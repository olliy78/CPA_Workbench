BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1


                                	title	BIOS CP/A, Buerocomputer (A5120/30 u. ae.)
                                	name	('BIOSMOD')
                                	.z80
                                	.tfcond		;bei Assembler-Aufruf mit "/X" vollst. Listing
                                
                                ; Versionsangabe:
                                ;----------------
  0019                          verst	equ	25	;Tag
  0009                          versm	equ	09	;Monat
  0059                          versj	equ	89	;Jahr
                                
                                	.list
                                
                                ;=====================================================================
                                ; Vereinbarungen fuer aktuelle Variante
                                ; Buerocomputer A5120/30
                                ;=====================================================================
  0000                          dev	equ	oem
  0006                          cpu	equ	k2526
  0019                          cpuclk	equ	25	;Takt der CPU; 25 bei 2,5Mhz; 40 bei 4,0Mhz
  0001                          fdc	equ	k5122
  0000                          crt	equ	k7024
                                
  F800                          bsanf2	equ	0f800h		;Anfang Bildschirmpuffer BAB2
  FC00                          bsanf1	equ	bsanf2+400h	;Anfang Bildschirmpuffer BAB1
  0800                          crtbfl	aset	800h		;benoetigter Bildschirmpuffer im Haupt-RAM
                                				;400h/800h, wenn Bildschirm nicht weggeschaltet
                                				;0   , wenn Bildschirm nicht im Haupt-RAM,
                                				;dann Makros 'crton', 'crtoff' definieren!
                                
                                ; eventuelle Routinen zum Aktivieren/Deaktivieren des Bildschirmpuffers
                                ; (ueber MEMDI/MEMDI1/MEMDI2) koennen hier eingefuegt werden:
                                
                                ; Aktivieren Bildschirmpuffer, nur Reg. BC,HL; kein Stack!
                                ;----------------------------
                                crton	MACRO
                                	ENDM
                                
                                ; Deaktivieren Bildschirmpuffer, nur Reg. BC,HL; kein Stack!
                                ;------------------------------
                                crtoff	MACRO
                                	ENDM
                                ;=====================================================================
                                
                                
                                	entry	BIOS,BIOSCE
  0E00                          bdosln	equ	0e00h
  0800                          ccpln	equ	0800h
                                
  0000'                         BIOS:
                                
                                ;***********************************************************
                                ; Generierungsvarianten und andere Equ's:
                                ; =======================================
                                
                                ; Vorbemerkung:
                                ; Alle in '"..."' eingeschlossenen Worte sind Bezeichner,
                                ; die in dem vorliegenden Assembler-Quelltext gesetzt werden.
                                
                                ; BIOS-Laenge (Grundwert, wird spaeter evtl. modifiziert!)
                                ; -----------
                                ;	minimal erreichbare BIOS-Laenge
                                ;	 ohne Bildschirmpuffer
                                ;	 ohne Interruptvektoren
                                ;	 0 Diskettenlaufwerke
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-1


                                ;	 ohne Diskettenpuffer
                                ;	 ohne Extra's
  0880                          biosln	aset	0880h ;07d0h
                                
                                ; Durch Weglassen der CP/A-Extras kann man den TPA-Bereich
                                ; um den Wert vergroessern, der sonst zu 'biosln' addiert
                                ; wird.
                                
                                ;	Hauptspeicher
                                ;	~~~~~~~~~~~~~
                                ; Bei Kaltstart erfolgt ein nichtzerstoerender RAM-Test von
                                ; "tpa"+3 bis "tpaend".
                                ; Wird dabei ein Speicherfehler erkannt, so wird auf die
                                ; letzten 3 fehlerfreien RAM-Zellen ein Sprung zum BDOS abge-
                                ; legt und der BDOS-Sprung auf Hauptspeicherplatz 5-7 auf
                                ; diesen Sprung gefuehrt. Ausserdem erfolgt eine entsprechende
                                ; Fehlermeldung beim Kaltstart.
                                
  0040                          ramkb	equ	64	;RAM-Groesse in Kilobytes
                                ;			 Bildschirmpuffer am Ende!
  0000                          rambyt	equ	ramkb*1024
                                
                                ; Falls eine 48k Speichererweiterung (OSS 062-8471) vorhanden
                                ; ist, so wird beim Kaltstart eine RAM-Floppy "M:" fuer diesen
                                ; Bereich angelegt.
                                ; Bei "oss"=0 erfolgt kein Test auf eine evtl. vorhandene
                                ; OSS-Karte.
                                
  0000                          oss	equ	0	;=0, wenn keine OSS-Karte vorhanden
                                ;			 =1, wenn evtl. OSS-Karte vorhanden
                                	IF	oss
                                	ENDIF
                                
                                
                                ; Wenn eine 16-Bit-Erweiterungskarte mit 256k-Speicher EM256 in-
                                ; stalliert ist, so kann dieser Speicher als RAM-Floppy 'M:' be-
                                ; nutzt werden.
                                ; Bei "em256" ungleich Null wird das Vorhandensein einer Erweite-
                                ; rungskarte getestet. Bei vorhandener EM256 wird beim Kaltstart
                                ; die RAM-Floppy eingerichtet.
                                ;
  0001                          em256	equ	1	;=0 ,wenn keine 16-Bit-Erweiterung
                                						;=1 ,wenn 16-Bit-Erweiterung vorhanden
                                	IF	em256
  0A40                          biosln	aset	biosln+1c0h
  4000                          em256adr equ	4000h	;256k-RAM wird vom U880 unter Adr.
                                			;4000..07FFFH angesprochen
                                			;!! 0 nicht moeglich wegen Konflikt mit Kaltstart
  00A8                          modadr	equ	0a8h	;Moduladresse der em256
                                	ENDIF
                                
                                ; Die RAM-Floppy mkd256 kann als Laufwerk 'M:' angesprochen werden.
                                ; Bei "mkd256" ungleich Null wird das Vorhandensein einer entsprechenden
                                ; Karte getestet. Ist diese vorhanden wird sie beim Kaltstart initialisiert
  0000                          mkd256	equ	0	; =0, ohne RAM-Floppy
                                							; =1, mit
                                
                                	IF	mkd256
                                	ENDIF
                                
  0000                          kes	equ	0	;keine Testram KES unterstuetzt
                                
                                ; Wenn mindestens eine RAF-Karte des ZWG der AdW vorhanden ist (beliebig
                                ; bestueckt, auch nur teilweise und/oder gemischt, max. 2M Byte pro Karte,
                                ; max. 4 Karten mit aufeinanderfolgenden E/A-Adressen), so kann bzw.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-2


                                ; koennen diese als RAM-Floppy 'M:' benutzt werden (ueber "SWAP A: M:"
                                ; bei Bedarf spaeter auch als LW A:)
                                ; Bei "raf" ungleich Null wird das Vorhandensein von RAF-Karten getestet.
                                ; Bei vorhandener(n) Karte(n) wird beim erstmaligen Kaltstart nach dem
                                ; Einschalten des Stromes die RAM-Floppy eingerichtet, bei RESET bleibt ihr
                                ; Inhalt erhalten.
                                ;
  0000                          raf	equ	0 ;=0 ,wenn keine RAF-Karte
                                					;=1 ,wenn RAF-Karte(n) vorhanden
                                 IF	raf
                                 ENDIF
                                
                                ; Wenn mindestens eine NANOS-256k-DRAM-Karte vorhanden ist (beliebig
                                ; bestueckt, auch nur teilweise und/oder gemischt, max. 256k Byte pro Karte,
                                ; max. 4 Karten mit jeweils beliebigen E/A-Adressen), so kann bzw.
                                ; koennen diese als RAM-Floppy 'M:' benutzt werden (ueber "SWAP A: M:"
                                ; bei Bedarf spaeter auch als LW A:)
                                ; Bei "rna" ungleich Null wird das Vorhandensein von NANOS-RAF-Karten getestet.
                                ; Bei vorhandener(n) Karte(n) wird beim erstmaligen Kaltstart nach dem
                                ; Einschalten des Stromes die RAM-Floppy eingerichtet, bei RESET bleibt ihr
                                ; Inhalt erhalten.
                                ;
  0000                          rna	equ	0 ;=0 ,wenn keine NANOS-RAF-Karte
                                					;=1 ,wenn mindestens eine NANOS-RAF-Karte da
                                 IF	rna
                                 ENDIF
                                
  0001                          ramfl	equ	oss+kes+em256+mkd256+raf+rna
                                
                                ;	Kaltstart
                                ;	~~~~~~~~~
                                ; Es besteht die Moeglichkeit, beim Kaltstart des Systems automatisch
                                ; ein Kommando auszufuehren (dies kann auch ueber SUBMIT eine Kommando-
                                ; folge sein!).
                                
                                 IF1
                                 ENDIF
  0000                          cldcmx	equ	0		;=0, wenn Kommando nur bei Kaltstart
                                				;    nach Einschalten auszufuehren
                                				;=1, wenn Kommando auch bei RESET
                                				;    auszufuehren
                                
                                ;	Warmstart
                                ;	~~~~~~~~~
                                ; Im Normalfall wird das CCP von einer im BIOS gehaltenen Kopie
                                ; bei jedem Warmstart vor das BDOS kopiert, wodurch keine Sy-
                                ; stemspuren auf Laufwerk A erforderlich sind. Um einen maximal
                                ; grossen TPA zu erhalten, sind auch andere Varianten moeglich:
                                
  0000                          wbootv	equ	0
                                ;		=0:	CCP-Kopie im BIOS (2K grosser Puffer)
                                ;		=1:	keine CCP-Kopie, Warmstart=Kaltstart
                                ;			(Kaltstart-Kommando sollte leer sein!)
                                ;		=2:	keine CCP-Kopie, CCP aus File '@os.com'
                                ;		=3:	CCP-Kopie in RAM-Floppy (RAM-Floppy
                                ;			dann um 2K kleiner),
                                ;			wenn keine RAM-Floppy vorhanden
                                ;			(siehe "Hauptspeicher"), so wie wbootv=1
                                ;		=4:	keine CCP-Kopie, CCP aus File '@ccp.com'
                                ;			selbstversch. vor BDOS o. Treiber geladen
                                ; Bei "wbootv"<>0 und Arbeit ohne Diskettenpuffer kann der
                                ; Kaltstart-Code u.U. bis in den Bildschirmpuffer reichen,
                                ; wodurch der Bildschirm beim Kaltstart kurzzeitig undefi-
                                ; niert sein kann.
                                
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-3


                                	IF	wbootv eq 0
  12D0                          biosln	aset	biosln+90h+ccpln;2K fuer CCP-Kopie
                                	ENDIF
                                	IF	(wbootv eq 2) or (wbootv eq 3) or (wbootv eq 4)
                                	ENDIF
                                
                                ;	BIOS-Monitor
                                ;	~~~~~~~~~~~~
  0000                          monitor equ	0	;=1: mit  BIOS-Monitor
                                ;			 =0: ohne
                                	IF	monitor
                                	ENDIF
                                
                                
                                ;	STOP-Funktion
                                ;	-------------
  0001                          stpvar	equ	1	;=1: mit Unterstuetzung STOP-Funktion
                                			;=0: ohne,
                                			;    es werden auch alle Drucker-Sondert. ign.
                                	IF	stpvar
  13A0                          biosln	aset	biosln+0d0h
                                	ENDIF
                                
                                ;	Speicherschutz
                                ;	~~~~~~~~~~~~~~
  0000                          mprot	equ	0	;=1: mit Speicherschutz
                                ;			 =0: ohne
                                	IF	mprot
                                	ENDIF
                                
                                ;	Status-Zeile
                                ;	------------
  0001                          cpastz	equ	1	;Statuszeile hardware-maessig nicht moeglich
                                
                                	IF	cpastz
  1450                          biosln	aset	biosln+0b0h
  0005                          stzfrm	equ	05h	;Format der Statuszeile, folgende Formen:
                                			;05h:	      invers, normale Helligkeit
                                			;07h:	      invers, andere  Helligkeit
                                			;04h:	nicht invers, normale Helligkeit
                                			;06h:	nicht invers, andere  Helligkeit
                                	ENDIF
                                
                                ;	Fehlermeldungen des BIOS
                                ;	------------------------
  0001                          errvar	equ	1	;=1: mit BIOS-Fehlermeludngen
                                			;=0: ohne
                                	IF	errvar
  14A0                          biosln	aset	biosln+50h
                                	ENDIF
                                
                                ;	Uhr
                                ;	---
  000C                          sysctc	equ	0ch	;System-CTC, Kanal 0
                                ; Fuer die Uhr wird Kanal 2 und 3 benutzt (5ms, 1sec),
                                ; Kanal 0,1 steht fuer den Anwender frei
                                
  0001                          uhrvar	equ	1	;=1: mit BCD-Uhr (Platz siehe "bcduhr")
                                ;			 =0: ohne
                                	IF	uhrvar
  14F0                          biosln	aset	biosln+50h
  0000                          datvar	equ	0	;=1 mit, =0 ohne Verwaltung des Datums
                                  IF datvar
                                  ENDIF
                                	ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-4


                                
                                ;	IOBYTE
                                ;	------
  0001                          iobvar	equ	1	;=1: mit IOBYTE-Unterstuetzung
                                			;=0: ohne (wie IOBYTE=00h)
                                	IF	iobvar
  1590                          biosln	aset	biosln+0a0h
                                	ENDIF
                                
                                ;	Vereinbarungen fuer zeichenweise arbeitende Geraete (i.a. Drucker)
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                                ; gaengige Hardware (auch andere zulaessig):
                                ;	Karte A51xx	Daten	Status	CTC S/E Bemerkungen
                                ;	K8025		5e	5f	58/58	Normalfall IFSS
                                ;	K8025		5c	5d	58/58	i.a. Tastatur K7637
                                ;						oder Zusatzdrucker
                                ;						oder Digitalisiergeraet
                                ;	K8025		52	53	0c/0c	2. IFSS -Ausgang
                                ;			52	53	59/59	alternative Tastatur K7637
                                ;	K6028/K8025	50	51/53	0c/0c	V.24-Ausgang
                                ;	K8025.22/.32	a1	a3	a8/a8	AFS Spezial EC8404M
                                ;	K6022		54	56		Normalfall PIO-Drucker
                                ;	K6022		50	51		1154 ueber ADA -> Humboldt-Uni
                                ;	1154 Spezial	54	56		1154 Spezialanschluss
                                ;						1156-Anschl. siehe BIOSCP56.MAC
                                ;	1156 Spez. neg. 38	39		1156 ueber KME3, neg. Pegel
                                ;	1156 Spez. pos. 38	39		1156 ueber KME10,pos. Pegel
                                
                                ; Diese Ausgaenge koennen physischen CP/M-Geraeten entsprechend
                                ; der I/O-Byte-Belegung zugewiesen werden:
                                ; TTY:	bei Kaltstart zugewiesener Drucker		(kann fehlen)
                                ; LPT:	zweiter Drucker					(kann fehlen)
                                ; UC1:	Geraetekopplung ueber CON: oder RDR:/PUN:	(kann fehlen)
                                ;	Fuer UC1: nur Treiber-Typ DC1/3 oder DTR erlaubt (kein PIO)!
                                
                                ; Im folgenden fuer 'iobxxx', 'xxxdat', 'xxxsta', 'xxxcts', 'xxxctr'
                                ; jeweils die Parameter angeben:
                                ; (=00000 fuer fehlenden, d.h. vom BIOS nicht unterstuetzten Tr.)
                                ; Sind alle Treiber-Nr. =0, so entfaellt der gesamte Treiber-
                                ; teil im BIOS (fuer Testzwecke zum Erreichen eines grossen
                                ; TPA, alle Ausgaben und Druckersondertasten ignoriert)
                                ; Format fuer 'iobxxx':
                                ; PSCBT
                                ; PSCB	nur bei T<5 angeben, sonst 0000
                                ; P		Paritaet
                                ;		0 ohne Paritaet; 1 ungerade Paritaet; 2 gerade Paritaet
                                ;  S		Stopbits
                                ;		1  1   Stopbit
                                ;		2  2   Stopbits
                                ;		3  1.5 Stopbits
                                ;   C		Anzahl der Bits pro Zeichen (5..8)
                                ;    B		Baudrate
                                ;		1:9600,2:4800,3:2400,4:1200,5:600,6:300,7:150,8:100,9:75
                                ;     T		Treiber- und Protokoll-Typ
                                ;		0:DC1/DC3  (Normalfall IFSS)
                                ;		1:DTR im Kanal A mit Statusabfrage DTR ueber Kanal B, DCD
                                ;			   (Normalfall V.24 ueber K6028/K8025 mit DTR an DSR)
                                ;		2:Strombauch fuer LX86 (Information Koll. Tief, Bln. 6346461)
                                ;		  fuer PSCBT: 01812 (Baudrate wird durch 8 auf 1200bd geteilt)
                                ;		  fuer xxxdat: 5eh, fuer xxxsta: 5fh, fuer xxxctx: 58h
                                ;		3:DTR im Kanal A mit Statusabfrage DTR ueber Kanal A, CTS
                                ;			   (V.24 ueber K6028/K8025 bei DTR an CTS statt an DSR)
                                ;		5:PIO
                                ;		6:PIO1154 Spezialinterface (Hardware-Loesung nicht nachnutzbar)
                                ;		7:PIO1156 neg. Pegel (Hardware siehe BIOSCP56.MAC)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-5


                                ;		8:PIO1156 pos. Pegel
                                ;		9:PIO1154 umgebaute ADA (Hardware siehe BIOSCH54.MAC)
                                
                                ; Standard-Drucker
                                ;=================
                                
                                ;iobtty	equ	11710	;ung. P.;1 Stbit;7 Bit;9600;DC1/3 (z.B. 1152,1157,63xx)
                                ;ttydat	equ	5eh	;IFSS Normalausgang
                                ;ttysta	equ	5fh
                                ;ttycts	equ	58h
                                ;ttyctr	equ	58h
                                
  0713                          iobtty equ      01811   ;ohne P. ;  1 Stbit; 8 Bit 9600; DTR ueb.Kanal A
  0050                          ttydat equ      50h     ; V.24 - Ausgang
  0051                          ttysta equ      51h
  000C                          ttycts equ      0ch
  000C                          ttyctr equ      0ch
                                 
                                ; zweiter Drucker
                                ;================
                                
                                ;ioblpt	equ	0	;ohne P.; 1 Stbit;8 Bit;9600;DTR (z.B. EPSON LX86)
                                ;lptdat	equ	50h	;V.24
                                ;lptsta	equ	51h
                                ;lptcts	equ	0ch
                                ;lptctr	equ	0ch
                                
  2DBE                          ioblpt	equ	11710	;ung. P.;1 Stbit;7 Bit;9600;DC1/3 (z.B. SD1152,K63xx)
  005E                          lptdat	equ	5eh	;IFSS Normalausgang
  005F                          lptsta	equ	5fh
  0058                          lptcts	equ	58h
  0058                          lptctr	equ	58h
                                
                                ; Kopplung
                                ;=========
                                				
                                ;iobuc1	equ	0	;ohne P.;1 Stbit;8 Bit;9600;DTR
                                ;uc1dat	equ	50h	;am V.24-Ausgang
                                ;uc1sta	equ	51h
                                ;uc1cts	equ	0ch
                                ;uc1ctr	equ	0ch
                                ;uc1bfl	equ	20		;Laenge des UC1:-Puffers
                                				;muss z.B. 2k Bildschirmrollen abfangen!
                                				;d.h. >=20 bei 9600 bd
                                
  0713                          iobuc1	equ	01811	;ohne P.;1 Stbit;8 Bit;9600;DTR
  0050                          uc1dat	equ	50h	;am V.24-Ausgang
  0051                          uc1sta	equ	51h
  000C                          uc1cts	equ	0ch
  000C                          uc1ctr	equ	0ch
  0014                          uc1bfl	equ	20		;Laenge des UC1:-Puffers
                                				;muss z.B. 2k Bildschirmrollen abfangen!
                                				;d.h. >=20 bei 9600 bd
                                				
                                ; Ueber diese Treiber koennen unter Beachtung des unterschiedlichen
                                ; Steuerzeichenvorrats beliebige Geraete angeschlossen werden, die
                                ; Treiber-Software ist steuerzeichenunabhaengig
                                ; (ausser TTY: und LPT: bei generierter Variante 2-Bahn-Drucker).
                                
                                ; Es besteht die Moeglichkeit, 2-Bahn-Drucker getrennt fuer
                                ; jede Bahn zu betreiben (nur Druckerschnittstelle 1):
  0000                          l2bahn	equ	0		;>0: Position fuer 2. Bahn (i.a. 138)
                                				;=0: keine 2. Bahn unterst.
                                
                                ;----Auswertung der ausgewaehlten Varianten
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-6


                                 IF1
                                 ENDIF
                                
  FFFF                          chdvar	equ	(iobtty ne 0) or (ioblpt ne 0) or (iobuc1 ne 0)
                                 IF	chdvar
                                  IF cdtdc1 or cdtdtr		;IFSS, V.24
  16E0                          biosln	aset	biosln+150h
                                  ENDIF
                                  IF cdtsib			;Strombauch
                                  ENDIF
                                  IF cdtpio			;PIO
                                  ENDIF
                                  IF cdtp54			;Spez. 1154
                                  ENDIF
                                  IF cdth54			;ADA 1154
                                  ENDIF
                                  IF cdtn56			;1156 neg
                                  ENDIF
                                  IF cdtp56			;1156 pos.
                                  ENDIF
                                
                                  IF stpvar
  1770                          biosln	aset	biosln+090h	;asynchrone LST:-Routinen
                                				;und Hardcopy
                                  ENDIF
                                
                                  IF	iobuc1
  1864                          biosln	aset	biosln+0e0h+uc1bfl ;UC1:-Routinen + UC1:-Puffer
                                  ENDIF
                                
                                  IF l2bahn
                                  ENDIF
                                
                                 ENDIF ;chdvar
                                ;---Ende Auswertung zeichenweise Treiber
                                
                                
                                ;	Vereinbarungen fuer Disketten
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                                
  0001                          @write	equ	1	;bei <>0 auch Schreiben auf Disketten unterst.
                                ; Es werden maximal 4 Diskettenlaufwerke A..D dicht von A
                                ; beginnend unterstuetzt.
                                ; Diese koennen sowohl 5 1/4 " als auch 8" Laufwerke sein
                                ; (auch gemischte Konfigurationen erlaubt!).
                                ; Fuer jedes Laufwerk kann Zuruecklesen nach jedem Schreiben verlangt
                                ; werden (Verify), fuer sichere Disketten und Laufwerke dies jedoch i.a.
                                ; nicht notwendig (Schreiben geht dann genauso schnell wie Lesen), lediglich
                                ; beim Anlegen einer Sicherheitskopie sollte explizit Verify vom Kopier-
                                ; programm verlangt werden ([v] bei POWER bzw. DIENST). Die bei der System-
                                ; generierung eingestellte Variante kann durch FORMAT laufwerksspezifisch
                                ; geaendert werden.
                                
                                ; Folgende Angaben sind verbindlich:
                                ;DSZTT
                                ;D		Density; 0 single (SD bzw. FM), 1 double (DD bzw. MFM)
                                ; S		Sided; 0 single (SS), 1 double (DS)
                                ;		bei Verify nach Schreiben S+2 angeben
                                ;  Z		5 fuer 5 1/4 ", 8 fuer 8 "
                                ;   TT		Anzahl der tracks
                                ; z.B.
                                ; 10540		DD, SS, 5", 40 Tracks (z.B. K5600.10)
                                ; 10580		DD, SS, 5", 80 Tracks (z.B. K5600.20)
                                ; 11580		DD, DS, 5", 80 Tracks (K5601 !!!)
                                ; 00877		SD, SS, 8", 77 Tracks (z.B. MF3200)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-7


                                ; 10877		DD, SS, 8", 77 Tracks (z.B. K5602.10, MF6400))
                                ; 0		nicht ex. (immer am Ende!)
                                
                                ;diskA	equ	13580 ;DD, DS mit Verify nach Schreiben, 5", 80 Tracks (K5601)
                                ;diskB	equ	13580
                                ;diskC	equ	13580
                                ;diskD	equ	0
                                
  2A7D                          diskA	equ	10877
  2D3C                          diskB	equ	11580
  2D3C                          diskC	equ	11580
  0000                          diskD	equ	0
                                
                                ; Es wird eine automatische Formaterkennung fuer gaengige CP/M-
                                ; Diskettenformate einschliesslich der SCP-Hausformate von CP/A
                                ; unterstuetzt. Dies kann unterdrueckt werden, wenn nur mit
                                ; festen Formaten gearbeitet wird (und eine extra CP/A-Variante
                                ; fuer den Datenaustausch mit Formaterkennung existiert). In
                                ; diesem Fall haben die Disketten das Standard-CP/A-Format ent-
                                ; sprechend dem vorgegebenen LW-Typ.
                                
  0001                          format	equ	1	;=1 mit, =0 ohne Routinen fuer autom. Formaterkennung
  0000                          @fsys	equ	0	;=1 mit, =0 ohne Systemspuren fuer Standardformat
                                 IF format
  0001                          @fact	equ	1	;=1 mit, =0 ohne automatische Formaterkennung scharf
                                 ENDIF
                                 IF format
  1AB4                          biosln	aset	biosln+250h	;Routinen +Tabellen
                                 ENDIF
                                
                                ; Zur automatischen Format-Erkennung von SIOS-Datendisketten wird
                                ; auf 40h in Spur 0, Sektor 1 geprueft. Solche Disketten duerfen
                                ; also keine System-Lader-Informationen haben und werden dann als
                                ; "CP/M"-Disketten ohne Systempuren behandelt. Dadurch ist die Anwen-
                                ; dung von Original-Konvertierungsprogrammen IBM<->CP/M moeglich
                                ; {unter SCP existierende Programme laufen u.a. nur dann, wenn sie
                                ; konsequent den BIOS-Entry 30h (Sektornr. uebersetzen) nutzen!}.
                                
                                ; Ohne automatische Formaterkennung oder bei vorhandenen System-Lader-
                                ; informationen auf der SIOS-Diskette muss das Format explizit einge-
                                ; stellt werden (26*128 einseitig ohne Systemspuren).
                                
                                 IF1
                                 ENDIF
  0002                          disk5	aset	dsk5fm+dsk5mf
  0001                          disk8	aset	dsk8fm+dsk8mf
  0003                          disknb	aset	disk5+disk8
                                 IF disknb ne 0
  1FB4                          biosln	aset	biosln+500h
                                 ENDIF
  20F5                          biosln	aset	biosln+disknb*6bh	;Diskettensteuerbloecke
  210F                          biosln	aset	biosln+dsk8mf*26	;Verlaengerung Sektortab.
  21AF                          biosln	aset	biosln+disk8*16+dsk80*48;Checksize beruecks.
                                
                                ; Die Disketten Ein-/Ausgabe kann gepuffert verlaufen.
                                ; "dbufsz"<=7 fuehrt zur ungepufferten Arbeit (Codeeinsparung).
                                ; Die Angabe der Pufferlaenge erfolgt als Exponent von 2, d.h.
                                ; die Puffergroesse ist 2**dbufsz !
                                
  000A                          dbufsz	equ	10		;2**dbufsz = Pufferlaenge
                                	IF	dbufsz gt 7
  272F                          biosln	aset	biosln+180h+(1 shl dbufsz);Diskpuffer dazu
                                	ENDIF
                                
                                ; Der Diskettenpuffer muss mindestens so gross wie die groesste
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-8


                                ; physische Sektorlaenge entspr. dem Spurformat sein, also
                                ; i.a. 1K. Fuer eine exakte BDOS-Rueckmeldung von Schreib-
                                ; fehlern (BAD SECTOR) darf die Puffergroesse nicht groesser
                                ; als die kleinste Blockgroesse fuer Disketten (1 K) sein,
                                ; da sonst die Pufferausgabe erst erfolgt, wenn mit anderen
                                ; Daten gearbeitet werden soll.
                                ; Vorzugswert fuer "dbufsz" ist daher 10!
                                ; Mehr als die maximale Spurlaenge von ca. 6 1/4  K ergibt
                                ; keinen Gewinn, d.h. "dbufsz"<=13 .
                                ; "dbufsz"<12 fuehrt zu einer ungepufferten Arbeit bei Sektor-
                                ; laenge 128, da die Effektivitaet wegen des Sektorversatzes
                                ; bei Pufferung von Teilen einer Spur sinkt!
                                
                                ;	Vereinbarung fuer HardDisk
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~
                                
                                ; Ueber einen Spezialadapter kann am 8-bit-Bus eine XT-kompatible Festplatte
                                ; genutzt werden.
                                ; Weitere Informationen befinden sich im Quelltext BIOxHD.MAC.
  0000                          hdsk	equ	0	;=1, wenn HardDisk zu unterstuetzen
                                 if hdsk
                                 endif
                                
                                ;	Vereinbarung der Tastatur
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~
                                
                                ; Waehrend des Kaltstarts wird auf Typ K7604/06/34/36/37 ge-
                                ; testet und die Treiberroutinen modifiziert.
                                ; 'Standardmaessig' ist diejenige Routine generiert, die den
                                ; laengsten Code benoetigt, d.h. es wird in jedem Fall modi-
                                ; fiziert.
                                
                                ; Portbelegungen:
                                ;----------------
                                
                                ; PIO-Tastatur (i.a. PIO auf ZE-Platte)
                                ;=============
  0006                          kbdpci	equ	06h	;Zeichen-Eingabe
  0001                          kbdpcs	equ	01h	;Eingabe-Status
  0003                          kbdp3o	equ	03h	;Lampen ausser Selector
  0005                          kbdp5o	equ	05h	;LED Selector
  0000                          kbdpin	equ	0	;=0: kein CTC-Kanal als Tastatur-Interrupt
                                
                                ; Bankschalter-Tastatur K7633 an AUP 062-08531
                                ; ===========================
  0042                          kbdbci	equ	42h	;;Zeichen-Eingabe
  0041                          kbdbcs	equ	41h	;;Status
  0043                          kbdb3o	equ	43h	;;Lampen
                                
                                ; SIO-Tastatur (i.a. zusammen mit IFSS-Drucker [unterer Stecker] auf K8025)
                                ;=============
  0058                          kbdsct	equ	58h	;CTC		Takt von K8025-CTC Kanal 0
  005C                          kbdsci	equ	5ch	;Zeichen E/A	2.  Stecker von unten
  005D                          kbdscs	equ	5dh	;Status
                                ; weitere SIO-Tastatur-Anschluesse (z.B. bei Digitalisier-Arbeitsplatz)
                                ; wenn nicht zu unterstuetzen, so "kbdsNx"-Werte gleich 0 (N = 2..5)
                                ; Abfrage in der Reihenfolge kbdscx, kbds2x, kbds3x, kbds4x,...
  0059                          kbds2t	equ	59h	;CTC		Takt von K8025-CTC Kanal 1 (Umbau)
  0052                          kbds2i	equ	52h	;Zeichen E/A	2. Stecker von oben
  0053                          kbds2s	equ	53h	;Status
                                
  005A                          kbds3t	equ	5ah	;CTC		Takt von K8025-CTC Kanal 2 (Umbau)
  0052                          kbds3i	equ	52h	;Zeichen E/A	2. Stecker von oben
  0053                          kbds3s	equ	53h	;Status
                                
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-9


  000C                          kbds4t	equ	0ch	;CTC		Takt von CPU (so K8025 ausgeliefert)
  0052                          kbds4i	equ	52h	;Zeichen E/A	2. Stecker von oben
  0053                          kbds4s	equ	53h	;Status
                                
  004A                          kbds5t	equ	4ah	;CTC
  004E                          kbds5i	equ	4eh	;Zeichen E/A
  004F                          kbds5s	equ	4fh	;Status
                                
                                
                                ; Die folgenden Typcode-Zeichen werden in der Reihenfolge
                                ; der Tastaturnummern abgetestet (falls durch PROM-Aenderung
                                ; der gleiche Typcode wie fuer eine andere Tastatur geliefert
                                ; wird, kann man so bestimmte Tastaturen bevorzugen).
                                
  0000                          kbdotp	equ	0 ;Typ der Tast. die keinen Typcode liefert:
                                ;			=0 fuer K7606
                                ;			=1 fuer K7604
                                ;			=2 fuer DEG-Spezialtastatur am IIR
                                ;			=3 fuer K7633 an AUP 062-8531
  0010                          typc3s	equ	010h	;Sondertastatur IH Mittweida (modif. K7634)
  00A0                          typc34	equ	0a0h	;K7634 ausser K7634.54
                                
                                ; Typ der Tastatur, die Typcode 80h liefert:
                                ; von den equ-Zeilen genau eine ohne Semikolon davor!
                                ;typ80	equ	3454	;K7634.54 (UBT-Tastatur)
  0024                          typ80	equ	36	;K7636-Familie
                                
  0080                          typc37	equ	080h	;K7637
                                
                                
                                ; Der Tastaturpuffer befindet sich bei Arbeit mit Statuszeile
                                ; an deren Ende, so dass der Kopf staendig auf dem Bildschirm
                                ; sichtbar ist. Ohne Statuszeile ist er im BIOS-Arbeitsbereich.
                                ; (Bei Verlagerung an das Bildschirm-Puffer-Ende gibt es
                                ;  "Spratzer" auf Grund der Speicherorganisation der K7024-Karte)
                                
  0014                          kbdbl	equ	20; 47	;1..47, Zahl zu puffernder Zeichen
                                			;Weniger als 47 laesst auch bei Arbeit
                                			;mit Statuszeile am Speicherende Bytes
                                			;als BIOS-Patch-Bereich frei.
                                
                                ; Unabhaengig von der Tastaturerkennung wird die Arbeit mit
                                ; Tastaturstrings unterstuetzt. Es existiert sowohl eine Stan-
                                ; dardbelegung von Stringtasten als auch die Moeglichkeit der
                                ; nutzereignenen Definition bis auf Widerruf.
                                
                                 IF cpastz	;Puffer benoetigt keinen zusaetzlichen Platz
                                 ENDIF
                                
                                 IF1
                                 ENDIF
                                
  0000                          costu	equ	0; 20	;>=0
                                			;bei =0 werden Verw.routinen eingespart
                                			;bei >0 Mindestlnge fuer Nutzer-Strdef.
                                			;    Tab. liegt direkt vor Int.vektoren
                                			;    und ist evtl. groesser!
                                	IF	costu
                                	ENDIF
                                
                                ;	Vereinbarungen fuer Bildschirm
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  2F2F                          biosln	aset	biosln+crtbfl
                                
                                ;Es wird sowohl ein grosser (24*80, BAB2) als auch ein kleiner
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-10


                                ;(16*64, BAB1) Bildschirm unterstuetzt. Die Treibermodifizierung
                                ;geschieht beim Kaltstart ohne notwendige Neuuebersetzung.
                                
                                ; vorgegebene Bildschirm-Werte:
                                
  F800                          bsanf2	equ	0f800h		;Anfang Bildschirmpuffer BAB2
  FC00                          bsanf1	equ	bsanf2+400h	;Anfang Bildschirmpuffer BAB1
  0018                          bszl2	equ	24		;Zeilenzahl
  0010                          bszl1	equ	16		;dito BAB1
  0050                          bssp2	equ	80		;Spaltenzahl
  0040                          bssp1	equ	64		;dito BAB1
  FF7F                          bsend2	equ	bsanf2+bszl2*bssp2-1	;Pufferende
  FFFF                          bsend1	equ	bsanf1+bszl1*bssp1-1	;dito BAB1
                                 IF cpastz
  FF80                          statz2	equ	bsend2+1	;Beginn der Statuszeile
  0000                          statz1	equ	bsend1+1	;dito BAB1
                                 ENDIF
                                
                                ; Waehrend des Kaltstarts wird Port 0ah, Bit 6 getestet (Wickel-
                                ; bruecke auf ZE-Karte) und hierueber BAB1 und BAB2/3 unterschieden.
                                
  0084                          bsinic	equ	84h	;Steuerzeichen fuer Bildschirmzustand
                                ;			 nach dem Loeschen des Bildschirms
                                ;			 bei Kaltstart
                                ;			 z.B. auf 86h fuer andere Helligkeit
                                
                                ; Es existiert inzwischen ein Reihe von Software, die die SCP1715-Steuer-
                                ; zeichenfolgen 1b 5e xx (Feldattribut) und 1b 5f xx (Spezialzeichen) nutzen,
                                ; die vom SCP1526 (Buerocomputer) nicht unterstuetzt werden.
                                ; Diese Steuerzeichenfolgen koennen wahlweise unter CP/A unterstuetzt werden,
                                ; wobei fuer den Buerocomputer technisch bedingt nur die Feldattribut-
                                ; Funktionen invers und hell zugelassen sind (Reaktion wie Steuerzeichen
                                ; 84,85,86,87; alle anderen Funktionen fuehren zur Steuerzeichen-Fehlermeldung
                                ; durch Ausgabe von '^' auf dem Bildschirm an dieser Selle).
                                ; Wird im folgenden "escpc"=0 gesetzt, so werden obige Steuerzeichenfolgen
                                ; als Kursorpositionierfolgen behandelt und fuehren zu entsprechend sinnlosen
                                ; Effekten auf dem Bildschirm. Ausser aus Speicherplatzgruenden sollte daher
                                ; "escpc"=1 sein.
  0001                          escpc	equ	1	;=1 fuer Unterstuetzung 1b 5e xx und 1b 5f xx
                                			;=0 fuer fehlende Unterstuetzung
                                 IF escpc
  2F6F                          biosln	aset	biosln+40h
                                 ENDIF
                                
                                ; Fuer eine effektivere Arbeit von TURBO-Pascal koennen wahlweise die
                                ; Nicht-SCP-Steuerzeichen 17h (Insert Line) und 19h (Delete Line)
                                ; vom Bildschirmtreiber unterstuetzt werden, wodurch der Bildschirm-
                                ; neuaufbau erheblich beschleunigt wird (keine Neuausgabe des gesamten
                                ; Bildschirmrestes). Hat nur Sinn, wenn TURBO-Pascal auch geaendert
                                ; wird, d.h. diese Steuerzeichen nutzt!
                                
  0001                          inslin	equ	1	;=1, wenn InsLine und DelLine zu unterstuetzen
                                			;=0 sonst
                                 IF inslin
  2FCF                          biosln	aset	biosln+60h
                                 ENDIF
                                
  0000                          adm3a	equ	0	;=1, wenn auch Unterst. einiger ADM3A-St.zeich.
                                ;			 =0, wenn nur SCP-Steuerz.
                                	IF	adm3a
                                	ENDIF
                                
                                
                                ; Umlautumcodierung (fuer deutschen Zeichensatz):
                                ; Bei BAB2 und BAB1 ist unter Verwendung eines speziellen
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-11


                                ; Zeichengenerators die Darstellung von Umlauten moeglich.
                                ; Dabei werden (nach Wunsch, umschaltbar mit CI/Stop U)
                                ; anstelle der ASCII-Zeichen spezielle Codierungen (10h..1fh)
                                ; auf den BS ausgegeben. Der Zeichensatz entspricht dem
                                ; Umfang des Typenrades des 1152 mit Umlauten.
                                ; Fuer BAB3 fuehrt die Umcodierung zur Interpretation als
                                ; Steuerzeichen normal/invers/intensiv ==> nicht benutzen!
  0001                          umlaut	equ	1; 0	;=1 mit Umcodierungsmoeglichkeit
                                			;=0 ohne	-"-
                                 IF umlaut
                                ; Bei umlaut<>0 muss genau eines der folgenden equ's =1 sein,
                                ; wodurch der Zeichengenratortyp bestimmt wird.
                                ; Die genaue Belegung ist im Text 'BIOxCRT.MAC' zu finden.
  0001                          zsuml	equ	1; 0	;Belegegung durch Koll. Geiler, IH Mittweida
  0000                          zsibm	equ	0; 1	;Belegung fuer ersatzweisen IBM-Zeichensatz
  302F                          biosln	aset	biosln+60h
                                 ENDIF
                                
                                
                                ;	Interruptvektor
                                ;	===============
                                
  F700                          intvec	equ	0f700h	;Beginn des Interruptvektors (immer 100h-er Grenze)
                                
                                ; Vom BIOS benutzte Interruptworte:
  00E0                          intvsy	equ	0e0h		;immer benoetigt intvsy..intvsy+1fh
                                 IF iobuc1
  00D0                          intvuc	equ	intvsy-10h	;SIO-Bedienung fuer UC1:-Treiber
  00D0                          intvb	equ	intvuc		;kleinster benoetiger Platz durch BIOS
                                 ENDIF
                                
                                ; Belegung der Interruptsaeule durch das BIOS:
                                ;============================================
                                
                                ; Kassetten werden ausserhalb des BIOS bedient und benoetigen
                                ; Interruptsaeulenplatz von 0c0h..0cfh!!
                                
                                 if iobuc1
                                ;	SIO fuer UC1:-Treiber im Interrupt
                                ; Kanal B
  00D0                          ivsio0	equ	intvuc		;Sendepuffer leer
  00D2                          ivsio1	equ	ivsio0+2	;Statuswechsel
  00D4                          ivsio2	equ	ivsio1+2	;Empf-Zeichen da
  00D6                          ivsio3	equ	ivsio2+2	;Empf-Ueberlauf
                                ; Kanal A
  00D8                          ivsio4	equ	ivsio3+2	;Sendepuffer leer
  00DA                          ivsio5	equ	ivsio4+2	;Statuswechsel
  00DC                          ivsio6	equ	ivsio5+2	;Empf-Zeichen da
  00DE                          ivsio7	equ	ivsio6+2	;Empf-Ueberlauf
                                 endif
                                
  00E0                          ivpar	equ	intvsy+00h	;Paritaetsfehler EM256-RAM
  00E2                          ivpiod	equ	intvsy+02h	;Status-Interrupt PIO-Drucker
                                
                                ;*** intvsy+04h frei
                                
  00E6                          ivprot	equ	intvsy+06h	;Speicherschutz bei A5120/30
                                
                                ;*** die folgenden beiden Adressen werden vom FORMAT-Programm
                                ;*** vorausgesetzt, d.h. ihre Lage ist quasi fest !!
  00E8                          ivdsk1	equ	intvsy+08h	;Disk Index-Interrupt
  00EA                          ivdsk2	equ	intvsy+0ah	;Disk Marken-/Fault-Interrupt
                                
                                ;*** intvsy+0ch, +0eh frei
                                
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-12


                                ; LS-Leser und Stanzer bei A5120/30
                                ; *** Die folgenden Adressen werden von PTPUNCH/PTREAD
                                ; *** vorausgesetzt, d.h. ihre Lage ist quasi fest!!
                                ; *** bei nicht vorhandener Lochstreifenperipherie intvsy+10h..+16h frei
  00F0                          ivpun1	equ	intvsy+10h	;LS-Stanzer
  00F2                          ivrdr1	equ	intvsy+12h	;LS-Leser
  00F4                          ivrdr2	equ	intvsy+14h
  00F6                          ivpun2	equ	intvsy+16h	;LS-Stanzer
                                
  00F8                          ivctc0	equ	intvsy+18h	;CTC Kanal 0
  00FA                          ivctc1	equ	ivctc0+2
  00FC                          ivctc2	equ	ivctc1+2
  00FE                          ivctc3	equ	ivctc2+2
                                
                                
                                ;	Unterstuetzung weiterer Peripherie
                                ;	----------------------------------
                                
                                ; Es gibt in CP/A grundsaetzlich folgende Moeglichkeiten fuer die
                                ; Unterstuetzung einer SIO-Bedienung (i.a. fuer Kopplungen):
                                ; a) Unterstuetzung als UC1:-Geraet
                                ;   (siehe Vereinbarungen fuer serielle Geraete).
                                ;   In diesem Fall erfolgt die Bedienung voll ueber das BIOS
                                ;   (im Interruptbetrieb, mit speziellem Empf.puffer im BIOS)
                                ;   Fehler werden nur als BIOS-Fehler gemeldet, das Anwenderprogramm
                                ;   erfaehrt davon nichts ueber die BIOS-Schnittstelle.
                                ; b) im Anwenderprogramm, keine Unterstuetzung im BIOS.
                                ; Im Fall b) - oder wenn es sich um andersartige Peripherie handelt -
                                ; bietet CP/A durch Veraenderung von "intvl" zusaetzlichen Platz in
                                ; der Interruptvektor-Tabelle an, so dass eine Umspeicherung der
                                ; BIOS-Interruptvektoren vermieden werden kann.
                                
  00D0                          intvl	aset	intvb		;kleinster low-Interruptvektor
                                				;Kann 000h..0d0h sein
                                				;("intvb"..ff wird vom BIOS benoetigt)
  305F                          biosln	aset	biosln+(100h-intvl)
                                
                                ;------------------------------------------------------
                                ;	absolute Hauptspeicherplaetze
                                ;------------------------------------------------------
                                ;		      Byteanzahl
  0000                          reboot	equ	0	;(3)	;Warmstart-Sprung
  0003                          iobyte	equ	3	;(1)	;I/O-Byte
  0004                          defaul	equ	4	;(1)	;DEFAULT-Disk
  0005                          bdosjp	equ	5	;(3)	;BDOS-Sprung
                                
                                 IF oss		;OSS-Hilfsadressen <4000h !
                                 ENDIF
                                
                                ; In CP/M zugelassener Scratch-Bereich fuer BIOS 40h..4fh
  0040                          lampbf	equ	40h	;(1)	;Puffer Tastaturlampen
                                				;Bedeutung (wenn Lampe vorhanden)
  0000                          lmpsl0	equ	0	;	Selektor 0
  0001                          lmpsl1	equ	1	;	Selektor 1
  0002                          lmpsl2	equ	2	;	Selektor 2
  0003                          lmpsl3	equ	3	;	Selektor 3
  0004                          lmpb2b	equ	4	;	2 Bahn Drucker beide Bahnen parallel
  0005                          lmpb2r	equ	5	;	2 Bahn Drucker rechte Bahn
  0006                          lmperr	equ	6	;	Fehler Lampe
  0007                          lmphcp	equ	7	;	Hardcopy (INSM) Lampe
  0041                          tim5cn	equ	41h	;(2)	;25-ms-Zaehler aufwaerts
  0043                          tim1cn	equ	43h	;(2)	;1-sec-Zaehler abwaerts
  0045                          tim1rt	equ	45h	;(2)	;Adr. der 1-sec Interr.routine
  004A                          kritbg	equ	4ah	;(2)	;Adr. der Nutzerroutine fuer Beginn zeit-
                                			;	;kritischer BIOS-Abschnitte (z.B. Floppy)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-13


  004C                          kriten	equ	4ch	;(2)	;Adr. Enderoutine fuer kritbg
  004E                          cpmext	equ	4eh	;(2)	;Adr. Sprungvektor CP/M-Erw.
                                
                                 IF uhrvar
  0050                          bcduhr	equ	50h	;(3)	;HH:MM:SS (40h ist Adr. in SCP)
                                ;		53h	;(3)	;DD:MM:YY
                                 ENDIF
                                
  0100                          tpa	equ	100h		;Programmladepunkt
                                
                                
                                ;************************Ende Varianten-Vereinbarungen*****************
                                
                                 IF1
                                 ENDIF
                                	page	66
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-14


                                
                                
                                ; Die folgenden EQU's dienen dazu, um bereits zum Zeitpunkt der
                                ; Uebersetzung eine Verschiebung des Ladepunktes durch ein zu
                                ; lang gewordenes BIOS zu erkennen.
                                
  3100                          biosl0	aset	(biosln+0ffh) and 0ff00h;auf 256-Grenze runden
  CF00                          biosad	aset	rambyt-biosl0	;BIOS-Ladeadresse
  C105                          tpaend	equ	biosad-bdosln+5 ;Laenge BDOS abziehen
                                
  F700                          intvec	equ	rambyt-crtbfl-100h	;Interruptvektoradr.
                                ;				 liegt immer 100h vor BS-Puffer
                                ;				 bei 64k RAM auf F700H
  F7D0                          intvr	aset	intvec+intvl	;nur hinterer teil genutzt
                                
  C100                          BDOS	equ	biosad-bdosln	;vermeiden Externals, da linkmt
  B900                          CCP	equ	BDOS-ccpln	;nicht ganz sauber ist
                                
                                
                                ;------------------------------------------------------------
                                ;	BEGINN BIOS-CODE
                                ;------------------------------------------------------------
                                
                                	.PHASE	biosad
                                 IF1
                                 ENDIF
                                
  CF00    C3 E894               BIOS00: JP	kaltst
  CF03    C3 E7C9               BIOS03: JP	warmst
  CF06    C3 E620               BIOS06: JP	const	;CON:	Status; oA =FF bereit, =00 sonst
  CF09    C3 E62C               BIOS09: JP	conin	;CON:	Zeichen oA (solange Warten)
  CF0C                          conol:	;conout mit evtl. hardcopy
  CF0C    C3 E638               BIOS0C: JP	conout	;CON:	Zeichen iC
  CF0F    C3 E674               BIOS0F: jp	list	;LST:	Zeichen iC
  CF12    C3 E65C               BIOS12: jp	punch	;PUN:	Zeichen iC
  CF15    C3 E650               BIOS15: jp	reader	;RDR:	Zeichen oA (solange Warten)
  CF18    C3 DB20               BIOS18: JP	home		;./. (trk:=0)
  CF1B    C3 D88E               BIOS1B: JP	seldsk		;iC (0=A,1=B,..); oHL ^DPH
  CF1E    C3 DB2F               BIOS1E: JP	settrk		;iBC
  CF21    C3 DB34               BIOS21: JP	setsec		;iBC
  CF24    C3 DB39               BIOS24: JP	setdma		;iBC
  CF27    C3 DBBA               BIOS27: JP	read		;oA Resultat; A=0 ok, A=1 sonst
  CF2A    C3 DB42               BIOS2A: JP	write		;oA Resultat; A=0 ok, A=1 sonst
  CF2D    C3 E668               BIOS2D: jp	listst	;LST:	Status; oA =FF bereit, =00 sonst
  CF30    C3 DB3E               BIOS30: JP	sectran		;iBC log. Sektnr (ab 0!!),
                                				;iDE ^Sektor-Translate-Tabelle
                                				;oHL Sektornr. fuer setsec
                                
                                ; Die folgenden Bytes liegen an der gleichen Stelle im BIOS
                                ; wie bei SCP fuer Buerocomputer und dienen zur sicheren Er-
                                ; kennung von SCP-spezifischen Programmen, da diese an dieser
                                ; Stelle testen.
                                
  CF33    43 50                 BIOS33: db	'CP'		;SCP-Kennzeichen ist 'BW '
  CF35    41                    	db	'A'		;'CPA'
  CF36                          BIOS36:
  CF36    42                    	db	'B'		;Hardware Buerocomputer
  CF37    36                    	db	'6'		;Schnittstellen-Version
                                
                                ; Die folgenden Bytes dienen der direkten Bildschirmbedienung ohne
                                ; BIOS-Benutzung fuer extreme Zeitanforderungen
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-15


  CF38                          BIOS38:
  CF38    FC00                  crtcps: dw	bsanf1		;Kursorposition im Bildschirmpuffer
  CF3A    FF                    crtccn: db	0ffh		;Zeittaktzaehler fuer Kursorpflege
                                ; Die folgenden Bytes dienen der Tastenumdefinition von aussen
  CF3B                          BIOS3B:
  CF3B    D29B                  kbdsst: dw	kbdsts		;Standard-Stringtabelle (bei jedem Warmstart)
                                			;Aufbau: virt. Tastencode,Laenge,String,...,0ffh
  CF3D                          BIOS3D:
                                ; Die folgenden beiden Bytes dienen der Einstellung spezieller Zust. von aussen
                                ;*************************************************************
                                ;	Synchronisierungsflags
                                ;*************************************************************
                                
  CF3D    00                    synflg: db	0		;Synchr.-Flags
  0000                          ctrlst	equ	0		;CTRL-Status-Bit (=0 fest!)
                                 IF monitor
                                 ENDIF
                                 IF umlaut
  0002                          umlflg	equ	2		;Umlaute umkodieren
                                 ENDIF
                                 IF stpvar
                                  IF chdvar
  0003                          synlrq	equ	3		;Anforderung LST:-Kanal zu synchron.
                                  ENDIF
                                 ENDIF
  0004                          stoprq	equ	4		;Stop-Anforderung
                                 IF monitor
                                 ENDIF
  0006                          stzaus	equ	6		;keine Pflege der Statuszeile
                                 IF stpvar
  0007                          phyact	equ	7		;Tasten physisch in Puffer
                                 ENDIF
                                
                                ;!!synsem muss direkt nach synflg liegen!!
  CF3E    01                    synsem: db	1		;bei >0 keine asynchr. Arbeit
                                
  CF3F                          BIOS3F:
                                ;=====================Ende des festen BIOS-Vektors=========================
                                
                                 IF1 ;dphaX wird spaeter bei existierendem Geraet X <>0 gesetzt
                                 ENDIF
                                
                                ; Parameterheader fuer Disketten
                                ;-------------------------------
                                
                                	IRP	di,<A,B,C,D>
                                 IF disk&di
                                dph&di: DW	0,0,0,0,dirbuf
                                	DW	dpb&di,csv&di,alv&di
                                dpha&di aset	dph&di
                                 ENDIF
                                	ENDM
  CF3F    0000 0000       +     dph&A: DW	0,0,0,0,dirbuf
  CF43    0000 0000       +     
  CF47    F0E9            +     
  CF49    CF6F F195       +     	DW	dpb&A,csv&A,alv&A
  CF4D    F169            +     
  CF4F    0000 0000       +     dph&B: DW	0,0,0,0,dirbuf
  CF53    0000 0000       +     
  CF57    F0E9            +     
  CF59    CFBC F1E7       +     	DW	dpb&B,csv&B,alv&B
  CF5D    F1B5            +     
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-16


  CF5F    0000 0000       +     dph&C: DW	0,0,0,0,dirbuf
  CF63    0000 0000       +     
  CF67    F0E9            +     
  CF69    CFEF F259       +     	DW	dpb&C,csv&C,alv&C
  CF6D    F227            +     
                                
                                ; Bemerkungen zur Arbeit ohne automatische Formaterkennung:
                                ;---------------------------------------------------------
                                ; Die folgende DPB-Generierung erzeugt entspr. 'dbufsz' das
                                ; jeweilige Standardformat von CP/A, so dass dieses bei Arbeit
                                ; ohne automatische Formaterkennung eingestellt ist.
                                ; Nutzerspezifische Modifizierungen koennen in den Standard-DPB's
                                ; vorgenommen werden. Kommt dabei das Format der Kaltstart-
                                ; Diskette nicht mehr vor, so muss diese nach dem Kaltstart
                                ; gegen die Nutzerdiskette gewechselt werden. Dadurch ist z.B.
                                ; fuer extreme TPA-Anforderungen nur 128er Diskettenformat
                                ; moeglich (kein 1K Diskettenpuffer!), obwohl der Kaltstart von
                                ; einer Diskette mit 1K Sektoren erfolgte.
                                
                         C      	include BIOSDPBM
                         C      ; Struktur DPB (einschl. Erweiterung gegenueber Standard-DPB)
                         C      ; Standard-Teil:
  0000                   C      dpbspt	equ	0	;(dw)	128-Sektoren pro Spur
  0002                   C      dpbbls	equ	2	;(db)	blockshift (3=1K, 4=2K)
  0003                   C      dpbblm	equ	3	;(db)	blockmask
  0004                   C      dpbexm	equ	4	;(db)	extentmask
  0005                   C      dpbsiz	equ	5	;(dw)	Kapazitaet -1 in Bloecken
  0007                   C      dpbdir	equ	7	;(dw)	Anzahl -1 DIR-Eintraege
  0009                   C      dpbalc	equ	9	;(dw)	Allocation-Bits fuer DIR
  000B                   C      dpbchk	equ	11	;(dw)	Check-Size fuer 'R/O'-Test
  000D                   C      dpbofs	equ	13	;(dw)	Zahl der Systemspuren
                         C      ; Ab Byte 15 folgt Nicht-Standard fuer DPB
                         C      
                         C      ; DPB-Steuerinformationen
  000F                   C      dpbflg	equ	15	;(db)	Flags, i.a. alle =0
  0003                   C      dpbfsm	equ	3	;	0..3 Zahl der abweichend vom
                         C      			;	restlichen Spurformat mit 
                         C      			;	26*128 formatierten Spuren
  0002                   C      dpbffm	equ	2	;	=1, wenn FM-Aufzeichung zu erzwingen
                         C      			;	    (d.h. FM-Disk in MFM-Laufwerk)
  0003                   C      dpbfsv	equ	3	;	=1, wenn Double sided zu betreiben,
                         C      			;	    indem von aussen nach innen
                         C      			;	    und auch Rueckseite von aussen
                         C      			;	    nach innen
                         C      			;	=0, wenn Double sided zu betreiben,
                         C      			;	    indem zunaechst von aussen nach
                         C      			;	    innen und Rueckseite von innen
                         C      			;	    nach aussen
                         C      			;	immer mit dpbf86+dpbfds zusammen setzen!
  0004                   C      dpbf86	equ	4	;	=1, dpbfsv benutzen
                         C      			;	=0, wenn Double sided zu betreiben,
                         C      			;	    indem ungerade logische Spuren
                         C      			;	    auf der Rueckseite liegen
                         C      			;	immer mit dpbfds zusammen setzen!
  0005                   C      dpbfds	equ	5	;	=1, wenn Double sided zu betreiben
  0006                   C      dpbfrm	equ	6	;	=1, wenn keine autom. Format-
                         C      			;	    erkennung in Seldsk
  0007                   C      dpbfnd	equ	7	;	=1, wenn abweichende DPB-Struktur
                         C      			;	    (keine Disketten)
                         C      
  0010                   C      dpbslc	equ	16	;(db)	Sektorlaengencode
  0011                   C      dpbbfm	equ	17	;(db)	Puffermaske, d.h. Anzahl der 128er
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-17


                         C      			;	Sektoren im Puffer -1
                         C      			;	muss < 2**(dbufsz-7) sein,
                         C      			;	muss < 2**dpbslc sein, wenn phys.
                         C      			;	Sektornummern in dpbstr nicht monoton
  0012                   C      dpbstp	equ	18	;(db)	Stepimpulse pro Spurpositionierung
                         C      			;	1 oder 2
  0013                   C      dpbsn0	equ	19	;(db)	Verschiebung der Sektor-Numm. auf Rueckseite
  0014                   C      dpbtrk	equ	20	;(db)	log. Anzahl Spuren
                         C      ; geraeteabh.Parameter:
  0015                   C      dpbdnr	equ	21	;(db)	physische Laufwerksnummer
  0016                   C      dpbptr	equ	22	;(db)	Gesamtzahl physische Spuren (40/77/80)
  0017                   C      dpbsti	equ	23	;(db)	Schrittzeit in 0.1 ms
  0018                   C      dpbtyp	equ	24	;(db)	Laufwerkstyp:
  0000                   C      dpbtds	equ	0	; =0 bei SS, =1 bei DS
  0003                   C      dpbtdd	equ	3	; =0 bei SD (FM), =1 bei DD (MFM)
  0004                   C      dpbt5z	equ	4	; =0 bei 8", =1 bei 5"
  0005                   C      dpbt80	equ	5	; =0 bei nicht 80-Spur, =1 bei 80-Spur
  0006                   C      dpbtwv	equ	6	; =0 ohne, =1 mit Verify nach Schreiben
  0007                   C      dpbt52	equ	7	; =0 bei max 26 ,=1 bei max 52 Sekt./Spur (8" MFM)
                         C      ; physische Sektortranslate-Tabelle (sollte am Ende liegen,
                         C      ; um bei festem Format mit weniger als 26 phys. Sektoren den
                         C      ; DPB entspr. verkuerzen zu koennen)
  0019                   C      dpbstr	equ	25	;(ds26)	entspr. phys. Sektoren pro Seite
                         C      
  0033                   C      dpblng	equ	dpbstr+26	;(max.) Laenge eines DPB
                         C      		;***bei 8" MFM:  52 Sektoren, d.h. dpblng um 26 groesser***
                                
                                ; Im folgenden kein IRP im Assembler moeglich, da INCLUDE
                                
                                 IF diska ne 0
  2A7D                          diskdi	aset	diska
  0000                          @din	aset	0
  CF6F                   C      DPBA:	include BIOSDPB
                         C      ;;BIOSDPB, Version 18.05.89
                         C       if dbufsz le 7
                         C       else
                         C       if dbufsz lt 10
                         C       else ;;dbufsz ge 10
                         C        if	((diskdi mod 10000)/1000) and 00000001b		;;DS
                         C        else							;;SS
                         C         if	(diskdi mod 100) eq 40				;;40 Tr.
                         C         endif
                         C         if	(diskdi mod 100) eq 77				;;77 Tr.
  CF6F    0020           C      	DW	32	;;(0)	;SECTORS/TRACK	(LOGIN)
  CF71    04             C      	DB	4	;;(2)	;BLOCK SHIFT	(LOGIN)
  CF72    0F             C      	db	0fh	;;(3)	;BLOCK MASK	(LOGIN)
  CF73    01             C      	DB	1	;;(4)	;EXTENT MASK	(LOGIN)
                         C       if @fsys
                         C       else
  CF74    0093           C      	DW	296/2-1 ;;(5)	;Blockanzahl- 1 (LOGIN)
                         C       endif
  CF76    003F           C      	DW	64-1	;;(7)	;DIR MAX	(LOGIN)
  CF78    80 00          C      	DB	080H,0	;;(9)	;ALLOC fuer dir.(LOGIN)
  CF7A    0010           C      	DW	16	;;(11)	;CHECK SIZE	(LOGIN)
                         C       if @fsys
                         C       else
  CF7C    0003           C      	DW	3	;;(13)	;OFFSET		(LOGIN)
                         C       endif
                         C         endif
                         C         if	(diskdi mod 100) eq 80				;;80 Tr.
                         C         endif
                         C        endif
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-18


                         C       endif
                         C       endif
                         C      
                         C      ;; Nicht-Standard-DPB-Teil
  0000                   C      @dpbhl	aset	0
                         C       if	((diskdi mod 10000)/1000) and 00000001b
                         C       endif
                         C       if @fact eq 0 ;;keine autom. Formaterkennung scharf, Format annageln
                         C       endif
  CF7E    00             C      	db	@dpbhl
                         C       if dbufsz le 7
                         C       endif
                         C       if (dbufsz lt 10) and (dbufsz gt 7)
                         C       endif
                         C       if dbufsz ge 10
  CF7F    03             C      	db	3		;;Sektorlaengencode
  CF80    07             C      	db	7		;;Puffermaske 8*128
                         C       endif
  CF81    01             C      	db	1		;;Zahl der Stepimpulse
  CF82    00             C      	db	0		;;keine Weiter-Numm. auf Rueckseite
  CF83    4D             C      	db	diskdi mod 100	;;benutztye Zahl phys. Spuren
  CF84    00             C      	db	@din		;;phys. LW-Nr.
  CF85    4D             C      	db	diskdi mod 100	;;maximale Zahl phys. Spuren
                         C       if	(diskdi mod 1000)/100 eq 5	;;5" 
                         C       else	;;8" 
  CF86    6E             C      	db	11*10		;;Schrittzeit fuer 8" LW
                         C       endif
                         C      
  0000                   C      @dpbhl	aset	0		;;vorbereiten Laufwerkstyp-Flags
                         C      
                         C       if	(diskdi ge 10000)
  0008                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtdd)	;;double density
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 5
                         C       endif
                         C       if (diskdi mod 100) eq 80
                         C       endif
                         C       if	((diskdi mod 10000)/1000) and 00000001b
                         C       endif
                         C       if ((diskdi mod 10000)/1000) and 00000010b
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C         if	(diskdi ge 10000) ;;8" MFM
  0088                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt52) ;;vermerken max. 52 Sektoren/Spur
                         C         endif
                         C       endif
  CF87    88             C      	db	@dpbhl	;;vom Laufwerkstyp abhaengige Flags
                         C      
                         C       if	(diskdi mod 1000)/100 eq 5 ;;5" 
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C        if	(diskdi ge 10000) ;;8" MFM
                         C       ;; log. Sektortranslate-Tabelle
  CF88    01 02 03 04    C      	db	1,2,3,4,5,6,7,8,9,10,11,12,13,14
  CF8C    05 06 07 08    C      
  CF90    09 0A 0B 0C    C      
  CF94    0D 0E          C      
  CF96    0F 10 11 12    C      	db	15,16,17,18,19,20,21,22,23,24,25,26
  CF9A    13 14 15 16    C      
  CF9E    17 18 19 1A    C      
  CFA2    1B 1C 1D 1E    C      	db	27,28,29,30,31,32,33,34,35,36,37,38,39
  CFA6    1F 20 21 22    C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-19


  CFAA    23 24 25 26    C      
  CFAE    27             C      
  CFAF    28 29 2A 2B    C      	db	40,41,42,43,44,45,46,47,48,49,50,51,52
  CFB3    2C 2D 2E 2F    C      
  CFB7    30 31 32 33    C      
  CFBB    34             C      
                         C        endif
                         C       endif	;;8" 
                                 ENDIF
                                 IF diskb ne 0
  2D3C                          diskdi	aset	diskb
  0001                          @din	aset	1
  CFBC                   C      DPBB:	include BIOSDPB
                         C      ;;BIOSDPB, Version 18.05.89
                         C       if dbufsz le 7
                         C       else
                         C       if dbufsz lt 10
                         C       else ;;dbufsz ge 10
                         C        if	((diskdi mod 10000)/1000) and 00000001b		;;DS
                         C         if	(diskdi mod 100) eq 40				;;40 Tr.
                         C         endif
                         C         if	(diskdi mod 100) eq 80				;;80 Tr.
  CFBC    0028           C      	DW	40	;;(0)	;SECTORS/TRACK	(LOGIN)
  CFBE    04             C      	DB	4	;;(2)	;BLOCK SHIFT	(LOGIN)
  CFBF    0F             C      	db	0fh	;;(3)	;BLOCK MASK	(LOGIN)
  CFC0    00             C      	DB	0	;;(4)	;EXTENT MASK	(LOGIN)
                         C       if @fsys
                         C       else
  CFC1    018F           C      	DW	800/2-1 ;;(5)	;Blockanzahl- 1 (LOGIN)
  CFC3    00BF           C      	DW	192-1	;;(7)	;DIR MAX	(LOGIN)
  CFC5    E0 00          C      	DB	0e0H,0	;;(9)	;ALLOC fuer dir.(LOGIN)
  CFC7    0030           C      	DW	48	;;(11)	;CHECK SIZE	(LOGIN)
  CFC9    0000           C      	DW	0	;;(13)	;OFFSET		(LOGIN)
                         C       endif
                         C         endif
                         C        endif
                         C       endif
                         C       endif
                         C      
                         C      ;; Nicht-Standard-DPB-Teil
  0000                   C      @dpbhl	aset	0
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0020                   C      @dpbhl	aset	@dpbhl+(1 shl dpbfds)		;;DS betreiben
                         C       endif
                         C       if @fact eq 0 ;;keine autom. Formaterkennung scharf, Format annageln
                         C       endif
  CFCB    20             C      	db	@dpbhl
                         C       if dbufsz le 7
                         C       endif
                         C       if (dbufsz lt 10) and (dbufsz gt 7)
                         C       endif
                         C       if dbufsz ge 10
  CFCC    03             C      	db	3		;;Sektorlaengencode
  CFCD    07             C      	db	7		;;Puffermaske 8*128
                         C       endif
  CFCE    01             C      	db	1		;;Zahl der Stepimpulse
  CFCF    00             C      	db	0		;;keine Weiter-Numm. auf Rueckseite
  CFD0    50             C      	db	diskdi mod 100	;;benutztye Zahl phys. Spuren
  CFD1    01             C      	db	@din		;;phys. LW-Nr.
  CFD2    50             C      	db	diskdi mod 100	;;maximale Zahl phys. Spuren
                         C       if	(diskdi mod 1000)/100 eq 5	;;5" 
                         C        if	(diskdi mod 100) gt 40
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-20


                         C         if ((diskdi mod 10000)/1000) and 00000001b
  CFD3    28             C      	db	4*10		;;Schrittzeit fuer 80 Tr. DS LW
                         C         endif
                         C        endif
                         C       endif
                         C      
  0000                   C      @dpbhl	aset	0		;;vorbereiten Laufwerkstyp-Flags
                         C      
                         C       if	(diskdi ge 10000)
  0008                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtdd)	;;double density
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 5
  0018                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt5z)	;;5" 
                         C       endif
                         C       if (diskdi mod 100) eq 80
  0038                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt80)	;;80-Spur-Laufwerk
                         C       endif
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0039                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtds)	;;double sided
                         C       endif
                         C       if ((diskdi mod 10000)/1000) and 00000010b
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C       endif
  CFD4    39             C      	db	@dpbhl	;;vom Laufwerkstyp abhaengige Flags
                         C      
                         C       if	(diskdi mod 1000)/100 eq 5 ;;5" 
                         C        if dbufsz le 7
                         C        else
                         C      ;; log. Sektortranslate-Tabelle fuer andere Formate
  CFD5    01 02 03 04    C      	db	1,2,3,4,5,6,7,8,9,10,11,12,13,14
  CFD9    05 06 07 08    C      
  CFDD    09 0A 0B 0C    C      
  CFE1    0D 0E          C      
  CFE3    0F 10 11 12    C      	db	15,16,17,18,19,20,21,22,23,24,25,26
  CFE7    13 14 15 16    C      
  CFEB    17 18 19 1A    C      
                         C        endif
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C       endif	;;8" 
                                 ENDIF
                                 IF diskc ne 0
  2D3C                          diskdi	aset	diskc
  0002                          @din	aset	2
  CFEF                   C      DPBC:	include BIOSDPB
                         C      ;;BIOSDPB, Version 18.05.89
                         C       if dbufsz le 7
                         C       else
                         C       if dbufsz lt 10
                         C       else ;;dbufsz ge 10
                         C        if	((diskdi mod 10000)/1000) and 00000001b		;;DS
                         C         if	(diskdi mod 100) eq 40				;;40 Tr.
                         C         endif
                         C         if	(diskdi mod 100) eq 80				;;80 Tr.
  CFEF    0028           C      	DW	40	;;(0)	;SECTORS/TRACK	(LOGIN)
  CFF1    04             C      	DB	4	;;(2)	;BLOCK SHIFT	(LOGIN)
  CFF2    0F             C      	db	0fh	;;(3)	;BLOCK MASK	(LOGIN)
  CFF3    00             C      	DB	0	;;(4)	;EXTENT MASK	(LOGIN)
                         C       if @fsys
                         C       else
  CFF4    018F           C      	DW	800/2-1 ;;(5)	;Blockanzahl- 1 (LOGIN)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-21


  CFF6    00BF           C      	DW	192-1	;;(7)	;DIR MAX	(LOGIN)
  CFF8    E0 00          C      	DB	0e0H,0	;;(9)	;ALLOC fuer dir.(LOGIN)
  CFFA    0030           C      	DW	48	;;(11)	;CHECK SIZE	(LOGIN)
  CFFC    0000           C      	DW	0	;;(13)	;OFFSET		(LOGIN)
                         C       endif
                         C         endif
                         C        endif
                         C       endif
                         C       endif
                         C      
                         C      ;; Nicht-Standard-DPB-Teil
  0000                   C      @dpbhl	aset	0
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0020                   C      @dpbhl	aset	@dpbhl+(1 shl dpbfds)		;;DS betreiben
                         C       endif
                         C       if @fact eq 0 ;;keine autom. Formaterkennung scharf, Format annageln
                         C       endif
  CFFE    20             C      	db	@dpbhl
                         C       if dbufsz le 7
                         C       endif
                         C       if (dbufsz lt 10) and (dbufsz gt 7)
                         C       endif
                         C       if dbufsz ge 10
  CFFF    03             C      	db	3		;;Sektorlaengencode
  D000    07             C      	db	7		;;Puffermaske 8*128
                         C       endif
  D001    01             C      	db	1		;;Zahl der Stepimpulse
  D002    00             C      	db	0		;;keine Weiter-Numm. auf Rueckseite
  D003    50             C      	db	diskdi mod 100	;;benutztye Zahl phys. Spuren
  D004    02             C      	db	@din		;;phys. LW-Nr.
  D005    50             C      	db	diskdi mod 100	;;maximale Zahl phys. Spuren
                         C       if	(diskdi mod 1000)/100 eq 5	;;5" 
                         C        if	(diskdi mod 100) gt 40
                         C         if ((diskdi mod 10000)/1000) and 00000001b
  D006    28             C      	db	4*10		;;Schrittzeit fuer 80 Tr. DS LW
                         C         endif
                         C        endif
                         C       endif
                         C      
  0000                   C      @dpbhl	aset	0		;;vorbereiten Laufwerkstyp-Flags
                         C      
                         C       if	(diskdi ge 10000)
  0008                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtdd)	;;double density
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 5
  0018                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt5z)	;;5" 
                         C       endif
                         C       if (diskdi mod 100) eq 80
  0038                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt80)	;;80-Spur-Laufwerk
                         C       endif
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0039                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtds)	;;double sided
                         C       endif
                         C       if ((diskdi mod 10000)/1000) and 00000010b
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C       endif
  D007    39             C      	db	@dpbhl	;;vom Laufwerkstyp abhaengige Flags
                         C      
                         C       if	(diskdi mod 1000)/100 eq 5 ;;5" 
                         C        if dbufsz le 7
                         C        else
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-22


                         C      ;; log. Sektortranslate-Tabelle fuer andere Formate
  D008    01 02 03 04    C      	db	1,2,3,4,5,6,7,8,9,10,11,12,13,14
  D00C    05 06 07 08    C      
  D010    09 0A 0B 0C    C      
  D014    0D 0E          C      
  D016    0F 10 11 12    C      	db	15,16,17,18,19,20,21,22,23,24,25,26
  D01A    13 14 15 16    C      
  D01E    17 18 19 1A    C      
                         C        endif
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C       endif	;;8" 
                                 ENDIF
                                 IF diskd ne 0
                                 ENDIF
                                
                                
                                ;=======================
                                ; CP/M-Erweiterungen
                                ;=======================
  D022                          cpmx00: IF	monitor
                                	ELSE
  D022    C9                    	ret
  D023    00                    	nop
  D024    00                    	nop
                                	ENDIF
  D025    C3 E53A               cpmx03: jp	tim5on		;5ms Takt an
  D028    C3 E541               cpmx06: jp	tim5of		;5ms Takt aus
  D02B    C3 E545               cpmx09: jp	tim1on		;1s Takt an
  D02E    C3 E54C               cpmx0c: jp	tim1of		;1s Takt aus
                                	IF	mprot
                                	ELSE
  D031    C9                    	ret
  D032    00                    	nop
  D033    00                    	nop
  D034    C9                    	ret
  D035    00                    	nop
  D036    00                    	nop
  D037    C9                    	ret
  D038    00                    	nop
  D039    00                    	nop
                                	ENDIF
                                 IF stpvar or monitor
  D03A    C3 E69B               cpmx18: jp	delsps		;verzoegern Sondertasten
  D03D    C3 E6A8               cpmx1b: jp	delspr		;erlauben Sondertasten
                                 ENDIF
                                 IF umlaut
  D040    C3 D57F               cpmx1e: jp	crtuml
                                 ENDIF
  D043    C3 DCFF               cpmx21: jp	diskio		;phys. Disktransfer
                                				;Schnittstelle siehe BIOxDSKT.MAC
                                
                                	page	66
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-23


                                
                                ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                                ;	Beginn BIOS-Treiber
                                ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                                
                                ; Dummy-Treiber
  D046                          dumst:
  D046    AF                    	xor	a
  D047    3D                    	dec	a		;Status immer FF (bereit)
                                 IF iobvar
                                 ENDIF
  D048    C9                    	ret			;Status immer FF (bereit)
                                
                                 IF iobvar
  D049    3E 1A                 dumi:	ld	a,1ah		;Eingabe-Zeichen immer EOF
  D04B    C9                    	ret
  D04C    79                    dumo:	ld	a,c
  D04D    11 D059               	ld	de,dumoh
  D050    CD E799               	call	mrecoa		;Zeichen hex aufbereiten
  D053    0E 28                 	ld	c,'('
  D055    CD D36E               	call	crto
  D058    01 0000               	ld	bc,0
  D059                          dumoh	equ	$-2
  D05B    C5                    	push	bc
  D05C    CD D36E               	call	crto
  D05F    C1                    	pop	bc
  D060    48                    	ld	c,b
  D061    CD D36E               	call	crto
  D064    0E 29                 	ld	c,')'
  D066    C3 D36E               	jp	crto
                                 ENDIF
                                
                         C      	include BIOSKBD
                         C      ;****************************************************
                         C      ;	Tastatur-Eingabe
                         C      ; - Unterstuetzung weiterer Steckplaetze fuer IFSS-Tastatur
                         C      ;   (z.B. Digitalisier-AP)
                         C      ; - freie Belegbarkeit Kursor- und rechter Ziffernblock
                         C      ; 17.07.88
                         C      ; - uebersichtlichere Darstellung phys. -> virtueller Tastencode
                         C      ; 24.09.88
                         C      ; - Anpassung Tastaturpuffer in Statuszeile an umschaltbaren Bildschirmpuffer
                         C      ; 25.09.88
                         C      ; - Fehler in Stop-Tasten-Behandlung korrigiert
                         C      ; 07.11.88
                         C      ; - Erweiterung des virtuellen Tastaturcodes um K7634-spezifische Tasten
                         C      ; 23.12.88
                         C      ; - saemtliche Sondertasten c0..ff liefern mit Control oder Shift einen
                         C      ;   virtuellen Zwischencode 80..bf
                         C      ; 14.01.89
                         C      ; - Variante K7633 (kbdotp eq 3) eingefuehrt
                         C      ; - wenn Tastatur nach RESET gross schreibt, so caps-lock-Test invertiert
                         C      ; 20.01.89
                         C      ; - Abtesten auf ^Q-Prefix ueber virtuellen Tastencode
                         C      ; 22.03.89
                         C      ; - Control-Flag gilt genau fuer das naechste Zeichen
                         C      ; 31.03.89
                         C      ; - Sondertasten >=80h ignoriert, wenn nicht in Tastatur-Tabelle
                         C      ; 25.09.89
                         C      ; - Fehlerkorrektur K7637: CTRL-Ersatztaste brachte kein ^Q-Prefix
                         C      ;****************************************************
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-24


                         C      
                         C       if1
                         C       endif	;if1
                         C      
                         C      ; Tastatur-Status
                         C      ;================
  D069                   C      kbdst:
                         C      ; vor Pufferabfrage anstehende Zeichen lesen (falls 5ms Takt aus)
  D069    F3             C      	di			;parallele Abfrage ueber 5ms verhindern
                         C       IF cpastz
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
  D06A    CD D071        C      	call	kbdsti		;interner Aufruf
  D06D    FB             C      	ei
                         C       IF stpvar or monitor
  D06E    C3 E6B4        C      	jp	chksp		;Test auf Spezialfunktionen
                         C       ENDIF
                         C      
  D071                   C      kbdsti:				;kbdst-Aufruf intern
  D071    CD D14D        C      kbdstz:	call	kbdst1		;Taste neu gedrueckt ?
  D074    28 05          C      	jr	z,kbdsnt	;nein
  D076    CD D082        C      	call	kbdrdt		;Taste in Puffer ablegen
                         C       IF stpvar
                         C       ENDIF
  D079    18 F6          C      	jr	kbdstz		;auf neuen Tastendruck testen
                         C      
  D07B    3E 00          C      kbdsnt:	ld	a,0		;erstes Pufferzeichen
  D07C                   C      kbdbfe	equ	$-1
  D07D    B7             C      	or	a		;Puffer leer?
  D07E    C8             C      	ret	z		;ja
  D07F    3E FF          C      	ld	a,0ffh
  D081    C9             C      	ret
                         C      
                         C      ;------------------------------------------------------------
                         C      
                         C      
                         C      ; Taste umkodieren und im Puffer ablegen
                         C      ;=======================================
                         C      ; Achtung!! Dieses UP wird aus Interruptroutine aufgmrufen
  D082    CD D16D        C      kbdrdt:	call	kbdrch		;Zeichen evtl. umkodieren
  D085    21 CF3D        C      	ld	hl,synflg
                         C      
  D088    FE DF          C      	cp	ctlc		;Ersatz-Control-Taste ?
  D08A    20 05          C      	jr	nz,kbdnct	;nein
  D08C    7E             C      	ld	a,(hl)
  D08D    EE 01          C      	xor	1 shl ctrlst	;CTRL-Status umkehren
  D08F    77             C      	ld	(hl),a
  D090    C9             C      	ret			;und Zeichen ignorieren
  D091                   C      kbdnct:
                         C      
                         C       IF stpvar
  D091    CB 7E          C      	bit	phyact,(hl)	;Taste physisch in Puffer?
  D093    C2 D0DC        C      	jp	nz,kbdput	;ja, direkt ablegen
                         C       ENDIF
                         C       IF costu
                         C       ENDIF
  D096    2A CF3B        C      	ld	hl,(kbdsst)	;Adresse der Standardstringtabelle
  D099    CD D1B3        C      	call	costr		;Standardstring?
  D09C    28 07          C      	jr	z,kbdnco	;nein
  D09E    1D             C      kbdco:	dec	e		;String der Laenge 0?
  D09F    C8             C      	ret	z		;ja, zu ignorierende Taste
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-25


  D0A0    1D             C      	dec	e		;String exakt ein Zeichen lang?
  D0A1    C2 D0F3        C      	jp	nz,kbdco1	;nein, kann keine Sondertaste sein
  D0A4    7E             C      	ld	a,(hl)		;holen erstes Stringzeichen
  D0A5    21 CF3D        C      kbdnco:	ld	hl,synflg
                         C      
                         C      ; Auswertung Sondertasten, die nicht im Puffer abgelegt werden
                         C      ;-------------------------------------------------------------
                         C      
  D0A8    FE DE          C      	cp	stpc		;STOP ?
  D0AA    20 0A          C      	jr	nz,kbdnst
  D0AC    CB E6          C      	set	stoprq,(hl)	;Stop-Request vermerken
                         C      
                         C      ; Rest des Konsolpuffers streichen
                         C      ;---------------------------------
  D0AE    AF             C      kbdbcl:	xor	a
                         C       IF cpastz
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
  D0AF    32 FFFF        C      	ld	(0ffffh),a
  D0B0                   C      crtm36	equ	$-2
                         C       IF cpastz
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
  D0B2    32 D07C        C      	ld	(kbdbfe),a
  D0B5    C9             C      	ret
                         C      
  D0B6                   C      kbdnst:
                         C       IF stpvar
                         C       IF chdvar
  D0B6    FE D9          C      	cp	SyLc		;Drucker Synchronisieren?
  D0B8    20 03          C      	jr	nz,kbdnsy	;nein
  D0BA    CB DE          C      	set	synlrq,(hl)	;sonst vermerken
  D0BC    C9             C      	ret
  D0BD                   C      kbdnsy:
  D0BD    FE DA          C      	cp	HrLc		;Hardcopy ein/aus ?
  D0BF    20 0C          C      	jr	nz,kbdnhc
  D0C1    21 CF0C        C      	ld	hl,conol
  D0C4    7E             C      	ld	a,(hl)
  D0C5    EE 0E          C      	xor	0cdh xor 0c3h	;CALL aus JP u.umgekehrt
  D0C7    77             C      	ld	(hl),a
  D0C8    3E 80          C      	ld	a,1 shl lmphcp	;Hardcopy-Lampe
  D0CA    C3 D1C5        C      	jp	kbdslm
  D0CD                   C      kbdnhc:
                         C       ENDIF
                         C       ENDIF	;stpvar
                         C      
                         C       IF monitor
                         C       ENDIF
                         C      
  D0CD    FE D1          C      	cp	Sel0		;Selector 0?
  D0CF    38 09          C      	jr	c,kbdnsl	;nein
  D0D1    FE D9          C      	cp	Sel3+1		;Selector 0..3?
  D0D3    30 05          C      	jr	nc,kbdnsl	;nein
  D0D5    E6 0F          C      	and	0fh		;Bit 0..3
  D0D7    C3 D1C5        C      	jp	kbdslm
  D0DA                   C      kbdnsl:
  D0DA    B7             C      	or	a		;Taste zu ignorieren?
  D0DB    F8             C      	ret	m		;ja
                         C      
                         C      ; Zeichen im Puffer ablegen
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-26


                         C      ;--------------------------
  D0DC                   C      kbdput:
                         C       IF cpastz
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
  D0DC    21 FFFF        C      	ld	hl,0ffffh	;Pufferadresse
  D0DD                   C      crtm35	equ	$-2
  D0DF    01 0014        C      	ld	bc,kbdbl	;Pufferlaenge
  D0E2    5F             C      	ld	e,a		;A retten
  D0E3    AF             C      	xor	a		;Pufferende-Kennzeichen
  D0E4    ED B1          C      	cpir
  D0E6    20 08          C      	jr	nz,kbdpt1	;Puffer voll
  D0E8    77             C      	ld	(hl),a		;neues Pufferende anzeigen
  D0E9    7B             C      	ld	a,e		;A wiederherstellen
  D0EA    2B             C      	dec	hl
  D0EB    77             C      	ld	(hl),a		;Zeichen puffern
                         C      ;um bei Arbeit mit Anzeige des Tastaturpuffers in Statuszeile
                         C      ;Bildschirmflimmern zu vermeiden hinterlegen des gepufferten Zeichens
                         C      ;ausserhalb des Bildschirmbereichs fuer Test, ob ueberhaupt etwas im Puffer
                         C       IF cpastz
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
  D0EC    32 D07C        C      	ld	(kbdbfe),a
  D0EF    C9             C      	ret
  D0F0                   C      kbdpt1:
                         C       IF cpastz
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
  D0F0    C3 D50D        C      	jp	crtclk		;Puffer voll anzeigen
                         C      
                         C      ; Ablegen String im Puffer
                         C      ;-------------------------
                         C      ; i E	Stringlaenge -1
                         C      ; i HL	Stringanfang
  D0F3    1C             C      kbdco1:	inc	e
  D0F4    E5             C      kbdco2:	push	hl
  D0F5    D5             C      	push	de
  D0F6    7E             C      	ld	a,(hl)
  D0F7    CD D0DC        C      	call	kbdput		;Zeichen in Puffer
  D0FA    D1             C      	pop	de
  D0FB    E1             C      	pop	hl
  D0FC    23             C      	inc	hl
  D0FD    1D             C      	dec	e
  D0FE    20 F4          C      	jr	nz,kbdco2	;wenn String noch nicht fertig
  D100    C9             C      	ret
                         C      
                         C      ; Holen naechstes Tastaturzeichen mit Warten
                         C      ;===========================================
  D101                   C      kbdi:
  D101                   C      kbdmd1:		;Modifizierung bei K7634/36/37 mit:
                         C      ;kbdwin:call	kbdst		;Taste im Puffer
                         C      ;	jr	z,kbdwin	;nein, warten
                         C      ;	jp	kbdinn		;sonst aeltestes Pufferzeichen
                         C      
  D101    CD D069        C      kbdwin:	call	kbdst		;Taste im Puffer?
  D104    20 32          C      	jr	nz,kbdinn	;ja
  D106    21 D10A        C      	ld	hl,kbdwt	;wartefaktor
  D109    06 64          C      	ld	b,100		;fuer dauerfunktion
  D10A                   C      kbdwt	equ	$-1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-27


  D10B    36 0A          C      	ld	(hl),10		;auf 10*0,01sec fuer
                         C      				;gleiche taste
  D10D    18 07          C      	jr	kbdwst		;einspr. in zyklus
  D10F    C5             C      kbdwa:	push	bc
  D110    06 01          C      	ld	b,1		;0,01 sec warten
  D112    CD E78A        C      	call	wait10
  D115    C1             C      	pop	bc
  D116    CD D14D        C      kbdwst:	call	kbdst1		;taste neu gedrueckt?
  D119    20 13          C      	jr	nz,kbdwb	;ja, abholen ueber kbdst
  D11B    DB 06          C      	in	a,(kbdpci)	;taste noch gedrueckt?
  D11D    B7             C      	or	a		;(funktioniert nur bei K760X!)
  D11E    28 0E          C      	jr	z,kbdwb		;nein; warten
  D120    10 ED          C      	djnz	kbdwa		;abwarten, wie lange
                         C      
  D122    CD D16D        C      	call	kbdrch		;Zeichen umkodieren
  D125    B7             C      	or	a		;Sondertaste?
  D126    FA D101        C      	jp	m,kbdwin	;ja, keine Dauerfunktion
  D129    CD D0DC        C      	call	kbdput		;sonst puffern
  D12C    18 0A          C      	jr	kbdinn		;und aeltestes Pufferzeichen uebergeben
  D12E    CD D069        C      kbdwb:	call	kbdst		;abwarten tastendruck
  D131    28 FB          C      	jr	z,kbdwb
  D133    21 D10A        C      kbdwe:	ld	hl,kbdwt	;bei neuer taste
  D136    36 64          C      	ld	(hl),100	;100*0.01 sec warten
                         C      
  D138                   C      kbdinn:
                         C       IF cpastz
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
  D138    11 FFFF        C      	ld	de,0ffffh	;Kopf des Tastaturpuffers
  D139                   C      crtm33	equ	$-2
  D13B    1A             C      	ld	a,(de)		;1.Zeichen lesen
  D13C    21 0000        C      	ld	hl,0ffffh+1	;Puffer umspeichern
  D13D                   C      crtm34	equ	$-2
  D13F    01 0014        C      	ld	bc,kbdbl	;einschl. 00h am Ende
  D142    ED B0          C      	ldir			;parall. Tastatur-Interrupt
                         C      				;stoert nicht, da alles umgesp.
  D144    5F             C      	ld	e,a
  D145    3A FFFF        C      	ld	a,(0ffffh)
  D146                   C      crtm32	equ	$-2		;auf Kopf des Tastaturpuffers
                         C       IF cpastz
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
  D148    32 D07C        C       	ld	(kbdbfe),a	;neues Zeichen als Flag Puffer voll/leer
  D14B    7B             C      	ld	a,e
  D14C    C9             C      	ret
                         C      
                         C      ;-------------------------------------------------------------
                         C      
                         C      ; Test, ob Taste (neu) gedrueckt
                         C      ;===============================
                         C      ; o AF	=00 und Z=1	keine Taste
                         C      ;	=FF und Z=0	es ist eine Taste gedrueckt
  D14D                   C      kbdst1:
                         C      
                         C      ; Modifiziert bei K7637 mit
                         C      ;kbdst1:in	a,(kbdscs) bzw. (kbddcs)
                         C      ;	and	1
                         C      ;	ret	z		;(a)=0, z=1
                         C      ;	ld	hl,synflg
                         C      ;	bit	ctrlst,(hl)	;Ersatz-CNTL?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-28


                         C      ;	ld	a,0ffh		;Schnittmaske c0..ff -> c0..ff
                         C      ;	jr	z,cst37b	;nein
                         C      ;	ld	a,0bfh		;Schnittmaske c0..ff -> 80..bf
                         C      ;cst37b:ld	(kbdlcs),a
                         C      ;	xor	a
                         C      ;	dec	a		;(a)=ff, z=0
                         C      ;	ret
                         C      
                         C      ; Modifiziert bei K7633 mit
                         C      ;kbdst1:in	a,(kbdbcs)
                         C      ;	and	3
                         C      ;	ret	z		;(a)=0, z=1
                         C      ;	ld	hl,synflg
                         C      ;	bit	ctrlst,(hl)	;Ersatz-CNTL?
                         C      ;	ld	a,0ffh		;Schnittmaske c0..ff -> c0..ff
                         C      ;	jr	z,cst33b	;nein
                         C      ;	ld	a,0bfh		;Schnittmaske c0..ff -> 80..bf
                         C      ;cst33b:ld	(kbdlcs),a
                         C      ;	xor	a
                         C      ;	dec	a		;(a)=ff, z=0
                         C      ;	ret
                         C      
                         C      ; Version fuer alle anderen Tastaturen
  D14D    DB 01          C      	in	a,(kbdpcs)
  D14F    2F             C      kbdstc:	cpl			;auf NOP, wenn Status negiert
                         C      ; Bit 3	=1:Taste gedrueckt
                         C      ; Bit 2	=1:Control gedrueckt
  D150    CB 5F          C      	bit	3,a		;Taste gedrueckt?
  D152    28 17          C      	jr	z,kbdst0	;nein
  D154    21 CF3D        C      	ld	hl,synflg
  D157    CB 57          C      	bit	2,a		;CNTL-Taste gedrueckt?
  D159    28 02          C      kbdstm:	jr	z,cst34a	;nein (auf jr modif., wenn kein CNTL-Status)
  D15B    CB C6          C      	set	ctrlst,(hl)	;sonst vermerken
  D15D    CB 46          C      cst34a:	bit	ctrlst,(hl)	;Taste mit CNTL oder Ersatz-CNTL?
  D15F    3E FF          C      	ld	a,0ffh		;Schnittmaske c0..ff -> c0..ff
  D161    28 02          C      	jr	z,cst34b	;nein
  D163    3E BF          C      	ld	a,0bfh		;Schnittmaske c0..ff -> 80..bf
  D165    32 D1A8        C      cst34b:	ld	(kbdlcs),a
  D168    AF             C      	xor	a
  D169    3D             C      	dec	a		;(a)=ff, z=0
  D16A    C9             C      	ret
  D16B    AF             C      kbdst0:	xor	a		;(a)=0, z=1
  D16C    C9             C      	ret
                         C      ;-------------------------------------------------------------
                         C      
                         C      ;Zeichen von Tastatur lesen , CAPS-Lock realisieren
                         C      ;==================================================
  D16D    CD D186        C      kbdrch:	call	kbdrcu		;Zeichen holen
  D170    21 0040        C      	ld	hl,lampbf
  D173    CB 46          C      	bit	kbdcpb,(hl)	;CAPS-Lock?
  D175    C8             C      kbdmd3:	ret	z		;nein (auf ret nz, wenn nach RESET Grossb.)
  D176    FE 41          C      	cp	'A'
  D178    D8             C      	ret	c
  D179    FE 5B          C      	cp	'Z'+1
  D17B    38 06          C      	jr	c,kbdcp1
  D17D    FE 61          C      	cp	'a'
  D17F    D8             C      	ret	c
  D180    FE 7B          C      	cp	'z'+1
  D182    D0             C      	ret	nc
  D183    EE 20          C      kbdcp1:	xor	20h		;gross <-> klein
  D185    C9             C      	ret
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-29


                         C      ; Zeichen von Tastatur umkodieren
                         C      ;================================
  D186                   C      kbdrcu:
  D186    DB 06          C      	in	a,(kbdpci)	;Zeichen lesen
  D187                   C      kbdmt1	equ	$-1		;auf "kbdsci/kbddci" bei K7637
                         C      
  D188    21 D236        C      cocpm1:	ld	hl,kbdcpt
  D18B    4E             C      kbdrc3:	ld	c,(hl)		;phys. Tastencode
  D18C    0C             C      	inc	c
  D18D    0D             C      	dec	c		;TabEnde?
  D18E    28 07          C      	jr	z,kbdrc1	;ja
  D190    B9             C      	cp	c		;Umcodieren ?
  D191    23             C      	inc	hl
  D192    28 07          C      	jr	z,kbdrc2	;ja
  D194    23             C      	inc	hl
  D195    18 F4          C      	jr	kbdrc3		;weiter in Tab
  D197    FE 80          C      kbdrc1:	cp	80h		;Sonderzeichen, das nicht in Tabelle?
  D199    38 01          C      	jr	c,kbdrc6	;nein; sonst A=00, d.h. Zeichen ignorieren
  D19B    7E             C      kbdrc2:	ld	a,(hl)		;virtueller Tastencode
  D19C                   C      kbdrc6:	
                         C      
  D19C                   C      cocpm2:
  D19C    21 CF3D        C      	ld	hl,synflg
  D19F    FE 20          C      	cp	20h		;Sondertaste?
  D1A1    38 0D          C      	jr	c,kbdrc5	;<20h, ja
  D1A3    FE 80          C      	cp	80h		
  D1A5    38 04          C      	jr	c,kbdrc4	;nein
                         C      ; virtueller Code 80..ff
  D1A7    E6 FF          C      	and	0ffh
  D1A8                   C      kbdlcs	equ	$-1		;auf bfh, wenn Taste mit Control/Shift
  D1A9    18 05          C      	jr	kbdrc5
                         C      ; normale Taste 20..7f
  D1AB    CB 46          C      kbdrc4:	bit	ctrlst,(hl)	;norm. Taste mit Control?
  D1AD    C8             C      	ret	z
  D1AE    E6 1F          C      	and	1fh		;CTRL realisieren
  D1B0    CB 86          C      kbdrc5:	res	ctrlst,(hl)
  D1B2    C9             C      	ret
                         C      
                         C      ; Suchen, ob Taste (A) umzukodieren entspr. Stringtab ab (HL)
                         C      ; ret z:	nicht gefunden, A unveraendert
                         C      ; ret nz:	gefunden, A unveraendert
                         C      ;		E Stringlaenge +1
                         C      ;		HL Stringanfang (nur gueltig falls E>1!)
  D1B3    16 00          C      costr:	ld	d,0
  D1B5    4E             C      costr0:	ld	c,(hl)		;Tastencode o. Tabende
  D1B6    0C             C      	inc	c		;Tabende?
  D1B7    C8             C      	ret	z		;ja, nicht gefunden
  D1B8    23             C      	inc	hl
  D1B9    5E             C      	ld	e,(hl)		;Stringlaenge
  D1BA    1C             C      	inc	e		;+1
  D1BB    0D             C      	dec	c		;Tastencode wiederherstellen
  D1BC    B9             C      	cp	c		;Zeichen umkodieren?
  D1BD    28 03          C      	jr	z,costr1	;ja
  D1BF    19             C      	add	hl,de		;String uebergehen
  D1C0    18 F3          C      	jr	costr0
  D1C2                   C      costr1:
  D1C2    23             C      	inc	hl
  D1C3    14             C      	inc	d		;ret nz
  D1C4    C9             C      	ret
                         C      
                         C       IF costu
                         C       ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-30


                         C      
                         C      ; Tastatur-Lampe umschalten
                         C      ;==========================
  D1C5    21 0040        C      kbdslm:	ld	hl,lampbf
  D1C8    AE             C      	xor	(hl)		;Lampe ein/aus
  D1C9    77             C      	ld	(hl),a
                         C      
                         C      ; Tastatur-Lampen ein/aus
                         C      ;========================
                         C      ; Achtung! Diese Routine wird auch aus Interrupt-Routine
                         C      ; aufgerufen (EI/DI darf hier nicht auftreten!!)
  D1CA                   C      lampen:
                         C      
  D1CA                   C      kbdmd2:		;Routine fuer K7637,
                         C      ;		 wird modifiziert bei K7604/06/34/36
  D1CA    3A 0040        C      lampen:	ld	a,(lampbf)
  D1CD    EE 00          C      	xor	00h		;ermitteln veraenderte Bits
  D1CE                   C      lamplt	equ	$-1		;Kopie Lampen-Puffer
  D1CF    C8             C      	ret	z		;unveraendert
  D1D0    21 E571        C      	ld	hl,intkbd
  D1D3    36 21          C      	ld	(hl),21h	;call ... -> ld hl,...
                         C      				;d.h. 5ms Tastaturabfrage verbieten
  D1D5    26 55          C      	ld	h,55h		;Standard-Vorbyte
  D1D7    6F             C      	ld	l,a
  D1D8    CB 7D          C      	bit	7,l		;INS-MODE ?
  D1DA    28 06          C      	jr	z,lampb6	;nein
  D1DC    7C             C      	ld	a,h
  D1DD    D3 5C          C      	out	(kbdsci),a
  D1DE                   C      k37dm3	equ	$-1		;modfiziert bei Digitalisier-AP
  D1DF    CD D224        C      	call	lmpout
  D1E2    CB 75          C      lampb6:	bit	6,l		;Fehlerlampe ?
  D1E4    28 05          C      	jr	z,lampb3	;nein
  D1E6    3E 20          C      	ld	a,20h
  D1E8    CD D224        C      	call	lmpout
  D1EB    CB 5D          C      lampb3:	bit	3,l		;Sel3?
  D1ED    28 08          C      	jr	z,lampb2
  D1EF    7C             C      	ld	a,h
  D1F0    D3 5C          C      	out	(kbdsci),a
  D1F1                   C      k37dm4	equ	$-1		;modfiziert bei Digitalisier-AP
  D1F2    3E 52          C      	ld	a,52h
  D1F4    CD D224        C      	call	lmpout
  D1F7    CB 55          C      lampb2:	bit	2,l		;Sel2?
  D1F9    28 08          C      	jr	z,lampb1
  D1FB    7C             C      	ld	a,h
  D1FC    D3 5C          C      	out	(kbdsci),a
  D1FD                   C      k37dm5	equ	$-1		;modfiziert bei Digitalisier-AP
  D1FE    3E 44          C      	ld	a,44h
  D200    CD D224        C      	call	lmpout
  D203    CB 4D          C      lampb1:	bit	1,l
  D205    28 08          C      	jr	z,lampb0
  D207    7C             C      	ld	a,h
  D208    D3 5C          C      	out	(kbdsci),a
  D209                   C      k37dm6	equ	$-1		;modfiziert bei Digitalisier-AP
  D20A    3E 20          C      	ld	a,20h
  D20C    CD D224        C      	call	lmpout
  D20F    CB 45          C      lampb0:	bit	0,l
  D211    28 05          C      	jr	z,lampbn
  D213    3E 52          C      	ld	a,52h
  D215    CD D224        C      	call	lmpout
  D218    3A 0040        C      lampbn:	ld	a,(lampbf)
  D21B    32 D1CE        C      	ld	(lamplt),a	;neuen Zustand merken
  D21E    21 E571        C      	ld	hl,intkbd
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-31


  D221    36 CC          C      	ld	(hl),0cch	;ld hl,... -> call z,...
  D223    C9             C      	ret
                         C      
  D224    E5             C      lmpout:	push	hl
  D225    D3 5C          C      	out	(kbdsci),a
  D226                   C      k37dm7	equ	$-1		;modfiziert bei Digitalisier-AP
  D227    CD D14D        C      lmpow:	call	kbdst1		;warten auf Antwort
  D22A    28 FB          C      	jr	z,lmpow
  D22C    DB 5C          C      	in	a,(kbdsci)
  D22D                   C      k37dm8	equ	$-1		;modfiziert bei Digitalisier-AP
  D22E    E6 F0          C      	and	0f0h
  D230    FE 80          C      	cp	typc37		;Antwort da?
  D232    20 F3          C      	jr	nz,lmpow	;nein
  D234    E1             C      	pop	hl
  D235    C9             C      	ret
                         C      
                         C      ; virtuelle Tastencodes: (unabhaengig von TastaturTyp)
                         C      ;=======================
                         C      
                         C      ; Beim Betaetigen zusammen mit CONTROL/SHIFT wird bei allen folgenden
                         C      ; Tastencodes >=c0h Bit 6 geloescht (d.h. Codes liegen von 80h..bfh)
                         C      
                         C      ; Kursortasten
                         C      ;-------------
  00C1                   C      kcurwl	equ	0c1h
  00C2                   C      kcurup	equ	0c2h
  00C3                   C      kcurwr	equ	0c3h
  00C4                   C      kcurlf	equ	0c4h
  00C5                   C      kcurpu	equ	0c5h
  00C6                   C      kcurri	equ	0c6h
  00C7                   C      kcurpd	equ	0c7h
  00C8                   C      kcurdw	equ	0c8h
                         C      
                         C      ; Sondertasten
                         C      ;-------------
                         C      ;		0c9h		;belegt mit zblb
  00CA                   C      spcclr	equ	0cah		;CLEAR
  00CB                   C      spccnc	equ	0cbh		;CNCL	
  00CC                   C      spcce	equ	0cch		;CE bzw. ERASE INPUT
  00CD                   C      spcins	equ	0cdh		;INS
  00C0                   C      spcdel	equ	0c0h		;DEL
  00CE                   C      spckor	equ	0ceh		;KOR
  00CF                   C      spcrol	equ	0cfh		;ROLL <-
  00D0                   C      spcror	equ	0d0h		;ROLL ->
                         C      
                         C      ; Bei Einfuehrung neuer Sonderzeichen zwischen Sel0..Sel3 muss
                         C      ; Test auf Sel0..3 zuletzt erfolgen, da diese als Gruppe
                         C      ; getestet werden, aber nicht dicht liegen!
  00D1                   C      Sel0	equ	0d1h;!!hintere!!	;LED 0 bei SEL 0
  00D2                   C      Sel1	equ	0d2h;!!Tetrade!!	;LED 1 bei SEL 1
  00D4                   C      Sel2	equ	0d4h;!!=2**LED!!	;LED 2 bei SEL 2
  00D8                   C      Sel3	equ	0d8h;!!	      !!	;LED 3 bei SEL 3
                         C      
  00D9                   C      SyLc	equ	0d9h			; Synch. List
  00DA                   C      HrLc	equ	0dah			; Hardcopy
  00DB                   C      Monc	equ	0dbh			; BIOS-Monitor
  00DC                   C      z00c	equ	0dch			; "00" im Ziffernblock
  00DD                   C      z000	equ	0ddh			; "000" im Ziffernblock
  00DE                   C      stpc	equ	0deh			; allg. STOP
  00DF                   C      ctlc	equ	0dfh			; Control (-Ersatz)
                         C      
                         C      ; Funktionstasten
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-32


                         C      ;----------------
  00E0                   C      pf0c	equ	0e0h			;PF0 bzw. S0 bzw. Enter im Ziffernblock
  00E1                   C      pf1c	equ	0e1h			;PF1...
  00E2                   C      pf2c	equ	0e2h
  00E3                   C      pf3c	equ	0e3h
  00E4                   C      pf4c	equ	0e4h
  00E5                   C      pf5c	equ	0e5h
  00E6                   C      pf6c	equ	0e6h
  00E7                   C      pf7c	equ	0e7h
  00E8                   C      pf8c	equ	0e8h
  00E9                   C      pf9c	equ	0e9h
                         C      ;***die folgenden 6 Funktionstasten ex nicht bei allen
                         C      ; Tastaturen, koennen aber durch andere Tasten ersetzt werden!
  00EA                   C      pfac	equ	0eah
  00EB                   C      pfbc	equ	0ebh
  00EC                   C      pfcc	equ	0ech
  00ED                   C      pfdc	equ	0edh
  00EE                   C      pfec	equ	0eeh		;bei CP/A i.a. Monitor-Taste
  00EF                   C      pffc	equ	0efh		;bei CP/A i.a. Stop-Taste
                         C      
                         C      ;rechter Ziffernblock
                         C      ;--------------------
  00F0                   C      zbl0	equ	0f0h
  00F1                   C      zbl1	equ	0f1h
  00F2                   C      zbl2	equ	0f2h
  00F3                   C      zbl3	equ	0f3h
  00F4                   C      zbl4	equ	0f4h
  00F5                   C      zbl5	equ	0f5h
  00F6                   C      zbl6	equ	0f6h
  00F7                   C      zbl7	equ	0f7h
  00F8                   C      zbl8	equ	0f8h
  00F9                   C      zbl9	equ	0f9h
  00DC                   C      zbl00	equ	z00c
  00DD                   C      zbl000	equ	z000
  00FA                   C      zblkom	equ	0fah		;Komma im Ziffernblock
  00FB                   C      zblmin	equ	0fbh		;Minus im Ziffernblock bei CP/A i.a. HardCopy
                         C      	;Enter im Ziffernblock als "pf0c" behandelt
  00FC                   C      zbla	equ	0fch		;Taste im Ziffernblock ueber der "7"
                         C      ;		0fdh		;belegt wegen TastenUmdefinitionsBegrenzer
  00C9                   C      zblb	equ	0c9h		;dito "8"
  00FE                   C      zblc	equ	0feh		;dito "9"
                         C      
                         C      ; zu ignorierende Tasten
                         C      ;-----------------------
  00FF                   C      cign	equ	0ffh			;Taste ignorieren
                         C      
  0000                   C      kbdcpb	equ	lmpsl0	;0..3, Selectortaste fuer CAPS-Lock
  0001                   C      kbdcal	equ	lmpsl1	;0..3, Selectortaste fuer ALPHA K7633
                         C      
                         C      ; Die folgende Code-Tabelle wird je nach Tastaturtyp beim
                         C      ; Kaltstart modifiziert. Sie dient dazu, um einen virtuellen
                         C      ; Tastaturcode zu erzeugen, der dann durch die String-
                         C      ; umkodierungstabellen unabhaengig von der konkreten Tastatur
                         C      ; zum eigentlichen Tastencode umgesetzt wird.
                         C      
                         C      ; Codetabelle fuer K7606/36
                         C      ;==========================
                         C      ;(Bemerkung: Falls sich K76x4-Tastaturen mit dem Typcode von K76x6 melden,
                         C      ;wurden einige phys. Tastencodes fuer diese mit aufgenommen, um trotzdem
                         C      ;eine notduerftige Arbeit zu erlauben. Gleichzeitig wird fuer die Kaltstart-
                         C      ;Modifizierung von 'kbdcpt' Reserve-Platz freigehalten.)
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-33


  D236                   C      kbdcpt:
                         C      ; Kursortasten
                         C      ;-------------
  D236    0B C1          C      	db	00BH,kcurwl		;|<-
  D238    04 C2          C      	db	004H,kcurup		;^
  D23A    01 C3          C      	DB	001H,kcurwr		;->|
  D23C    06 C4          C      	db	006H,kcurlf		;<-
  D23E    0C C5          C      	DB	00CH,kcurpu		;'\
  D240    07 C6          C      	db	007H,kcurri		;->
  D242    0A C7          C      	db	00AH,kcurpd		;<-'
  D244    05 C8          C      	db	005H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  D246    FF 0D          C      	db	0ffh,0dh		;ET1 als CR
  D248    9D 0D          C      	db	09dh,0dh		;ENTR			K7604/34
  D24A    0F 09          C      	db	00FH,009h		;|<-| als Ersatz Tab
  D24C    13 1B          C      	db	013H,01bh		;DELL als Ersatz ESC
  D24E    1B C0          C      	db	01BH,spcdel		;DEL
  D250    19 CC          C      	db	019H,spcce		;CE
  D252    09 CC          C      	db	009H,spcce		;ERIN als Ersatz CE	K7604/34
  D254    03 CD          C      	db	003H,spcins		;INSL
  D256    1E CD          C          	db	01eH,spcins		;INS			K7604/34
  D258    A0 D1          C      	DB	0A0H,Sel0		;SEL0
  D25A    A1 D2          C      	DB	0A1H,Sel1		;SEL1
  D25C    A2 D4          C      	DB	0A2H,Sel2		;SEL2
  D25E    A3 D8          C              DB	0A3H,Sel3		;SEL3
  D260    FE DF          C      	db	0feh,ctlc		;ET2 als Control-Taste (Loslassen!)
  D262    1F DF          C      	db	01fH,ctlc		;RESET Control-Taste	K7604/34
                         C      ; num. Tasten
                         C      ;------------
  D264    14 FF          C      	db	10*2,0ffh		;Reserve fuer rechtes Ziffernfeld
  D266    11 DC          C      	db	011H,zbl00		;00
  D268    12 DD          C      	db	012H,zbl000		;000
  D26A    A8 FB          C      	DB	0A8H,zblmin		;INSM als Ersatz num. Minus
  D26C    02 FB          C      	db	002H,zblmin		;INSM			K7604/34
                         C      ; Funktionstasten
                         C      ;----------------
  D26E    C0 E0          C      	db	0c0h,pf0c		;S
  D270    C1 E1          C      	db	0c1h,pf1c		;S1
  D272    C2 E2          C      	db	0c2h,pf2c		;S2
  D274    C3 E3          C      	db	0c3h,pf3c		;S3
  D276    C4 E4          C      	db	0c4h,pf4c		;S4
  D278    C5 E5          C      	db	0c5h,pf5c		;S5
  D27A    C6 E6          C      	db	0c6h,pf6c		;S6
  D27C    C7 E7          C      	db	0c7h,pf7c		;S7
  D27E    C8 E8          C      	db	0c8h,pf8c		;S8
  D280    C9 E9          C      	db	0c9h,pf9c		;S9
  D282    CA EA          C      	db	0cah,pfac		;S10
  D284    CB EB          C      	db	0cbh,pfbc		;S11
  D286    CC EC          C      	db	0cch,pfcc		;S12
  D288    10 EE          C      	db	010H,pfec		;MON als PF14
  D28A    08 EE          C      	db	008H,pfec		;EREO als Ersatz PF14	K7604/34
  D28C    AF EF          C      	DB	0AFH,pffc		;CI als Ersatz PF15
                         C      
  D28E    00             C      	db	0			;Tabellenende
  D28F                   C      	ds	12,0			;Reserve fuer K7633, K7637
  0065                   C      kbdcpl	equ	$-kbdcpt		;max. Tabellenlaenge
                         C      ;----------------------------------------------------------
                         C      
                         C      ; String-Umkodierungstabellen
                         C      ;============================
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-34


                         C      ; Standardstrings:
                         C      
  D29B                   C      kbdsts:	costs
  D29B    C1 01 01       C+     	db	kcurwl,1,'A' and 1fh
  D29E    C2 01 05       C+     	db	kcurup,1,'E' and 1fh
  D2A1    C3 01 06       C+     	db	kcurwr,1,'F' and 1fh
  D2A4    C4 01 08       C+     	db	kcurlf,1,'H' and 1fh
  D2A7    C5 01 12       C+     	db	kcurpu,1,'R' and 1fh
  D2AA    C6 01 04       C+     	db	kcurri,1,'D' and 1fh
  D2AD    C7 01 03       C+     	db	kcurpd,1,'C' and 1fh
  D2B0    C8 01 18       C+     	db	kcurdw,1,'X' and 1fh
  D2B3    E0 01 02       C+     	db	pf0c,1,'B' and 1fh
  D2B6    E1 01 07       C+     	db	pf1c,1,'G' and 1fh
  D2B9    E2 01 19       C+     	db	pf2c,1,'Y' and 1fh
  D2BC    E3 01 14       C+     	db	pf3c,1,'T' and 1fh
  D2BF    E4 01 16       C+     	db	pf4c,1,'V' and 1fh
  D2C2    E5 01 0C       C+     	db	pf5c,1,'L' and 1fh
  D2C5    E6 02 0F 44    C+     	db	pf6c,2,'O' and 1fh,'D'
  D2C9    E7 02 0F 47    C+     	db	pf7c,2,'O' and 1fh,'G'
  D2CD    E8 01 17       C+     	db	pf8c,1,'W' and 1fh
  D2D0    E9 01 1A       C+     	db	pf9c,1,'Z' and 1fh
  D2D3    EA 04 0B 53    C+     	db	pfac,4,'K' and 1fh,'S','Q' and 1fh,'P'
  D2D7    11 50          C+     
  D2D9    EB 02 0B 42    C+     	db	pfbc,2,'K' and 1fh,'B'
  D2DD    EC 02 0B 4B    C+     	db	pfcc,2,'K' and 1fh,'K'
  D2E1    ED 02 0B 56    C+     	db	pfdc,2,'K' and 1fh,'V'
  D2E5    EE 01 DB       C+     	db	pfec,1,Monc
  D2E8    EF 01 DE       C+     	db	pffc,1,Stpc
  D2EB    F1 01 31       C+     	db	zbl1,1,'1'
  D2EE    F2 01 32       C+     	db	zbl2,1,'2'
  D2F1    F3 01 33       C+     	db	zbl3,1,'3'
  D2F4    F4 01 34       C+     	db	zbl4,1,'4'
  D2F7    F5 01 35       C+     	db	zbl5,1,'5'
  D2FA    F6 01 36       C+     	db	zbl6,1,'6'
  D2FD    F7 01 37       C+     	db	zbl7,1,'7'
  D300    F8 01 38       C+     	db	zbl8,1,'8'
  D303    F9 01 39       C+     	db	zbl9,1,'9'
  D306    F0 01 30       C+     	db	zbl0,1,'0'
  D309    DC 02 30 30    C+     	db	zbl00,2,'00'
  D30D    DD 03 30 30    C+     	db	zbl000,3,'000'
  D311    30             C+     
  D312    FA 01 2E       C+     	db	zblkom,1,'.'
  D315    FB 01 DA       C+     	db	zblmin,1,HrLc
  D318    CC 01 18       C+     	db	spcce,1,'X' and 1fh
  D31B    CD 01 D9       C+     	db	spcins,1,SyLc
  D31E    C0 01 7F       C+     	db	spcdel,1,7fh
  D321    81 02 11 01    C+     	db	kcurwl-40h,2,'Q' and 1fh,'A' and 1fh
  D325    82 02 11 05    C+     	db	kcurup-40h,2,'Q' and 1fh,'E' and 1fh
  D329    83 02 11 06    C+     	db	kcurwr-40h,2,'Q' and 1fh,'F' and 1fh
  D32D    84 02 11 13    C+     	db	kcurlf-40h,2,'Q' and 1fh,'S' and 1fh
  D331    85 02 11 12    C+     	db	kcurpu-40h,2,'Q' and 1fh,'R' and 1fh
  D335    86 02 11 04    C+     	db	kcurri-40h,2,'Q' and 1fh,'D' and 1fh
  D339    87 02 11 03    C+     	db	kcurpd-40h,2,'Q' and 1fh,'C' and 1fh
  D33D    88 02 11 18    C+     	db	kcurdw-40h,2,'Q' and 1fh,'X' and 1fh
  D341    A0 02 11 02    C+     	db	pf0c-40h,2,'Q' and 1fh,'B' and 1fh
  D345    A1 02 11 10    C+     	db	pf1c-40h,2,'Q' and 1fh,'P' and 1fh
  D349    A2 02 11 19    C+     	db	pf2c-40h,2,'Q' and 1fh,'Y' and 1fh
  D34D    A3 02 11 7F    C+     	db	pf3c-40h,2,'Q' and 1fh,7fh
  D351    A4 02 11 16    C+     	db	pf4c-40h,2,'Q' and 1fh,'V' and 1fh
  D355    A5 02 11 0C    C+     	db	pf5c-40h,2,'Q' and 1fh,'L' and 1fh
  D359    A8 02 11 17    C+     	db	pf8c-40h,2,'Q' and 1fh,'W' and 1fh
  D35D    A9 02 11 1A    C+     	db	pf9c-40h,2,'Q' and 1fh,'Z' and 1fh
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-35


  D361    AB 02 11 02    C+     	db	pfbc-40h,2,'Q' and 1fh,'B' and 1fh
  D365    AC 02 11 0B    C+     	db	pfcc-40h,2,'Q' and 1fh,'K' and 1fh
  D369    AD 02 11 16    C+     	db	pfdc-40h,2,'Q' and 1fh,'V' and 1fh
  D36D    FF             C      	db	0ffh		;Tab.ende
                         C      
                         C       IF costu
                         C       ENDIF
                                
                         C      	include BIOSCRT
                         C      ;************************************************************
                         C      ; Bildschirm-Ausgabe K7023, K7024, DSY5 u.ae.
                         C      ; - Fehlerkorrektur Steuerzeichen 18h (es wurden nur 79 Zeichen gel.)
                         C      ; - bei Tastenumdefinition auch chr(253) als Begrenzer (dbase)
                         C      ; - BAB2 als Standardvariante
                         C      ; - 17h (insline) und 19h (delline) eingefuehrt fuer TURBO-PASCAL-Editor
                         C      ; - Realisierung der SCP1715-Steuerzeichen 1b 5e xx (Feldattribut)
                         C      ;   und 1b 5f xx (Spezialzeichen)
                         C      ;   Diese ESC-Folgen fueren beim Buerocomputer i.a. auf '^' (unzulaessig),
                         C      ;   ausser Feldattribute invers und hell (Reaktion wie Steuerz. 84..87)
                         C      ; - Einfuehrung Umlaut-Umkodierung fuer deutschen Zeichensatz
                         C      ;   einschl. SCP1715-Steuerzeichen 0Eh und 0Fh
                         C      ; - Einfuehrung MACROS "setbs" und "setram" zum Hin- und Rueckschalten
                         C      ;   des Bildschirmpuffers
                         C      ; 17.06.88
                         C      ; - Zugriff zum Bildschirm aus Interruptroutinen unterdrueckt
                         C      ; - Unterstuetzung von Karten mit Bit 7 invers (z.B. DSY5)
                         C      ; - Unterst. einer weiteren Variante fuer dtsch. Zeichens. auf 00..1f (ZSIBM)
                         C      ; 23.09.88
                         C      ; - Einfuehrung der Macros 'crton' und 'crtoff'
                         C      ; - di/ei waehrend Bildschirmumschaltung eingefuehrt
                         C      ;************************************************************
                         C      
                         C       if1
                         C       endif	;if1
                         C      
                         C       IF crtbfl eq 0
                         C       ELSE ;crtbfl ne 0
                         C        IF1
                         C        ENDIF
                         C       ENDIF
                         C      
                         C      
                         C      ;**************************************************************************
  D046                   C      crtst	equ	dumst		;CRT:-Status immer ready
                         C      
  D36E                   C      crto:
  D36E    3E C3          C      	ld	a,0c3h		;jp ...
  D370    32 E5B7        C      	ld	(intcrt),a	;waehrend Bildaufbau Interrupt-Zugriff verb.
  D373    C5             C      	push	bc		;merken zeichen in c
  D374    2A CF38        C      	ld	hl,(crtcps)	;Kursorposition	
                         C      	setbs
  D377    CB BE          C      	res	7,(hl)		;loeschen Kursor
                         C      	setram
  D379    CD D3AB        C      	call	crtoti		;Zeichen ausgeben
                         C      ;				 HL danach auf neuer Kursorpositon
                         C      
                         C      ; Setzen Kursor auf (HL)
                         C      
  D37C    22 CF38        C      	ld	(crtcps),hl	;cursorposition
                         C      	setbs
  D37F    3E 80          C      	ld	a,80h
  D380                   C      dcurs	equ	$-1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-36


  D381    B6             C      	or	(hl)		;Kursor setzen
  D382    77             C      	ld	(hl),a
                         C      	setram
  D383    C1             C      crtonc:	pop	bc		;wiederherstellen c-reg
                         C      
  D384    3E 21          C      	ld	a,021h		;ld hl,...
  D386    32 E5B7        C      	ld	(intcrt),a	;wiederzulassen Zugriff aus Interruptrtn
                         C      
                         C       if (stpvar ne 0)  and (chdvar ne 0)
                         C      ; Hardcopy realisieren
                         C      
  D389    3A 0040        C      	ld	a,(lampbf)
  D38C    CB 7F          C      	bit	lmphcp,a	;Hardcopy?
  D38E    C8             C      	ret	z		;nein
  D38F    79             C      	ld	a,c
  D390    E6 7F          C      	and	7fh
  D392    FE 20          C      	cp	20h		;Steuerzeichen?
  D394    38 03          C      	jr	c,crtoe1	;ja
  D396    FE 7F          C      	cp	7fh
  D398    D8             C      	ret	c
  D399    C5             C      crtoe1:	push	bc
  D39A    21 D3A7        C      	ld	hl,crtlc	;zugelassene Steuerzeichen
  D39D    01 0004        C      	ld	bc,crtlcl
  D3A0    ED B1          C      	cpir			;erlaubt?
  D3A2    C1             C      	pop	bc
  D3A3    C8             C      	ret	z		;ja
  D3A4    0E 5E          C      	ld	c,'^'		;sonst Spezialzeichen
  D3A6    C9             C      	ret
                         C      
                         C      ; bei Hardcopy Bildschirm -> Drucker zugelassene Steuerzeichen
                         C      
  D3A7    08 0A 0C 0D    C      crtlc:	db	08h,0ah,0ch,0dh
  0004                   C      crtlcl	equ	$-crtlc
                         C      
                         C       endif	;stpvar and chdvar
                         C      
                         C      
                         C      ;========================================================
                         C      ; interner Aufruf Bildschirmtreiber
                         C      ; i HL	Zeiger in Bildschirmpuffer auf Kursorposition
                         C      ; o HL	neuer Zeiger auf Kursorposition
                         C      ;========================================================
                         C      
  D3AB                   C      crtoti:
  D3AB    3E 00          C      	ld	a,0		;escape mode
  D3AC                   C      desc	equ	$-1
  D3AD    B7             C      	or	a
  D3AE    20 62          C      	jr	nz,crto04	;ja
  D3B0    79             C      crto02:	ld	a,c
  D3B1    32 D5B0        C      	ld	(crtcch),a	;merken fuer direkte Ausgabe
  D3B4    FE 87          C      	cp	87h		;07h ist bell!, daher 87h<>07h
  D3B6    28 39          C      	jr	z,crto09
  D3B8    CB BF          C      	res	7,a		;sonst 1xxxxxxxB  = 0xxxxxxxB
  D3BA    FE 20          C      	cp	20h		;steuerzeichen?
  D3BC    38 33          C      	jr	c,crto09	;ja
  D3BE    FE 7F          C      	cp	7fh
  D3C0    30 2F          C      	jr	nc,crto09
                         C       IF umlaut
  D3C2    CD D57F        C      	call	crtuml		;evtl. Umlaute umkodieren
                         C       ENDIF
  D3C5                   C      crtobs:
  D3C5    EB             C      	ex	de,hl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-37


                         C       IF crt eq dsy5
                         C       ENDIF
  D3C6                   C      crtsbl:
                         C      	setbs
  D3C6    12             C      	ld	(de),a		;Zeichen in Bildschirmpuffer
                         C      	setram
  D3C7    21 0001        C      crtcur:	ld	hl,0-bsend1
  D3C8                   C      crtm01	equ	$-2
  D3CA    19             C      	add	hl,de		;bs voll?
  D3CB    EB             C      	ex	de,hl
  D3CC    23             C      	inc	hl	
  D3CD    D0             C      	ret	nc
  D3CE    11 FFC0        C      	ld	de,bsend1-bssp1+1
  D3CF                   C      crtm02	equ	$-2
  D3D1    D5             C      crto03:	push	de
  D3D2    21 FC40        C      	ld	hl,bsanf1+bssp1	;aufschieben
  D3D3                   C      crtm03	equ	$-2
  D3D5    11 FC00        C      	ld	de,bsanf1
  D3D6                   C      crtm04	equ	$-2
  D3D8    01 03C0        C      	ld	bc,bsend1-bsanf1-bssp1+1
  D3D9                   C      crtm05	equ	$-2
                         C      	setbs
  D3DB    ED B0          C      	ldir
  D3DD    2B             C      	dec	hl
  D3DE    36 20          C      	ld	(hl),' '	;letzte zeile loeschen
  D3E0    11 FFFE        C      	ld	de,bsend1-1
  D3E1                   C      crtm06	equ	$-2
  D3E3    01 003F        C      	ld	bc,bssp1-1
  D3E4                   C      crtm07	equ	$-2
  D3E6    ED B8          C      	lddr
                         C      	setram
  D3E8    E1             C      	pop	hl
  D3E9    C9             C      	ret
                         C      ;------------------------------
                         C      ; 84/04,..,86/06,87
                         C      
                         C       IF crt eq k7024
  D3EA                   C      crto84:
  D3EA                   C      crto85:
  D3EA                   C      crto86:
  D3EA                   C      crto87:
  D3EA    3A D5B0        C      	ld	a,(crtcch)	;Zeichen direkt ausgeben
  D3ED    CB BF          C      	res	7,a		;ohne Bit 7
  D3EF    18 D4          C      	jr	crtobs
                         C       ENDIF
                         C       IF crt eq dsy5
                         C       ENDIF
                         C      ;--------------------------------
                         C      
                         C      ; Behandlung Sonderzeichen
                         C      ;=========================
  D3F1    EB             C      crto09:	ex	de,hl		;test sonderzeichen
  D3F2    21 D5B1        C      	ld	hl,dszta
  D3F5    01 0018        C      	ld	bc,dsztal
  D3F8    ED B1          C      	cpir
  D3FA    28 05          C      	jr	z,crto11	;gefunden
  D3FC    0E 5E          C      	ld	c,'^'		;nicht-Sonderz. anzeigen
  D3FE    EB             C      	ex	de,hl
  D3FF    18 AF          C      	jr	crto02		;falls nicht gefunden
  D401    21 D5F8        C      crto11:	ld	hl,dswe-1
  D404    B7             C      	or	a
  D405    ED 42          C      	sbc	hl,bc
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-38


  D407    ED 42          C      	sbc	hl,bc
  D409    46             C      	ld	b,(hl)
  D40A    2B             C      	dec	hl
  D40B    4E             C      	ld	c,(hl)		;bc:=ansprungadresse
  D40C    C5             C      	push	bc
  D40D    6B             C      	ld	l,e
  D40E    62             C      	ld	h,d		;bs adresse
  D40F    3E 20          C      	ld	a,' '		;fuer BS-loeschen
  D411    C9             C      crtnop:	ret			;ansprung sonderzeichen
                         C      ;-----------------------------
                         C      
                         C      ; Behandlung Zeichen innerhalb Escape-Folgen
                         C      ;===========================================
  D412                   C      crto04:	if	adm3a
                         C      	endif
                         C      
                         C      	if	costu
                         C      	endif
                         C      
  D412    3D             C      	dec	a
  D413    32 D3AC        C      	ld	(desc),a	;naechstes escape flag setzen
                         C       IF escpc
  D416    79             C      	ld	a,c		;Zeichen mit offset nach A
                         C       ENDIF
  D417    CB B9          C      	res	7,c		;loeschen evtl. offset 80h
  D419    28 1B          C      	jr	z,crto07	;letztes Zeichen ESC-Folge
                         C      
                         C      ; vorletztes Zeichen ESC-Folge
                         C      ;-----------------------------
                         C       IF escpc
  D41B    D6 5E          C      	sub	5eh		;Feldattribut oder Sonderzeichen?
  D41D    32 D437        C      	ld	(crtffl),a	;wenn ja, so 00 bzw. 01
  D420    C8             C      	ret	z		;1b 5e xx
  D421    3D             C      	dec	a
  D422    C8             C      	ret	z		;1b 5f xx 
                         C       ENDIF
                         C      ;Positionierung Zeile
                         C       	if	adm3a
                         C      	endif
                         C      
  D423    3E 0F          C      	ld	a,bszl1-1	;letzte zeile
  D424                   C      crtm08	equ	$-1
  D425    B9             C      	cp	c		;nach letzter zeile?
  D426    38 01          C      	jr	c,crto05	;ja
  D428    79             C      	ld	a,c		;sonst auf gewuenschte zeile
  D429    21 FC00        C      crto05:	ld	hl,bsanf1	;zeile adressieren
  D42A                   C      crtm09	equ	$-2
  D42C    B7             C      	or	a
  D42D    C8             C      	ret	z
  D42E    11 0040        C      	ld	de,bssp1
  D42F                   C      crtm10	equ	$-2
  D431    47             C      	ld	b,a
  D432    19             C      crto06:	add	hl,de
  D433    10 FD          C      	djnz	crto06		;zeile finden
  D435    C9             C      	ret
                         C      
  D436                   C      crto07:
                         C      ; letztes Zeichen ESC-Folge
                         C      ;--------------------------
                         C       IF escpc
  D436    06 FF          C      	ld	b,0ffh
  D437                   C      crtffl	equ	$-1		;auf 00 bei "1b 5e xx"; auf 01 bei "1b 5f xx"
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-39


  D438    10 05          C      	djnz	crtnsp		;nicht 1b 5f xx
  D43A    3E 5E          C      crtfa3:	ld	a,'^'		;Spezialzeichen nicht realisierbar
  D43C    C3 D3C5        C      	jp	 crtobs
  D43F                   C      crtnsp:
  D43F    04             C      	inc	b		;1b 5e xx?
  D440    20 17          C      	jr	nz,crtnfa	;nein
  D442    CB 67          C      	bit	4,a		;invers?
  D444    28 02          C      	jr	z,crtfa1	;nein
  D446    CB C0          C      	set	0,b
  D448    CB 47          C      crtfa1:	bit	0,a		;hell?
  D44A    28 02          C      	jr	z,crtfa2	;nein
  D44C    CB C8          C      	set	1,b
  D44E    E6 2E          C      crtfa2:	and	00101110b	;wurden noch andere Funktionen verlangt?
  D450    20 E8          C      	jr	nz,crtfa3	;ja, kann die Hardware nicht
  D452    3E 84          C      	ld	a,84h
  D454    B0             C      	or	b		;Steuerzeichen auf 84..87 abbilden
  D455    4F             C      	ld	c,a
  D456    C3 D3B0        C      	jp	crto02		;umgewandeltes Steuerzeichen auswerten
  D459                   C      crtnfa:
                         C       ENDIF
                         C      ; Positionierung Spalte
                         C      	if	adm3a
                         C      	endif
                         C      
  D459    3E 3F          C      	ld	a,bssp1-1	;spalte setzen
  D45A                   C      crtm11	equ	$-1
  D45B    B9             C      	cp	c		;0 .. letzte spalte
  D45C    30 01          C      	jr	nc,crto08	;ja
  D45E    4F             C      	ld	c,a		;sonst auf letzte spalte
  D45F    06 00          C      crto08:	ld	b,0
  D461    09             C      	add	hl,bc
  D462    C9             C      	ret
                         C      
                         C      	if	adm3a
                         C      	endif
                         C      ;----------------------------
                         C      
                         C      ; ...Realisierung Sonderzeichen...
                         C      ;=================================
  D463    01 0040        C      crtcr:	ld	bc,bssp1
  D464                   C      crtm12	equ	$-2
  D466    21 FFFF        C      	ld	hl,bsend1
  D467                   C      crtm13	equ	$-2
  D469    B7             C      crto12:	or	a
  D46A    ED 42          C      	sbc	hl,bc		;suchen,bis hl < (crtcps)
  D46C    E5             C      	push	hl
  D46D    ED 52          C      	sbc	hl,de
  D46F    E1             C      	pop	hl
  D470    30 F7          C      	jr	nc,crto12	;zeilenanf. noch nicht gefunden
  D472    23             C      	inc	hl
  D473    C9             C      	ret
                         C      ;-----------------------------
  D474    21 FFBF        C      crtlf:	ld	hl,bsend1-bssp1
  D475                   C      crtm14	equ	$-2
  D477    ED 52          C      	sbc	hl,de	;bs ende (anfang letzte zeile)
  D479    DA D3D1        C      	jp	c,crto03	;aufschieben
  D47C    21 0040        C      	ld	hl,bssp1
  D47D                   C      crtm15	equ	$-2
  D47F    19             C      	add	hl,de		;naechste zeile
  D480    C9             C      	ret
                         C      ;-----------------------------
  D481                   C      crtdel:	setbs
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-40


  D481    12             C      	ld	(de),a
                         C      	setram
  D482    21 FC00        C      crtcl:	ld	hl,bsanf1	;cursor zurueck
  D483                   C      crtm16	equ	$-2
  D485    ED 52          C      	sbc	hl,de
  D487    EB             C      	ex	de,hl
  D488    C8             C      	ret	z
  D489    2B             C      	dec	hl
  D48A    C9             C      	ret
                         C      ;----------------------------
  D48B    11 FC00        C      crtbsl:	ld	de,bsanf1	;bs loeschen + home
  D48C                   C      crtm17	equ	$-2
  D48E    21 FFFF        C      crtbsr:	ld	hl,bsend1
  D48F                   C      crtm18	equ	$-2
  D491    ED 52          C      	sbc	hl,de
  D493    EB             C      	ex	de,hl
                         C      	setbs
  D494    77             C      	ld	(hl),a
                         C      	setram
  D495    C8             C      	ret	z
  D496    E5             C      	push	hl
  D497    42             C      	ld	b,d	
  D498    4B             C      	ld	c,e
  D499    54             C      	ld	d,h
  D49A    5D             C      	ld	e,l
  D49B    13             C      	inc	de
                         C      	setbs
  D49C    ED B0          C      	ldir
                         C      	setram
  D49E    E1             C      	pop	hl
  D49F    C9             C        	ret
                         C      ;----------------------------
  D4A0    21 FC00        C      crthom:	ld	hl,bsanf1	;home
  D4A1                   C      crtm19	equ	$-2
  D4A3    C9             C      	ret
                         C      ;----------------------------
  D4A4                   C      crtcup:
                         C      	if	adm3a
                         C      	endif
                         C      
  D4A4    21 FC3F        C      	ld	hl,bsanf1+bssp1-1  ;eine zeile hoch
  D4A5                   C      crtm20	equ	$-2
  D4A7    ED 52          C      	sbc	hl,de		;in oberster zeile?
  D4A9    EB             C      	ex	de,hl
  D4AA    D0             C      	ret	nc		;nicht ausfuehren
  D4AB    11 FFC0        C      	ld	de,0-bssp1
  D4AC                   C      crtm21	equ	$-2
  D4AE    19             C      	add	hl,de		;zeilenlaenge abziehen
  D4AF    C9             C      	ret
                         C      ;-----------------------------
  D4B0    CD D463        C      crtzl:	call	crtcr		;zeile loeschen
  D4B3    EB             C      	ex	de,hl
  D4B4    D5             C      crtzlr:	push	de		;restzeile loeschen
  D4B5    CD D463        C      	call	crtcr
  D4B8    09             C      	add	hl,bc
  D4B9    B7             C      	or	a
  D4BA    ED 52          C      	sbc	hl,de		;zeilenrest
                         C      	setbs
  D4BC    12             C      crto13:	ld	(de),a
  D4BD    13             C      	inc	de
  D4BE    2D             C      	dec	l
  D4BF    20 FB          C      	jr	nz,crto13
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-41


                         C      	setram
  D4C1    E1             C      	pop	hl
  D4C2    C9             C      	ret
                         C      ;-----------------------------
                         C       IF inslin
  D4C3    CD D463        C      crtinl:	call	crtcr		;Insert line
  D4C6    E5             C      	push	hl		;hl auf Zeilenanfang
  D4C7    11 FF30        C      	ld	de,bsend2-bssp2+1 ;Anfang letzte Zeile
  D4C8                   C      crtm44	equ	$-2
  D4CA    EB             C      	ex	de,hl
  D4CB    B7             C      	or	a
  D4CC    ED 52          C      	sbc	hl,de		;Laenge
  D4CE    28 0A          C      	jr	z,crtil1	;letzte Zeile
  D4D0    44             C      	ld	b,h
  D4D1    4D             C      	ld	c,l
  D4D2    11 FF7F        C      	ld	de,bsend2	;Ziel
  D4D3                   C      crtm45	equ	$-2
  D4D5    21 FF2F        C      	ld	hl,bsend2-bssp2	;Quelle
  D4D6                   C      crtm46	equ	$-2
                         C      	setbs
  D4D8    ED B8          C      	lddr			;eine Zeile nach unten schieben
                         C      	setram
  D4DA    D1             C      crtil1:	pop	de
  D4DB    62             C      	ld	h,d
  D4DC    6B             C      	ld	l,e
  D4DD    18 D5          C      	jr	crtzlr		;freigewordene Zeile loeschen
                         C      ;-----------------------------
  D4DF    CD D463        C      crtdll:	call	crtcr		;Delete Line
  D4E2    E5             C      	push	hl
  D4E3    11 FF30        C      	ld	de,bsend2-bssp2+1	;Anfang letzte Zeile
  D4E4                   C      crtm47	equ	$-2
  D4E6    EB             C      	ex	de,hl
  D4E7    B7             C      	or	a
  D4E8    ED 52          C      	sbc	hl,de		;Laenge
  D4EA    28 08          C      	jr	z,crtdl1	;letzte Zeile
  D4EC    E3             C      	ex	(sp),hl
  D4ED    54             C      	ld	d,h
  D4EE    5D             C      	ld	e,l		;de auf Ziel (Zeilenanfang)
  D4EF    09             C      	add	hl,bc		;hl auf Quelle
  D4F0    C1             C      	pop	bc
  D4F1    D5             C      	push	de
                         C      	setbs
  D4F2    ED B0          C      	ldir			;eine Zeile nach oben schieben
                         C      	setram
  D4F4    21 FF30        C      crtdl1:	ld	hl,bsend2-bssp2+1
  D4F5                   C      crtm48	equ	$-2
  D4F7    54             C      	ld	d,h
  D4F8    5D             C      	ld	e,l
  D4F9    CD D4B4        C      	call	crtzlr		;letzte Zeile loeschen
  D4FC    E1             C      	pop	hl
  D4FD    C9             C      	ret
                         C      ;-----------------------------
                         C       ENDIF	;inslin
  D4FE    3E 02          C      crtesc:	ld	a,2		;escape flag setzen
  D500    32 D3AC        C      	ld	(desc),a
                         C      
                         C      	if	costu or adm3a
                         C      	endif
                         C      
  D503    C9             C      	ret
                         C      ;-----------------------------
  D504    3E 80          C      crtcrt:	ld	a,80h		;cursor an
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-42


  D506    18 01          C      	jr	crto14
                         C      ;-----------------------------
  D508    AF             C      crtcof:	xor	a		;cursor aus
  D509    32 D380        C      crto14:	ld	(dcurs),a
  D50C    C9             C      	ret
                         C      ;-----------------------------
                         C      ; Realisierung 07h
                         C      ; Achtung! Diese Routine wird aus Interruptroutine aufgerufen!
  D50D    CD D510        C      crtclk:	call	crtcl1		;Fehlerlampe umschalten
                         C      
  D510    06 19          C      crtcl1:	ld	b,25		;0.25 sec warten
  D512    CD E78A        C      	call	wait10
                         C      				;Fehlerlampe wieder zurueck
                         C      ; Fehlerlampe umschalten
                         C      ; Reg. A, HL bleiben erhalten
  D515    F5             C      swilmp:	push	af
  D516    E5             C      	push	hl
  D517    21 0040        C      	ld	hl,lampbf
  D51A    7E             C      	ld	a,(hl)
  D51B    EE 40          C      	xor	1 shl lmperr
  D51D    77             C      	ld	(hl),a
  D51E    CD D1CA        C      	call	lampen
  D521    E1             C      	pop	hl
  D522    F1             C      	pop	af
  D523    C9             C      	ret
                         C      ;-----------------------------
                         C       IF umlaut
                         C      ; Umschalten auf 2. Zeichensatz
  D524    E5             C      crt2zs:	push	hl
  D525    21 CF3D        C      	ld	hl,synflg
  D528    CB D6          C      	set	umlflg,(hl)
  D52A    E1             C      	pop	hl
  D52B    C9             C      	ret
                         C      ; Umschalten auf 1. Zeichensatz
  D52C    E5             C      crt1zs:	push	hl
  D52D    21 CF3D        C      	ld	hl,synflg
  D530    CB 96          C      	res	umlflg,(hl)
  D532    E1             C      	pop	hl
  D533    C9             C      	ret
                         C       ENDIF
                         C      ;-----------------------------
                         C      
                         C       IF stpvar
                         C       IF chdvar
                         C      ;Hardcopy Bildschirm -> LST
  D534    E5             C      crthrd:	push	hl
  D535    21 FC00        C      	ld	hl,bsanf1
  D536                   C      crtm22	equ	$-2
  D538    0E 11          C      	ld	c,bszl1+1
  D539                   C      crtm23	equ	$-1
  D53A    18 30          C      	jr	crthd3		;zu Beginn neue Zeile
  D53C    06 40          C      crthd1:	ld	b,bssp1
  D53D                   C      crtm24	equ	$-1
  D53E    C5             C      crthd2:	push	bc
                         C      	setbs
  D53F    7E             C      	ld	a,(hl)
                         C      	setram
  D540    23             C      	inc	hl
  D541    E5             C      	push	hl
  D542    E6 7F          C      	and	7fh
  D544    FE 20          C      	cp	20h		;BS-Steuerzeichen?
  D546    30 1C          C      	jr	nc,crthd4	;nein
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-43


                         C       IF umlaut
  D548    21 CF3D        C      	ld	hl,synflg	;Schalterbyte 
  D54B    CB 56          C      	bit	umlflg,(hl)	;Umlaute anzeigen ?
  D54D    28 13          C      	jr	z,cnuml1	;nein!
  D54F    21 D5A5        C      	ld	hl,umltb2	;Umlautcodierung ?
  D552    01 000B        C      	ld	bc,umllen
  D555    ED B1          C      	cpir
  D557    20 09          C      	jr	nz,cnuml1	;nein !
  D559    01 000C        C      	ld	bc,umllen+1	;sonst rueckkodieren
  D55C    B7             C      	or	a
  D55D    ED 42          C      	sbc	hl,bc
  D55F    7E             C      	ld	a,(hl)		;rueckkodiertes Zeichen
  D560    18 02          C      	jr	crthd4
  D562                   C      cnuml1:
                         C       ENDIF
  D562    3E 5E          C      	ld	a,'^'		;sonst Sonderzeichen
  D564    4F             C      crthd4:	ld	c,a
  D565    CD CF0F        C      	call	BIOS0F		;LIST
  D568    E1             C      	pop	hl
  D569    C1             C      	pop	bc
  D56A    10 D2          C      	djnz	crthd2		;bis Zeilenende
  D56C    C5             C      crthd3:	push	bc
  D56D    E5             C      	push	hl
  D56E    0E 0D          C      	ld	c,0dh
  D570    CD CF0F        C      	call	BIOS0F
  D573    0E 0A          C      	ld	c,0ah
  D575    CD CF0F        C      	call	BIOS0F
  D578    E1             C      	pop	hl
  D579    C1             C      	pop	bc
  D57A    0D             C      	dec	c		;Bildschirmende?
  D57B    20 BF          C      	jr	nz,crthd1	;nein
  D57D    E1             C      	pop	hl
  D57E    C9             C      	ret
                         C       ENDIF
                         C       ENDIF	;stpvar
                         C      
                         C       IF umlaut
                         C      ; Umlaute umcodieren fuer Anzeige auf BAB1/BAB2 (Sonder-PROM)
  D57F                   C      crtuml:	
  D57F    E5             C      	push 	hl		;retten wegen evtl. ext. Verwendung
  D580    C5             C      	push 	bc
  D581    21 CF3D        C      	ld	hl,synflg	;Schalterbyte
  D584    CB 56          C      	bit	umlflg,(hl)	;Umlaute anzeigen ?
  D586    28 0F          C      	jr	z,umlcn1	;nein !
  D588    21 D59A        C      	ld 	hl,umltb1
  D58B    01 000B        C      	ld 	bc,umllen
  D58E    ED B1          C      	cpir			;in Tabelle suchen
  D590    20 05          C      	jr	nz,umlcn1	;nicht gefunden
  D592    01 000A        C      	ld	bc,umllen-1	;wegen cpir
  D595    09             C      	add 	hl,bc
  D596    7E             C      	ld	a,(hl)		;umcodieren
  D597    C1             C      umlcn1:	pop	bc
  D598    E1             C      	pop	hl
  D599    C9             C      	ret
                         C      
                         C      ;------------------------------
                         C      ; Umcodiertabelle fuer Umlautumcodierung
                         C       IF zsuml ;auf freie 7023/24-Steuerzeichen (IH Mittweida, Koll. Geiler)
                         C      ;		Ae  Oe  Ue  ae  oe  ue  sz  **2 **3 Par my
  D59A    5B 5C 5D 7B    C      umltb1:db	5bh,5ch,5dh,7bh,7ch,7dh,7eh,3ch,3eh,40h,5eh
  D59E    7C 7D 7E 3C    C      
  D5A2    3E 40 5E       C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-44


  D5A5    15 16 17 1C    C      umltb2:db	15h,16h,17h,1ch,1dh,1eh,1fh,10h,12h,14h,18h
  D5A9    1D 1E 1F 10    C      
  D5AD    12 14 18       C      
  000B                   C      umllen	equ	umltb2-umltb1
                         C       ENDIF
                         C       IF zsibm ;auf 00..1f erweiterter IBM-Zeichensatz
                         C       ENDIF	
                         C       ENDIF	
                         C      
                         C      ; Arbeitszellen
                         C      ;==============
                         C      
  D5B0    00             C      crtcch:	db	0		;direkt auszugebendes BS-Zeichen
                         C       if crt eq dsy5
                         C       endif
                         C      
                         C      ; Tabelle der Sonderzeichen, SCP kompatibel!
                         C      ;==========================================
                         C      
  D5B1                   C      dszta:	
  D5B1    00             C      	db	00h	;nop
  D5B2    01             C      	db	01h	;home
  D5B3    02             C      	db	02h	;(auch 82h) cursor an
  D5B4    03             C      	db	03h	;(auch 83h) cursor aus
  D5B5    04             C      	db	04h	;(auch 84h) normal, nicht inv.
  D5B6    05             C      	db	05h	;(auch 85h) normal,       inv.
  D5B7    06             C      	db	06h	;(auch 86h) hell  , nicht inv.
                         C      ;			 (nur  87h) hell  ,       inv.
  D5B8    07             C      	db	07h	;bell (akustisches zeichen)
  D5B9    08             C      	db	08h	;cursor zurueck
  D5BA    0A             C      	db	0ah	;LF
  D5BB    0C             C      	db	0ch	;bs loeschen, cursor links oben
  D5BC    0D             C      	db	0dh	;CR
                         C       if umlaut
  D5BD    0E             C      	db	0eh	;umschalten auf 2. Zeichensatz
  D5BE    0F             C      	db	0fh	;umschalten auf 1. Zeichensatz
                         C       endif
  D5BF    14             C      	db	14h	;rest bs loeschen
  D5C0    15             C      	db	15h	;cursor vorwaerts
  D5C1    16             C      	db	16h	;rest der zeile loeschen
                         C       IF inslin
  D5C2    17             C      	db	17h	;Insert Line
                         C       ENDIF
  D5C3    18             C      	db	18h	;zeile loeschen, cursor an zeilanf.
                         C       IF inslin
  D5C4    19             C      	db	19h	;Delete Line
                         C       ENDIF
  D5C5    1A             C      	db	1ah	;eine zeile hoch
                         C      			;bei ADM3a wie 0ch
  D5C6    1B             C      	db	1bh	;escape
                         C      ;		1b zeile+80h spalte+80h		Kursor posit. SCP
                         C      ;		1b zeile+00h spalte+00h		geht auch bei CP/A
                         C      ;		1b '='/'Y' zeile+20h spalte+20h	Kursor posit. bei ADM3A
                         C      ;		1b 5e xx	Feldattribut setzen (SCP1715 fuer 8275-Contr.)
                         C      ;			mit xx= 01urggbh
                         C      ;				  u		unterstreichen,
                         C      ;				   r		invers,
                         C      ;				    gg		Zeichengenerator-Umschaltung,
                         C      ;				      b		blinken,
                         C      ;				       h	heller 
                         C      ;		1b 5f xx	Spezialzeichen setzen (SCP1715 fuer 8275)
                         C      ;			mit xx= 01ssssbh
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-45


                         C      ;				  ssss		Zeichencode (1100 Sonderfkt)
                         C      ;				      b		blinken des Sonderzeichens
                         C      ;				       h	heller des Sonderzeichens
                         C      	if	adm3a
                         C      	endif
                         C       if crt eq dsy5
                         C       endif
  D5C7    7F             C      	db	7fh	;delete
  D5C8    87             C      	db	87h	;(nicht 07h) hell  ,      inv.
  0018                   C       dsztal	equ	$-dszta	;Tabellenlaenge
                         C      
                         C      ; Reaktionsroutinen fuer Sonderzeichen
                         C      
  D5C9    D411           C      	dw	crtnop	;00
  D5CB    D4A0           C      	dw	crthom	;01
  D5CD    D504           C      	dw	crtcrt	;02/82
  D5CF    D508           C      	dw	crtcof	;03/83
  D5D1    D3EA           C      	dw	crto84	;04/84
  D5D3    D3EA           C      	dw	crto85	;05/85
  D5D5    D3EA           C      	dw	crto86	;06/86
  D5D7    D50D           C      	dw	crtclk	;07
  D5D9    D482           C      	dw	crtcl	;08
  D5DB    D474           C      	dw	crtlf	;0A
  D5DD    D48B           C      	dw	crtbsl	;0C
  D5DF    D463           C      	dw	crtcr	;0D
                         C       if umlaut
  D5E1    D524           C      	dw	crt2zs	;0E
  D5E3    D52C           C      	dw	crt1zs	;0F
                         C       endif
  D5E5    D48E           C      	dw	crtbsr	;14
  D5E7    D3C7           C      	dw	crtcur	;15
  D5E9    D4B4           C      	dw	crtzlr	;16
                         C       IF inslin
  D5EB    D4C3           C      	dw	crtinl	;17
                         C       ENDIF
  D5ED    D4B0           C      	dw	crtzl	;18
                         C       IF inslin
  D5EF    D4DF           C      	dw	crtdll	;19
                         C       ENDIF
  D5F1    D4A4           C      	dw	crtcup	;1A
  D5F3    D4FE           C      	dw	crtesc	;1B
                         C      	if	adm3a
                         C      	endif
                         C       if crt eq dsy5
                         C       endif
  D5F5    D481           C      	dw	crtdel	;7F
  D5F7    D3EA           C      	dw	crto87	;87
  D5F9                   C      dswe 	equ	$	;tabellenende
                         C      
                                
                                 IF chdvar
                         C      	include BIOSCHD
                         C      ;**************************************************************
                         C      ;	zeichenorientierte Geraete
                         C      ; Aenderungen:
                         C      ; Fehlerkorrektur UC1:-Treiber
                         C      ; - getrennter Status Sender/Empf.
                         C      ; - Verwaltung des DTR-Bits auf Empf.seite
                         C      ; - UC1: arbeitet empfangsseitig interruptgetrieben
                         C      ; - Einfuehrung eines UC1:-Puffers als Verlaengerung des SIO-Puffers
                         C      ; - bei E/A-Fehler (Drucker nicht bereit) warten auf Bestaetigung,
                         C      ;   moegliche Reaktion ^C, I(gnore device) oder R(etry)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-46


                         C      ; 29.09.88
                         C      ; - beide Bahnen parallel wird zurueckgesetzt, wenn linke oder rechte
                         C      ;   Bahn ausgewaehlt wird
                         C      ; 04.04.89
                         C      ; - zeichenweise Geraete werden bei Warmstart nicht neu initialisiert,
                         C      ;   nur beim Betaetigen der Taste "Synchronisieren"
                         C      ; 06.07.89
                         C      ; - bei DTR mit/ohne Warten auf Senderegister leer
                         C      ; 15.09.89
                         C      ; - wegen Drucker 1152.257 TimeOut auf nicht-Bereitschaft von 30 s auf 2 min
                         C      ;**************************************************************
                         C      
                         C       if1
                         C       endif ; if1
                         C      
                         C      
                         C      ; Ausgabe
                         C      ;~~~~~~~~
                         C      ; TTY:
                         C      ;=====
                         C       if	iobtty
  D5F9    DD 21 D693     C      ttyo:	ld	ix,lsttty
  D5FD    18 0C          C      	jr	lsto
                         C       endif
                         C      
                         C      ; LPT:
                         C      ;=====
                         C       if	ioblpt
  D5FF    DD 21 D6B0     C      lpto:	ld	ix,lstlpt
  D603    18 06          C      	jr	lsto
                         C       endif
                         C      
                         C      ; UC1:
                         C      ;=====
                         C       if	iobuc1
  D605    DD 21 D6CD     C      uc1o:	ld	ix,lstuc1
  D609    18 00          C      	jr	lstoch		;nicht 2 Bahn Zeichen interpr.
                         C       endif
                         C      
  D60B                   C      lsto:
  D60B                   C      listi:	;interner Aufruf lsto mit gestelltem IX
                         C       IF l2bahn
                         C       ENDIF
                         C      
                         C      ; Einzelzeichenausgabe Reg. C
                         C      ;-----------------------------
  D60B                   C      lstoch:
  D60B    DD CB 00 4E    C      	bit	1,(ix+ltpst)	;senderseitig blockiert?
  D60F    C0             C      	ret	nz		;ja, Ausgabe ignorieren
  D610    C5             C      	push	bc		;retten Zeichen in C
  D611    0E 78          C      loutws:	ld	c,120		;max. Wartezeit in Sek. auf ready
  D613    06 64          C      loutw1:	ld	b,100		;100*10ms warten
  D615    C5             C      loutwt:	push	bc
  D616    CD D677        C      	CALL	lststi		;Status holen
  D619    20 16          C      	jr	nz,loutwf	;ist frei
  D61B    06 01          C      	ld	b,1
  D61D    CD E78A        C      	call	wait10		;Warten 10 ms
  D620    C1             C      	pop	bc
  D621    10 F2          C      	djnz	loutwt		;weiter warten?
  D623    0D             C      	dec	c		;weitere Sekunde warten?
  D624    20 ED          C      	jr	nz,loutw1	;ja
                         C       IF errvar
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-47


  D626    CD D63B        C      	call	spioer		;Fehlermeldung
  D629    20 E6          C      	jr	nz,loutws	;Wiederholung
                         C       ENDIF
  D62B    C1             C      	pop	bc
  D62C    DD CB 00 CE    C      	set	1,(ix+ltpst)	;Sender blockiert
  D630    C9             C      	ret			;folgende Ausgaben werden ignor.
  D631    C1             C      loutwf:	pop	bc
  D632    C1             C      	pop	bc
  D633    79             C      	ld	a,c		;auszugebendes Zeichen nach A
  D634    DD 6E 04       C      	ld	l,(ix+ltpo)
  D637    DD 66 05       C      	ld	h,(ix+ltpo+1)
  D63A    E9             C      	jp	(hl)
                         C      
                         C       IF errvar
  D63B    DD 7E 02       C      spioer:	ld	a,(ix+ltpsd)	;Daten-Port-Adresse
  D63E    11 D65A        C      	ld	de,louttp
  D641    CD E799        C      	call	mrecoa		;in Text
  D644    21 D65A        C      	ld	hl,loutto
  D647    CD E779        C      	call	biosms
  D64A    CD D0AE        C      	call	kbdbcl
  D64D    CD E62C        C      	call	conin
  D650    CB AF          C      	res	5,a
  D652    FE 03          C      	cp	'C' and 1fh	;^C ?
  D654    CA 0000        C      	jp	z,0		;ja, Abbruch
  D657    FE 49          C      	cp	'I'		;ret z: 'I'; ret nz: 'R'
  D659    C9             C      	ret
                         C      
  D65A                   C      loutto:
                         C       IF cpastz
                         C       ENDIF
  D65A    58 58 68 20    C      louttp:	db	'XXh Fehler ^C/I/R'
  D65E    46 65 68 6C    C      
  D662    65 72 20 5E    C      
  D666    43 2F 49 2F    C      
  D66A    52             C      
                         C       IF cpastz
                         C       ENDIF
                         C       ENDIF	;errvar
                         C      
                         C      ;-----------------------
                         C      
                         C      
                         C      ; Status
                         C      ;-------
                         C      ; o A=0, ret z	: Ausgabe besetzt
                         C      ; o A=ff,ret nz	: Ausgabe frei
                         C      
                         C      ; TTY:
                         C      ;=====
                         C       if	iobtty
  D66B    DD 21 D693     C      ttyst:	ld	ix,lsttty
  D66F    18 06          C      	jr	lstst
                         C       endif
                         C      
                         C      ; LPT
                         C      ;====
                         C       if	ioblpt
  D671    DD 21 D6B0     C      lptst:	ld	ix,lstlpt
  D675    18 00          C      	jr	lstst
                         C       endif
                         C      
                         C       if iobuc1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-48


                         C       endif
                         C      
  D677                   C      lstst:
  D677                   C      lststi:	;interner Aufruf Sender-Status mit gestelltem IX
                         C      ; ret nz, A=FF fuer frei
                         C      ; ret z , A=00 fuer besetzt
                         C      
  D677    DD 6E 08       C      	ld	l,(ix+ltps)
  D67A    DD 66 09       C      	ld	h,(ix+ltps+1)
  D67D    E9             C      	jp	(hl)
                         C      
                         C      ;-----------------------------
                         C      
                         C      ; Zeichenempfang
                         C      ;---------------
                         C      
  D049                   C      ttyi	equ	dumi
  D049                   C      lpti	equ	dumi
                         C       if iobuc1
                         C       endif
                         C      
                         C      ;-------------------------------
                         C      
                         C      ; Alle zeichenweisen Geraete neu synchronisieren
                         C      ;-----------------------------------------------
  D67E                   C      lsynch:	
  D67E    AF             C      	xor	a
                         C      	if	iobtty
  D67F    32 D693        C      	ld	(lsttty+ltpst),a
                         C      	endif
                         C      	if	ioblpt
  D682    32 D6B0        C      	ld	(lstlpt+ltpst),a
                         C      	endif
                         C      	if	iobuc1
  D685    32 D6CD        C      	ld	(lstuc1+ltpst),a
                         C      	endif
  D688    C9             C      	ret
                         C      
                         C      ; Portprogrammierung
                         C      ;===================
                         C      ; i HL	^Steuertabelle, Laenge+1, Port, Bytes,...,1
  D689                   C      portpr:
  D689    46             C      portpz:	ld	b,(hl)		;Stringlaenge +1
  D68A    23             C      	inc	hl
  D68B    05             C      	dec	b		;Ende?
  D68C    C8             C      	ret	z		;ja
  D68D    4E             C      	ld	c,(hl)		;Port
  D68E    23             C      	inc	hl
  D68F    ED B3          C      	otir
  D691    18 F6          C      	jr	portpz
                         C      
                         C      ;Steuertabellen fuer zeichenweise arbeitende Geraete
                         C      ;===================================================
                         C      
                         C      ;Struktur:
                         C      ; fester Teil
  0000                   C      ltpst	equ	0	;Status
                         C      			;Bit  7-4 Empf.,3-0 Sender  Bedeutung, wenn =1
                         C      			;	4	0 Empfseite init./ Senderseite init.
                         C      			;	5	1      -	 / Sender blockiert
                         C      			;	7	3 Sender gestoppt/ Sender hat frei gem.
  0001                   C      ltpdc	equ	1	;DC1/DC3: zuletzt empf. Zeichen (i.a. DCx)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-49


                         C      			;DTR:	Statusmaske (Bit 5 Kanal A, Bit 3 Kanal B),
                         C      			;	Bit 7 =1 wenn kein Wait auf Senderegister leer
  0002                   C      ltpsd	equ	2	;Portadr. Daten
  0003                   C      ltpsc	equ	3	;Portadr. Kommando/Status (noch mal in ltpini!)
                         C      
  0004                   C      ltpo	equ	4	;Adresse der Senderoutine
  0006                   C      ltpi	equ	6	;Adresse der Empfangsroutine
  0008                   C      ltps	equ	8	;Adresse der Empfangsstatus-Routine
                         C      
                         C      ; Der folgende Teil existiert nur fuer SIO-Treiber
  000A                   C      ltpw5	equ	10	;WR5:
                         C      			;DTR/RTS Bit 7,1: 11 DTR; 00 DC1/DC3
                         C      			;Bitanzahl/Byte Bit 6,5: 00 5;01 7;10 6;11 8
                         C      			;Bit 3 = 1 (Senderfreigabe)
                         C      			;Bit 0,2,4 = 0
                         C      ; Port-Initialisierung (fuer alle Treiber)
  000B                   C      ltpini	equ	11	;jeweils Byteanzahl+1; Port; Bytefolge
                         C      			;variabel lang
                         C      
                         C      			;fuer SIO-Treiber einige Erlaeuterungen:
  000C                   C      ltpcs	equ	12	;Port CTC-Sendetakt
                         C      			;Vorteiler (37h Vorteiler 256, 17h Vorteiler 16)
                         C      			;Baudrate (1=9600,2=4800,..64=150,96=100,128=75)
                         C      			;evtl. nochmal fuer Port CTC-Empf.takt
                         C      			;WR4:
                         C      			;Paritaet  in Bit 1,0: 00 ohne, 01 unger., 11 ger.
                         C      			;Stop-Bits in Bit 3,2: 01 1; 10 1,5; 11 2
                         C      			;Reserve   in Bit 5,4: 00 immer (nur fuer Synchr.mode)
                         C      			;Takt      in Bit 7,6: 00 *1, 01 *16, 10 *32, 11 *64
                         C      			;WR1:
                         C      			;Interrvektormod. in Bit 2: 0=keine Modifizierung
                         C      			;in Kanal B!! setzen
                         C      			;Empf.interr.mode Bit4,3: 00 kein Interrupt
                         C      			;			  01 bei erstem Zeichen
                         C      			;			  10 bei jedem mit Mod.
                         C      			;			  11 bei jedem ohne Mod.
                         C      			;WR3:
                         C      			;Empf.freigabe in Bit 0: 0=Empf. gesperrt; 1=Empf. frei
                         C      			;Bit 1-5:00000
                         C      			;Bitanzahl/Byte Bit 7,6:00 5;01 7;10 6;11 8
                         C      
                                 IF iobtty
  0713                          @lt	aset	iobtty
  0050                          @ld	aset	ttydat
  0051                          @ls	aset	ttysta
  000C                          @lcs	aset	ttycts
  000C                          @lcr	aset	ttyctr
  0000                          @wr1	aset	00000000b ;WR1: kein Interruptbetrieb
  0000                          @wsre	aset	00000000b ;Bit 7=0: Warten auf Senderegister leer
  D693                   C      lsttty: include BIOSCPB
                         C      ;; 07.04.89
                         C      ;; 06.07.89
                         C      ;; - Einfuehrung Bit 7 in Statusmaske DTR - =1 kein Warten Senderegister leer
  D693    00             C      	db	00H	;Status
                         C       IF ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
                         C        IF (@lt mod 10) eq 1; DTR, Treiber 1
  0008                   C      @l	aset	@wsre xor 08h	;Statusmaske DTR-Abfrage ueber DCD im Kanal B
                         C        ENDIF
                         C        IF (@lt mod 10) eq 3; DTR, Treiber 3
                         C        ENDIF
  D694    08             C      	db	@l	;DTR-Abfrage-Maske, Bit 7 Wait_Senderegister_leer-Flag
                         C       ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-50


  D695    50             C      	db	@ld	;Port fuer Daten
  D696    51             C      	DB	@ls	;Port fuer Status/Kommando
                         C       IF (@lt mod 10) lt 5	;;SIO ###########################################
                         C       if ((@lt mod 10) eq 0) or ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
  D697    D6EA           C      	dw	cdsioo	;;Senden
  D699    D049           C      	dw	cdsioi	;;Empfang
  D69B    D6F0           C      	dw	cdsios	;;Empf.Status
                         C       endif
                         C       if (@lt mod 10) eq 2
                         C       endif
  0008                   C      @l	aset	00001000b	;;DC1/3, 5 Bit
                         C       if ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
  008A                   C      @l	aset	@l xor 10000010b	;;DTR
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 6
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 7
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 8
  00EA                   C      @l	aset	@l xor 01100000b
                         C       endif
  D69D    EA             C      	db	@l	;WR5
                         C      			;**Portinitialisierung**
                         C      ; CTC Sendetakt
  D69E    03             C       	db	2+1
  D69F    0C             C      	db	@lcs		;CTC Senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
  D6A0    17             C      	db	17h		;Vorteiler 16
                         C       ENDIF
  0001                   C      @l	aset	1 shl (((@lt mod 100)/10)-1)
                         C        if ((@lt mod 100)/10) eq 8
                         C        endif
                         C        if ((@lt mod 100)/10) eq 9
                         C        endif
  D6A1    01             C      	db	@l		;Baudrate senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
                         C      ;;; zum nachtraeglichen Patchen immer CTC Empf. generieren
                         C      ;;; auch wenn '@cls eq @clr'
                         C      ; CTC Empfangstakt
  D6A2    03             C      	db	2+1
  D6A3    0C             C      	db	@lcr		;CTC Empf.
  D6A4    17             C      	db	17h		;Vorteiler 16
  D6A5    01             C      	db	@l		;Baudrate empf.
                         C      ; SIO-Initialisierung
  D6A6    08             C      	db	7+1
  D6A7    51             C      	db	@ls		;SIO-Komm.
  D6A8    18             C      	db	18h		;WR0
  0044                   C      @l	aset	01000100b	;;Takt*16, ohne P., 1 Stbit, DTR
                         C       if (@lt mod 10) eq 2
                         C       endif
                         C        if @lt ge 10000
                         C        endif
                         C        if @lt ge 20000
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 2
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 3
                         C        endif
  D6A9    04 44          C      	db	4,@l		;WR4
  D6AB    01 00          C      	db	1,@wr1		;WR1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-51


  0001                   C      @l	aset	00000001b	;;5 Bit, Empf.freigabe
                         C        if ((@lt mod 1000)/100) eq 6
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 7
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 8
  00C1                   C      @l	aset	@l xor 11000000b
                         C        endif
  D6AD    03 C1          C      	db	3,@l		;WR3
                         C        ENDIF	;;(cpu ne c1715) or (@ld ne kbdsci)
  D6AF    01             C      	db	1	;**Ende SIO-Initialisierung** 
                         C       ENDIF
                         C      
                                 ENDIF
                                
                                 IF ioblpt
  2DBE                          @lt	aset	ioblpt
  005E                          @ld	aset	lptdat
  005F                          @ls	aset	lptsta
  0058                          @lcs	aset	lptcts
  0058                          @lcr	aset	lptctr
  0000                          @wr1	aset	00000000b ;WR1: kein Interruptbetrieb
  0000                          @wsre	aset	00000000b ;Bit 7=0: Warten auf Senderegister leer
  D6B0                   C      lstlpt: include BIOSCPB
                         C      ;; 07.04.89
                         C      ;; 06.07.89
                         C      ;; - Einfuehrung Bit 7 in Statusmaske DTR - =1 kein Warten Senderegister leer
  D6B0    00             C      	db	00H	;Status
                         C       IF ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
                         C       ELSE ;DC1/3 oder PIO
  D6B1    00             C      	db	00H	;zuletzt empfangenes Zeichen
                         C       ENDIF
  D6B2    5E             C      	db	@ld	;Port fuer Daten
  D6B3    5F             C      	DB	@ls	;Port fuer Status/Kommando
                         C       IF (@lt mod 10) lt 5	;;SIO ###########################################
                         C       if ((@lt mod 10) eq 0) or ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
  D6B4    D6EA           C      	dw	cdsioo	;;Senden
  D6B6    D049           C      	dw	cdsioi	;;Empfang
  D6B8    D6F0           C      	dw	cdsios	;;Empf.Status
                         C       endif
                         C       if (@lt mod 10) eq 2
                         C       endif
  0008                   C      @l	aset	00001000b	;;DC1/3, 5 Bit
                         C       if ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 6
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 7
  0028                   C      @l	aset	@l xor 00100000b
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 8
                         C       endif
  D6BA    28             C      	db	@l	;WR5
                         C      			;**Portinitialisierung**
                         C      ; CTC Sendetakt
  D6BB    03             C       	db	2+1
  D6BC    58             C      	db	@lcs		;CTC Senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
  D6BD    17             C      	db	17h		;Vorteiler 16
                         C       ENDIF
  0001                   C      @l	aset	1 shl (((@lt mod 100)/10)-1)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-52


                         C        if ((@lt mod 100)/10) eq 8
                         C        endif
                         C        if ((@lt mod 100)/10) eq 9
                         C        endif
  D6BE    01             C      	db	@l		;Baudrate senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
                         C      ;;; zum nachtraeglichen Patchen immer CTC Empf. generieren
                         C      ;;; auch wenn '@cls eq @clr'
                         C      ; CTC Empfangstakt
  D6BF    03             C      	db	2+1
  D6C0    58             C      	db	@lcr		;CTC Empf.
  D6C1    17             C      	db	17h		;Vorteiler 16
  D6C2    01             C      	db	@l		;Baudrate empf.
                         C      ; SIO-Initialisierung
  D6C3    08             C      	db	7+1
  D6C4    5F             C      	db	@ls		;SIO-Komm.
  D6C5    18             C      	db	18h		;WR0
  0044                   C      @l	aset	01000100b	;;Takt*16, ohne P., 1 Stbit, DTR
                         C       if (@lt mod 10) eq 2
                         C       endif
                         C        if @lt ge 10000
  0045                   C      @l	aset	@l xor 00000001b	;;ung P.
                         C        endif
                         C        if @lt ge 20000
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 2
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 3
                         C        endif
  D6C6    04 45          C      	db	4,@l		;WR4
  D6C8    01 00          C      	db	1,@wr1		;WR1
  0001                   C      @l	aset	00000001b	;;5 Bit, Empf.freigabe
                         C        if ((@lt mod 1000)/100) eq 6
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 7
  0041                   C      @l	aset	@l xor 01000000b
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 8
                         C        endif
  D6CA    03 41          C      	db	3,@l		;WR3
                         C        ENDIF	;;(cpu ne c1715) or (@ld ne kbdsci)
  D6CC    01             C      	db	1	;**Ende SIO-Initialisierung** 
                         C       ENDIF
                         C      
                                 ENDIF
                                
                                 IF iobuc1
  0713                          @lt	aset	iobuc1
  0050                          @ld	aset	uc1dat
  0051                          @ls	aset	uc1sta
  000C                          @lcs	aset	uc1cts
  000C                          @lcr	aset	uc1ctr
  0014                          @wr1	aset	00010100b ;WR1: Empfangsinterr. bei jedem Char., Intv.modif.
  0080                          @wsre	aset	10000000b ;Bit 7=1: kein Warten auf Senderegister leer
  D6CD                   C      lstuc1: include BIOSCPB
                         C      ;; 07.04.89
                         C      ;; 06.07.89
                         C      ;; - Einfuehrung Bit 7 in Statusmaske DTR - =1 kein Warten Senderegister leer
  D6CD    00             C      	db	00H	;Status
                         C       IF ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
                         C        IF (@lt mod 10) eq 1; DTR, Treiber 1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-53


  0088                   C      @l	aset	@wsre xor 08h	;Statusmaske DTR-Abfrage ueber DCD im Kanal B
                         C        ENDIF
                         C        IF (@lt mod 10) eq 3; DTR, Treiber 3
                         C        ENDIF
  D6CE    88             C      	db	@l	;DTR-Abfrage-Maske, Bit 7 Wait_Senderegister_leer-Flag
                         C       ENDIF
  D6CF    50             C      	db	@ld	;Port fuer Daten
  D6D0    51             C      	DB	@ls	;Port fuer Status/Kommando
                         C       IF (@lt mod 10) lt 5	;;SIO ###########################################
                         C       if ((@lt mod 10) eq 0) or ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
  D6D1    D6EA           C      	dw	cdsioo	;;Senden
  D6D3    D049           C      	dw	cdsioi	;;Empfang
  D6D5    D6F0           C      	dw	cdsios	;;Empf.Status
                         C       endif
                         C       if (@lt mod 10) eq 2
                         C       endif
  0008                   C      @l	aset	00001000b	;;DC1/3, 5 Bit
                         C       if ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
  008A                   C      @l	aset	@l xor 10000010b	;;DTR
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 6
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 7
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 8
  00EA                   C      @l	aset	@l xor 01100000b
                         C       endif
  D6D7    EA             C      	db	@l	;WR5
                         C      			;**Portinitialisierung**
                         C      ; CTC Sendetakt
  D6D8    03             C       	db	2+1
  D6D9    0C             C      	db	@lcs		;CTC Senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
  D6DA    17             C      	db	17h		;Vorteiler 16
                         C       ENDIF
  0001                   C      @l	aset	1 shl (((@lt mod 100)/10)-1)
                         C        if ((@lt mod 100)/10) eq 8
                         C        endif
                         C        if ((@lt mod 100)/10) eq 9
                         C        endif
  D6DB    01             C      	db	@l		;Baudrate senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
                         C      ;;; zum nachtraeglichen Patchen immer CTC Empf. generieren
                         C      ;;; auch wenn '@cls eq @clr'
                         C      ; CTC Empfangstakt
  D6DC    03             C      	db	2+1
  D6DD    0C             C      	db	@lcr		;CTC Empf.
  D6DE    17             C      	db	17h		;Vorteiler 16
  D6DF    01             C      	db	@l		;Baudrate empf.
                         C      ; SIO-Initialisierung
  D6E0    08             C      	db	7+1
  D6E1    51             C      	db	@ls		;SIO-Komm.
  D6E2    18             C      	db	18h		;WR0
  0044                   C      @l	aset	01000100b	;;Takt*16, ohne P., 1 Stbit, DTR
                         C       if (@lt mod 10) eq 2
                         C       endif
                         C        if @lt ge 10000
                         C        endif
                         C        if @lt ge 20000
                         C        endif
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-54


                         C        if ((@lt mod 10000)/1000) eq 2
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 3
                         C        endif
  D6E3    04 44          C      	db	4,@l		;WR4
  D6E5    01 14          C      	db	1,@wr1		;WR1
  0001                   C      @l	aset	00000001b	;;5 Bit, Empf.freigabe
                         C        if ((@lt mod 1000)/100) eq 6
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 7
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 8
  00C1                   C      @l	aset	@l xor 11000000b
                         C        endif
  D6E7    03 C1          C      	db	3,@l		;WR3
                         C        ENDIF	;;(cpu ne c1715) or (@ld ne kbdsci)
  D6E9    01             C      	db	1	;**Ende SIO-Initialisierung** 
                         C       ENDIF
                         C      
                                 ENDIF
                                
                                  IF cdtdc1 or cdtdtr
                         C      	include BIOSCSIO
                         C      ;===================================================================
                         C      ; SIO-Treiber, DTR- und DC1/DC3-Protokoll
                         C      ;===================================================================
                         C      ;
                         C      ; Aenderungen:
                         C      ; - Statusabfrage jedesmal, auch wenn zuvor frei gemeldet
                         C      ; - Pufferueberlauf bei UC1-Puffer kontrolliert
                         C      ; - bei DC1/DC3 nach Initialisierung 7fh an Drucker und max. 30 sec auf
                         C      ;  Antwort gewartet (sonst Fehler am SD1157, wenn zu frueh gesendet wird)
                         C      ; 29.6.88:
                         C      ; - bei DC1/3 Protokoll wird neu initialisiert, wenn DC4 vom Drucker kommt
                         C      ;  (Probleme bei K6314)
                         C      ; 20.09.88
                         C      ; - Neben DTR-Statusabfrage ueber Kanal B, Bit 3 (Treiber 1, Standard)
                         C      ;  auch DTR-Statusabfrage ueber Kanal A, Bit 5 (Treiber 3) unterstuetzt
                         C      ; 23.03.89
                         C      ; - CTS-Zusammenspiel bei K6311 u.ae. funktioniert nur, wenn bis zum
                         C      ;   Verlassen aller Bits aus dem Sender gewartet wird und nicht nur auf
                         C      ;   das Freiwerden des Sendepuffers - sonst Zeichenverlust!
                         C      ; - wenn UC1 am Kanal A wird WR1 Bit2 und WR2 im Kanal B gesetzt
                         C       IF cpu eq c1715
                         C       ENDIF
                         C      ; 04.04.89
                         C      ; - nach Drucker-Init 'set 0,(ix+ltpst)' statt 'ld (ix+ltpst),11h'
                         C      ; 06.07.89
                         C      ; - wegen K6314-Problemen wird nach Initialisierung DC1 angenommen
                         C      ; - bei UC1-Kopplung ueber DTR ohne Warten auf Senderegister leer,
                         C      ;   nur Warten auf Sendepuffer leer
                         C      ;   (Aenderung 23.03.89 daher nur fuer Drucker wirksam, sonst zu langsam)
                         C      ; 15.09.89
                         C      ; - bei UC1-Kopplung ueber DC1/DC3 nicht 7fh zu Beginn gesendet, sondern DC1
                         C      ;**************************************************************************
                         C      
  D049                   C      cdsioi	equ	dumi		;keine Zeicheneingabe unterstuetzt
                         C      
                         C      ; Einzelzeichenausgabe Reg. A
  D6EA    DD 4E 02       C      cdsioo:	ld	c,(ix+ltpsd)	;Datenport
  D6ED    ED 79          C      	out	(c),a
  D6EF    C9             C      	ret
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-55


                         C      
                         C      ;------------------------------------
                         C      
                         C      ; Statusabfrage
  D6F0    DD 7E 00       C      cdsios:	ld	a,(ix+ltpst)	;Status
  D6F3    CB 4F          C      	bit	1,a		;senderseitig blockiert?
  D6F5    20 3F          C      	jr	nz,lstsr	;ja, frei rueckmelden
  D6F7    B7             C      	or	a		;initialisiert?
  D6F8    CC D75D        C      	call	z,cdsins	;nein
  D6FB    DD CB 0A 7E    C      	bit	7,(ix+ltpw5)	;Prozedur DTR?
  D6FF    28 3A          C      	JR	Z,lstsdc	;nein
  D701    DD 4E 03       C      	ld	c,(ix+ltpsc)	;SIO Kommando
                         C       IF iobuc1
  D704    DD CB 01 7E    C      	bit	7,(ix+ltpdc)	;Warten auf Senderegister leer?
  D708    28 0C          C      	jr	z,lstse0	;ja
  D70A    3E 10          C      	ld	a,00010000b	;Reset Ext/Status-Interrupt, Lesereg. 0
  D70C    ED 79          C      	out	(c),a		;Status abspeichern
  D70E    ED 78          C      	in	a,(c)		;Lesereg. 0
  D710    CB 57          C      	bit	2,a		;Sendepuffer leer?
  D712    20 0C          C      	jr	nz,lstse1	;ja
  D714    18 20          C      	jr	lstsr		;nein, Drucker besetzt
  D716                   C      lstse0:
                         C       ENDIF
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D716    3E 11          C      	LD	a,00010001b	;Reset Ext/Status-Interrupt, Lesereg. 1
  D718    ED 79          C      	OUT	(C),a		;Status abspeichern
  D71A    ED 78          C      	IN	a,(C)		;Leseregister 1
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D71C    CB 47          C      	bit	0,a		;alle Bits gesendet?
                         C      				; Sendepuffer frei reicht nicht, da
                         C      				; K6311 u.ae. nicht korrekt arbeiten
  D71E    28 16          C      	jr	z,lstsr		;nein, Drucker besetzt
  D720    DD CB 01 5E    C      lstse1:	bit	3,(ix+ltpdc)	;Abfrage DTR ueber DCD im Kanal B?
  D724    20 06          C      	jr	nz,lstsb3	;ja
  D726    ED 78          C      	in	a,(c)		;Leseregister 0
  D728    CB 6F          C      	bit	5,a		;CTS?
  D72A    18 0A          C      	jr	lstsr		;nz bei ja
  D72C    0C             C      lstsb3:	inc	c
  D72D    0C             C      	inc	c		;auf Kanal B
  D72E    3E 10          C      	LD	a,00010000b	;Reset Ext/Status-Interrupt, Lesereg. 0
  D730    ED 79          C      	out	(c),a		;DCD in RR0 Kanal B abspeichern
  D732    ED 78          C      	in	a,(c)		;Leseregister 0 des Kanal B
  D734    CB 5F          C      	bit	3,a		;DCD im Kanal B (ist DTR-Bit vom Kanal A)
                         C      ; Ausgang Senderstatus
  D736                   C      lstsr:
  D736    3E FF          C      lstsr1:	ld	a,0ffh
  D738    C0             C      	ret	nz		;senderseitig frei
  D739    3C             C      	inc	a		;A=00, ret z
  D73A    C9             C      	RET			;senderseitig besetzt
                         C      ;-----------------------
                         C      ; DC1/DC3 und XON/XOFF
  D73B    DD 4E 02       C      lstsdc:	LD	C,(ix+ltpsd)	;SIO Daten
  D73E    ED 78          C      	IN	A,(C)		;Status lesen (SIO speichert letzten Status)
  D740    DD 77 01       C      	LD	(ix+ltpdc),A	;zuletzt empf. Zeichen fuer Fehlersuche merken
  D743    E6 7F          C      	and	7fh		;evtl. Paritaet ignorieren
  D745    FE 13          C      	cp	13h		;DC3?
  D747    28 12          C      	jr	z,lstsd2	;ja, besetzt
  D749    FE 14          C      	cp	14h		;DC4 (Status)?
  D74B    20 05          C      	jr	nz,lstsd1	;nein (DC1 angenommen)
  D74D    CD D791        C      	call	cdsini		;statt Status abzuholen neu initialisieren
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-56


  D750    18 E9          C      	jr	lstsdc		;und Status neu abfragen
  D752    DD 4E 03       C      lstsd1:	ld	c,(ix+ltpsc)	;SIO Kommando
  D755    ED 78          C      	in	a,(c)
  D757    CB 57          C      	bit	2,a		;Sendepuffer leer? (nz bei ja)
  D759    18 DB          C      	jr	lstsr
  D75B    AF             C      lstsd2:	xor	a		;A=00, ret z
  D75C    C9             C      	ret			;senderseitig besetzt
                         C      
                         C      ;-----------------------
                         C      
                         C      ; (Re-)Initialisierung
                         C      ; IX auf Steuertabelle
                         C      ; ret: C zeigt auf Kommandoport
                         C      
                         C      ; Sender initialisieren
  D75D                   C      cdsins:
  D75D    DD CB 00 C6    C      	set	0,(ix+ltpst)	;Sender ist initialisiert
  D761    CD D791        C      	call	cdsini
  D764    DD CB 0A 7E    C      	bit	7,(ix+ltpw5)	;Prozedur DC1/DC3?
  D768    C0             C      	ret	nz		;nein
  D769    41             C      	ld	b,c
  D76A    DD 4E 02       C      	ld	c,(ix+ltpsd)	;Datenport
                         C       IF iobuc1
  D76D    DD CB 01 7E    C       	bit	7,(ix+ltpdc)	;Warten auf Senderegister leer?
  D771    28 06          C      	jr	z,cdsind	;ja, Drucker
  D773    3E 11          C      	ld	a,11h		;bei UC1: mit DC1/DC3-Protokoll DC1 senden
  D775    ED 79          C      	out	(c),a
  D777    48             C      	ld	c,b
  D778    C9             C      	ret
                         C       ENDIF
  D779    3E 7F          C      cdsind:	ld	a,7fh		;nach Initialisierung RESET senden
  D77B    ED 79          C      	out	(c),a
  D77D    48             C      	ld	c,b
  D77E    11 0BB8        C      	ld	de,30*100	;max. Wartezeit ca. 30 sec (SD1157!)
  D781    ED 78          C      cdsinw:	in	a,(c)
  D783    CB 47          C      	bit	0,a		;Antwort da?
  D785    C0             C      	ret	nz		;ja
  D786    06 01          C      	ld	b,1
  D788    CD E78A        C      	call	wait10		;10ms warten
  D78B    1B             C      	dec	de
  D78C    7A             C      	ld	a,d
  D78D    B3             C      	or	e		;max. Wartezeit abgelaufen?
  D78E    20 F1          C      	jr	nz,cdsinw	;nein
  D790    C9             C      	ret			;sonst Drucker wohl nicht bereit
                         C      
                         C      
                         C      ; gem. UP fuer Sender und Empf. initialisieren
  D791                   C      cdsini:
  D791    DD E5          C      	push	ix
  D793    E1             C      	pop	hl
  D794    01 000B        C      	ld	bc,ltpini
  D797    09             C      	add	hl,bc
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D798    CD D689        C      	call	portpr		;CTC, WR0, WR4, WR1, WR3
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D79B    DD 5E 0A       C      ltpow5:	LD	e,(ix+ltpw5)	;Prozedurtyp/Bitanzahl
                         C      ; Stellen Schreibregister 5
                         C      ; Reg. B,HL bleiben erhalten
  D79E    3E 05          C      ltpot5:	ld	a,5
  D7A0    DD 4E 03       C      	ld	c,(ix+ltpsc)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-57


                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D7A3    ED 79          C      	OUT	(C),A
  D7A5    ED 59          C      	OUT	(C),e
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D7A7    C9             C      	RET
                         C      
                         C      ;-------------------------------------
                         C       if iobuc1
                         C      
                         C      ; UC1-Routinen (ausser Senden)
                         C      
                         C      ; UC1: Empf.-Status
                         C      ;==================
                         C      ; o A=0, ret z	: kein Zeichen empfangen
                         C      ; o A=ff,ret nz	: Zeichen da
  D7A8    DD 21 D6CD     C      uc1st:	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
  D7AC                   C      uc1si:	;interner Aufruf mit gestelltem IX
  D7AC    DD CB 00 66    C      	bit	4,(ix+ltpst)	;initialisiert?
  D7B0    20 19          C      	jr	nz,uc1si1	;ja
  D7B2    AF             C      	xor	a
  D7B3    32 D879        C      	ld	(uc1bfp),a	;Puffer leeren
  D7B6    CD D791        C      	call	cdsini		;Initialisierung
  D7B9    DD CB 00 E6    C      	set	4,(ix+ltpst)	;Empfaenger ist initialisiert
  D7BD    F3             C      	di
                         C       IF (uc1dat xor uc1sta) eq 01b	;Kanal-Nr ist Bit 1 (bei Buerocomp und OEM)
                         C        IF (uc1sta and 10b) eq 00b	;UC1 ist an Kanal A
  D7BE    CB C9          C      	set	1,c		;Kanal B erzwingen
                         C        ENDIF
                         C       ENDIF
  D7C0    21 D7D3        C      	ld	hl,uc1i2	;WR1,WR2 programmieren
  D7C3    06 04          C       	ld	b,uc1il
  D7C5    ED B3          C      	otir
  D7C7    FB             C      	ei
  D7C8    CD D802        C      	call	uc1ird		;DTR bzw. DC1 senden
  D7CB    3A D879        C      uc1si1:	ld	a,(uc1bfp)	;Zeichen im Empfpuffer?
  D7CE    B7             C      	or	a
  D7CF    C8             C      	ret	z		;nein
  D7D0    3E FF          C      	ld	a,0ffh
  D7D2    C9             C      	ret
                         C      
  D7D3                   C      uc1i2: ;zusaetzliche Initialisierung fuer WR1/Bit2 und WR2 (beide nur Kanal B)
                         C       IF (uc1dat xor uc1sta) eq 01b	;Kanal-Nr ist Bit 1 (bei Buerocomp und OEM)
                         C        IF (uc1sta and 10b) eq 00b	;UC1 ist an Kanal A
  D7D3    01 04          C      	db	1,00000100b	;WR1, Kanal B: Intv.modif. setzen
                         C        ENDIF
                         C       ENDIF
  D7D5    02 D0          C      	db	2,ivsio0	;WR2, Kanal B: Interruptvektor
  0004                   C      uc1il	equ	$-uc1i2
                         C      ; UC1: empf. Zeichen an Nutzer
                         C      ;=============================
                         C      ; o A:	aeltestes empf. Zeichen
                         C      
  D7D7    DD 21 D6CD     C      uc1i:	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
                         C      
  D7DB                   C      uc1ii:	;interner Aufruf mit gestelltem IX
  D7DB    FB             C      uc1iw:	ei			;UC1:-Interrupt zulassen
  D7DC    CD D7AC        C      	call	uc1si		;Zeichen da?
  D7DF    28 FA          C      	jr	z,uc1iw		;nein ***keine Zeitueberwachung!***
  D7E1    21 D879        C      	ld	hl,uc1bfp
  D7E4    F3             C      	di
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-58


  D7E5    4E             C      	ld	c,(hl)
  D7E6    35             C      	dec	(hl)		;Pufferlaenge -1
  D7E7    06 00          C      	ld	b,0
  D7E9    23             C      	inc	hl		;^(aeltestes Pufferzeichen)
  D7EA    7E             C      	ld	a,(hl)		;Zeichen nach A
  D7EB    11 D87B        C      	ld	de,uc1buf+1
  D7EE    EB             C      	ex	de,hl
  D7EF    ED B0          C      	ldir			;Puffer aufschieben
  D7F1    FB             C      	ei
  D7F2    DD CB 00 7E    C      	bit	7,(ix+ltpst)	;war Stopaufforderung?
  D7F6    C8             C      	ret	z		;nein
  D7F7    F5             C      	push	af		;retten Zeichen
  D7F8    3A D879        C      	ld	a,(uc1bfp)	;Pufferbelegung
  D7FB    FE 06          C      	cp	1*uc1bfl/3	;unter dem Limit?
  D7FD    DC D802        C      	call	c,uc1ird	;ja, Senden wieder erlauben
  D800    F1             C      	pop	af
  D801    C9             C      	ret
                         C      
                         C      ; Empfangsbereitschaft anzeigen
  D802    DD CB 00 BE    C      uc1ird:	res	7,(ix+ltpst)
  D806    DD CB 0A 7E    C      	bit	7,(ix+ltpw5)	;Prozedur DC1/DC3?
  D80A    C2 D79B        C      	jp	nz,ltpow5	;nein, DTR wieder setzen
  D80D    3E 11          C      	ld	a,11h		;DC1 (Senden wieder erlauben)
  D80F    DD 4E 02       C      	LD	C,(ix+ltpsd)	;SIO Daten
  D812    ED 79          C      	OUT	(C),A
  D814    C9             C      	ret
                         C      
                         C      ; UC1: Empf.-Interrupt
                         C      ;=====================
  D815    ED 73 E579     C      uc1rin:	ld	(intsp),sp
  D819    31 F0E9        C      	ld	sp,intstk
  D81C    F5             C      	push	af
  D81D    E5             C      	push	hl
  D81E    D5             C      	push	de
  D81F    C5             C      	push	bc
  D820    DD E5          C      	push	ix
  D822    21 D842        C      	ld	hl,uc1rir
  D825    E5             C      	push	hl
  D826    DD 21 D6CD     C      	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
  D82A    DD 4E 02       C      	ld	c,(ix+ltpsd)	;SIO Daten
  D82D    ED 40          C      	in	b,(c)		;Zeichen lesen
  D82F    21 D879        C      	ld	hl,uc1bfp	;Pufferzeiger zum zuletzt empf. Zeichen
  D832    7E             C      	ld	a,(hl)
  D833    FE 14          C      	cp	uc1bfl		;Puffer voll?
  D835    D0             C      	ret	nc		;ja, Zeichen ignorieren
  D836    FE 0D          C      	cp	2*uc1bfl/3	;Puffer fast voll (SIO-Empf.puffer 3 Byte!)?
  D838    D4 D847        C      	call	nc,uc1ri1	;ja, DC3 senden bzw. DTR wegnehmen
  D83B    34             C      	inc	(hl)		;+1
  D83C    5E             C      	ld	e,(hl)
  D83D    16 00          C      	ld	d,0
  D83F    19             C      	add	hl,de		;naechste freie Stelle
  D840    70             C      	ld	(hl),b		;Zeichen in Puffer
  D841    C9             C      	ret
  D842    DD E1          C      uc1rir:	pop	ix
  D844    C3 E574        C      	jp	intrbc		;fertig
                         C      
                         C      ; Stopaufforderung senden
                         C      ; B,HL bleibt erhalten
  D847    DD CB 00 FE    C      uc1ri1:	set	7,(ix+ltpst)	;merken Stopaufforderung
  D84B    DD 5E 0A       C      	ld	e,(ix+ltpw5)
  D84E    CB 7B          C      	bit	7,e		;Prozedur DC1/DC3?
  D850    28 05          C      	jr	z,uc1ri2	;ja
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-59


  D852    CB BB          C      	res	7,e		;DTR loeschen
  D854    C3 D79E        C      	jp	ltpot5
  D857    3E 13          C      uc1ri2:	ld	a,13h		;DC3 an Partner (Senden stopppen)
  D859    DD 4E 02       C      	LD	C,(ix+ltpsd)	;SIO Daten
  D85C    ED 79          C      	OUT	(C),A
  D85E    C9             C      	ret
                         C      
                         C      ; UC1: Interrupt Empf.-Fehler (Parit., Ueberlauf, Rahmenfehler)
                         C      ;============================
  D85F    ED 73 E579     C      uc1err:	ld	(intsp),sp
  D863    31 F0E9        C      	ld	sp,intstk
  D866    F5             C      	push	af
  D867    E5             C      	push	hl
  D868    D5             C      	push	de
  D869    C5             C      	push	bc
  D86A    DD E5          C      	push	ix
  D86C    DD 21 D6CD     C      	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
  D870    DD 4E 03       C      	ld	c,(ix+ltpsc)	;SIO Kommando
  D873    16 30          C      	ld	d,00110000b	;Reset Fehler-Interrupt
  D875    ED 51          C      	out	(c),d
                         C      				;keine Fehlermeldung, da bei
                         C      				;Empf.ueberlauf alles noch
                         C      				;mehr verzoegert wird
  D877    18 C9          C      	jr	uc1rir
                         C      
                         C      ; UC1: Empfangspuffer
                         C      ;====================
  D879    00             C      uc1bfp:	db	0
  D87A                   C      uc1buf:	ds	uc1bfl,0
                         C      
                         C       endif	;uc1
                         C      
                                  ENDIF
                                  IF cdtsib
                                  ENDIF
                                  IF cdtpio
                                  ENDIF
                                  IF cdtp54
                                  ENDIF
                                  IF cdth54
                                  ENDIF
                                  IF cdtn56 or cdtp56
                                  ENDIF
                                 ENDIF
                                
                         C      	include BIOSDSK
                         C      
                         C      ;****************************************************
                         C      ;	Diskettentreiber; Umkleidung des phys. Transfers
                         C      ;	Version 04.11.88
                         C      ; Aenderungen:
                         C      ; - Jeder Fehler in Spur 0, Sektor 1 fuehrt zur Annahme von Systemspuren
                         C      ;   (A7100-System mit 5" FM und 8272-Hardware mit 128er Sektorlaenge)
                         C      ; - !!Schnittstelle fuer diskio-Aufruf neu!! (Flags neu, side zusaetzlich)
                         C      ; - Verify nach Schreiben kann laufwerksspezifisch gewaehlt werden
                         C      ; - Laufwerkskapazitaet nach phys. LW-Nr in Statuszeile
                         C      ; - Fehlerkorrektur bei KAYPRO IV fuer C128
                         C      ; 12.06.88
                         C      ; - bei stzaus in synflg keine Pflege der Statuszeile
                         C      ; 06.07.88:
                         C      ; - Spurnummer generell auf 16 bit erweitert
                         C      ; 14.10.88
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-60


                         C      ; - Generierung ohne Floppy-Laufwerke moeglich
                         C      ; 26.10.88
                         C      ; - Test der Laufwerksbereitschaft bei Select
                         C      ; 04.11.88
                         C      ; - bei 5" und 512 Sektorlaenge Dir-Groesse 0
                         C      ; 12.03.89
                         C      ; - 'ibmfrm' gestrichen, phys. Formaterkennung fuer SIOS erfolgt immer
                         C      ;****************************************************
                         C      
                         C       if1
                         C       endif
                         C      
                         C      ; Laufwerksauswahl
                         C      ;=================
                         C      ; i C: Laufw. (0=A:, 1=B: ...)
                         C      ; i E: Bit 0 ist LOGIN-Bit von BDOS (=0, wenn LOGIN)
                         C      
  D88E    CD E871        C      seldsk:	call	dgetpb		;HL auf DPH stellen, IX auf DPB
  D891    C8             C      	ret	z		;Geraet ex. nicht
  D892    79             C      	ld	a,c
  D893    32 DF0B        C      	ld	(ddrive),a	;Laufwerk merken
  D896    CB 43          C      	bit	0,e		;LOGIN von BDOS?
  D898    C0             C      	ret	nz		;nein
                         C       if ramfl
                         C      ;###RAM-Floppy
  D899    DD CB 0F 7E    C      	bit	dpbfnd,(ix+dpbflg)	;Diskette?
  D89D    C0             C      	ret	nz		;nein, fertig
                         C      ;####
                         C       endif
  D89E    E5             C      	push	hl		;^DPH merken
                         C      
                         C      	IF	dbufsz gt 7
  D89F    21 DF02        C      	ld	hl,dbdev
  D8A2    BE             C      	cp	(hl)		;LOGIN fuer gepuffertes Device?
  D8A3    20 07          C      	jr	nz,dselnb	;nein
  D8A5    36 FF          C      	ld	(hl),0ffh	;Puffer ist ungueltig
  D8A7    21 DF01        C      	ld	hl,dbflg
  D8AA    CB 96          C      	res	dfbwr,(hl)	;kein veraend. Puffer auszug.!
  D8AC                   C      dselnb:
                         C      	ENDIF
                         C      
                         C       IF format
  D8AC    DD CB 0F 76    C      	bit	dpbfrm,(ix+dpbflg);Formaterkennung unterdr.?
  D8B0    28 1A          C      	jr	z,drdfrm	;nein
                         C       ENDIF
                         C      
                         C      ; Test der Laufwerks-Bereitschaft; nur dann Select Disk ok
                         C      ;---------------------------------------------------------
  D8B2    32 DEF4        C      	ld	(drddev),a	;log. LW
  D8B5    DD 6E 0D       C      	ld	l,(ix+dpbofs)
  D8B8    DD 66 0E       C      	ld	h,(ix+dpbofs+1)
  D8BB    22 DEF5        C      	ld	(drdtrk),hl	;auf Beginn des Verzeichnisses
  D8BE    21 DEF3        C      	ld	hl,drdcdb	;Positionieren ohne Fehlerbehandlung
  D8C1    CD DCFF        C      	call	dsktra
  D8C4    CA DAC1        C      	jp	z,selext	;ok
  D8C7    E1             C      	pop	hl		;^DPH wegschmeissen
  D8C8    21 0000        C      	ld	hl,0		;Select Fehler
  D8CB    C9             C      	ret
  D8CC                   C      drdfrm:
                         C      
                         C      	IF	format
                         C      ;++++++++++Automatische Format-Erkennung++++++++++
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-61


                         C      ; Reg. C zeigt auf Laufwerk
                         C      
                         C      	IF	dbufsz gt 7
  D8CC    CD DCCC        C       	call	dbtrw		;Puffer freimachen
                         C      				;und auf Lesen schalten
  D8CF    21 DF18        C      	ld	hl,dbnb
  D8D2    36 FF          C      	ld	(hl),0ffh	;Puffernummer ist ungueltig, obwohl evtl.
                         C      				;alle anderen Pufferparameter stimmen
                         C      				;(da nur 128 Bytes vom Puffer belegt sind)
                         C      	ENDIF
                         C      
  D8D4    79             C      	ld	a,c
  D8D5    32 DEFB        C      	ld	(dfrmdv),a
  D8D8    32 DF02        C      	ld	(dbdev),a
                         C      
  D8DB    AF             C      	xor	a
  D8DC    DD 77 0F       C      	ld	(ix+dpbflg),a	;ruecksetzen alle Flags
  D8DF    DD 77 13       C      	ld	(ix+dpbsn0),a	;keine Weiter-Numm. auf Ruecks.
  D8E2    DD 77 0D       C      	ld	(ix+dpbofs),a	;keine Systemspuren
                         C      
  D8E5    32 DEFC        C      	ld	(dfrmtr),a	;Spur 0
  D8E8    32 DF03        C      	ld	(dbtrk),a
  D8EB    32 DF04        C      	ld	(dbtrk+1),a
  D8EE    3C             C      	inc	a
  D8EF    32 DF05        C      	ld	(dbsec),a	;Sektor 1
  D8F2    32 DF07        C      	ld	(dbsnb),a	;1 phys. Sektor lesen
                         C      
                         C      ; Stellen  Sektor-Translate-Tabelle 1,2,3,...
  D8F5    DD E5          C      	push	ix
  D8F7    06 1A          C      	ld	b,26		;max. Laenge der Tabelle
                         C       IF dsk8mf
  D8F9    DD CB 18 7E    C      	bit	dpbt52,(ix+dpbtyp)	;Tabelle max 52 lang?
  D8FD    28 02          C      	jr	z,nd8mf		;nein
  D8FF    06 34          C      	ld	b,52
  D901                   C      nd8mf:
                         C       ENDIF
  D901    DD 77 19       C      selstz:	ld	(ix+dpbstr),a
  D904    DD 23          C      	inc	ix
  D906    3C             C      	inc	a
  D907    10 F8          C      	djnz	selstz
  D909    DD E1          C      	pop	ix
                         C      
                         C      ; Positionieren auf Spur 0 und analysieren Systemspuren
  D90B    CD DCE4        C      	call	dsidtr		;beliebigen Sekt.Id lesen
  D90E    20 49          C      	jr	nz,selsys	;Fehler beim Lesen; Systemsp. annehmen
                         C      ;				 (z.B. SCP1700 mit 5"FM in Spur 0!!)
  D910    7C             C      	ld	a,h
  D911    32 DF06        C      	ld	(dbslc),a	;setzen Spurformat fuer Sp. 0
                         C      	IF	dbufsz le 7
                         C      	ENDIF
  D914    21 DF01        C      	ld	hl,dbflg
                         C       IF dsk8mf
  D917    CB 9E          C      	res	dioffm,(hl)
  D919    3A DEFA        C      	ld	a,(dfrflg)	;Flag zum Lesen des Sektid.
  D91C    CB 5F          C      	bit	dioffm,a	;war dazu temporaer FM notwendig?
  D91E    28 02          C      	jr	z,nfrtfm	;nein
  D920    CB DE          C      	set	dioffm,(hl)	;sonst fuer Datenlesen uebernehmen
  D922                   C      nfrtfm:
                         C       ENDIF
  D922    46             C      	ld	b,(hl)		;merken Fehlerprotokoll-Bit
  D923    CB E6          C      	set	dfbtr,(hl)	;kein Fehlerprotokoll
  D925    E5             C      	push	hl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-62


  D926    CD DCD2        C      	call	dbtran		;Lesen Spur 0, Sektor 1
  D929    E1             C      	pop	hl
  D92A    70             C      	ld	(hl),b		;setzen Standard fuer Fehlerprotokoll-Bit
  D92B    20 2C          C      	jr	nz,selsys	;Fehler, Systemspuren annehmen
  D92D    FD E5          C      	push	iy
  D92F    FD 2A DF08     C      	ld	iy,(dbdma)
  D933    FD 7E 00       C      	ld	a,(iy+0)	;Format-Loeschbyte
  D936    FE E5          C      	cp	0e5h		;leere Diskette/geloeschter Eintrag?
  D938    20 0A          C      	jr	nz,selsy2	;nein, weder/noch
  D93A    FD BE 01       C      	cp	(iy+1)		;auch danach 0e5h?
  D93D    20 15          C      	jr	nz,selsy0	;nein, geloeschter Dir-Eintrag
  D93F    DD 35 0D       C      	dec	(ix+dpbofs)	;Flag: leere Disk oder leere Systemsp.
  D942    18 10          C      	jr	selsy0		;dpbofs auf 254
  D944                   C      selsy2:
  D944    FE 40          C      	cp	40h		;IBM-Format (SIOS-Daten-Diskette)?
  D946    28 0F          C      	jr	z,selsy1	;ja, 0 Systemspuren annehmen
  D948    FE 20          C      	cp	20h		;<=31 ? ("S"YL ist groesser!)
  D94A    30 0B          C      	jr	nc,selsy1	;nein, kann kein Directory sein; 0 Systemsp.
                         C      ;Systemlader fuer PC1715 beginnt mit 02 oder 03
  D94C    FD 7E 20       C      	ld	a,(iy+20h)	;bei SCP1715-Systemdiskette dort 00h
                         C      				;bei MicroDos dort 10h
  D94F    FD B6 21       C      	or	(iy+21h)	;bei SCP1715-Systemdiskette dort 00h
                         C      				;bei CP/A dort Dir-Eintrag (E5 oder Filename)
  D952    28 03          C      	jr	z,selsy1	;beides 00h, kein Directory; 0 Systemsp.
  D954    DD 35 0D       C      selsy0:	dec	(ix+dpbofs)	;=255, wenn Directory; =254 wenn vorn leer
  D957                   C      selsy1:
  D957    FD E1          C      	pop	iy
  D959                   C      selsys:
                         C      
                         C      ; Analysieren Datenspur
                         C      
                         C      ; SS/DS-Analyse
  D959    DD 36 12 02    C      	ld	(ix+dpbstp),2	;Doppel-Step-Impulse
  D95D    3E 03          C      	ld	a,dlgint	;auf LOGIN-Spur
  D95F    CD DCE1        C      	call	dsidtt		;belieb. SektId Vorderseite lesen
  D962    20 3B          C      	jr	nz,seldle	;Fehler, unsicheres Format
  D964    54             C      	ld	d,h		;d:=Sektorlcode, e:=Spur
                         C       IF dsk8mf
  D965    21 DEFA        C      	ld	hl,dfrcdb
  D968    CB 5E          C      	bit	dioffm,(hl)	;musste FM erzwungen werden?
  D96A    28 04          C      	jr	z,selnfm	;nein
  D96C    DD CB 0F D6    C      	set	dpbffm,(ix+dpbflg)	;sonst ist alles FM
  D970    21 DF01        C      selnfm:	ld	hl,dbflg
  D973    CB 9E          C      	res	dioffm,(hl)	;loeschen fuer normalen Transfer
                         C      
                         C       ENDIF
                         C       IF dskds
  D975    DD CB 18 46    C      	bit	dpbtds,(ix+dpbtyp)	;ist es ein DS-Laufwerk?
  D979    28 14          C      	jr	z,selss		;nein, SS
  D97B    D5             C      	push	de		;merken Sektorlaengencode und Spur
  D97C    DD CB 0F EE    C      	set	dpbfds,(ix+dpbflg)
  D980    3E 07          C      	ld	a,1+(dlgint*2)	;Rueckseite der Spur,
                         C      				;ab der Format bei SS konstant
  D982    CD DCE1        C      	call	dsidtt		;beliebigen Sekt.Id Ruecks. lesen
  D985    7A             C      	ld	a,d		;merken side Ruecks.
  D986    6B             C      	ld	l,e		;h:=Sektorlcode, l:=Spur Rueckseite
  D987    D1             C      	pop	de		;wiederherstellen Vorderseite
  D988    20 05          C      	jr	nz,selss	;Fehler beim Lesen, SS
  D98A    B7             C      	or	a
  D98B    ED 52          C      	sbc	hl,de		;Vorder- gleich Rueckseite?
  D98D    28 04          C      	jr	z,sel48		;ja; 40 Tr/ 80 Tr unterscheiden
  D98F    DD CB 0F AE    C      selss:	res	dpbfds,(ix+dpbflg)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-63


                         C       ENDIF
                         C      
                         C      ; 40/80 Track Analyse
  D993    7B             C      sel48:	ld	a,e		;trk
  D994    D6 03          C      	sub	dlgint		;waren 2 Steps richtig? 
  D996    28 12          C      	jr	z,seldl1	;ja
  D998    DD 35 12       C      	dec	(ix+dpbstp)	;Einzelstep-Impulse
  D99B    D6 03          C      	sub	dlgint		;waere 1 Step richtig?
  D99D    28 0B          C      	jr	z,seldl1	;ja
                         C      				;nein, unsicher
  D99F    DD 36 10 FF    C      seldle:	ld	(ix+dpbslc),0ffh;provozieren 'BAD SECTOR'
  D9A3    21 0000        C      	ld	hl,0		;erzeugen 'SELECT' Error
  D9A6    E3             C      	ex	(sp),hl
  D9A7    C3 DAC1        C      	jp	selext
                         C      
                         C      ; DS/SS und 40/80 ist unterschieden, es fehlt Sektorlaenge
  D9AA    7A             C      seldl1:	ld	a,d
  D9AB    DD 77 10       C      	ld	(ix+dpbslc),a	;definieren Sektorlaengencode
                         C       IF	dbufsz le 7
                         C       ELSE
                         C      	IF	dbufsz lt 10	;Test, ob Disk-Puffer ausreicht
                         C      	ENDIF
  D9AE    B7             C      	or	a		;Sektorlaenge 128?
  D9AF    20 1B          C      	jr	nz,seldxl	;nein, normale Sektorfolge
                         C       ENDIF	;dbufsz gt 7
                         C       IF dsk8mf
  D9B1    DD CB 18 7E    C      	bit	dpbt52,(ix+dpbtyp)	;8" MFM?
  D9B5    28 06          C      	jr	z,seldsv	;nein
  D9B7    DD CB 0F 56    C      	bit	dpbffm,(ix+dpbflg)	;als MFM betreiben?
  D9BB    28 0F          C      	jr	z,seldxl	;ja, kein Sektorversatz
                         C       ENDIF
  D9BD                   C      seldsv:
                         C      ; Stellen Sektor-Translate-Tabelle 1,7,13,..
  D9BD    DD E5          C      	push	ix
  D9BF    E1             C      	pop	hl
  D9C0    01 0019        C      	ld	bc,dpbstr
  D9C3    09             C      	add	hl,bc
  D9C4    EB             C      	ex	de,hl
  D9C5    21 DEC8        C      	ld	hl,xlt
  D9C8    0E 1A          C      	ld	c,26
  D9CA    ED B0          C      	ldir
  D9CC                   C      seldxl:
                         C      
  D9CC    CD DE32        C      	call	dtrsla		;stellen hl entspr. Sektorlaenge
  D9CF    20 CE          C      	jr	nz,seldle	;unzulaessig
  D9D1    01 0005        C      	ld	bc,dsll		;Laenge eines Eintrags
                         C       IF disk8
  D9D4    DD CB 18 66    C      	bit	dpbt5z,(ix+dpbtyp)	;8"-LW?
  D9D8    20 13          C      	jr	nz,sel5zl	;nein
  D9DA    09             C      	add	hl,bc		;5" uebergehen
  D9DB    09             C      	add	hl,bc
  D9DC    09             C      	add	hl,bc
  D9DD    09             C      	add	hl,bc
                         C        IF dsk8mf
  D9DE    DD CB 18 5E    C      	bit	dpbtdd,(ix+dpbtyp)	;MFM-Laufwerk?
  D9E2    28 1F          C      	jr	z,selset	;nein
  D9E4    DD CB 0F 56    C      	bit	dpbffm,(ix+dpbflg) ;als FM zu betreiben?
  D9E8    20 19          C      	jr	nz,selset	;ja
  D9EA    09             C      	add	hl,bc		;sonst auf 8" MFM Muster
                         C        ENDIF
  D9EB    18 16          C      	jr	selset		;Format-Werte setzen
  D9ED                   C      sel5zl:
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-64


                         C       ENDIF
  D9ED    DD CB 12 4E    C      	bit	1,(ix+dpbstp)	;40 Tr. auf 80er LW?
  D9F1    20 08          C      	jr	nz,seld40	;ja
  D9F3    DD 7E 16       C      	ld	a,(ix+dpbptr)	;40er LW?
  D9F6    FE 29          C      	cp	40+1
  D9F8    38 01          C      	jr	c,seld40	;ja, 40 Tr. auf 40er LW
  D9FA    09             C      	add	hl,bc		;auf 80er Format stellen
  D9FB    DD CB 0F 6E    C      seld40:	bit	dpbfds,(ix+dpbflg)	;DS?
  D9FF    28 02          C      	jr	z,seldss	;nein
  DA01    09             C      	add	hl,bc		;auf DS Format
  DA02    09             C      	add	hl,bc
  DA03                   C      seldss:
  DA03                   C      selset:
                         C      ; DPB modifizieren entsprechend erkanntem Format
  DA03    4E             C      	ld	c,(hl)		;Zahl der benutzten Spuren
  DA04    DD 71 14       C      	ld	(ix+dpbtrk),c
  DA07    23             C      	inc	hl
  DA08    4E             C      	ld	c,(hl)		;Anzahl 128er Sektoren pro Spur
  DA09    DD 71 00       C      	ld	(ix+dpbspt),c
  DA0C    23             C      	inc	hl
  DA0D    4E             C      	ld	c,(hl)		;Anzahl der Dir-Eintraege -1
  DA0E    23             C      	inc	hl
  DA0F    7E             C      	ld	a,(hl)		;Anzahl der Systemspuren
  DA10    CB 3F          C      	srl	a		;feste Anzahl erzwungen?
  DA12    38 28          C      	jr	c,seldof	;ja
  DA14    DD CB 0D 7E    C      	bit	7,(ix+dpbofs)	;kann Spur 0 Directory sein?
  DA18    28 22          C      	jr	z,seldof	;nein, Standardanzahl setzen
  DA1A    DD 34 0D       C      	inc	(ix+dpbofs)	;evtl. leere Systemspur?
  DA1D    28 1C          C      	jr	z,seldo0	;nein, 0 Systemspuren
  DA1F    47             C      	ld	b,a		;retten Anzahl Systemspuren
  DA20    32 DF03        C      	ld	(dbtrk),a	;einlesen evtl. moeglicher Datenbeginn
  DA23    E5             C      	push	hl
  DA24    CD DCD2        C      	call	dbtran		; dauert bei falscher Spur etwas laenger
  DA27    E1             C      	pop	hl
  DA28    78             C      	ld	a,b
  DA29    20 11          C      	jr	nz,seldof	;Fehler, mit Systemspuren annehmen
  DA2B    FD E5          C      	push	iy
  DA2D    FD 2A DF08     C      	ld	iy,(dbdma)
  DA31    FD 7E 0E       C      	ld	a,(iy+14)	;falls dort Dir, so Byte 14 von Dir =0
  DA34    FE E5          C      	cp	0e5h		;Daten auch leer?
  DA36    FD E1          C      	pop	iy
  DA38    78             C      	ld	a,b
  DA39    20 01          C      	jr	nz,seldof	;nein, vorn liegen nichtbelegte Systemspuren
  DA3B    AF             C      seldo0:	xor	a		;sonst ohne Systemspuren
  DA3C    DD 77 0D       C      seldof:	ld	(ix+dpbofs),a
  DA3F    B7             C      	or	a		;0 Systemspuren?
  DA40    28 07          C      	jr	z,selddr	;ja
  DA42    79             C      	ld	a,c		;Anzahl Dir-Eintraege -1
  DA43    FE BF          C      	cp	192-1		;>=192 Dir-Eintraege ?
  DA45    38 02          C      	jr	c,selddr	;nein
  DA47    0E 7F          C      	ld	c,128-1		;780k hat 128 Dir-Eintraege
  DA49    DD 71 07       C      selddr:	ld	(ix+dpbdir),c
  DA4C    23             C      	inc	hl
  DA4D    4E             C      	ld	c,(hl)		;Abstand der Blockgroessentab.
  DA4E    06 00          C      	ld	b,0
  DA50    09             C      	add	hl,bc		;auf Blockgroessentabelle
  DA51    4E             C      	ld	c,(hl)
  DA52    DD 71 02       C      	ld	(ix+dpbbls),c
  DA55    23             C      	inc	hl
  DA56    4E             C      	ld	c,(hl)
  DA57    DD 71 03       C      	ld	(ix+dpbblm),c
  DA5A    23             C      	inc	hl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-65


  DA5B    4E             C      	ld	c,(hl)
  DA5C    DD 71 04       C      	ld	(ix+dpbexm),c
                         C      
                         C      ; Bestimmen Zahl der abweichenden 128er-Sektoren ab Spur 0
                         C      
  DA5F    AF             C      	xor	a
  DA60    32 DEFC        C      	ld	(dfrmtr),a	;ab Spur 0
                         C      		;(gleichz. Spurkorr. bei falschen Doppelstepimpulsen)
  DA63    CD DCE4        C      sf128z:	call	dsidtr		;beliebigen SektId lesen
  DA66    20 18          C      	jr	nz,sf128e	;Fehler
  DA68    7C             C      	ld	a,h		;Sektorlaenge
  DA69    DD BE 10       C      	cp	(ix+dpbslc)	;gleich Disketten-Rest?
  DA6C    28 12          C      	jr	z,sf128e	;ja
  DA6E    DD 7E 0F       C      	ld	a,(ix+dpbflg)
  DA71    E6 03          C      	and	dpbfsm		;bisherige Anzahl abweichender Spuren
  DA73    FE 03          C      	cp	dpbfsm		;Zaehler voll?
  DA75    28 09          C      	jr	z,sf128e	;ja
  DA77    DD 34 0F       C      	inc	(ix+dpbflg)	;erhoehen abweich. Spurzahl
  DA7A    21 DEFC        C      	ld	hl,dfrmtr	;naechste (logische!) Spur
  DA7D    34             C      	inc	(hl)
  DA7E    18 E3          C      	jr	sf128z
  DA80                   C      sf128e:
                         C      
                         C      ; Setzen Anzahl der logischen 128er Rekords im Puffer -1
                         C      ; Es wird immer das Maximum gesetzt, dies setzt eine dichte
                         C      ; Sektorfolge beim Transfer voraus! (so in dpbstr)
                         C      
                         C      	IF	dbufsz gt 7
  DA80    DD 36 11 07    C      	ld	(ix+dpbbfm),+(1 shl (dbufsz-7))-1
                         C      	ENDIF
                         C      
                         C      ; Berechnen Speicherkapazitaet-1 in BDOS-Bloecken aus
                         C      ; ((Tracks-dpbofs)*dpbspt/(2**dpbbls))-1
  DA84    DD 6E 14       C      	ld	l,(ix+dpbtrk)
  DA87    AF             C      	xor	a
  DA88    67             C      	ld	h,a		;hl:=log. Spurzahl
  DA89    DD 5E 0D       C      	ld	e,(ix+dpbofs)
  DA8C    57             C      	ld	d,a		;de:=log. offset-Spurzahl
  DA8D    ED 52          C      	sbc	hl,de
  DA8F    EB             C      	ex	de,hl		;de:=log. Daten-Spurzahl
  DA90    6F             C      	ld	l,a		;hl:=0
  DA91    DD 46 00       C      	ld	b,(ix+dpbspt)
  DA94    19             C      dsizmz:	add	hl,de
  DA95    10 FD          C      	djnz	dsizmz		;hl:=(tracks-dpbofs)*dpbspt
  DA97    DD 46 02       C      dsizme:	ld	b,(ix+dpbbls)
  DA9A    CB 3C          C      dsizdz:	srl	h
  DA9C    CB 1D          C      	rr	l
  DA9E    10 FA          C      	djnz	dsizdz
  DAA0    2B             C      	dec	hl
  DAA1    DD 75 05       C      	ld	(ix+dpbsiz),l
  DAA4    DD 74 06       C      	ld	(ix+dpbsiz+1),h
  DAA7    DD 7E 07       C      	ld	a,(ix+dpbdir)	;Dir-Groesse
  DAAA    3C             C      	inc	a
  DAAB    E6 FC          C      	and	0fch		;abrunden auf durch 4 teilbare Dir-Groesse
  DAAD    0F             C      	rrca
  DAAE    0F             C      	rrca			;div 4, da 4 Dir-Eintr. /Sekt.
  DAAF    DD 77 0B       C      	ld	(ix+dpbchk),a	;ist Sektorzahl = Check size
  DAB2    DD 46 02       C      	ld	b,(ix+dpbbls)	;block shift
  DAB5    0F             C      seldla:	rrca			;BDOS-Bloecke fuer Dir.
  DAB6    10 FD          C      	djnz	seldla
  DAB8    47             C      	ld	b,a
  DAB9    AF             C      	xor	a
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-66


  DABA    37             C      seldal:	scf			;Allocation-Bits fuer Dir.
  DABB    1F             C      	rra
  DABC    10 FC          C      	djnz	seldal
  DABE    DD 77 09       C      	ld	(ix+dpbalc),a
                         C      ;+++++++++++Ende automatische Formaterkennung+++++++++++++
                         C      	ENDIF	;format
                         C      
  DAC1                   C      selext:
                         C       IF cpastz
                         C      ; Anzeigen Diskformat als Speicherkapazitaet in kBytes
  DAC1    3A CF3D        C      	ld	a,(synflg)
  DAC4    CB 77          C      	bit	stzaus,a	;Anzeige in Statuszeile erlaubt?
  DAC6    20 49          C      	jr	nz,selexx	;nein
                         C      ; Ermitteln Stelle in Statuszeile
  DAC8    DD 7E 15       C      	ld	a,(ix+dpbdnr)
                         C        IF dev eq cpd
                         C        ELSE
  DACB    4F             C      	ld	c,a
  DACC    21 FF81        C      	ld	hl,statz2+statzk-stzkl
  DACD                   C      crtm40	equ	$-2
  DACF    11 0006        C      	ld	de,stzkl
  DAD2    3C             C      	inc	a
  DAD3    19             C      selexb:	add	hl,de
  DAD4    3D             C      	dec	a
  DAD5    20 FC          C      	jr	nz,selexb
  DAD7    22 DB17        C      	ld	(selex5),hl
                         C        ENDIF
                         C      
  DADA    79             C      	ld	a,c
  DADB    C6 30          C      	add	a,'0'
  DADD    CD DB16        C      	call	selex4
  DAE0    3E 3A          C      	ld	a,':'
  DAE2    DD CB 18 76    C      	bit	dpbtwv,(ix+dpbtyp)	;Verify nach Schreiben?
  DAE6    28 02          C      	jr	z,selexv	;nein
  DAE8    3E 76          C      	ld	a,'v'		;sonst durch 'v' kennzeichnen
  DAEA    CD DB16        C      selexv:	call	selex4
                         C      
                         C      ; (dpbsiz+1)*(2**(dpbbls-3))
  DAED    DD 6E 05       C      	ld	l,(ix+dpbsiz)
  DAF0    DD 66 06       C      	ld	h,(ix+dpbsiz+1)
  DAF3    23             C      	inc	hl
  DAF4    DD 7E 02       C      	ld	a,(ix+dpbbls)
  DAF7    D6 03          C      	sub	3
  DAF9    28 04          C      	jr	z,selex1
  DAFB    29             C      selex2:	add	hl,hl
  DAFC    3D             C      	dec	a
  DAFD    20 FC          C      	jr	nz,selex2
  DAFF    11 FF9C        C      selex1:	ld	de,-100		;immer dreistellig
  DB02    CD DB13        C      	call	selex3
  DB05    11 FFF6        C      	ld	de,-10
  DB08    CD DB13        C      	call	selex3
  DB0B    7D             C      	ld	a,l
  DB0C    F6 30          C      	or	'0'
  DB0E    CD DB16        C      	call	selex4
                         C       ENDIF
                         C      
  DB11    E1             C      selexx:	pop	hl		;hl auf DPH
  DB12    C9             C      	ret			;Return Seldsk
                         C      
                         C       IF cpastz
                         C        IF dev eq cpd
                         C        ELSE
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-67


  DB13    CD E7AF        C      selex3:	call	mhldig		;10er Ziffer nach A
  DB16    11 0000        C      selex4:	ld	de,0
  DB17                   C      selex5	equ	$-2		;Zeiger in Statuszeile
                         C      	setbs
  DB19    12             C      	ld	(de),a		;ablegen in Statuszeile
                         C      	setram
  DB1A    13             C      	inc	de
  DB1B    ED 53 DB17     C      	ld	(selex5),de
  DB1F    C9             C      	ret
                         C        ENDIF
                         C       ENDIF
                         C      
                         C      
                         C      ; auf Spur 0 zurueck (vor jedem Dir-Zugriff)
                         C      ;===================
  DB20                   C      home:
                         C      	IF	dbufsz gt 7
  DB20    21 DF01        C      	ld	hl,dbflg
  DB23    CB 56          C      	bit	dfbwr,(hl)	;veraenderter Puffer?
  DB25    20 05          C      	jr	nz,home1	;ja, nicht freigeben
  DB27    3E FF          C      	ld	a,0ffh		;sonst Diskwechsel erlauben
  DB29    32 DF02        C      	ld	(dbdev),a	;Puffer ist nicht aktiv
                         C      	ENDIF
  DB2C    01 0000        C      home1:	ld	bc,0
                         C      ;-----------------------
                         C      
                         C      ; Einstellen Spur in Reg. BC
                         C      ;================
  DB2F                   C      settrk:
  DB2F    ED 43 DF0C     C      	ld	(dtrack),bc	;Spur merken
  DB33    C9             C      	ret
                         C      ;-----------------------
                         C      
                         C      ; Einstellen Sektor in Reg. C
                         C      ;==================
  DB34    79             C      setsec:	LD	A,C
  DB35    32 DF0E        C      	LD	(dsectr),A
  DB38    C9             C      	RET
                         C      ;-----------------------
                         C      
                         C      ; Einstellen DMA in Reg. BC
                         C      ;===============
  DB39    ED 43 DF11     C      setdma:	LD	(ddma),BC
  DB3D    C9             C      	RET
                         C      ;-----------------------
                         C      
                         C      ; Uebersetzung Sektornummer 
                         C      ;==========================
                         C      ; Translate-Tab-Adr. in DE, Eingangs-Sektornummer in BC,
                         C      ;			    Ausgangs-Sektornummer in HL
                         C      ; Es wird keine Translate-Tabelle benutzt, da die Sektor-
                         C      ; nummernverwaltung verallgemeinert im nicht-Standard-DPB 
                         C      ; enthalten ist (auch fuer physische Sektorlaenge <>128)
                         C      
  DB3E                   C      sectran:
  DB3E    60             C      	LD	H,B
  DB3F    69             C      	LD	L,C
  DB40    23             C      	inc	hl		;Sektoren zaehlen in CP/A ab 1
  DB41    C9             C      	RET
                         C      ;-----------------------
                         C      
                         C      ; Schreiben Sektor
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-68


                         C      ;=================
                         C      ; Register C (vom BDOS gestellt):
                         C      ;	=0, wenn normales write
                         C      ;	=1, wenn directory-write (sofort ausgeben)
                         C      ;	=2, wenn Beginn eines neuen Datenblocks (kein preread)
                         C      
  DB42                   C      write:
                         C       IF @write
  DB42    59             C      	ld	e,c		;retten Reg. C
  DB43    3A DF0B        C      	ld	a,(ddrive)
  DB46    4F             C      	ld	c,a
  DB47    CD E871        C      	call	dgetpb		;ix:=dpb(ddrive)
  DB4A    28 6B          C      	jr	z,drwerr	;Geraet ex. nicht
                         C       if ramfl
                         C      ;###RAM-Floppy
  DB4C    DD CB 0F 7E    C      	bit	dpbfnd,(ix+dpbflg)	;Diskette?
  DB50    C2 E47B        C      	jp	nz,wrramf	;nein
                         C      ;###
                         C       endif
  DB53    21 DF0A        C      	ld	hl,dflg
  DB56    CB D6          C      	set	dfwr,(hl)	;Write-Flag setzen
                         C      
                         C      	IF	dbufsz gt 7	;gepufferte Disk E/A
  DB58    21 DF01        C      	ld	hl,dbflg
  DB5B    CB C6          C      	set	dfbprr,(hl)	;Annahme preread notwendig
  DB5D    7B             C      	ld	a,e		;A:= Write-Typ
  DB5E    32 DF19        C      	ld	(dwrtyp),a	;merken Write-Typ
  DB61    FE 02          C      	cp	2		;write to unallocated?
  DB63    20 17          C      	jr	nz,chkuna	;nein
  DB65    DD 7E 03       C      	ld	a,(ix+dpbblm)	;Zahl der 128-Sekt. im Block -1
  DB68    3C             C      	inc	a
  DB69    32 DF13        C      	ld	(unacnt),a	;fuer diese Sekt. kein preread
  DB6C    21 DF14        C      	ld	hl,unadev
  DB6F    71             C      	ld	(hl),c
  DB70    2A DF0C        C      	ld	hl,(dtrack)
  DB73    22 DF15        C      	ld	(unatrk),hl
  DB76    3A DF0E        C      	ld	a,(dsectr)
  DB79    32 DF17        C      	ld	(unasec),a
  DB7C    21 DF13        C      chkuna:	ld	hl,unacnt
  DB7F    7E             C      	ld	a,(hl)
  DB80    B7             C      	or	a		;noch nicht geschr. Sekt. da?
  DB81    28 56          C      	jr	z,alloc		;nein
  DB83    3D             C      	dec	a		;sonst Restzahl -1
  DB84    77             C      	ld	(hl),a
  DB85    23             C      	inc	hl
  DB86    79             C      	ld	a,c
  DB87    BE             C      	cp	(hl)		;gleiches Geraet?
  DB88    20 4F          C      	jr	nz,alloc	;nein
  DB8A    23             C      	inc	hl
  DB8B    3A DF0C        C      	ld	a,(dtrack)
  DB8E    BE             C      	cp	(hl)		;gleiche Spur?
  DB8F    20 48          C      	jr	nz,alloc	;nein
  DB91    23             C      	inc	hl
  DB92    3A DF0D        C      	ld	a,(dtrack+1)
  DB95    BE             C      	cp	(hl)
  DB96    20 41          C      	jr	nz,alloc
  DB98    23             C      	inc	hl
  DB99    3A DF0E        C      	ld	a,(dsectr)
  DB9C    BE             C      	cp	(hl)		;gleicher Sektor?
  DB9D    20 3A          C      	jr	nz,alloc	;nein
                         C      ; Vorbereiten naechsten unalloc write-Aufruf
  DB9F    DD BE 00       C      	cp	(ix+dpbspt)	;neue Spur?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-69


  DBA2    38 0A          C      	jr	c,unatr1	;nein
  DBA4    2B             C      	dec	hl
  DBA5    56             C      	ld	d,(hl)
  DBA6    2B             C      	dec	hl
  DBA7    5E             C      	ld	e,(hl)
  DBA8    13             C      	inc	de		;unatrk +1
  DBA9    73             C      	ld	(hl),e
  DBAA    23             C      	inc	hl
  DBAB    72             C      	ld	(hl),d
  DBAC    23             C      	inc	hl
  DBAD    AF             C      	xor	a		;Sektor auf Spuranfang
  DBAE    3C             C      unatr1:	inc	a		;naechster Sektor
  DBAF    77             C      	ld	(hl),a
  DBB0    21 DF01        C      	ld	hl,dbflg
  DBB3    CB 86          C      	res	dfbprr,(hl)	;anzeigen kein preread notw.
                         C      	ENDIF
  DBB5    18 26          C      	jr	drw
                         C      
                         C       ENDIF ;@write
                         C      
                         C      ; Abbruch read/write mit E/A-Fehler
  DBB7    3E 01          C      drwerr:	ld	a,1
  DBB9    C9             C      	ret
                         C      
                         C      ; Lesen Sektor
                         C      ;=============
                         C      
  DBBA                   C      read:
  DBBA    3A DF0B        C      	ld	a,(ddrive)
  DBBD    4F             C      	ld	c,a
  DBBE    CD E871        C      	call	dgetpb		;ix:=dpb(ddrive)
  DBC1    28 F4          C      	jr	z,drwerr	;Geraet ex. nicht
                         C       if ramfl
                         C      ;###RAM-Floppy
  DBC3    DD CB 0F 7E    C      	bit	dpbfnd,(ix+dpbflg)	;Diskette?
  DBC7    C2 E49E        C      	jp	nz,rdramf	;nein
                         C      ;###
                         C       endif
  DBCA    21 DF0A        C      	ld	hl,dflg
  DBCD    CB 96          C      	res	dfwr,(hl)	;Lesen anzeigen
                         C      
                         C       IF dbufsz gt 7
  DBCF    21 DF01        C      	ld	hl,dbflg
  DBD2    CB C6          C      	set	dfbprr,(hl)	;preread notwendig
  DBD4    3E 02          C      	ld	a,2
  DBD6    32 DF19        C      	ld	(dwrtyp),a
                         C      
  DBD9                   C      alloc:
                         C        IF @write
  DBD9    AF             C      	xor	a
  DBDA    32 DF13        C      	ld	(unacnt),a	;Ende unalloc
                         C        ENDIF
                         C      
                         C       ENDIF
                         C      
                         C      ; gemeinsamer Zweig read/write Floppy
                         C      ;------------------------------------
                         C      
  DBDD    3A DF0E        C      drw:	ld	a,(dsectr)	;Sektornummer in 1..dpbspt ?
  DBE0    3D             C      	dec	a		;ab 0 zaehlen
  DBE1    FA DBB7        C      	jp	m,drwerr	;<0, Fehler
  DBE4    DD BE 00       C      	cp	(ix+dpbspt)	;<dpbspt?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-70


  DBE7    30 CE          C      	jr	nc,drwerr	;nein, Fehler
                         C       IF dbufsz gt 7
  DBE9    47             C      	ld	b,a		;retten dsectr-1
                         C       ENDIF
  DBEA    DD 7E 0F       C      	ld	a,(ix+dpbflg)
  DBED    E6 03          C      	and	dpbfsm		;Anzahl der abweich. 128er Spuren
  DBEF    5F             C      	ld	e,a
  DBF0    16 00          C      	ld	d,0
  DBF2    2A DF0C        C      	ld	hl,(dtrack)	;verlangte Spur
  DBF5    B7             C      	or	a
  DBF6    ED 52          C      	sbc	hl,de		;im abweichenden Spurformat?
  DBF8    DA DCFC        C      	jp	c,drwsec	;ja, Sektorlaenge 128
                         C      
                         C       IF dbufsz gt 7	;gepufferte Disk E/A
                         C       IF dbufsz lt 12 ;<2**12 =4K Puffer
  DBFB    DD 7E 10       C      	ld	a,(ix+dpbslc)	;phys. Sektorlaenge 128?
  DBFE    B7             C      	or	a		;d.h. mit Sektorversatz?
  DBFF    CA DCFC        C      	jp	z,drwsec	;ja, keine Pufferung sinnvoll
                         C       ENDIF
  DC02    78             C      	ld	a,b
  DC03    DD 56 11       C      	ld	d,(ix+dpbbfm)	;Puffermaske
  DC06    A2             C      	and	d		;rel. Sekt.nr. des BDOS-Blocks zum Puff.anf.
  DC07    F5             C      	push	af		;merken fuer move
  DC08    A8             C      	xor	b		;a ist Sektornr. des Puff.anf.
  DC09    CB 3F          C      drwbnr:	srl	a		;ermitteln Puffernr in Spur
  DC0B    CB 1A          C      	rr	d		;noch Bits in Puffermaske?
  DC0D    20 FA          C      	jr	nz,drwbnr	;ja
                         C      ; Test, ob dieser Puffer da ist
  DC0F    F5             C      	push	af		;merken Puffernummer
  DC10    21 DF18        C      	ld	hl,dbnb
  DC13    BE             C      	cp	(hl)		;richtige Puffernummer?
  DC14    20 12          C      	jr	nz,dbn		;nein
  DC16    2A DF0C        C      	ld	hl,(dtrack)	;geforderte Spur
  DC19    ED 5B DF03     C      	ld	de,(dbtrk)
  DC1D    B7             C      	or	a
  DC1E    ED 52          C      	sbc	hl,de		;richtige Spur?
  DC20    20 06          C      	jr	nz,dbn
  DC22    3A DF02        C      	ld	a,(dbdev)	;zum Puffer gehoeriges Geraet
  DC25    B9             C      	cp	c		;richtiges Geraet?
  DC26    28 6C          C      	jr	z,dbmat		;ja, Sektor steht im Puffer
                         C      
  DC28    C5             C      dbn:	push	bc		;retten ddrive
  DC29    CD DCCC        C      	call	dbtrw		;veraenderten Puffer ausgeben
  DC2C    C1             C      	pop	bc		;c:=ddrive
  DC2D    21 DF02        C      	ld	hl,dbdev
  DC30    71             C      	ld	(hl),c
  DC31    2A DF0C        C      	ld	hl,(dtrack)
  DC34    22 DF03        C      	ld	(dbtrk),hl
  DC37    CD E871        C      	call	dgetpb		;ix:=dpb(c)
  DC3A    DD 46 10       C      	ld	b,(ix+dpbslc)
  DC3D    21 DF06        C      	ld	hl,dbslc
  DC40    70             C      	ld	(hl),b
  DC41    DD 7E 11       C      	ld	a,(ix+dpbbfm)	;Zahl der 128er Sektoren -1
  DC44    3C             C      	inc	a
  DC45    87             C      	add	a,a		;CY:=0
  DC46    04             C      	inc	b		;fuer djnz, falls dpbslc=0
  DC47    0F             C      dbsnbz:	rrca			;Zahl der phys. Sekt. im Puff.
  DC48    10 FD          C      	djnz	dbsnbz
  DC4A    57             C      	ld	d,a		;merken
  DC4B    AF             C      	xor	a
  DC4C    C1             C      	pop	bc		;b:=geforderte Puffernr.
  DC4D    C5             C      	push	bc
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-71


  DC4E    21 DF18        C      	ld	hl,dbnb
  DC51    70             C      	ld	(hl),b
  DC52    04             C      	inc	b
  DC53    05             C      	dec	b		;Puffernr. 0?
  DC54    28 03          C      	jr	z,dbsec0	;ja
  DC56    82             C      dbsecz:	add	a,d		;0. phys. Sekt. im Puffer
  DC57    10 FD          C      	djnz	dbsecz		;=dbsnb.*Puffernr.
  DC59    5F             C      dbsec0:	ld	e,a		;merken Pufferanf.-Sektor
  DC5A    DD 46 10       C      	ld	b,(ix+dpbslc)
  DC5D    DD 7E 00       C      	ld	a,(ix+dpbspt)
  DC60    04             C      	inc	b		;wegen djnz
  DC61    87             C      	add	a,a
  DC62    CB 3F          C      dbsecm:	srl	a		;phys. Sektoranzahl
  DC64    10 FC          C      	djnz	dbsecm
  DC66    93             C      	sub	e		;Restsektorzahl auf Spur
  DC67    BA             C      	cp	d		;>= Zahl zu transferierender?
  DC68    30 01          C      	jr	nc,dbseco	;ja
  DC6A    57             C      	ld	d,a		;sonst nur Restsektorzahl
  DC6B    1C             C      dbseco:	inc	e		;Sektoren zaehlen ab 1
  DC6C    7B             C      	ld	a,e
  DC6D    32 DF05        C      	ld	(dbsec),a	;Sektor
  DC70    7A             C      	ld	a,d
  DC71    32 DF07        C      	ld	(dbsnb),a	;Sektorzahl
  DC74    21 DF01        C      	ld	hl,dbflg
  DC77    CB 96          C      	res	dfbwr,(hl)
                         C       if @write
  DC79    CB 46          C      	bit	dfbprr,(hl)	;muss neuer Puffer gel. werden?
  DC7B    20 14          C      	jr	nz,dbprr	;ja
                         C      ; nur dann kein preread, wenn Rest BDOS-Block >= phys. Puff.
                         C      ; und Rest BDOS-Block auf Pufferanfang beginnt
  DC7D    3A DF13        C      	ld	a,(unacnt)
  DC80    DD BE 11       C      	cp	(ix+dpbbfm)	;Restzahl-1 >= Puffergr.-1 ?
  DC83    38 0C          C      	jr	c,dbprr		;nein, preread
  DC85    3A DF0E        C      	ld	a,(dsectr)	;Sektornr.
  DC88    3D             C      	dec	a		;ab 0 zaehlen
  DC89    DD A6 11       C      	and	(ix+dpbbfm)	;rel. Sekt.nr. des
                         C      ;				BDOS-Blocks zum Pufferanfang
  DC8C    20 03          C      	jr	nz,dbprr
  DC8E    32 DF1A        C      	ld	(dberrf),a	;fehlerfrei gel. anzeigen
  DC91    C4 DCD2        C      dbprr:	call	nz,dbtran	;Puffer lesen
                         C       endif
  DC94                   C      dbmat:	
                         C      
                         C      ; Sektor in/aus Puffer holen
                         C      ;===========================
  DC94    F1             C      	pop	af		;Puffernr. in Spur wegschm.
  DC95    F1             C      	pop	af		;128-er Index im Puffer
  DC96    F5             C      	push	af
  DC97    1F             C      	rra			;Sektornb*128 berechnen
  DC98    47             C      	ld	b,a
  DC99    0E 00          C      	ld	c,0
  DC9B    CB 19          C      	rr	c
  DC9D    21 F339        C      	ld	hl,dbuf
  DCA0    09             C      	add	hl,bc		;Adresse im Puffer
  DCA1    ED 5B DF11     C      	ld	de,(ddma)	;Nutzer-DMA
  DCA5    3A DF0A        C      	ld	a,(dflg)
  DCA8    CB 57          C      	bit	dfwr,a		;Schreiben?
  DCAA    28 09          C      	jr	z,dsmove	;nein
  DCAC    3A DF01        C      	ld	a,(dbflg)
  DCAF    CB D7          C      	set	dfbwr,a		;anzeigen Puffer beschrieben
  DCB1    32 DF01        C      	ld	(dbflg),a
  DCB4    EB             C      	ex	de,hl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-72


  DCB5    01 0080        C      dsmove:	ld	bc,128
                         C       IF dev eq cpd
                         C       ELSE
  DCB8    ED B0          C      	ldir
                         C       ENDIF
  DCBA    F1             C      	pop	af		;128-Index im Puffer
  DCBB    DD BE 11       C      	cp	(ix+dpbbfm)	;letzter Sektor im Puffer
  DCBE    28 05          C      	jr	z,dmovew	;ja, Puffer ausgeben
  DCC0    3A DF19        C      	ld	a,(dwrtyp)
  DCC3    FE 01          C      	cp	1		;write to directory?
  DCC5    CC DCCC        C      dmovew:	call	z,dbtrw		;ja, veraend. Puffer ausgeben
  DCC8    3A DF1A        C      	ld	a,(dberrf)	;Ergebnis letztes dbtran
  DCCB    C9             C      	ret
                         C      
                         C      ; Schreiben Puffer, wenn notw.
                         C      ;=============================
  DCCC    21 DF01        C      dbtrw:	ld	hl,dbflg
  DCCF    CB 56          C      	bit	dfbwr,(hl)	;Puffer veraendert?
  DCD1    C8             C      	ret	z		;nein, Schreiben unterdruecken
                         C      	ENDIF	;dbufsz gt 7
                         C      
                         C      	IF	format or (dbufsz gt 7)
                         C      ; gemeinsamer Zweig Lesen/Schreiben Puffer
                         C      ;=========================================
  DCD2                   C      dbtran:	
  DCD2    21 DF01        C      	ld	hl,dbcdb
                         C      	IF	dbufsz gt 7
  DCD5    CD DCFF        C      	call	dsktra
  DCD8    32 DF1A        C      	ld	(dberrf),a	;Fehlerflag stellen
  DCDB    21 DF01        C      	ld	hl,dbflg
  DCDE    CB 96          C      	res	dfbwr,(hl)	;Puffer ist nicht beschrieben
  DCE0    C9             C      	ret
                         C      	ENDIF
                         C      
                         C      	ENDIF
                         C      
                         C      	IF	format
                         C      ; Lesen beliebigen Sektor-Id.
                         C      ;===========================
  DCE1    32 DEFC        C      dsidtt:	ld	(dfrmtr),a	;Eingang fuer Spur in A
  DCE4                   C      dsidtr:
  DCE4    21 DEFA        C      	ld	hl,dfrcdb
                         C       IF dsk8mf
  DCE7    CB 9E          C      	res	dioffm,(hl)	;nicht temporaer umschalten
  DCE9    CD DCFF        C      	call	dsktra		;beliebigen Sektorid lesen
  DCEC    C8             C      	ret	z		;ok
  DCED    DD 7E 18       C      	ld	a,(ix+dpbtyp)
  DCF0    E6 18          C      	and	(1 shl dpbt5z)+(1 shl dpbtdd)	;8"/5" und FM/MFM
  DCF2    EE 08          C      	xor	1 shl dpbtdd	;8" MFM ?
  DCF4    C0             C      	ret	nz		;nein, Fehler
  DCF5    21 DEFA        C      	ld	hl,dfrcdb
  DCF8    CB DE          C      	set	dioffm,(hl)	;temporaer auf FM umschalten
                         C       ENDIF
  DCFA    18 03          C      	jr	dsktra		;belieb. SektId lesen
                         C      	ENDIF
                         C      
                         C      
                         C      ; gemeinsamer Zweig Read/Write 128-Sektor einzeln
                         C      ;================================================
  DCFC                   C      drwsec:
  DCFC    21 DF0A        C      	ld	hl,dcdb
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-73


                         C      ; interner Aufruf phys. Diskettentransfer
                         C      ;----------------------------------------
                         C      ; i HL auf CDB
  DCFF                   C      dsktra:
                         C       IF dev eq cpd
                         C       ENDIF
                         C      
                         C      ;*********************************************************
                         C      ; Umkleidung des physischer Disketten-Transfers
                         C      ;*********************************************************
                         C      
                         C      ; Parameter: HL auf CDB mit folgender Struktur:
                         C      ; +0: cdbfl	;Flags	(Struktur angepasst an ft.kom)
  0000                   C      diof00	equ	0	;** frei fuer Anw. ** (frueher Verify nach Schreiben)
  0001                   C      diofid	equ	1	;fest	;=1, wenn nur Sektid. zu lesen
  0002                   C      diofwr	equ	2	;fest	;=1, wenn Schreiben
  0003                   C      dioffm	equ	3	;fest	;=1, wenn temporaer FM-Format erzwungen
  0004                   C      dioftr	equ	4		;=1, wenn keine Fehlermeldung (und -behandlg)
  0005                   C      diofhd	equ	5		;=1, wenn Kopf hochnehmen ("headup")
  0006                   C      diofps	equ	6		;=1, wenn trk,sid,sec schon physisch
  0007                   C      diofs1	equ	7	;fest	;=1, wenn Rueckseite
                         C      
                         C      ; ab hier unwichtig bei "diofhd" in cdbfl =1 (headup)
                         C      ; +1: cdbdev	;logisches Geraet 0 .. dphnb-1
                         C      ; +2: cdbtrk	;log./phys. Spur
                         C      ; +3: cdbsid	;bel./phys. Seite
                         C      ; +4: cdbsec	;log./phys. Sektor
                         C      ; +5: cdbslc	;Sektorlaengencode (0=128, 1=256, 2=512, 3=1024)
                         C      ; +6: cdbsnb	;Anz. zu uebertr. ph. Sekt. (wenn =0, so nur position.)
                         C      ; ab hier nur wichtig, wenn "diofid" in cdbfl =0:
                         C      ; +7,8: cdbdma	;Transferadresse
                         C      
                         C      ; Return, falls nicht "diofhd" in cdbfl =1:
                         C      ;	A=0 (ret z) bei fehlerfrei, sonst A=1 (ret nz) bei cdbfl, "dioftr" =0
                         C      ;	oder Returncode phys. Transfer
                         C      ;	E:=trk, D:=sid ,L:=sec, H:=len
                         C      ;	BC,IX unveraendert
                         C      
  DCFF                   C      diskio:	;Aufruf ueber Sprungvektor von BIOS-Erweiterung
  DCFF    C5             C      	push	bc
  DD00    11 DF1B        C      	ld	de,diocdb	;CDB des Nutzers auf internen Hilfsspeicher
  DD03    01 0009        C      	ld	bc,diocdl	;da modifiziert
  DD06    D5             C       	push	de
                         C       IF dev eq cpd
                         C       ELSE
  DD07    ED B0          C      	ldir
                         C       ENDIF
  DD09    E1             C      diskii:	pop	hl		;hl auf diocdb
  DD0A    C1             C      	pop	bc
                         C      
  DD0B    CB 6E          C      	bit	diofhd,(hl)	;Kopf hochnehmen?
                         C       IF disknb ne 0
  DD0D    C2 E1F8        C      	jp	nz,headup	;ja, kein Transfer
                         C       ENDIF
  DD10    C5             C      	push	bc
  DD11    DD E5          C      	push	ix
  DD13    E5             C      	push	hl
  DD14    23             C       	inc	hl
  DD15    4E             C      	ld	c,(hl)		;logisches Laufwerk
  DD16    CD E871        C      	call	dgetpb		;IX auf DPB stellen
  DD19    E1             C      	pop	hl		;wiederherstellen hl
  DD1A    3E 44          C      	ld	a,'D'		;falls LW nicht ex.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-74


  DD1C    CA DDEF        C      	jp	z,dioert	;LW ex. nicht
                         C      
                         C       IF hdsk
                         C       ENDIF
  DD1F    CB 76          C      	bit	diofps,(hl)	;trk,sid,sec schon physisch?
  DD21    20 6E          C      	jr	nz,diophy	;ja
                         C       IF dsk8mf
  DD23    DD CB 18 7E    C      	bit	dpbt52,(ix+dpbtyp)	;8" MFM?
  DD27    28 0E          C      	jr	z,drwnsp	;nein
  DD29    DD 7E 0F       C      	ld	a,(ix+dpbflg)
  DD2C    E6 03          C      	and	dpbfsm		;Zahl der abweichenden 128er Sektoren
  DD2E    57             C      	ld	d,a
  DD2F    3A DF1D        C      	ld	a,(dioctr)	;verlangte Spur
  DD32    BA             C      	cp	d		;im abweichenden Format?
  DD33    30 02          C      	jr	nc,drwnsp	;nein
  DD35    CB DE          C      	set	dioffm,(hl)	;sonst temporaer FM erzwingen
  DD37                   C      drwnsp:
                         C       ENDIF
                         C      ; Track, Side und Sector entpsr. Diskettenformat setzen
  DD37    23             C      	inc	hl
  DD38    23             C      	inc	hl
  DD39    56             C      	ld	d,(hl)		;Track
  DD3A    5A             C      	ld	e,d		;merken
  DD3B    23             C      	inc	hl
  DD3C    23             C      	inc	hl
  DD3D    4E             C      	ld	c,(hl)		;Sektornummer ab 1
  DD3E    0D             C      	dec	c		;Sektornr. ab 0
  DD3F    DD CB 0F 66    C      	bit	dpbf86,(ix+dpbflg)	;Fortsetzung Dsk. auf Ruecks.?
  DD43    20 0C          C      	jr	nz,diots2	;ja
  DD45    DD CB 0F 6E    C      	bit	dpbfds,(ix+dpbflg)	;ungerade Spuren auf Rueckseite?
  DD49    28 29          C      	jr	z,diotrs	;nein, einseitig
  DD4B    CB 3A          C      	srl	d		;Spur halbieren
  DD4D    30 25          C      	jr	nc,diotrs	;gerade Spur, Vorderseite
  DD4F    18 12          C      	jr	diots1		;auf Rueckseite
  DD51    DD 46 14       C      diots2:	ld	b,(ix+dpbtrk)	;log. Spurzahl
  DD54    CB 38          C      	srl	b		;Spuren auf Vorderseite
  DD56    7A             C      	ld	a,d
  DD57    90             C      	sub	b		;Spur auf Vorderseite?
  DD58    38 1A          C      	jr	c,diotrs	;ja, Spur in d unveraendert lassen
                         C      				;40 ->  0; 41 ->  1; ...; 79 ->  39
                         C      				;77 ->  0; 78 ->  1; ...;153 ->  76
  DD5A    DD CB 0F 5E    C      	bit	dpbfsv,(ix+dpbflg)	;Ruecks. von aussen nach innen?
  DD5E    20 02          C      	jr	nz,diots4	;ja
  DD60    2F             C      	cpl			;40 -> -1; 41 -> -2; ...; 79 -> -40
                         C      				;77 -> -1; 78 -> -2; ...;153 -> -77
  DD61    80             C      	add	a,b		;40 -> 39; 41 -> 38; ...; 79 ->   0
                         C      				;77 -> 76; 78 -> 75; ...;153 ->   0
  DD62    57             C      diots4:	ld	d,a
  DD63    3A DF1B        C      diots1:	ld	a,(diocfl)
  DD66    CB FF          C      	set	diofs1,a	;vermerken Rueckseite
  DD68    32 DF1B        C      	ld	(diocfl),a
  DD6B    DD 7E 13       C      	ld	a,(ix+dpbsn0)	;Versch. der Sektornr. auf Rueckseite
  DD6E    81             C      	add	a,c		;Sektornr. evtl. weiterzaehlen
                         C      ;;;	cp	c		;Weiternummerierung auf Rueckseite?
  DD6F    4F             C      	ld	c,a
                         C      ;;;	jr	nz,diotrs	;ja, dann side:=0
  DD70    3E 01          C      	ld	a,1		;side:=1
  DD72    18 01          C      	jr	diotss
  DD74    AF             C      diotrs:	xor	a		;side:=0
  DD75    32 DF1E        C      diotss:	ld	(diocsi),a	;phys. Seite setzen
  DD78    7A             C      	ld	a,d
  DD79    32 DF1D        C      	ld	(dioctr),a	;phys. Spur setzen
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-75


                         C      
  DD7C    7B             C      	ld	a,e		;log. Spurnr. zurueck nach A
  DD7D    DD E5          C      	push	ix
  DD7F    E1             C      	pop	hl
  DD80    11 0019        C      	ld	de,dpbstr	;d:=0
  DD83    19             C      	add	hl,de
  DD84    DD BE 0D       C      	cp	(ix+dpbofs)	;Systemspur?
  DD87    38 03          C      	jr	c,diossp	;ja, Sektornummern nicht logisch
  DD89    59             C      	ld	e,c
  DD8A    19             C      	add	hl,de		;HL entspr. Index in dpbstr
  DD8B    4A             C      	ld	c,d		;c:=0
  DD8C    79             C      diossp:	ld	a,c		;phys. Sektornr. ab 0
  DD8D    86             C      	add	a,(hl)		;+echte Sektornr.
  DD8E    32 DF1F        C      	ld	(diocse),a	;phys. Sektor setzen
  DD91                   C      diophy:
                         C      
                         C      ; i ret, BC, IX im Stack
                         C      ; i cdb auf diocdb
                         C      ; i IX auf DPB
                         C      
  DD91                   C      diorty:	;interne Wiederholung diskio
  DD91    DD E5          C      	push	ix		;retten IX fuer evtl. Wiederholung
  DD93    21 DF1B        C      	ld	hl,diocdb
  DD96    E5             C      	push	hl
  DD97    7E             C      	ld	a,(hl)		;side 0/1, -/FM, read/write, -/sectid l.
  DD98    E6 8E          C       and (1 shl diofs1)+(1 shl dioffm)+(1 shl diofwr)+(1 shl diofid)
  DD9A    47             C      	ld	b,a
  DD9B    DD 7E 18       C      	ld	a,(ix+dpbtyp)	;5"/8", FM/MFM, 40/80, Verify nach Schreiben
  DD9E    E6 78          C       and (1 shl dpbt80)+(1 shl dpbt5z)+(1 shl dpbtdd)+(1 shl dpbtwv) ;aus DPB
  DDA0    A8             C      	xor	b
                         C       IF dsk8mf
  DDA1    DD CB 0F 56    C      	bit	dpbffm,(ix+dpbflg)	;Diskette permanent FM?
  DDA5    28 02          C      	jr	z,dionfm	;nein
  DDA7    CB 9F          C      	res	dpbtdd,a		;erzwingen FM-Format
  DDA9                   C      dionfm:
                         C       ENDIF
  DDA9    CB 66          C      	bit	dioftr,(hl)	;Fehlerbehandlung unterdruecken?
  DDAB    28 01          C      	jr	z,dionft	;nein
  DDAD    3C             C      	inc	a
  DDAE                   C      dionft:
  DDAE    32 E215        C      	ld	(ft.kom),a	
                         C      
  DDB1    23             C      	inc	hl
  DDB2    DD 7E 15       C      	ld	a,(ix+dpbdnr)	;physische LW-Nr.
  DDB5    32 E218        C      	ld	(ft.lwn),a
                         C      
  DDB8    23             C      	inc	hl
  DDB9    7E             C      	ld	a,(hl)
  DDBA    32 E219        C      	ld	(ft.trk),a
  DDBD    23             C      	inc	hl
  DDBE    7E             C      	ld	a,(hl)
  DDBF    32 E21A        C      	ld	(ft.sid),a
  DDC2    23             C      	inc	hl
  DDC3    7E             C      	ld	a,(hl)
  DDC4    32 E21B        C      	ld	(ft.sec),a
  DDC7    23             C      	inc	hl
  DDC8    7E             C      	ld	a,(hl)
  DDC9    32 E21C        C      	ld	(ft.len),a
  DDCC    23             C      	inc	hl
  DDCD    7E             C      	ld	a,(hl)
  DDCE    32 E21D        C      	ld	(ft.anz),a
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-76


  DDD1    DD 7E 12       C      	ld	a,(ix+dpbstp)	;Anzahl der Stepimpulse
  DDD4    32 E21E        C      	ld	(ft.stp),a
                         C      
  DDD7    DD 7E 17       C      	ld	a,(ix+dpbsti)	;Schrittzeit
  DDDA    32 E21F        C      	ld	(ft.sti),a
                         C      
  DDDD    2A DF22        C      	ld	hl,(diocad)
  DDE0    22 E216        C      	ld	(ft.adr),hl
                         C      
                         C       IF stpvar or monitor
  DDE3    CD E69B        C      	call	delsps		;Sondertasten verbieten
                         C       ENDIF
                         C       IF hdsk
                         C       ELSE
  DDE6    CD DF24        C      	call	floppy		;$$$ phys. Transfer $$$
                         C       ENDIF
                         C       IF stpvar or monitor
  DDE9    CD E6A8        C      	call	delspr		;Sondertasten wieder erlauben
                         C       ENDIF
                         C      
  DDEC    E1             C      	pop	hl		;HL wieder auf Paramfeld-Adresse
  DDED    DD E1          C      	pop	ix		;IX wieder auf DPB
                         C      
  DDEF                   C      dioert:
                         C      ; Fehlerprotokoll
  DDEF    CB 66          C      	bit	dioftr,(hl)	;Fehlerprotokoll und -behandlung  unterdr.?
  DDF1    20 33          C      	jr	nz,dtrok	;ja
  DDF3    B7             C      	or	a		;Returncode
  DDF4    28 30          C      	jr	z,dtrok		; -> fehlerfrei
  DDF6    FE 52          C      	cp	'R'		;not ready?
  DDF8    CA DD91        C      	jp	z,diorty	;ja, Wiederholung
                         C      
                         C       IF errvar
  DDFB    32 DEE3        C      	ld	(derrcd),a	;Fehlercode
  DDFE    CB 56          C      	bit	diofwr,(hl)	;war lesen?
  DE00    3E 52          C      	ld	a,'R'
  DE02    28 02          C      	jr	z,derrr		;ja
  DE04    3E 57          C      	ld	a,'W'
  DE06    32 DEE2        C      derrr:	ld	(derrrw),a
                         C        IF dev eq cpd
                         C        ELSE
  DE09    21 E219        C      	ld	hl,ft.trk	;phys. Spur
  DE0C    11 DEED        C      	ld	de,derrtr
  DE0F    CD E798        C      	call	mbreco
  DE12    21 E21A        C      	ld	hl,ft.sid	;Seite
  DE15    CD E798        C      	call	mbreco
  DE18    21 E21B        C      	ld	hl,ft.sec	;Sektor
  DE1B    CD E798        C      	call	mbreco
                         C        ENDIF
  DE1E    21 DEE2        C      	ld	hl,derrms
  DE21    CD E779        C      	call	biosms
                         C       ENDIF
  DE24    3E 01          C       	ld	a,1		;return mit Fehler
                         C      
  DE26    B7             C      dtrok:	or	a		;stellen Z-Flag
  DE27    ED 5B E219     C      	ld	de,(ft.trk)	;E:=trk, D:=sid
  DE2B    2A E21B        C      	ld	hl,(ft.sec)	;L:=sec, H:=len
  DE2E    DD E1          C      	pop	ix
  DE30    C1             C      	pop	bc
  DE31    C9             C      	ret
                         C      
                         C       IF	format
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-77


                         C      
                         C      ; Stellen HL entsprechend Sektorlaengencode in (A)
                         C      ;=================================================
                         C      ; ret nz bei unzulaessigem
  DE32    B7             C      dtrsla:	or	a
  DE33    21 DE46        C      	ld	hl,dtrsl0
  DE36    C8             C      	ret	z		;=0 (128)
  DE37    3D             C      	dec	a
  DE38    21 DE64        C      	ld	hl,dtrsl1	;=1 (256)
  DE3B    C8             C      	ret	z
  DE3C    3D             C      	dec	a
  DE3D    21 DE83        C      	ld	hl,dtrsl2	;=2 (512)
  DE40    C8             C      	ret	z
  DE41    3D             C      	dec	a
  DE42    21 DEA1        C      	ld	hl,dtrsl3	;=3 (1024)
  DE45    C9             C      	ret
                         C      
                         C       ENDIF
                         C      
                         C      ;************************************************
                         C      ;	Steuertabellen
                         C      ;************************************************
                         C      
                         C      
                         C       IF	format
                         C      ; Modifizierungstabellen entspr. Sektorlaenge und LW-Typ
                         C      ;-------------------------------------------------------
                         C      
                         C      ; Struktur:
                         C      
  0000                   C      dsltrk	equ	0		;benutzte Spuren
  0001                   C      dslspt	equ	dsltrk+1	;Sektoren/Spur
  0002                   C      dsldir	equ	dslspt+1	;Dir-Eintraege
  0003                   C      dsloff	equ	dsldir+1	;2*offset
                         C      				;[+Flag fuer festes offset]
  0001                   C      dslfo	equ	1		;festes offset
  0000                   C      dslvo	equ	0		;offset =0, falls Directory mgl.
  0004                   C      dslblk	equ	dsloff+1	;rel. Adr. Tab. BDOS-Blockgroesse
  0005                   C      dsll	equ	5		;Laenge eines Eintrags
                         C      
                         C      ; Reihenfolge
                         C      ; 5", 40 Tr, SS
                         C      ; 5", 80 Tr, SS
                         C      ; 5", 40 Tr, DS
                         C      ; 5", 80 Tr, DS
                         C       if	disk8
                         C      ; 8", 77 Tr, SS, SD
                         C        if dsk8mf
                         C      ; 8", 77 Tr, SS, DD
                         C        endif
                         C       endif
                         C      
                         C      ; Zur automatischen Bestimmung des Spurformats wird dasjenige
                         C      ; Format der Spur "dlgint" benutzt, alle folgenden Spuren
                         C      ; muessen das gleiche Format haben!
  0003                   C      dlgint	equ	3	;groesste Anzahl SS-Systemspuren
                         C      
                         C      ; 128
  DE46                   C      dtrsl0:	
  DE46    28 1A 3F 04    C      	db	40,26,63,2*2+dslvo,dbl1k-$	;CP/M Standard
  DE4A    75             C      
  DE4B    50 1A 7F 04    C      	db	80,26,127,2*2+dslvo,dbl2k-$
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-78


  DE4F    73             C      
  DE50    50 1A 7F 01    C      	db	80,26,127,2*0+dslfo,dbl2k-$
  DE54    6E             C      
  DE55    A0 1A 7F 01    C      	db	160,26,127,2*0+dslfo,dbl2k0-$
  DE59    6C             C      
                         C      
                         C      	if	disk8
  DE5A    4D 1A 3F 04    C      	db	77,26,63,2*2+dslvo,dbl1k-$	;CP/M Standard
  DE5E    61             C      
                         C      	if	dsk8mf
  DE5F    4D 28 7F 04    C      	db	77,40,127,2*2+dslvo,dbl2k-$
  DE63    5F             C      
                         C      	endif
                         C      	endif
                         C      
                         C      ; 256
  DE64                   C      dtrsl1:	
  DE64    28 20 3F 07    C      	db	40,32,63,2*3+dslfo,dbl2k-$	;SCP Hausformat A51xx
  DE68    5A             C      
  DE69    50 20 3F 07    C      	db	80,32,63,2*3+dslfo,dbl2k-$	;SCP
  DE6D    55             C      
  DE6E    50 20 7F 09    C      	db	80,32,127,2*4+dslfo,dbl2k-$
  DE72    50             C      
  DE73    A0 20 7F 09    C      	db	160,32,127,2*4+dslfo,dbl2k0-$	;SCP Hausformat PC1715
  DE77    4E             C      
                         C      
                         C      	if	disk8
  DE78    4D 20 3F 07    C      	db	77,32,63,2*3+dslfo,dbl2k-$
  DE7C    46             C      
                         C      	if	dsk8mf
  DE7D    4D 34 7F 04    C      	db	77,52,127,2*2,dslfo,dbl2k-$
  DE81    01 40          C      
                         C      	endif
                         C      	endif
                         C      
                         C      ; 512
  DE83                   C      dtrsl2:	
  DE83    28 24 00 01    C      	db	40,36,0,2*0+dslfo,dbl1k-$
  DE87    38             C      
  DE88    50 24 00 01    C      	db	80,36,0,2*0+dslfo,dbl2k-$
  DE8C    36             C      
  DE8D    50 24 00 01    C      	db	80,36,0,2*0+dslfo,dbl2k-$
  DE91    31             C      
  DE92    A0 24 00 01    C      	db	160,36,0,2*0+dslfo,dbl2k0-$
  DE96    2F             C      
                         C      
                         C      	if	disk8
  DE97    4D 24 7F 04    C      	db	77,36,127,2*2+dslvo,dbl2k-$	;Hausformat IH Mittweida
  DE9B    27             C      
                         C      	if	dsk8mf
  DE9C    4D 40 7F 04    C      	db	77,64,127,2*2+dslvo,dbl2k0-$
  DEA0    25             C      
                         C      	endif
                         C      	endif
                         C      	
                         C      ; 1024
  DEA1                   C      dtrsl3:	
  DEA1    28 28 3F 04    C      	db	40,40,63,2*2+dslvo,dbl1k-$	;CP/A Standard A51xx
  DEA5    1A             C      
  DEA6    50 28 7F 04    C      	db	80,40,127,2*2+dslvo,dbl2k-$	;CP/A
  DEAA    18             C      
  DEAB    50 28 7F 00    C      	db	80,40,127,2*0+dslvo,dbl2k-$	;CP/A
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-79


  DEAF    13             C      
  DEB0    A0 28 BF 08    C      	db	160,40,191,2*4+dslvo,dbl2k0-$	;CP/A (und SCP)
  DEB4    11             C      
                         C      
                         C      	if	disk8
  DEB5    4D 20 3F 06    C      	db	77,32,63,2*3+dslvo,dbl2k-$	;CP/A und SCP
  DEB9    09             C      
                         C      	if	dsk8mf
  DEBA    4D 40 7F 04    C      	db	77,64,127,2*2+dslvo,dbl2k0-$	;CP/A und SCP
  DEBE    07             C      
                         C      	endif
                         C      	endif
                         C      
                         C      ; Modifizierungstabellen fuer BDOS-Blockgroesse
  DEBF    03 07 00       C      dbl1k:	db	3,7,0		;Bl. Shift, Bl. Mask, Ext. Mask
  DEC2    04 0F 01       C      dbl2k:	db	4,0fh,1
  DEC5    04 0F 00       C      dbl2k0:	db	4,0fh,0		;fuer Kapazitaet >255
                         C      
                         C      ; log. Sektortranslate-Tabelle fuer 26*128
  DEC8    01 07 0D 13    C      xlt:	db	1,7,13,19,25,5,11,17,23,3,9,15,21
  DECC    19 05 0B 11    C      
  DED0    17 03 09 0F    C      
  DED4    15             C      
  DED5    02 08 0E 14    C      	db	2,8,14,20,26,6,12,18,24,4,10,16,22
  DED9    1A 06 0C 12    C      
  DEDD    18 04 0A 10    C      
  DEE1    16             C      
                         C      
                         C       ENDIF	;format
                         C      
                         C      	include BIOSDSKW
                         C      ;;***************************************************************
                         C      ;;	Arbeitsbereiche logischer Floppy-Treiber im System-RAM *
                         C      ;;***************************************************************
                         C      ;; 03.06.89
                         C      
                         C       IF errvar
                         C      ;; Fehlermeldung Disk I/O Error
                         C      ;;=============================
                         C      ;; Genau so lang (kurz), wie in Statuszeile Platz dafuer da ist!
                         C      ;; und das sind 17 Bytes!
  DEE2                   C      derrms:
                         C       IF cpastz
                         C       ENDIF
  DEE2    58             C      derrrw:	db	'X'
  DEE3    58 3B 54 2C    C      derrcd:	db	'X;T,Si,Se='
  DEE7    53 69 2C 53    C      
  DEEB    65 3D          C      
  DEED    58 58          C      derrtr:	db	'XX'
  DEEF    58 58          C      derrts:	db	'XX'
  DEF1    58 58          C      derrsc:	db	'XX'
                         C       IF cpastz
                         C       ENDIF
                         C      
                         C       ENDIF
                         C      
                         C      ;; CDB's
                         C      ;;======
                         C      
                         C      ;;CDB fuer Bestimmung Laufwerksbereitschaft bei Select Disk
                         C      ;;--------------------------------------------------------
  DEF3                   C      drdcdb:
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-80


  DEF3    10             C      drdflg:	db	(1 shl dioftr)	;;Lesen, kein Fehlerprotokoll
  DEF4    FF             C      drddev:	db	0ffh		;;Geraet
  DEF5    0000           C      drdtrk:	dw	0		;;Spur
  DEF7    01             C      	db	1		;;Sektor (bel.)
  DEF8    01             C      	db	1		;;Sektorlaengencode (>0, 1..3)
  DEF9    00             C      	db	0		;;Sektoranzahl=0 -> nur Positionieren
                         C      
                         C      	IF	format
                         C      ;; CDB fuer Bestimmung Spurformat
                         C      ;;------------------------------------
  DEFA                   C      dfrcdb:
  DEFA    12             C      dfrflg:	db	(1 shl diofid)+(1 shl dioftr)
                         C      ;;		Lesen Sektorid., kein Fehlerprotokoll
  DEFB    FF             C      dfrmdv:	db	0ffh		;;Geraet
  DEFC    FF             C      dfrmtr:	db	0ffh		;;Spur
  DEFD    FF             C      	db	0ffh		;;Seite (bel.)
  DEFE    01             C      	db	1		;;Sektor (bel.)
  DEFF    01             C      	db	1		;;Sektorlaengencode (>0, 1..3)
  DF00    01             C      	db	1		;;Sektoranzahl (>0)
                         C      	ENDIF
                         C      
                         C      	IF	format or (dbufsz gt 7)
                         C      ;; Puffer-CDB
                         C      ;;-----------
  DF01                   C      dbcdb:
  DF01    00             C      dbflg:	db	0
  0000                   C      dfbprr	equ	diof00		;;=1, wenn Puffer erst gelesen 
                         C      ;;				     werden muss
  0002                   C      dfbwr	equ	diofwr		;;=1, wenn Puffer durch
                         C      ;;				     Schreiben veraendert
  0004                   C      dfbtr	equ	dioftr		;;=1, wenn mit Fehlerprotokoll
                         C      ;; restliche Bits immer =0
  DF02    FF             C      dbdev:	db	0ffh
  DF03    FF             C      dbtrk:	db	0ffh
  DF04    FF             C      dbsid:	db	0ffh
  DF05    FF             C      dbsec:	db	0ffh
  DF06    FF             C      dbslc:	db	0ffh
  DF07    FF             C      dbsnb:	db	0ffh
                         C      	IF	dbufsz gt 7
  DF08    F339           C      dbdma:	dw	dbuf
                         C      	ENDIF
                         C      	ENDIF
                         C      
                         C      ;; CDB fuer ungepufferte E/A
                         C      ;;--------------------------
                         C      
  DF0A                   C      dcdb:
  DF0A    00             C      dflg:	db	0
  0002                   C      dfwr	equ	diofwr 		;;=1, wenn write-Aufruf
                         C      ;; restliche Bits immer =0
  DF0B    00             C      ddrive:	db	0
  DF0C    FF             C      dtrack:	db	0ffh
  DF0D    FF             C      	db	0ffh		;;Seite
  DF0E    FF             C      dsectr:	db	0ffh
  DF0F    00             C      	db	0		;;128 Bytes Sektorlaenge
  DF10    01             C      	db	1		;;immer nur 1 Sektor
  DF11    FFFF           C      ddma:	dw	0ffffh
                         C      
                         C       if ramfl
  DF0C                   C      rtrack	equ	dtrack
                         C       endif
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-81


                         C      ;; Pufferzugriff
                         C       IF @write
                         C       IF dbufsz gt 7
  DF13    00 FF FF FF    C      unacnt:	db	0,0ffh,0ffh,0ffh,0
  DF17    00             C      
  DF14                   C      unadev	equ	unacnt+1
  DF15                   C      unatrk	equ	unacnt+2
  DF17                   C      unasec	equ	unacnt+4
                         C       ENDIF
                         C       ENDIF
                         C       IF dbufsz gt 7
  DF18    FF             C      dbnb:	db	0ffh
  DF19    FF             C      dwrtyp:	db	0ffh
  DF1A    00             C      dberrf:	db	0		;;Ergebnisflag letztes dbtran
                         C       ENDIF
                         C      	include BIOSDSKB
                         C      ;;***************************************************************
                         C      ;;	Arbeitsbereiche logischer Floppy-Treiber im BIOS-RAM   *
                         C      ;;***************************************************************
                         C       IF dev eq cpd
                         C       ELSE
  DF1B                   C      diocdb:	ds	9,0ffh
                         C       ENDIF
  DF1B                   C      diocfl	equ	diocdb+0
  DF1C                   C      diocde	equ	diocdb+1
  DF1D                   C      dioctr	equ	diocdb+2
  DF1E                   C      diocsi	equ	diocdb+3
  DF1F                   C      diocse	equ	diocdb+4
  DF20                   C      diocsl	equ	diocdb+5
  DF21                   C      diocsn	equ	diocdb+6
  DF22                   C      diocad	equ	diocdb+7
  0009                   C      diocdl	equ	9		;;Anzahl der Bytes
                         C      
                         C       IF dev eq cpd
                         C       ELSE
                         C        IF disknb eq 0
                         C        ENDIF
                         C       ENDIF
                                 IF disknb ne 0
                         C      	include BIOSDSKT
                         C      ;*********************************************************
                         C      ; physischer Disketten-Transfer
                         C      ; Aenderungen:
                         C      ; - Es koennen 9 statt bisher 4 phys. Sektoren auf einmal gelesen werden
                         C      ;!-!Schnittstellenaenderung bei SektId lesen:
                         C      ;   ft.anz muss <>0 sein (zuvor beliebig, bei =0 kein Transfer)
                         C      ;   ft.len muss 0..3 sein (zuvor beliebig, bei >3 fehlerhafte Tabellenmodif.)
                         C      ;   ft.kom, Bit 7 eingefuehrt: =0 Vorderseite, =1 Rueckseite
                         C      ;   ft.kom, Bit 0 (Verify nach Schreiben) auf Bit 6 verlegt
                         C      ;   ft.kom, Bit 0 =1 bedeutet "keine Fehlerwiederholung"
                         C      ; - Floppy-Treiber auch fuer Variante K5120/22 generierbar
                         C      ; 06.07.88
                         C      ; - Motor-Start-Wait von 254 auf 252 veraendert (2.5 Umdrehungen)
                         C      ;   (ist bei einigen Laufwerken wegen PreReady notwendig)
                         C      ; 03.11.22
                         C      ; - Variante K5122 eingefuegt
                         C      ; 25.09.89
                         C      ; - bei MFS 1.2 bei Mehr-Sektor-Transfer "Fault reset" zwischen den Sektoren
                         C      ;*********************************************************
                         C      
                         C      ; Aufruf:
                         C      ; -------
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-82


                         C      ; Bereitstellung der Parameter auf den Bytes:
                         C      
                         C      ;       ft.kom:	db	0	; bit0 - =1 ohne Fehlerwiederholung
                         C      ;				     1 - =1 lesen ft.len von beliebigem Sektor
                         C      ;				     2 - =0 lesen ; =1 schreiben Sektor(en)
                         C      ;				     3 - =0-FM; =1-MFM   (5"FM nur bei PC1715)
                         C      ;				     4 - =0-8"; =1-5"
                         C      ;				     5 - =0- 40-Spur-Laufwerk; =1- 80-Spur-LW
                         C      ;				     6 - =1 bei verify nach schreiben
                         C      ;				     7 - =0 Vorderseite, =1 Rueckseite
                         C      ;	ft.adr: dw	0	; Transferadresse
                         C      ;	ft.lwn: db	0	; 0..3 phys. Laufwerksnummer
                         C      ;	ft.trk: db	0	; 0..  track
                         C      ;	ft.sid: db	0	; 0..ff side (side=0 auf Rueckseite moeglich!)
                         C      ;	ft.sec: db	0	; 0..  sector (beliebig bei SektId lesen)
                         C      ;	ft.len: db	0	; 0..3 Sektorlaenge (auch 0..3 bei SektId les.)
                         C      ;	ft.anz: db	0	; 0..9 Anzahl der zu uebertragenden Sektoren
                         C      ;				;      =0: nur Positionieren
                         C      ;				;      (<>0 bei SektId lesen)
                         C      ;       ft.stp: db	0	;      Anzahl der Stepimpulse von Spur zu Spur
                         C      ;	ft.sti: db	0	;      Schrittzeit von Spur zu Spur
                         C      ;				;      in 0,1ms Einheiten
                         C      ;
                         C      ;	call	floppy
                         C      ;       ...			; in A steht Ergebniskode
                         C      ;				; alle Register (auch IX) undef.
                         C      ;
                         C      ; Ergebniskode (in Reg. A):
                         C      ;	00h kein Fehler (Z-Flag nicht von floppy gesetzt)
                         C      ;	'C' CRC-Fehler
                         C      ;	'D' LW nicht existent
                         C      ;	'R' Geraet nicht bereit, aber existent
                         C      ;	'L' unzulaessige Transferlaenge
                         C      ;	'S' Sektor nicht gefunden
                         C      ;	'T' Spurnummer zu gross
                         C      ;	'U' keine Marke gefunden
                         C      ;	'W' Diskette schreibgeschuetzt
                         C      
                         C      ; Paramfeld wird an folgenden Stellen veraendert:
                         C      ;  Komm. "Lesen Sekt,Id.":	ft.trk .. ft.len gestellt
                         C      ;  Komm. "Schreiben mit Verify":ft.kom, bit 2 geloescht
                         C      ;**************************************************
                         C      
  0004                   C      maxlw	equ	4		; Anzahl der Laufwerke (1..4)
                         C      
                         C      ; Adressen der Floppy-Karte
                         C      ;==========================
                         C      
                         C       IF (fdc eq k5120) or (fdc eq k5122)
                         C      ;Steuer-PIO
  0010                   C      flcoad    equ  10h  ;PORT A
  0011                   C      flcoac    equ  11h
  0012                   C      flcobd    equ  12h  ;PORT B
  0013                   C      flcobc    equ  13h
                         C      
                         C      ;Daten-PIO
  0014                   C      fldaad    equ  14h  ;Port A Schreib-Daten
  0015                   C      fldaac    equ  15h
  0016                   C      fldabd    equ  16h  ;Port B Lese-Daten
  0017                   C      fldabc    equ  17h
                         C      
                         C      ;Select-Latch
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-83


  0018                   C      flsel     equ  18h  ;Bit 7..4 /Sel LW3..0;Bit 3..0  /LCK  LW 3..0
                         C      ;
                         C       ENDIF
                         C      
                         C       IF (fdc eq f1715)
                         C       ENDIF
                         C      
                         C      ;; Legende AMF:
                         C      ;;   Port A
                         C      ;;  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
                         C      ;;    |   |   |   |   |   |   |   |__ A  /WE  0-Schreiben ein
                         C      ;;    |   |   |   |   |   |   |______ A   MK  lesen  0-MFM-A1 Erkennung
                         C      ;;    |   |   |   |   |   |                          1-FM-Mark., MFM-C2 Erkenn.
                         C      ;;    |   |   |   |   |   |               schreiben  0-Takt fuer MFM
                         C      ;;    |   |   |   |   |   |                          1-Marken FM und A1 MFM
                         C      ;;    |   |   |   |   |   |__________ A  /SIDE 0-Kopf Seite 1; 1-Kopf Seite 0
                         C      ;;    |   |   |   |   |        oder   A  /FR   0-Fault reset;  1-kein FR
                         C      ;;    |   |   |   |   |______________ A  /STR 0-AMF aktiv
                         C      ;;    |   |   |   |                           1-AMF ausgeschaltet
                         C      ;;    |   |   |   |__________________ A   MK1 lesen  0-Informationen einlesen
                         C      ;;    |   |   |                                      1-nur 1 einlesen
                         C      ;;    |   |   |                           schreiben  0-FM-Daten schreiben
                         C      ;;    |   |   |                                      1-MFM und FM-Marken schr.
                         C      ;;    |   |   |______________________ A   MR, SD     0-steppen Richtung aussen
                         C      ;;    |   |                                          1-Marke-erkannt loeschen
                         C      ;;    |   |                                            steppen Richtung innen
                         C      ;;    |   |__________________________ A  /HL         0-Kopf geladen
                         C      ;;    |                                              1-Kopf entladen
                         C      ;;    |______________________________ A  /ST         0-Stepsignal an LW ein
                         C      ;;                                                   1-Stepsignal an LW aus
                         C      ;;
                         C      ;;  Port B
                         C      ;;  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
                         C      ;;    |   |   |   |   |   |   |   |__ E  /RDY  0-Laufwerk bereit
                         C      ;;    |   |   |   |   |   |   |                1-Laufwerk nicht bereit
                         C      ;;    |   |   |   |   |   |   |______ E  /MKE  0-Marke erkannt
                         C      ;;    |   |   |   |   |   |                    1-Marke noch nicht erkannt
                         C      ;;    |   |   |   |   |	 oder PC1715  E   MKE  1-Marke erkannt
                         C      ;;    |   |   |   |   |   | u.K5122            0-Marke noch nicht erkannt
                         C      ;;    |   |   |   |   |   |__________ E  /SYN  ???? (K5120)
                         C      ;;    |   |   |   |   |  oder K5122   A  /HF   0-Takt fuer 8" MFM
                         C      ;;    |   |   |   |   |                        1-Takt fuer 5" MFM und 8" FM
                         C      ;;    |   |   |   |   |  oder PC1715: A   MFM  0-FM-Aufzeichnung
                         C      ;;    |   |   |   |   |                        1-MFM-Aufzeichnung
                         C      ;;    |   |   |   |   |______________ A   PRE  0-schreiben ohne Prekompensation
                         C      ;;    |   |   |   |                            1-schreiben mit         "
                         C      ;;    |   |   |   |__________________ E  /FA   0-Fehler in der AMF aufgetreten
                         C      ;;    |   |   |                                1-kein Fehler aufgetreten
                         C      ;;    |   |   |          oder PC1715: A   FO   0-5"-Disketten
                         C      ;;    |   |   |                                1-8"-Disketten
                         C      ;;    |   |   |______________________ E  /WP   0-Schreibschutz ist ein
                         C      ;;    |   |                                    1-kein Schreibschutz
                         C      ;;    |   |__________________________ E  /FW   0-Laufwerk meldete Schreibfehler
                         C      ;;    |                                        1-Laufwerk meldete keinen Fehler
                         C      ;;    |______________________________ E  /T0   0-Kopf steht auf Spur 0
                         C      ;;                                             1-Kopf steht nicht auf Spur 0
                         C      
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      ;	FLOPPY-Treiber
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
  DF24                   C      floppy:
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-84


                         C      ; Anfangswerte stellen
  DF24    3A E215        C      	ld	a,(ft.kom)
  DF27    E6 01          C      	and	1		;Fehlerwiederholung?
  DF29    20 02          C      	jr	nz,setecr	;nein, A=0+1 (keine Wiederholung)
  DF2B    3E 10          C      	ld	a,15+1
  DF2D    32 E23B        C      setecr:	ld	(crerc),a	; Fehlerzaehler fuer CRC-Fehlerwiederholungen
  DF30    20 02          C      	jr	nz,setesp
  DF32    3E 05          C      	ld	a,4+1		; Fehlerzaehler fuer Spurfindewiederholungen
  DF34    32 E23C        C      setesp:	ld	(sperc),a
                         C      
                         C      ; Laufwerksnummer pruefen
  DF37    3A E218        C      	ld	a,(ft.lwn)	; LW
                         C      ;	cp	maxlw		; LW < groesster LW-Nr.?
                         C      ;	jr	nc,nolw		; -> nein, Fehler: LW nicht existent
  DF3A    4F             C      	ld	c,a		; merken LW fuer Motor-an-Test
  DF3B    47             C      	ld	b,a		; fuer djnz
  DF3C    B7             C      	or	a		; LW=0?
  DF3D    3A E23E        C      	ld	a,(lwexis)
  DF40    28 04          C      	jr	z,drv0		; ->ja
  DF42    0F             C      sp13: 	rrca
  DF43    0F             C      	rrca
  DF44    10 FC          C      	djnz	sp13
  DF46    E6 03          C      drv0: 	and	3
  DF48    20 05          C      	jr	nz,drv0a
                         C      
  DF4A    3E 44          C      nolw: 	ld	a,'D'		; LW nicht existent
  DF4C    C3 E111        C      	jp	fehret		; -> Fehler
                         C      
  DF4F                   C      drv0a:
                         C      ; LW selektieren und Motor einschalten
  DF4F    AF             C      	xor	a
  DF50    32 E1E6        C      	ld	(pretx+1),a	;Motorabschaltung verhindern
  DF53    3D             C      	dec	a		;A:=255
  DF54    CD E1CD        C      	call	fl.sto		;Index-Ueberwachung ein
  DF57    CB D9          C      	set	3,c		; Motor-an-Bit setzen
  DF59    21 E23F        C      	ld	hl,alwnr
  DF5C    7E             C      	ld	a,(hl)
  DF5D    B9             C      	cp	c		; ist es das richtige LW und Motor an?
  DF5E    3E 6A          C      	ld	a,+pvrw2-(xpvrw+2) ; jr z,pvrw2 (keine Vertikalstab.)
  DF60    28 42          C      	jr	z,dskmon	; ->ja, Kopf ist noch aufgesetzt
                         C      ; falsches LW oder Motor des LW aus
  DF62    CD E200        C      	call	flres		; alte Spurnr. merken
                         C      
                         C      ; neues LW anwaehlen, Motor einschalten und alte Spurnr. holen
  DF65    71             C      	ld	(hl),c		; neues LW, Motor-an-Bit
  DF66    EB             C      	ex	de,hl		;merken ^alwnr
  DF67    CB 99          C      	res	3,c		; alte Spurnr. holen
  DF69    06 00          C      	ld	b,0
  DF6B    21 E241        C      	ld	hl,spnrl
  DF6E    09             C      	add	hl,bc
  DF6F    7E             C      	ld	a,(hl)
  DF70    32 E240        C      	ld	(aspnr),a
  DF73    41             C      	ld	b,c
  DF74    04             C      	inc	b
  DF75    3E 77          C      	ld	a,077h		; LW-Anwahlbyte bilden (mit Lock)
  DF77    07             C      nfdei2: rlca
  DF78    10 FD          C      	djnz	nfdei2
  DF7A    D3 18          C      	out	(flsel),a	; Laufwerk selektieren (und evtl. Motor ein)
                         C       IF fdc eq f1715
                         C       ENDIF
  DF7C    3E A9          C      	ld	a,10101001b	; Kopf laden, Fault reset
  DF7E    D3 10          C      	out	(flcoad),a
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-85


                         C      
                         C      ; Motor-Start
  DF80    2E FD          C      	ld	l,252+1		;von 255 auf 252, d.h. mind 2 Umdrehungen?
  DF82    3A E215        C      	ld	a,(ft.kom)
  DF85    CB 67          C      	bit	4,a		;5"?
  DF87    28 06          C      	jr	z,dskmo1	;nein
  DF89    CB 6F          C      	bit	5,a		;5" 40 Spur?
  DF8B    20 02          C      	jr	nz,dskmo1	;nein
  DF8D    2E FB          C      	ld	l,250+1		;von 255 auf 250,
                         C      				; d.h. mind. 4 volle Umdrehungen?
                         C      				;(bei MFS 1.2 kommt evtl. ready zu frueh)
  DF8F                   C      dskmo1:
  DF8F    3A E1DE        C      dskdaw:	ld	a,(fl.zto)	;Index-Interrupt-Zaehler
  DF92    BD             C      	cp	l		;entprechend viele Umdrehungen vorbei?
  DF93    38 0D          C      	jr	c,dskda		;ja
  DF95    0D             C      	dec	c		; warten, bis Diskette eingeschoben
  DF96    20 F7          C      	jr	nz,dskdaw
  DF98    10 F5          C      	djnz	dskdaw
  DF9A    EB             C      	ex	de,hl
  DF9B    CB 9E          C      	res	3,(hl)		;loeschen Motor an Bit
  DF9D    3E 52          C      	ld	a,'R'		;LW nicht bereit
  DF9F    C3 E111        C      	jp	fehret
  DFA2    3E 61          C      dskda:	ld	a,+pvrw1-(xpvrw+2) ; jr z,pvrw1 (mit Vertikal-Stabil.)
  DFA4                   C      dskmon:
  DFA4    32 E005        C      	ld	(xpvrw+1),a	; Vertikal-Stabilisierung ein/aus
                         C      
                         C      
                         C       IF dsk8fm+dsk8mf+dsk5fm; Standard ist 5"MFM
                         C      ; modifizieren FM/MFM und 8"/5"
                         C      
  DFA7    21 E25A        C      	ld	hl,mdmfm8
  DFAA    01 000A        C      	ld	bc,mdtbl	;BC:=(Anzahl der Bytes)
  DFAD    3A E215        C      	ld	a,(ft.kom)
  DFB0    CB 5F          C      	bit	3,a		;MFM?
  DFB2    20 02          C      	jr	nz,modfl1	;ja
  DFB4    09             C      	add	hl,bc
  DFB5    09             C      	add	hl,bc
  DFB6    CB 67          C      modfl1:	bit	4,a		;8"?
  DFB8    28 01          C      	jr	z,modfl2	;ja
  DFBA    09             C      	add	hl,bc
  DFBB    EB             C      modfl2:	ex	de,hl
  DFBC    21 E245        C      	ld	hl,mdtbad
  DFBF    CD E16E        C      	call	flmodf		;Modifizierung
                         C       ENDIF
                         C       if dsk80
  DFC2    3A E215        C      	ld	a,(ft.kom)
                         C       if dsk8fm+dsk8mf
  DFC5    CB 67          C      	bit	4,a		;5" LW?
  DFC7    28 0B          C      	jr	z,dprecn	;nein
                         C       endif
  DFC9    CB 6F          C      	bit	5,a		;80-Spur-LW?
  DFCB    3E 19          C      	ld	a,25		;Spur, ab der mit Praekomp.
  DFCD    28 02          C      	jr	z,dprec2	;nein
  DFCF    3E 29          C      	ld	a,41
  DFD1    32 E08B        C      dprec2:	ld	(dpretr),a
  DFD4                   C      dprecn:
                         C       endif
                         C      
                         C      ; modifizieren entspr. phys. Sektorlaenge
  DFD4    3A E21C        C      	ld	a,(ft.len)
  DFD7    32 E31C        C      	ld	(sidlen),a
  DFDA    21 E282        C      	ld	hl,dsln0-dslnl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-86


  DFDD    47             C      	ld	b,a
  DFDE    04             C      	inc	b
  DFDF    11 0009        C      	ld	de,dslnl
  DFE2    19             C      dtrsll:	add	hl,de
  DFE3    10 FD          C      	djnz	dtrsll
  DFE5    EB             C      	ex	de,hl
  DFE6    21 E278        C      	ld	hl,dslnmt	;Tabelle der Modif.adr.
  DFE9    CD E16E        C      	call	flmodf
                         C      
                         C      ; Kopf positionieren
  DFEC    21 E219        C      	ld	hl,ft.trk	; gewuenschte Spur
  DFEF    7E             C      	ld	a,(hl)
  DFF0    B7             C      	or	a		;Spur 0?
  DFF1    20 0D          C      	jr	nz,npost0	;nein
  DFF3    3A E21D        C      	ld	a,(ft.anz)	;Sektorzahl
  DFF6    B7             C      	or	a		;nur positionieren auf Spur 0 (FORMAT-Progr.)
  DFF7    28 4F          C      	jr	z,trk0		;ja, Spur 0 immer ueber Recalibrate
  DFF9    3A E215        C      	ld	a,(ft.kom)
  DFFC    CB 4F          C      	bit	1,a		;Lesen Sekt.id Spur 0?
  DFFE    20 53          C      	jr	nz,trk0s	;ja, Lesen Sektid Spur 0 ueber Recalibrate
  E000    3A E240        C      npost0:	ld	a,(aspnr)	; stimmt Spur?
  E003    BE             C      	cp	(hl)
  E004    28 61          C      xpvrw:	jr	z,pvrw1		; -> ja, Kopf evtl. vertikal stabilisieren
                         C      				; auf jr z,pvrw2, wenn Kopf noch aufgesetzt
  E006                   C      spprty:				;Wiederholung bei fehlerhafter Spur
                         C      ; Positionierung auf ft.trk
  E006    3A E219        C      spe: 	ld	a,(ft.trk)
  E009    06 8F          C      	ld	b,08fh		; stepout-Befehl
  E00B    21 E240        C      	ld	hl,aspnr
  E00E    BE             C      	cp	(hl)		; auf richtiger Spur angekommen?
  E00F    28 56          C      	jr	z,phrw		; -> ja, Kopf horizontal stabilisieren
  E011    38 0D          C      	jr	c,spre		; -> stepout
  E013    FE 55          C      xmaxtr: cp	85		; Spur zu gross?
  E015    38 05          C      	jr	c,spve		; -> nein, stepin
  E017    3E 54          C      	ld	a,'T'		; Fehler: Spurnr. zu gross
  E019    C3 E111        C      	jp	fehret
                         C      
                         C      ; stepin
  E01C    06 AF          C      spve:	ld	b,0afh		; stepin-Befehl
  E01E    34             C      	inc	(hl)		; alte Spurnr. erhoehen
  E01F    34             C      	inc	(hl)		; wegen stepout-dec
                         C      
                         C      ; stepout
  E020    35             C      spre: 	dec	(hl)		; alte Spurnr. verringern
  E021    CD E026        C      	call	step
  E024    18 E0          C      	jr	spe
                         C      
                         C      ; steppen
  E026    3A E21E        C      step: 	ld	a,(ft.stp)	; Anzahl der Stepimpulse pro Step
  E029    0E 10          C      step0: 	ld	c,flcoad
  E02B    ED 41          C      	out	(c),b		; select direction
                         C      ;;;	push	bc
                         C      ;;;	ld	b,0
                         C      ;;;step1: 	djnz	step1		; 1,3ms warten
                         C      ;;;	pop	bc
  E02D    C5             C      step2: 	push	bc
  E02E    CB B8          C      	res	7,b
  E030    F3             C      	di			;verhindern Unterbrechung
  E031    ED 41          C      	out	(c),b
  E033    CB F8          C      	set	7,b
  E035    ED 41          C      	out	(c),b		; step
  E037    FB             C      	ei
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-87


  E038    ED 4B E21F     C      	ld	bc,(ft.sti)	; 13,2 / 11,6 / 3,0 ms Schrittzeit
  E03C    06 13          C      stepw1: ld	b,19		;(19*13)/(256*9600)=0.0001
  E03E    10 FE          C      stepw: 	djnz	stepw		;0.1 ms warten
  E040    0D             C      	dec	c
  E041    20 F9          C      	jr	nz,stepw1
  E043    C1             C      	pop	bc
  E044    3D             C      	dec	a
  E045    20 E6          C      	jr	nz,step2
  E047    C9             C      	ret
                         C      
                         C      ; Spur 0 anfahren (Recalibrate)
  E048    06 02          C      trk0:	ld	b,2		; nach innen, falls auf Spur -1
  E04A    C5             C      trk0i:	push	bc
  E04B    06 AF          C      	ld	b,0afh	 	; stepin
  E04D    CD E026        C      	call	step
  E050    C1             C      	pop	bc
  E051    10 F7          C      	djnz	trk0i
  E053    DB 12          C      trk0s:	in	a,(flcobd)
  E055    07             C      	rlca			; Spur 0 erreicht?
  E056    30 09          C      	jr	nc,trk0f	; -> ja
  E058    06 8F          C      	ld	b,08fh		; stepout-Befehl
  E05A    3E 01          C      	ld	a,1		; in phys. Schritten
  E05C    CD E029        C      	call	step0
  E05F    18 F2          C      	jr	trk0s
  E061    AF             C      trk0f: 	xor	a
  E062    32 E240        C      	ld	(aspnr),a	; aktuelle Spurnr ist 0
  E065    18 9F          C      	jr	spprty
                         C      
                         C      
                         C      ; Kopf stabilisieren (horizontal und vertikal)
  E067                   C      pvrw1:	; Kopf vertikal stabilisieren
  E067                   C      phrw:	; Kopf horizontal (und evtl. auch vertikal) stabilisieren
  E067    3E 32          C      	ld	a,50		; 50 ms (fuer alle Laufwerkstypen)
  E069    06 BD          C      phrww1: ld	b,189		; (189*13)/(256*9600)=0.001
  E06B    10 FE          C      phrww: 	djnz	phrww		; 1 ms warten
  E06D    3D             C      	dec	a
  E06E    20 F9          C      	jr	nz,phrww1
  E070                   C      pvrw2:	; Kopf war aufgesetzt und Spur stimmte auch - keine Stabilis.
                         C      
  E070                   C      rdwr:
                         C      ; Anfangswerte fuer Transfer der physischen Sektoren
  E070    3A E21D        C      	ld	a,(ft.anz)	; Anzahl der zu uebertragenden phys. Sektoren
  E073    32 E311        C      	ld	(secan1),a
  E076    32 E180        C      	ld	(secanz),a	; fuer CRC-Berechnung
                         C      
  E079    3A E219        C      	ld	a,(ft.trk)	; Spur
  E07C    32 E318        C      	ld	(sidtr),a
  E07F    21 E21E        C      	ld	hl,ft.stp
  E082    CB 46          C      	bit	0,(hl)		;Doppelschritte?
  E084    28 01          C      	jr	z,dprec1	;nein
  E086    87             C      	add	a,a		;sonst phys. Spur verdoppeln
  E087                   C      dprec1:
                         C      ; evtl. Precompensation einschalten
  E087    01 0412        C      	ld	bc,00000100b*256+flcobd
  E089                   C      dfrcod	equ	$-1		; Frequenzcode
  E08A    FE 19          C      	cp	25		; Spur ab der mit writeprecomp.
  E08B                   C      dpretr	equ	$-1
  E08C    38 02          C      	jr	c,prec		; <, ohne Precompensation
  E08E    CB D8          C      	set	3,b		; >= , mit
  E090    ED 41          C      prec: 	out	(c),b
                         C      
  E092    3A E21B        C      	ld	a,(ft.sec)	; erste zu uebertr. Sektornr.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-88


  E095    32 E31B        C      	ld	(sidsec),a
  E098    3A E21A        C      	ld	a,(ft.sid)
  E09B    32 E319        C      	ld	(sidsid),a
                         C      
                         C       IF dskds ; double sided
                         C      ; evtl. side 1 anwaehlen vorbereiten
  E09E    3A E215        C      	ld	a,(ft.kom)
  E0A1    21 E2AF        C      	ld	hl,dsidmt
  E0A4    46             C      	ld	b,(hl)
  E0A5    23             C      dsidmz:	inc	hl
  E0A6    5E             C      	ld	e,(hl)
  E0A7    23             C      	inc	hl
  E0A8    56             C      	ld	d,(hl)
  E0A9    EB             C      	ex	de,hl
  E0AA    CB 7F          C      	bit	7,a		; side 0?
  E0AC    28 04          C      	jr	z,pside0	; ja
  E0AE    CB 96          C      	res	2,(hl)		; side 1 einstellen
  E0B0    18 02          C      	jr 	pside1
  E0B2    CB D6          C      pside0:	set	2,(hl)
  E0B4    EB             C      pside1:	ex	de,hl
  E0B5    10 EE          C      	djnz	dsidmz
  E0B7    CB 6F          C      	bit	5,a		;40-Spur LW?
  E0B9    20 03          C      	jr	nz,pside2	;nein
  E0BB    EB             C      	ex	de,hl		;diom11
  E0BC    CB 96          C      	res	2,(hl)		;fault reset zwischen den Sektoren
  E0BE                   C      pside2:
                         C       ENDIF
                         C      
                         C      ; evtl. nur Lesen Sektor-Id.
  E0BE    3A E215        C      	ld	a,(ft.kom)
  E0C1    CB 4F          C      	bit	1,a		; Lesen Sekt.Id?
  E0C3    21 E309        C      	ld	hl,dio
  E0C6    28 03          C      	jr	z,srdsid	; -> nein
  E0C8    21 E36F        C      	ld	hl,diotsr
  E0CB    22 E2C9        C      srdsid:	ld	(diortn),hl
                         C      
                         C       IF @write
  E0CE    3A E215        C      	ld	a,(ft.kom)	; Schreiben?
  E0D1    CB 57          C      	bit	2,a
  E0D3    20 08          C      	jr	nz,writpt	; -> ja, Schreibroutine steht auf dioop
                         C       ENDIF
  E0D5    21 E3C4        C      	ld	hl,diord
  E0D8    22 E36D        C      	ld	(dioop),hl	; read einstellen
                         C      
                         C       IF @write
  E0DB    18 22          C      	jr	dtrdyt
  E0DD                   C      writpt:		; pruefen, ob Schreiben erlaubt ist
  E0DD    DB 12          C      	in	a,(flcobd)
  E0DF    CB 6F          C      	bit	5,a		; /WP
  E0E1    3E 57          C      	ld	a,'W'		; Fehler: write protected
  E0E3    CA E111        C      	jp	z,fehret
                         C      
                         C      ; CRC-Zeichen der zu schreibenden Daten berechnen und in crcber ablegen
  E0E6    2A E216        C      	ld	hl,(ft.adr)
  E0E9    DD 21 E220     C      	ld	ix,crcber	; Pointer auf 1. Daten-CRC stellen
  E0ED    DD 36 00 FB    C      crcbes: ld	(ix),0fbh	; Datenbeginn
  E0F1    CD E190        C      	call	crcbd		; CRC eines phys. Sektors berechnen
  E0F4    DD 72 00       C      	ld	(ix+0),d
  E0F7    DD 73 01       C      	ld	(ix+1),e	; ... und ablegen
  E0FA    CD E17B        C      	call	crcnb		; weiterer phys. Sektor?
  E0FD    20 EE          C      	jr	nz,crcbes	; -> ja
                         C       ENDIF ;@write
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-89


                         C      
                         C      
                         C      ; Disk inzwischen ready?
                         C      
  E0FF                   C      dtrdyt:
  E0FF    DB 12          C      dtrdyz:	IN	A,(flcobd)
  E101    1F             C      	RRA			;ready-bit =0?
  E102    38 FB          C      dtrdyw:	JR	C,dtrdyz	;nein, 5" Disk not ready
                         C      				;auf jr c,$+2 modif bei 8"
                         C      
  E104    3E 05          C      	ld	a,5
  E106    CD E1CD        C      	call	fl.sto		;bei evtl. Fehlerwiederholung
                         C      				; timeout-Wert wieder hochstellen
                         C      				; fuer Ueberwachung auf fehlende Marke
  E109    3A E21D        C      	ld	a,(ft.anz)	;Sektorzahl
  E10C    B7             C      	or	a		; nur positionieren?
  E10D    C2 E2C2        C      	jp	nz,diorun	; -> nein, Start des Transfers
                         C      
                         C      ; kein Fehler aufgetreten
  E110    AF             C      noerr:	xor	a
                         C      
                         C      ; Fertigmelden, Ergebnis in A
  E111    F5             C      fehret:	push	af
  E112    21 E1E6        C      	ld	hl,pretx+1	;Motorabschaltung ueber Index-Interrupt
  E115    36 0B          C      	ld	(hl),pret3-pret4;jr pret4
  E117    3E 14          C      	ld	a,20		;nach 20*200ms = 4 sec
  E119    CD E1CD        C      	call	fl.sto
  E11C    F1             C      	pop	af
  E11D    C9             C      	ret
                         C      
                         C      ; normale Beendigung
                         C      ;===================
                         C      
                         C      ; Schreiben
  E11E    21 E215        C      dtrwre:	ld	hl,ft.kom
  E121    CB 76          C      	bit	6,(hl)		;Kontrollesen?
  E123    28 EB          C      	jr	z,noerr		;nein, fertig
  E125    CB 96          C      	res	2,(hl)		;sonst schreiben loeschen (d.h. auf lesen)
  E127    C3 E070        C      	jp	rdwr		;und auf gleichen Puffer zuruecklesen
                         C      
                         C      ; Lesen
  E12A    2A E216        C      dtrrde:	ld	hl,(ft.adr)
  E12D    DD 21 E220     C      	ld	ix,crcber
  E131    CD E190        C      crcbel:	call	crcbd		;CRC bilden
  E134    CD E186        C      	call	crcvgl		; und vergleichen
  E137    20 07          C      	jr	nz,crcerx	; -> Fehler
  E139    CD E17B        C      	call	crcnb		;noch ein Sektor?
  E13C    20 F3          C      	jr	nz,crcbel	;ja
  E13E    18 D0          C      	jr	noerr
                         C      
                         C      ; Fehlerbehandlung
                         C      ;=================
                         C      ; blieb weiterer Versuch, Sektor CRC-richtig reinzubekommen?
  E140    21 E23B        C      crcerx: ld	hl,crerc
  E143    35             C      	dec	(hl)
  E144    C2 E070        C      	jp	nz,rdwr		; -> ja, alles noch mal
  E147    3E 43          C      	ld	a,'C'		; Fehler: CRC-Zeichen falsch
  E149    18 C6          C      	jr	fehret
                         C      
                         C      ; Sektor nicht gefunden, evtl. falsche Spur
  E14B                   C      serrx:
                         C      ; blieb weiterer Versuch, die richtige Spur zu finden?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-90


  E14B    21 E23C        C      	ld	hl,sperc
  E14E    35             C      	dec	(hl)
  E14F    28 15          C      	jr	z,sperr2	; Wiederhlg. abgelaufen
  E151    3E 02          C      	ld	a,2
  E153    BE             C      	cp	(hl)		;> 2 Wiederhlg?
  E154    DA E048        C      	jp	c,trk0		;ja, Spur neu anfahren
  E157    06 8F          C      	ld	b,08fh		;stepout
  E159    28 05          C      	jr	z,sperr4	;=2 Wiederhlg., stepout
  E15B    06 AF          C      	ld	b,0afh		;stepin
  E15D    CD E026        C      	call	step		;2 mal (zuvor war stepout)
  E160    CD E026        C      sperr4:	call	step
  E163    C3 E067        C      	jp	phrw		;Wiederholung
                         C      
  E166    3E 53          C      sperr2:	ld	a,'S'		; Fehler: Sektor ist nicht zu finden
  E168    18 A7          C      	jr	fehret
                         C      
                         C      
  E16A                   C      fl.to1: ; keine Sektor-Marke gefunden
  E16A    3E 55          C      	ld	a,'U'		; time-out (undefind)
  E16C    18 A3          C      	jr	fehret
                         C      
                         C      ; Modifizierung entsprechend Steuertabelle
                         C      ;=========================================
                         C      ; i HL	Tabelle der Modifizierungsadressen (wohin)
                         C      ; i DE	Tabelle der Modifizierungsbytes    (was)
  E16E    46             C      flmodf:	ld	b,(hl)		;Anzahl der Adressen
  E16F    23             C      dslnmz:	inc	hl
  E170    C5             C      	push	bc
  E171    4E             C      	ld	c,(hl)
  E172    23             C      	inc	hl
  E173    46             C      	ld	b,(hl)		;bc:=wohin
  E174    1A             C      	ld	a,(de)		;a:=was
  E175    13             C      	inc	de
  E176    02             C      	ld	(bc),a
  E177    C1             C      	pop	bc
  E178    10 F5          C      	djnz	dslnmz
  E17A    C9             C      	ret
                         C      
                         C      ; CRC-Berechnung
                         C      ;===============
                         C      
                         C      ; von weiterem Sektor CRC-Zeichen berechnen?
                         C      ; IX wird weitergestellt
  E17B    DD 23          C      crcnb: 	inc	ix		; CRC-Pointer erhoehen
  E17D    DD 23          C      	inc	ix
  E17F    3E FF          C      	ld	a,0ffh
  E180                   C      secanz	equ	$-1
  E181    3D             C      	dec	a
  E182    32 E180        C      	ld	(secanz),a
  E185    C9             C      	ret
                         C      
                         C      ; CRC-Vergleich DE mit (IX)
  E186    DD 7E 00       C      crcvgl: ld	a,(ix+0)
  E189    BA             C      	cp	d
  E18A    C0             C      	ret	nz
  E18B    DD 7E 01       C      	ld	a,(ix+1)
  E18E    BB             C      	cp	e
  E18F    C9             C      	ret
                         C      
                         C      ; von einem phys. Sektor ab HL die CRC-Zeichen berechnen
                         C      ; HL wird weitergestellt
  E190    11 CDB4        C      crcbd:	ld	de,0cdb4h	;CRC Anfangswert
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-91


  E191                   C      crcbeg	equ	$-2
  E193    DD E5          C      	push	ix
  E195    E3             C      	ex	(sp),hl		;hl:= ^Datenbeginn-Byte
  E196    06 01          C      	ld	b,1
  E198    CD E1AA        C      	call	bercrc		;CRC ueber Datenbeginn-Byte
  E19B    E3             C      	ex	(sp),hl
  E19C    DD E1          C      	pop	ix
  E19E    06 01          C      	ld	b,1
  E19F                   C      fl.tsb	equ	$-1		; Zahl der 128er Bloecke
  E1A0    C5             C      sp74: 	push	bc
  E1A1    06 80          C      	ld	b,128
  E1A3    CD E1AA        C      	call	bercrc
  E1A6    C1             C      	pop	bc
  E1A7    10 F7          C      	djnz	sp74
  E1A9    C9             C      	ret
                         C      
                         C      ; von HL an B Zeichen auf DE als CRC-Polynom draufrechnen
  E1AA    7E             C      bercrc: ld	a,(hl)
  E1AB    AA             C      	xor	d
  E1AC    57             C      	ld	d,a
  E1AD    0F             C      	rrca
  E1AE    0F             C      	rrca
  E1AF    0F             C      	rrca
  E1B0    0F             C      	rrca
  E1B1    E6 0F          C      	and	0fh
  E1B3    AA             C      	xor	d
  E1B4    57             C      	ld	d,a
  E1B5    0F             C      	rrca
  E1B6    0F             C      	rrca
  E1B7    0F             C      	rrca
  E1B8    4F             C      	ld	c,a
  E1B9    E6 1F          C      	and	1fh
  E1BB    AB             C      	xor	e
  E1BC    5F             C      	ld	e,a
  E1BD    79             C      	ld	a,c
  E1BE    0F             C      	rrca
  E1BF    E6 F0          C      	and	0f0h
  E1C1    AB             C      	xor	e
  E1C2    5F             C      	ld	e,a
  E1C3    79             C      	ld	a,c
  E1C4    E6 E0          C      	and	0e0h
  E1C6    AA             C      	xor	d
  E1C7    53             C      	ld	d,e
  E1C8    5F             C      	ld	e,a
  E1C9    23             C      	inc	hl
  E1CA    10 DE          C      	djnz	bercrc
  E1CC    C9             C      	ret
                         C      
                         C      ; Aktivieren Indexpunktueberwachung
                         C      ; i A	Zaehler (wird bis 0 runtergezaehlt)
                         C      ; nur Reg. A zerstoert
                         C      
  E1CD    32 E1DE        C      fl.sto:	ld	(fl.zto),a	;Setzen Zaehler fuer Indexpunkte
  E1D0    3E 83          C      	ld	a,83h		;zulassen Indexinterrupt
  E1D2    D3 11          C      	out	(flcoac),a
  E1D4    C9             C      	ret
                         C      
                         C      ; Interruptbehandlungsroutine: time-out-Zeit abgelaufen
                         C      ; ausgeloest durch Index-Interrupt
  E1D5    ED 73 E579     C      itimeo: ld	(intsp),sp
  E1D9    31 F0E9        C      	ld	sp,intstk
  E1DC    F5             C      	push	af
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-92


  E1DD    3E 00          C      	ld	a,0		; Zaehler fuer time-out Takte
  E1DE                   C      fl.zto	equ	$-1
  E1DF    3D             C      	dec	a		; time-out -1
  E1E0    32 E1DE        C      	ld	(fl.zto),a
  E1E3    20 10          C      	jr	nz,pret1	;-> nicht abgelaufen
  E1E5    18 0B          C      pretx:	jr	pret3		;modif. auf "jr pret4" waehrend Transfer
  E1E7                   C      pret4:
                         C       IF cpu eq k2526
  E1E7    3E A9          C      	ld	a,10101001b	;Time out waehrend Transfer
  E1E9    D3 10          C      	out	(flcoad),a	;CPU 2 stoppen
  E1EB    3E 00          C      	ld	a,dtrtor-dtrwjr
  E1ED    32 E2F9        C      	ld	(dtrret),a	;Reaktionsroutine "keine Marke gefunden"
                         C       ENDIF
  E1F0    18 03          C      	jr	pret1
  E1F2    CD E1F8        C      pret3:	call	headup
  E1F5    C3 E577        C      pret1: 	jp	intraf		; allg. Ausgang Interruptroutinen
                         C      
                         C      ; Motor-Abschaltung von aussen her
                         C      ; nur Reg. AF zerstoert
  E1F8    3E 03          C      headup:	ld	a,3		; Indexinterrupt sperren
  E1FA    D3 11          C      	out	(flcoac),a
  E1FC    3E FF          C      	ld	a,0ffh		; Motor aus
  E1FE    D3 18          C      	out	(flsel),a
                         C       IF fdc eq f1715
                         C       ENDIF
                         C      ; Motor aus und alte Spurnummer merken
  E200    E5             C      flres: 	push	hl
  E201    C5             C      	push	bc
  E202    21 E23F        C      	ld	hl,alwnr
  E205    CB 9E          C      	res	3,(hl)		; Motor aus vermerken
  E207    4E             C      	ld	c,(hl)
  E208    06 00          C      	ld	b,0
  E20A    21 E241        C      	ld	hl,spnrl	; alte Spurnr. in Tabelle merken
  E20D    09             C      	add	hl,bc
  E20E    3A E240        C       	ld	a,(aspnr)
  E211    77             C      	ld	(hl),a
  E212    C1             C      	pop	bc
  E213    E1             C      	pop	hl
  E214    C9             C      	ret
                         C      
                         C      
                         C      ;*****************************************************
                         C      ;	Arbeitsbereiche phys. Floppy-Treiber
                         C      ;*****************************************************
                         C      
                         C      ; Parameterfeld
                         C      ;==============
  E215    00             C      ft.kom: db	0	; Kommando
  E216    0000           C      ft.adr: dw	0	; Transferadresse
  E218    00             C      ft.lwn: db	0	; Laufwerksnummer 0..3
  E219    00             C      ft.trk: db	0	; Spurnummer   0..
  E21A    00             C      ft.sid: db	0	; side-Nr.     0..1
  E21B    00             C      ft.sec: db	0	; Sektornummer
  E21C    00             C      ft.len: db	0	; Sektorlaenge 0..3
  E21D    00             C      ft.anz: db	0	; Anz. phys. Sektoren
  E21E    00             C      ft.stp: db	0	; Anzahl der Stepimpulse pro Spur
  E21F    00             C      ft.sti: db	0	; Schrittzeit von Spur zu Spur
                         C      
  E220                   C      crcber: ds	3*9,0ffh; Ber. zum Ablegen der gelesenen/zu schreibenden CRC-Z.
                         C      			; reicht fuer 9 physische Sektoren pro Transfer
                         C      ; Fehler-Wiederholungszaehler
  E23B    00             C      crerc: 	db	0	; CRC-Fehler
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-93


  E23C    00             C      sperc: 	db	0	; Spur nicht gefunden
  E23D    00             C      seerc: 	db	0	; Sektor nicht gefunden
  E23E    00             C      lwexis: db	0	; Anzeigebyte fuer vorhandene Laufwerke
                         C      			; bit 0 = 1 LW 0 vorhanden
                         C      			; bit 2 = 1 LW 1 vorhanden
                         C      			; bit 4 = 1 LW 2 vorhanden
                         C      			; bit 6 = 1 LW 3 vorhanden
                         C      
  E23F    00             C      alwnr: 	db	0	; alte Laufwerksnummer vom vergangenen Zugriff
                         C      			; bit 0-2 LW-Nr., bit 3 = 1 Motor laeuft noch
                         C      
  E240    00             C      aspnr:	db	0	; aktuelle Spur des durch alwnr bezeichneten LW
  E241    00 00 00 00    C      spnrl: 	db	0,0,0,0	; Tabelle der alten Spurnummern
                         C      
                         C       IF dsk8fm+dsk8mf+dsk5fm
                         C      
                         C      ; Modifizierungstaelle entspr. LW-Typ und Aufzeichnungsverfahren
                         C      ; standardmaessig ist 5" MFM, Seite 0 eingestellt
                         C      
  E245    0A             C      mdtbad:	db	mdtbl
  E246    E33A           C      	dw	diom01		;Lesen Marke auf Seite 0 ein
  E248    E365           C      	dw	diomd2		;Gap-Rest Sektor/Daten
  E24A    E191           C      	dw	crcbeg		;CRC-Anfangswert
  E24C    E192           C      	dw	crcbeg+1
  E24E    E089           C      	dw	dfrcod		;Taktfrequenzcode
  E250    E08B           C      	dw	dpretr		;Precomp. Spur
  E252    E103           C      	dw	dtrdyw+1	;ready Wartezyklus
                         C       IF cpu eq k2526
                         C       ENDIF
                         C       if @write
  E254    E36D           C      	dw	dioop		;Schreibroutine
  E256    E36E           C      	dw	dioop+1
                         C        IF cpu eq k2526
                         C        ENDIF
                         C        if dsk8fm+dsk8mf
  E258    E46C           C      	dw	diowm1+1	;Zahl der Null-Bytes nach Datenschreiben
                         C        endif
                         C       endif
  000A                   C      mdtbl	equ	($-mdtbad-1)/2
                         C      
                         C      ; MFM
                         C      ;====
  E25A    85             C      mdmfm8:	db	10000101b
                         C       IF cpu eq k2526
  E25B    11             C      	db	17
                         C       ENDIF
  E25C    CDB4           C      	dw	0cdb4h
                         C       IF fdc eq f1715
                         C       ENDIF
                         C       IF fdc eq k5120
                         C       ENDIF
                         C       IF fdc eq k5122
  E25E    00             C      	db	00000000b
                         C       ENDIF
  E25F    FF             C      	db	255
  E260    00             C      	db	0
                         C       IF cpu eq k2526
                         C       ENDIF
                         C       if @write
  E261    E42E           C      	dw	diwmfm
                         C        IF cpu eq k2526
                         C        ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-94


                         C        if dsk8fm+dsk8mf
  E263    02             C      	db	2
                         C        endif
                         C       endif
                         C      
  E264    85             C      mdmfm5:	db	10000101b
                         C       IF cpu eq k2526
  E265    11             C      	db	17
                         C       ENDIF
  E266    CDB4           C      	dw	0cdb4h
                         C       IF fdc eq f1715
                         C       ENDIF
                         C       IF fdc eq k5120
                         C       ENDIF
                         C       IF fdc eq k5122
  E268    04             C      	db	00000100b
                         C       ENDIF
  E269    19             C      	db	25
  E26A    FB             C      	db	dtrdyz-(dtrdyw+2)
                         C       IF cpu eq k2526
                         C       ENDIF
                         C       if @write
  E26B    E42E           C      	dw	diwmfm
                         C        IF cpu eq k2526
                         C        ENDIF
                         C        if dsk8fm+dsk8mf
  E26D    1C             C      	db	28
                         C        endif
                         C       endif
                         C      
                         C      ; FM
                         C      ;===
                         C       IF dsk8mf+dsk8fm+dsk5fm ; dsk8fm-Platz immer freihalten wenn danach 5" FM
  E26E    87             C      mdfm8:	db	10000111b
                         C       IF cpu eq k2526
  E26F    06             C      	db	6
                         C       ENDIF
  E270    FFFF           C      	dw	0ffffh
                         C       IF fdc eq f1715
                         C       ENDIF
                         C       IF fdc eq k5120
                         C       ENDIF
                         C       IF fdc eq k5122
  E272    04             C      	db	00000100b
                         C       ENDIF
  E273    FF             C      	db	255
  E274    00             C      	db	0
                         C       IF cpu eq k2526
                         C       ENDIF
                         C       if @write
  E275    E408           C      	dw	diowfm
                         C        IF cpu eq k2526
                         C        ENDIF
                         C        if dsk8fm+dsk8mf
  E277    02             C      	db	2
                         C        endif
                         C       endif
                         C       ENDIF
                         C      
                         C       IF dsk5fm ; kann K5120, K5122 nicht, nur PC1715
                         C       ENDIF
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-95


                         C       ENDIF ;nicht nur 5" MFM
                         C      
                         C      ; Modifizierungstabelle entspr. Sektorlaenge
                         C      
  E278    09             C      dslnmt:	db	dslnl		;Tabellenlaenge
  E279    E19F           C      	dw	fl.tsb		;Anzahl der 128er Bloecke
  E27B    E3D5           C      	dw	diosl1		;Laenge erstes INIR
                         C       IF cpu eq k2526
  E27D    E3E1           C      	dw	dini1+1		;INI oder INIR
  E27F    E3E4           C      	dw	dini2+1
  E281    E3E7           C      	dw	dini3+1
                         C       ENDIF
                         C       if @write
  E283    E45B           C      	dw	diosl2		;Laenge erstes OTIR
                         C        IF cpu eq k2526
  E285    E45E           C      	dw	doti1+1		;OUTI oder OTIR
  E287    E460           C      	dw	doti2+1
  E289    E462           C      	dw	doti3+1
                         C        ENDIF
                         C       endif
  0009                   C      dslnl	equ	($-dslnmt-1)/2	;Tabellenlaenge
                         C      
                         C      ; 128
  E28B    01             C      dsln0:	db	1
                         C       IF cpu eq k2526
  E28C    80 A2 A2 A2    C      	db	128,0a2h,0a2h,0a2h
                         C       ENDIF
                         C       if @write
                         C        IF cpu eq k2526
  E290    80 A3 A3 A3    C      	db	128,0a3h,0a3h,0a3h
                         C        ENDIF
                         C       endif
                         C      
                         C      ; 256
  E294    02             C      dsln1:	db	2
                         C       IF cpu eq k2526
  E295    00 A2 A2 A2    C      	db	0,0a2h,0a2h,0a2h
                         C       ENDIF
                         C       if @write
                         C        IF cpu eq k2526
  E299    00 A3 A3 A3    C      	db	0,0a3h,0a3h,0a3h
                         C        ENDIF
                         C       endif
                         C      
                         C      ; 512
  E29D    04             C      dsln2:	db	4
                         C       IF cpu eq k2526
  E29E    00 A2 A2 B2    C      	db	0,0a2h,0a2h,0b2h
                         C       ENDIF
                         C       if @write
                         C        IF cpu eq k2526
  E2A2    00 A3 A3 B3    C      	db	0,0a3h,0a3h,0b3h
                         C        ENDIF
                         C       endif
                         C      
                         C      ; 1024
  E2A6    08             C      dsln3:	db	8
                         C       IF cpu eq k2526
  E2A7    00 B2 B2 B2    C      	db	0,0b2h,0b2h,0b2h
                         C       ENDIF
                         C       if @write
                         C        IF cpu eq k2526
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-96


  E2AB    00 B3 B3 B3    C      	db	0,0b3h,0b3h,0b3h
                         C        ENDIF
                         C       endif
                         C      
                         C       IF dskds
                         C      ; Modifizierungsadressen fuer Seitenauswahl
  E2AF    09             C      dsidmt:	db	dsidtl		; MFM		 FM
  E2B0    E33A           C      	dw	diom01		;85/81		87/83
                         C       IF cpu eq k2526
  E2B2    E2E6           C      	dw	diom02		;a5/a1		a5/a1
  E2B4    E336           C       	dw	diom03		;b5/b1		b5/b1
  E2B6    E326           C      	dw	diom13		;bd/b9		bd/b9
                         C       ENDIF
                         C       if @write
                         C        IF dsk8fm+dsk5fm
                         C        ENDIF
  E2B8    E434           C      	dw	diom07		;b4/b0		 -
  E2BA    E446           C      	dw	diom08		;b6/b2		 -
  E2BC    E450           C      	dw	diom09		;b4/b0		 -
                         C       endif
  E2BE    E3CD           C      	dw	diom10		;b5/b1		b5/b1
                         C      ;;diom11 muss letztes Byte in der Tabelle sein
  E2C0    E472           C      	dw	diom11		;b5/b1		b5/b1
  0009                   C      dsidtl	equ	($-dsidmt-1)/2
                         C       ENDIF
                         C      	include BIOSDSKP
                         C      ;****************************************************************
                         C      ; Treiber fuer Ansteuerung K5120/K5122 ueber K2526 (mit Hilfsprozessor)
                         C      ; 04.06.87
                         C      ; - Fehlerkorrektur 8" MFM (Taktzeiten)
                         C      ; 25.09.89
                         C      ; - wegen MFS 1.2 nach Transfer b1 (= fault reset) als Standardwert
                         C      ;****************************************************************
                         C      
  E2C2                   C      diorun:
  E2C2    2A E216        C      	ld	hl,(ft.adr)
  E2C5    22 E30E        C      	ld	(diodma),hl
                         C      
                         C      ; physischen Transfer ueber CPU 2 starten
                         C      
  E2C8    21 E309        C      	ld	hl,dio
  E2C9                   C      diortn	equ	$-2
  E2CB    ED 4B 0001     C      	ld	bc,(1)		;retten HS 1
  E2CF    22 0001        C      	ld	(1),hl		;CPU 2 -Routine
  E2D2    3E FE          C      	ld	a,0feh
  E2D4    32 E2F9        C      	ld	(dtrret),a	;stellen Warte-Reaktion
  E2D7    AF             C      	XOR	A
  E2D8    D3 14          C      	OUT	(fldaad),A
  E2DA    D3 04          C      	OUT	(04H),A		;reset CPU 2
  E2DC    3D             C      	dec	a		;Mode 3 (Bit E/A)
  E2DD    D3 17          C      	OUT	(fldabc),A
  E2DF    D3 17          C      	OUT	(fldabc),A	;alles Input
  E2E1    3E B9          C      	ld	a,10111001b	;AMF aus, Fault reset
  E2E3    D3 10          C      	out	(flcoad),a
  E2E5    3E A5          C      	LD	A,10100101b	;Seite einstellen, Mark reset, AMF aktiv
  E2E6                   C      diom02	equ	$-1		;a5/a1
  E2E7    D3 10          C      	OUT	(flcoad),A
  E2E9    3E 7F          C      	LD	A,7FH		;Mode 1
  E2EB    D3 17          C      	OUT	(fldabc),A
  E2ED    DB 16          C      	IN	A,(fldabd)	;CPU2 starten (ueber BUSRQ)
                         C      ; durch die Anfangsinitialisierung der CPU2 vergehen die notwendigen
                         C      ; 100 Mikrosek. fuer Seitenumschaltung
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-97


  E2EF    ED 43 0001     C      	ld	(1),bc		;HS 1 wiederherst.
  E2F3    3A E33A        C      	LD	A,(diom01)	;Lesen Marke
  E2F6    D3 10          C      	OUT	(flcoad),A	;weiter bei CPU2 nach Anfangsinit.
                         C      ; Achtung!! Zur Synchronisation CPU1 und CPU2 keine 2-Byte-Werte
                         C      ; (Adressen) verwenden, da dazwischen BUSRQ auftreten kann und dann
                         C      ; nur ein Byte gesetzt wurde!!
  E2F8    18 FE          C      	jr	$		;auf CPU 2 Ende warten
  E2F9                   C      dtrret	equ	$-1
  E2FA                   C      dtrwjr:
  E2FA    C3 E16A        C      dtrtor:	jp	fl.to1		;time out
  E2FD    C3 E110        C      dtrner:	jp	noerr		;fehlerfrei (Sekt.id)
  E300    C3 E14B        C      dtrnsr:	jp	serrx		;Sektor nicht gefunden
  E303    C3 E12A        C      dtrrdr:	jp	dtrrde		;Read Ende
  E306    C3 E11E        C      dtrwrr:	jp	dtrwre		;Write Ende
                         C      ;--------------------------
                         C      
                         C      
                         C      ; Code CPU 2 fuer phys. Diskettentransfer
                         C      ;========================================
                         C      ; Zeitbedingungen fuer 8" MFM:
                         C      ; 6 Umdrehungen pro Sec bei 2*5208 Bytes pro Spur bedeutet
                         C      ; 1/(6*2*5208), d.h. 16 Mikrosec pro Byte!!
                         C      ; Bei einer Taktfrequenz von (9600*256)=2457600 Hz sind das
                         C      ; (9600*256)/(6*2*5208) Takte, d.h. max. 39 Takte pro Byte!!
                         C      ; Wegen BUSRQ/BUSAK muss davon der laengste Maschinenzyklus
                         C      ; der CPU 1 abgezogen werden, d.h. 6 Takte (Interruptannahme),
                         C      ; weiterhin je ein Takt fuer BUSRQ/BUSAK-Umschaltung,
                         C      ; es verbleiben 31 Takte zwischen den E/A-Maschinenzyklen!!
                         C      
                         C      ; normaler Entry in phys. Diskettentransfer
                         C      ;==========================================
  E309                   C      dio:	
  E309    AF             C      	xor	a		;wiederherstellen 'jr diokl'
  E30A    32 E342        C      	ld	(diomd1+1),a
  E30D    21 0000        C      	ld	hl,0
  E30E                   C      diodma	equ	$-2		;Transferadresse
  E310    3E 00          C      	ld	a,0
  E311                   C      secan1	equ	$-1		;a':=Zahl zu transfer. phys. Sekt.
  E312    08             C      	ex	af,af'
  E313    11 E220        C      	ld	de,crcber	;auf Beginn Datenbyte-/CRC-Vektor
  E316    D9             C      dio2:	exx
  E317    01 00FF        C      	ld	bc,000ffh	;bc':= Spur, Seite
  E318                   C      sidtr	equ	$-2
  E319                   C      sidsid	equ	$-1
  E31A    21 FFFF        C      	ld	hl,0ffffh	;hl':= Sektor, Sektlngflag
  E31B                   C      sidsec	equ	$-2
  E31C                   C      sidlen	equ	$-1
  E31D    11 FEA1        C      	ld	de,0fea1h	;de':= Sektorid-Byte, Kluftbyte
  E320    3E 3C          C      	ld	a,60		;Wiederholungszaehler falscher Sektid.
  E322    32 E23D        C      	ld	(seerc),a	;fuer ersten Sektor stellen
  E325    3E BD          C      diostp:	ld	a,10111101b	;bd/b9, AMF aus, Seite bleibt (>=100 Mikros.)
  E326                   C      diom13	equ	$-1
  E327    D3 10          C      	out	(flcoad),a	;Ende CPU2
  E329    18 12          C      	jr	diogo		;Fortsetzung nach Anfangsinit
                         C      
  E32B                   C      dionss:
  E32B    3E 3C          C      	ld	a,60		;Wiederholungszaehler falscher Sektid.
  E32D    32 E23D        C      	ld	(seerc),a	;fuer naechsten Sektor setzen
  E330                   C      diomr:
  E330    3E 05          C      	ld	a,5		;verhindern unendl. Schleife
  E332    32 E1DE        C      	ld	(fl.zto),a	;bei fehlender Sektor-Marke
  E335    3E B5          C      diomrk:	ld	a,10110101b	;b5/b1 MFM; b5/b1 FM
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-98


  E336                   C      diom03	equ	$-1		;Mark reset, lesen 1
  E337    D3 10          C      	out	(flcoad),a
  E339    3E 85          C      	ld	a,10000101b	;85/81 MFM; 87/83 FM
  E33A                   C      diom01	equ	$-1		;Lesen Marke entspr. Aufzverf.
  E33B    D3 10          C      	out	(flcoad),a
  E33D    DB 16          C      diogo:	in	a,(fldabd)
  E33F    D3 14          C      	out	(fldaad),a
  E341    18 00          C      diomd1:	jr	diomd1+2	;wird modifiziert mit 'jr diotrr',
                         C      				;wenn Sektorid zu lesen
  E343    DB 16          C      diokl:	in	a,(fldabd)
  E345    BB             C      	cp	e		;'A1', d.h. noch in Kluft?
  E346    28 FB          C      	jr	z,diokl		;ja
  E348    BA             C      	cp	d		;'FE', d.h. Sektorbeginn?
  E349    DB 16          C      	in	a,(fldabd)
  E34B    20 E8          C      	jr	nz,diomrk	;nein, weitersuchen
  E34D    B9             C      	cp	c		;Spur ok?
  E34E    DB 16          C      	in	a,(fldabd)
  E350    20 5D          C      	jr	nz,serr		;nein, falscher Sektid.
  E352    B8             C      	cp	b		;Seite ok?
  E353    DB 16          C      	in	a,(fldabd)
  E355    20 58          C      	jr	nz,serr		;nein, falscher Sektid.
  E357    BD             C      	cp	l		;Sektor ok?
  E358    DB 16          C      	in	a,(fldabd)
  E35A    20 53          C      	jr	nz,serr		;nein, falscher Sektid.
  E35C    BC             C      	cp	h		;Sekt-Laengencode?
  E35D    DB 16          C      	in	a,(fldabd)	;**ignorieren CRC Sektid**
  E35F    20 4E          C      	jr	nz,serr		;nein, falscher Sektid.
  E361    D9             C      	exx
  E362    DB 16          C      	in	a,(fldabd)	;**ignorieren CRC Sektid**
  E364    06 11          C      	ld	b,17		;Zahl zu uebergeh. Bytes
  E365                   C      diomd2	equ	$-1		;bei DD auf 17, bei SD auf 6
  E366    DB 16          C      diosyn:	in	a,(fldabd)	;Bytes ignorieren
  E368    10 FC          C      	djnz	diosyn
  E36A    DB 16          C      	in	a,(fldabd)
  E36C    C3 E3C4        C      	jp	diord
  E36D                   C      dioop	equ	$-2		;wird modifiziert entspr. Oper.
                         C      ;				 mit diord, diwmfm, diowfm
                         C      
                         C      ; Entry fuer phys. Treiber zum Lesen Sekt.-Id. auf akt. Spur
                         C      ;===========================================================
  E36F    3E 39          C      diotsr:	ld	a,diotrr-(diomd1+2)	;jr diotrr
  E371    32 E342        C      	ld	(diomd1+1),a	;modifizieren
  E374    01 0316        C      	ld	bc,3*256+fldabd	;Lesen 3 Bytes Sektorid
  E377    21 E21A        C      	ld	hl,ft.trk+1	;dorthin Sektorid hinterlegen
  E37A    18 9A          C      	jr	dio2		;Einsprung in phys. Treiber
  E37C                   C      diotrr:
  E37C    DB 16          C      diotr0:	in	a,(fldabd)
  E37E    BB             C      	cp	e		;'A1', d.h. noch in Kluft?
  E37F    28 FB          C      	jr	z,diotr0	;ja
  E381    BA             C      	cp	d		;'FE', d.h. Sektorbeginn?
  E382    DB 16          C      	in	a,(fldabd)	;wenn ja, so ist das die Spur
  E384    20 AF          C      	jr	nz,diomrk	;nein, weitersuchen
  E386    D9             C      	exx
  E387    ED B2          C      	inir			;Sektorid lesen
  E389    D9             C      	exx
  E38A    6F             C      	ld	l,a		;Spur retten
  E38B    3A E336        C      	ld	a,(diom03)
  E38E    D3 10          C      	out	(flcoad),a	;Lesen 1
  E390    7D             C      	ld	a,l
  E391    B9             C      	cp	c		;richtige Spur?
  E392    28 09          C      	jr	z,diotr1	;ja
  E394    3A E21A        C      	ld	a,(ft.sid)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-99


  E397    90             C      	sub	b		;stimmt side?
  E398    20 0B          C      	jr	nz,diotre	;nein, dies ist kein Sektid.
  E39A    B9             C      	cp	c		;war Spur 0 gefordert?
  E39B    28 23          C      	jr	z,serr2		;ja, nachjustieren (ft.trk steht noch)
  E39D    7D             C      diotr1:	ld	a,l
  E39E    32 E219        C      	ld	(ft.trk),a	;(tatsaechliche) Spur aus Sekt.Id.
  E3A1    3E 03          C      	ld	a,dtrner-dtrwjr	;Reaktionsroutine
  E3A3    18 5D          C      	jr	dioend		;Abschlussbehandlung
  E3A5    D9             C      diotre:	exx
  E3A6    01 0316        C      	ld	bc,3*256+fldabd	;Lesen 3 Bytes Sektorid
  E3A9    21 E21A        C      	ld	hl,ft.trk+1	;dorthin Sektorid hinterlegen
  E3AC    D9             C      	exx
  E3AD    18 07          C      	jr	serr1
                         C      ;---------------------------
                         C      
                         C      ; Fehlerausgaenge
                         C      ;----------------
                         C      ; falscher Sektorid.
  E3AF    DB 16          C      serr:	in	a,(fldabd)
  E3B1    3A E336        C      	ld	a,(diom03)	;Lesen 1
  E3B4    D3 10          C      	out	(flcoad),a
  E3B6    3A E23D        C      serr1:	ld	a,(seerc)
  E3B9    3D             C      	dec	a		;blieb weiterer Versuch?
  E3BA    32 E23D        C      	ld	(seerc),a
  E3BD    C2 E330        C      	jp	nz,diomr	;ja
  E3C0    3E 06          C      serr2:	ld	a,dtrnsr-dtrwjr	;Sektor nicht gefunden
  E3C2    18 3E          C      	jr	dioend
                         C      
                         C      ; Lesen
                         C      ;-------
  E3C4    DB 16          C      diord:	in	a,(fldabd)
  E3C6    06 06          C      	ld	b,6
  E3C8    DB 16          C      diords:	in	a,(fldabd)	;uebergehen Synchron-Bytes
  E3CA    10 FC          C      	djnz	diords
  E3CC    3E B5          C      	ld	a,10110101b	;b5/b1
  E3CD                   C      diom10	equ	$-1
  E3CE    D3 10          C      	out	(flcoad),a	;Lesen 1
  E3D0    3A E33A        C      	ld	a,(diom01)	;85/81 MFM; 87/83 FM
  E3D3    01 8016        C      	ld	bc,128*256+fldabd ;b:=inir-Laenge
  E3D5                   C      diosl1	equ	$-1		  ;   128 bei Sektl 128, sonst =0
  E3D6    D3 10          C      	out	(flcoad),a	;Lesen Marke
  E3D8    DB 16          C      	in	a,(fldabd)	;ignorieren evtl. anstehenden Muell
  E3DA    DB 16          C      diorkl:	in	a,(fldabd)
  E3DC    FE A1          C      	cp	0a1h		;noch in Kluft?
  E3DE    28 FA          C      	jr	z,diorkl	;ja
  E3E0    ED A2          C      dini1:	ini			;Daten lesen
  E3E2    12             C      	ld	(de),a		;Datenbeginn-Byte hinterlegen
  E3E3    ED A2          C      dini2:	ini
  E3E5    13             C      	inc	de
  E3E6    ED A2          C      dini3:	ini
  E3E8    ED B2          C      	inir
  E3EA    EB             C      	ex	de,hl
  E3EB    ED A2          C      	ini			;CRC Daten
  E3ED    ED A2          C      	ini
  E3EF    3A E472        C      	ld	a,(diom11)	;b1 fuer MFS 1.2 Fault reset, sonst b5/b1
  E3F2    D3 10          C      	out	(flcoad),a	;Lesen 1
  E3F4    EB             C      	ex	de,hl
  E3F5    3E 09          C      	ld	a,dtrrdr-dtrwjr	;Reaktionsroutine Read Ende
                         C      
                         C      ; naechsten Sektor behandeln
                         C      ;---------------------------
  E3F7    08             C      dions:	ex	af,af'		;Zahl zu uebertr. Sektoren
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-100


  E3F8    3D             C      	dec	a
  E3F9    28 06          C      	jr	z,dionse	;=0, fertig
  E3FB    08             C      	ex	af,af'
  E3FC    D9             C      	exx
  E3FD    2C             C      	inc	l		;Sektor+1
  E3FE    C3 E32B        C      	jp	dionss
  E401    08             C      dionse:	ex	af,af'
                         C      
                         C      ; Abschlussbehandlung
                         C      ;--------------------
  E402                   C      dioend:
  E402    32 E2F9        C      	ld	(dtrret),a	;Reaktionsroutine hinterlegen
  E405    C3 E325        C      	jp	diostp		;Stop CPU2
                         C      
                         C       IF @write
                         C      
                         C       IF dsk8fm+dsk8mf+dsk5fm
                         C      
                         C      ; Schreiben FM
                         C      ;-------------
  E408    DB 16          C      diowfm:	in	a,(fldabd)
  E40A    EB             C      	ex	de,hl
  E40B    DB 16          C      	in	a,(fldabd)
  E40D    01 A410        C      	ld	bc,10100100b*256+flcoad
  E40F                   C      diom04	equ	$-1		;a4/a0
  E410    DB 16          C      	in	a,(fldabd)
  E412    ED 41          C      	out	(c),b		;Schreiben FM Daten ein
  E414    DB 16          C      	in	a,(fldabd)
  E416    AF             C      	xor	a
  E417    D3 14          C      	out	(fldaad),a	;6*'00'
  E419    01 0414        C      	ld	bc,4*256+fldaad
  E41C    D3 14          C      diowfs:	out	(fldaad),a
  E41E    10 FC          C      	djnz	diowfs
  E420    3E B6          C      	ld	a,10110110b
  E421                   C      diom05	equ	$-1		;b6/b2
  E422    ED 41          C      	out	(c),b
  E424    D3 10          C      	out	(flcoad),a	;schreiben FM Marke ein
  E426    3E A4          C      	ld	a,10100100b
  E427                   C      diom06	equ	$-1		;a4/a0
  E428    ED A3          C      	outi			;'FB'	
  E42A    D3 10          C      	out	(flcoad),a	;schreiben FM Daten ein
  E42C    18 2C          C      	jr	diowrt
                         C       ENDIF
                         C      
                         C      
                         C      ; Schreiben  MFM
                         C      ;---------------
  E42E    DB 16          C      diwmfm:	in	a,(fldabd)
  E430    DB 16          C      	in	a,(fldabd)
  E432    01 B410        C      	ld	bc,10110100b*256+flcoad
  E434                   C      diom07	equ	$-1		;b4/b0
  E435    DB 16          C      	in	a,(fldabd)
  E437    ED 41          C      	out	(c),b		;Schreiben MFM normal
  E439    DB 16          C      	in	a,(fldabd)
  E43B    AF             C      	xor	a
  E43C    D3 14          C      	out	(fldaad),a	; 1*'00'
  E43E    01 0A14        C      	ld	bc,10*256+fldaad
  E441    D3 14          C      diwmfs:	out	(fldaad),a	;10*'00'
  E443    10 FC          C      	djnz	diwmfs
  E445    3E B6          C      	ld	a,10110110b
  E446                   C      diom08	equ	$-1		;b6/b2
  E447    ED 41          C      	out	(c),b		; 1*'00'
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-101


  E449    D3 10          C      	out	(flcoad),a	;Schreiben MFM Marke
  E44B    06 A1          C      	ld	b,0a1h
  E44D    ED 41          C      	out	(c),b		;3*'A1'
  E44F    3E B4          C      	ld	a,10110100b
  E450                   C      diom09	equ	$-1		;b4/b0
  E451    ED 41          C      	out	(c),b
  E453    EB             C      	ex	de,hl
  E454    ED 41          C      	out	(c),b
  E456    D3 10          C      	out	(flcoad),a	;Schreiben MFM normal
  E458    ED A3          C      	outi			;'FB'
                         C      
  E45A    06 80          C      diowrt:	ld	b,128		;Laenge erster OTIR-Block
  E45B                   C      diosl2	equ	$-1		;128 bei Sektl 128, sonst 0
  E45C    EB             C      	ex	de,hl
  E45D    ED A3          C      doti1:	outi			;Daten ausgeben
  E45F    ED A3          C      doti2:	outi
  E461    ED A3          C      doti3:	outi
  E463    ED B3          C      	otir
  E465    EB             C      	ex	de,hl
  E466    ED A3          C      	outi			;CRC Daten
  E468    AF             C      	xor	a
  E469    ED A3          C      	outi
  E46B    06 14          C      diowm1:	ld	b,20		;Anzahl der Nach-Null-Bytes
                         C      				;5" MFM/FM: 20; 8" MFM/FM: 2
  E46D    D3 14          C      diow00:	out	(fldaad),a	;'00'
  E46F    10 FC          C      	djnz	diow00
  E471    3E B1          C      	ld	a,10110001b	;b1 fuer MFS 1.2 Fault reset, sonst b5/b1
  E472                   C      diom11	equ	$-1
  E473    D3 10          C      	out	(flcoad),a	;Schreiben aus, Lesen 1
  E475    EB             C      	ex	de,hl
  E476    3E 0C          C      	ld	a,dtrwrr-dtrwjr	;Schreiben OK Reaktion
  E478    C3 E3F7        C      	jp	dions		;naechster Sektor
                         C      
                         C      	ENDIF	;@write
                                 ENDIF
                                 IF hdsk
                                 ENDIF
                                 IF oss
                                 ENDIF
                                 IF em256
                         C      	include BIOSREM		;RAM-Floppy mit EM256
                         C      ;********************************************************
                         C      ;	RAM-Floppy mit EM256 Erweiterungsmodul (16 Bit mit U8000)
                         C      ; Version 15.05.87
                         C      ;********************************************************
                         C      
                         C       if1
                         C       endif ;if1
                         C      
                         C      ;**************************************************************
                         C      ;	Schreiben RAM-Floppy
                         C      ;**************************************************************
  E47B                   C      wrramf:
  E47B    2A DF11        C      	ld 	hl,(ddma)
  E47E    01 0080        C      	ld 	bc,128		;128 Byte von DMA nach Puffer
  E481    11 F2B9        C      	ld 	de,dmabuf
  E484    ED B0          C      	ldir
  E486    3A DF0C        C      	ld	a,(dtrack)
  E489    CD E4C1        C      	call 	ramon		;Testram / EM256 zuschalten
  E48C    C5             C      	push 	bc
  E48D    EB             C      	ex 	de,hl
  E48E    01 0080        C      	ld 	bc,128
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-102


  E491    21 F2B9        C      	ld 	hl,dmabuf	;128 byte von Puffer nach RAM-Floppy
  E494    ED B0          C      	ldir
  E496    C1             C      	pop 	bc
  E497    CD E4F4        C      	call	ramoff
                         C      	IF	em256
  E49A    3A E519        C      	ld	a,(parerr)
                         C      	ENDIF
  E49D    C9             C      	ret
                         C      
                         C      ;**************************************************************
                         C      ;	Lesen RAM-Floppy
                         C      ;**************************************************************
                         C      
  E49E                   C      rdramf:
  E49E    3A DF0C        C      	ld	a,(dtrack)
  E4A1    CD E4C1        C      	call 	ramon		;Testram aktivieren
  E4A4    C5             C      	push 	bc
  E4A5    01 0080        C      	ld 	bc,128		;128 Byte 
  E4A8    11 F2B9        C      	ld 	de,dmabuf	;nach Puffer
  E4AB    ED B0          C      	ldir
  E4AD    C1             C      	pop 	bc
  E4AE    CD E4F4        C      	call 	ramoff		;Testram abschalten
  E4B1    21 F2B9        C      	ld 	hl,dmabuf	;von Puffer nach DMA uebertragen
  E4B4    01 0080        C      	ld 	bc,128
  E4B7    ED 5B DF11     C      	ld 	de,(ddma)
  E4BB    ED B0          C      	ldir
                         C      	IF	em256
  E4BD    3A E519        C      	ld	a,(parerr)
                         C      	ENDIF
  E4C0    C9             C      	ret
                         C      
                         C      ;********************************************************************
                         C      ;	Unterprogramme fuer RAM-Floppy
                         C      ;********************************************************************
                         C      
                         C      ;Routinen fuer EM256-RAM-Floppy
                         C      ;==============================
                         C      ;
                         C      ;Aktivieren / Deaktivieren der RAM des EM256
                         C      ;Eintritt: <A> - Tracknummer, <dsectr> - Sektornummer
                         C      ;Austritt: <DE>- Anfangsadresse des Sektors
                         C      ;
  E4C1    57             C      ramon:	ld	d,a		;<a>=  0  0 S1 S0 P3 P2 P1 P0
  E4C2    0F             C      	rrca			;          Segment   Page   
  E4C3    0F             C      	rrca
  E4C4    0F             C      	rrca
  E4C5    0F             C      	rrca			;<a>= P3 P2 P1 P0  0  0 S1 S0
  E4C6    E6 3F          C      	and	3fh		;   =  0  0 P1 P0  0  0 S1 S0
  E4C8    F6 40          C      	or	high(hbemadr)	;   = H3 H2 P1 P0  0  0 S1 S0
  E4CA    47             C      	ld	b,a		;H3,H2 sind ext. Adresse!!
  E4CB    7A             C      	ld	a,d
  E4CC    2F             C      	cpl
  E4CD    E6 0C          C      	and	0ch		;<a>=  0  0  0  0 /P3/P2  0  0
  E4CF    B0             C      	or	b		;   = H3 H2 P1 P0 /P3/P2 S1 S0
  E4D0    47             C      	ld	b,a		;Low-Nibble gleichgueltig (retten)
  E4D1    0E AF          C      	ld 	c,modadr+7	;Adressierung 16*4-RAM
  E4D3    E6 0C          C      	and	0ch		;<a>=  0  0  0  0 /P3/P2  0  0     
                         C      				;EM256 erkennt sich auf em256adr
                         C      				;Write enable, Page enable
  E4D5    ED 79          C      	out	(c),a
  E4D7    78             C      	ld	a,b
  E4D8    E6 03          C      	and	3		;Segmentnummer
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-103


  E4DA    F6 10          C      	or	1 shl reset16	;U8000-Reset, RAM-Enable
  E4DC    D3 A9          C      	out	(modadr+1),a	;RAM scharf
  E4DE    78             C      	ld	a,b
  E4DF    E6 F0          C      	and	0f0h
  E4E1    57             C      	ld 	d,a		;Page erscheint auf Adr. in DE
  E4E2    AF             C      	xor 	a
  E4E3    5F             C      	ld	e,a
  E4E4    32 E519        C      	ld	(parerr),a	;Paritaetsfehler reset
  E4E7    3A DF0E        C      	ld	a,(dsectr)	;offset aus Sektornummer berechnen
  E4EA    3D             C      	dec	a
  E4EB    67             C      	ld 	h,a
  E4EC    2E 00          C      	ld	l,0
  E4EE    CB 3C          C      	srl	h
  E4F0    CB 1D          C      	rr	l		
  E4F2    19             C      	add	hl,de		;Offset zu Track(Page)Adresse addieren
  E4F3    C9             C      	ret
  E4F4    78             C      ramoff:	ld a,b
  E4F5    E6 0C          C      	and	0ch
  E4F7    F6 03          C      	or	1 shl n_pagen or 1 shl n_write	;page disable, write disable
  E4F9    ED 79          C      	out 	(c),a
  E4FB    3E 14          C      	ld	a,1 shl reset16 or 1 shl n_ramen
  E4FD    D3 A9          C      	out	(modadr+1),a
  E4FF    C9             C      	ret
                         C      
  E500    32 E518        C      parrou:	ld	(rettea),a	;Interruptbedienung Paritaetsfehler
  E503    3E 01          C      	ld	a,1		;benoetigt keinen eigenen Stack
  E505    32 E519        C      	ld	(parerr),a	;Kennung Fehler
  E508    DB A9          C      	in	a,(modadr+1)
  E50A    CB F7          C      	set	prreset,a
  E50C    D3 A9          C      	out	(modadr+1),a	;Fehler ruecksetzen
  E50E    CB B7          C      	res	prreset,a
  E510    D3 A9          C      	out	(modadr+1),a
  E512    3A E518        C      	ld	a,(rettea)
  E515    FB             C      	ei
  E516    ED 4D          C      	reti
                         C      
  E518    00             C      rettea:	db	0		;A bei Parityinterrupt
  E519    00             C      parerr:	db	0		;Paritaetsfehlerspeicher
                         C      
                         C      
                         C      ;*************************************************************
                         C      ; Steuertabellen fuer RAM-Floppy
                         C      ;*************************************************************
                         C      
  E51A                   C      dphem:
  E51A    0000           C      dphm:	dw	0	;kein Sektorversatz
  E51C    0000 0000      C      	dw	0,0,0
  E520    0000           C      
  E522    F0E9           C      	dw	dirbuf
  E524    E52A 0000      C      	dw	dpbem,0,alvem
  E528    F299           C      
                         C      
  E52A                   C      dpbem:
  E52A    0020           C      dpbm:	dw	32	;Recs per Track
  E52C    03 07 00       C      	db	3,7,0	;1k-BDOS-Bloecke 
  E52F    00FF           C      	dw	256-1	;256k
  E531    003F           C      	dw	64-1	;64 Dir-.Eintraege
  E533    C0 00          C      	db	0c0h,0	;Alloc. fuer 64 Dir.
  E535    0000           C      	dw	0	;kein check
  E537    0000           C      	dw	0	;Offset: keine Systemspuren
  E539    80             C      	db	80h	;kein Disketten-DPB
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-104


  E51A                   C      dpham	aset	dphm		;definieren LW "M:"
                                 ENDIF
                                 IF mkd256
                                 ENDIF
                                 IF kes
                                 ENDIF
                                 IF raf
                                 ENDIF
                                 IF rna
                                 ENDIF
                                
                         C      	include BIOSTIM
                         C      ;*************************************************************
                         C      ;	Zeitgeberdienst
                         C      ; 15.06.88
                         C      ; - BAB2 als Standard
                         C       IF cpu eq c1715
                         C       ENDIF
                         C      ; - zusaetzliche Laufwerksabschaltung ueber Zeittakt eingefuehrt
                         C      ; - Abfrage von 'synsem' in 1-sec-Interrupt entfernt (kein setbs/setram notw.)
                         C      ; 24.09.88
                         C      ; - Bildschirmpuffer kann ausserhalb des normalen RAM's liegen
                         C      ; 09.10.88
                         C      ; - Pflege der Statuszeile nur bei stzaus=0
                         C      ; 23.12.88
                         C      ; - Einbau der Pflege des Datums
                         C      ; 07.01.89
                         C      ; - Tastaturpolling nur wenn Zugriff zur Statuszeile erlaubt
                         C      ; 20.03.89
                         C      ; - Laufwerksabschaltung ueber Zeittakt nur bei FDC K5120/22 und F1715
                         C      ;*************************************************************
                         C      
                         C       IF1
                         C       ENDIF
                         C      
                         C      ; 5ms/25ms an
  E53A                   C      tim5on:
                         C       IF cpu eq c1715
                         C       ENDIF
  E53A    3E B1          C      	ld	a,10110001b
                         C      	;int./zeitg./vort.256/pos.flanke/naechst.zykl./keine zk/weiter/1
  E53C    F3             C      tim5ot:	DI
  E53D    D3 0E          C      	out	(sysctc+tim5ct),a
  E53F    FB             C      	EI
  E540    C9             C      ret:	ret
                         C      
                         C      ; 5ms/25ms aus
  E541                   C      tim5of:
                         C       IF cpu eq c1715
                         C       ENDIF
  E541    3E 31          C      	ld	a,00110001b	;kein int./...
  E543    18 F7          C      	jr	tim5ot
                         C      
                         C       IF cpu eq c1715
                         C       ELSE
                         C      ; 1s an
  E545    3E D1          C      tim1on:	ld	a,11010001b
                         C      	;int./zaehler//pos.flanke//keine zk/weiter/1
  E547    F3             C      tim1ot:	DI
  E548    D3 0F          C      	out	(sysctc+tim1ct),a
  E54A    FB             C      	EI
  E54B    C9             C      	ret
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-105


                         C      ; 1s aus
  E54C    3E 51          C      tim1of:	ld	a,01010001b	;kein int./...
  E54E    18 F7          C      	jr	tim1ot
                         C       ENDIF
                         C      
                         C      ; Interr.routine 5ms/25ms
  E550                   C      tim5it:
                         C       IF stpvar or monitor
  E550    22 E558        C      	ld	(t5ihl),hl	;retten hl
  E553    21 E6B4        C      	ld	hl,chksp	;Test auf haengende Spezialfktnen
  E556    E5             C      	push	hl		;nach const-Aufruf in CTC-Interrupt
  E557    21 0000        C      	ld	hl,0		;wiederherstellen hl
  E558                   C      t5ihl	equ	$-2
                         C       ENDIF
  E55A    ED 73 E579     C      	ld	(intsp),sp
  E55E    31 F0E9        C      	ld	sp,intstk
  E561    F5             C      	push	af
  E562    E5             C      	push	hl
  E563    D5             C      	push	de
  E564    C5             C      	push	bc
  E565    2A 0041        C      	ld	hl,(tim5cn)
  E568    23             C      	inc	hl
  E569    22 0041        C      	ld	(tim5cn),hl
                         C       IF cpu eq c1715
                         C       ENDIF
  E56C    3A CF3D        C      	ld	a,(synflg)
  E56F    CB 77          C      	bit	stzaus,a	;Zugriff zur Statuszeile erlaubt?
  E571    CC D071        C      intkbd:	call	z,kbdsti	;ja, Tastatur abfragen und puffern
                         C      				;auf 'ld hl,.. .' waehrend Lampen-Ausgabe
  E574                   C      intrbc:				;allg. Interr.-ausgang
  E574    C1             C      	pop	bc
  E575    D1             C      	pop	de
  E576                   C      intrhl:				;allg. Interr.-ausgang
  E576    E1             C      	pop	hl
  E577                   C      intraf:				;allg. Interr.-ausgang
  E577    F1             C      	pop	af
  E578    31 0000        C      	ld	sp,0
  E579                   C      intsp	equ	$-2
  E57B                   C      intret:				;allg. Interr.-ausgang
  E57B    FB             C      	ei
  E57C    ED 4D          C      	reti
                         C      
                         C       IF cpu ne c1715
                         C      ; Interr.routine 1s
  E57E    ED 73 E579     C      tim1it:	ld	(intsp),sp
  E582    31 F0E9        C      	ld	sp,intstk
  E585    F5             C      	push	af
  E586    E5             C      	push	hl
  E587    D5             C      	push	de
  E588    C5             C      	push	bc
  E589    CD E58E        C      	call	tim1up
  E58C    18 E6          C      	jr	intrbc
                         C       ENDIF
                         C      
                         C      ; Reaktionsroutine fuer 1 sec Interrupt
  E58E    2A 0043        C      tim1up:	ld	hl,(tim1cn)
  E591    2B             C      	dec	hl
  E592    22 0043        C      	ld	(tim1cn),hl
                         C       IF uhrvar
                         C      ;1 Sec. BCD-Uhr verwalten
  E595    06 03          C      	ld	b,3		;HH:MM:SS
  E597    21 0052        C      	ld	hl,bcduhr+2	;auf SS
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-106


  E59A    18 07          C      	jr	t1uhr1		;Einsprung in Zyklus
  E59C    FE 60          C      t1uhr2:	cp	60h		;Uebertrag?
  E59E    38 0E          C      	jr	c,t1uhre	;nein
  E5A0    36 00          C      	ld	(hl),0
  E5A2    2B             C      	dec	hl
  E5A3    7E             C      t1uhr1:	ld	a,(hl)
  E5A4    C6 01          C      	add	a,1		;kein "inc"-Befehl!
  E5A6    27             C      	daa
  E5A7    10 F3          C      	djnz	t1uhr2		;Sec., Min. haben 60
  E5A9    FE 24          C      	cp	24h		;Std. haben 24
  E5AB    38 01          C      	jr	c,t1uhre	;kein Uebertrag
  E5AD    AF             C      	xor	a		;A:=0, nc fuer Datumuebertrag einstellen
  E5AE    77             C      t1uhre:	ld	(hl),a
                         C        IF datvar
                         C        ENDIF
                         C       ENDIF
  E5AF    3A E571        C      	ld	a,(intkbd)	;lampen aktiv?
  E5B2    FE 21          C      	cp	021h		;  call-Befehl oder ld hl,...
  E5B4    C4 D1CA        C      	call	nz,lampen	;nein, Aktualisierung Lampen
                         C      
  E5B7    21 E608        C      intcrt:	ld	hl,tim1uu	;auf jp,... waehrend conout
                         C      
                         C       IF cpastz or uhrvar
  E5BA    3A CF3D        C      	ld	a,(synflg)
  E5BD    CB 77          C      	bit	stzaus,a	;Pflege der Statuszeile?
  E5BF    20 47          C      	jr	nz,nt1stz	;nein
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
                         C       IF uhrvar
                         C      ; Uhr anzeigen
  E5C1    21 0050        C      	ld	hl,bcduhr
                         C       IF crtbfl ;Bildschirmpuffer liegt im adressierbaren RAM
                         C        IF cpastz
  E5C4    11 FFB9        C      	ld	de,statz2+statzu
  E5C5                   C      bsuhr	equ	$-2		;BS-Puffer-Adr. fuer Uhr
                         C        ENDIF
                         C       ENDIF
  E5C7    06 03          C      	ld	b,3
  E5C9    18 04          C      	jr	t1uhr4		;Einsprung in Zyklus
  E5CB    3E 3A          C      t1uhr3:	ld	a,':'
  E5CD    12             C      	ld	(de),a
  E5CE    13             C      	inc	de
  E5CF    CD E798        C      t1uhr4:	call	mbreco
  E5D2    23             C      	inc	hl
  E5D3    10 F6          C      	djnz	t1uhr3
                         C        IF crtbfl
  E5D5                   C      t1uhrn:
                         C        ENDIF
                         C       ENDIF
                         C      
                         C       IF cpastz
                         C      ; Default-LW, User in Statuszeile
  E5D5    3A 0004        C      	ld	a,(defaul)
  E5D8    F5             C      	push	af
  E5D9    E6 0F          C      	and	0fh		;User loeschen
  E5DB    C6 41          C      	add	a,'A'
                         C        IF crtbfl ;Bildschirmpuffer liegt im adressierbaren RAM
  E5DD    11 FF81        C      	ld	de,statz2+statzd
  E5DE                   C      crtm27	equ	$-2		;BS-Puffer-Adr
                         C        ENDIF
  E5E0    12             C      	ld	(de),a		;anzeigen default-LW
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-107


  E5E1    F1             C      	pop	af
  E5E2    13             C      	inc	de
  E5E3    CD E79C        C      	call	mrecol		;anzeigen user
                         C      
                         C      ; I/O-Byte in Statuszeile
  E5E6    3A 0003        C      	ld	a,(iobyte)
                         C       IF crtbfl ;Bildschirmpuffer liegt im adressierbaren RAM
  E5E9    11 FFA0        C      	ld	de,statz2+statzi
  E5EA                   C      crtm38	equ	$-2
                         C       ENDIF
  E5EC    CD E799        C      	call	mrecoa
                         C      
                         C      ; Lampen-Byte in Statuszeile
  E5EF    3A 0040        C      	ld	a,(lampbf)
                         C       IF crtbfl ;Bildschirmpuffer liegt im adressierbaren RAM
  E5F2    11 FFA4        C      	ld	de,statz2+statzl
  E5F3                   C      crtm39	equ	$-2
                         C       ENDIF
  E5F5    CD E799        C      	call	mrecoa
                         C      
                         C       ENDIF ;cpastz
                         C      
                         C       IF cpastz or uhrvar
                         C        IF crtbfl eq 0 ;Bildschirmpuffer liegt nicht im adressierbaren RAM
                         C        ENDIF ;crtbfl eq 0
                         C       ENDIF ;cpastz or uhrvar
                         C      
                         C       IF cpastz
                         C      ; wenn Anzeigezeit um, so BIOS-Meldung wieder loeschen
  E5F8    21 E789        C      	ld	hl,stzbto	;Anzeigezeit in Sekunden
  E5FB    35             C      	dec	(hl)		;abgelaufen?
  E5FC    20 0A          C      	jr	nz,nstzcl	;nein
  E5FE    06 11          C      	ld	b,stzbl
  E600    21 FFA7        C      	ld	hl,statz2+statzb
  E601                   C      crtm28	equ	$-2		;BS-Puffer-Adr.
  E603    36 20          C      stzclz:	ld	(hl),' '
  E605    23             C      	inc	hl
  E606    10 FB          C      	djnz	stzclz
  E608                   C      nstzcl:
                         C       .comment % wegen Stoerungen auf dem Bildschirm bei Arbeit ohne Wait abgeklemmt
                         C        IF crt eq dsy5
                         C      ; Statuszeile invertieren
                         C      	ld	hl,statz2+statzd
                         C      	ld	b,statzt-statzd	;bis vor Tastaturpuffer
                         C      stzinv:	set	7,(hl)
                         C      	inc	hl
                         C      	djnz	stzinv	
                         C        ENDIF
                         C      %
                         C       ENDIF ;cpastz
                         C      
                         C       IF cpastz or uhrvar
                         C        IF crtbfl eq 0 ;Bildschirmpuffer liegt nicht im adressierbaren RAM
                         C        ENDIF
  E608                   C      nt1stz:
                         C       ENDIF
                         C      
  E608                   C      tim1uu:
                         C       IF disknb ne 0
                         C        IF (fdc eq K5120) or (fdc eq K5122) or (fdc eq f1715)
                         C      ; zusaetzliche Laufwerksabschaltung ueber Zeittakt
  E608    3A E1E6        C      	ld	a,(pretx+1)	;Motorabschaltung unterdrueckt?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-108


  E60B    B7             C      	or	a
  E60C    28 0E          C      	jr	z,t1nmo1	;ja
  E60E    3A E1DE        C      	ld	a,(fl.zto)	;pro Sekunde 5 Umdrehungen
  E611    D6 04          C      	sub	4		;noch >= 4* 200ms Zeit?
  E613    30 01          C      	jr	nc,t1nmo2	;ja
  E615    AF             C      	xor	a
  E616    32 E1DE        C      t1nmo2:	ld	(fl.zto),a
  E619    CC E1F8        C      	call	z,headup	;Ueberw.zeit abgelaufen -> Motor aus
  E61C                   C      t1nmo1:
                         C        ENDIF
                         C       ENDIF
  E61C    2A 0045        C      	ld	hl,(tim1rt)	;Adresse der Nutzerroutine
  E61F    E9             C      	jp	(hl)		;1-sec-Nutzerroutine ausfuehren, ret
                         C      
                         C       IF cpastz or uhrvar
                         C        IF crtbfl eq 0
                         C        ENDIF
                         C       ENDIF
                                
                                 IF	mprot
                                 ENDIF
                                
                                 IF	monitor
                                 ENDIF
                                
                         C      	include BIOSNUC
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      ; Zentrale BIOS-Kompenenten
                         C      ; - rst 38h fuehrt bei Monitor zu seinem Aufruf, sonst Warmstart
                         C      ; - Nachladen CCP aus RAM-Floppy vereinheitlicht (unabh. von RAM-Floppy)
                         C      ; - synflg hinter BIOS-Sprungvektor fuer Modifizierung von aussen
                         C      ; - Verwendung der Interruptsaeule in Generierungsteil verlagert
                         C      ; 25.09.88
                         C      ; - Streichen des Tastaturpuffers in Tastaturstatus
                         C      ; 09.10.88
                         C      ; - Pflege der Statuszeile nur bei stzaus=0
                         C      ; 11.01.89
                         C      ; - Variante wbootv=4 (@CCP.COM) eingefuehrt
                         C      ; 17.05.89
                         C      ; - Generierung ohne LW A moeglich
                         C      ; 05.06.89
                         C      ; - Unterstuetzung NANOS-RAF
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      
                         C       IF iobvar
                         C      ;Verteiler fuer die 1-Zeichen-Kanaele entsprechend IOBYTE:
                         C      ;=========================================================
                         C      
  E620                   C      const:			; iobyte  00 00 00 xx
  E620    CD E680        C      	call	iodisp
  E623    07             C      	db	7
  E624    D069           C      	dw	kbdst		;0 kbd:
  E626    D069           C      	dw	kbdst		;1 kbd:
  E628    E644           C      	dw	reades		;2 rdr:
  E62A    D7A8           C      	dw	uc1st		;3 uc1: (liefert, ob Z. da)
                         C      
  E62C                   C      conin:			; iobyte:  00 00 00 xx
  E62C    CD E680        C      	call	iodisp
  E62F    07             C      	db	7
  E630    D101           C      	dw	kbdi		;0 kbd:
  E632    D101           C      	dw	kbdi		;1 kbd:
  E634    E650           C      	dw	reader		;2 rdr:
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-109


  E636    D7D7           C      	dw	uc1i		;3 uc1: (wartet, bis Z. da)
                         C      
  E638                   C      conout:			; iobyte:  00 00 00 xx
  E638    CD E680        C      	call	iodisp
  E63B    07             C      	db	7
  E63C    D36E           C      	dw	crto		;0 crt:
  E63E    D04C           C      	dw	dumo		;1 dum:
  E640    E65C           C      	dw	punch		;2 pun:
  E642    D605           C      	dw	uc1o		;3 uc1: (wartet, bis frei)
                         C      
  E644                   C      reades:			; iobyte:   00 00 xx 00
  E644    CD E680        C      	call	iodisp
  E647    01             C      	db	1
  E648    D069           C      	dw	kbdst		;0 kbd:
  E64A    D046           C      	dw	dumst		;1 dum:
  E64C    D046           C      	dw	dumst		;2 dum:
  E64E    D7A8           C      	dw	uc1st		;3 uc1: (liefert, ob Z. da)
                         C      
  E650                   C      reader:			; iobyte:   00 00 xx 00
  E650    CD E680        C      	call	iodisp
  E653    01             C      	db	1
  E654    D101           C      	dw	kbdi		;0 kbd:
  E656    D049           C      	dw	dumi		;1 dum:
  E658    D049           C      	dw	dumi		;2 dum:
  E65A    D7D7           C      	dw	uc1i		;3 uc1: (wartet, bis Z. da)
                         C      
                         C      
  E65C                   C      punch:			; iobyte:   00 xx 00 00
  E65C    CD E680        C      	call	iodisp
  E65F    03             C      	db	3
  E660    D36E           C      	dw	crto		;0 crt:
  E662    D04C           C      	dw	dumo		;1 dum:
  E664    E674           C      	dw	list		;2 lst:
  E666    D605           C      	dw	uc1o		;3 uc1: (wartet, bis frei)
                         C      
                         C      
  E668                   C      listst:			; iobyte:  xx 00 00 00
  E668    CD E680        C      	call	iodisp
  E66B    05             C      	db	5
  E66C    D66B           C      	dw	ttyst		;0 tty:
  E66E    D046           C      	dw	crtst		;1 crt:
  E670    D671           C      	dw	lptst		;2 lpt:
  E672    D046           C      	dw	dumst		;3 dum:
                         C      
  E674                   C      list:			; iobyte:  xx 00 00 00
  E674    CD E680        C      	call	iodisp
  E677    05             C      	db	5
  E678    D5F9           C      	dw	ttyo		;0 tty:
  E67A    D36E           C      	dw	crto		;1 crt:
  E67C    D5FF           C      	dw	lpto		;2 lpt:
  E67E    D04C           C      	dw	dumo		;3 dum:
                         C      
                         C      
                         C      ; IOBYTE-Auswertung - Verteilung auf die physischen Geraete
                         C      ; ---------------------------------------------------------
                         C      ; A,HL werden zerstoert
                         C      ; Anwender-IX wird gerettet, darf von Treiber-Routine zerstoert werden
                         C      ; damit kann Treiber auch aus Interrupt-Routine aufgerufen werden
                         C      
  E680                   C      iodisp:
  E680    E1             C      	pop	hl
  E681    C5             C      	push	bc
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-110


  E682    46             C      	ld	b,(hl)
  E683    23             C      	inc	hl
  E684    3A 0003        C      	ld	a,(iobyte)
  E687    0F             C      iodis1: rrca
  E688    10 FD          C      	djnz	iodis1
  E68A    E6 06          C      	and	6
  E68C    4F             C      	ld	c,a
  E68D    09             C      	add	hl,bc
  E68E    7E             C      	ld	a,(hl)
  E68F    23             C      	inc	hl
  E690    66             C      	ld	h,(hl)
  E691    6F             C      	ld	l,a
  E692    C1             C      	pop	bc
  E693    DD E5          C      	push	ix		;retten Anwender-IX
  E695    CD E76C        C      	call	callhl
  E698    DD E1          C      	pop	ix		;wiederherstellen Anwender-IX
  E69A    C9             C      	ret
                         C      
                         C       ENDIF
                         C      
                         C      ;************************************************************
                         C      ;	Spezialroutinen
                         C      ;************************************************************
                         C      
                         C      	IF	monitor
                         C      	ENDIF
                         C      
                         C      
                         C      ; Arbeit mit asynchronen Sonderaktionen
                         C      ;======================================
                         C      ; Die folgenden beiden Routinen werden vom BIOS immer dann aufgerufen,
                         C      ; wenn wegen zeitkritischer (z.B. Floppy-Bedienung) oder anderer
                         C      ; BIOS-Arbeit (z.B. Bildschirmrollen) keine parallelen Sonderaktionen
                         C      ; erlaubt sind.
                         C      
                         C      ; Reg A bleibt erhalten
  E69B    F5             C      delsps: push	af
  E69C    2A 004A        C      	ld	hl,(kritbg)	;evtl. Nutzerroutine fuer Beginn krit. BIOS
  E69F    CD E76C        C      	call	callhl		;aufrufen
  E6A2    F1             C      	pop	af
  E6A3    21 CF3E        C      	ld	hl,synsem	;Verzoegern Sonderaktionen
  E6A6    34             C      	inc	(hl)
  E6A7    C9             C      	ret
                         C      
                         C      ; Reg A bleibt erhalten
  E6A8    F5             C      delspr: push	af
  E6A9    2A 004C        C      	ld	hl,(kriten)	;evtl. Nutzerroutine fuer Ende krit. BIOS
  E6AC    CD E76C        C      	call	callhl		;aufrufen
  E6AF    F1             C      	pop	af
  E6B0    21 CF3E        C      	ld	hl,synsem	;Zulassen Sonderaktionen
  E6B3    35             C      	dec	(hl)
                         C      
                         C       IF stpvar or monitor
                         C      
                         C      ; Test auf zwischenzeitliche Anforderung von Sonderroutinen
                         C      ;----------------------------------------------------------
                         C      
                         C      ; Diese Routine wird nach dem Lesen eines Tastaturzeichens
                         C      ; als "Ohr" eingeschoben, bevor zur eigentlichen Interrupt-
                         C      ; adresse zurueckgekehrt wird. Sie wird nicht innerhalb der
                         C      ; Interruptroutine ausgefuehrt, um mit offenen Interrupts
                         C      ; arbeiten zu koennen.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-111


                         C      ; maximale Stackbelastung nach RETI von Interruptroutinen:
                         C      ; -	Return-Adresse zum Nutzer
                         C      ; -	AF
  E6B4    F3             C      chksp:	di
  E6B5    F5             C      	push	af		;A und F Reg retten
  E6B6    3A CF3E        C      	ld	a,(synsem)
  E6B9    B7             C      	or	a		;asynchr. Routinen zugelassen?
  E6BA    C2 E6D1        C      	jp	nz,chkspx	;nein
  E6BD    3C             C      	inc	a		;weiteren Eintritt verhindern
  E6BE    32 CF3E        C      	ld	(synsem),a
  E6C1    FB             C      chkspn: ei
  E6C2    3A CF3D        C      	ld	a,(synflg)	;inzw. (neue) Anforderung?
  0000                   C      rqmask	aset	0
                         C       IF monitor
                         C       ENDIF
                         C       IF stpvar
  0010                   C      rqmask	aset	rqmask+(1 shl stoprq)
                         C       IF chdvar
  0018                   C      rqmask	aset	rqmask+(1 shl synlrq)
                         C       ENDIF
                         C       ENDIF
  E6C5    E6 18          C      	and	rqmask
  E6C7    C2 E6D4        C      	jp	nz,chkspd	;ja, ausfuehren
  E6CA    3A CF3E        C      	ld	a,(synsem)
  E6CD    3D             C      	dec	a
  E6CE    32 CF3E        C      	ld	(synsem),a
  E6D1    F1             C      chkspx: pop	af
  E6D2    FB             C      	ei
  E6D3    C9             C      	ret
                         C      
                         C      ; asynchrone Aktionen ausfuehren
  E6D4                   C      chkspd:
                         C       IF monitor
                         C       ENDIF
                         C      
                         C       IF stpvar
  E6D4    3A CF3D        C      	ld	a,(synflg)
  E6D7    CB 67          C      	bit	stoprq,a	;inzwischen Stop-Forderung?
  E6D9    28 10          C      	jr	z,nstpsp	;nein
  E6DB    CB A7          C      	res	stoprq,a
  E6DD    32 CF3D        C      	ld	(synflg),a
  E6E0    F1             C      	pop	af		;Nutzer-Stackbelastung verringern
  E6E1    22 E719        C      	ld	(asynhl),hl	;HL freimachen
  E6E4    21 E71C        C      	ld	hl,stoprt	;Routine
  E6E7    CD E705        C      	call	asynrt		;aufrufen mit eigenem Stack
  E6EA    F5             C      	push	af
  E6EB                   C      nstpsp:
                         C      
                         C       IF chdvar
  E6EB    3A CF3D        C      	ld	a,(synflg)
  E6EE    CB 5F          C      	bit	synlrq,a	;inzwischen LST:-Synchr.?
  E6F0    28 10          C      	jr	z,nsynlr	;nein
  E6F2    CB 9F          C      	res	synlrq,a
  E6F4    32 CF3D        C      	ld	(synflg),a
  E6F7    F1             C      	pop	af
  E6F8    22 E719        C      	ld	(asynhl),hl
  E6FB    21 D67E        C      	ld	hl,lsynch
  E6FE    CD E705        C      	call	asynrt
  E701    F5             C      	push	af
  E702                   C      nsynlr:
                         C       ENDIF
                         C       ENDIF	;stpvar
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-112


                         C      
  E702    C3 E6C1        C      	jp	chkspn		;Test auf neue Requests
                         C      
                         C       IF stpvar or chdvar
                         C      ; Asynchrone Routine (HL) mit eigenem Stack aufrufen
                         C      ;---------------------------------------------------
                         C      
  E705    ED 73 E716     C      asynrt: ld	(asynsv),sp	;asynchr. Routinen haben
  E709    31 F0D1        C      	ld	sp,stpstk	;ein eigenes Stack
  E70C    F5             C      	push	af
  E70D    D5             C      	push	de
  E70E    C5             C      	push	bc
  E70F    CD E76C        C      	call	callhl		;Routine aufrufen
  E712    C1             C      	pop	bc
  E713    D1             C      	pop	de
  E714    F1             C      	pop	af
  E715    31 0000        C      	ld	sp,0		;SP wiederherstellen
  E716                   C      asynsv	equ	$-2
  E718    21 0000        C      	ld	hl,0		;gerettetes hl wiederherst.
  E719                   C      asynhl	equ	$-2
  E71B    C9             C      	ret
                         C       ENDIF
                         C      
                         C       IF stpvar
                         C      ; Asynchrone Stop-Routine
                         C      ;------------------------
  E71C                   C      stoprt:
                         C       IF disknb ne 0
  E71C    CD E1F8        C      	call	headup		;Disk-Kopf abheben
                         C       ENDIF
  E71F    CD E756        C      stopz:	call	stpchp		;holen naechste phys. Taste
                         C      
                         C       IF umlaut
  E722    FE 75          C      	cp	'u'		;Umlaut-Modus umschalten ?
  E724    28 04          C      	jr	z,stopzu
  E726    FE 55          C      	cp	'U'
  E728    20 08          C      	jr	nz,stopnu	;Nein !
  E72A    21 CF3D        C      stopzu: ld	hl,synflg	;Umlaute-Flag im Flagbyte
  E72D    7E             C      	ld	a,(hl)
  E72E    EE 04          C      	xor	1 shl umlflg	;umschalten
  E730    77             C      	ld	(hl),a
  E731    C9             C      	ret
  E732                   C      stopnu:
                         C       ENDIF
                         C      
                         C       IF chdvar
  E732    FE FB          C      	cp	zblmin		;"- im Ziffernblock": Hardcopy BS -> LIST?
  E734    CA D534        C      	jp	z,crthrd	;ja, ausfuehren
  E737    FE CD          C      	cp	spcins		;"INS": I/O-Byte im LST:Kanal weiterschalten?
  E739    20 08          C      	jr	nz,stopz2	;nein
  E73B    21 0003        C      	ld	hl,iobyte
  E73E    7E             C      	ld	a,(hl)
  E73F    C6 40          C      	add	a,40h		;Ueberlauf wird ignoriert
  E741    77             C      	ld	(hl),a
  E742    C9             C      	ret
  E743                   C      stopz2:
                         C      
                         C       IF l2bahn
                         C       ENDIF
                         C       ENDIF
                         C      
                         C       IF cpastz or uhrvar
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-113


  E743    FE EE          C      	cp	pfec		;"F14": Status-Anzeige ein/aus?
  E745    20 08          C      	jr	nz,stopz3	;nein
  E747    21 CF3D        C      	ld	hl,synflg
  E74A    7E             C      	ld	a,(hl)
  E74B    EE 40          C      	xor	1 shl stzaus	;Status-Anzeige ein/aus
  E74D    77             C      	ld	(hl),a
  E74E    C9             C      	ret			;fertig
  E74F                   C      stopz3:
                         C       ENDIF
                         C      
                         C       IF costu
                         C       ENDIF
                         C      
  E74F    D6 C7          C      	sub	kcurpd		;"Page down": ^C ?
  E751    C0             C      	ret	nz		;nein, Stop-Ende
  E752    32 CF3E        C      	ld	(synsem),a	;falls rst 0 nicht in BIOS fuehrt
  E755    C7             C      	rst	0		;sonst Warmstart
                         C      
                         C      ; Holen naechste Taste physisch
  E756    21 CF3D        C      stpchp: ld	hl,synflg
  E759    CB FE          C      	set	phyact,(hl)	;naechste Taste physisch
  E75B    E5             C      	push	hl
  E75C    CD E763        C      	call	stopch		;holen naechstes Tastaturz.
  E75F    E1             C      	pop	hl
  E760    CB BE          C      	res	phyact,(hl)	;physisches Lesen beendet
  E762    C9             C      	ret
                         C      
                         C      ; Holen naechste Taste im Stopzustand
  E763    CD D515        C      stopch: call	swilmp		;Stop-Lampe an
  E766    CD D101        C      	call	kbdi		;Warten auf naechstes Zeichen
  E769    C3 D515        C      	jp	swilmp		;danach Stop-Lampe aus
                         C      
                         C       ENDIF ;stpvar
                         C       ENDIF ;asynchr. Routinen
                         C      
                         C      ;***************************************************
                         C      ;	Allgemeine BIOS-Hilfsprogramme
                         C      ;***************************************************
                         C      
                         C      ; Aufruf der Routine (HL)
  E76C    E9             C      callhl: jp	(hl)
                         C      
                         C      ; Ausgabe Text ab (HL) bis 00h auf CON: und evtl. LST:
  E76D    7E             C      putmes: LD	A,(HL)
  E76E    B7             C      	OR	A
  E76F    C8             C      	RET	Z
  E770    E5             C      	PUSH	HL
  E771    4F             C      	LD	C,A
  E772    CD CF0C        C      	CALL	conol
  E775    E1             C      	POP	HL
  E776    23             C      	INC	HL
  E777    18 F4          C      	JR	putmes
                         C      
                         C      ; Ausgabe Text ab (HL) mit exakter Laenge "stzbl" in Statuszeile
                         C       IF cpastz
  E779    11 0027        C      biosms: ld	de,statz1+statzb
  E77A                   C      crtm29	equ	$-2		;BS-Pufferadr. fuer Message
  E77C    01 0011        C      	ld	bc,stzbl
                         C      	setbs
  E77F    ED B0          C      	ldir
                         C      	setram
  E781    21 E789        C      	ld	hl,stzbto	;Anzeigezeit in Sekunden
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-114


  E784    36 1E          C      	ld	(hl),30
  E786    C3 D50D        C      	jp	crtclk		;Blinken
                         C      
  E789    F0             C      stzbto: db	4*60		;Anzeigezeit fuer CP/A-Text
                         C       ENDIF
                         C      
                         C      ;	Wait 0.01 sec * (B)
                         C      ; Reg HL bleibt erhalten
  E78A    C5             C      wait10: push	bc
  E78B    0E 0A          C      	ld	c,10		;10* 1ms warten
  E78D    06 BD          C      wait2z: ld	b,189		;(189*13)/(256*9600)=0.001
  E78F    10 FE          C      wait1z: djnz	wait1z		;1ms warten
  E791    0D             C      	dec	c
  E792    20 F9          C      	jr	nz,wait2z
  E794    C1             C      	pop	bc
  E795    10 F3          C      	djnz	wait10
  E797    C9             C      	ret
                         C      
                         C      ;************************************************************
                         C      ;	zentral verwendete Rueckkonvertierungsroutinen
                         C      ;************************************************************
                         C      
                         C       IF monitor or errvar or iobvar or uhrvar or mprot
                         C      
                         C      ; Rueckkonvertieren Byte ab (HL) nach (DE)
                         C      ; RET: 2 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
  E798    7E             C      mbreco: ld	a,(hl)
                         C      
                         C      ; Rueckkonvertieren Byte in A nach (DE)
                         C      ; RET: 2 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
  E799    CD E79C        C      mrecoa: call	mreca
                         C      
                         C      ; Rueckkonvertieren A in HEX-Ziffern nach (DE)
                         C      ; RET: A um 4 bits nach rechts rotiert
                         C      ;      DE zeigt auf naechstes Byte
  E79C                   C      mrecol:
  E79C    0F             C      mreca:	rrca			;linkes Halbbyte
  E79D    0F             C      	rrca
  E79E    0F             C      	rrca
  E79F    0F             C      	rrca
  E7A0                   C      mrecor:				;rechtes Halbbyte
  E7A0    F5             C      	push	af		;fuer 2. mreca-Aufruf retten
  E7A1    E6 0F          C      	and	0fh
  E7A3    D6 0A          C      	sub	9+1
  E7A5    38 02          C      	jr	c,mrecod	;0..9
  E7A7    C6 07          C      	add	a,7		;A..F
  E7A9    C6 3A          C      mrecod: add	a,'0'+10
  E7AB    12             C      	ld	(de),a
  E7AC    13             C      	inc	de
  E7AD    F1             C      	pop	af
  E7AE    C9             C      	ret
                         C      
                         C       ENDIF
                         C      
                         C       IF monitor or cpastz
                         C      
                         C      ; Ermitteln 10er-Ziffer von HL zur Basis -DE
                         C      ; C =0, wenn bisher nur fuehrende Nullen
                         C      ; RET: HL enthaelt Rest; C>0 bei Ziffer >'0'
                         C      ;	B,DE erhalten
                         C      ;	ret z bei fuehrender Null
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-115


  E7AF    3E 2F          C      mhldig: ld	a,'0'-1		;ASCII-Zaehler
  E7B1    3C             C      mhdig1: inc	a
  E7B2    19             C      	add	hl,de
  E7B3    38 FC          C      	jr	c,mhdig1
  E7B5    ED 52          C      	sbc	hl,de		;einmal zuviel gezaehlt
  E7B7    0C             C      	inc	c
  E7B8    FE 30          C      	cp	'0'		;Null ?
  E7BA    C0             C      	ret	nz		;nein
  E7BB    0D             C      	dec	c		; Test auf fuehrende Null
  E7BC    C9             C      	ret			;ret z bei ja
                         C      
                         C       ENDIF
                         C      
                         C      
                         C      ;*************************************************************
                         C      ;	wiederholter Kaltstart
                         C      ;*************************************************************
  E7BD                   C      kalts1:
                         C       IF cpu eq k2521
                         C       ENDIF
                         C       IF (cpu eq k2526) or (cpu eq c1715)
  E7BD    CD E541        C      	call	tim5of		;totlegen aller Interruptquellen
                         C        IF cpu eq k2526
  E7C0    CD E54C        C      	call	tim1of
                         C        ENDIF
                         C        IF cpu eq c1715
                         C        ENDIF
  E7C3    F3             C      	di
                         C        IF cpu eq k2526
  E7C4    3E F7          C      	ld	a,0f7h
  E7C6    D3 0A          C      	out	(0ah),a		;Lade-ROM zuschalten
                         C        ENDIF
                         C        IF cpu eq c1715
                         C        ENDIF
  E7C8    C7             C      	rst	0		;RESET
                         C       ENDIF
                         C      
                         C      ;*************************************************************
                         C      ;	Warmstart
                         C      ;*************************************************************
                         C       if1
                         C       endif
                         C      
                         C       IF	wbootv eq 1	;Warmstart=Kaltstart
                         C       ELSE
  E7C9    31 0080        C      WARMST: LD	SP,tpa-80h
                         C      
                         C         if	wbootv eq 0		;;CCP-Kopie im BIOS
  E7CC    21 E894        C      	ld	hl,ccpkop	;;CCP von Kopie wiederherst.
  E7CF    11 B900        C      	ld	de,CCP
  E7D2    01 0811        C      	ld	bc,ccpkpl+bdskpl
  E7D5    ED B0          C      	ldir
                         C         endif
                         C      
                         C         if	(wbootv eq 2) or (wbootv eq 3) or (wbootv eq 4)
                         C         endif ;(wbootv eq 2) or (wbootv eq 3) or (wbootv eq 4)
                         C      
                         C         if (wbootv eq 0) or (wbootv eq 2) or (wbootv eq 3)
  E7D7    21 B903        C      	LD	HL,CCP+3	;EINGANG MIT KOMMANDOLOESCHEN
                         C         endif
                         C         if wbootv eq 4
                         C         endif
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-116


                         C      	warmin
  E7DA    F3             C+     wbinit: DI
  E7DB    E5             C+     	PUSH	HL
  E7DC    3E F7          C+     	LD	A,high(intvr)
  E7DE    ED 47          C+     	LD	I,A
  E7E0    ED 5E          C+     	im	2
  E7E2    3E C3          C+     	LD	A,0C3H
  E7E4    32 0000        C+     	LD	(REBOOT),A
  E7E7    21 0003'       C+     	LD	HL,BIOS+3
  E7EA    22 0001        C+     	LD	(REBOOT+1),HL
  E7ED    32 0005        C+     	LD	(BDOSJP),A
  E7F0    21 C106        C+     	LD	HL,BDOS+6
  E7F3    22 0006        C+     	LD	(BDOSJP+1),HL
  E7F6    32 0038        C+     	ld	(38h),a		;Breakpoint
  E7F9    21 0000        C+     	ld	hl,0		;ohne Monitor wie Warmstart
  E7FC    22 0039        C+     	ld	(38h+1),hl
  E7FF    21 CF3D        C+     	ld	hl,synflg
  E802    36 00          C+     	ld	(hl),0
  E804    23             C+     	inc	hl
  E805    36 00          C+     	ld	(hl),0		;synsem:=0
  E807    21 E540        C+     	ld	hl,ret
  E80A    22 004A        C+     	ld	(kritbg),hl	;leere Routine fuer Beginn kritischer BIOS-Teil
  E80D    22 004C        C+     	ld	(kriten),hl
  E810    21 E540        C+     	ld	hl,ret
  E813    22 0045        C+     	ld	(tim1rt),hl
  E816    CD E53A        C+     	call	tim5on
  E819    CD E545        C+     	call	tim1on
  E81C    AF             C+     	xor	a
  E81D    32 D3AC        C+     	ld	(desc),a	;evtl. ESCAPE-Modus beenden
  E820    0E 82          C+     	ld	c,82h		;Kursor sichtbar machen
  E822    CD D36E        C+     	call	crto
  E825    3A 0040        C+     	ld	a,(lampbf)
  E828    E6 B3          C+      and (1 shl lmphcp)+(1 shl lmpb2r)+(1 shl lmpb2b)+(1 shl kbdcpb)+(1 shl kbdcal)
  E82A    32 0040        C+     	ld	(lampbf),a	;ruecksetzen Lampen
  E82D    21 D29B        C+     	ld	hl,kbdsts	;Standard-Stringtabelle wiederherstellen
  E830    22 CF3B        C+     	ld	(kbdsst),hl
  E833    3E FF          C+     	ld	a,0ffh
  E835    32 DF02        C+     	ld	(dbdev),a
  E838    FB             C+     	EI
  E839    21 0007        C+     	ld	hl,statz1+statzk
  E83C    06 17          C+     	ld	b,stzke-stzka
  E83E    36 20          C+     clstkz: ld	(hl),' '
  E840    23             C+     	inc	hl
  E841    10 FB          C+     	djnz	clstkz
  E843    21 0004        C+     setcld: ld	hl,defaul
  E846    4E             C+     	ld	c,(hl)
  E847    C5             C+     	push	bc
  E848    79             C+     	ld	a,c
  E849    E6 0F          C+     	and	0fh
  E84B    4F             C+     	ld	c,a
  E84C    AE             C+     	xor	(hl)
  E84D    F6 00          C+     	or	0
  E84F    77             C+     	ld	(hl),a
  E850    CD E871        C+     	call	dgetpb
  E853    C1             C+     	pop	bc
  E854    28 ED          C+     	jr	z,setcld
  E856    C9             C+     	ret
                         C       ENDIF	;wbootv ne 1
                         C      
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      ;	Steuertabellen fuer Massenspeicher
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-117


                         C       if1
                         C       endif
                         C      
                         C      ; Tabelle der Adressen der DPH's
                         C      ;===============================
                         C      
                         C      ;===============================================
  000D                   C      @din	aset	dphnb
  E857                   C      dphatb: IRP	di,<A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P>
                         C      	if	@din eq 0
                         C      	EXITM
                         C      	endif
                         C      @din	aset	@din-1
                         C       IF dpha&di ; Laufwerk A auf erstes definiertes Geraet legen
                         C      dphaA	aset	dpha&di
                         C       ENDIF
                         C      	dw	dpha&di
                         C      	ENDM
  E857    CF3F           C+     	dw	dpha&A
  E859    CF4F           C+     	dw	dpha&B
  E85B    CF5F           C+     	dw	dpha&C
  E85D    0000           C+     	dw	dpha&D
  E85F    0000           C+     	dw	dpha&E
  E861    0000           C+     	dw	dpha&F
  E863    0000           C+     	dw	dpha&G
  E865    0000           C+     	dw	dpha&H
  E867    0000           C+     	dw	dpha&I
  E869    0000           C+     	dw	dpha&J
  E86B    0000           C+     	dw	dpha&K
  E86D    0000           C+     	dw	dpha&L
  E86F    E51A           C+     	dw	dpha&M
                         C      
                         C      ; Ermitteln DPH und DPB von (c) nach HL bzw. IX
                         C      ; ret z		DPH existiert nicht, HL=0
                         C      ; ret nz	ok, HL auf DPH, IX auf DPB
                         C      ; BC, DE bleiben erhalten
                         C      ;=====================================================
  E871    D5             C      dgetpb: push	de
  E872    21 0000        C      	ld	hl,0
  E875    79             C      	ld	a,c
  E876    FE 0D          C      	cp	dphnb		;DPH definiert?
  E878    30 16          C      	jr	nc,dgetp0	;nein
  E87A    EB             C      	ex	de,hl
  E87B    21 E857        C      	ld	hl,dphatb	;Adresstabelle fuer DPH's
  E87E    59             C      	ld	e,c
  E87F    19             C      	add	hl,de
  E880    19             C      	add	hl,de
  E881    7E             C      	ld	a,(hl)
  E882    23             C      	inc	hl
  E883    66             C      	ld	h,(hl)
  E884    6F             C      	ld	l,a		;hl:=^DPH
  E885    E5             C      	push	hl
  E886    1E 0A          C      	ld	e,10
  E888    19             C      	add	hl,de
  E889    5E             C      	ld	e,(hl)
  E88A    23             C      	inc	hl
  E88B    56             C      	ld	d,(hl)		;de:=^dpb
  E88C    D5             C      	push	de
  E88D    DD E1          C      	pop	ix		;ix:=^dpb
  E88F    E1             C      	pop	hl
  E890    D1             C      dgetp0: pop	de
  E891    7C             C      	ld	a,h
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-118


  E892    B5             C      	or	l		;ret z bei hl=0
  E893    C9             C      	ret
                         C      
                         C      
                         C      ;**************************************************
                         C      ;	Arbeits-Felder (ab hier keine Konstanten!!)
                         C      ;	Arbeits-Felder werden benutzt fuer Kaltstart-Routinen
                         C      ;**************************************************
  E894                   C      biosds	equ	$
  E894                   C      @dsad	aset	biosds
                         C      
                         C      ; ===========allgemeine BIOS-Funktionen=============
                         C      
  0800                   C      ccpkpl	equ	ccpln		;Laenge CCP+ BDOS-Anfang
  0011                   C      bdskpl	equ	11h		;BDOS-Anfang
                         C      
                         C      	if	wbootv eq 0	;CCP-Kopie im BIOS
  E894                   C      ccpkop	equ	@dsad
  F0A5                   C      ccpkpe	equ	ccpkop+ccpkpl+bdskpl
  F0A5                   C      @dsad	aset	ccpkpe	;Ende CCP-Kopie
                         C      	endif
                         C      
                         C      	if	(wbootv eq 2) or (wbootv eq 3)
                         C      	endif
                         C      
                         C       IF stpvar
  F0D1                   C      @dsad	aset	@dsad+2*22	;Stack fuer asynchrone Routinen
  F0D1                   C      stpstk	equ	@dsad
                         C       ENDIF
  F0E9                   C      @dsad	aset	@dsad+2*12	;Stack fuer Interrupt-Routinen
  F0E9                   C      intstk	equ	@dsad
                         C      
                         C      ;=============Disketten-Arbeit============
                         C      
  F0E9                   C      dirbuf	equ	@dsad	;Directory-Puffer fuer alle Laufwerke
  F169                   C      @dsad	aset	@dsad+128
                         C      	IRP	di,<A,B,C,D>
                         C       IF disk&di
                         C      alv&di	equ	@dsad		;;Allocation-Vector Disk.
                         C      	IF	((disk&di mod 1000)/100) eq 5	;;5" 
                         C      	if	((disk&di mod 10000)/1000)	;;DS
                         C      @dsad	aset	@dsad+(400+7)/8 ;;reicht fuer 400k (1K Bloecke)
                         C      				;;	bzw. 800K (2K Bloecke)
                         C      	else					;;SS
                         C      @dsad	aset	@dsad+(200+7)/8 ;;reicht fuer 200k (1K Bloecke)
                         C      				;;	bzw. 400K (2K Bloecke)
                         C      	endif
                         C      	ELSE					;;8" 
                         C      	if	(disk&di ge 10000)		;;MFM
                         C      @dsad	aset	@dsad+(352+7)/8 ;;reicht fuer 704 2K Bloecke
                         C      	else					;;FM
                         C      @dsad	aset	@dsad+(250+7)/8 ;;reicht fuer 250K (1K Bloecke)
                         C      				;;	bzw. 500K (2K-Bloecke)
                         C      	endif
                         C      	ENDIF
                         C      csv&di	equ	@dsad		;;Check Sum
                         C      	IF	(disk&di mod 100) gt 40 ;;8",77 oder 5",80 Track
                         C      	if	((disk&di mod 10000)/1000)	;;DS
                         C      @dsad	aset	@dsad+256/4	;;reicht fuer 256 Dir.eintraege
                         C      	else					;;SS
                         C      @dsad	aset	@dsad+128/4	;;reicht fuer 128 Dir.eintraege
                         C      	endif
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-119


                         C      	ELSE				;;5" 40 Track
                         C      	if	((disk&di mod 10000)/1000)	;;DS
                         C      @dsad	aset	@dsad+128/4	;;reicht fuer 128 Dir.eintraege
                         C      	else
                         C      @dsad	aset	@dsad+64/4	;;reicht fuer 64 Dir.eintraege
                         C      	endif
                         C      	ENDIF
                         C       ENDIF
                         C      	ENDM
                         C      
                         C      	if	oss
                         C      	endif
                         C      
                         C      
                         C      	IF	em256
  F299                   C      alvem	equ	@dsad		;Allocation Vektor TRAM-Floppy
  F2B9                   C      @dsad	aset	@dsad+32	;reicht fuer 256k
                         C      ; kein checksum vektor, da nicht wechselbar
  F2B9                   C      dmabuf	equ	@dsad		;Puffer fuer RAM-Zugriff
  F339                   C      @dsad	aset	@dsad+128
                         C      	ENDIF
                         C      
                         C      	IF	mkd256
                         C      	ENDIF
                         C      
                         C       IF raf
                         C       ENDIF
                         C      
                         C       IF rna
                         C       ENDIF
                         C      
                         C       IF dbufsz gt 7
  F339                   C      dbuf	equ	@dsad		;Diskettenpuffer
  F739                   C      @dsad	aset	@dsad+(1 shl dbufsz)
                         C       ENDIF
                         C      
                         C      ; ============Tastatur=================
                         C      
                         C       IF cpastz
                         C       ENDIF
                         C      
                         C      ; Es folgt der Bereich fuer nutzereigene Stringdefinition
                         C      ; immer am Ende, d.h. bis zum Beginn der Interruptsaeule,
                         C      ; damit durch Rundung auf 100h-Grenze freibleibende Bytes
                         C      ; fuer Nutzerstrings zusaetzlich zur Verfuegung stehen.
                         C       IF costu
                         C       ENDIF
                         C      
  F739                   C      biosde	aset	@dsad	;*****Ende BIOS-Arbeitsbereiche*****
                         C      
                         C      
                         C      ; Kontrolle auf Adressenueberschreitung
                         C      ;======================================
                         C       if1
                         C       endif
                         C      
                         C       if biosde gt intvr
                         C       endif
                         C      
                         C      
                         C       if1
                         C       endif
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-120


                         C      
  F739                   C      @diff	aset	biosde
                         C      
                         C       if intvr ge @diff
  0000                   C      @diff	aset	(intvr-@diff) shr 8 shl 8
                         C       if @diff gt 100h ;100h als Unschaerfe zulassen
                         C       endif
                         C       endif ;intvr ge @diff
                         C      
                         C       if1
                         C       endif
                         C      
                         C      ;************************************************
                         C      ;	Kaltstart-Rest, der nicht im Anfangslader
                         C      ; Anschlussbedingung:
                         C      ; i A:	Default-Laufwerk (i.a. =Kaltstartlaufwerk)
                         C      ;	Bit 7 =1, wenn kein jungfr. Kaltstart
                         C      ;************************************************
                         C      
  E894                   C      KALTST:				;Kaltstart-Initialisierung
                         C      ; Achtung! Weder Stack noch Reg. A benutzen!
  E894    F3             C      	di
                         C       IF dev eq k8915
                         C       ENDIF
  E895    21 19A3'       C      	ld	hl,kaltsc
  E898    11 0180        C      	ld	de,kaltsb
  E89B    01 0D80        C      	ld	bc,kaltsl
  E89E    ED B0          C      	ldir			;Kaltstart-Code nach vorn
  E8A0    C3 0180        C      	jp	kaltsb		;und abarbeiten
                         C      	.DEPHASE
                         C      
                         C       IF dev eq OEM
  0180                   C      kaltsb	equ	180h		;Basisadr fuer Kaltstartcode
                         C       ENDIF
                         C       IF dev eq K8915
                         C       ENDIF
  19A3'                  C      kaltsc: .PHASE	kaltsb
                         C      
                         C      ; Loeschen 0..tpa-80h
  0180    21 0000        C      	ld	hl,0
  0183    36 00          C      	ld	(hl),0
  0185    11 0001        C      	ld	de,1
  0188    01 007F        C      	ld	bc,tpa-80h-1
  018B    ED B0          C      	ldir
                         C      ;
  018D    31 0180        C      	ld	sp,kaltsb
  0190    F5             C      	push	af		;merken Default
  0191    E6 80          C      	and	80h		;Bit 7
  0193    32 0B97        C      	ld	(cjungf),a	;merken
  0196    F1             C      	pop	af
                         C      
  0197    E6 03          C      	and	03h
  0199    32 0004        C      	ld	(defaul),a	;setzen Default-Laufwerk
  019C    32 E84E        C      	ld	(clddev),a
                         C      
                         C       if (wbootv eq 2) or (wbootv eq 3) or (wbootv eq 4)
                         C       endif
                         C      
                         C      ; Loeschen BIOS-Arbeitsbreiche zur Spur-Suche
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                         C      
  019F    21 E894        C      	ld	hl,biosds
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-121


  01A2    11 E895        C      	ld	de,biosds+1
  01A5    01 0EA4        C      	ld	bc,biosde-biosds-1
  01A8    36 FD          C      	ld	(hl),0fdh
  01AA    ED B0          C      	ldir
                         C      
                         C      ; Definieren Interruptvektor
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~
  01AC    21 F7D0        C      	LD	HL,intvr
  01AF    7C             C      	LD	A,H
  01B0    ED 47          C      	LD	I,A
  01B2    ED 5E          C      	im	2
                         C       IF (intvec+100h-intvr) eq 256
                         C       ELSE
  01B4    06 30          C      	ld	b,intvec+100h-intvr
                         C       ENDIF
  01B6    36 00          C      intvcl: ld	(hl),0		;vorloeschen Interruptsaeule
  01B8    23             C      	inc	hl
  01B9    10 FB          C      	djnz	intvcl
  01BB    21 D022        C      	ld	hl,cpmx00	;Adr.Sprungvektor CP/M-Erw.
  01BE    22 004E        C      	ld	(cpmext),hl	;eintragen
                         C      
                         C      ; Definieren Arbeitszellen fuer asynchrone Routinen
                         C      ;--------------------------------------------------
                         C      
  01C1    21 E540        C      	ld	hl,ret
  01C4    22 004A        C      	ld	(kritbg),hl
  01C7    22 004C        C      	ld	(kriten),hl
                                
                                ;#############################################################
                                ; Kaltstart-Initialisierungen
                                ;----------------------------
                         C      	include BIOSTIMC
                         C      
                         C      ; Kaltstart-Initialisierung Timer
                         C      ;================================
                         C      ; 21.03.89
                         C      
                         C       IF cpu eq c1715
                         C       ELSE
  0002                   C      tim5ct	equ	2
  0003                   C      tim1ct	equ	3
                         C       ENDIF
  01CA    21 E550        C      	ld	hl,tim5it	;;int.adr.
  01CD    22 F7FC        C      	ld	(intvec+ivctc0+2*tim5ct),hl
                         C       IF cpu ne c1715
  01D0    21 E57E        C       	ld	hl,tim1it	;;int.adr. 1 sec
  01D3    22 F7FE        C      	ld	(intvec+ivctc0+2*tim1ct),hl
                         C       ENDIF
  01D6    3E F8          C      	ld	a,ivctc0
  01D8    D3 0C          C      	out	(sysctc),a	;;int.vekt.
  01DA    3E 37          C      	ld	a,00110111b
                         C      ;;kein int./zeitg./vort.256/pos.flanke/naechst.zykl./zk folgt/abbruch/1
  01DC    D3 0E          C      	out	(sysctc+tim5ct),a
  0030                   C      tim5zk	equ	(5*100*cpuclk)/256	;;Zeitkonstante 5 ms
                         C       IF cpu eq c1715
                         C       ELSE
  01DE    3E 30          C      	ld	a,tim5zk		;;zk fuer 5 ms
                         C       ENDIF
  01E0    D3 0E          C       	out	(sysctc+tim5ct),a
                         C       IF cpu ne c1715
  01E2    3E 57          C       	ld	a,01010111b
                         C      ;;kein int./zaehler//pos.flanke//zk folgt/abbruch/1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-122


  01E4    D3 0F          C      	out	(sysctc+tim1ct),a
  01E6    3E C8          C      	ld	a,1000/5		;;zk fuer 1s
  01E8    D3 0F          C      	out	(sysctc+tim1ct),a
                         C       ENDIF
                         C      	include BIOSCHDC
                         C      ; Kaltstart-Initialisierung zeichenorientierte Geraete
                         C      ;=====================================================
                         C      ; 03.04.89
                         C       if cdtpio
                         C       endif
                         C       if iobuc1
                         C       IF (uc1dat xor uc1sta) eq 01b	;Kanal-Nr ist Bit 1 (bei Buerocomp und OEM)
                         C        IF (uc1sta and 10b) eq 00b	;UC1 ist an Kanal A
  01EA    21 D815        C      	ld	hl,uc1rin	;;Empf-Interrupt fuer UC1:
  01ED    22 F7DC        C      	ld	(intvec+ivsio6),hl ;;Kanal A
  01F0    21 D85F        C      	ld	hl,uc1err	;;spez. Empf.Bedingung fuer UC1:
  01F3    22 F7DE        C      	ld	(intvec+ivsio7),hl ;;Kanal A
                         C        ENDIF
                         C       ENDIF
                         C       endif
                                  IF disknb ne 0
                         C      	include BIOSDSKC
                         C      
                         C      ; Kaltstart-Initialisierung Floppy
                         C      ;=================================
                         C      
                         C      ;; Steuer-PIO A
  01F6    21 E1D5        C      	LD	HL,itimeo		;;Interrupt bei Indexpunkt
  01F9    22 F7E8        C      	LD	(intvec+ivdsk1),HL
  01FC    3E E8          C      	ld	a,ivdsk1
  01FE    D3 11          C      	OUT	(flcoac),A
  0200    3E 7F          C      	LD	A,7FH
  0202    D3 11          C      	OUT	(flcoac),A		;;zunaechst Byte Eingabe
                         C      ;; Daten-PIO B (Lesen)
  0204    D3 17          C      	OUT	(fldabc),A		;;Byte Eingabe
  0206    DB 16          C      	IN	A,(fldabd)		;;Scheineingabe
                         C      ;; weiter Steuer-PIO A
  0208    3E FD          C      	LD	A,11111101b		;;AMF aus
  020A    D3 10          C      	OUT	(flcoad),A
  020C    3E 3F          C      	LD	A,3FH			;;ab jetzt Byte Ausgabe
  020E    D3 11          C      	OUT	(flcoac),A
                         C      ;; Daten-PIO A (Schreiben)
  0210    D3 15          C      	OUT	(fldaac),A		;;Byte Ausgabe
                         C      ;; Steuer-PIO B
  0212    3E FF          C      	LD	A,0FFH			;;Bit E/A
  0214    D3 13          C      	OUT	(flcobc),A
  0216    3E F3          C      	LD	A,11110011b		;;eeee aaee
  0218    D3 13          C      	OUT	(flcobc),A
                         C      
                         C      ;; Ermittlung der vorhandenen Laufwerke
  021A    0E 04          C      	ld	c,maxlw
  021C    16 00          C      	ld	d,0
  021E    3E F7          C      	ld	a,0f7h		;; ohne lock
  0220    07             C      fl.ka1: rlca
  0221    D3 18          C      	out	(flsel),a
  0223    08             C      	ex	af,af'
  0224    06 55          C      	ld	b,85		;; max 85 mal steppen
  0226    DB 12          C      fl.ka2:	in	a,(flcobd)
  0228    07             C      	rlca			;; kam Spur0-Signal?
  0229    30 12          C      	jr	nc,fl.ka4	;; -> ja
  022B    3E 5F          C      	ld	a,01011111b	;; steppen in Richtung Spur 0
  022D    D3 10          C      	out	(flcoad),a
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-123


  022F    3E DF          C      	ld	a,11011111b	;; mit Kopf oben
  0231    D3 10          C      	out	(flcoad),a
  0233    26 08          C      	ld	h,8		;; Schrittzeit abwarten
  0235    2D             C      fl.ka3: dec	l
  0236    20 FD          C      	jr	nz,fl.ka3
  0238    25             C      	dec	h
  0239    20 FA          C      	jr	nz,fl.ka3
  023B    10 E9          C      	djnz	fl.ka2		;; -> weiteren Schritt ausfuehren
                         C      ;****Laufwerke immer existent melden wegen 8" Beistell-Laufwerken ohne Strom
                         C      ;***	jr	fl.ka5		;; -> LW nicht existent
                         C      ;***
  023D    CB F2          C      fl.ka4: set	6,d		;; Laufwerk existent melden
  023F    0D             C      fl.ka5: dec	c		;; weiteres LW?
  0240    28 07          C      	jr	z,fl.ka6	;; -> nein
  0242    CB 0A          C      	rrc	d
  0244    CB 0A          C      	rrc	d
  0246    08             C      	ex	af,af'
  0247    18 D7          C      	jr	fl.ka1		;; -> naechstes LW pruefen
                         C      
  0249    7A             C      fl.ka6: ld	a,d
  024A    32 E23E        C      	ld	(lwexis),a
                         C      
  024D    3E FF          C      	ld	a,0ffh		;; alle LW ausschalten
  024F    D3 18          C      	out	(flsel),a
                         C      
  0251    AF             C      	xor	a
  0252    32 E23F        C      	ld	(alwnr),a	;; LW 0 ist das zuletzt benutzte, Motor ist aus
  0255    32 E240        C      	ld	(aspnr),a	;; steht auf Spur 0
  0258    06 04          C      	ld	b,maxlw
  025A    21 E241        C      	ld	hl,spnrl
  025D    77             C      fl.ka7: ld	(hl),a		;; alle alten Spurnr. sind 0
  025E    23             C      	inc	hl
  025F    10 FC          C      	djnz	fl.ka7
                         C      
                                  ENDIF
                                  IF oss
                                  ENDIF
                                  IF em256
                         C      	include BIOSREMC
                         C      ;;Initialisieren RAM-Floppy mit EM256
                         C      ;;===================================
                         C      ;; 06.02.89
                         C      ;; 09.04.89
                         C      ;; - Fehlerkorrektur: Blockgroesse im DPB ist 1K und nicht 2K
                         C      
                         C      ;;	Bedeutung der Bits der PIO-Ports des EM256
                         C      ;;
                         C      ;;	PIO Port A (alle Bits auf Eingabe)
  0000                   C      pioa_0	equ	0		;;Kennung vom U8000
  0001                   C      pioa_1	equ	1		;;       "
  0002                   C      pioa_2	equ	2		;;       "
  0003                   C      n_vi	equ	3		;;Vektorinterrupt U8000 (negiert)
  0004                   C      int16	equ	4		;;Interrupt vom U8000 an U880
  0005                   C      n_s	equ	5		;;Normal-(1) oder Systemmode(0) des U8000
  0006                   C      m8_16	equ	6		;;8-Bit-(1) oder 16-Bit-Mode(0)
  0007                   C      tren	equ	7		;;Transfer Enable des U8000
                         C      ;;		
                         C      ;;	PIO Port B (b0..b6 Ausgabe, b7 Eingabe)
  0000                   C      sg0p	equ	0		;;fuer U880-Zugriff angewaehltes Segment
  0001                   C      sg1b	equ	1		;;                "
  0002                   C      n_ramen	equ	2		;;RAM-Enable (negiert)
  0003                   C      n_stop	equ	3		;;U8000-Stop (negiert)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-124


  0004                   C      reset16	equ	4		;;U8000-Reset
  0005                   C      n_trq8	equ	5		;;Transferrequest des U880 (negiert)
  0006                   C      prreset	equ	6		;;Reset Paritaetsfehler
  0007                   C      n_pe	equ	7		;;Paritaetsfehler (negiert)
                         C      ;;
                         C      ;;
                         C      ;;Programmierung des 16*4-RAM
                         C      ;;
                         C      ;;     0x/modadr+7    |x|x|x|x| | | | |
                         C      ;;     1x/modadr+7    |x|x|x|x| | | | |
                         C      ;;          .                 .
                         C      ;;          .                 .
                         C      ;;    0Fx/modadr+7    |x|x|x|x| | | | |
                         C      ;;     |     |                 | | | |___0=Page enable
                         C      ;;     |     |                 | | |_____0=Write enable
                         C      ;;     |     |                 | |_______/A14-8  Adressbit14 auf EM256 (neg.)
                         C      ;;     |     |                 |_________/A15-8      "    15        "
                         C      ;;     |     |___________________________Grund(Port)adresse des 16*4-RAM
                         C      ;;     |_________________________________Subadresse, adressiert Page im
                         C      ;;					 gewaehlten Segment
                         C      ;;
                         C      ;; !! b6 und b7 der Subadresse stellen die hoechstwertigen Bits der !!
                         C      ;; !! externen (von der U880-Seite) Adresse fuer den Zugriff dar.   !!
                         C      ;; !! Die wirkliche Adresse auf U8000-Seite ergibt sich durch Sub-  !!
                         C      ;; !! stitution durch die mit /A14-8 u. /A15-8 festgelegten Bits.   !!
                         C      
  0000                   C      n_pagen	equ	0	;;Page enable (negiert)
  0001                   C      n_write equ	1	;;write enable (negiert)
  4000                   C      hbemadr	aset	em256adr and 0c000h
                         C      ;;
  0261    21 E500        C      emina:	ld 	hl,parrou	;;Interruptadresse Paritaetsfehler
  0264    22 F7E0        C      	ld	(intvec+ivpar),hl;;
                         C      ;;
                         C      ;;initialisieren 1. EM 256
  0267    06 03          C      	ld	b,3
  0269    21 038C        C      	ld	hl,painit	;;em256 PIO Port A
  026C    0E AA          C      	ld	c,modadr+2
  026E    ED B3          C      	otir			;;Initialisieren
                         C      ;;
  0270    06 05          C      	ld	b,5
  0272    21 038F        C      	ld 	hl,pbinit	;;em256 PIO Port B
  0275    0E AB          C      	ld	c,modadr+3
  0277    ED B3          C      	otir			;;Initialisieren
                         C      ;;
  0279    3E 54          C      	ld	a,1 shl prreset or 1 shl reset16 or 1 shl n_ramen
  027B    D3 A9          C      	out	(modadr+1),a	;;Parityreset
  027D    3E 14          C      	ld	a,1 shl n_ramen or 1 shl reset16
                         C            				;;RAM-Disable, U8000 Reset
  027F    D3 A9          C      	out	(modadr+1),a
                         C      ;;
                         C      ;;alle Pages im 16*4-Bit-Speicher mit PAGE Disable, WRITE Disable,
                         C      ;;externe Adresse em256adr initialisieren
                         C      ;;
  0281    01 00AF        C      	ld	bc,modadr+7	;;16*4-RAM, Subadresse 0
  0284    3E 07          C      inloop:	ld a,1 shl n_pagen or 1 shl n_write or hbemadr shr 12
  0286    ED 79          C      	out	(c),a
  0288    3E 10          C      	ld 	a,10h
  028A    80             C      	add	a,b
  028B    47             C      	ld 	b,a		;;naechste Subadresse
  028C    30 F6          C      	jr	nc,inloop
                         C      ;;
                         C      ;;Test ob Ramfloppy vorhanden
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-125


  028E    2A 4000        C      	ld	hl,(em256adr)	;;retten aktuellen Inhalt RAM
  0291    E5             C      	push	hl
  0292    21 0000        C      	ld	hl,0
  0295    22 4000        C      	ld	(em256adr),hl	;;und zerstoeren RAM-Inhalt
  0298    AF             C      	xor	a		;;Spur 0
  0299    CD E4C1        C      	call	ramon		;;scharf
  029C    2A 4000        C      	ld	hl,(em256adr)	;;retten alten Inhalt RAM-Floppy
  029F    E5             C      	push	hl
  02A0    11 A55A        C      	ld	de,0a55ah	;;Bitmuster 5A A5 auf erste beide Bytes
  02A3    ED 53 4000     C      	ld	(em256adr),de	;;der RAM-Floppy oder in normalen RAM
  02A7    2A 4000        C      	ld	hl,(em256adr)	;;Muster zuruecklesen
  02AA    B7             C      	or	a
  02AB    ED 52          C      	sbc	hl,de
  02AD    28 07          C      	jr	z,emt1		
  02AF    CD E4F4        C      	call	ramoff		;;Muster nicht angekommen
  02B2    E1             C      emt0:	pop	hl
  02B3    37             C      	scf
  02B4    18 17          C      	jr	emt2
  02B6    CD E4F4        C      emt1:	call	ramoff		;;Test Muster im 8 Bit Speicher
  02B9    2A 4000        C      	ld	hl,(em256adr)
  02BC    B7             C      	or	a
  02BD    ED 52          C      	sbc	hl,de
  02BF    28 F1          C      	jr	z,emt0
  02C1    AF             C      	xor	a		;;Ramfloppy in Ordnung bringen
  02C2    CD E4C1        C      	call	ramon
  02C5    E1             C      	pop	hl
  02C6    22 4000        C      	ld	(em256adr),hl
  02C9    CD E4F4        C      	call	ramoff
  02CC    AF             C      	xor	a
  02CD    E1             C      emt2:	pop	hl
  02CE    22 4000        C      	ld	(em256adr),hl
  02D1    30 19          C      	jr	nc,inl001	;;ja, EM256 ist vorhanden
                         C      ;;  EM256 nicht vorhanden,
  02D3    21 0C37        C      	ld	hl,kemlwt
  02D6    36 3F          C      	ld	(hl),'?'	;;in Kaltstart-Text
  02D8    23             C      	inc	hl
  02D9    36 3F          C      	ld	(hl),'?'
  02DB    21 0000        C      	ld	hl,0		;;Laufwerk nicht definiert
  02DE    22 E86F        C      	ld	(dphatb+2*('M'-'A')),hl
  02E1    3E C9          C      	ld	a,0c9h		;;RET
  02E3    32 E4C1        C      	ld	(ramon),a	;;ramon entschaerfen
  02E6    32 E4F4        C      	ld	(ramoff),a	;;ramoff	"
  02E9    C3 03D0        C      	jp	emine
                         C      ;;
  02EC    AF             C      inl001:	xor 	a
  02ED    32 E519        C      	ld	(parerr),a	;;Paritaetsfehler ruecksetzen
  02F0    CD 0394        C      	call 	tstkng		;;Test, ob Kennung vorhanden
  02F3    28 1C          C      	jr	z,inl004	;;Ja, noch geladen
                         C      
                         C      ;;RAM-Floppy neu anlegen
  02F5    AF             C      inl003:	xor	a
  02F6    CD E4C1        C      	call	ramon
  02F9    C5             C      	push	bc
  02FA    11 4000        C      	ld	de,em256adr	;;Dir-Eintrag anlegen
  02FD    21 03AF        C      	ld	hl,kenn1
  0300    01 0021        C      	ld	bc,32+1		;;+ 1 Byte 0E5H
  0303    ED B0          C      	ldir
  0305    21 4020        C      	ld 	hl,em256adr+32
  0308    01 0FE0        C      	ld	bc,1000h-31-1
  030B    ED B0          C      	ldir			;;Directory mit 0E5H vollschreiben
  030D    C1             C      	pop	bc
  030E    CD E4F4        C      	call	ramoff
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-126


  0311    3A E519        C      inl004:	ld	a,(parerr)
  0314    3D             C      	dec	a		;;Fehler aufgetreten ?
  0315    20 09          C      	jr	nz,inl005	;; Nein !
  0317    21 0362        C      	ld	hl,parmes
  031A    CD E779        C      	call	biosms
  031D    C3 0261        C      	jp	emina
                         C      ;;
                         C      ;; wenn auf Segment 2,1 (Spuren 32,16) die Kennung steht, liegt eine
                         C      ;; abgeruestete Variante des EM256 vor ---> Kapazitaet in DPB verringern
                         C      ;;
  0320                   C      inl005:
  0320    3E FF          C      	ld	a,256-1		;;Volle Bestueckung annehmen
  0322    32 E52F        C      	ld	(dpbem+dpbsiz),a
  0325    21 0C3E        C      	ld	hl,kemmc
  0328    36 32          C      	ld	(hl),'2'
  032A    23             C      	inc	hl
  032B    36 35          C      	ld	(hl),'5'
  032D    23             C      	inc	hl
  032E    36 36          C      	ld	(hl),'6'
                         C      ;;
  0330    3E 20          C      	ld	a,32		;;Spur 32
  0332    CD 0394        C      	call	tstkng		;;Test: Kennung da?
  0335    C2 03D0        C      	jp	nz,emine	;;Nein, dann volle Bestueckung
                         C      
  0338    3E 7F          C      	ld	a,128-1		;;Ja, dann max.128kByte
  033A    32 E52F        C      	ld	(dpbem+dpbsiz),a
  033D    21 0C3E        C      	ld 	hl,kemmc
  0340    36 31          C      	ld	(hl),'1'	;;128 k in Meldezeile
  0342    23             C      	inc	hl
  0343    36 32          C      	ld	(hl),'2'
  0345    23             C      	inc	hl
  0346    36 38          C      	ld	(hl),'8'
  0348    3E 10          C      	ld	a,16		;;Spur 16
  034A    CD 0394        C      	call	tstkng		;;Test:	Kennung da?
  034D    C2 03D0        C      	jp	nz,emine	;;Nein,dann 128kByte
                         C      
  0350    3E 3F          C      	ld	a,64-1		;;Ja, dann 64kByte
  0352    32 E52F        C      	ld	(dpbem+dpbsiz),a
  0355    21 0C3E        C      	ld 	hl,kemmc
  0358    36 20          C      	ld	(hl),' '	;; 64 k in Meldezeile
  035A    23             C      	inc	hl
  035B    36 36          C      	ld	(hl),'6'
  035D    23             C      	inc	hl
  035E    36 34          C      	ld	(hl),'4'
  0360    18 6E          C      	jr	emine
                         C      
  0362    0D 0A 20 50    C      parmes:	db	0dh,0ah,' Paritaetsfehler im EM256, Wiederholung!'
  0366    61 72 69 74    C      
  036A    61 65 74 73    C      
  036E    66 65 68 6C    C      
  0372    65 72 20 69    C      
  0376    6D 20 45 4D    C      
  037A    32 35 36 2C    C      
  037E    20 57 69 65    C      
  0382    64 65 72 68    C      
  0386    6F 6C 75 6E    C      
  038A    67 21          C      
                         C      
  038C    CF             C      painit:	db	0cfh		;;Bit-E/A
  038D    FF             C      	db	0ffh		;;alle Bits Eingabe
  038E    07             C      	db	7		;;Int. verbieten, keine Maske
  038F    E0             C      pbinit: db	ivpar		;;Int.-vektor Paritaetsfehler
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-127


  0390    CF             C      	db	0cfh		;;Bit-E/A
  0391    80             C      	db 	80h		;;b7 Eingabe, Rest Ausgabe
  0392    97             C      	db 	97h		;;Maske folgt, 0 loest INT aus, INT Enable
  0393    80             C      	db	80h		;;Paritaetsfehler loest INT aus
                         C      
  0394    CD E4C1        C      tstkng: call	ramon
  0397    C5             C      	push	bc
  0398    21 03AF        C      	ld	hl,kenn1
  039B    11 4000        C      	ld	de,em256adr
  039E    06 0C          C      	ld	b,12
  03A0    1A             C      testk1:	ld	a,(de)		;;Kennung da ?
  03A1    BE             C      	cp	(hl)
  03A2    20 04          C      	jr	nz,testk2	;;Nein, dann volle Bestueckung
  03A4    23             C      	inc	hl
  03A5    13             C      	inc	de
  03A6    10 F8          C      	djnz	testk1
  03A8    C1             C      testk2:	pop	bc
  03A9    F5             C      	push	af			;;Zero-Flag merken
  03AA    CD E4F4        C      	call	ramoff
  03AD    F1             C      	pop	af
  03AE    C9             C      	ret
                         C      
                         C      ;; Kennungsmuster fuer Verhindern Loeschen der RAM-Floppy nach Kaltstart
  03AF    1F 40 45 4D    C      kenn1:	db 1fh,'@EMvalid','S' or 80h,'Y' or 80h,'S'	;;User 31
  03B3    76 61 6C 69    C      
  03B7    64 D3 D9 53    C      
  03BB                   C      	ds 20,0
  03CF    E5             C      	db 0e5h
                         C      
  03D0                   C      emine:
                                  ENDIF
                                  IF mkd256
                                  ENDIF
                                  IF kes
                                  ENDIF
                                  IF raf
                                  ENDIF
                                  IF rna
                                  ENDIF
                                
                                ;##############################################################
                                ; Kaltstart-Initialisierung, die vom Bildschirmformat abhaengen
                                ;--------------------------------------------------------------
                         C      	include BIOSCLD1	;Wiederholung mit neuem Bildschirmformat
                         C       IF cpu eq c1715
                         C       ENDIF
                         C      	include BIOSCRTC
                         C      ; Kaltstart-Initialisierung Bildschirm
                         C      ;=====================================
                         C      ; Version 25.09.88
                         C      ;;***naechste frei crtmxx-Marke: crtm49
                         C      
                         C       IF cpu eq k2526 ;BC A5120
                         C      ; automatische Bildschirmerkennung durch Bit 6 des System-PIO's
                         C      ; Bit 6=0 -> Loetbruecke bei grossem (24*80) Bildschirm
  03D0    DB 0A          C      	in	a,(0ah)		;;BAB2/3 (grosser Bildschirm?)
                         C       ENDIF
                         C      ;; Automatische Umschaltung des Bildschirmformates
  03D2    CB 77          C      	bit	6,a		;;BAB2 (24*80)?
  03D4    CA 049F        C      	jp	z,bsbab2	;;ja
                         C      
                         C      ;; Umstellung auf BAB1 (16*64)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-128


                         C      ;;----------------------------
  03D7    21 0001        C      bsbab1:	ld	hl,0-bsend1
  03DA    22 D3C8        C      	ld	(crtm01),hl
  03DD    21 FFC0        C      	ld	hl,bsend1-bssp1+1
  03E0    22 D3CF        C      	ld	(crtm02),hl
                         C       IF inslin
  03E3    22 D4C8        C      	ld	(crtm44),hl
  03E6    22 D4E4        C      	ld	(crtm47),hl
  03E9    22 D4F5        C      	ld	(crtm48),hl
                         C       ENDIF
  03EC    2B             C      	dec	hl
  03ED    22 D475        C      	ld	(crtm14),hl
                         C       IF inslin
  03F0    22 D4D6        C      	ld	(crtm46),hl
                         C       ENDIF
  03F3    21 FC40        C      	ld	hl,bsanf1+bssp1
  03F6    22 D3D3        C      	ld	(crtm03),hl
  03F9    2B             C      	dec	hl
  03FA    22 D4A5        C      	ld	(crtm20),hl
  03FD    21 FC00        C      	ld	hl,bsanf1
  0400    22 CF38        C      	ld	(crtcps),hl
  0403    22 D3D6        C      	ld	(crtm04),hl
  0406    22 D42A        C      	ld	(crtm09),hl
  0409    22 D483        C      	ld	(crtm16),hl
  040C    22 D48C        C      	ld	(crtm17),hl
  040F    22 D4A1        C      	ld	(crtm19),hl
                         C       IF stpvar
                         C        IF chdvar
  0412    22 D536        C      	ld	(crtm22),hl
                         C        ENDIF
                         C       ENDIF
                         C       IF mprot
                         C       ENDIF
  0415    21 03C0        C      	ld	hl,bsend1-bsanf1-bssp1+1
  0418    22 D3D9        C      	ld	(crtm05),hl
  041B    21 FFFE        C      	ld	hl,bsend1-1
  041E    22 D3E1        C      	ld	(crtm06),hl
  0421    23             C      	inc	hl
  0422    22 D467        C      	ld	(crtm13),hl
  0425    22 D48F        C      	ld	(crtm18),hl
                         C       IF inslin
  0428    22 D4D3        C      	ld	(crtm45),hl
                         C       ENDIF
  042B    21 003F        C      	ld	hl,bssp1-1
  042E    22 D3E4        C      	ld	(crtm07),hl
  0431    7D             C      	ld	a,l
  0432    32 D45A        C      	ld	(crtm11),a
  0435    23             C      	inc	hl
  0436    22 D42F        C      	ld	(crtm10),hl
  0439    22 D464        C      	ld	(crtm12),hl
  043C    22 D47D        C      	ld	(crtm15),hl
                         C       IF stpvar
                         C        IF chdvar
  043F    7D             C      	ld	a,l
  0440    32 D53D        C      	ld	(crtm24),a
  0443    3E 11          C      	ld	a,bszl1+1
  0445    32 D539        C      	ld	(crtm23),a
                         C        ENDIF
                         C       ENDIF
  0448    3E 0F          C      	ld	a,bszl1-1
  044A    32 D424        C      	ld	(crtm08),a
  044D    21 FFC0        C      	ld	hl,0-bssp1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-129


  0450    22 D4AC        C      	ld	(crtm21),hl
                         C       IF cpastz
  0453    21 0000        C      	ld	hl,statz1
  0456    22 056D        C      	ld	(crtm26),hl
                         C      ;;;	ld	hl,statz1+statzc	;Umschaltzeichen fuer BELL
                         C      ;;;	ld	(crtm30),hl
  0459    21 0001        C      	ld	hl,statz1+statzd
  045C    22 E5DE        C      	ld	(crtm27),hl
  045F    21 0001        C      	ld	hl,statz1+statzk-stzkl
  0462    22 DACD        C      	ld	(crtm40),hl
  0465    21 0007        C      	ld	hl,statz1+statzk
  0468    22 E83A        C      	ld	(crtm42),hl
  046B    21 0020        C      	ld	hl,statz1+statzi
  046E    22 E5EA        C      	ld	(crtm38),hl
  0471    21 0024        C      	ld	hl,statz1+statzl
  0474    22 E5F3        C      	ld	(crtm39),hl
  0477    21 0027        C      	ld	hl,statz1+statzb
  047A    22 E601        C      	ld	(crtm28),hl
  047D    22 E77A        C      	ld	(crtm29),hl
  0480    21 0042        C      	ld	hl,statz1+statzt
                         C       ENDIF
  0483    22 D146        C      	ld	(crtm32),hl
  0486    22 D139        C      	ld	(crtm33),hl
  0489    22 D0DD        C      	ld	(crtm35),hl
  048C    22 060E        C       	ld	(crtm43),hl
                         C       IF stpvar or monitor
  048F    22 D0B0        C      	ld	(crtm36),hl
                         C       ENDIF
  0492    23             C      	inc	hl
  0493    22 D13D        C      	ld	(crtm34),hl
                         C       IF	uhrvar
                         C        IF cpastz
  0496    21 0039        C      	ld	hl,statz1+statzu
                         C        ENDIF
  0499    22 E5C5        C      	ld	(bsuhr),hl		;;Stelle fuer Uhrzeit
                         C       ENDIF
  049C    C3 0564        C      	jp	bsbabi
                         C      
                         C      ;; Umstellung auf BAB2 (24*80)
                         C      ;;----------------------------
  049F    21 0081        C      bsbab2:	ld	hl,0-bsend2
  04A2    22 D3C8        C      	ld	(crtm01),hl
  04A5    21 FF30        C      	ld	hl,bsend2-bssp2+1
  04A8    22 D3CF        C      	ld	(crtm02),hl
                         C       IF inslin
  04AB    22 D4C8        C      	ld	(crtm44),hl
  04AE    22 D4E4        C      	ld	(crtm47),hl
  04B1    22 D4F5        C      	ld	(crtm48),hl
                         C       ENDIF
  04B4    2B             C      	dec	hl
  04B5    22 D475        C      	ld	(crtm14),hl
                         C       IF inslin
  04B8    22 D4D6        C      	ld	(crtm46),hl
                         C       ENDIF
  04BB    21 F850        C      	ld	hl,bsanf2+bssp2
  04BE    22 D3D3        C      	ld	(crtm03),hl
  04C1    2B             C      	dec	hl
  04C2    22 D4A5        C      	ld	(crtm20),hl
  04C5    21 F800        C      	ld	hl,bsanf2
  04C8    22 CF38        C      	ld	(crtcps),hl
  04CB    22 D3D6        C      	ld	(crtm04),hl
  04CE    22 D42A        C      	ld	(crtm09),hl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-130


  04D1    22 D483        C      	ld	(crtm16),hl
  04D4    22 D48C        C      	ld	(crtm17),hl
  04D7    22 D4A1        C      	ld	(crtm19),hl
                         C       IF stpvar
                         C        IF chdvar
  04DA    22 D536        C      	ld	(crtm22),hl
                         C        ENDIF
                         C       ENDIF
                         C       IF mprot
                         C       ENDIF
  04DD    21 0730        C      	ld	hl,bsend2-bsanf2-bssp2+1
  04E0    22 D3D9        C      	ld	(crtm05),hl
  04E3    21 FF7E        C      	ld	hl,bsend2-1
  04E6    22 D3E1        C      	ld	(crtm06),hl
  04E9    23             C      	inc	hl
  04EA    22 D467        C      	ld	(crtm13),hl
  04ED    22 D48F        C      	ld	(crtm18),hl
                         C       IF inslin
  04F0    22 D4D3        C      	ld	(crtm45),hl
                         C       ENDIF
  04F3    21 004F        C      	ld	hl,bssp2-1
  04F6    22 D3E4        C      	ld	(crtm07),hl
  04F9    7D             C      	ld	a,l
  04FA    32 D45A        C      	ld	(crtm11),a
  04FD    23             C      	inc	hl
  04FE    22 D42F        C      	ld	(crtm10),hl
  0501    22 D464        C      	ld	(crtm12),hl
  0504    22 D47D        C      	ld	(crtm15),hl
                         C       IF stpvar
                         C        IF chdvar
  0507    7D             C      	ld	a,l
  0508    32 D53D        C      	ld	(crtm24),a
  050B    3E 19          C      	ld	a,bszl2+1
  050D    32 D539        C      	ld	(crtm23),a
                         C        ENDIF
                         C       ENDIF
  0510    3E 17          C      	ld	a,bszl2-1
  0512    32 D424        C      	ld	(crtm08),a
  0515    21 FFB0        C      	ld	hl,0-bssp2
  0518    22 D4AC        C      	ld	(crtm21),hl
                         C       IF cpastz
  051B    21 FF80        C      	ld	hl,statz2
  051E    22 056D        C      	ld	(crtm26),hl
                         C      ;;;	ld	hl,statz2+statzc	;Umschaltzeichen fuer BELL
                         C      ;;;	ld	(crtm30),hl
  0521    21 FF81        C      	ld	hl,statz2+statzd
  0524    22 E5DE        C      	ld	(crtm27),hl
  0527    21 FF81        C      	ld	hl,statz2+statzk-stzkl
  052A    22 DACD        C      	ld	(crtm40),hl
  052D    21 FF87        C      	ld	hl,statz2+statzk
  0530    22 E83A        C      	ld	(crtm42),hl
  0533    21 FFA0        C      	ld	hl,statz2+statzi
  0536    22 E5EA        C      	ld	(crtm38),hl
  0539    21 FFA4        C      	ld	hl,statz2+statzl
  053C    22 E5F3        C      	ld	(crtm39),hl
  053F    21 FFA7        C      	ld	hl,statz2+statzb
  0542    22 E601        C      	ld	(crtm28),hl
  0545    22 E77A        C      	ld	(crtm29),hl
  0548    21 FFC2        C      	ld	hl,statz2+statzt
                         C       ENDIF
  054B    22 D146        C      	ld	(crtm32),hl
  054E    22 D139        C      	ld	(crtm33),hl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-131


  0551    22 D0DD        C      	ld	(crtm35),hl
  0554    22 060E        C      	ld	(crtm43),hl
                         C       IF stpvar or monitor
  0557    22 D0B0        C      	ld	(crtm36),hl
                         C       ENDIF
  055A    23             C      	inc	hl
  055B    22 D13D        C      	ld	(crtm34),hl
                         C       IF	uhrvar
                         C        IF cpastz
  055E    21 FFB9        C      	ld	hl,statz2+statzu
                         C        ENDIF
  0561    22 E5C5        C      	ld	(bsuhr),hl		;;Stelle fuer Uhrzeit
                         C       ENDIF
                         C      
  0564                   C      bsbabi:
                         C      
                         C       IF cpastz
                         C      ;; Initialisieren Statuszeile
                         C      
  0564    3A E84E        C      	ld	a,(clddev)
  0567    C6 41          C      	add	a,'A'		;setzen Submit-laufwerk in Statuszeile
  0569    32 057E        C      	ld	(statzm+statzs),a
  056C    11 0000        C      	ld	de,statz1
  056D                   C      crtm26	equ	$-2
  056F    21 057A        C      	ld	hl,statzm
  0572    01 0080        C      	ld	bc,stzml
  0575    ED B0          C      	ldir
  0577    C3 05FA        C      	jp	statze
                         C      
                         C      ;=========================================================
                         C      ; Muster fuer Statuszeile
                         C      ;=========================================================
  057A                   C      statzm:
                         C       IF crt eq k7024 
  0000                   C      statzc	equ	$-statzm	;;Invers-Einleitung Statuszeile
  057A    05             C      	db	stzfrm		;;Darstellungsformat Statuszeile
                         C        if stzfrm ge 90h ;;invers
                         C        else
  007C                   C      stztrn	equ	'|'
                         C        endif
                         C       ENDIF
                         C       IF crt eq dsy5 ;;invers durch Bit 7
                         C       ENDIF
                         C      
                         C      ;; Default-LW, User
  0001                   C      statzd	equ	$-statzm
  057B    41 30          C      	db	'A0'
                         C      ;; Submit-LW
  057D    5C             C      	db	'\'
  0004                   C      statzs	equ	$-statzm
  057E    41             C      	db	'A'
  057F    3E 7C          C      	db	'>',stztrn
                         C      
                         C      ;; Kapazitaet der Laufwerke
  0007                   C      statzk	equ	$-statzm
  0581    20 20 20 20    C      stzka:	db	'     '	;;A:800
  0585    20             C      
                         C      	if	dphnb le 3
                         C      	else
  0006                   C      stzkl	equ	6		;;Laenge eines Eintrags
                         C      	endif
                         C      	if	dphnb gt 1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-132


  0586                   C      	ds	stzkl,' '
                         C      	endif
                         C      	if	dphnb gt 2
  058C                   C      	ds	stzkl,' '
                         C      	endif
                         C      	if	dphnb gt 3
  0592                   C      	ds	stzkl,' '
                         C      	endif
  0598    7C             C      stzke:	db	stztrn
                         C      
                         C      ;; I/O-Byte
  0599    69             C      	db	'i'
  0020                   C      statzi	equ	$-statzm
  059A    30 30 7C       C      	db	'00',stztrn
                         C      
                         C      ;; Lampen-Puffer (da nicht alle Bits ansteuerbar)
  059D    6C             C      	db	'l'
  0024                   C      statzl	equ	$-statzm
  059E    30 30 7C       C      	db	'00',stztrn
                         C      
                         C      ;; BIOS-Meldungen
  0027                   C      statzb	equ	$-statzm
  05A1    2A 2A 43 50    C      stzb:	db	'**CP/A**  AdW/IIR'
  05A5    2F 41 2A 2A    C      
  05A9    20 20 41 64    C      
  05AD    57 2F 49 49    C      
  05B1    52             C      
  0011                   C      stzbl	equ	$-stzb
  05B2    7C             C      	db	stztrn
                         C      
                         C      ;; Uhrzeit
                         C      	if	uhrvar
  0039                   C      statzu	equ	$-statzm
  05B3    30 30 3A 30    C      	db	'00:00:00',stztrn
  05B7    30 3A 30 30    C      
  05BB    7C             C      
                         C      	endif
                         C      
                         C      ;; Kopf des Tastaturpuffers
  0042                   C      statzt	equ	$-statzm
  05BC    00             C      cobufm:	db	0		;;zu Beginn leer
  05BD                   C      	ds	statzm+128-$,0	;;auffuellen bis max. Laenge
                         C      
  0080                   C      stzml	equ	$-statzm
                         C      
  05FA                   C      statze:
                         C      
                         C       ENDIF	;cpastz
                         C      
  05FA    0E 0C          C      	ld	c,0ch
  05FC    CD D36E        C      	call	crto		;;Bildschirmpuffer loeschen
                         C      
  05FF    3E 01          C      	ld	a,1
  0601    D3 40          C      	out	(40h),a		;;BAB3: Kursor blinkend
  0603    3E 03          C      	ld	a,3
  0605    D3 40          C      	OUT	(40h),A		;;BAB3: 1920 Zeichen
                         C      
  0607    0E 84          C      	ld	c,bsinic	;;Grundzustand Bildschirm
  0609    CD D36E        C      	call	crto		;;einstellen
                         C      
                         C      	include BIOSKBDC
                         C      ; Kaltstart-Initialisierung Tastatur
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-133


                         C      ;===================================
                         C      ;14.07.88:
                         C      ; - Einbau Typcode 80h fuer K7634.54 (meldet sich wie K7636, ist aber anders!)
                         C      ; 07.11.88
                         C      ; - Erweiterung um K7634-spezifische Tasten
                         C      ;14.01.89
                         C      ; - Einbau K7633
                         C      ;16.02.89
                         C      ; - Ueberwachung der Tabellenlaenge zur Modifizierung der Tastaturcodes
                         C      ;22.03.89
                         C      ; - INSLINE -> spcins  bei K7634 in Umkodierungstabelle aufgenommen
                         C      ; - bei K7633 war KORR und ABBR vertauscht
                         C      ;07.08.89
                         C      ; - Fehlerkorrektur K7637: CTRL-Ersatztaste brachte kein ^Q-Prefix
                         C      
  060C    AF             C      	xor	a
  060D    32 FFFF        C      	ld	(0ffffh),a	;;Tastaturpuffer leeren
  060E                   C      crtm43	equ	$-2
                         C      
                         C       IF costu
                         C       ENDIF
                         C      
                         C      ;;automatische Tastaturerkennung
                         C      ;;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                         C       IF kbdpin
                         C       ENDIF
  0610    06 03          C       	ld	b,3
  0612    11 0400        C      ciini1:	ld	de,400h
  0615    1B             C      ciini2:	dec	de
  0616    DB 06          C      	in	a,(kbdpci)	;;ueberlesen Tastaturzeichen
  0618    7A             C      	ld	a,d
  0619    B3             C      	or	e
  061A    20 F9          C      	jr	nz,ciini2
  061C    10 F4          C      	djnz	ciini1
                         C      
  061E    DB 01          C      	in	a,(kbdpcs)	;;Status einer leeren Tastatur
  0620    E6 08          C      	and	8		;;ist Taste gedrueckt?
  0622    20 06          C      	jr	nz,ciini3	;;nein
  0624    32 072B        C      	ld	(coistc),a	;;sonst cpl -> nop
  0627    32 D14F        C      	ld	(kbdstc),a
  062A                   C      ciini3:
                         C      
  062A                   C      ciisrt:		;;Eingang fuer Wiederholen Tastatur-Abfrage
  062A    AF             C      	xor	a
  062B    D3 03          C      	out	(kbdp3o),a	;;ruecksetzen K7634/36
                         C       IF kbdotp eq 3
                         C       ENDIF
  062D    ED 4B 072D     C      	ld	bc,(kbdsmt)
  0631    06 05          C      	ld	b,00000101b	;;di/zeitg/vt16/neg.fl/strt/zk
  0633    ED 41          C      	out	(c),b		;;Zeitgeber fuer IFSS-Tastatur
  0635    06 01          C      	ld	b,1		;;Zeitkonstante 9600bd
  0637    ED 41          C      	out	(c),b
  0639    ED 4B 072F     C      	ld	bc,(kbdsms)
  063D    06 0A          C      	ld	b,k37prl	;;ruecksetzen K7637
  063F    21 0731        C      	ld	hl,k37par
  0642    ED B3          C      	otir			;;SIO initialisieren
  0644    ED 4B 072E     C      	ld	bc,(kbdsmi)
  0648    AF             C      	xor	a		;;reset an Tastatur
  0649    ED 79          C      	out	(c),a
                         C      ;; Bediensicherung nach RESET wird als unzulaessiges Zeichen
                         C      ;; bei der normalen Tastatureingabe ignoriert
  064B    21 073B        C      	ld	hl,kmodif	;;Standard-Ausgang
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-134


  064E    E5             C      	push	hl		;;als Return-Adresse
  064F    11 0600        C      	ld	de,6*256+0	;;Warten auf Typ-Code K7634/36/37
  0652    CD 0729        C      coityp:	call	coistp
  0655    CB 5F          C      	bit	3,a		;;Zeichen da?
  0657    28 2A          C      	jr	z,coitn1	;;nein
  0659    CB 57          C      	bit	2,a		;;CNTL-Status ohne gedrueckte CNTL-Taste?
  065B    28 05          C      	jr	z,coicnp	;;nein
  065D    3E 18          C      	ld	a,18h		;;sonst jr-Befehl,
  065F    32 D159        C      	ld	(kbdstm),a	;;zum Ignorieren des CNTL-Status
  0662    DB 06          C      coicnp:	in	a,(kbdpci)
  0664    E6 F0          C      	and	0f0h
  0666    FE 10          C      	cp	typc3s		;;Typ-Code Sondertastatur
  0668    21 07AC        C      	ld	hl,km3s
  066B    C8             C      	ret	z		;;ja
  066C    FE A0          C      	cp	typc34		;;Typ-Code K7634?
  066E    20 0D          C      	jr	nz,coin34	;;nein
  0670    CD 0729        C      	call	coistp		;;ctrl-Taste vorhanden?
  0673    CB 57          C      	bit	2,a
  0675    21 0782        C      	ld	hl,km3458
  0678    C8             C      	ret	z		;;ja, nicht K7634.54
  0679    21 0766        C      	ld	hl,km3454
  067C    C9             C      	ret
                         C      ;;;Typcode 80h
  067D    FE 80          C      coin34:	cp	80h		;;Typcode 80h?
                         C       if typ80 eq 3454
                         C       else
  067F    21 079E        C      	ld	hl,km36		;;  Modifizierung fuer K7636
                         C      endif
  0682    C8             C      	ret	z		;;ja
                         C      ;;;Ende Typcode 80h
                         C      
  0683    ED 4B 072F     C      coitn1:	ld	bc,(kbdsms)
  0687    ED 78          C      	in	a,(c)
  0689    CB 47          C      	bit	0,a		;;Zeichen da?
  068B    28 31          C      	jr	z,coitn2	;;nein
  068D    ED 4B 072E     C      	ld	bc,(kbdsmi)
  0691    ED 78          C      	in	a,(c)
  0693    E6 F0          C      	and	0f0h
  0695    FE 80          C      	cp	typc37
  0697    21 0758        C      	ld	hl,km37
  069A    20 22          C      	jr	nz,coitn2	;;nicht Typcode K7637
  069C    3A 072F        C      	ld	a,(kbdsms)	;;Portadressen aendern
  069F    32 084D        C      	ld	(k37dm1),a
  06A2    3A 072E        C      	ld	a,(kbdsmi)
  06A5    32 07BB        C      	ld	(k37dm2),a
  06A8    32 D1DE        C      	ld	(k37dm3),a
  06AB    32 D1F1        C      	ld	(k37dm4),a
  06AE    32 D1FD        C      	ld	(k37dm5),a
  06B1    32 D209        C      	ld	(k37dm6),a
  06B4    32 D226        C      	ld	(k37dm7),a
  06B7    32 D22D        C      	ld	(k37dm8),a
  06BA    21 0758        C      	ld	hl,km37
  06BD    C9             C      	ret			;;K7637
  06BE                   C      coitn2:
  06BE    1D             C      	dec	e
  06BF    20 91          C      	jr	nz,coityp
  06C1    15             C      	dec	d
  06C2    20 8E          C      	jr	nz,coityp	;;verhindern unendl.Schleife
                         C      ;;				 fuer Tastaturen ohne Typcode
  06C4    21 0730        C       	ld	hl,kbdsnr	;;laufende SIO-Tastatur-Nr
  06C7    7E             C      	ld	a,(hl)
  06C8    34             C       	inc	(hl)		;;+1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-135


                         C       if kbds2i+kbds2s+kbds2t
  06C9    FE 02          C      	cp	2		;;war schon 2?
  06CB    30 13          C      	jr	nc,coits2	;;ja
  06CD    3E 52          C      	ld	a,kbds2i
  06CF    32 072E        C      	ld	(kbdsmi),a
  06D2    3E 53          C      	ld	a,kbds2s
  06D4    32 072F        C      	ld	(kbdsms),a
  06D7    3E 59          C      	ld	a,kbds2t
  06D9    32 072D        C      	ld	(kbdsmt),a
  06DC    E1             C      	pop	hl		;;return-Adresse vergessen
  06DD    C3 062A        C      	jp	ciisrt	
  06E0                   C      coits2:
                         C       endif
                         C       if kbds3i+kbds3s+kbds3t
  06E0    FE 03          C      	cp	3		;;war schon 3?
  06E2    30 13          C      	jr	nc,coits3	;;ja
  06E4    3E 52          C      	ld	a,kbds3i
  06E6    32 072E        C      	ld	(kbdsmi),a
  06E9    3E 53          C      	ld	a,kbds3s
  06EB    32 072F        C      	ld	(kbdsms),a
  06EE    3E 5A          C      	ld	a,kbds3t
  06F0    32 072D        C      	ld	(kbdsmt),a
  06F3    E1             C      	pop	hl		;;return-Adresse vergessen
  06F4    C3 062A        C      	jp	ciisrt	
  06F7                   C      coits3:
                         C       endif
                         C       if kbds4i+kbds4s+kbds4t
  06F7    FE 04          C      	cp	4		;;war schon 4?
  06F9    30 13          C      	jr	nc,coits4	;;ja
  06FB    3E 52          C      	ld	a,kbds4i
  06FD    32 072E        C      	ld	(kbdsmi),a
  0700    3E 53          C      	ld	a,kbds4s
  0702    32 072F        C      	ld	(kbdsms),a
  0705    3E 0C          C      	ld	a,kbds4t
  0707    32 072D        C      	ld	(kbdsmt),a
  070A    E1             C      	pop	hl		;;return-Adresse vergessen
  070B    C3 062A        C      	jp	ciisrt	
  070E                   C      coits4:
                         C       endif
                         C       if kbds5i+kbds5s+kbds5t
  070E    FE 05          C      	cp	5		;;war schon 5?
  0710    30 13          C      	jr	nc,coits5	;;ja
  0712    3E 4E          C      	ld	a,kbds5i
  0714    32 072E        C      	ld	(kbdsmi),a
  0717    3E 4F          C      	ld	a,kbds5s
  0719    32 072F        C      	ld	(kbdsms),a
  071C    3E 4A          C      	ld	a,kbds5t
  071E    32 072D        C      	ld	(kbdsmt),a
  0721    E1             C      	pop	hl		;;return-Adresse vergessen
  0722    C3 062A        C      	jp	ciisrt	
  0725                   C      coits5:
                         C       endif
                         C       IF kbdotp eq 0	;;K7606 annehmen
  0725    21 0790        C      	ld	hl,km06
                         C       ENDIF
                         C       IF kbdotp eq 1	;;K7604 annehmen
                         C       ENDIF
                         C       IF kbdotp eq 2	;;DEG-Tastatur annehmen
                         C       ENDIF
                         C       IF kbdotp eq 3	;;K7633 annehmen
                         C       ENDIF
  0728    C9             C      	ret
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-136


                         C      
                         C      ;;Lesen Statusregister fuer PIO-Tastatur
                         C      ; Bit 3	=1, wenn Taste gedrueckt
                         C      ; Bit 2	=1, wenn CNTL-Taste gedrueckt
  0729    DB 01          C      coistp:	in	a,(kbdpcs)
  072B    2F             C      coistc:	cpl			;;auf NOP, wenn Status negiert
  072C    C9             C      	ret
                         C      
                         C      ;; Initialisierung Tastatur K7637
  072D    58             C      kbdsmt:	db	kbdsct	;;CTC
  072E    5C             C      kbdsmi:	db	kbdsci	;;Zeichen E/A
  072F    5D             C      kbdsms:	db	kbdscs	;;Status
  0730    01             C      kbdsnr:	db	1	;;Laufende Nr. fuer Tastaturvarianten
  0731    00 18          C      k37par:	db	0,18h	;;Kanal-Reset
  0733    04 44          C      	db	4,44h	;;clock*16  / 1 stoppbit / unger. Par.
  0735    01 00          C      	db	1,0
  0737    05 68          C      	db	5,68h	;;Send. ein / 8 bit pro Zeichen
  0739    03 C1          C      	db	3,0c1h	;;Empf. ein / 8 bit pro Zeichen
  000A                   C      k37prl	equ	$-k37par
                         C      
                         C      
                         C      ;; Tastatur-Modifizierung gemaess Steuertabelle ab (HL)
                         C      
  073B                   C      kmodif:
  073B    11 0C09        C      	ld	de,kbdtyp
  073E    01 0002        C      	ld	bc,2
  0741    ED B0          C      	ldir
  0743    06 06          C      	ld	b,kmodl		;;Anzahl der Adressen
  0745    C5             C      kmodi1:	push	bc
  0746    5E             C      	ld	e,(hl)
  0747    23             C      	inc	hl
  0748    56             C      	ld	d,(hl)
  0749    23             C      	inc	hl
  074A    E5             C      	push	hl
  074B    21 0751        C      	ld	hl,kmodi2
  074E    E5             C      	push	hl		;;ret-Adr.
  074F    D5             C      	push	de		;;Modif.routine
  0750    C9             C      coidum:	ret			;;abarbeiten
  0751    E1             C      kmodi2:	pop	hl
  0752    C1             C      	pop	bc
  0753    10 F0          C      	djnz	kmodi1
                         C      ;; Ende Kaltstart-Modifizierungen
  0755    C3 0A38        C      	jp	coinie
                         C      
                         C      
                         C      ;;Steuertabellen fuer Modifizierung
                         C      ;;==================================
                         C      
                         C      ;; dw coidum, wenn keine Modifizierung
                         C      
                         C      ;; k7637 -Tastatur
                         C      ;;----------------
                         C      
  0758    33 37          C      km37:	db	'37'
  075A    07BA           C      kmodt:	dw	coi37p		;;Port-Modifizierung
  075C    07CF           C      	dw	coi37t		;;Tastenumkodierung
  075E    07E7           C      	dw	coi37c		;;kbdst1-Modifizierung
  0760    07F3           C      	dw	coi37w		;;kbdwin-Modifizierung
  0762    0750           C      	dw	coidum		;;lampen-Modifizierung
  0764    0750           C      	dw	coidum		;;gross <-> klein vertauschen
  0006                   C      kmodl	equ	($-kmodt)/2	;;Anzahl der Adressen
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-137


                         C      ;; k76x4 -Tastaturen
                         C      ;;------------------
                         C      
                         C       IF kbdotp eq 1
                         C       ENDIF
                         C      
  0766    33 34          C      km3454:	db	'34'
  0768    0750           C      	dw	coidum
  076A    07C0           C      	dw	coi344
  076C    0750           C      	dw	coidum
  076E    07F3           C      	dw	coi34w
  0770    080A           C      	dw	coi34l
  0772    083C           C      	dw	coicps
                         C      
                         C      ;;;Typcode 80h
  0774    33 34          C      km8454:	db	'34'
  0776    0750           C      	dw	coidum
  0778    07C5           C      	dw	coi834		;bis auf wenige Tasten wie K7636
  077A    0750           C      	dw	coidum
  077C    07F3           C      	dw	coi34w
  077E    0816           C      	dw	coi84l		;warten auf Typcode 80h, sonst wie K7634
  0780    083C           C      	dw	coicps
                         C      ;;;Ende Typcode 80h
                         C      
  0782    33 34          C      km3458:	db	'34'
  0784    0750           C      	dw	coidum
  0786    07CA           C      	dw	coi348
  0788    0750           C      	dw	coidum
  078A    07F3           C      	dw	coi34w
  078C    080A           C      	dw	coi34l
  078E    083C           C      	dw	coicps
                         C      
                         C      ;; k76x6 -Tastaturen
                         C      ;;------------------
                         C      
                         C       IF kbdotp eq 0
  0790    30 36          C      km06:	db	'06'
  0792    0750           C      	dw	coidum
  0794    0750           C      	dw	coidum
  0796    0750           C      	dw	coidum
  0798    0750           C      	dw	coidum
  079A    081D           C      	dw	coi06l
  079C    0750           C      	dw	coidum
                         C       ENDIF
                         C      
  079E    33 36          C      km36:	db	'36'
  07A0    0750           C      	dw	coidum
  07A2    0750           C      	dw	coidum
  07A4    0750           C      	dw	coidum
  07A6    07F3           C      	dw	coi36w
  07A8    0829           C      	dw	coi36l
  07AA    0750           C      	dw	coidum
                         C      
                         C      ;; Sondertastatur (modifizierte K7634)
                         C      ;;---------------
  07AC    3F 53          C      km3s:	db	'?S'
  07AE    0750           C      	dw	coidum		;;Portmodif.
  07B0    07DB           C      	dw	coi3st		;;Tastenumkodierung
  07B2    0750           C      	dw	coidum		;;kbdst1-Modif.
  07B4    07F3           C      	dw	coi3sw		;;kbdwin-Modif.
  07B6    0835           C      	dw	coi3sl		;;lampen-Modif.
  07B8    0750           C      	dw	coidum		;;klein <-> gross
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-138


                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      
                         C      ;; Modifizierungs-Unterprogramme
                         C      ;;==============================
                         C      
                         C      ;;Portmodifizierung
                         C      ;;-----------------
  07BA    3E 5C          C      coi37p:	ld	a,kbdsci
  07BB                   C      k37dm2	equ	$-1		;;modifiziert bei Digitalisier-AP
  07BC    32 D187        C      	ld	(kbdmt1),a
  07BF    C9             C      	ret
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;;Codemodif.
                         C      ;;----------
                         C       IF kbdotp eq 1
                         C       ENDIF
  07C0    21 08E8        C      coi344:	ld	hl,cp3454
  07C3    18 0D          C      	jr	coicpt
                         C      
                         C      ;;;Typcode 80h
  07C5    21 0992        C      coi834:	ld	hl,cp8454
  07C8    18 08          C      	jr	coicpt
                         C      ;;;Ende Typcode 80h
                         C      
  07CA    21 093D        C      coi348:	ld	hl,cp3458
  07CD    18 03          C      	jr	coicpt
                         C      
  07CF    21 09D9        C      coi37t:	ld	hl,cp37
  07D2    11 D236        C      coicpt:	ld	de,kbdcpt
  07D5    01 0065        C      	ld	bc,kbdcpl
  07D8    ED B0          C      	ldir			;;Umkodierungstabelle setzen
  07DA    C9             C      	ret
                         C      
  07DB    21 0842        C      coi3st:	ld	hl,cocp3s	;;Umkodierung ignorieren
  07DE    11 D188        C      	ld	de,cocpm1
  07E1    01 0002        C      	ld	bc,coc3se-cocp3s
  07E4    ED B0          C      	ldir
  07E6    C9             C      	ret
                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;;kbdst1-Modif.
                         C      ;;-------------
  07E7    21 084C        C      coi37c:	ld	hl,cst37
  07EA    11 D14D        C      	ld	de,kbdst1
  07ED    01 0016        C      	ld	bc,cst37e-cst37
  07F0    ED B0          C      	ldir
  07F2    C9             C      	ret
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;;kbdwin-Modif.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-139


                         C      ;;-------------
  07F3                   C      coi3sw:
  07F3                   C      coi04w:
  07F3                   C      coi34w:
  07F3                   C      coi36w:
  07F3                   C      coi37w:
                         C       IF kbdotp eq 3
                         C       ENDIF
  07F3    21 0844        C      	ld	hl,cwi34
  07F6    11 D101        C      	ld	de,kbdmd1
  07F9    01 0008        C      	ld	bc,cwi34e-cwi34
  07FC    ED B0          C      	ldir
  07FE    C9             C      	ret
                         C      
                         C      ;;lampen-Modif.
                         C      ;;-------------
  07FF    21 08AF        C      coi04l:	ld	hl,lmp04
  0802    11 0896        C      	ld	de,lmp3404	;;lmp34 modif. ohne Warten
  0805    01 0002        C      	ld	bc,lmp04e-lmp04
  0808    ED B0          C      	ldir
  080A    21 0878        C      coi34l:	ld	hl,lmp34
  080D    11 D1CA        C      	ld	de,kbdmd2
  0810    01 0037        C      	ld	bc,lmp34e-lmp34
  0813    ED B0          C      	ldir
  0815    C9             C      	ret
                         C      
                         C      ;;;Typcode 80h
  0816    21 08A0        C      coi84l:	ld	hl,lmp34c
  0819    36 80          C      	ld	(hl),80h	;;Typecode modif.
  081B    18 ED          C      	jr	coi34l
                         C      ;;;Ende Typcode 80h
                         C      
                         C       IF kbdotp eq 0
  081D    21 0862        C      coi06l:	ld	hl,lmp06
  0820    11 D1CA        C      	ld	de,kbdmd2
  0823    01 0016        C      	ld	bc,lmp06e-lmp06
  0826    ED B0          C      	ldir
  0828    C9             C      	ret
                         C       ENDIF
                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C      
  0829    21 08B1        C      coi36l:	ld	hl,lmp36
  082C    11 D1CA        C      	ld	de,kbdmd2
  082F    01 0037        C      	ld	bc,lmp36e-lmp36
  0832    ED B0          C      	ldir
  0834    C9             C      	ret	
                         C      
  0835    21 08A0        C      coi3sl:	ld	hl,lmp34c
  0838    36 10          C      	ld	(hl),typc3s	;;Typecode modif.
  083A    18 CE          C      	jr	coi34l
                         C      
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;;Gross <-> klein modif. bei Tastaturen, die nach RESET Grossb. liefern
                         C      ;;----------------------
  083C    3E C0          C      coicps:	ld	a,0c0h		;ret nz
  083E    32 D175        C      	ld	(kbdmd3),a	;statt ret z
  0841    C9             C      	ret
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-140


                         C      
                         C      ;; Modifizierungs-Muster
                         C      ;;======================
                         C      
                         C      ;; Tastatur-Code modif.
                         C      ;;--------------------
  0842    18 12          C      cocp3s:	jr	$+cocpm2-cocpm1
  0844                   C      coc3se:
                         C      
                         C      ;; kbdwin
                         C      ;;-------
  0844                   C      cwi34:		;;Modifizierungsroutine fuer K7634/36/37
                         C      ;;kbdwin:
  0844    CD D069        C      	call	kbdst		;;Taste gedrueckt?
  0847    28 FB          C      	jr	z,cwi34		;;nein
  0849    C3 D138        C      	jp	kbdinn		;;sonst auswerten
                         C      
  084C                   C      cwi34e:
                         C      
                         C      ;; kbdst1
                         C      ;;-------
                         C      ;; Modifizierungsroutine fuer K7637
  084C                   C      cst37:
                         C      ;;kbdst1:
  084C    DB 5D          C      	in	a,(kbdscs)	;;Taste gedrueckt?
  084D                   C      k37dm1	equ	$-1		;;modifiziert bei Digitalisier-AP
  084E    E6 01          C      	and	1
  0850    C8             C      	ret	z		;(a)=0, z=1
  0851    21 CF3D        C      	ld	hl,synflg
  0854    CB 46          C      	bit	ctrlst,(hl)	;Ersatz-CNTL?
  0856    3E FF          C      	ld	a,0ffh		;Schnittmaske c0..ff -> c0..ff
  0858    28 02          C      	jr	z,cst37b	;nein
  085A    3E BF          C      	ld	a,0bfh		;Schnittmaske c0..ff -> 80..bf
  085C    32 D1A8        C      cst37b:	ld	(kbdlcs),a
  085F    AF             C      	xor	a
  0860    3D             C      	dec	a		;(a)=ff, z=0
  0861    C9             C      	ret
  0862                   C      cst37e:
                         C      
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;; lampen
                         C      ;;-------
                         C       IF kbdotp eq 0
  0862                   C      lmp06:		;;Modifizierungsroutine fuer K7606
                         C      ;;lampen:
  0862    3E 03          C      	ld	a,3
  0864    D3 03          C      	out	(kbdp3o),a	;;lampen aus
  0866    3A 0040        C      	ld	a,(lampbf)	;;puffer lampenbits
  0869    F5             C      	push	af
  086A    07             C      	rlca
  086B    07             C      	rlca
  086C    E6 03          C      	and	3
  086E    EE 0B          C      	xor	8+3		;;0 bedeutet ein
  0870    D3 03          C      	out	(kbdp3o),a
  0872    F1             C      	pop	af		;;selectorlampem
  0873    EE 0F          C      	xor	0fh		;;0 bedeutet ein
  0875    D3 05          C      	out	(kbdp5o),a
  0877    C9             C      	ret
  0878                   C      lmp06e:
                         C       ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-141


                         C      
  0878                   C      lmp34:		;;Modifizierungsroutine fuer K7604/K7634
                         C      ;;lampen:
  0878    3A 0040        C      	ld	a,(lampbf)
  087B    FE 00          C      	cp	00h		;;veraendert?
  087C                   C      lmpb34	equ	$-1		;;Kopie Lampen-Puffer
  087D    C8             C      	ret	z		;;unveraendert
  087E    21 E571        C      	ld	hl,intkbd
  0881    36 21          C      	ld	(hl),21h	;;ld hl,...
  0883    E6 C0          C      	and	0c0h		;;Sel 0..3 LED gibt es nicht
  0885    CB 7F          C      	bit	7,a		;;INS-MODE ?
  0887    28 02          C      	jr	z,lmp34a	;;aus
  0889    CB E7          C      	set	4,a
  088B    CB 77          C      lmp34a:	bit	6,a		;;Fehlerlampe ?
  088D    28 02          C      	jr	z,lmp34b	;;aus
  088F    F6 24          C      	or	00100100b	;;sonst zusaetzlich OFF-LED
  0891    2F             C      lmp34b:	cpl			;;0 bedeutet ein
  0892    CB FF          C      	set	7,a		;;Flag LED-Aenderung
  0894    D3 03          C      	out	(kbdp3o),a
  0896                   C      lmp3404:
  0896    CD D14D        C      lmp34w:	call	kbdst1		;;warten auf Antwort
  0899    28 FB          C      	jr	z,lmp34w
  089B    DB 06          C      	in	a,(kbdpci)
  089D    E6 F0          C      	and	0f0h
  089F    FE A0          C      	cp	typc34
  08A0                   C      lmp34c	equ	$-1		;;fuer evtl. Typecode-Modif.
  08A1    20 F3          C      	jr	nz,lmp34w
  08A3    3A 0040        C      lmp04w:	ld	a,(lampbf)
  08A6    32 D1CE        C      	ld	(lampen+lmpb34-lmp34),a
  08A9    21 E571        C      	ld	hl,intkbd
  08AC    36 CC          C      	ld	(hl),0cch
  08AE    C9             C      	ret
  08AF                   C      lmp34e	equ	$
                         C      
  08AF                   C      lmp04:		;;Modifizierungsroutine fuer K7604
  08AF    18 0B          C      	jr	$+(lmp04w-lmp3404);;nicht auf Antwort warten
  08B1                   C      lmp04e	equ	$
                         C      
  08B1                   C      lmp36:		;;Modifizierungsroutine fuer K7636
                         C      ;;lampen:
  08B1    3A 0040        C      	ld	a,(lampbf)
  08B4    FE 00          C      	cp	00h		;;veraendert?
  08B5                   C      lmpb36	equ	$-1		;;Kopie Lampen-Puffer
  08B6    C8             C      	ret	z		;;unveraendert
  08B7    21 E571        C      	ld	hl,intkbd	;parall. 5ms Portabfrage verhindern
  08BA    36 21          C      	ld	(hl),21h	;call ... -> ld hl,...
  08BC    E6 CF          C      	and	0cfh		;;loeschen unbenutzte Bits
  08BE    CB 7F          C      	bit	7,a		;;INS-MODE ?
  08C0    28 02          C      	jr	z,lmp36a	;;aus
  08C2    CB E7          C      	set	4,a
  08C4    CB 77          C      lmp36a:	bit	6,a		;;Fehlerlampe ?
  08C6    28 02          C      	jr	z,lmp36b	;;aus
  08C8    CB EF          C      	set	5,a		;;sonst zusaetzlich 'PIEP'
  08CA    2F             C      lmp36b:	cpl			;;0 bedeutet ein
  08CB    CB FF          C      	set	7,a		;;Flag LED-Aenderung
  08CD    D3 03          C      	out	(kbdp3o),a
  08CF                   C      lmpdg06:
  08CF    CD D14D        C      lmp36w:	call	kbdst1		;;warten auf Antwort
  08D2    28 FB          C      	jr	z,lmp36w
  08D4    DB 06          C      	in	a,(kbdpci)
  08D6    E6 F0          C      	and	0f0h
  08D8    FE 80          C      	cp	80h		;Typcode
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-142


  08DA    20 F3          C      	jr	nz,lmp36w
  08DC    3A 0040        C      lmpdgw:	ld	a,(lampbf)
  08DF    32 D1CE        C      	ld	(lampen+lmpb36-lmp36),a
  08E2    21 E571        C      	ld	hl,intkbd
  08E5    36 CC          C      	ld	(hl),0cch	;;wieder call ...
  08E7    C9             C      	ret
  08E8                   C      lmp36e	equ	$
                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C      
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;; Tabelle physikalische -> virt. Tastencodes
                         C      ;; ##########################################
                         C      
                         C      ;; K76x4.54 (ohne Controltaste)
                         C      ;;=========
  08E8                   C      cp0454:
  08E8                   C      cp3454:
                         C      ; Kursortasten
                         C      ;-------------
  08E8    0B C1          C      	db	00BH,kcurwl		;|<-
  08EA    04 C2          C      	db	004H,kcurup		;^
  08EC    01 C3          C      	DB	001H,kcurwr		;->|
  08EE    06 C4          C      	db	006H,kcurlf		;<-
  08F0    1E C5          C      	db	01eh,kcurpu		;FM als Ersatz '\
  08F2    07 C6          C      	db	007H,kcurri		;->
  08F4    0A C7          C      	db	00AH,kcurpd		;<-'
  08F6    05 C8          C      	db	005H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  08F8    9D 0D          C      	db	09dh,0dh		;ENTR
  08FA    0F 09          C      	db	00FH,009h		;|<-| als Ersatz Tab
  08FC    13 1B          C      	db	013H,01bh		;DEL LINE als Ersatz ESC
  08FE    1B C0          C      	db	01BH,spcdel		;DEL
  0900    03 CD          C      	db	003H,spcins		;INSL
  0902    1C D1          C      	db	01cH,Sel0		;DUP
  0904    1F DF          C      	db	01fh,ctlc		;RESET als Ersatz Control-Taste
  0906    09 CC          C      	db	009h,spcce		;ERIN als Ersatz CE
  0908    8D CA          C      	db	08dh,spcclr		;CLEAR
  090A    8F CB          C      	db	08fh,spccnc		;CNCL
  090C    82 CE          C      	db	082h,spckor		;KOR
  090E    83 CF          C      	db	083h,spcrol		;ROLL <-
  0910    84 D0          C      	db	084h,spcror		;ROLL ->
                         C      ; num. Tasten
                         C      ;------------
  0912    12 DD          C      	db	012H,zbl000		;Dzif
  0914    02 FB          C      	db	002h,zblmin		;INS MODE als Ersatz num. Minus
  0916    86 FC          C      	db	086h,zbla		;Taste ueber der "7"
  0918    85 C9          C      	db	085h,zblb		;Taste ueber der "8"
  091A    87 FE          C      	db	087h,zblc		;Taste ueber der "9"
                         C      ; Funktionstasten
                         C      ;----------------
  091C    11 E0          C      	db	011h,pf0c		;REC
  091E    91 E1          C      	db	091h,pf1c		;PF1
  0920    92 E2          C      	db	092h,pf2c		;PF2
  0922    93 E3          C      	db	093h,pf3c		;PF3
  0924    94 E4          C      	db	094h,pf4c		;PF4
  0926    95 E5          C      	db	095h,pf5c		;PF5
  0928    96 E6          C      	db	096h,pf6c		;PF6
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-143


  092A    97 E7          C      	db	097h,pf7c		;PF7
  092C    98 E8          C      	db	098h,pf8c		;PF8
  092E    99 E9          C      	db	099h,pf9c		;PF9
  0930    9A EA          C      	db	09ah,pfac		;PF10
  0932    9B EB          C      	db	09bh,pfbc		;PF11
  0934    9C EC          C      	db	09ch,pfcc		;PF12
  0936    81 ED          C      	db	081h,pfdc		;VLD als Ersatz PF13
  0938    08 EE          C      	db	008H,pfec		;EREO als Ersatz PF14 (Monitor)
  093A    10 EF          C      	db	010h,pffc		;OFF als Erstatz PF15 (Stop)
  093C    00             C      	db	0			;Tabellenende
                         C       IF1
                         C       ENDIF
                         C      ;----------------------------------------------------------
                         C      
                         C      ;; K76x4.58 (mit Controltaste)
                         C      ;;=========
  093D                   C      cp0458:
  093D                   C      cp3458:
                         C      ; Kursortasten
                         C      ;-------------
  093D    0B C1          C      	db	00BH,kcurwl		;|<-
  093F    04 C2          C      	db	004H,kcurup		;^
  0941    01 C3          C      	DB	001H,kcurwr		;->|
  0943    07 C4          C      	db	007H,kcurlf		;<-
  0945    1E C5          C      	db	01eh,kcurpu		;FM als Ersatz '\
  0947    06 C6          C      	db	006H,kcurri		;->
  0949    0A C7          C      	db	00AH,kcurpd		;<-'
  094B    05 C8          C      	db	005H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  094D    9D 0D          C      	db	09dh,0dh		;ENTR
  094F    0F 09          C      	db	00FH,009h		;|<-| als Ersatz Tab
  0951    13 1B          C      	db	013H,01bh		;DEL LINE als Ersatz ESC
  0953    1B C0          C      	db	01BH,spcdel		;DEL
  0955    03 CD          C      	db	003H,spcins		;INSL
  0957    1C D1          C      	db	01cH,Sel0		;DUP
  0959    1F DF          C      	db	01fh,ctlc		;RESET als Ersatz Control-Taste
  095B    09 CC          C      	db	009h,spcce		;ERIN als Ersatz CE
  095D    8D CA          C      	db	08dh,spcclr		;CLEAR
  095F    8F CB          C      	db	08fh,spccnc		;CNCL
  0961    82 CE          C      	db	082h,spckor		;KOR
  0963    83 CF          C      	db	083h,spcrol		;ROLL <-
  0965    84 D0          C      	db	084h,spcror		;ROLL ->
                         C      ; num. Tasten
                         C      ;------------
  0967    12 DD          C      	db	012H,zbl000		;Dzif
  0969    02 FB          C      	db	002h,zblmin		;INS MODE als Ersatz num. Minus
  096B    86 FC          C      	db	086h,zbla		;Taste ueber der "7"
  096D    85 C9          C      	db	085h,zblb		;Taste ueber der "8"
  096F    87 FE          C      	db	087h,zblc		;Taste ueber der "9"
                         C      ; Funktionstasten
                         C      ;----------------
  0971    11 E0          C      	db	011h,pf0c		;REC
  0973    91 E1          C      	db	091h,pf1c		;PF1
  0975    92 E2          C      	db	092h,pf2c		;PF2
  0977    93 E3          C      	db	093h,pf3c		;PF3
  0979    94 E4          C      	db	094h,pf4c		;PF4
  097B    95 E5          C      	db	095h,pf5c		;PF5
  097D    96 E6          C      	db	096h,pf6c		;PF6
  097F    97 E7          C      	db	097h,pf7c		;PF7
  0981    98 E8          C      	db	098h,pf8c		;PF8
  0983    99 E9          C      	db	099h,pf9c		;PF9
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-144


  0985    9A EA          C      	db	09ah,pfac		;PF10
  0987    9B EB          C      	db	09bh,pfbc		;PF11
  0989    9C EC          C      	db	09ch,pfcc		;PF12
  098B    81 ED          C      	db	081h,pfdc		;VLD als Ersatz PF13
  098D    08 EE          C      	db	008H,pfec		;EREO als Ersatz PF14 (Monitor)
  098F    10 EF          C      	db	010h,pffc		;OFF als Erstatz PF15 (Stop)
  0991    00             C      	db	0			;Tabellenende
                         C       IF1
                         C       ENDIF
                         C      ;----------------------------------------------------------
                         C      
                         C      ;;;Typcode 80h
                         C      ;; K7634.54 mit Typcode 80h (UBT-Tastatur)
                         C      ;==========================
  0992                   C      cp8454:
                         C      ; Kursortasten
                         C      ;-------------
  0992    0B C1          C      	db	00BH,kcurwl		;|<-
  0994    04 C2          C      	db	004H,kcurup		;^
  0996    01 C3          C      	DB	001H,kcurwr		;->|
  0998    06 C4          C      	db	006H,kcurlf		;<-
  099A    1E C5          C      	db	01eh,kcurpu		;FM als Ersatz '\
  099C    07 C6          C      	db	007H,kcurri		;->
  099E    0A C7          C      	db	00AH,kcurpd		;<-'
  09A0    13 C7          C      	db	013h,kcurpd		;DEL LINE als Ersatz <-'
  09A2    05 C8          C      	db	005H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  09A4    FF 0D          C      	db	0ffh,0dh		;ENT als CR
  09A6    0F 09          C      	db	00FH,009h		;|<-| als Ersatz Tab
  09A8    FE 1B          C      	db	0feH,01bh		;CNCL als Ersatz ESC
  09AA    1B C0          C      	db	01BH,spcdel		;DEL
  09AC    09 CC          C      	db	009H,spcce		;ERIN als Ersatz CE	K7604/34
  09AE    03 CD          C      	db	003H,spcins		;INSL
  09B0    1C D1          C      	db	01cH,Sel0		;DUP
  09B2    AF DF          C      	db	0afH,ctlc		;RESET Control-Taste	K7604/34
                         C      ; num. Tasten
                         C      ;------------
  09B4    12 DD          C      	db	012H,zbl000		;Dzif
  09B6    A8 FB          C      	DB	0A8H,zblmin		;INSM als Ersatz num. Minus
                         C      ; Funktionstasten
                         C      ;----------------
  09B8    FD E0          C      	db	0fdh,pf0c		;REC
  09BA    C1 E1          C      	db	0c1h,pf1c		;PF1
  09BC    C2 E2          C      	db	0c2h,pf2c		;PF2
  09BE    C3 E3          C      	db	0c3h,pf3c		;PF3
  09C0    C4 E4          C      	db	0c4h,pf4c		;PF4
  09C2    C5 E5          C      	db	0c5h,pf5c		;PF5
  09C4    C6 E6          C      	db	0c6h,pf6c		;PF6
  09C6    C7 E7          C      	db	0c7h,pf7c		;PF7
  09C8    C8 E8          C      	db	0c8h,pf8c		;PF8
  09CA    C9 E9          C      	db	0c9h,pf9c		;PF9
  09CC    CA EA          C      	db	0cah,pfac		;PF10
  09CE    CB EB          C      	db	0cbh,pfbc		;PF11
  09D0    CC EC          C      	db	0cch,pfcc		;PF12
  09D2    FC ED          C      	db	0fch,pfdc		;CLEAR als Ersatz PF13
  09D4    08 EE          C      	db	008H,pfec		;EREO als Ersatz PF14
  09D6    10 EF          C      	DB	010H,pffc		;OFF als Ersatz PF15
                         C      
  09D8    00             C      	db	0			;Tabellenende
                         C       IF1
                         C       ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-145


                         C      ;----------------------------------------------------------
                         C      ;;;Ende Typcode 80h
                         C      
                         C      ;; K7637
                         C      ;;======
  09D9                   C      cp37:
                         C      ; Kursortasten
                         C      ;-------------
  09D9    9B C1          C      	db	09BH,kcurwl		;|<-
  09DB    94 C2          C      	db	094H,kcurup		;^
  09DD    91 C3          C      	DB	091H,kcurwr		;->|
  09DF    96 C4          C      	db	096H,kcurlf		;<-
  09E1    9C C5          C      	DB	09CH,kcurpu		;'\
  09E3    97 C6          C      	db	097H,kcurri		;->
  09E5    9A C7          C      	db	09AH,kcurpd		;<-'
  09E7    95 C8          C      	db	095H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  09E9    FF 0D          C      	db	0ffh,0dh		;ET1 als CR
  09EB    9F 09          C      	db	09FH,009h		;|<-| als Ersatz Tab
  09ED    B3 1B          C      	db	0b3H,01bh		;DELL als Ersatz ESC
  09EF    BB C0          C      	db	0bBH,spcdel		;DELCH
  09F1    B9 CC          C      	db	0b9H,spcce		;CE
  09F3    93 CD          C      	db	093H,spcins		;INSL
  09F5    A0 D1          C      	DB	0A0H,Sel0		;SEL0
  09F7    A1 D2          C      	DB	0A1H,Sel1		;SEL1
  09F9    A2 D4          C      	DB	0A2H,Sel2		;SEL2
  09FB    A3 D8          C              DB	0A3H,Sel3		;SEL3
  09FD    FE DF          C      	db	0feh,ctlc		;ET2 als Control-Taste (Loslassen!)
                         C      ; num. Tasten
                         C      ;------------
  09FF    B1 DC          C      	db	0b1H,zbl00		;00
  0A01    A8 FB          C      	DB	0A8H,zblmin		;INSMD als Ersatz num. Minus
                         C      ; Funktionstasten
                         C      ;----------------
  0A03    C0 E0          C      	db	0c0h,pf0c		;ENTER
  0A05    C1 E1          C      	db	0c1h,pf1c		;PF1
  0A07    C2 E2          C      	db	0c2h,pf2c		;PF2
  0A09    C3 E3          C      	db	0c3h,pf3c		;PF3
  0A0B    C4 E4          C      	db	0c4h,pf4c		;PF4
  0A0D    C5 E5          C      	db	0c5h,pf5c		;PF5
  0A0F    C6 E6          C      	db	0c6h,pf6c		;PF6
  0A11    C7 E7          C      	db	0c7h,pf7c		;PF7
  0A13    C8 E8          C      	db	0c8h,pf8c		;PF8
  0A15    C9 E9          C      	db	0c9h,pf9c		;PF9
  0A17    CA EA          C      	db	0cah,pfac		;PF10
  0A19    CB EB          C      	db	0cbh,pfbc		;PF11
  0A1B    CC EC          C      	db	0cch,pfcc		;PF12
  0A1D    B0 EE          C      	db	0b0H,pfec		;MON als PF14
  0A1F    AF EF          C      	DB	0AFH,pffc		;RESET als Ersatz PF15
                         C      ; Tasten, die mit Shift oder Control anderen Code liefern
                         C      ;--------------------------------------------------------
  0A21    93 BB          C      	db	093h,zblmin-40h		;INSMD	+Shift/Control	= INSL
  0A23    B3 80          C      	db	0b3h,spcdel-40h		;DELCH	+Shift/Control	= DELL
  0A25    FA A1          C      	db	0fah,pf1c-40h		;PF1	+Shift/Control	= PA1
  0A27    F9 A2          C      	db	0f9h,pf2c-40h		;PF2	+Shift/Control	= PA2
  0A29    F8 A3          C      	db	0f8h,pf3c-40h		;PF3	+Shift/Control	= PA3
  0A2B    FC A5          C      	db	0fch,pf5c-40h		;PF5	+Shift/Control	= CLEAR
  0A2D    FD A6          C      	db	0fdh,pf6c-40h		;PF6	+Shift/Control	= REC
  0A2F    BE A7          C      	db	0beh,pf7c-40h		;PF7	+Shift/Control	= FM
  0A31    BC A8          C      	db	0bch,pf8c-40h		;PF8	+Shift/Control	= DUP
  0A33    98 AA          C      	db	098h,pfac-40h		;PF10	+Shift/Control	= EREOF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-146


  0A35    99 AB          C      	db	099h,pfbc-40h		;PF11	+Shift/Control	= ERINP
                         C      
  0A37    00             C      	db	0			;Tabellenende
                         C      
                         C       IF1
                         C       ENDIF
                         C      ;----------------------------------------------------------
                         C      
                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C      
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
  0A38                   C      coinie:
  0A38    CD D1CA        C      	call	lampen		;alle Lampen aus
                                
                                ;########################################################
                                ; Durch Initialisierrung modifizierte Kaltstart-Meldungen
                                ;--------------------------------------------------------
                         C      	include BIOSCLD2
                         C      ; 23.12.88
                         C      ; - Anforderung des Datums bei "datvar"<>0
                         C      
                         C      ; Ende der Kaltstart-Initialisierungen
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  0A3B    FB             C      	ei
  0A3C    21 E7BD        C      	ld	hl,kalts1	;erneuten kaltstart
  0A3F    22 CF01        C      	ld	(BIOS00+1),hl	;umlenken
  0A42    21 0B9D        C      	LD	HL,kaltm	;Startmeldung, variabler Teil
  0A45    CD 0B96        C      	CALL	cputms
                         C      
                         C      ; Hauptspeicher-Test TPA-Bereich
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  0A48    21 0E17        C      	ld	hl,ramtt
  0A4B    CD 0B96        C      	call	cputms
  0A4E    21 C106        C      	ld	hl,tpaend+1
  0A51    11 0F03        C      	ld	de,kaltsb+kaltsl+3;Kaltstart-Code nicht modif.
  0A54    B7             C      	or	a
  0A55    ED 52          C      	sbc	hl,de		;Restlaenge TPA (-3 fuer JP)
  0A57    44             C      	ld	b,h
  0A58    4D             C      	ld	c,l
  0A59    EB             C      	ex	de,hl
  0A5A    7E             C      ramtz:	ld	a,(hl)
  0A5B    2F             C      	cpl
  0A5C    77             C      	ld	(hl),a
  0A5D    BE             C      	cp	(hl)		;angekommen?
  0A5E    20 2C          C      	jr	nz,ramter	;nein
  0A60    2F             C      	cpl
  0A61    77             C      	ld	(hl),a
  0A62    23             C      	inc	hl
  0A63    0B             C      	dec	bc
  0A64    78             C      	ld	a,b
  0A65    B1             C      	or	c
  0A66    20 F2          C      	jr	nz,ramtz
  0A68    21 0E39        C      	ld	hl,ramtok
  0A6B    CD 0B96        C      	call	cputms
  0A6E    C3 0AAC        C      	jp	ramten
  0A71    7C             C      rameh:	ld	a,h
  0A72    CD 0A76        C      	call	dcnvoa
  0A75    7D             C      	ld	a,l
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-147


                         C      
                         C      ; Rueckkonvertieren Byte in A nach (DE)
                         C      ; RET: 2 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
  0A76    CD 0A79        C      dcnvoa:	call	dcnva
                         C      
                         C      ; Rueckkonvertieren A in HEX-Ziffern nach (DE)
                         C      ; RET: A um 4 bits nach rechts rotiert
                         C      ;      DE zeigt auf naechstes Byte
  0A79                   C      dcnvol:
  0A79    0F             C      dcnva:	rrca			;linkes Halbbyte
  0A7A    0F             C      	rrca
  0A7B    0F             C      	rrca
  0A7C    0F             C      	rrca
  0A7D                   C      dcnvor:				;rechtes Halbbyte
  0A7D    F5             C      	push	af		;fuer 2. dcnva-Aufruf retten
  0A7E    E6 0F          C      	and	0fh
  0A80    D6 0A          C      	sub	9+1
  0A82    38 02          C      	jr	c,dcnvod	;0..9
  0A84    C6 07          C      	add	a,7		;A..F
  0A86    C6 3A          C      dcnvod:	add	a,'0'+10
  0A88    12             C      	ld	(de),a
  0A89    13             C      	inc	de
  0A8A    F1             C      	pop	af
  0A8B    C9             C      	ret
                         C      
  0A8C    11 0E60        C      ramter:	ld	de,ramead
  0A8F    CD 0A71        C      	call	rameh
  0A92    11 C106        C      	ld	de,BDOS+6	;jp BDOS+6 vor diese Stelle
  0A95    2B             C      	dec	hl
  0A96    72             C      	ld	(hl),d
  0A97    2B             C      	dec	hl
  0A98    73             C      	ld	(hl),e
  0A99    2B             C      	dec	hl
  0A9A    36 C3          C      	ld	(hl),0c3h
  0A9C    22 E7F1        C      	ld	(bdosre),hl	;diesen Sprung als BDOS setzen
  0A9F    2B             C      	dec	hl
  0AA0    11 0E75        C      	ld	de,ramete
  0AA3    CD 0A71        C      	call	rameh
  0AA6    21 0E45        C      	ld	hl,ramert
  0AA9    CD 0B96        C      	call	cputms
  0AAC                   C      ramten:
                         C      
                         C       IF uhrvar		;stellen der Uhr
  0AAC    21 0B1D        C      	ld	hl,uhrini	;Aufforderung fuer Uhr stellen
  0AAF    CD E76D        C      	call	putmes		;ausgeben
  0AB2    21 0B47        C      	ld	hl,uhrins
  0AB5    E5             C      uhrin1:	push	hl
                         C       IF cpu eq c1715
                         C       ENDIF
  0AB6    CD E62C        C      	call	conin		;Zeichen holen
  0AB9    E1             C      	pop	hl
                         C       IF cpu eq c1715
                         C       ENDIF
  0ABA    FE 0D          C      	cp	0dh		;CR?
  0ABC    CA 0AC7        C      	jp	z,uhrw4		;ja, fertig
  0ABF    CD 0ACA        C      	call	uhrchr		;eingegebenes Zeichen auswerten
  0AC2    7E             C      	ld	a,(hl)
  0AC3    FE 20          C      	cp	' '		;rechtes Eingabe-Ende?
  0AC5    20 EE          C      	jr	nz,uhrin1	;nein
  0AC7    C3 0B57        C      uhrw4:	jp	uhrine		;ja, fertig
                         C      
  0ACA    FE 08          C      uhrchr:	cp	08h		;back?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-148


  0ACC    28 35          C      	jr	z,uhrinb	;ja
  0ACE    FE 7F          C      	cp	7fh		;del?
  0AD0    28 31          C      	jr	z,uhrinb	;ja
  0AD2    FE 04          C      	cp	04h		;^D? (Kursor nach rechts)
  0AD4    28 21          C      	jr	z,uhrinf	;ja
  0AD6    FE 3A          C      	cp	'9'+1		;irgendeine Nicht-Ziffern-Taste?
  0AD8    38 16          C      	jr	c,uhrinz	;nein
  0ADA    2B             C      	dec	hl
  0ADB    7E             C      	ld	a,(hl)
  0ADC    23             C      	inc	hl
  0ADD    FE 3A          C      	cp	3ah		;Position rechts neben Trennzeichen?
  0ADF    D0             C      	ret	nc		;ja, Eingabe ignorieren
  0AE0    2B             C      	dec	hl
  0AE1    36 30          C      	ld	(hl),'0'	;sonst fuehrende Null
  0AE3    0E 08          C      	ld	c,8
  0AE5    CD 0B13        C      	call	uhrinc
  0AE8    0E 30          C      	ld	c,'0'
  0AEA    CD 0B13        C      	call	uhrinc
  0AED    23             C      	inc	hl		;und die Ziffer um eins nach rechts
  0AEE    18 03          C      	jr	uhrinl
  0AF0    FE 30          C      uhrinz:	cp	'0'		;Ziffer
  0AF2    D8             C      	ret	c		;nein, ignorieren
  0AF3    77             C      uhrinl:	ld	(hl),a		;Zeichen in Text
  0AF4    4F             C      	ld	c,a		;und auf Bildschirm
  0AF5    18 02          C      	jr	uhrif1
  0AF7    0E 15          C      uhrinf:	ld	c,15h		;Kursor nach rechts
  0AF9    23             C      uhrif1:	inc	hl		;Textposition nach rechts
  0AFA    CD 0B13        C      	call	uhrinc
  0AFD    7E             C      	ld	a,(hl)		;aktuelle Kursorposition
  0AFE    FE 3A          C      	cp	3ah		;Trennzeichen?
  0B00    30 F5          C      	jr	nc,uhrinf	;ja, uebergehen
  0B02    C9             C      	ret
                         C      
  0B03    2B             C      uhrinb:	dec	hl		;eine Position nach links ausfuehren
  0B04    0E 08          C      	ld	c,8		;Kursor nach links
  0B06    CD 0B13        C      	call	uhrinc
  0B09    7E             C      	ld	a,(hl)
  0B0A    FE 20          C      	cp	' '		;linkes Textende?
  0B0C    28 E9          C      	jr	z,uhrinf	;ja, back zuweit
  0B0E    FE 3A          C      	cp	3ah		;Trennzeichen?
  0B10    30 F1          C      	jr	nc,uhrinb	;ja, uebergehen
  0B12    C9             C      	ret
                         C      
  0B13    F5             C      uhrinc:	push	af
  0B14    E5             C      	push	hl
  0B15    C5             C      	push	bc
  0B16    CD CF0C        C      	call	conol
  0B19    C1             C      	pop	bc
  0B1A    E1             C      	pop	hl
  0B1B    F1             C      	pop	af
  0B1C    C9             C      	ret
                         C      
  0B1D    0D 0A          C      uhrini:	db	0dh,0ah
  0B1F    2D 20 42 69    C      	db	'- Bitte Uhrzeit'
  0B23    74 74 65 20    C      
  0B27    55 68 72 7A    C      
  0B2B    65 69 74       C      
                         C       IF datvar
                         C       ENDIF
                         C       IF cpu eq c1715
                         C       ELSE
  0B2E    20 65 69 6E    C      	db	' eingeben!'
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-149


  0B32    67 65 62 65    C      
  0B36    6E 21          C      
                         C       ENDIF
  0B38    0D 0A          C      	db	0dh,0ah
  0B3A    20 48 48 3A    C      	db	' HH:MM:SS'
  0B3E    4D 4D 3A 53    C      
  0B42    53             C      
                         C        IF datvar
                         C        ENDIF
  0B43    86             C      	db	86h		;hell ein
  0B44    0D 0A          C      	db	0dh,0ah
  0B46    20             C      	db	' '
  0B47    30 30 3A 30    C      uhrins:	db	'00:00:00'
  0B4B    30 3A 30 30    C      
                         C        IF datvar
                         C        ENDIF
  0B4F    20 84 0D 15    C      	db	' ',84h,0dh,15h	;normal ein, zurueck auf erste Eingabepos.
  0B53    00             C      	db	0
                         C      
  0B54    0D 0A 00       C      uhrinn:	db	0dh,0ah,0
                         C      
  0B57    21 0B54        C      uhrine:	ld	hl,uhrinn
  0B5A    CD E76D        C      	call	putmes
  0B5D    11 0B47        C      	ld	de,uhrins
  0B60    21 0050        C      	ld	hl,bcduhr
                         C        IF datvar
                         C        ELSE
  0B63    06 03          C      	ld	b,3
                         C        ENDIF
  0B65    1A             C      uhrin4:	ld	a,(de)
  0B66    ED 6F          C      	rld
  0B68    13             C      	inc	de
  0B69    1A             C      	ld	a,(de)
  0B6A    ED 6F          C      	rld
  0B6C    13             C      	inc	de
  0B6D    13             C      	inc	de		;':' uebergehen
  0B6E    23             C      	inc	hl
  0B6F    10 F4          C      	djnz	uhrin4
                         C       ENDIF
                                
                                ;#############################################################
                                ; Kaltstart-Initialisierungen nach variabler Kaltstart-Meldung
                                ;-------------------------------------------------------------
                                 IF raf
                                 ENDIF
                                 IF rna
                                 ENDIF
                                 IF hdsk
                                 ENDIF
                         C      	include BIOSCLD3
                         C      ;12.01.89
                         C      ;17.05.89
                         C      ;05.06.89
                         C      
                         C      ;START CP/M
                         C      ;~~~~~~~~~~~
                         C       if wbootv eq 0
  0B71    21 B900        C      	ld	hl,CCP		;CCP fuer Warmstart kopieren
  0B74    11 E894        C      	ld	de,ccpkop
  0B77    01 0811        C      	ld	bc,ccpkpl+bdskpl
  0B7A    ED B0          C      	ldir
                         C       endif
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-150


                         C      
                         C         if	(wbootv eq 3)	;;CCP nach RAM-Floppy laden
                         C         endif ;wbootv eq 3
                         C         if (wbootv eq 2) or (wbootv eq 3)
                         C         endif ;(wbootv eq 2) or (wbootv eq 3)
                         C      
  0B7C    21 B903        C      	ld	hl,CCP+3	;zum Eingang mit Kommandoloeschen
                         C       if cldcmx eq 0
  0B7F    3A 0B97        C      	ld	a,(cjungf)
  0B82    B7             C      	or	a		;jungfr. Start?
  0B83    20 0E          C      	jr	nz,njung3	;nein
                         C       endif
  0B85    21 0E7F        C      	LD	HL,kltkom	;Kaltstartkommando
  0B88    11 B907        C      	LD	DE,CCP+7	;in CCP eintragen
  0B8B    01 0081        C      	LD	BC,lkaltc
  0B8E    ED B0          C      	LDIR
  0B90    21 B900        C      	ld	hl,CCP		;zum Eingang ohne Komm.loeschen
  0B93                   C      njung3:
                         C       if	wbootv eq 1	;Warmstart=Kaltstart, d.h. Code nur einmal
                         C       else
  0B93    C3 E7DA        C      	jp	wbinit		;Warmstart-Initialisierungen
                         C       endif
                         C      
                         C      ; Meldungen Kaltstart
                         C      
  0B96                   C      cputms:
  0B96    3E 00          C      	ld	a,0		;jungfr. Kaltstart?
  0B97                   C      cjungf	equ	$-1
  0B98    B7             C      	or	a
  0B99    C0             C      	ret	nz		;nein
  0B9A    C3 E76D        C      	jp	putmes
                         C      
                         C      ; Konstanten fuer Kaltstart
                         C      ;==========================
  0B9D                   C      kaltm:
  0B9D    43 50 2F 41    C      	db	'CP/A'
  0BA1    2C 20 56 65    C      	db	', Version '
  0BA5    72 73 69 6F    C      
  0BA9    6E 20          C      
                         C      	version
  0BAB    32 35          C+     	db	'25'
  0BAD    2E             C+     	db	'.'
  0BAE    30 39          C+     	db	'09'
  0BB0    2E             C+     	db	'.'
  0BB1    38 39          C+     	db	'89'
  0BB3    2C 20 54 50    C      	db	', TPA '
  0BB7    41 20          C      
                         C      	hexout	tpa
  0010                   C+     	.RADIX	16
  0BB9    31 30 30 48    C+     	db	'100','H'
  000A                   C+     	.RADIX	10
  0BBD    20 2D 20       C      	db	' - '
                         C      	hexout	tpaend
  0010                   C+     	.RADIX	16
  0BC0    30 43 31 30    C+     	db	'0C105','H'
  0BC4    35 48          C+     
  000A                   C+     	.RADIX	10
                         C      
  0BC6    0D 0A          C      	db	0dh,0ah
                         C      	IF	monitor
                         C      	ELSE
  0BC8    2D 20 6F 68    C      	db	'- ohne BIOS-Monitor (Taste und Aufruf ignoriert)'
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-151


  0BCC    6E 65 20 42    C      
  0BD0    49 4F 53 2D    C      
  0BD4    4D 6F 6E 69    C      
  0BD8    74 6F 72 20    C      
  0BDC    28 54 61 73    C      
  0BE0    74 65 20 75    C      
  0BE4    6E 64 20 41    C      
  0BE8    75 66 72 75    C      
  0BEC    66 20 69 67    C      
  0BF0    6E 6F 72 69    C      
  0BF4    65 72 74 29    C      
                         C      	ENDIF
                         C      
                         C       IF cpu eq c1715
                         C       ELSE
  0BF8    0D 0A          C      	db	0dh,0ah
  0BFA    2D 20 54 61    C      	db	'- Tastatur: K76'
  0BFE    73 74 61 74    C      
  0C02    75 72 3A 20    C      
  0C06    4B 37 36       C      
  0C09    3F 3F          C      kbdtyp: db	'??'
                         C      
                         C       ENDIF
                         C       IF oss
                         C       ENDIF
                         C       IF	kes
                         C       ENDIF
                         C       IF	em256
  0C0B    0D 0A          C      	db	0dh,0ah
  0C0D    2D 20 31 36    C      	db	'- 16-Bit Erweiterungsmodul als RAM-Floppy '
  0C11    2D 42 69 74    C      
  0C15    20 45 72 77    C      
  0C19    65 69 74 65    C      
  0C1D    72 75 6E 67    C      
  0C21    73 6D 6F 64    C      
  0C25    75 6C 20 61    C      
  0C29    6C 73 20 52    C      
  0C2D    41 4D 2D 46    C      
  0C31    6C 6F 70 70    C      
  0C35    79 20          C      
  0C37    4D 3A 20 6D    C      kemlwt: db	'M: mit '
  0C3B    69 74 20       C      
  0C3E    3F 3F 3F 20    C      kemmc:	db	'??? kByte'
  0C42    6B 42 79 74    C      
  0C46    65             C      
                         C       ENDIF
                         C       IF	mkd256
                         C       ENDIF
                         C       IF raf
                         C       ENDIF
                         C      
                         C       IF rna
                         C       ENDIF
                         C      
  0C47    0D 0A          C      	db	0dh,0ah
  0C49    2D 20 44 69    C      	db	'- Disketten: '
  0C4D    73 6B 65 74    C      
  0C51    74 65 6E 3A    C      
  0C55    20             C      
  0000                   C      @din	aset	0
                         C      	IRP	di,<A,B,C,D>
                         C       IF disk&di
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-152


                         C      @din	aset	@din+1
                         C      	if	@din gt 1
                         C      	db	'/'
                         C      	endif
                         C      	db	'&di:'
                         C      	db	((disk&di mod 1000)/100) or '0','"('
                         C      	db	((disk&di mod 100)/10) or '0'
                         C      	db	(disk&di mod 10) or '0'
                         C      	db	','
                         C      	if	disk&di ge 10000
                         C      	db	'DD'
                         C      	else
                         C      	db	'SD'
                         C      	endif
                         C      	db	','
                         C      	if	((disk&di mod 10000)/1000) and 00000001b
                         C      	db	'DS'
                         C      	else
                         C      	db	'SS'
                         C      	endif
                         C      	if	((disk&di mod 10000)/1000) and 00000010b
                         C      	db	',Verify'
                         C      	else
                         C      	endif
                         C      	db	')'
                         C       ENDIF
                         C      	ENDM
  0C56    41 3A          C+     	db	'A:'
  0C58    38 22 28       C+     	db	((disk&A mod 1000)/100) or '0','"('
  0C5B    37             C+     	db	((disk&A mod 100)/10) or '0'
  0C5C    37             C+     	db	(disk&A mod 10) or '0'
  0C5D    2C             C+     	db	','
  0C5E    44 44          C+     	db	'DD'
  0C60    2C             C+     	db	','
  0C61    53 53          C+     	db	'SS'
  0C63    29             C+     	db	')'
  0C64    2F             C+     	db	'/'
  0C65    42 3A          C+     	db	'B:'
  0C67    35 22 28       C+     	db	((disk&B mod 1000)/100) or '0','"('
  0C6A    38             C+     	db	((disk&B mod 100)/10) or '0'
  0C6B    30             C+     	db	(disk&B mod 10) or '0'
  0C6C    2C             C+     	db	','
  0C6D    44 44          C+     	db	'DD'
  0C6F    2C             C+     	db	','
  0C70    44 53          C+     	db	'DS'
  0C72    29             C+     	db	')'
  0C73    2F             C+     	db	'/'
  0C74    43 3A          C+     	db	'C:'
  0C76    35 22 28       C+     	db	((disk&C mod 1000)/100) or '0','"('
  0C79    38             C+     	db	((disk&C mod 100)/10) or '0'
  0C7A    30             C+     	db	(disk&C mod 10) or '0'
  0C7B    2C             C+     	db	','
  0C7C    44 44          C+     	db	'DD'
  0C7E    2C             C+     	db	','
  0C7F    44 53          C+     	db	'DS'
  0C81    29             C+     	db	')'
  0C82    0D 0A          C      	db	0dh,0ah
  0C84    20 20 20 20    C      	db	'             max. phys. Sektorlaenge: '
  0C88    20 20 20 20    C      
  0C8C    20 20 20 20    C      
  0C90    20 6D 61 78    C      
  0C94    2E 20 70 68    C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-153


  0C98    79 73 2E 20    C      
  0C9C    53 65 6B 74    C      
  0CA0    6F 72 6C 61    C      
  0CA4    65 6E 67 65    C      
  0CA8    3A 20          C      
                         C      	if	dbufsz le 7
                         C      	else
                         C      	decout	<1 shl dbufsz>
  0CAA    31 30 32 34    C+     	db	'1024'
                         C      	endif
  0CAE    2C 20          C      	db	', '
                         C       if format
  0CB0    6D 69 74       C      	db	'mit'
                         C       endif
  0CB3    20 61 75 74    C      	db	' autom. Formaterkennung'
  0CB7    6F 6D 2E 20    C      
  0CBB    46 6F 72 6D    C      
  0CBF    61 74 65 72    C      
  0CC3    6B 65 6E 6E    C      
  0CC7    75 6E 67       C      
  0CCA    0D 0A          C      	db	0dh,0ah
                         C       if chdvar eq 0
                         C       else
                         C       if1
                         C       endif
  0CCC    2D 20 65 69    C      	db	'- einige I/O-Byte-Zuordnungen:'
  0CD0    6E 69 67 65    C      
  0CD4    20 49 2F 4F    C      
  0CD8    2D 42 79 74    C      
  0CDC    65 2D 5A 75    C      
  0CE0    6F 72 64 6E    C      
  0CE4    75 6E 67 65    C      
  0CE8    6E 3A          C      
  0CEA    0D 0A 20 20    C      	db	0dh,0ah,'  Bit 7,6 (LST:-Kanal):'
  0CEE    42 69 74 20    C      
  0CF2    37 2C 36 20    C      
  0CF6    28 4C 53 54    C      
  0CFA    3A 2D 4B 61    C      
  0CFE    6E 61 6C 29    C      
  0D02    3A             C      
                         C      	if	iobtty
  0D03    0D 0A 20 20    C      	db	0dh,0ah,'      00 (TTY:): '
  0D07    20 20 20 20    C      
  0D0B    30 30 20 28    C      
  0D0F    54 54 59 3A    C      
  0D13    29 3A 20       C      
                         C      	druckt	ttydat
  0D16    47 65 72 61    C+     	db	'Geraet an Portadresse '
  0D1A    65 74 20 61    C+     
  0D1E    6E 20 50 6F    C+     
  0D22    72 74 61 64    C+     
  0D26    72 65 73 73    C+     
  0D2A    65 20          C+     
  0010                   C+     	.RADIX	16
  0D2C    35 30 48       C+     	db	'50','H'
  000A                   C+     	.RADIX	10
                         C      	endif
  0D2F    0D 0A 20 20    C      	db	0dh,0ah,'      01 (CRT:): LST:-Ausgabe auf Bildschirm'
  0D33    20 20 20 20    C      
  0D37    30 31 20 28    C      
  0D3B    43 52 54 3A    C      
  0D3F    29 3A 20 4C    C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-154


  0D43    53 54 3A 2D    C      
  0D47    41 75 73 67    C      
  0D4B    61 62 65 20    C      
  0D4F    61 75 66 20    C      
  0D53    42 69 6C 64    C      
  0D57    73 63 68 69    C      
  0D5B    72 6D          C      
                         C      	if	ioblpt
  0D5D    0D 0A 20 20    C      	db	0dh,0ah,'      10 (LPT:): '
  0D61    20 20 20 20    C      
  0D65    31 30 20 28    C      
  0D69    4C 50 54 3A    C      
  0D6D    29 3A 20       C      
                         C      	druckt	lptdat
  0D70    47 65 72 61    C+     	db	'Geraet an Portadresse '
  0D74    65 74 20 61    C+     
  0D78    6E 20 50 6F    C+     
  0D7C    72 74 61 64    C+     
  0D80    72 65 73 73    C+     
  0D84    65 20          C+     
  0010                   C+     	.RADIX	16
  0D86    35 45 48       C+     	db	'5E','H'
  000A                   C+     	.RADIX	10
                         C      	endif
  0D89    0D 0A 20 20    C      	db	0dh,0ah,'      11 (UL1:): LST:-Ausgabe hex auf Bildschirm'
  0D8D    20 20 20 20    C      
  0D91    31 31 20 28    C      
  0D95    55 4C 31 3A    C      
  0D99    29 3A 20 4C    C      
  0D9D    53 54 3A 2D    C      
  0DA1    41 75 73 67    C      
  0DA5    61 62 65 20    C      
  0DA9    68 65 78 20    C      
  0DAD    61 75 66 20    C      
  0DB1    42 69 6C 64    C      
  0DB5    73 63 68 69    C      
  0DB9    72 6D          C      
                         C      	if	iobuc1
  0DBB    0D 0A 20 20    C      	db	0dh,0ah,'  Bit 5,4/3,2/1,0 (UP2:-/UR2:-/UC1:-Kanaele):'
  0DBF    42 69 74 20    C      
  0DC3    35 2C 34 2F    C      
  0DC7    33 2C 32 2F    C      
  0DCB    31 2C 30 20    C      
  0DCF    28 55 50 32    C      
  0DD3    3A 2D 2F 55    C      
  0DD7    52 32 3A 2D    C      
  0DDB    2F 55 43 31    C      
  0DDF    3A 2D 4B 61    C      
  0DE3    6E 61 65 6C    C      
  0DE7    65 29 3A       C      
  0DEA    0D 0A 20 20    C      	db	0dh,0ah,'      11 (UC1:): '
  0DEE    20 20 20 20    C      
  0DF2    31 31 20 28    C      
  0DF6    55 43 31 3A    C      
  0DFA    29 3A 20       C      
                         C      	druckt	uc1dat
  0DFD    47 65 72 61    C+     	db	'Geraet an Portadresse '
  0E01    65 74 20 61    C+     
  0E05    6E 20 50 6F    C+     
  0E09    72 74 61 64    C+     
  0E0D    72 65 73 73    C+     
  0E11    65 20          C+     
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-155


  0010                   C+     	.RADIX	16
  0E13    35 30 48       C+     	db	'50','H'
  000A                   C+     	.RADIX	10
                         C      	endif
                         C       endif
                         C      
  0E16    00             C      	db	0	;ende-flag putmes
                         C      
                         C      ; RAM-Test-Texte
                         C      ;~~~~~~~~~~~~~~~
  0E17    0D 0A          C      ramtt:	db	0dh,0ah
  0E19    2D 20 52 41    C      	db	'- RAM-Test fuer TPA-Bereich... ',0
  0E1D    4D 2D 54 65    C      
  0E21    73 74 20 66    C      
  0E25    75 65 72 20    C      
  0E29    54 50 41 2D    C      
  0E2D    42 65 72 65    C      
  0E31    69 63 68 2E    C      
  0E35    2E 2E 20 00    C      
  0E39    54 50 41 20    C      ramtok: db	'TPA ist OK!',0
  0E3D    69 73 74 20    C      
  0E41    4F 4B 21 00    C      
  0E45    0D 0A 21 21    C      ramert: db	0dh,0ah,'!!RAM-Fehler auf Adresse '
  0E49    52 41 4D 2D    C      
  0E4D    46 65 68 6C    C      
  0E51    65 72 20 61    C      
  0E55    75 66 20 41    C      
  0E59    64 72 65 73    C      
  0E5D    73 65 20       C      
  0E60    58 58 58 58    C      ramead: db	'XXXXH!!  TPA nur bis '
  0E64    48 21 21 20    C      
  0E68    20 54 50 41    C      
  0E6C    20 6E 75 72    C      
  0E70    20 62 69 73    C      
  0E74    20             C      
  0E75    59 59 59 59    C      ramete: db	'YYYYH.',07h,0dh,0ah,0
  0E79    48 2E 07 0D    C      
  0E7D    0A 00          C      
                         C      
                         C      ; Kaltstart-Kommando
                         C      ;-------------------
  0E7F    7F             C      kltkom: db	kaltce-kaltc
  0E80                   C      kaltc:	coldcm
  0E80    53 55 42 4D    C+     kltbef: db	'SUBM AUTOEXEC',0
  0E84    20 41 55 54    C+     
  0E88    4F 45 58 45    C+     
  0E8C    43 00          C+     
  0E8E                   C+     	ds	kltbef+127-$,0
  0EFF    00             C      kaltce: DB	0		;00h notwendig fuer CCP
  0081                   C      lkaltc	equ	$-kltkom	;Laenge gesamtes Kommando
                         C      
                         C      	.DEPHASE
  0D80                   C      kaltsl	equ	$-kaltsc
                         C      
  2723'                  C      kalten	equ	$
                         C      
                                
                                ;##############################################################
  2723'                         biosce: ;Code-Ende fuer BIOS
                                
                                	END
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S


Macros:
CHARDB          CHDWARM         COLDCM          COSTS           CRTOFF          
CRTON           CRTWARM         DECDB           DECOUT          DRUCKT          
DSKWARM         HEXDB           HEXOUT          KBDWARM         PRINTD          
PRINTH          PRINTV          PRINTX          RFLWARM         SETBS           
SETRAM          TIMWARM         VERSION         WARMIN          

Symbols:
0001 	@CDT            0000 	@DIFF           0003 	@DIN            
0039 	@DPBHL          F739 	@DSAD           0001 	@FACT           
0000 	@FSYS           00C1 	@L              000C 	@LCR            
000C 	@LCS            0050 	@LD             0051 	@LS             
0713 	@LT             0014 	@WR1            0001 	@WRITE          
0080 	@WSRE           0000 	ADM3A           DBD9 	ALLOC           
F169 	ALVA            F1B5 	ALVB            F227 	ALVC            
F299 	ALVEM           E23F 	ALWNR           E240 	ASPNR           
E719 	ASYNHL          E705 	ASYNRT          E716 	ASYNSV          
0007 	B1715           0050 	BCDUHR          C100 	BDOS            
0005 	BDOSJP          0E00 	BDOSLN          E7F1 	BDOSRE          
0011 	BDSKPL          E1AA 	BERCRC          0000I'	BIOS            
CF00 	BIOS00          CF03 	BIOS03          CF06 	BIOS06          
CF09 	BIOS09          CF0C 	BIOS0C          CF0F 	BIOS0F          
CF12 	BIOS12          CF15 	BIOS15          CF18 	BIOS18          
CF1B 	BIOS1B          CF1E 	BIOS1E          CF21 	BIOS21          
CF24 	BIOS24          CF27 	BIOS27          CF2A 	BIOS2A          
CF2D 	BIOS2D          CF30 	BIOS30          CF33 	BIOS33          
CF36 	BIOS36          CF38 	BIOS38          CF3B 	BIOS3B          
CF3D 	BIOS3D          CF3F 	BIOS3F          CF00 	BIOSAD          
2723I'	BIOSCE          F739 	BIOSDE          E894 	BIOSDS          
3100 	BIOSL0          305F 	BIOSLN          E779 	BIOSMS          
FC00 	BSANF1          F800 	BSANF2          03D7 	BSBAB1          
049F 	BSBAB2          0564 	BSBABI          FFFF 	BSEND1          
FF7F 	BSEND2          0084 	BSINIC          0040 	BSSP1           
0050 	BSSP2           E5C5 	BSUHR           0010 	BSZL1           
0018 	BSZL2           0007 	C1715           E76C 	CALLHL          
B900 	CCP             E894 	CCPKOP          F0A5 	CCPKPE          
0800 	CCPKPL          0800 	CCPLN           D779 	CDSIND          
D791 	CDSINI          D75D 	CDSINS          D781 	CDSINW          
D049 	CDSIOI          D6EA 	CDSIOO          D6F0 	CDSIOS          
0000U	CDTCD1          0001 	CDTDC1          0002 	CDTDTR          
0000 	CDTH54          0000 	CDTN56          0000 	CDTP54          
0000 	CDTP56          0000 	CDTPIO          0000 	CDTSIB          
FFFF 	CHDVAR          E6B4 	CHKSP           E6D4 	CHKSPD          
E6C1 	CHKSPN          E6D1 	CHKSPX          DB7C 	CHKUNA          
00FF 	CIGN            0612 	CIINI1          0615 	CIINI2          
062A 	CIINI3          062A 	CIISRT          0B97 	CJUNGF          
0000 	CLDCMX          E84E 	CLDDEV          E83E 	CLSTKZ          
D562 	CNUML1          05BC 	COBUFM          0844 	COC3SE          
0842 	COCP3S          D188 	COCPM1          D19C 	COCPM2          
07FF 	COI04L          07F3 	COI04W          081D 	COI06L          
07C0 	COI344          07CA 	COI348          080A 	COI34L          
07F3 	COI34W          0829 	COI36L          07F3 	COI36W          
07E7 	COI37C          07BA 	COI37P          07CF 	COI37T          
07F3 	COI37W          0835 	COI3SL          07DB 	COI3ST          
07F3 	COI3SW          07C5 	COI834          0816 	COI84L          
0662 	COICNP          083C 	COICPS          07D2 	COICPT          
0750 	COIDUM          067D 	COIN34          0A38 	COINIE          
072B 	COISTC          0729 	COISTP          0683 	COITN1          
06BE 	COITN2          06E0 	COITS2          06F7 	COITS3          
070E 	COITS4          0725 	COITS5          0652 	COITYP          
E62C 	CONIN           CF0C 	CONOL           E638 	CONOUT          
E620 	CONST           D1B3 	COSTR           D1B5 	COSTR0          
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-1


D1C2 	COSTR1          0000 	COSTU           08E8 	CP0454          
093D 	CP0458          08E8 	CP3454          093D 	CP3458          
09D9 	CP37            0992 	CP8454          0001 	CPASTZ          
0001 	CPD             004E 	CPMEXT          D022 	CPMX00          
D025 	CPMX03          D028 	CPMX06          D02B 	CPMX09          
D02E 	CPMX0C          D03A 	CPMX18          D03D 	CPMX1B          
D040 	CPMX1E          D043 	CPMX21          0006 	CPU             
0019 	CPUCLK          0B96 	CPUTMS          E190 	CRCBD           
E191 	CRCBEG          E131 	CRCBEL          E220 	CRCBER          
E0ED 	CRCBES          E140 	CRCERX          E17B 	CRCNB           
E186 	CRCVGL          E23B 	CRERC           0000 	CRT             
D52C 	CRT1ZS          D524 	CRT2ZS          0800 	CRTBFL          
D48B 	CRTBSL          D48E 	CRTBSR          D5B0 	CRTCCH          
CF3A 	CRTCCN          D482 	CRTCL           D510 	CRTCL1          
D50D 	CRTCLK          D508 	CRTCOF          CF38 	CRTCPS          
D463 	CRTCR           D504 	CRTCRT          D4A4 	CRTCUP          
D3C7 	CRTCUR          D481 	CRTDEL          D4F4 	CRTDL1          
D4DF 	CRTDLL          D4FE 	CRTESC          D448 	CRTFA1          
D44E 	CRTFA2          D43A 	CRTFA3          D437 	CRTFFL          
D53C 	CRTHD1          D53E 	CRTHD2          D56C 	CRTHD3          
D564 	CRTHD4          D4A0 	CRTHOM          D534 	CRTHRD          
D4DA 	CRTIL1          D4C3 	CRTINL          D3A7 	CRTLC           
0004 	CRTLCL          D474 	CRTLF           D3C8 	CRTM01          
D3CF 	CRTM02          D3D3 	CRTM03          D3D6 	CRTM04          
D3D9 	CRTM05          D3E1 	CRTM06          D3E4 	CRTM07          
D424 	CRTM08          D42A 	CRTM09          D42F 	CRTM10          
D45A 	CRTM11          D464 	CRTM12          D467 	CRTM13          
D475 	CRTM14          D47D 	CRTM15          D483 	CRTM16          
D48C 	CRTM17          D48F 	CRTM18          D4A1 	CRTM19          
D4A5 	CRTM20          D4AC 	CRTM21          D536 	CRTM22          
D539 	CRTM23          D53D 	CRTM24          056D 	CRTM26          
E5DE 	CRTM27          E601 	CRTM28          E77A 	CRTM29          
D146 	CRTM32          D139 	CRTM33          D13D 	CRTM34          
D0DD 	CRTM35          D0B0 	CRTM36          E5EA 	CRTM38          
E5F3 	CRTM39          DACD 	CRTM40          E83A 	CRTM42          
060E 	CRTM43          D4C8 	CRTM44          D4D3 	CRTM45          
D4D6 	CRTM46          D4E4 	CRTM47          D4F5 	CRTM48          
D459 	CRTNFA          D411 	CRTNOP          D43F 	CRTNSP          
D36E 	CRTO            D3B0 	CRTO02          D3D1 	CRTO03          
D412 	CRTO04          D429 	CRTO05          D432 	CRTO06          
D436 	CRTO07          D45F 	CRTO08          D3F1 	CRTO09          
D401 	CRTO11          D469 	CRTO12          D4BC 	CRTO13          
D509 	CRTO14          D3EA 	CRTO84          D3EA 	CRTO85          
D3EA 	CRTO86          D3EA 	CRTO87          D3C5 	CRTOBS          
D399 	CRTOE1          D383 	CRTONC          D3AB 	CRTOTI          
D3C6 	CRTSBL          D046 	CRTST           D57F 	CRTUML          
D4B0 	CRTZL           D4B4 	CRTZLR          D15D 	CST34A          
D165 	CST34B          084C 	CST37           085C 	CST37B          
0862 	CST37E          F195 	CSVA            F1E7 	CSVB            
F259 	CSVC            00DF 	CTLC            0000 	CTRLST          
0844 	CWI34           084C 	CWI34E          0000 	DATVAR          
DF01 	DBCDB           DF02 	DBDEV           DF08 	DBDMA           
DF1A 	DBERRF          DF01 	DBFLG           DEBF 	DBL1K           
DEC2 	DBL2K           DEC5 	DBL2K0          DC94 	DBMAT           
DC28 	DBN             DF18 	DBNB            DC91 	DBPRR           
DF05 	DBSEC           DC59 	DBSEC0          DC62 	DBSECM          
DC6B 	DBSECO          DC56 	DBSECZ          DF04 	DBSID           
DF06 	DBSLC           DF07 	DBSNB           DC47 	DBSNBZ          
DCD2 	DBTRAN          DF03 	DBTRK           DCCC 	DBTRW           
F339 	DBUF            000A 	DBUFSZ          DF0A 	DCDB            
0A79 	DCNVA           0A76 	DCNVOA          0A86 	DCNVOD          
0A79 	DCNVOL          0A7D 	DCNVOR          D380 	DCURS           
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-2


DF11 	DDMA            DF0B 	DDRIVE          0004 	DEFAUL          
E6A8 	DELSPR          E69B 	DELSPS          DEE3 	DERRCD          
DEE2 	DERRMS          DE06 	DERRR           DEE2 	DERRRW          
DEF1 	DERRSC          DEED 	DERRTR          DEEF 	DERRTS          
D3AC 	DESC            0000 	DEV             0000 	DFBPRR          
0004 	DFBTR           0002 	DFBWR           DF0A 	DFLG            
DEFA 	DFRCDB          E089 	DFRCOD          DEFA 	DFRFLG          
DEFB 	DFRMDV          DEFC 	DFRMTR          0002 	DFWR            
E890 	DGETP0          E871 	DGETPB          E3E0 	DINI1           
E3E3 	DINI2           E3E6 	DINI3           E309 	DIO             
E316 	DIO2            DF22 	DIOCAD          DF1B 	DIOCDB          
DF1C 	DIOCDE          0009 	DIOCDL          DF1B 	DIOCFL          
DF1F 	DIOCSE          DF1E 	DIOCSI          DF20 	DIOCSL          
DF21 	DIOCSN          DF1D 	DIOCTR          E30E 	DIODMA          
E402 	DIOEND          DDEF 	DIOERT          0000 	DIOF00          
0003 	DIOFFM          0005 	DIOFHD          0001 	DIOFID          
0006 	DIOFPS          0007 	DIOFS1          0004 	DIOFTR          
0002 	DIOFWR          E33D 	DIOGO           E343 	DIOKL           
E33A 	DIOM01          E2E6 	DIOM02          E336 	DIOM03          
E40F 	DIOM04          E421 	DIOM05          E427 	DIOM06          
E434 	DIOM07          E446 	DIOM08          E450 	DIOM09          
E3CD 	DIOM10          E472 	DIOM11          E326 	DIOM13          
E341 	DIOMD1          E365 	DIOMD2          E330 	DIOMR           
E335 	DIOMRK          DDA9 	DIONFM          DDAE 	DIONFT          
E3F7 	DIONS           E401 	DIONSE          E32B 	DIONSS          
E36D 	DIOOP           DD91 	DIOPHY          E3C4 	DIORD           
E3C8 	DIORDS          E3DA 	DIORKL          E2C9 	DIORTN          
DD91 	DIORTY          E2C2 	DIORUN          E3D5 	DIOSL1          
E45B 	DIOSL2          DD8C 	DIOSSP          E325 	DIOSTP          
E366 	DIOSYN          E37C 	DIOTR0          E39D 	DIOTR1          
E3A5 	DIOTRE          E37C 	DIOTRR          DD74 	DIOTRS          
DD63 	DIOTS1          DD51 	DIOTS2          DD62 	DIOTS4          
E36F 	DIOTSR          DD75 	DIOTSS          E46D 	DIOW00          
E408 	DIOWFM          E41C 	DIOWFS          E46B 	DIOWM1          
E45A 	DIOWRT          F0E9 	DIRBUF          0002 	DISK5           
0001 	DISK8           2A7D 	DISKA           2D3C 	DISKB           
2D3C 	DISKC           0000 	DISKD           2D3C 	DISKDI          
DD09 	DISKII          DCFF 	DISKIO          0003 	DISKNB          
E42E 	DIWMFM          E441 	DIWMFS          0003 	DLGINT          
F2B9 	DMABUF          DCC5 	DMOVEW          E45D 	DOTI1           
E45F 	DOTI2           E461 	DOTI3           CF6F 	DPBA            
0009 	DPBALC          CFBC 	DPBB            0011 	DPBBFM          
0003 	DPBBLM          0002 	DPBBLS          CFEF 	DPBC            
000B 	DPBCHK          0007 	DPBDIR          0015 	DPBDNR          
E52A 	DPBEM           0004 	DPBEXM          0004 	DPBF86          
0005 	DPBFDS          0002 	DPBFFM          000F 	DPBFLG          
0007 	DPBFND          0006 	DPBFRM          0003 	DPBFSM          
0003 	DPBFSV          0033 	DPBLNG          E52A 	DPBM            
000D 	DPBOFS          0016 	DPBPTR          0005 	DPBSIZ          
0010 	DPBSLC          0013 	DPBSN0          0000 	DPBSPT          
0017 	DPBSTI          0012 	DPBSTP          0019 	DPBSTR          
0007 	DPBT52          0004 	DPBT5Z          0005 	DPBT80          
0003 	DPBTDD          0000 	DPBTDS          0014 	DPBTRK          
0006 	DPBTWV          0018 	DPBTYP          CF3F 	DPHA            
E51A 	DPHAA           CF4F 	DPHAB           CF5F 	DPHAC           
0000 	DPHAD           0000 	DPHAE           0000 	DPHAF           
0000 	DPHAG           0000 	DPHAH           0000 	DPHAI           
0000 	DPHAJ           0000 	DPHAK           0000 	DPHAL           
E51A 	DPHAM           0000 	DPHAN           0000 	DPHAO           
0000 	DPHAP           E857 	DPHATB          CF4F 	DPHB            
CF5F 	DPHC            E51A 	DPHEM           E51A 	DPHM            
000D 	DPHNB           E087 	DPREC1          DFD1 	DPREC2          
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-3


DFD4 	DPRECN          E08B 	DPRETR          DEF3 	DRDCDB          
DEF4 	DRDDEV          DEF3 	DRDFLG          D8CC 	DRDFRM          
DEF5 	DRDTRK          DF46 	DRV0            DF4F 	DRV0A           
DBDD 	DRW             DC09 	DRWBNR          DBB7 	DRWERR          
DD37 	DRWNSP          DCFC 	DRWSEC          DF0E 	DSECTR          
D8AC 	DSELNB          E2AF 	DSIDMT          E0A5 	DSIDMZ          
0009 	DSIDTL          DCE4 	DSIDTR          DCE1 	DSIDTT          
DA9A 	DSIZDZ          DA97 	DSIZME          DA94 	DSIZMZ          
0000 	DSK5FM          0002 	DSK5MF          0003 	DSK80           
0000 	DSK8FM          0001 	DSK8MF          DFA2 	DSKDA           
DF8F 	DSKDAW          0002 	DSKDS           DF8F 	DSKMO1          
DFA4 	DSKMON          DCFF 	DSKTRA          0004 	DSLBLK          
0002 	DSLDIR          0001 	DSLFO           0005 	DSLL            
E28B 	DSLN0           E294 	DSLN1           E29D 	DSLN2           
E2A6 	DSLN3           0009 	DSLNL           E278 	DSLNMT          
E16F 	DSLNMZ          0003 	DSLOFF          0001 	DSLSPT          
0000 	DSLTRK          0000 	DSLVO           DCB5 	DSMOVE          
D5F9 	DSWE            0001 	DSY5            D5B1 	DSZTA           
0018 	DSZTAL          DF0C 	DTRACK          E0FF 	DTRDYT          
E102 	DTRDYW          E0FF 	DTRDYZ          E2FD 	DTRNER          
E300 	DTRNSR          DE26 	DTROK           E12A 	DTRRDE          
E303 	DTRRDR          E2F9 	DTRRET          DE46 	DTRSL0          
DE64 	DTRSL1          DE83 	DTRSL2          DEA1 	DTRSL3          
DE32 	DTRSLA          DFE2 	DTRSLL          E2FA 	DTRTOR          
E2FA 	DTRWJR          E11E 	DTRWRE          E306 	DTRWRR          
D049 	DUMI            D04C 	DUMO            D059 	DUMOH           
D046 	DUMST           DF19 	DWRTYP          0001 	EM256           
4000 	EM256ADR        0261 	EMINA           03D0 	EMINE           
02B2 	EMT0            02B6 	EMT1            02CD 	EMT2            
0001 	ERRVAR          0001 	ESCPC           0007 	F1715           
0001 	FDC             000B 	FDC3            E111 	FEHRET          
0220 	FL.KA1          0226 	FL.KA2          0235 	FL.KA3          
023D 	FL.KA4          023F 	FL.KA5          0249 	FL.KA6          
025D 	FL.KA7          E1CD 	FL.STO          E16A 	FL.TO1          
E19F 	FL.TSB          E1DE 	FL.ZTO          0011 	FLCOAC          
0010 	FLCOAD          0013 	FLCOBC          0012 	FLCOBD          
0015 	FLDAAC          0014 	FLDAAD          0017 	FLDABC          
0016 	FLDABD          E16E 	FLMODF          DF24 	FLOPPY          
E200 	FLRES           0018 	FLSEL           0001 	FORMAT          
E216 	FT.ADR          E21D 	FT.ANZ          E215 	FT.KOM          
E21C 	FT.LEN          E218 	FT.LWN          E21B 	FT.SEC          
E21A 	FT.SID          E21F 	FT.STI          E21E 	FT.STP          
E219 	FT.TRK          4000 	HBEMADR         0000 	HDSK            
E1F8 	HEADUP          DB20 	HOME            DB2C 	HOME1           
00DA 	HRLC            02EC 	INL001          02F5 	INL003          
0311 	INL004          0320 	INL005          0284 	INLOOP          
0001 	INSLIN          0004 	INT16           E5B7 	INTCRT          
E571 	INTKBD          E577 	INTRAF          E574 	INTRBC          
E57B 	INTRET          E576 	INTRHL          E579 	INTSP           
F0E9 	INTSTK          00D0 	INTVB           01B6 	INTVCL          
F700 	INTVEC          00D0 	INTVL           F7D0 	INTVR           
00E0 	INTVSY          00D0 	INTVUC          2DBE 	IOBLPT          
0713 	IOBTTY          0713 	IOBUC1          0001 	IOBVAR          
0003 	IOBYTE          E687 	IODIS1          E680 	IODISP          
E1D5 	ITIMEO          00F8 	IVCTC0          00FA 	IVCTC1          
00FC 	IVCTC2          00FE 	IVCTC3          00E8 	IVDSK1          
00EA 	IVDSK2          00E0 	IVPAR           00E2 	IVPIOD          
00E6 	IVPROT          00F0 	IVPUN1          00F6 	IVPUN2          
00F2 	IVRDR1          00F4 	IVRDR2          00D0 	IVSIO0          
00D2 	IVSIO1          00D4 	IVSIO2          00D6 	IVSIO3          
00D8 	IVSIO4          00DA 	IVSIO5          00DC 	IVSIO6          
00DE 	IVSIO7          0001 	K2521           0006 	K2526           
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-4


084D 	K37DM1          07BB 	K37DM2          D1DE 	K37DM3          
D1F1 	K37DM4          D1FD 	K37DM5          D209 	K37DM6          
D226 	K37DM7          D22D 	K37DM8          0731 	K37PAR          
000A 	K37PRL          0000 	K5120           0001 	K5122           
0006 	K5126           0000 	K7024           0002 	K8915           
0E80 	KALTC           0EFF 	KALTCE          2723'	KALTEN          
0B9D 	KALTM           E7BD 	KALTS1          0180 	KALTSB          
19A3'	KALTSC          0D80 	KALTSL          E894 	KALTST          
0043 	KBDB3O          0042 	KBDBCI          D0AE 	KBDBCL          
0041 	KBDBCS          D07C 	KBDBFE          0014 	KBDBL           
0001 	KBDCAL          D09E 	KBDCO           D0F3 	KBDCO1          
D0F4 	KBDCO2          D183 	KBDCP1          0000 	KBDCPB          
0065 	KBDCPL          D236 	KBDCPT          D101 	KBDI            
D138 	KBDINN          D1A8 	KBDLCS          D101 	KBDMD1          
D1CA 	KBDMD2          D175 	KBDMD3          D187 	KBDMT1          
D0A5 	KBDNCO          D091 	KBDNCT          D0CD 	KBDNHC          
D0DA 	KBDNSL          D0B6 	KBDNST          D0BD 	KBDNSY          
0000 	KBDOTP          0003 	KBDP3O          0005 	KBDP5O          
0006 	KBDPCI          0001 	KBDPCS          0000 	KBDPIN          
D0F0 	KBDPT1          D0DC 	KBDPUT          D197 	KBDRC1          
D19B 	KBDRC2          D18B 	KBDRC3          D1AB 	KBDRC4          
D1B0 	KBDRC5          D19C 	KBDRC6          D16D 	KBDRCH          
D186 	KBDRCU          D082 	KBDRDT          0052 	KBDS2I          
0053 	KBDS2S          0059 	KBDS2T          0052 	KBDS3I          
0053 	KBDS3S          005A 	KBDS3T          0052 	KBDS4I          
0053 	KBDS4S          000C 	KBDS4T          004E 	KBDS5I          
004F 	KBDS5S          004A 	KBDS5T          005C 	KBDSCI          
005D 	KBDSCS          0058 	KBDSCT          D1C5 	KBDSLM          
072E 	KBDSMI          072F 	KBDSMS          072D 	KBDSMT          
0730 	KBDSNR          D07B 	KBDSNT          CF3B 	KBDSST          
D069 	KBDST           D16B 	KBDST0          D14D 	KBDST1          
D14F 	KBDSTC          D071 	KBDSTI          D159 	KBDSTM          
D29B 	KBDSTS          D071 	KBDSTZ          0C09 	KBDTYP          
D10F 	KBDWA           D12E 	KBDWB           D133 	KBDWE           
D101 	KBDWIN          D116 	KBDWST          D10A 	KBDWT           
00C8 	KCURDW          00C4 	KCURLF          00C7 	KCURPD          
00C5 	KCURPU          00C6 	KCURRI          00C2 	KCURUP          
00C1 	KCURWL          00C3 	KCURWR          0C37 	KEMLWT          
0C3E 	KEMMC           03AF 	KENN1           0000 	KES             
0E80 	KLTBEF          0E7F 	KLTKOM          0790 	KM06            
0766 	KM3454          0782 	KM3458          079E 	KM36            
0758 	KM37            07AC 	KM3S            0774 	KM8454          
0745 	KMODI1          0751 	KMODI2          073B 	KMODIF          
0006 	KMODL           075A 	KMODT           004A 	KRITBG          
004C 	KRITEN          0000 	L2BAHN          D20F 	LAMPB0          
D203 	LAMPB1          D1F7 	LAMPB2          D1EB 	LAMPB3          
D1E2 	LAMPB6          0040 	LAMPBF          D218 	LAMPBN          
D1CA 	LAMPEN          D1CE 	LAMPLT          E674 	LIST            
D60B 	LISTI           E668 	LISTST          0081 	LKALTC          
08AF 	LMP04           08B1 	LMP04E          08A3 	LMP04W          
0862 	LMP06           0878 	LMP06E          0878 	LMP34           
0896 	LMP3404         088B 	LMP34A          0891 	LMP34B          
08A0 	LMP34C          08AF 	LMP34E          0896 	LMP34W          
08B1 	LMP36           08C4 	LMP36A          08CA 	LMP36B          
08E8 	LMP36E          08CF 	LMP36W          0004 	LMPB2B          
0005 	LMPB2R          087C 	LMPB34          08B5 	LMPB36          
08CF 	LMPDG06         08DC 	LMPDGW          0006 	LMPERR          
0007 	LMPHCP          D224 	LMPOUT          D227 	LMPOW           
0000 	LMPSL0          0001 	LMPSL1          0002 	LMPSL2          
0003 	LMPSL3          D65A 	LOUTTO          D65A 	LOUTTP          
D613 	LOUTW1          D631 	LOUTWF          D611 	LOUTWS          
D615 	LOUTWT          0058 	LPTCTR          0058 	LPTCTS          
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-5


005E 	LPTDAT          D049 	LPTI            D5FF 	LPTO            
D671 	LPTST           005F 	LPTSTA          D6B0 	LSTLPT          
D60B 	LSTO            D60B 	LSTOCH          D72C 	LSTSB3          
D752 	LSTSD1          D75B 	LSTSD2          D73B 	LSTSDC          
D716 	LSTSE0          D720 	LSTSE1          D736 	LSTSR           
D736 	LSTSR1          D677 	LSTST           D677 	LSTSTI          
D693 	LSTTTY          D6CD 	LSTUC1          D67E 	LSYNCH          
000C 	LTPCS           0001 	LTPDC           0006 	LTPI            
000B 	LTPINI          0004 	LTPO            D79E 	LTPOT5          
D79B 	LTPOW5          0008 	LTPS            0003 	LTPSC           
0002 	LTPSD           0000 	LTPST           000A 	LTPW5           
E23E 	LWEXIS          0006 	M8_16           0004 	MAXLW           
E798 	MBRECO          E26E 	MDFM8           E264 	MDMFM5          
E25A 	MDMFM8          E245 	MDTBAD          000A 	MDTBL           
E7B1 	MHDIG1          E7AF 	MHLDIG          0000 	MKD256          
00A8 	MODADR          DFB6 	MODFL1          DFBB 	MODFL2          
00DB 	MONC            0000 	MONITOR         0000 	MPROT           
E79C 	MRECA           E799 	MRECOA          E7A9 	MRECOD          
E79C 	MRECOL          E7A0 	MRECOR          D901 	ND8MF           
DF77 	NFDEI2          D922 	NFRTFM          0B93 	NJUNG3          
E110 	NOERR           DF4A 	NOLW            E000 	NPOST0          
E6EB 	NSTPSP          E608 	NSTZCL          E702 	NSYNLR          
E608 	NT1STZ          0000 	N_PAGEN         0007 	N_PE            
0002 	N_RAMEN         0005 	N_S             0003 	N_STOP          
0005 	N_TRQ8          0003 	N_VI            0001 	N_WRITE         
0000 	OEM             0000 	OSS             038C 	PAINIT          
E519 	PARERR          0362 	PARMES          E500 	PARROU          
038F 	PBINIT          00E0 	PF0C            00E1 	PF1C            
00E2 	PF2C            00E3 	PF3C            00E4 	PF4C            
00E5 	PF5C            00E6 	PF6C            00E7 	PF7C            
00E8 	PF8C            00E9 	PF9C            00EA 	PFAC            
00EB 	PFBC            00EC 	PFCC            00ED 	PFDC            
00EE 	PFEC            00EF 	PFFC            E067 	PHRW            
E06B 	PHRWW           E069 	PHRWW1          0007 	PHYACT          
0000 	PIOA_0          0001 	PIOA_1          0002 	PIOA_2          
D689 	PORTPR          D689 	PORTPZ          E090 	PREC            
E1F5 	PRET1           E1F2 	PRET3           E1E7 	PRET4           
E1E5 	PRETX           0006 	PRRESET         E0B2 	PSIDE0          
E0B4 	PSIDE1          E0BE 	PSIDE2          E65C 	PUNCH           
E76D 	PUTMES          E067 	PVRW1           E070 	PVRW2           
0000 	RAF             0000 	RAMBYT          0E60 	RAMEAD          
0A71 	RAMEH           0E45 	RAMERT          0E75 	RAMETE          
0001 	RAMFL           0040 	RAMKB           E4F4 	RAMOFF          
E4C1 	RAMON           0AAC 	RAMTEN          0A8C 	RAMTER          
0E39 	RAMTOK          0E17 	RAMTT           0A5A 	RAMTZ           
E49E 	RDRAMF          E070 	RDWR            DBBA 	READ            
E650 	READER          E644 	READES          0000 	REBOOT          
0004 	RESET16         E540 	RET             E518 	RETTEA          
0000 	RNA             0018 	RQMASK          DF0C 	RTRACK          
E311 	SECAN1          E180 	SECANZ          DB3E 	SECTRAN         
E23D 	SEERC           00D1 	SEL0            00D2 	SEL1            
00D4 	SEL2            00D8 	SEL3            D993 	SEL48           
D9ED 	SEL5ZL          D9FB 	SELD40          DABA 	SELDAL          
DA49 	SELDDR          D9AA 	SELDL1          DAB5 	SELDLA          
D99F 	SELDLE          DA3B 	SELDO0          DA3C 	SELDOF          
D88E 	SELDSK          DA03 	SELDSS          D9BD 	SELDSV          
D9CC 	SELDXL          DAFF 	SELEX1          DAFB 	SELEX2          
DB13 	SELEX3          DB16 	SELEX4          DB17 	SELEX5          
DAD3 	SELEXB          DAC1 	SELEXT          DAEA 	SELEXV          
DB11 	SELEXX          D970 	SELNFM          DA03 	SELSET          
D98F 	SELSS           D901 	SELSTZ          D954 	SELSY0          
D957 	SELSY1          D944 	SELSY2          D959 	SELSYS          
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-6


E3AF 	SERR            E3B6 	SERR1           E3C0 	SERR2           
E14B 	SERRX           E843 	SETCLD          DB39 	SETDMA          
DF2D 	SETECR          DF34 	SETESP          DB34 	SETSEC          
DB2F 	SETTRK          DA80 	SF128E          DA63 	SF128Z          
0000 	SG0P            0001 	SG1B            E31C 	SIDLEN          
E31B 	SIDSEC          E319 	SIDSID          E318 	SIDTR           
DF42 	SP13            E1A0 	SP74            00CC 	SPCCE           
00CA 	SPCCLR          00CB 	SPCCNC          00C0 	SPCDEL          
00CD 	SPCINS          00CE 	SPCKOR          00CF 	SPCROL          
00D0 	SPCROR          E006 	SPE             E23C 	SPERC           
E166 	SPERR2          E160 	SPERR4          D63B 	SPIOER          
E241 	SPNRL           E006 	SPPRTY          E020 	SPRE            
E01C 	SPVE            E0CB 	SRDSID          0000 	STATZ1          
FF80 	STATZ2          0027 	STATZB          0000 	STATZC          
0001 	STATZD          05FA 	STATZE          0020 	STATZI          
0007 	STATZK          0024 	STATZL          057A 	STATZM          
0004 	STATZS          0042 	STATZT          0039 	STATZU          
E026 	STEP            E029 	STEP0           E02D 	STEP2           
E03E 	STEPW           E03C 	STEPW1          E763 	STOPCH          
E732 	STOPNU          0004 	STOPRQ          E71C 	STOPRT          
E71F 	STOPZ           E743 	STOPZ2          E74F 	STOPZ3          
E72A 	STOPZU          00DE 	STPC            E756 	STPCHP          
F0D1 	STPSTK          0001 	STPVAR          0006 	STZAUS          
05A1 	STZB            0011 	STZBL           E789 	STZBTO          
E603 	STZCLZ          0005 	STZFRM          0581 	STZKA           
0598 	STZKE           0006 	STZKL           0080 	STZML           
007C 	STZTRN          D515 	SWILMP          00D9 	SYLC            
CF3D 	SYNFLG          0003 	SYNLRQ          CF3E 	SYNSEM          
000C 	SYSCTC          E61C 	T1NMO1          E616 	T1NMO2          
E5A3 	T1UHR1          E59C 	T1UHR2          E5CB 	T1UHR3          
E5CF 	T1UHR4          E5AE 	T1UHRE          E5D5 	T1UHRN          
E558 	T5IHL           03A0 	TESTK1          03A8 	TESTK2          
0043 	TIM1CN          0003 	TIM1CT          E57E 	TIM1IT          
E54C 	TIM1OF          E545 	TIM1ON          E547 	TIM1OT          
0045 	TIM1RT          E58E 	TIM1UP          E608 	TIM1UU          
0041 	TIM5CN          0002 	TIM5CT          E550 	TIM5IT          
E541 	TIM5OF          E53A 	TIM5ON          E53C 	TIM5OT          
0030 	TIM5ZK          0100 	TPA             C105 	TPAEND          
0007 	TREN            E048 	TRK0            E061 	TRK0F           
E04A 	TRK0I           E053 	TRK0S           0394 	TSTKNG          
000C 	TTYCTR          000C 	TTYCTS          0050 	TTYDAT          
D049 	TTYI            D5F9 	TTYO            D66B 	TTYST           
0051 	TTYSTA          0024 	TYP80           00A0 	TYPC34          
0080 	TYPC37          0010 	TYPC3S          0014 	UC1BFL          
D879 	UC1BFP          D87A 	UC1BUF          000C 	UC1CTR          
000C 	UC1CTS          0050 	UC1DAT          D85F 	UC1ERR          
D7D7 	UC1I            D7D3 	UC1I2           D7DB 	UC1II           
0004 	UC1IL           D802 	UC1IRD          D7DB 	UC1IW           
D605 	UC1O            D847 	UC1RI1          D857 	UC1RI2          
D815 	UC1RIN          D842 	UC1RIR          D7AC 	UC1SI           
D7CB 	UC1SI1          D7A8 	UC1ST           0051 	UC1STA          
0ACA 	UHRCHR          0AF9 	UHRIF1          0AB5 	UHRIN1          
0B65 	UHRIN4          0B03 	UHRINB          0B13 	UHRINC          
0B57 	UHRINE          0AF7 	UHRINF          0B1D 	UHRINI          
0AF3 	UHRINL          0B54 	UHRINN          0B47 	UHRINS          
0AF0 	UHRINZ          0001 	UHRVAR          0AC7 	UHRW4           
0001 	UMLAUT          D597 	UMLCN1          0002 	UMLFLG          
000B 	UMLLEN          D59A 	UMLTB1          D5A5 	UMLTB2          
DF13 	UNACNT          DF14 	UNADEV          DF17 	UNASEC          
DBAE 	UNATR1          DF15 	UNATRK          0059 	VERSJ           
0009 	VERSM           0019 	VERST           E78A 	WAIT10          
E78F 	WAIT1Z          E78D 	WAIT2Z          E7C9 	WARMST          
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-7


E7DA 	WBINIT          0000 	WBOOTV          DB42 	WRITE           
E0DD 	WRITPT          E47B 	WRRAMF          DEC8 	XLT             
E013 	XMAXTR          E004 	XPVRW           00DD 	Z000            
00DC 	Z00C            00F0 	ZBL0            00DC 	ZBL00           
00DD 	ZBL000          00F1 	ZBL1            00F2 	ZBL2            
00F3 	ZBL3            00F4 	ZBL4            00F5 	ZBL5            
00F6 	ZBL6            00F7 	ZBL7            00F8 	ZBL8            
00F9 	ZBL9            00FC 	ZBLA            00C9 	ZBLB            
00FE 	ZBLC            00FA 	ZBLKOM          00FB 	ZBLMIN          
0000 	ZSIBM           0001 	ZSUML           



No Fatal error(s)


   DF14 	UNADEV          DF17 	UNASEC          
DBAE 	UNATR1         