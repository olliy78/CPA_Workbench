BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1


                                	title	BIOS CP/A, Buerocomputer (A5120/30 u. ae.)
                                	name	('BIOSMOD')
                                	.z80
                                	.tfcond		;bei Assembler-Aufruf mit "/X" vollst. Listing
                                
                                ; Versionsangabe:
                                ;----------------
  0019                          verst	equ	25	;Tag
  0009                          versm	equ	09	;Monat
  0059                          versj	equ	89	;Jahr
                                
                                	.list
                                
                                ;=====================================================================
                                ; Vereinbarungen fuer aktuelle Variante
                                ; Buerocomputer A5120/30
                                ;=====================================================================
  0000                          dev	equ	oem
  0006                          cpu	equ	k2526
  0019                          cpuclk	equ	25	;Takt der CPU; 25 bei 2,5Mhz; 40 bei 4,0Mhz
  0001                          fdc	equ	k5122
  0000                          crt	equ	k7024
                                
  F800                          bsanf2	equ	0f800h		;Anfang Bildschirmpuffer BAB2
  FC00                          bsanf1	equ	bsanf2+400h	;Anfang Bildschirmpuffer BAB1
  0800                          crtbfl	aset	800h		;benoetigter Bildschirmpuffer im Haupt-RAM
                                				;400h/800h, wenn Bildschirm nicht weggeschaltet
                                				;0   , wenn Bildschirm nicht im Haupt-RAM,
                                				;dann Makros 'crton', 'crtoff' definieren!
                                
                                ; eventuelle Routinen zum Aktivieren/Deaktivieren des Bildschirmpuffers
                                ; (ueber MEMDI/MEMDI1/MEMDI2) koennen hier eingefuegt werden:
                                
                                ; Aktivieren Bildschirmpuffer, nur Reg. BC,HL; kein Stack!
                                ;----------------------------
                                crton	MACRO
                                	ENDM
                                
                                ; Deaktivieren Bildschirmpuffer, nur Reg. BC,HL; kein Stack!
                                ;------------------------------
                                crtoff	MACRO
                                	ENDM
                                ;=====================================================================
                                
                                
                                	entry	BIOS,BIOSCE
  0E00                          bdosln	equ	0e00h
  0800                          ccpln	equ	0800h
                                
  0000'                         BIOS:
                                
                                ;***********************************************************
                                ; Generierungsvarianten und andere Equ's:
                                ; =======================================
                                
                                ; Vorbemerkung:
                                ; Alle in '"..."' eingeschlossenen Worte sind Bezeichner,
                                ; die in dem vorliegenden Assembler-Quelltext gesetzt werden.
                                
                                ; BIOS-Laenge (Grundwert, wird spaeter evtl. modifiziert!)
                                ; -----------
                                ;	minimal erreichbare BIOS-Laenge
                                ;	 ohne Bildschirmpuffer
                                ;	 ohne Interruptvektoren
                                ;	 0 Diskettenlaufwerke
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-1


                                ;	 ohne Diskettenpuffer
                                ;	 ohne Extra's
  0880                          biosln	aset	0880h ;07d0h
                                
                                ; Durch Weglassen der CP/A-Extras kann man den TPA-Bereich
                                ; um den Wert vergroessern, der sonst zu 'biosln' addiert
                                ; wird.
                                
                                ;	Hauptspeicher
                                ;	~~~~~~~~~~~~~
                                ; Bei Kaltstart erfolgt ein nichtzerstoerender RAM-Test von
                                ; "tpa"+3 bis "tpaend".
                                ; Wird dabei ein Speicherfehler erkannt, so wird auf die
                                ; letzten 3 fehlerfreien RAM-Zellen ein Sprung zum BDOS abge-
                                ; legt und der BDOS-Sprung auf Hauptspeicherplatz 5-7 auf
                                ; diesen Sprung gefuehrt. Ausserdem erfolgt eine entsprechende
                                ; Fehlermeldung beim Kaltstart.
                                
  0040                          ramkb	equ	64	;RAM-Groesse in Kilobytes
                                ;			 Bildschirmpuffer am Ende!
  0000                          rambyt	equ	ramkb*1024
                                
                                ; Falls eine 48k Speichererweiterung (OSS 062-8471) vorhanden
                                ; ist, so wird beim Kaltstart eine RAM-Floppy "M:" fuer diesen
                                ; Bereich angelegt.
                                ; Bei "oss"=0 erfolgt kein Test auf eine evtl. vorhandene
                                ; OSS-Karte.
                                
  0000                          oss	equ	0	;=0, wenn keine OSS-Karte vorhanden
                                ;			 =1, wenn evtl. OSS-Karte vorhanden
                                	IF	oss
                                	ENDIF
                                
                                
                                ; Wenn eine 16-Bit-Erweiterungskarte mit 256k-Speicher EM256 in-
                                ; stalliert ist, so kann dieser Speicher als RAM-Floppy 'M:' be-
                                ; nutzt werden.
                                ; Bei "em256" ungleich Null wird das Vorhandensein einer Erweite-
                                ; rungskarte getestet. Bei vorhandener EM256 wird beim Kaltstart
                                ; die RAM-Floppy eingerichtet.
                                ;
  0001                          em256	equ	1	;=0 ,wenn keine 16-Bit-Erweiterung
                                						;=1 ,wenn 16-Bit-Erweiterung vorhanden
                                	IF	em256
  0A40                          biosln	aset	biosln+1c0h
  4000                          em256adr equ	4000h	;256k-RAM wird vom U880 unter Adr.
                                			;4000..07FFFH angesprochen
                                			;!! 0 nicht moeglich wegen Konflikt mit Kaltstart
  00A8                          modadr	equ	0a8h	;Moduladresse der em256
                                	ENDIF
                                
                                ; Die RAM-Floppy mkd256 kann als Laufwerk 'M:' angesprochen werden.
                                ; Bei "mkd256" ungleich Null wird das Vorhandensein einer entsprechenden
                                ; Karte getestet. Ist diese vorhanden wird sie beim Kaltstart initialisiert
  0000                          mkd256	equ	0	; =0, ohne RAM-Floppy
                                							; =1, mit
                                
                                	IF	mkd256
                                	ENDIF
                                
  0000                          kes	equ	0	;keine Testram KES unterstuetzt
                                
                                ; Wenn mindestens eine RAF-Karte des ZWG der AdW vorhanden ist (beliebig
                                ; bestueckt, auch nur teilweise und/oder gemischt, max. 2M Byte pro Karte,
                                ; max. 4 Karten mit aufeinanderfolgenden E/A-Adressen), so kann bzw.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-2


                                ; koennen diese als RAM-Floppy 'M:' benutzt werden (ueber "SWAP A: M:"
                                ; bei Bedarf spaeter auch als LW A:)
                                ; Bei "raf" ungleich Null wird das Vorhandensein von RAF-Karten getestet.
                                ; Bei vorhandener(n) Karte(n) wird beim erstmaligen Kaltstart nach dem
                                ; Einschalten des Stromes die RAM-Floppy eingerichtet, bei RESET bleibt ihr
                                ; Inhalt erhalten.
                                ;
  0000                          raf	equ	0 ;=0 ,wenn keine RAF-Karte
                                					;=1 ,wenn RAF-Karte(n) vorhanden
                                 IF	raf
                                 ENDIF
                                
                                ; Wenn mindestens eine NANOS-256k-DRAM-Karte vorhanden ist (beliebig
                                ; bestueckt, auch nur teilweise und/oder gemischt, max. 256k Byte pro Karte,
                                ; max. 4 Karten mit jeweils beliebigen E/A-Adressen), so kann bzw.
                                ; koennen diese als RAM-Floppy 'M:' benutzt werden (ueber "SWAP A: M:"
                                ; bei Bedarf spaeter auch als LW A:)
                                ; Bei "rna" ungleich Null wird das Vorhandensein von NANOS-RAF-Karten getestet.
                                ; Bei vorhandener(n) Karte(n) wird beim erstmaligen Kaltstart nach dem
                                ; Einschalten des Stromes die RAM-Floppy eingerichtet, bei RESET bleibt ihr
                                ; Inhalt erhalten.
                                ;
  0000                          rna	equ	0 ;=0 ,wenn keine NANOS-RAF-Karte
                                					;=1 ,wenn mindestens eine NANOS-RAF-Karte da
                                 IF	rna
                                 ENDIF
                                
  0001                          ramfl	equ	oss+kes+em256+mkd256+raf+rna
                                
                                ;	Kaltstart
                                ;	~~~~~~~~~
                                ; Es besteht die Moeglichkeit, beim Kaltstart des Systems automatisch
                                ; ein Kommando auszufuehren (dies kann auch ueber SUBMIT eine Kommando-
                                ; folge sein!).
                                
                                 IF1
                                 ENDIF
  0000                          cldcmx	equ	0		;=0, wenn Kommando nur bei Kaltstart
                                				;    nach Einschalten auszufuehren
                                				;=1, wenn Kommando auch bei RESET
                                				;    auszufuehren
                                
                                ;	Warmstart
                                ;	~~~~~~~~~
                                ; Im Normalfall wird das CCP von einer im BIOS gehaltenen Kopie
                                ; bei jedem Warmstart vor das BDOS kopiert, wodurch keine Sy-
                                ; stemspuren auf Laufwerk A erforderlich sind. Um einen maximal
                                ; grossen TPA zu erhalten, sind auch andere Varianten moeglich:
                                
  0000                          wbootv	equ	0
                                ;		=0:	CCP-Kopie im BIOS (2K grosser Puffer)
                                ;		=1:	keine CCP-Kopie, Warmstart=Kaltstart
                                ;			(Kaltstart-Kommando sollte leer sein!)
                                ;		=2:	keine CCP-Kopie, CCP aus File '@os.com'
                                ;		=3:	CCP-Kopie in RAM-Floppy (RAM-Floppy
                                ;			dann um 2K kleiner),
                                ;			wenn keine RAM-Floppy vorhanden
                                ;			(siehe "Hauptspeicher"), so wie wbootv=1
                                ;		=4:	keine CCP-Kopie, CCP aus File '@ccp.com'
                                ;			selbstversch. vor BDOS o. Treiber geladen
                                ; Bei "wbootv"<>0 und Arbeit ohne Diskettenpuffer kann der
                                ; Kaltstart-Code u.U. bis in den Bildschirmpuffer reichen,
                                ; wodurch der Bildschirm beim Kaltstart kurzzeitig undefi-
                                ; niert sein kann.
                                
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-3


                                	IF	wbootv eq 0
  12D0                          biosln	aset	biosln+90h+ccpln;2K fuer CCP-Kopie
                                	ENDIF
                                	IF	(wbootv eq 2) or (wbootv eq 3) or (wbootv eq 4)
                                	ENDIF
                                
                                ;	BIOS-Monitor
                                ;	~~~~~~~~~~~~
  0000                          monitor equ	0	;=1: mit  BIOS-Monitor
                                ;			 =0: ohne
                                	IF	monitor
                                	ENDIF
                                
                                
                                ;	STOP-Funktion
                                ;	-------------
  0001                          stpvar	equ	1	;=1: mit Unterstuetzung STOP-Funktion
                                			;=0: ohne,
                                			;    es werden auch alle Drucker-Sondert. ign.
                                	IF	stpvar
  13A0                          biosln	aset	biosln+0d0h
                                	ENDIF
                                
                                ;	Speicherschutz
                                ;	~~~~~~~~~~~~~~
  0000                          mprot	equ	0	;=1: mit Speicherschutz
                                ;			 =0: ohne
                                	IF	mprot
                                	ENDIF
                                
                                ;	Status-Zeile
                                ;	------------
  0000                          cpastz	equ	0	;Statuszeile hardware-maessig nicht moeglich
                                
                                	IF	cpastz
                                	ENDIF
                                
                                ;	Fehlermeldungen des BIOS
                                ;	------------------------
  0001                          errvar	equ	1	;=1: mit BIOS-Fehlermeludngen
                                			;=0: ohne
                                	IF	errvar
  13F0                          biosln	aset	biosln+50h
                                	ENDIF
                                
                                ;	Uhr
                                ;	---
  000C                          sysctc	equ	0ch	;System-CTC, Kanal 0
                                ; Fuer die Uhr wird Kanal 2 und 3 benutzt (5ms, 1sec),
                                ; Kanal 0,1 steht fuer den Anwender frei
                                
  0000                          uhrvar	equ	0	;=1: mit BCD-Uhr (Platz siehe "bcduhr")
                                ;			 =0: ohne
                                	IF	uhrvar
                                	ENDIF
                                
                                ;	IOBYTE
                                ;	------
  0001                          iobvar	equ	1	;=1: mit IOBYTE-Unterstuetzung
                                			;=0: ohne (wie IOBYTE=00h)
                                	IF	iobvar
  1490                          biosln	aset	biosln+0a0h
                                	ENDIF
                                
                                ;	Vereinbarungen fuer zeichenweise arbeitende Geraete (i.a. Drucker)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-4


                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                                ; gaengige Hardware (auch andere zulaessig):
                                ;	Karte A51xx	Daten	Status	CTC S/E Bemerkungen
                                ;	K8025		5e	5f	58/58	Normalfall IFSS
                                ;	K8025		5c	5d	58/58	i.a. Tastatur K7637
                                ;						oder Zusatzdrucker
                                ;						oder Digitalisiergeraet
                                ;	K8025		52	53	0c/0c	2. IFSS -Ausgang
                                ;			52	53	59/59	alternative Tastatur K7637
                                ;	K6028/K8025	50	51/53	0c/0c	V.24-Ausgang
                                ;	K8025.22/.32	a1	a3	a8/a8	AFS Spezial EC8404M
                                ;	K6022		54	56		Normalfall PIO-Drucker
                                ;	K6022		50	51		1154 ueber ADA -> Humboldt-Uni
                                ;	1154 Spezial	54	56		1154 Spezialanschluss
                                ;						1156-Anschl. siehe BIOSCP56.MAC
                                ;	1156 Spez. neg. 38	39		1156 ueber KME3, neg. Pegel
                                ;	1156 Spez. pos. 38	39		1156 ueber KME10,pos. Pegel
                                
                                ; Diese Ausgaenge koennen physischen CP/M-Geraeten entsprechend
                                ; der I/O-Byte-Belegung zugewiesen werden:
                                ; TTY:	bei Kaltstart zugewiesener Drucker		(kann fehlen)
                                ; LPT:	zweiter Drucker					(kann fehlen)
                                ; UC1:	Geraetekopplung ueber CON: oder RDR:/PUN:	(kann fehlen)
                                ;	Fuer UC1: nur Treiber-Typ DC1/3 oder DTR erlaubt (kein PIO)!
                                
                                ; Im folgenden fuer 'iobxxx', 'xxxdat', 'xxxsta', 'xxxcts', 'xxxctr'
                                ; jeweils die Parameter angeben:
                                ; (=00000 fuer fehlenden, d.h. vom BIOS nicht unterstuetzten Tr.)
                                ; Sind alle Treiber-Nr. =0, so entfaellt der gesamte Treiber-
                                ; teil im BIOS (fuer Testzwecke zum Erreichen eines grossen
                                ; TPA, alle Ausgaben und Druckersondertasten ignoriert)
                                ; Format fuer 'iobxxx':
                                ; PSCBT
                                ; PSCB	nur bei T<5 angeben, sonst 0000
                                ; P		Paritaet
                                ;		0 ohne Paritaet; 1 ungerade Paritaet; 2 gerade Paritaet
                                ;  S		Stopbits
                                ;		1  1   Stopbit
                                ;		2  2   Stopbits
                                ;		3  1.5 Stopbits
                                ;   C		Anzahl der Bits pro Zeichen (5..8)
                                ;    B		Baudrate
                                ;		1:9600,2:4800,3:2400,4:1200,5:600,6:300,7:150,8:100,9:75
                                ;     T		Treiber- und Protokoll-Typ
                                ;		0:DC1/DC3  (Normalfall IFSS)
                                ;		1:DTR im Kanal A mit Statusabfrage DTR ueber Kanal B, DCD
                                ;			   (Normalfall V.24 ueber K6028/K8025 mit DTR an DSR)
                                ;		2:Strombauch fuer LX86 (Information Koll. Tief, Bln. 6346461)
                                ;		  fuer PSCBT: 01812 (Baudrate wird durch 8 auf 1200bd geteilt)
                                ;		  fuer xxxdat: 5eh, fuer xxxsta: 5fh, fuer xxxctx: 58h
                                ;		3:DTR im Kanal A mit Statusabfrage DTR ueber Kanal A, CTS
                                ;			   (V.24 ueber K6028/K8025 bei DTR an CTS statt an DSR)
                                ;		5:PIO
                                ;		6:PIO1154 Spezialinterface (Hardware-Loesung nicht nachnutzbar)
                                ;		7:PIO1156 neg. Pegel (Hardware siehe BIOSCP56.MAC)
                                ;		8:PIO1156 pos. Pegel
                                ;		9:PIO1154 umgebaute ADA (Hardware siehe BIOSCH54.MAC)
                                
                                ; Standard-Drucker
                                ;=================
                                
                                ;iobtty	equ	11710	;ung. P.;1 Stbit;7 Bit;9600;DC1/3 (z.B. 1152,1157,63xx)
                                ;ttydat	equ	5eh	;IFSS Normalausgang
                                ;ttysta	equ	5fh
                                ;ttycts	equ	58h
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-5


                                ;ttyctr	equ	58h
                                
  0713                          iobtty equ      01811   ;ohne P. ;  1 Stbit; 8 Bit 9600; DTR ueb.Kanal A
  0050                          ttydat equ      50h     ; V.24 - Ausgang
  0051                          ttysta equ      51h
  000C                          ttycts equ      0ch
  000C                          ttyctr equ      0ch
                                 
                                ; zweiter Drucker
                                ;================
                                
                                ;ioblpt	equ	0	;ohne P.; 1 Stbit;8 Bit;9600;DTR (z.B. EPSON LX86)
                                ;lptdat	equ	50h	;V.24
                                ;lptsta	equ	51h
                                ;lptcts	equ	0ch
                                ;lptctr	equ	0ch
                                
  2DBE                          ioblpt	equ	11710	;ung. P.;1 Stbit;7 Bit;9600;DC1/3 (z.B. SD1152,K63xx)
  005E                          lptdat	equ	5eh	;IFSS Normalausgang
  005F                          lptsta	equ	5fh
  0058                          lptcts	equ	58h
  0058                          lptctr	equ	58h
                                
                                ; Kopplung
                                ;=========
                                				
                                ;iobuc1	equ	0	;ohne P.;1 Stbit;8 Bit;9600;DTR
                                ;uc1dat	equ	50h	;am V.24-Ausgang
                                ;uc1sta	equ	51h
                                ;uc1cts	equ	0ch
                                ;uc1ctr	equ	0ch
                                ;uc1bfl	equ	20		;Laenge des UC1:-Puffers
                                				;muss z.B. 2k Bildschirmrollen abfangen!
                                				;d.h. >=20 bei 9600 bd
                                
  0713                          iobuc1	equ	01811	;ohne P.;1 Stbit;8 Bit;9600;DTR
  0050                          uc1dat	equ	50h	;am V.24-Ausgang
  0051                          uc1sta	equ	51h
  000C                          uc1cts	equ	0ch
  000C                          uc1ctr	equ	0ch
  0014                          uc1bfl	equ	20		;Laenge des UC1:-Puffers
                                				;muss z.B. 2k Bildschirmrollen abfangen!
                                				;d.h. >=20 bei 9600 bd
                                				
                                ; Ueber diese Treiber koennen unter Beachtung des unterschiedlichen
                                ; Steuerzeichenvorrats beliebige Geraete angeschlossen werden, die
                                ; Treiber-Software ist steuerzeichenunabhaengig
                                ; (ausser TTY: und LPT: bei generierter Variante 2-Bahn-Drucker).
                                
                                ; Es besteht die Moeglichkeit, 2-Bahn-Drucker getrennt fuer
                                ; jede Bahn zu betreiben (nur Druckerschnittstelle 1):
  0000                          l2bahn	equ	0		;>0: Position fuer 2. Bahn (i.a. 138)
                                				;=0: keine 2. Bahn unterst.
                                
                                ;----Auswertung der ausgewaehlten Varianten
                                 IF1
                                 ENDIF
                                
  FFFF                          chdvar	equ	(iobtty ne 0) or (ioblpt ne 0) or (iobuc1 ne 0)
                                 IF	chdvar
                                  IF cdtdc1 or cdtdtr		;IFSS, V.24
  15E0                          biosln	aset	biosln+150h
                                  ENDIF
                                  IF cdtsib			;Strombauch
                                  ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-6


                                  IF cdtpio			;PIO
                                  ENDIF
                                  IF cdtp54			;Spez. 1154
                                  ENDIF
                                  IF cdth54			;ADA 1154
                                  ENDIF
                                  IF cdtn56			;1156 neg
                                  ENDIF
                                  IF cdtp56			;1156 pos.
                                  ENDIF
                                
                                  IF stpvar
  1670                          biosln	aset	biosln+090h	;asynchrone LST:-Routinen
                                				;und Hardcopy
                                  ENDIF
                                
                                  IF	iobuc1
  1764                          biosln	aset	biosln+0e0h+uc1bfl ;UC1:-Routinen + UC1:-Puffer
                                  ENDIF
                                
                                  IF l2bahn
                                  ENDIF
                                
                                 ENDIF ;chdvar
                                ;---Ende Auswertung zeichenweise Treiber
                                
                                
                                ;	Vereinbarungen fuer Disketten
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                                
  0001                          @write	equ	1	;bei <>0 auch Schreiben auf Disketten unterst.
                                ; Es werden maximal 4 Diskettenlaufwerke A..D dicht von A
                                ; beginnend unterstuetzt.
                                ; Diese koennen sowohl 5 1/4 " als auch 8" Laufwerke sein
                                ; (auch gemischte Konfigurationen erlaubt!).
                                ; Fuer jedes Laufwerk kann Zuruecklesen nach jedem Schreiben verlangt
                                ; werden (Verify), fuer sichere Disketten und Laufwerke dies jedoch i.a.
                                ; nicht notwendig (Schreiben geht dann genauso schnell wie Lesen), lediglich
                                ; beim Anlegen einer Sicherheitskopie sollte explizit Verify vom Kopier-
                                ; programm verlangt werden ([v] bei POWER bzw. DIENST). Die bei der System-
                                ; generierung eingestellte Variante kann durch FORMAT laufwerksspezifisch
                                ; geaendert werden.
                                
                                ; Folgende Angaben sind verbindlich:
                                ;DSZTT
                                ;D		Density; 0 single (SD bzw. FM), 1 double (DD bzw. MFM)
                                ; S		Sided; 0 single (SS), 1 double (DS)
                                ;		bei Verify nach Schreiben S+2 angeben
                                ;  Z		5 fuer 5 1/4 ", 8 fuer 8 "
                                ;   TT		Anzahl der tracks
                                ; z.B.
                                ; 10540		DD, SS, 5", 40 Tracks (z.B. K5600.10)
                                ; 10580		DD, SS, 5", 80 Tracks (z.B. K5600.20)
                                ; 11580		DD, DS, 5", 80 Tracks (K5601 !!!)
                                ; 00877		SD, SS, 8", 77 Tracks (z.B. MF3200)
                                ; 10877		DD, SS, 8", 77 Tracks (z.B. K5602.10, MF6400))
                                ; 0		nicht ex. (immer am Ende!)
                                
                                ;diskA	equ	13580 ;DD, DS mit Verify nach Schreiben, 5", 80 Tracks (K5601)
                                ;diskB	equ	13580
                                ;diskC	equ	13580
                                ;diskD	equ	0
                                
  2A7D                          diskA	equ	10877
  2D3C                          diskB	equ	11580
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-7


  2D3C                          diskC	equ	11580
  0000                          diskD	equ	0
                                
                                ; Es wird eine automatische Formaterkennung fuer gaengige CP/M-
                                ; Diskettenformate einschliesslich der SCP-Hausformate von CP/A
                                ; unterstuetzt. Dies kann unterdrueckt werden, wenn nur mit
                                ; festen Formaten gearbeitet wird (und eine extra CP/A-Variante
                                ; fuer den Datenaustausch mit Formaterkennung existiert). In
                                ; diesem Fall haben die Disketten das Standard-CP/A-Format ent-
                                ; sprechend dem vorgegebenen LW-Typ.
                                
  0001                          format	equ	1	;=1 mit, =0 ohne Routinen fuer autom. Formaterkennung
  0000                          @fsys	equ	0	;=1 mit, =0 ohne Systemspuren fuer Standardformat
                                 IF format
  0001                          @fact	equ	1	;=1 mit, =0 ohne automatische Formaterkennung scharf
                                 ENDIF
                                 IF format
  19B4                          biosln	aset	biosln+250h	;Routinen +Tabellen
                                 ENDIF
                                
                                ; Zur automatischen Format-Erkennung von SIOS-Datendisketten wird
                                ; auf 40h in Spur 0, Sektor 1 geprueft. Solche Disketten duerfen
                                ; also keine System-Lader-Informationen haben und werden dann als
                                ; "CP/M"-Disketten ohne Systempuren behandelt. Dadurch ist die Anwen-
                                ; dung von Original-Konvertierungsprogrammen IBM<->CP/M moeglich
                                ; {unter SCP existierende Programme laufen u.a. nur dann, wenn sie
                                ; konsequent den BIOS-Entry 30h (Sektornr. uebersetzen) nutzen!}.
                                
                                ; Ohne automatische Formaterkennung oder bei vorhandenen System-Lader-
                                ; informationen auf der SIOS-Diskette muss das Format explizit einge-
                                ; stellt werden (26*128 einseitig ohne Systemspuren).
                                
                                 IF1
                                 ENDIF
  0002                          disk5	aset	dsk5fm+dsk5mf
  0001                          disk8	aset	dsk8fm+dsk8mf
  0003                          disknb	aset	disk5+disk8
                                 IF disknb ne 0
  1EB4                          biosln	aset	biosln+500h
                                 ENDIF
  1FF5                          biosln	aset	biosln+disknb*6bh	;Diskettensteuerbloecke
  200F                          biosln	aset	biosln+dsk8mf*26	;Verlaengerung Sektortab.
  20AF                          biosln	aset	biosln+disk8*16+dsk80*48;Checksize beruecks.
                                
                                ; Die Disketten Ein-/Ausgabe kann gepuffert verlaufen.
                                ; "dbufsz"<=7 fuehrt zur ungepufferten Arbeit (Codeeinsparung).
                                ; Die Angabe der Pufferlaenge erfolgt als Exponent von 2, d.h.
                                ; die Puffergroesse ist 2**dbufsz !
                                
  000A                          dbufsz	equ	10		;2**dbufsz = Pufferlaenge
                                	IF	dbufsz gt 7
  262F                          biosln	aset	biosln+180h+(1 shl dbufsz);Diskpuffer dazu
                                	ENDIF
                                
                                ; Der Diskettenpuffer muss mindestens so gross wie die groesste
                                ; physische Sektorlaenge entspr. dem Spurformat sein, also
                                ; i.a. 1K. Fuer eine exakte BDOS-Rueckmeldung von Schreib-
                                ; fehlern (BAD SECTOR) darf die Puffergroesse nicht groesser
                                ; als die kleinste Blockgroesse fuer Disketten (1 K) sein,
                                ; da sonst die Pufferausgabe erst erfolgt, wenn mit anderen
                                ; Daten gearbeitet werden soll.
                                ; Vorzugswert fuer "dbufsz" ist daher 10!
                                ; Mehr als die maximale Spurlaenge von ca. 6 1/4  K ergibt
                                ; keinen Gewinn, d.h. "dbufsz"<=13 .
                                ; "dbufsz"<12 fuehrt zu einer ungepufferten Arbeit bei Sektor-
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-8


                                ; laenge 128, da die Effektivitaet wegen des Sektorversatzes
                                ; bei Pufferung von Teilen einer Spur sinkt!
                                
                                ;	Vereinbarung fuer HardDisk
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~
                                
                                ; Ueber einen Spezialadapter kann am 8-bit-Bus eine XT-kompatible Festplatte
                                ; genutzt werden.
                                ; Weitere Informationen befinden sich im Quelltext BIOxHD.MAC.
  0000                          hdsk	equ	0	;=1, wenn HardDisk zu unterstuetzen
                                 if hdsk
                                 endif
                                
                                ;	Vereinbarung der Tastatur
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~
                                
                                ; Waehrend des Kaltstarts wird auf Typ K7604/06/34/36/37 ge-
                                ; testet und die Treiberroutinen modifiziert.
                                ; 'Standardmaessig' ist diejenige Routine generiert, die den
                                ; laengsten Code benoetigt, d.h. es wird in jedem Fall modi-
                                ; fiziert.
                                
                                ; Portbelegungen:
                                ;----------------
                                
                                ; PIO-Tastatur (i.a. PIO auf ZE-Platte)
                                ;=============
  0006                          kbdpci	equ	06h	;Zeichen-Eingabe
  0001                          kbdpcs	equ	01h	;Eingabe-Status
  0003                          kbdp3o	equ	03h	;Lampen ausser Selector
  0005                          kbdp5o	equ	05h	;LED Selector
  0000                          kbdpin	equ	0	;=0: kein CTC-Kanal als Tastatur-Interrupt
                                
                                ; Bankschalter-Tastatur K7633 an AUP 062-08531
                                ; ===========================
  0042                          kbdbci	equ	42h	;;Zeichen-Eingabe
  0041                          kbdbcs	equ	41h	;;Status
  0043                          kbdb3o	equ	43h	;;Lampen
                                
                                ; SIO-Tastatur (i.a. zusammen mit IFSS-Drucker [unterer Stecker] auf K8025)
                                ;=============
  0058                          kbdsct	equ	58h	;CTC		Takt von K8025-CTC Kanal 0
  005C                          kbdsci	equ	5ch	;Zeichen E/A	2.  Stecker von unten
  005D                          kbdscs	equ	5dh	;Status
                                ; weitere SIO-Tastatur-Anschluesse (z.B. bei Digitalisier-Arbeitsplatz)
                                ; wenn nicht zu unterstuetzen, so "kbdsNx"-Werte gleich 0 (N = 2..5)
                                ; Abfrage in der Reihenfolge kbdscx, kbds2x, kbds3x, kbds4x,...
  0059                          kbds2t	equ	59h	;CTC		Takt von K8025-CTC Kanal 1 (Umbau)
  0052                          kbds2i	equ	52h	;Zeichen E/A	2. Stecker von oben
  0053                          kbds2s	equ	53h	;Status
                                
  005A                          kbds3t	equ	5ah	;CTC		Takt von K8025-CTC Kanal 2 (Umbau)
  0052                          kbds3i	equ	52h	;Zeichen E/A	2. Stecker von oben
  0053                          kbds3s	equ	53h	;Status
                                
  000C                          kbds4t	equ	0ch	;CTC		Takt von CPU (so K8025 ausgeliefert)
  0052                          kbds4i	equ	52h	;Zeichen E/A	2. Stecker von oben
  0053                          kbds4s	equ	53h	;Status
                                
  004A                          kbds5t	equ	4ah	;CTC
  004E                          kbds5i	equ	4eh	;Zeichen E/A
  004F                          kbds5s	equ	4fh	;Status
                                
                                
                                ; Die folgenden Typcode-Zeichen werden in der Reihenfolge
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-9


                                ; der Tastaturnummern abgetestet (falls durch PROM-Aenderung
                                ; der gleiche Typcode wie fuer eine andere Tastatur geliefert
                                ; wird, kann man so bestimmte Tastaturen bevorzugen).
                                
  0000                          kbdotp	equ	0 ;Typ der Tast. die keinen Typcode liefert:
                                ;			=0 fuer K7606
                                ;			=1 fuer K7604
                                ;			=2 fuer DEG-Spezialtastatur am IIR
                                ;			=3 fuer K7633 an AUP 062-8531
  0010                          typc3s	equ	010h	;Sondertastatur IH Mittweida (modif. K7634)
  00A0                          typc34	equ	0a0h	;K7634 ausser K7634.54
                                
                                ; Typ der Tastatur, die Typcode 80h liefert:
                                ; von den equ-Zeilen genau eine ohne Semikolon davor!
                                ;typ80	equ	3454	;K7634.54 (UBT-Tastatur)
  0024                          typ80	equ	36	;K7636-Familie
                                
  0080                          typc37	equ	080h	;K7637
                                
                                
                                ; Der Tastaturpuffer befindet sich bei Arbeit mit Statuszeile
                                ; an deren Ende, so dass der Kopf staendig auf dem Bildschirm
                                ; sichtbar ist. Ohne Statuszeile ist er im BIOS-Arbeitsbereich.
                                ; (Bei Verlagerung an das Bildschirm-Puffer-Ende gibt es
                                ;  "Spratzer" auf Grund der Speicherorganisation der K7024-Karte)
                                
  0014                          kbdbl	equ	20; 47	;1..47, Zahl zu puffernder Zeichen
                                			;Weniger als 47 laesst auch bei Arbeit
                                			;mit Statuszeile am Speicherende Bytes
                                			;als BIOS-Patch-Bereich frei.
                                
                                ; Unabhaengig von der Tastaturerkennung wird die Arbeit mit
                                ; Tastaturstrings unterstuetzt. Es existiert sowohl eine Stan-
                                ; dardbelegung von Stringtasten als auch die Moeglichkeit der
                                ; nutzereignenen Definition bis auf Widerruf.
                                
                                 IF cpastz	;Puffer benoetigt keinen zusaetzlichen Platz
                                 ELSE
  2643                          biosln	aset	biosln+kbdbl
                                 ENDIF
                                
                                 IF1
                                 ENDIF
                                
  0000                          costu	equ	0; 20	;>=0
                                			;bei =0 werden Verw.routinen eingespart
                                			;bei >0 Mindestlnge fuer Nutzer-Strdef.
                                			;    Tab. liegt direkt vor Int.vektoren
                                			;    und ist evtl. groesser!
                                	IF	costu
                                	ENDIF
                                
                                ;	Vereinbarungen fuer Bildschirm
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  2E43                          biosln	aset	biosln+crtbfl
                                
                                ;Es wird sowohl ein grosser (24*80, BAB2) als auch ein kleiner
                                ;(16*64, BAB1) Bildschirm unterstuetzt. Die Treibermodifizierung
                                ;geschieht beim Kaltstart ohne notwendige Neuuebersetzung.
                                
                                ; vorgegebene Bildschirm-Werte:
                                
  F800                          bsanf2	equ	0f800h		;Anfang Bildschirmpuffer BAB2
  FC00                          bsanf1	equ	bsanf2+400h	;Anfang Bildschirmpuffer BAB1
  0018                          bszl2	equ	24		;Zeilenzahl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-10


  0010                          bszl1	equ	16		;dito BAB1
  0050                          bssp2	equ	80		;Spaltenzahl
  0040                          bssp1	equ	64		;dito BAB1
  FF7F                          bsend2	equ	bsanf2+bszl2*bssp2-1	;Pufferende
  FFFF                          bsend1	equ	bsanf1+bszl1*bssp1-1	;dito BAB1
                                 IF cpastz
                                 ENDIF
                                
                                ; Waehrend des Kaltstarts wird Port 0ah, Bit 6 getestet (Wickel-
                                ; bruecke auf ZE-Karte) und hierueber BAB1 und BAB2/3 unterschieden.
                                
  0084                          bsinic	equ	84h	;Steuerzeichen fuer Bildschirmzustand
                                ;			 nach dem Loeschen des Bildschirms
                                ;			 bei Kaltstart
                                ;			 z.B. auf 86h fuer andere Helligkeit
                                
                                ; Es existiert inzwischen ein Reihe von Software, die die SCP1715-Steuer-
                                ; zeichenfolgen 1b 5e xx (Feldattribut) und 1b 5f xx (Spezialzeichen) nutzen,
                                ; die vom SCP1526 (Buerocomputer) nicht unterstuetzt werden.
                                ; Diese Steuerzeichenfolgen koennen wahlweise unter CP/A unterstuetzt werden,
                                ; wobei fuer den Buerocomputer technisch bedingt nur die Feldattribut-
                                ; Funktionen invers und hell zugelassen sind (Reaktion wie Steuerzeichen
                                ; 84,85,86,87; alle anderen Funktionen fuehren zur Steuerzeichen-Fehlermeldung
                                ; durch Ausgabe von '^' auf dem Bildschirm an dieser Selle).
                                ; Wird im folgenden "escpc"=0 gesetzt, so werden obige Steuerzeichenfolgen
                                ; als Kursorpositionierfolgen behandelt und fuehren zu entsprechend sinnlosen
                                ; Effekten auf dem Bildschirm. Ausser aus Speicherplatzgruenden sollte daher
                                ; "escpc"=1 sein.
  0001                          escpc	equ	1	;=1 fuer Unterstuetzung 1b 5e xx und 1b 5f xx
                                			;=0 fuer fehlende Unterstuetzung
                                 IF escpc
  2E83                          biosln	aset	biosln+40h
                                 ENDIF
                                
                                ; Fuer eine effektivere Arbeit von TURBO-Pascal koennen wahlweise die
                                ; Nicht-SCP-Steuerzeichen 17h (Insert Line) und 19h (Delete Line)
                                ; vom Bildschirmtreiber unterstuetzt werden, wodurch der Bildschirm-
                                ; neuaufbau erheblich beschleunigt wird (keine Neuausgabe des gesamten
                                ; Bildschirmrestes). Hat nur Sinn, wenn TURBO-Pascal auch geaendert
                                ; wird, d.h. diese Steuerzeichen nutzt!
                                
  0001                          inslin	equ	1	;=1, wenn InsLine und DelLine zu unterstuetzen
                                			;=0 sonst
                                 IF inslin
  2EE3                          biosln	aset	biosln+60h
                                 ENDIF
                                
  0000                          adm3a	equ	0	;=1, wenn auch Unterst. einiger ADM3A-St.zeich.
                                ;			 =0, wenn nur SCP-Steuerz.
                                	IF	adm3a
                                	ENDIF
                                
                                
                                ; Umlautumcodierung (fuer deutschen Zeichensatz):
                                ; Bei BAB2 und BAB1 ist unter Verwendung eines speziellen
                                ; Zeichengenerators die Darstellung von Umlauten moeglich.
                                ; Dabei werden (nach Wunsch, umschaltbar mit CI/Stop U)
                                ; anstelle der ASCII-Zeichen spezielle Codierungen (10h..1fh)
                                ; auf den BS ausgegeben. Der Zeichensatz entspricht dem
                                ; Umfang des Typenrades des 1152 mit Umlauten.
                                ; Fuer BAB3 fuehrt die Umcodierung zur Interpretation als
                                ; Steuerzeichen normal/invers/intensiv ==> nicht benutzen!
  0001                          umlaut	equ	1; 0	;=1 mit Umcodierungsmoeglichkeit
                                			;=0 ohne	-"-
                                 IF umlaut
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-11


                                ; Bei umlaut<>0 muss genau eines der folgenden equ's =1 sein,
                                ; wodurch der Zeichengenratortyp bestimmt wird.
                                ; Die genaue Belegung ist im Text 'BIOxCRT.MAC' zu finden.
  0001                          zsuml	equ	1; 0	;Belegegung durch Koll. Geiler, IH Mittweida
  0000                          zsibm	equ	0; 1	;Belegung fuer ersatzweisen IBM-Zeichensatz
  2F43                          biosln	aset	biosln+60h
                                 ENDIF
                                
                                
                                ;	Interruptvektor
                                ;	===============
                                
  F700                          intvec	equ	0f700h	;Beginn des Interruptvektors (immer 100h-er Grenze)
                                
                                ; Vom BIOS benutzte Interruptworte:
  00E0                          intvsy	equ	0e0h		;immer benoetigt intvsy..intvsy+1fh
                                 IF iobuc1
  00D0                          intvuc	equ	intvsy-10h	;SIO-Bedienung fuer UC1:-Treiber
  00D0                          intvb	equ	intvuc		;kleinster benoetiger Platz durch BIOS
                                 ENDIF
                                
                                ; Belegung der Interruptsaeule durch das BIOS:
                                ;============================================
                                
                                ; Kassetten werden ausserhalb des BIOS bedient und benoetigen
                                ; Interruptsaeulenplatz von 0c0h..0cfh!!
                                
                                 if iobuc1
                                ;	SIO fuer UC1:-Treiber im Interrupt
                                ; Kanal B
  00D0                          ivsio0	equ	intvuc		;Sendepuffer leer
  00D2                          ivsio1	equ	ivsio0+2	;Statuswechsel
  00D4                          ivsio2	equ	ivsio1+2	;Empf-Zeichen da
  00D6                          ivsio3	equ	ivsio2+2	;Empf-Ueberlauf
                                ; Kanal A
  00D8                          ivsio4	equ	ivsio3+2	;Sendepuffer leer
  00DA                          ivsio5	equ	ivsio4+2	;Statuswechsel
  00DC                          ivsio6	equ	ivsio5+2	;Empf-Zeichen da
  00DE                          ivsio7	equ	ivsio6+2	;Empf-Ueberlauf
                                 endif
                                
  00E0                          ivpar	equ	intvsy+00h	;Paritaetsfehler EM256-RAM
  00E2                          ivpiod	equ	intvsy+02h	;Status-Interrupt PIO-Drucker
                                
                                ;*** intvsy+04h frei
                                
  00E6                          ivprot	equ	intvsy+06h	;Speicherschutz bei A5120/30
                                
                                ;*** die folgenden beiden Adressen werden vom FORMAT-Programm
                                ;*** vorausgesetzt, d.h. ihre Lage ist quasi fest !!
  00E8                          ivdsk1	equ	intvsy+08h	;Disk Index-Interrupt
  00EA                          ivdsk2	equ	intvsy+0ah	;Disk Marken-/Fault-Interrupt
                                
                                ;*** intvsy+0ch, +0eh frei
                                
                                ; LS-Leser und Stanzer bei A5120/30
                                ; *** Die folgenden Adressen werden von PTPUNCH/PTREAD
                                ; *** vorausgesetzt, d.h. ihre Lage ist quasi fest!!
                                ; *** bei nicht vorhandener Lochstreifenperipherie intvsy+10h..+16h frei
  00F0                          ivpun1	equ	intvsy+10h	;LS-Stanzer
  00F2                          ivrdr1	equ	intvsy+12h	;LS-Leser
  00F4                          ivrdr2	equ	intvsy+14h
  00F6                          ivpun2	equ	intvsy+16h	;LS-Stanzer
                                
  00F8                          ivctc0	equ	intvsy+18h	;CTC Kanal 0
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-12


  00FA                          ivctc1	equ	ivctc0+2
  00FC                          ivctc2	equ	ivctc1+2
  00FE                          ivctc3	equ	ivctc2+2
                                
                                
                                ;	Unterstuetzung weiterer Peripherie
                                ;	----------------------------------
                                
                                ; Es gibt in CP/A grundsaetzlich folgende Moeglichkeiten fuer die
                                ; Unterstuetzung einer SIO-Bedienung (i.a. fuer Kopplungen):
                                ; a) Unterstuetzung als UC1:-Geraet
                                ;   (siehe Vereinbarungen fuer serielle Geraete).
                                ;   In diesem Fall erfolgt die Bedienung voll ueber das BIOS
                                ;   (im Interruptbetrieb, mit speziellem Empf.puffer im BIOS)
                                ;   Fehler werden nur als BIOS-Fehler gemeldet, das Anwenderprogramm
                                ;   erfaehrt davon nichts ueber die BIOS-Schnittstelle.
                                ; b) im Anwenderprogramm, keine Unterstuetzung im BIOS.
                                ; Im Fall b) - oder wenn es sich um andersartige Peripherie handelt -
                                ; bietet CP/A durch Veraenderung von "intvl" zusaetzlichen Platz in
                                ; der Interruptvektor-Tabelle an, so dass eine Umspeicherung der
                                ; BIOS-Interruptvektoren vermieden werden kann.
                                
  00D0                          intvl	aset	intvb		;kleinster low-Interruptvektor
                                				;Kann 000h..0d0h sein
                                				;("intvb"..ff wird vom BIOS benoetigt)
  2F73                          biosln	aset	biosln+(100h-intvl)
                                
                                ;------------------------------------------------------
                                ;	absolute Hauptspeicherplaetze
                                ;------------------------------------------------------
                                ;		      Byteanzahl
  0000                          reboot	equ	0	;(3)	;Warmstart-Sprung
  0003                          iobyte	equ	3	;(1)	;I/O-Byte
  0004                          defaul	equ	4	;(1)	;DEFAULT-Disk
  0005                          bdosjp	equ	5	;(3)	;BDOS-Sprung
                                
                                 IF oss		;OSS-Hilfsadressen <4000h !
                                 ENDIF
                                
                                ; In CP/M zugelassener Scratch-Bereich fuer BIOS 40h..4fh
  0040                          lampbf	equ	40h	;(1)	;Puffer Tastaturlampen
                                				;Bedeutung (wenn Lampe vorhanden)
  0000                          lmpsl0	equ	0	;	Selektor 0
  0001                          lmpsl1	equ	1	;	Selektor 1
  0002                          lmpsl2	equ	2	;	Selektor 2
  0003                          lmpsl3	equ	3	;	Selektor 3
  0004                          lmpb2b	equ	4	;	2 Bahn Drucker beide Bahnen parallel
  0005                          lmpb2r	equ	5	;	2 Bahn Drucker rechte Bahn
  0006                          lmperr	equ	6	;	Fehler Lampe
  0007                          lmphcp	equ	7	;	Hardcopy (INSM) Lampe
  0041                          tim5cn	equ	41h	;(2)	;25-ms-Zaehler aufwaerts
  0043                          tim1cn	equ	43h	;(2)	;1-sec-Zaehler abwaerts
  0045                          tim1rt	equ	45h	;(2)	;Adr. der 1-sec Interr.routine
  004A                          kritbg	equ	4ah	;(2)	;Adr. der Nutzerroutine fuer Beginn zeit-
                                			;	;kritischer BIOS-Abschnitte (z.B. Floppy)
  004C                          kriten	equ	4ch	;(2)	;Adr. Enderoutine fuer kritbg
  004E                          cpmext	equ	4eh	;(2)	;Adr. Sprungvektor CP/M-Erw.
                                
                                 IF uhrvar
                                 ENDIF
                                
  0100                          tpa	equ	100h		;Programmladepunkt
                                
                                
                                ;************************Ende Varianten-Vereinbarungen*****************
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-13


                                
                                 IF1
                                 ENDIF
                                	page	66
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-14


                                
                                
                                ; Die folgenden EQU's dienen dazu, um bereits zum Zeitpunkt der
                                ; Uebersetzung eine Verschiebung des Ladepunktes durch ein zu
                                ; lang gewordenes BIOS zu erkennen.
                                
  3000                          biosl0	aset	(biosln+0ffh) and 0ff00h;auf 256-Grenze runden
  D000                          biosad	aset	rambyt-biosl0	;BIOS-Ladeadresse
  C205                          tpaend	equ	biosad-bdosln+5 ;Laenge BDOS abziehen
                                
  F700                          intvec	equ	rambyt-crtbfl-100h	;Interruptvektoradr.
                                ;				 liegt immer 100h vor BS-Puffer
                                ;				 bei 64k RAM auf F700H
  F7D0                          intvr	aset	intvec+intvl	;nur hinterer teil genutzt
                                
  C200                          BDOS	equ	biosad-bdosln	;vermeiden Externals, da linkmt
  BA00                          CCP	equ	BDOS-ccpln	;nicht ganz sauber ist
                                
                                
                                ;------------------------------------------------------------
                                ;	BEGINN BIOS-CODE
                                ;------------------------------------------------------------
                                
                                	.PHASE	biosad
                                 IF1
                                 ENDIF
                                
  D000    C3 E8A2               BIOS00: JP	kaltst
  D003    C3 E7E1               BIOS03: JP	warmst
  D006    C3 E663               BIOS06: JP	const	;CON:	Status; oA =FF bereit, =00 sonst
  D009    C3 E66F               BIOS09: JP	conin	;CON:	Zeichen oA (solange Warten)
  D00C                          conol:	;conout mit evtl. hardcopy
  D00C    C3 E67B               BIOS0C: JP	conout	;CON:	Zeichen iC
  D00F    C3 E6B7               BIOS0F: jp	list	;LST:	Zeichen iC
  D012    C3 E69F               BIOS12: jp	punch	;PUN:	Zeichen iC
  D015    C3 E693               BIOS15: jp	reader	;RDR:	Zeichen oA (solange Warten)
  D018    C3 DBC7               BIOS18: JP	home		;./. (trk:=0)
  D01B    C3 D992               BIOS1B: JP	seldsk		;iC (0=A,1=B,..); oHL ^DPH
  D01E    C3 DBD6               BIOS1E: JP	settrk		;iBC
  D021    C3 DBDB               BIOS21: JP	setsec		;iBC
  D024    C3 DBE0               BIOS24: JP	setdma		;iBC
  D027    C3 DC61               BIOS27: JP	read		;oA Resultat; A=0 ok, A=1 sonst
  D02A    C3 DBE9               BIOS2A: JP	write		;oA Resultat; A=0 ok, A=1 sonst
  D02D    C3 E6AB               BIOS2D: jp	listst	;LST:	Status; oA =FF bereit, =00 sonst
  D030    C3 DBE5               BIOS30: JP	sectran		;iBC log. Sektnr (ab 0!!),
                                				;iDE ^Sektor-Translate-Tabelle
                                				;oHL Sektornr. fuer setsec
                                
                                ; Die folgenden Bytes liegen an der gleichen Stelle im BIOS
                                ; wie bei SCP fuer Buerocomputer und dienen zur sicheren Er-
                                ; kennung von SCP-spezifischen Programmen, da diese an dieser
                                ; Stelle testen.
                                
  D033    43 50                 BIOS33: db	'CP'		;SCP-Kennzeichen ist 'BW '
  D035    41                    	db	'A'		;'CPA'
  D036                          BIOS36:
  D036    42                    	db	'B'		;Hardware Buerocomputer
  D037    36                    	db	'6'		;Schnittstellen-Version
                                
                                ; Die folgenden Bytes dienen der direkten Bildschirmbedienung ohne
                                ; BIOS-Benutzung fuer extreme Zeitanforderungen
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-15


  D038                          BIOS38:
  D038    FC00                  crtcps: dw	bsanf1		;Kursorposition im Bildschirmpuffer
  D03A    FF                    crtccn: db	0ffh		;Zeittaktzaehler fuer Kursorpflege
                                ; Die folgenden Bytes dienen der Tastenumdefinition von aussen
  D03B                          BIOS3B:
  D03B    D39B                  kbdsst: dw	kbdsts		;Standard-Stringtabelle (bei jedem Warmstart)
                                			;Aufbau: virt. Tastencode,Laenge,String,...,0ffh
  D03D                          BIOS3D:
                                ; Die folgenden beiden Bytes dienen der Einstellung spezieller Zust. von aussen
                                ;*************************************************************
                                ;	Synchronisierungsflags
                                ;*************************************************************
                                
  D03D    00                    synflg: db	0		;Synchr.-Flags
  0000                          ctrlst	equ	0		;CTRL-Status-Bit (=0 fest!)
                                 IF monitor
                                 ENDIF
                                 IF umlaut
  0002                          umlflg	equ	2		;Umlaute umkodieren
                                 ENDIF
                                 IF stpvar
                                  IF chdvar
  0003                          synlrq	equ	3		;Anforderung LST:-Kanal zu synchron.
                                  ENDIF
                                 ENDIF
  0004                          stoprq	equ	4		;Stop-Anforderung
                                 IF monitor
                                 ENDIF
  0006                          stzaus	equ	6		;keine Pflege der Statuszeile
                                 IF stpvar
  0007                          phyact	equ	7		;Tasten physisch in Puffer
                                 ENDIF
                                
                                ;!!synsem muss direkt nach synflg liegen!!
  D03E    01                    synsem: db	1		;bei >0 keine asynchr. Arbeit
                                
  D03F                          BIOS3F:
                                ;=====================Ende des festen BIOS-Vektors=========================
                                
                                 IF1 ;dphaX wird spaeter bei existierendem Geraet X <>0 gesetzt
                                 ENDIF
                                
                                ; Parameterheader fuer Disketten
                                ;-------------------------------
                                
                                	IRP	di,<A,B,C,D>
                                 IF disk&di
                                dph&di: DW	0,0,0,0,dirbuf
                                	DW	dpb&di,csv&di,alv&di
                                dpha&di aset	dph&di
                                 ENDIF
                                	ENDM
  D03F    0000 0000       +     dph&A: DW	0,0,0,0,dirbuf
  D043    0000 0000       +     
  D047    F0F7            +     
  D049    D06F F1A3       +     	DW	dpb&A,csv&A,alv&A
  D04D    F177            +     
  D04F    0000 0000       +     dph&B: DW	0,0,0,0,dirbuf
  D053    0000 0000       +     
  D057    F0F7            +     
  D059    D0BC F1F5       +     	DW	dpb&B,csv&B,alv&B
  D05D    F1C3            +     
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-16


  D05F    0000 0000       +     dph&C: DW	0,0,0,0,dirbuf
  D063    0000 0000       +     
  D067    F0F7            +     
  D069    D0EF F267       +     	DW	dpb&C,csv&C,alv&C
  D06D    F235            +     
                                
                                ; Bemerkungen zur Arbeit ohne automatische Formaterkennung:
                                ;---------------------------------------------------------
                                ; Die folgende DPB-Generierung erzeugt entspr. 'dbufsz' das
                                ; jeweilige Standardformat von CP/A, so dass dieses bei Arbeit
                                ; ohne automatische Formaterkennung eingestellt ist.
                                ; Nutzerspezifische Modifizierungen koennen in den Standard-DPB's
                                ; vorgenommen werden. Kommt dabei das Format der Kaltstart-
                                ; Diskette nicht mehr vor, so muss diese nach dem Kaltstart
                                ; gegen die Nutzerdiskette gewechselt werden. Dadurch ist z.B.
                                ; fuer extreme TPA-Anforderungen nur 128er Diskettenformat
                                ; moeglich (kein 1K Diskettenpuffer!), obwohl der Kaltstart von
                                ; einer Diskette mit 1K Sektoren erfolgte.
                                
                         C      	include BIOSDPBM
                         C      ; Struktur DPB (einschl. Erweiterung gegenueber Standard-DPB)
                         C      ; Standard-Teil:
  0000                   C      dpbspt	equ	0	;(dw)	128-Sektoren pro Spur
  0002                   C      dpbbls	equ	2	;(db)	blockshift (3=1K, 4=2K)
  0003                   C      dpbblm	equ	3	;(db)	blockmask
  0004                   C      dpbexm	equ	4	;(db)	extentmask
  0005                   C      dpbsiz	equ	5	;(dw)	Kapazitaet -1 in Bloecken
  0007                   C      dpbdir	equ	7	;(dw)	Anzahl -1 DIR-Eintraege
  0009                   C      dpbalc	equ	9	;(dw)	Allocation-Bits fuer DIR
  000B                   C      dpbchk	equ	11	;(dw)	Check-Size fuer 'R/O'-Test
  000D                   C      dpbofs	equ	13	;(dw)	Zahl der Systemspuren
                         C      ; Ab Byte 15 folgt Nicht-Standard fuer DPB
                         C      
                         C      ; DPB-Steuerinformationen
  000F                   C      dpbflg	equ	15	;(db)	Flags, i.a. alle =0
  0003                   C      dpbfsm	equ	3	;	0..3 Zahl der abweichend vom
                         C      			;	restlichen Spurformat mit 
                         C      			;	26*128 formatierten Spuren
  0002                   C      dpbffm	equ	2	;	=1, wenn FM-Aufzeichung zu erzwingen
                         C      			;	    (d.h. FM-Disk in MFM-Laufwerk)
  0003                   C      dpbfsv	equ	3	;	=1, wenn Double sided zu betreiben,
                         C      			;	    indem von aussen nach innen
                         C      			;	    und auch Rueckseite von aussen
                         C      			;	    nach innen
                         C      			;	=0, wenn Double sided zu betreiben,
                         C      			;	    indem zunaechst von aussen nach
                         C      			;	    innen und Rueckseite von innen
                         C      			;	    nach aussen
                         C      			;	immer mit dpbf86+dpbfds zusammen setzen!
  0004                   C      dpbf86	equ	4	;	=1, dpbfsv benutzen
                         C      			;	=0, wenn Double sided zu betreiben,
                         C      			;	    indem ungerade logische Spuren
                         C      			;	    auf der Rueckseite liegen
                         C      			;	immer mit dpbfds zusammen setzen!
  0005                   C      dpbfds	equ	5	;	=1, wenn Double sided zu betreiben
  0006                   C      dpbfrm	equ	6	;	=1, wenn keine autom. Format-
                         C      			;	    erkennung in Seldsk
  0007                   C      dpbfnd	equ	7	;	=1, wenn abweichende DPB-Struktur
                         C      			;	    (keine Disketten)
                         C      
  0010                   C      dpbslc	equ	16	;(db)	Sektorlaengencode
  0011                   C      dpbbfm	equ	17	;(db)	Puffermaske, d.h. Anzahl der 128er
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-17


                         C      			;	Sektoren im Puffer -1
                         C      			;	muss < 2**(dbufsz-7) sein,
                         C      			;	muss < 2**dpbslc sein, wenn phys.
                         C      			;	Sektornummern in dpbstr nicht monoton
  0012                   C      dpbstp	equ	18	;(db)	Stepimpulse pro Spurpositionierung
                         C      			;	1 oder 2
  0013                   C      dpbsn0	equ	19	;(db)	Verschiebung der Sektor-Numm. auf Rueckseite
  0014                   C      dpbtrk	equ	20	;(db)	log. Anzahl Spuren
                         C      ; geraeteabh.Parameter:
  0015                   C      dpbdnr	equ	21	;(db)	physische Laufwerksnummer
  0016                   C      dpbptr	equ	22	;(db)	Gesamtzahl physische Spuren (40/77/80)
  0017                   C      dpbsti	equ	23	;(db)	Schrittzeit in 0.1 ms
  0018                   C      dpbtyp	equ	24	;(db)	Laufwerkstyp:
  0000                   C      dpbtds	equ	0	; =0 bei SS, =1 bei DS
  0003                   C      dpbtdd	equ	3	; =0 bei SD (FM), =1 bei DD (MFM)
  0004                   C      dpbt5z	equ	4	; =0 bei 8", =1 bei 5"
  0005                   C      dpbt80	equ	5	; =0 bei nicht 80-Spur, =1 bei 80-Spur
  0006                   C      dpbtwv	equ	6	; =0 ohne, =1 mit Verify nach Schreiben
  0007                   C      dpbt52	equ	7	; =0 bei max 26 ,=1 bei max 52 Sekt./Spur (8" MFM)
                         C      ; physische Sektortranslate-Tabelle (sollte am Ende liegen,
                         C      ; um bei festem Format mit weniger als 26 phys. Sektoren den
                         C      ; DPB entspr. verkuerzen zu koennen)
  0019                   C      dpbstr	equ	25	;(ds26)	entspr. phys. Sektoren pro Seite
                         C      
  0033                   C      dpblng	equ	dpbstr+26	;(max.) Laenge eines DPB
                         C      		;***bei 8" MFM:  52 Sektoren, d.h. dpblng um 26 groesser***
                                
                                ; Im folgenden kein IRP im Assembler moeglich, da INCLUDE
                                
                                 IF diska ne 0
  2A7D                          diskdi	aset	diska
  0000                          @din	aset	0
  D06F                   C      DPBA:	include BIOSDPB
                         C      ;;BIOSDPB, Version 18.05.89
                         C       if dbufsz le 7
                         C       else
                         C       if dbufsz lt 10
                         C       else ;;dbufsz ge 10
                         C        if	((diskdi mod 10000)/1000) and 00000001b		;;DS
                         C        else							;;SS
                         C         if	(diskdi mod 100) eq 40				;;40 Tr.
                         C         endif
                         C         if	(diskdi mod 100) eq 77				;;77 Tr.
  D06F    0020           C      	DW	32	;;(0)	;SECTORS/TRACK	(LOGIN)
  D071    04             C      	DB	4	;;(2)	;BLOCK SHIFT	(LOGIN)
  D072    0F             C      	db	0fh	;;(3)	;BLOCK MASK	(LOGIN)
  D073    01             C      	DB	1	;;(4)	;EXTENT MASK	(LOGIN)
                         C       if @fsys
                         C       else
  D074    0093           C      	DW	296/2-1 ;;(5)	;Blockanzahl- 1 (LOGIN)
                         C       endif
  D076    003F           C      	DW	64-1	;;(7)	;DIR MAX	(LOGIN)
  D078    80 00          C      	DB	080H,0	;;(9)	;ALLOC fuer dir.(LOGIN)
  D07A    0010           C      	DW	16	;;(11)	;CHECK SIZE	(LOGIN)
                         C       if @fsys
                         C       else
  D07C    0003           C      	DW	3	;;(13)	;OFFSET		(LOGIN)
                         C       endif
                         C         endif
                         C         if	(diskdi mod 100) eq 80				;;80 Tr.
                         C         endif
                         C        endif
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-18


                         C       endif
                         C       endif
                         C      
                         C      ;; Nicht-Standard-DPB-Teil
  0000                   C      @dpbhl	aset	0
                         C       if	((diskdi mod 10000)/1000) and 00000001b
                         C       endif
                         C       if @fact eq 0 ;;keine autom. Formaterkennung scharf, Format annageln
                         C       endif
  D07E    00             C      	db	@dpbhl
                         C       if dbufsz le 7
                         C       endif
                         C       if (dbufsz lt 10) and (dbufsz gt 7)
                         C       endif
                         C       if dbufsz ge 10
  D07F    03             C      	db	3		;;Sektorlaengencode
  D080    07             C      	db	7		;;Puffermaske 8*128
                         C       endif
  D081    01             C      	db	1		;;Zahl der Stepimpulse
  D082    00             C      	db	0		;;keine Weiter-Numm. auf Rueckseite
  D083    4D             C      	db	diskdi mod 100	;;benutztye Zahl phys. Spuren
  D084    00             C      	db	@din		;;phys. LW-Nr.
  D085    4D             C      	db	diskdi mod 100	;;maximale Zahl phys. Spuren
                         C       if	(diskdi mod 1000)/100 eq 5	;;5" 
                         C       else	;;8" 
  D086    6E             C      	db	11*10		;;Schrittzeit fuer 8" LW
                         C       endif
                         C      
  0000                   C      @dpbhl	aset	0		;;vorbereiten Laufwerkstyp-Flags
                         C      
                         C       if	(diskdi ge 10000)
  0008                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtdd)	;;double density
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 5
                         C       endif
                         C       if (diskdi mod 100) eq 80
                         C       endif
                         C       if	((diskdi mod 10000)/1000) and 00000001b
                         C       endif
                         C       if ((diskdi mod 10000)/1000) and 00000010b
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C         if	(diskdi ge 10000) ;;8" MFM
  0088                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt52) ;;vermerken max. 52 Sektoren/Spur
                         C         endif
                         C       endif
  D087    88             C      	db	@dpbhl	;;vom Laufwerkstyp abhaengige Flags
                         C      
                         C       if	(diskdi mod 1000)/100 eq 5 ;;5" 
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C        if	(diskdi ge 10000) ;;8" MFM
                         C       ;; log. Sektortranslate-Tabelle
  D088    01 02 03 04    C      	db	1,2,3,4,5,6,7,8,9,10,11,12,13,14
  D08C    05 06 07 08    C      
  D090    09 0A 0B 0C    C      
  D094    0D 0E          C      
  D096    0F 10 11 12    C      	db	15,16,17,18,19,20,21,22,23,24,25,26
  D09A    13 14 15 16    C      
  D09E    17 18 19 1A    C      
  D0A2    1B 1C 1D 1E    C      	db	27,28,29,30,31,32,33,34,35,36,37,38,39
  D0A6    1F 20 21 22    C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-19


  D0AA    23 24 25 26    C      
  D0AE    27             C      
  D0AF    28 29 2A 2B    C      	db	40,41,42,43,44,45,46,47,48,49,50,51,52
  D0B3    2C 2D 2E 2F    C      
  D0B7    30 31 32 33    C      
  D0BB    34             C      
                         C        endif
                         C       endif	;;8" 
                                 ENDIF
                                 IF diskb ne 0
  2D3C                          diskdi	aset	diskb
  0001                          @din	aset	1
  D0BC                   C      DPBB:	include BIOSDPB
                         C      ;;BIOSDPB, Version 18.05.89
                         C       if dbufsz le 7
                         C       else
                         C       if dbufsz lt 10
                         C       else ;;dbufsz ge 10
                         C        if	((diskdi mod 10000)/1000) and 00000001b		;;DS
                         C         if	(diskdi mod 100) eq 40				;;40 Tr.
                         C         endif
                         C         if	(diskdi mod 100) eq 80				;;80 Tr.
  D0BC    0028           C      	DW	40	;;(0)	;SECTORS/TRACK	(LOGIN)
  D0BE    04             C      	DB	4	;;(2)	;BLOCK SHIFT	(LOGIN)
  D0BF    0F             C      	db	0fh	;;(3)	;BLOCK MASK	(LOGIN)
  D0C0    00             C      	DB	0	;;(4)	;EXTENT MASK	(LOGIN)
                         C       if @fsys
                         C       else
  D0C1    018F           C      	DW	800/2-1 ;;(5)	;Blockanzahl- 1 (LOGIN)
  D0C3    00BF           C      	DW	192-1	;;(7)	;DIR MAX	(LOGIN)
  D0C5    E0 00          C      	DB	0e0H,0	;;(9)	;ALLOC fuer dir.(LOGIN)
  D0C7    0030           C      	DW	48	;;(11)	;CHECK SIZE	(LOGIN)
  D0C9    0000           C      	DW	0	;;(13)	;OFFSET		(LOGIN)
                         C       endif
                         C         endif
                         C        endif
                         C       endif
                         C       endif
                         C      
                         C      ;; Nicht-Standard-DPB-Teil
  0000                   C      @dpbhl	aset	0
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0020                   C      @dpbhl	aset	@dpbhl+(1 shl dpbfds)		;;DS betreiben
                         C       endif
                         C       if @fact eq 0 ;;keine autom. Formaterkennung scharf, Format annageln
                         C       endif
  D0CB    20             C      	db	@dpbhl
                         C       if dbufsz le 7
                         C       endif
                         C       if (dbufsz lt 10) and (dbufsz gt 7)
                         C       endif
                         C       if dbufsz ge 10
  D0CC    03             C      	db	3		;;Sektorlaengencode
  D0CD    07             C      	db	7		;;Puffermaske 8*128
                         C       endif
  D0CE    01             C      	db	1		;;Zahl der Stepimpulse
  D0CF    00             C      	db	0		;;keine Weiter-Numm. auf Rueckseite
  D0D0    50             C      	db	diskdi mod 100	;;benutztye Zahl phys. Spuren
  D0D1    01             C      	db	@din		;;phys. LW-Nr.
  D0D2    50             C      	db	diskdi mod 100	;;maximale Zahl phys. Spuren
                         C       if	(diskdi mod 1000)/100 eq 5	;;5" 
                         C        if	(diskdi mod 100) gt 40
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-20


                         C         if ((diskdi mod 10000)/1000) and 00000001b
  D0D3    28             C      	db	4*10		;;Schrittzeit fuer 80 Tr. DS LW
                         C         endif
                         C        endif
                         C       endif
                         C      
  0000                   C      @dpbhl	aset	0		;;vorbereiten Laufwerkstyp-Flags
                         C      
                         C       if	(diskdi ge 10000)
  0008                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtdd)	;;double density
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 5
  0018                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt5z)	;;5" 
                         C       endif
                         C       if (diskdi mod 100) eq 80
  0038                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt80)	;;80-Spur-Laufwerk
                         C       endif
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0039                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtds)	;;double sided
                         C       endif
                         C       if ((diskdi mod 10000)/1000) and 00000010b
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C       endif
  D0D4    39             C      	db	@dpbhl	;;vom Laufwerkstyp abhaengige Flags
                         C      
                         C       if	(diskdi mod 1000)/100 eq 5 ;;5" 
                         C        if dbufsz le 7
                         C        else
                         C      ;; log. Sektortranslate-Tabelle fuer andere Formate
  D0D5    01 02 03 04    C      	db	1,2,3,4,5,6,7,8,9,10,11,12,13,14
  D0D9    05 06 07 08    C      
  D0DD    09 0A 0B 0C    C      
  D0E1    0D 0E          C      
  D0E3    0F 10 11 12    C      	db	15,16,17,18,19,20,21,22,23,24,25,26
  D0E7    13 14 15 16    C      
  D0EB    17 18 19 1A    C      
                         C        endif
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C       endif	;;8" 
                                 ENDIF
                                 IF diskc ne 0
  2D3C                          diskdi	aset	diskc
  0002                          @din	aset	2
  D0EF                   C      DPBC:	include BIOSDPB
                         C      ;;BIOSDPB, Version 18.05.89
                         C       if dbufsz le 7
                         C       else
                         C       if dbufsz lt 10
                         C       else ;;dbufsz ge 10
                         C        if	((diskdi mod 10000)/1000) and 00000001b		;;DS
                         C         if	(diskdi mod 100) eq 40				;;40 Tr.
                         C         endif
                         C         if	(diskdi mod 100) eq 80				;;80 Tr.
  D0EF    0028           C      	DW	40	;;(0)	;SECTORS/TRACK	(LOGIN)
  D0F1    04             C      	DB	4	;;(2)	;BLOCK SHIFT	(LOGIN)
  D0F2    0F             C      	db	0fh	;;(3)	;BLOCK MASK	(LOGIN)
  D0F3    00             C      	DB	0	;;(4)	;EXTENT MASK	(LOGIN)
                         C       if @fsys
                         C       else
  D0F4    018F           C      	DW	800/2-1 ;;(5)	;Blockanzahl- 1 (LOGIN)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-21


  D0F6    00BF           C      	DW	192-1	;;(7)	;DIR MAX	(LOGIN)
  D0F8    E0 00          C      	DB	0e0H,0	;;(9)	;ALLOC fuer dir.(LOGIN)
  D0FA    0030           C      	DW	48	;;(11)	;CHECK SIZE	(LOGIN)
  D0FC    0000           C      	DW	0	;;(13)	;OFFSET		(LOGIN)
                         C       endif
                         C         endif
                         C        endif
                         C       endif
                         C       endif
                         C      
                         C      ;; Nicht-Standard-DPB-Teil
  0000                   C      @dpbhl	aset	0
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0020                   C      @dpbhl	aset	@dpbhl+(1 shl dpbfds)		;;DS betreiben
                         C       endif
                         C       if @fact eq 0 ;;keine autom. Formaterkennung scharf, Format annageln
                         C       endif
  D0FE    20             C      	db	@dpbhl
                         C       if dbufsz le 7
                         C       endif
                         C       if (dbufsz lt 10) and (dbufsz gt 7)
                         C       endif
                         C       if dbufsz ge 10
  D0FF    03             C      	db	3		;;Sektorlaengencode
  D100    07             C      	db	7		;;Puffermaske 8*128
                         C       endif
  D101    01             C      	db	1		;;Zahl der Stepimpulse
  D102    00             C      	db	0		;;keine Weiter-Numm. auf Rueckseite
  D103    50             C      	db	diskdi mod 100	;;benutztye Zahl phys. Spuren
  D104    02             C      	db	@din		;;phys. LW-Nr.
  D105    50             C      	db	diskdi mod 100	;;maximale Zahl phys. Spuren
                         C       if	(diskdi mod 1000)/100 eq 5	;;5" 
                         C        if	(diskdi mod 100) gt 40
                         C         if ((diskdi mod 10000)/1000) and 00000001b
  D106    28             C      	db	4*10		;;Schrittzeit fuer 80 Tr. DS LW
                         C         endif
                         C        endif
                         C       endif
                         C      
  0000                   C      @dpbhl	aset	0		;;vorbereiten Laufwerkstyp-Flags
                         C      
                         C       if	(diskdi ge 10000)
  0008                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtdd)	;;double density
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 5
  0018                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt5z)	;;5" 
                         C       endif
                         C       if (diskdi mod 100) eq 80
  0038                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt80)	;;80-Spur-Laufwerk
                         C       endif
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0039                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtds)	;;double sided
                         C       endif
                         C       if ((diskdi mod 10000)/1000) and 00000010b
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C       endif
  D107    39             C      	db	@dpbhl	;;vom Laufwerkstyp abhaengige Flags
                         C      
                         C       if	(diskdi mod 1000)/100 eq 5 ;;5" 
                         C        if dbufsz le 7
                         C        else
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-22


                         C      ;; log. Sektortranslate-Tabelle fuer andere Formate
  D108    01 02 03 04    C      	db	1,2,3,4,5,6,7,8,9,10,11,12,13,14
  D10C    05 06 07 08    C      
  D110    09 0A 0B 0C    C      
  D114    0D 0E          C      
  D116    0F 10 11 12    C      	db	15,16,17,18,19,20,21,22,23,24,25,26
  D11A    13 14 15 16    C      
  D11E    17 18 19 1A    C      
                         C        endif
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8" 
                         C       endif	;;8" 
                                 ENDIF
                                 IF diskd ne 0
                                 ENDIF
                                
                                
                                ;=======================
                                ; CP/M-Erweiterungen
                                ;=======================
  D122                          cpmx00: IF	monitor
                                	ELSE
  D122    C9                    	ret
  D123    00                    	nop
  D124    00                    	nop
                                	ENDIF
  D125    C3 E5E5               cpmx03: jp	tim5on		;5ms Takt an
  D128    C3 E5EC               cpmx06: jp	tim5of		;5ms Takt aus
  D12B    C3 E5F0               cpmx09: jp	tim1on		;1s Takt an
  D12E    C3 E5F7               cpmx0c: jp	tim1of		;1s Takt aus
                                	IF	mprot
                                	ELSE
  D131    C9                    	ret
  D132    00                    	nop
  D133    00                    	nop
  D134    C9                    	ret
  D135    00                    	nop
  D136    00                    	nop
  D137    C9                    	ret
  D138    00                    	nop
  D139    00                    	nop
                                	ENDIF
                                 IF stpvar or monitor
  D13A    C3 E6DE               cpmx18: jp	delsps		;verzoegern Sondertasten
  D13D    C3 E6EB               cpmx1b: jp	delspr		;erlauben Sondertasten
                                 ENDIF
                                 IF umlaut
  D140    C3 D67F               cpmx1e: jp	crtuml
                                 ENDIF
  D143    C3 DDA6               cpmx21: jp	diskio		;phys. Disktransfer
                                				;Schnittstelle siehe BIOxDSKT.MAC
                                
                                	page	66
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-23


                                
                                ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                                ;	Beginn BIOS-Treiber
                                ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                                
                                ; Dummy-Treiber
  D146                          dumst:
  D146    AF                    	xor	a
  D147    3D                    	dec	a		;Status immer FF (bereit)
                                 IF iobvar
                                 ENDIF
  D148    C9                    	ret			;Status immer FF (bereit)
                                
                                 IF iobvar
  D149    3E 1A                 dumi:	ld	a,1ah		;Eingabe-Zeichen immer EOF
  D14B    C9                    	ret
  D14C    79                    dumo:	ld	a,c
  D14D    11 D159               	ld	de,dumoh
  D150    CD E7BF               	call	mrecoa		;Zeichen hex aufbereiten
  D153    0E 28                 	ld	c,'('
  D155    CD D46E               	call	crto
  D158    01 0000               	ld	bc,0
  D159                          dumoh	equ	$-2
  D15B    C5                    	push	bc
  D15C    CD D46E               	call	crto
  D15F    C1                    	pop	bc
  D160    48                    	ld	c,b
  D161    CD D46E               	call	crto
  D164    0E 29                 	ld	c,')'
  D166    C3 D46E               	jp	crto
                                 ENDIF
                                
                         C      	include BIOSKBD
                         C      ;****************************************************
                         C      ;	Tastatur-Eingabe
                         C      ; - Unterstuetzung weiterer Steckplaetze fuer IFSS-Tastatur
                         C      ;   (z.B. Digitalisier-AP)
                         C      ; - freie Belegbarkeit Kursor- und rechter Ziffernblock
                         C      ; 17.07.88
                         C      ; - uebersichtlichere Darstellung phys. -> virtueller Tastencode
                         C      ; 24.09.88
                         C      ; - Anpassung Tastaturpuffer in Statuszeile an umschaltbaren Bildschirmpuffer
                         C      ; 25.09.88
                         C      ; - Fehler in Stop-Tasten-Behandlung korrigiert
                         C      ; 07.11.88
                         C      ; - Erweiterung des virtuellen Tastaturcodes um K7634-spezifische Tasten
                         C      ; 23.12.88
                         C      ; - saemtliche Sondertasten c0..ff liefern mit Control oder Shift einen
                         C      ;   virtuellen Zwischencode 80..bf
                         C      ; 14.01.89
                         C      ; - Variante K7633 (kbdotp eq 3) eingefuehrt
                         C      ; - wenn Tastatur nach RESET gross schreibt, so caps-lock-Test invertiert
                         C      ; 20.01.89
                         C      ; - Abtesten auf ^Q-Prefix ueber virtuellen Tastencode
                         C      ; 22.03.89
                         C      ; - Control-Flag gilt genau fuer das naechste Zeichen
                         C      ; 31.03.89
                         C      ; - Sondertasten >=80h ignoriert, wenn nicht in Tastatur-Tabelle
                         C      ; 25.09.89
                         C      ; - Fehlerkorrektur K7637: CTRL-Ersatztaste brachte kein ^Q-Prefix
                         C      ;****************************************************
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-24


                         C      
                         C       if1
                         C       endif	;if1
                         C      
                         C      ; Tastatur-Status
                         C      ;================
  D169                   C      kbdst:
                         C      ; vor Pufferabfrage anstehende Zeichen lesen (falls 5ms Takt aus)
  D169    F3             C      	di			;parallele Abfrage ueber 5ms verhindern
                         C       IF cpastz
                         C       ENDIF
  D16A    CD D171        C      	call	kbdsti		;interner Aufruf
  D16D    FB             C      	ei
                         C       IF stpvar or monitor
  D16E    C3 E6F7        C      	jp	chksp		;Test auf Spezialfunktionen
                         C       ENDIF
                         C      
  D171                   C      kbdsti:				;kbdst-Aufruf intern
  D171    CD D24D        C      kbdstz:	call	kbdst1		;Taste neu gedrueckt ?
  D174    28 05          C      	jr	z,kbdsnt	;nein
  D176    CD D182        C      	call	kbdrdt		;Taste in Puffer ablegen
                         C       IF stpvar
                         C       ENDIF
  D179    18 F6          C      	jr	kbdstz		;auf neuen Tastendruck testen
                         C      
  D17B    3E 00          C      kbdsnt:	ld	a,0		;erstes Pufferzeichen
  D17C                   C      kbdbfe	equ	$-1
  D17D    B7             C      	or	a		;Puffer leer?
  D17E    C8             C      	ret	z		;ja
  D17F    3E FF          C      	ld	a,0ffh
  D181    C9             C      	ret
                         C      
                         C      ;------------------------------------------------------------
                         C      
                         C      
                         C      ; Taste umkodieren und im Puffer ablegen
                         C      ;=======================================
                         C      ; Achtung!! Dieses UP wird aus Interruptroutine aufgmrufen
  D182    CD D26D        C      kbdrdt:	call	kbdrch		;Zeichen evtl. umkodieren
  D185    21 D03D        C      	ld	hl,synflg
                         C      
  D188    FE DF          C      	cp	ctlc		;Ersatz-Control-Taste ?
  D18A    20 05          C      	jr	nz,kbdnct	;nein
  D18C    7E             C      	ld	a,(hl)
  D18D    EE 01          C      	xor	1 shl ctrlst	;CTRL-Status umkehren
  D18F    77             C      	ld	(hl),a
  D190    C9             C      	ret			;und Zeichen ignorieren
  D191                   C      kbdnct:
                         C      
                         C       IF stpvar
  D191    CB 7E          C      	bit	phyact,(hl)	;Taste physisch in Puffer?
  D193    C2 D1DC        C      	jp	nz,kbdput	;ja, direkt ablegen
                         C       ENDIF
                         C       IF costu
                         C       ENDIF
  D196    2A D03B        C      	ld	hl,(kbdsst)	;Adresse der Standardstringtabelle
  D199    CD D2B3        C      	call	costr		;Standardstring?
  D19C    28 07          C      	jr	z,kbdnco	;nein
  D19E    1D             C      kbdco:	dec	e		;String der Laenge 0?
  D19F    C8             C      	ret	z		;ja, zu ignorierende Taste
  D1A0    1D             C      	dec	e		;String exakt ein Zeichen lang?
  D1A1    C2 D1F3        C      	jp	nz,kbdco1	;nein, kann keine Sondertaste sein
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-25


  D1A4    7E             C      	ld	a,(hl)		;holen erstes Stringzeichen
  D1A5    21 D03D        C      kbdnco:	ld	hl,synflg
                         C      
                         C      ; Auswertung Sondertasten, die nicht im Puffer abgelegt werden
                         C      ;-------------------------------------------------------------
                         C      
  D1A8    FE DE          C      	cp	stpc		;STOP ?
  D1AA    20 0A          C      	jr	nz,kbdnst
  D1AC    CB E6          C      	set	stoprq,(hl)	;Stop-Request vermerken
                         C      
                         C      ; Rest des Konsolpuffers streichen
                         C      ;---------------------------------
  D1AE    AF             C      kbdbcl:	xor	a
                         C       IF cpastz
                         C       ENDIF
  D1AF    32 FFFF        C      	ld	(0ffffh),a
  D1B0                   C      crtm36	equ	$-2
                         C       IF cpastz
                         C       ENDIF
  D1B2    32 D17C        C      	ld	(kbdbfe),a
  D1B5    C9             C      	ret
                         C      
  D1B6                   C      kbdnst:
                         C       IF stpvar
                         C       IF chdvar
  D1B6    FE D9          C      	cp	SyLc		;Drucker Synchronisieren?
  D1B8    20 03          C      	jr	nz,kbdnsy	;nein
  D1BA    CB DE          C      	set	synlrq,(hl)	;sonst vermerken
  D1BC    C9             C      	ret
  D1BD                   C      kbdnsy:
  D1BD    FE DA          C      	cp	HrLc		;Hardcopy ein/aus ?
  D1BF    20 0C          C      	jr	nz,kbdnhc
  D1C1    21 D00C        C      	ld	hl,conol
  D1C4    7E             C      	ld	a,(hl)
  D1C5    EE 0E          C      	xor	0cdh xor 0c3h	;CALL aus JP u.umgekehrt
  D1C7    77             C      	ld	(hl),a
  D1C8    3E 80          C      	ld	a,1 shl lmphcp	;Hardcopy-Lampe
  D1CA    C3 D2C5        C      	jp	kbdslm
  D1CD                   C      kbdnhc:
                         C       ENDIF
                         C       ENDIF	;stpvar
                         C      
                         C       IF monitor
                         C       ENDIF
                         C      
  D1CD    FE D1          C      	cp	Sel0		;Selector 0?
  D1CF    38 09          C      	jr	c,kbdnsl	;nein
  D1D1    FE D9          C      	cp	Sel3+1		;Selector 0..3?
  D1D3    30 05          C      	jr	nc,kbdnsl	;nein
  D1D5    E6 0F          C      	and	0fh		;Bit 0..3
  D1D7    C3 D2C5        C      	jp	kbdslm
  D1DA                   C      kbdnsl:
  D1DA    B7             C      	or	a		;Taste zu ignorieren?
  D1DB    F8             C      	ret	m		;ja
                         C      
                         C      ; Zeichen im Puffer ablegen
                         C      ;--------------------------
  D1DC                   C      kbdput:
                         C       IF cpastz
                         C       ENDIF
  D1DC    21 FFFF        C      	ld	hl,0ffffh	;Pufferadresse
  D1DD                   C      crtm35	equ	$-2
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-26


  D1DF    01 0014        C      	ld	bc,kbdbl	;Pufferlaenge
  D1E2    5F             C      	ld	e,a		;A retten
  D1E3    AF             C      	xor	a		;Pufferende-Kennzeichen
  D1E4    ED B1          C      	cpir
  D1E6    20 08          C      	jr	nz,kbdpt1	;Puffer voll
  D1E8    77             C      	ld	(hl),a		;neues Pufferende anzeigen
  D1E9    7B             C      	ld	a,e		;A wiederherstellen
  D1EA    2B             C      	dec	hl
  D1EB    77             C      	ld	(hl),a		;Zeichen puffern
                         C      ;um bei Arbeit mit Anzeige des Tastaturpuffers in Statuszeile
                         C      ;Bildschirmflimmern zu vermeiden hinterlegen des gepufferten Zeichens
                         C      ;ausserhalb des Bildschirmbereichs fuer Test, ob ueberhaupt etwas im Puffer
                         C       IF cpastz
                         C       ENDIF
  D1EC    32 D17C        C      	ld	(kbdbfe),a
  D1EF    C9             C      	ret
  D1F0                   C      kbdpt1:
                         C       IF cpastz
                         C       ENDIF
  D1F0    C3 D60D        C      	jp	crtclk		;Puffer voll anzeigen
                         C      
                         C      ; Ablegen String im Puffer
                         C      ;-------------------------
                         C      ; i E	Stringlaenge -1
                         C      ; i HL	Stringanfang
  D1F3    1C             C      kbdco1:	inc	e
  D1F4    E5             C      kbdco2:	push	hl
  D1F5    D5             C      	push	de
  D1F6    7E             C      	ld	a,(hl)
  D1F7    CD D1DC        C      	call	kbdput		;Zeichen in Puffer
  D1FA    D1             C      	pop	de
  D1FB    E1             C      	pop	hl
  D1FC    23             C      	inc	hl
  D1FD    1D             C      	dec	e
  D1FE    20 F4          C      	jr	nz,kbdco2	;wenn String noch nicht fertig
  D200    C9             C      	ret
                         C      
                         C      ; Holen naechstes Tastaturzeichen mit Warten
                         C      ;===========================================
  D201                   C      kbdi:
  D201                   C      kbdmd1:		;Modifizierung bei K7634/36/37 mit:
                         C      ;kbdwin:call	kbdst		;Taste im Puffer
                         C      ;	jr	z,kbdwin	;nein, warten
                         C      ;	jp	kbdinn		;sonst aeltestes Pufferzeichen
                         C      
  D201    CD D169        C      kbdwin:	call	kbdst		;Taste im Puffer?
  D204    20 32          C      	jr	nz,kbdinn	;ja
  D206    21 D20A        C      	ld	hl,kbdwt	;wartefaktor
  D209    06 64          C      	ld	b,100		;fuer dauerfunktion
  D20A                   C      kbdwt	equ	$-1
  D20B    36 0A          C      	ld	(hl),10		;auf 10*0,01sec fuer
                         C      				;gleiche taste
  D20D    18 07          C      	jr	kbdwst		;einspr. in zyklus
  D20F    C5             C      kbdwa:	push	bc
  D210    06 01          C      	ld	b,1		;0,01 sec warten
  D212    CD E7B0        C      	call	wait10
  D215    C1             C      	pop	bc
  D216    CD D24D        C      kbdwst:	call	kbdst1		;taste neu gedrueckt?
  D219    20 13          C      	jr	nz,kbdwb	;ja, abholen ueber kbdst
  D21B    DB 06          C      	in	a,(kbdpci)	;taste noch gedrueckt?
  D21D    B7             C      	or	a		;(funktioniert nur bei K760X!)
  D21E    28 0E          C      	jr	z,kbdwb		;nein; warten
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-27


  D220    10 ED          C      	djnz	kbdwa		;abwarten, wie lange
                         C      
  D222    CD D26D        C      	call	kbdrch		;Zeichen umkodieren
  D225    B7             C      	or	a		;Sondertaste?
  D226    FA D201        C      	jp	m,kbdwin	;ja, keine Dauerfunktion
  D229    CD D1DC        C      	call	kbdput		;sonst puffern
  D22C    18 0A          C      	jr	kbdinn		;und aeltestes Pufferzeichen uebergeben
  D22E    CD D169        C      kbdwb:	call	kbdst		;abwarten tastendruck
  D231    28 FB          C      	jr	z,kbdwb
  D233    21 D20A        C      kbdwe:	ld	hl,kbdwt	;bei neuer taste
  D236    36 64          C      	ld	(hl),100	;100*0.01 sec warten
                         C      
  D238                   C      kbdinn:
                         C       IF cpastz
                         C       ENDIF
  D238    11 FFFF        C      	ld	de,0ffffh	;Kopf des Tastaturpuffers
  D239                   C      crtm33	equ	$-2
  D23B    1A             C      	ld	a,(de)		;1.Zeichen lesen
  D23C    21 0000        C      	ld	hl,0ffffh+1	;Puffer umspeichern
  D23D                   C      crtm34	equ	$-2
  D23F    01 0014        C      	ld	bc,kbdbl	;einschl. 00h am Ende
  D242    ED B0          C      	ldir			;parall. Tastatur-Interrupt
                         C      				;stoert nicht, da alles umgesp.
  D244    5F             C      	ld	e,a
  D245    3A FFFF        C      	ld	a,(0ffffh)
  D246                   C      crtm32	equ	$-2		;auf Kopf des Tastaturpuffers
                         C       IF cpastz
                         C       ENDIF
  D248    32 D17C        C       	ld	(kbdbfe),a	;neues Zeichen als Flag Puffer voll/leer
  D24B    7B             C      	ld	a,e
  D24C    C9             C      	ret
                         C      
                         C      ;-------------------------------------------------------------
                         C      
                         C      ; Test, ob Taste (neu) gedrueckt
                         C      ;===============================
                         C      ; o AF	=00 und Z=1	keine Taste
                         C      ;	=FF und Z=0	es ist eine Taste gedrueckt
  D24D                   C      kbdst1:
                         C      
                         C      ; Modifiziert bei K7637 mit
                         C      ;kbdst1:in	a,(kbdscs) bzw. (kbddcs)
                         C      ;	and	1
                         C      ;	ret	z		;(a)=0, z=1
                         C      ;	ld	hl,synflg
                         C      ;	bit	ctrlst,(hl)	;Ersatz-CNTL?
                         C      ;	ld	a,0ffh		;Schnittmaske c0..ff -> c0..ff
                         C      ;	jr	z,cst37b	;nein
                         C      ;	ld	a,0bfh		;Schnittmaske c0..ff -> 80..bf
                         C      ;cst37b:ld	(kbdlcs),a
                         C      ;	xor	a
                         C      ;	dec	a		;(a)=ff, z=0
                         C      ;	ret
                         C      
                         C      ; Modifiziert bei K7633 mit
                         C      ;kbdst1:in	a,(kbdbcs)
                         C      ;	and	3
                         C      ;	ret	z		;(a)=0, z=1
                         C      ;	ld	hl,synflg
                         C      ;	bit	ctrlst,(hl)	;Ersatz-CNTL?
                         C      ;	ld	a,0ffh		;Schnittmaske c0..ff -> c0..ff
                         C      ;	jr	z,cst33b	;nein
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-28


                         C      ;	ld	a,0bfh		;Schnittmaske c0..ff -> 80..bf
                         C      ;cst33b:ld	(kbdlcs),a
                         C      ;	xor	a
                         C      ;	dec	a		;(a)=ff, z=0
                         C      ;	ret
                         C      
                         C      ; Version fuer alle anderen Tastaturen
  D24D    DB 01          C      	in	a,(kbdpcs)
  D24F    2F             C      kbdstc:	cpl			;auf NOP, wenn Status negiert
                         C      ; Bit 3	=1:Taste gedrueckt
                         C      ; Bit 2	=1:Control gedrueckt
  D250    CB 5F          C      	bit	3,a		;Taste gedrueckt?
  D252    28 17          C      	jr	z,kbdst0	;nein
  D254    21 D03D        C      	ld	hl,synflg
  D257    CB 57          C      	bit	2,a		;CNTL-Taste gedrueckt?
  D259    28 02          C      kbdstm:	jr	z,cst34a	;nein (auf jr modif., wenn kein CNTL-Status)
  D25B    CB C6          C      	set	ctrlst,(hl)	;sonst vermerken
  D25D    CB 46          C      cst34a:	bit	ctrlst,(hl)	;Taste mit CNTL oder Ersatz-CNTL?
  D25F    3E FF          C      	ld	a,0ffh		;Schnittmaske c0..ff -> c0..ff
  D261    28 02          C      	jr	z,cst34b	;nein
  D263    3E BF          C      	ld	a,0bfh		;Schnittmaske c0..ff -> 80..bf
  D265    32 D2A8        C      cst34b:	ld	(kbdlcs),a
  D268    AF             C      	xor	a
  D269    3D             C      	dec	a		;(a)=ff, z=0
  D26A    C9             C      	ret
  D26B    AF             C      kbdst0:	xor	a		;(a)=0, z=1
  D26C    C9             C      	ret
                         C      ;-------------------------------------------------------------
                         C      
                         C      ;Zeichen von Tastatur lesen , CAPS-Lock realisieren
                         C      ;==================================================
  D26D    CD D286        C      kbdrch:	call	kbdrcu		;Zeichen holen
  D270    21 0040        C      	ld	hl,lampbf
  D273    CB 46          C      	bit	kbdcpb,(hl)	;CAPS-Lock?
  D275    C8             C      kbdmd3:	ret	z		;nein (auf ret nz, wenn nach RESET Grossb.)
  D276    FE 41          C      	cp	'A'
  D278    D8             C      	ret	c
  D279    FE 5B          C      	cp	'Z'+1
  D27B    38 06          C      	jr	c,kbdcp1
  D27D    FE 61          C      	cp	'a'
  D27F    D8             C      	ret	c
  D280    FE 7B          C      	cp	'z'+1
  D282    D0             C      	ret	nc
  D283    EE 20          C      kbdcp1:	xor	20h		;gross <-> klein
  D285    C9             C      	ret
                         C      
                         C      ; Zeichen von Tastatur umkodieren
                         C      ;================================
  D286                   C      kbdrcu:
  D286    DB 06          C      	in	a,(kbdpci)	;Zeichen lesen
  D287                   C      kbdmt1	equ	$-1		;auf "kbdsci/kbddci" bei K7637
                         C      
  D288    21 D336        C      cocpm1:	ld	hl,kbdcpt
  D28B    4E             C      kbdrc3:	ld	c,(hl)		;phys. Tastencode
  D28C    0C             C      	inc	c
  D28D    0D             C      	dec	c		;TabEnde?
  D28E    28 07          C      	jr	z,kbdrc1	;ja
  D290    B9             C      	cp	c		;Umcodieren ?
  D291    23             C      	inc	hl
  D292    28 07          C      	jr	z,kbdrc2	;ja
  D294    23             C      	inc	hl
  D295    18 F4          C      	jr	kbdrc3		;weiter in Tab
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-29


  D297    FE 80          C      kbdrc1:	cp	80h		;Sonderzeichen, das nicht in Tabelle?
  D299    38 01          C      	jr	c,kbdrc6	;nein; sonst A=00, d.h. Zeichen ignorieren
  D29B    7E             C      kbdrc2:	ld	a,(hl)		;virtueller Tastencode
  D29C                   C      kbdrc6:	
                         C      
  D29C                   C      cocpm2:
  D29C    21 D03D        C      	ld	hl,synflg
  D29F    FE 20          C      	cp	20h		;Sondertaste?
  D2A1    38 0D          C      	jr	c,kbdrc5	;<20h, ja
  D2A3    FE 80          C      	cp	80h		
  D2A5    38 04          C      	jr	c,kbdrc4	;nein
                         C      ; virtueller Code 80..ff
  D2A7    E6 FF          C      	and	0ffh
  D2A8                   C      kbdlcs	equ	$-1		;auf bfh, wenn Taste mit Control/Shift
  D2A9    18 05          C      	jr	kbdrc5
                         C      ; normale Taste 20..7f
  D2AB    CB 46          C      kbdrc4:	bit	ctrlst,(hl)	;norm. Taste mit Control?
  D2AD    C8             C      	ret	z
  D2AE    E6 1F          C      	and	1fh		;CTRL realisieren
  D2B0    CB 86          C      kbdrc5:	res	ctrlst,(hl)
  D2B2    C9             C      	ret
                         C      
                         C      ; Suchen, ob Taste (A) umzukodieren entspr. Stringtab ab (HL)
                         C      ; ret z:	nicht gefunden, A unveraendert
                         C      ; ret nz:	gefunden, A unveraendert
                         C      ;		E Stringlaenge +1
                         C      ;		HL Stringanfang (nur gueltig falls E>1!)
  D2B3    16 00          C      costr:	ld	d,0
  D2B5    4E             C      costr0:	ld	c,(hl)		;Tastencode o. Tabende
  D2B6    0C             C      	inc	c		;Tabende?
  D2B7    C8             C      	ret	z		;ja, nicht gefunden
  D2B8    23             C      	inc	hl
  D2B9    5E             C      	ld	e,(hl)		;Stringlaenge
  D2BA    1C             C      	inc	e		;+1
  D2BB    0D             C      	dec	c		;Tastencode wiederherstellen
  D2BC    B9             C      	cp	c		;Zeichen umkodieren?
  D2BD    28 03          C      	jr	z,costr1	;ja
  D2BF    19             C      	add	hl,de		;String uebergehen
  D2C0    18 F3          C      	jr	costr0
  D2C2                   C      costr1:
  D2C2    23             C      	inc	hl
  D2C3    14             C      	inc	d		;ret nz
  D2C4    C9             C      	ret
                         C      
                         C       IF costu
                         C       ENDIF
                         C      
                         C      ; Tastatur-Lampe umschalten
                         C      ;==========================
  D2C5    21 0040        C      kbdslm:	ld	hl,lampbf
  D2C8    AE             C      	xor	(hl)		;Lampe ein/aus
  D2C9    77             C      	ld	(hl),a
                         C      
                         C      ; Tastatur-Lampen ein/aus
                         C      ;========================
                         C      ; Achtung! Diese Routine wird auch aus Interrupt-Routine
                         C      ; aufgerufen (EI/DI darf hier nicht auftreten!!)
  D2CA                   C      lampen:
                         C      
  D2CA                   C      kbdmd2:		;Routine fuer K7637,
                         C      ;		 wird modifiziert bei K7604/06/34/36
  D2CA    3A 0040        C      lampen:	ld	a,(lampbf)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-30


  D2CD    EE 00          C      	xor	00h		;ermitteln veraenderte Bits
  D2CE                   C      lamplt	equ	$-1		;Kopie Lampen-Puffer
  D2CF    C8             C      	ret	z		;unveraendert
  D2D0    21 E61C        C      	ld	hl,intkbd
  D2D3    36 21          C      	ld	(hl),21h	;call ... -> ld hl,...
                         C      				;d.h. 5ms Tastaturabfrage verbieten
  D2D5    26 55          C      	ld	h,55h		;Standard-Vorbyte
  D2D7    6F             C      	ld	l,a
  D2D8    CB 7D          C      	bit	7,l		;INS-MODE ?
  D2DA    28 06          C      	jr	z,lampb6	;nein
  D2DC    7C             C      	ld	a,h
  D2DD    D3 5C          C      	out	(kbdsci),a
  D2DE                   C      k37dm3	equ	$-1		;modfiziert bei Digitalisier-AP
  D2DF    CD D324        C      	call	lmpout
  D2E2    CB 75          C      lampb6:	bit	6,l		;Fehlerlampe ?
  D2E4    28 05          C      	jr	z,lampb3	;nein
  D2E6    3E 20          C      	ld	a,20h
  D2E8    CD D324        C      	call	lmpout
  D2EB    CB 5D          C      lampb3:	bit	3,l		;Sel3?
  D2ED    28 08          C      	jr	z,lampb2
  D2EF    7C             C      	ld	a,h
  D2F0    D3 5C          C      	out	(kbdsci),a
  D2F1                   C      k37dm4	equ	$-1		;modfiziert bei Digitalisier-AP
  D2F2    3E 52          C      	ld	a,52h
  D2F4    CD D324        C      	call	lmpout
  D2F7    CB 55          C      lampb2:	bit	2,l		;Sel2?
  D2F9    28 08          C      	jr	z,lampb1
  D2FB    7C             C      	ld	a,h
  D2FC    D3 5C          C      	out	(kbdsci),a
  D2FD                   C      k37dm5	equ	$-1		;modfiziert bei Digitalisier-AP
  D2FE    3E 44          C      	ld	a,44h
  D300    CD D324        C      	call	lmpout
  D303    CB 4D          C      lampb1:	bit	1,l
  D305    28 08          C      	jr	z,lampb0
  D307    7C             C      	ld	a,h
  D308    D3 5C          C      	out	(kbdsci),a
  D309                   C      k37dm6	equ	$-1		;modfiziert bei Digitalisier-AP
  D30A    3E 20          C      	ld	a,20h
  D30C    CD D324        C      	call	lmpout
  D30F    CB 45          C      lampb0:	bit	0,l
  D311    28 05          C      	jr	z,lampbn
  D313    3E 52          C      	ld	a,52h
  D315    CD D324        C      	call	lmpout
  D318    3A 0040        C      lampbn:	ld	a,(lampbf)
  D31B    32 D2CE        C      	ld	(lamplt),a	;neuen Zustand merken
  D31E    21 E61C        C      	ld	hl,intkbd
  D321    36 CC          C      	ld	(hl),0cch	;ld hl,... -> call z,...
  D323    C9             C      	ret
                         C      
  D324    E5             C      lmpout:	push	hl
  D325    D3 5C          C      	out	(kbdsci),a
  D326                   C      k37dm7	equ	$-1		;modfiziert bei Digitalisier-AP
  D327    CD D24D        C      lmpow:	call	kbdst1		;warten auf Antwort
  D32A    28 FB          C      	jr	z,lmpow
  D32C    DB 5C          C      	in	a,(kbdsci)
  D32D                   C      k37dm8	equ	$-1		;modfiziert bei Digitalisier-AP
  D32E    E6 F0          C      	and	0f0h
  D330    FE 80          C      	cp	typc37		;Antwort da?
  D332    20 F3          C      	jr	nz,lmpow	;nein
  D334    E1             C      	pop	hl
  D335    C9             C      	ret
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-31


                         C      ; virtuelle Tastencodes: (unabhaengig von TastaturTyp)
                         C      ;=======================
                         C      
                         C      ; Beim Betaetigen zusammen mit CONTROL/SHIFT wird bei allen folgenden
                         C      ; Tastencodes >=c0h Bit 6 geloescht (d.h. Codes liegen von 80h..bfh)
                         C      
                         C      ; Kursortasten
                         C      ;-------------
  00C1                   C      kcurwl	equ	0c1h
  00C2                   C      kcurup	equ	0c2h
  00C3                   C      kcurwr	equ	0c3h
  00C4                   C      kcurlf	equ	0c4h
  00C5                   C      kcurpu	equ	0c5h
  00C6                   C      kcurri	equ	0c6h
  00C7                   C      kcurpd	equ	0c7h
  00C8                   C      kcurdw	equ	0c8h
                         C      
                         C      ; Sondertasten
                         C      ;-------------
                         C      ;		0c9h		;belegt mit zblb
  00CA                   C      spcclr	equ	0cah		;CLEAR
  00CB                   C      spccnc	equ	0cbh		;CNCL	
  00CC                   C      spcce	equ	0cch		;CE bzw. ERASE INPUT
  00CD                   C      spcins	equ	0cdh		;INS
  00C0                   C      spcdel	equ	0c0h		;DEL
  00CE                   C      spckor	equ	0ceh		;KOR
  00CF                   C      spcrol	equ	0cfh		;ROLL <-
  00D0                   C      spcror	equ	0d0h		;ROLL ->
                         C      
                         C      ; Bei Einfuehrung neuer Sonderzeichen zwischen Sel0..Sel3 muss
                         C      ; Test auf Sel0..3 zuletzt erfolgen, da diese als Gruppe
                         C      ; getestet werden, aber nicht dicht liegen!
  00D1                   C      Sel0	equ	0d1h;!!hintere!!	;LED 0 bei SEL 0
  00D2                   C      Sel1	equ	0d2h;!!Tetrade!!	;LED 1 bei SEL 1
  00D4                   C      Sel2	equ	0d4h;!!=2**LED!!	;LED 2 bei SEL 2
  00D8                   C      Sel3	equ	0d8h;!!	      !!	;LED 3 bei SEL 3
                         C      
  00D9                   C      SyLc	equ	0d9h			; Synch. List
  00DA                   C      HrLc	equ	0dah			; Hardcopy
  00DB                   C      Monc	equ	0dbh			; BIOS-Monitor
  00DC                   C      z00c	equ	0dch			; "00" im Ziffernblock
  00DD                   C      z000	equ	0ddh			; "000" im Ziffernblock
  00DE                   C      stpc	equ	0deh			; allg. STOP
  00DF                   C      ctlc	equ	0dfh			; Control (-Ersatz)
                         C      
                         C      ; Funktionstasten
                         C      ;----------------
  00E0                   C      pf0c	equ	0e0h			;PF0 bzw. S0 bzw. Enter im Ziffernblock
  00E1                   C      pf1c	equ	0e1h			;PF1...
  00E2                   C      pf2c	equ	0e2h
  00E3                   C      pf3c	equ	0e3h
  00E4                   C      pf4c	equ	0e4h
  00E5                   C      pf5c	equ	0e5h
  00E6                   C      pf6c	equ	0e6h
  00E7                   C      pf7c	equ	0e7h
  00E8                   C      pf8c	equ	0e8h
  00E9                   C      pf9c	equ	0e9h
                         C      ;***die folgenden 6 Funktionstasten ex nicht bei allen
                         C      ; Tastaturen, koennen aber durch andere Tasten ersetzt werden!
  00EA                   C      pfac	equ	0eah
  00EB                   C      pfbc	equ	0ebh
  00EC                   C      pfcc	equ	0ech
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-32


  00ED                   C      pfdc	equ	0edh
  00EE                   C      pfec	equ	0eeh		;bei CP/A i.a. Monitor-Taste
  00EF                   C      pffc	equ	0efh		;bei CP/A i.a. Stop-Taste
                         C      
                         C      ;rechter Ziffernblock
                         C      ;--------------------
  00F0                   C      zbl0	equ	0f0h
  00F1                   C      zbl1	equ	0f1h
  00F2                   C      zbl2	equ	0f2h
  00F3                   C      zbl3	equ	0f3h
  00F4                   C      zbl4	equ	0f4h
  00F5                   C      zbl5	equ	0f5h
  00F6                   C      zbl6	equ	0f6h
  00F7                   C      zbl7	equ	0f7h
  00F8                   C      zbl8	equ	0f8h
  00F9                   C      zbl9	equ	0f9h
  00DC                   C      zbl00	equ	z00c
  00DD                   C      zbl000	equ	z000
  00FA                   C      zblkom	equ	0fah		;Komma im Ziffernblock
  00FB                   C      zblmin	equ	0fbh		;Minus im Ziffernblock bei CP/A i.a. HardCopy
                         C      	;Enter im Ziffernblock als "pf0c" behandelt
  00FC                   C      zbla	equ	0fch		;Taste im Ziffernblock ueber der "7"
                         C      ;		0fdh		;belegt wegen TastenUmdefinitionsBegrenzer
  00C9                   C      zblb	equ	0c9h		;dito "8"
  00FE                   C      zblc	equ	0feh		;dito "9"
                         C      
                         C      ; zu ignorierende Tasten
                         C      ;-----------------------
  00FF                   C      cign	equ	0ffh			;Taste ignorieren
                         C      
  0000                   C      kbdcpb	equ	lmpsl0	;0..3, Selectortaste fuer CAPS-Lock
  0001                   C      kbdcal	equ	lmpsl1	;0..3, Selectortaste fuer ALPHA K7633
                         C      
                         C      ; Die folgende Code-Tabelle wird je nach Tastaturtyp beim
                         C      ; Kaltstart modifiziert. Sie dient dazu, um einen virtuellen
                         C      ; Tastaturcode zu erzeugen, der dann durch die String-
                         C      ; umkodierungstabellen unabhaengig von der konkreten Tastatur
                         C      ; zum eigentlichen Tastencode umgesetzt wird.
                         C      
                         C      ; Codetabelle fuer K7606/36
                         C      ;==========================
                         C      ;(Bemerkung: Falls sich K76x4-Tastaturen mit dem Typcode von K76x6 melden,
                         C      ;wurden einige phys. Tastencodes fuer diese mit aufgenommen, um trotzdem
                         C      ;eine notduerftige Arbeit zu erlauben. Gleichzeitig wird fuer die Kaltstart-
                         C      ;Modifizierung von 'kbdcpt' Reserve-Platz freigehalten.)
                         C      
  D336                   C      kbdcpt:
                         C      ; Kursortasten
                         C      ;-------------
  D336    0B C1          C      	db	00BH,kcurwl		;|<-
  D338    04 C2          C      	db	004H,kcurup		;^
  D33A    01 C3          C      	DB	001H,kcurwr		;->|
  D33C    06 C4          C      	db	006H,kcurlf		;<-
  D33E    0C C5          C      	DB	00CH,kcurpu		;'\
  D340    07 C6          C      	db	007H,kcurri		;->
  D342    0A C7          C      	db	00AH,kcurpd		;<-'
  D344    05 C8          C      	db	005H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  D346    FF 0D          C      	db	0ffh,0dh		;ET1 als CR
  D348    9D 0D          C      	db	09dh,0dh		;ENTR			K7604/34
  D34A    0F 09          C      	db	00FH,009h		;|<-| als Ersatz Tab
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-33


  D34C    13 1B          C      	db	013H,01bh		;DELL als Ersatz ESC
  D34E    1B C0          C      	db	01BH,spcdel		;DEL
  D350    19 CC          C      	db	019H,spcce		;CE
  D352    09 CC          C      	db	009H,spcce		;ERIN als Ersatz CE	K7604/34
  D354    03 CD          C      	db	003H,spcins		;INSL
  D356    1E CD          C          	db	01eH,spcins		;INS			K7604/34
  D358    A0 D1          C      	DB	0A0H,Sel0		;SEL0
  D35A    A1 D2          C      	DB	0A1H,Sel1		;SEL1
  D35C    A2 D4          C      	DB	0A2H,Sel2		;SEL2
  D35E    A3 D8          C              DB	0A3H,Sel3		;SEL3
  D360    FE DF          C      	db	0feh,ctlc		;ET2 als Control-Taste (Loslassen!)
  D362    1F DF          C      	db	01fH,ctlc		;RESET Control-Taste	K7604/34
                         C      ; num. Tasten
                         C      ;------------
  D364    14 FF          C      	db	10*2,0ffh		;Reserve fuer rechtes Ziffernfeld
  D366    11 DC          C      	db	011H,zbl00		;00
  D368    12 DD          C      	db	012H,zbl000		;000
  D36A    A8 FB          C      	DB	0A8H,zblmin		;INSM als Ersatz num. Minus
  D36C    02 FB          C      	db	002H,zblmin		;INSM			K7604/34
                         C      ; Funktionstasten
                         C      ;----------------
  D36E    C0 E0          C      	db	0c0h,pf0c		;S
  D370    C1 E1          C      	db	0c1h,pf1c		;S1
  D372    C2 E2          C      	db	0c2h,pf2c		;S2
  D374    C3 E3          C      	db	0c3h,pf3c		;S3
  D376    C4 E4          C      	db	0c4h,pf4c		;S4
  D378    C5 E5          C      	db	0c5h,pf5c		;S5
  D37A    C6 E6          C      	db	0c6h,pf6c		;S6
  D37C    C7 E7          C      	db	0c7h,pf7c		;S7
  D37E    C8 E8          C      	db	0c8h,pf8c		;S8
  D380    C9 E9          C      	db	0c9h,pf9c		;S9
  D382    CA EA          C      	db	0cah,pfac		;S10
  D384    CB EB          C      	db	0cbh,pfbc		;S11
  D386    CC EC          C      	db	0cch,pfcc		;S12
  D388    10 EE          C      	db	010H,pfec		;MON als PF14
  D38A    08 EE          C      	db	008H,pfec		;EREO als Ersatz PF14	K7604/34
  D38C    AF EF          C      	DB	0AFH,pffc		;CI als Ersatz PF15
                         C      
  D38E    00             C      	db	0			;Tabellenende
  D38F                   C      	ds	12,0			;Reserve fuer K7633, K7637
  0065                   C      kbdcpl	equ	$-kbdcpt		;max. Tabellenlaenge
                         C      ;----------------------------------------------------------
                         C      
                         C      ; String-Umkodierungstabellen
                         C      ;============================
                         C      
                         C      ; Standardstrings:
                         C      
  D39B                   C      kbdsts:	costs
  D39B    C1 01 01       C+     	db	kcurwl,1,'A' and 1fh
  D39E    C2 01 05       C+     	db	kcurup,1,'E' and 1fh
  D3A1    C3 01 06       C+     	db	kcurwr,1,'F' and 1fh
  D3A4    C4 01 08       C+     	db	kcurlf,1,'H' and 1fh
  D3A7    C5 01 12       C+     	db	kcurpu,1,'R' and 1fh
  D3AA    C6 01 04       C+     	db	kcurri,1,'D' and 1fh
  D3AD    C7 01 03       C+     	db	kcurpd,1,'C' and 1fh
  D3B0    C8 01 18       C+     	db	kcurdw,1,'X' and 1fh
  D3B3    E0 01 02       C+     	db	pf0c,1,'B' and 1fh
  D3B6    E1 01 07       C+     	db	pf1c,1,'G' and 1fh
  D3B9    E2 01 19       C+     	db	pf2c,1,'Y' and 1fh
  D3BC    E3 01 14       C+     	db	pf3c,1,'T' and 1fh
  D3BF    E4 01 16       C+     	db	pf4c,1,'V' and 1fh
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-34


  D3C2    E5 01 0C       C+     	db	pf5c,1,'L' and 1fh
  D3C5    E6 02 0F 44    C+     	db	pf6c,2,'O' and 1fh,'D'
  D3C9    E7 02 0F 47    C+     	db	pf7c,2,'O' and 1fh,'G'
  D3CD    E8 01 17       C+     	db	pf8c,1,'W' and 1fh
  D3D0    E9 01 1A       C+     	db	pf9c,1,'Z' and 1fh
  D3D3    EA 04 0B 53    C+     	db	pfac,4,'K' and 1fh,'S','Q' and 1fh,'P'
  D3D7    11 50          C+     
  D3D9    EB 02 0B 42    C+     	db	pfbc,2,'K' and 1fh,'B'
  D3DD    EC 02 0B 4B    C+     	db	pfcc,2,'K' and 1fh,'K'
  D3E1    ED 02 0B 56    C+     	db	pfdc,2,'K' and 1fh,'V'
  D3E5    EE 01 DB       C+     	db	pfec,1,Monc
  D3E8    EF 01 DE       C+     	db	pffc,1,Stpc
  D3EB    F1 01 31       C+     	db	zbl1,1,'1'
  D3EE    F2 01 32       C+     	db	zbl2,1,'2'
  D3F1    F3 01 33       C+     	db	zbl3,1,'3'
  D3F4    F4 01 34       C+     	db	zbl4,1,'4'
  D3F7    F5 01 35       C+     	db	zbl5,1,'5'
  D3FA    F6 01 36       C+     	db	zbl6,1,'6'
  D3FD    F7 01 37       C+     	db	zbl7,1,'7'
  D400    F8 01 38       C+     	db	zbl8,1,'8'
  D403    F9 01 39       C+     	db	zbl9,1,'9'
  D406    F0 01 30       C+     	db	zbl0,1,'0'
  D409    DC 02 30 30    C+     	db	zbl00,2,'00'
  D40D    DD 03 30 30    C+     	db	zbl000,3,'000'
  D411    30             C+     
  D412    FA 01 2E       C+     	db	zblkom,1,'.'
  D415    FB 01 DA       C+     	db	zblmin,1,HrLc
  D418    CC 01 18       C+     	db	spcce,1,'X' and 1fh
  D41B    CD 01 D9       C+     	db	spcins,1,SyLc
  D41E    C0 01 7F       C+     	db	spcdel,1,7fh
  D421    81 02 11 01    C+     	db	kcurwl-40h,2,'Q' and 1fh,'A' and 1fh
  D425    82 02 11 05    C+     	db	kcurup-40h,2,'Q' and 1fh,'E' and 1fh
  D429    83 02 11 06    C+     	db	kcurwr-40h,2,'Q' and 1fh,'F' and 1fh
  D42D    84 02 11 13    C+     	db	kcurlf-40h,2,'Q' and 1fh,'S' and 1fh
  D431    85 02 11 12    C+     	db	kcurpu-40h,2,'Q' and 1fh,'R' and 1fh
  D435    86 02 11 04    C+     	db	kcurri-40h,2,'Q' and 1fh,'D' and 1fh
  D439    87 02 11 03    C+     	db	kcurpd-40h,2,'Q' and 1fh,'C' and 1fh
  D43D    88 02 11 18    C+     	db	kcurdw-40h,2,'Q' and 1fh,'X' and 1fh
  D441    A0 02 11 02    C+     	db	pf0c-40h,2,'Q' and 1fh,'B' and 1fh
  D445    A1 02 11 10    C+     	db	pf1c-40h,2,'Q' and 1fh,'P' and 1fh
  D449    A2 02 11 19    C+     	db	pf2c-40h,2,'Q' and 1fh,'Y' and 1fh
  D44D    A3 02 11 7F    C+     	db	pf3c-40h,2,'Q' and 1fh,7fh
  D451    A4 02 11 16    C+     	db	pf4c-40h,2,'Q' and 1fh,'V' and 1fh
  D455    A5 02 11 0C    C+     	db	pf5c-40h,2,'Q' and 1fh,'L' and 1fh
  D459    A8 02 11 17    C+     	db	pf8c-40h,2,'Q' and 1fh,'W' and 1fh
  D45D    A9 02 11 1A    C+     	db	pf9c-40h,2,'Q' and 1fh,'Z' and 1fh
  D461    AB 02 11 02    C+     	db	pfbc-40h,2,'Q' and 1fh,'B' and 1fh
  D465    AC 02 11 0B    C+     	db	pfcc-40h,2,'Q' and 1fh,'K' and 1fh
  D469    AD 02 11 16    C+     	db	pfdc-40h,2,'Q' and 1fh,'V' and 1fh
  D46D    FF             C      	db	0ffh		;Tab.ende
                         C      
                         C       IF costu
                         C       ENDIF
                                
                         C      	include BIOSCRT
                         C      ;************************************************************
                         C      ; Bildschirm-Ausgabe K7023, K7024, DSY5 u.ae.
                         C      ; - Fehlerkorrektur Steuerzeichen 18h (es wurden nur 79 Zeichen gel.)
                         C      ; - bei Tastenumdefinition auch chr(253) als Begrenzer (dbase)
                         C      ; - BAB2 als Standardvariante
                         C      ; - 17h (insline) und 19h (delline) eingefuehrt fuer TURBO-PASCAL-Editor
                         C      ; - Realisierung der SCP1715-Steuerzeichen 1b 5e xx (Feldattribut)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-35


                         C      ;   und 1b 5f xx (Spezialzeichen)
                         C      ;   Diese ESC-Folgen fueren beim Buerocomputer i.a. auf '^' (unzulaessig),
                         C      ;   ausser Feldattribute invers und hell (Reaktion wie Steuerz. 84..87)
                         C      ; - Einfuehrung Umlaut-Umkodierung fuer deutschen Zeichensatz
                         C      ;   einschl. SCP1715-Steuerzeichen 0Eh und 0Fh
                         C      ; - Einfuehrung MACROS "setbs" und "setram" zum Hin- und Rueckschalten
                         C      ;   des Bildschirmpuffers
                         C      ; 17.06.88
                         C      ; - Zugriff zum Bildschirm aus Interruptroutinen unterdrueckt
                         C      ; - Unterstuetzung von Karten mit Bit 7 invers (z.B. DSY5)
                         C      ; - Unterst. einer weiteren Variante fuer dtsch. Zeichens. auf 00..1f (ZSIBM)
                         C      ; 23.09.88
                         C      ; - Einfuehrung der Macros 'crton' und 'crtoff'
                         C      ; - di/ei waehrend Bildschirmumschaltung eingefuehrt
                         C      ;************************************************************
                         C      
                         C       if1
                         C       endif	;if1
                         C      
                         C       IF crtbfl eq 0
                         C       ELSE ;crtbfl ne 0
                         C        IF1
                         C        ENDIF
                         C       ENDIF
                         C      
                         C      
                         C      ;**************************************************************************
  D146                   C      crtst	equ	dumst		;CRT:-Status immer ready
                         C      
  D46E                   C      crto:
  D46E    3E C3          C      	ld	a,0c3h		;jp ...
  D470    32 E648        C      	ld	(intcrt),a	;waehrend Bildaufbau Interrupt-Zugriff verb.
  D473    C5             C      	push	bc		;merken zeichen in c
  D474    2A D038        C      	ld	hl,(crtcps)	;Kursorposition	
                         C      	setbs
  D477    CB BE          C      	res	7,(hl)		;loeschen Kursor
                         C      	setram
  D479    CD D4AB        C      	call	crtoti		;Zeichen ausgeben
                         C      ;				 HL danach auf neuer Kursorpositon
                         C      
                         C      ; Setzen Kursor auf (HL)
                         C      
  D47C    22 D038        C      	ld	(crtcps),hl	;cursorposition
                         C      	setbs
  D47F    3E 80          C      	ld	a,80h
  D480                   C      dcurs	equ	$-1
  D481    B6             C      	or	(hl)		;Kursor setzen
  D482    77             C      	ld	(hl),a
                         C      	setram
  D483    C1             C      crtonc:	pop	bc		;wiederherstellen c-reg
                         C      
  D484    3E 21          C      	ld	a,021h		;ld hl,...
  D486    32 E648        C      	ld	(intcrt),a	;wiederzulassen Zugriff aus Interruptrtn
                         C      
                         C       if (stpvar ne 0)  and (chdvar ne 0)
                         C      ; Hardcopy realisieren
                         C      
  D489    3A 0040        C      	ld	a,(lampbf)
  D48C    CB 7F          C      	bit	lmphcp,a	;Hardcopy?
  D48E    C8             C      	ret	z		;nein
  D48F    79             C      	ld	a,c
  D490    E6 7F          C      	and	7fh
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-36


  D492    FE 20          C      	cp	20h		;Steuerzeichen?
  D494    38 03          C      	jr	c,crtoe1	;ja
  D496    FE 7F          C      	cp	7fh
  D498    D8             C      	ret	c
  D499    C5             C      crtoe1:	push	bc
  D49A    21 D4A7        C      	ld	hl,crtlc	;zugelassene Steuerzeichen
  D49D    01 0004        C      	ld	bc,crtlcl
  D4A0    ED B1          C      	cpir			;erlaubt?
  D4A2    C1             C      	pop	bc
  D4A3    C8             C      	ret	z		;ja
  D4A4    0E 5E          C      	ld	c,'^'		;sonst Spezialzeichen
  D4A6    C9             C      	ret
                         C      
                         C      ; bei Hardcopy Bildschirm -> Drucker zugelassene Steuerzeichen
                         C      
  D4A7    08 0A 0C 0D    C      crtlc:	db	08h,0ah,0ch,0dh
  0004                   C      crtlcl	equ	$-crtlc
                         C      
                         C       endif	;stpvar and chdvar
                         C      
                         C      
                         C      ;========================================================
                         C      ; interner Aufruf Bildschirmtreiber
                         C      ; i HL	Zeiger in Bildschirmpuffer auf Kursorposition
                         C      ; o HL	neuer Zeiger auf Kursorposition
                         C      ;========================================================
                         C      
  D4AB                   C      crtoti:
  D4AB    3E 00          C      	ld	a,0		;escape mode
  D4AC                   C      desc	equ	$-1
  D4AD    B7             C      	or	a
  D4AE    20 62          C      	jr	nz,crto04	;ja
  D4B0    79             C      crto02:	ld	a,c
  D4B1    32 D6B0        C      	ld	(crtcch),a	;merken fuer direkte Ausgabe
  D4B4    FE 87          C      	cp	87h		;07h ist bell!, daher 87h<>07h
  D4B6    28 39          C      	jr	z,crto09
  D4B8    CB BF          C      	res	7,a		;sonst 1xxxxxxxB  = 0xxxxxxxB
  D4BA    FE 20          C      	cp	20h		;steuerzeichen?
  D4BC    38 33          C      	jr	c,crto09	;ja
  D4BE    FE 7F          C      	cp	7fh
  D4C0    30 2F          C      	jr	nc,crto09
                         C       IF umlaut
  D4C2    CD D67F        C      	call	crtuml		;evtl. Umlaute umkodieren
                         C       ENDIF
  D4C5                   C      crtobs:
  D4C5    EB             C      	ex	de,hl
                         C       IF crt eq dsy5
                         C       ENDIF
  D4C6                   C      crtsbl:
                         C      	setbs
  D4C6    12             C      	ld	(de),a		;Zeichen in Bildschirmpuffer
                         C      	setram
  D4C7    21 0001        C      crtcur:	ld	hl,0-bsend1
  D4C8                   C      crtm01	equ	$-2
  D4CA    19             C      	add	hl,de		;bs voll?
  D4CB    EB             C      	ex	de,hl
  D4CC    23             C      	inc	hl	
  D4CD    D0             C      	ret	nc
  D4CE    11 FFC0        C      	ld	de,bsend1-bssp1+1
  D4CF                   C      crtm02	equ	$-2
  D4D1    D5             C      crto03:	push	de
  D4D2    21 FC40        C      	ld	hl,bsanf1+bssp1	;aufschieben
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-37


  D4D3                   C      crtm03	equ	$-2
  D4D5    11 FC00        C      	ld	de,bsanf1
  D4D6                   C      crtm04	equ	$-2
  D4D8    01 03C0        C      	ld	bc,bsend1-bsanf1-bssp1+1
  D4D9                   C      crtm05	equ	$-2
                         C      	setbs
  D4DB    ED B0          C      	ldir
  D4DD    2B             C      	dec	hl
  D4DE    36 20          C      	ld	(hl),' '	;letzte zeile loeschen
  D4E0    11 FFFE        C      	ld	de,bsend1-1
  D4E1                   C      crtm06	equ	$-2
  D4E3    01 003F        C      	ld	bc,bssp1-1
  D4E4                   C      crtm07	equ	$-2
  D4E6    ED B8          C      	lddr
                         C      	setram
  D4E8    E1             C      	pop	hl
  D4E9    C9             C      	ret
                         C      ;------------------------------
                         C      ; 84/04,..,86/06,87
                         C      
                         C       IF crt eq k7024
  D4EA                   C      crto84:
  D4EA                   C      crto85:
  D4EA                   C      crto86:
  D4EA                   C      crto87:
  D4EA    3A D6B0        C      	ld	a,(crtcch)	;Zeichen direkt ausgeben
  D4ED    CB BF          C      	res	7,a		;ohne Bit 7
  D4EF    18 D4          C      	jr	crtobs
                         C       ENDIF
                         C       IF crt eq dsy5
                         C       ENDIF
                         C      ;--------------------------------
                         C      
                         C      ; Behandlung Sonderzeichen
                         C      ;=========================
  D4F1    EB             C      crto09:	ex	de,hl		;test sonderzeichen
  D4F2    21 D6B1        C      	ld	hl,dszta
  D4F5    01 0018        C      	ld	bc,dsztal
  D4F8    ED B1          C      	cpir
  D4FA    28 05          C      	jr	z,crto11	;gefunden
  D4FC    0E 5E          C      	ld	c,'^'		;nicht-Sonderz. anzeigen
  D4FE    EB             C      	ex	de,hl
  D4FF    18 AF          C      	jr	crto02		;falls nicht gefunden
  D501    21 D6F8        C      crto11:	ld	hl,dswe-1
  D504    B7             C      	or	a
  D505    ED 42          C      	sbc	hl,bc
  D507    ED 42          C      	sbc	hl,bc
  D509    46             C      	ld	b,(hl)
  D50A    2B             C      	dec	hl
  D50B    4E             C      	ld	c,(hl)		;bc:=ansprungadresse
  D50C    C5             C      	push	bc
  D50D    6B             C      	ld	l,e
  D50E    62             C      	ld	h,d		;bs adresse
  D50F    3E 20          C      	ld	a,' '		;fuer BS-loeschen
  D511    C9             C      crtnop:	ret			;ansprung sonderzeichen
                         C      ;-----------------------------
                         C      
                         C      ; Behandlung Zeichen innerhalb Escape-Folgen
                         C      ;===========================================
  D512                   C      crto04:	if	adm3a
                         C      	endif
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-38


                         C      	if	costu
                         C      	endif
                         C      
  D512    3D             C      	dec	a
  D513    32 D4AC        C      	ld	(desc),a	;naechstes escape flag setzen
                         C       IF escpc
  D516    79             C      	ld	a,c		;Zeichen mit offset nach A
                         C       ENDIF
  D517    CB B9          C      	res	7,c		;loeschen evtl. offset 80h
  D519    28 1B          C      	jr	z,crto07	;letztes Zeichen ESC-Folge
                         C      
                         C      ; vorletztes Zeichen ESC-Folge
                         C      ;-----------------------------
                         C       IF escpc
  D51B    D6 5E          C      	sub	5eh		;Feldattribut oder Sonderzeichen?
  D51D    32 D537        C      	ld	(crtffl),a	;wenn ja, so 00 bzw. 01
  D520    C8             C      	ret	z		;1b 5e xx
  D521    3D             C      	dec	a
  D522    C8             C      	ret	z		;1b 5f xx 
                         C       ENDIF
                         C      ;Positionierung Zeile
                         C       	if	adm3a
                         C      	endif
                         C      
  D523    3E 0F          C      	ld	a,bszl1-1	;letzte zeile
  D524                   C      crtm08	equ	$-1
  D525    B9             C      	cp	c		;nach letzter zeile?
  D526    38 01          C      	jr	c,crto05	;ja
  D528    79             C      	ld	a,c		;sonst auf gewuenschte zeile
  D529    21 FC00        C      crto05:	ld	hl,bsanf1	;zeile adressieren
  D52A                   C      crtm09	equ	$-2
  D52C    B7             C      	or	a
  D52D    C8             C      	ret	z
  D52E    11 0040        C      	ld	de,bssp1
  D52F                   C      crtm10	equ	$-2
  D531    47             C      	ld	b,a
  D532    19             C      crto06:	add	hl,de
  D533    10 FD          C      	djnz	crto06		;zeile finden
  D535    C9             C      	ret
                         C      
  D536                   C      crto07:
                         C      ; letztes Zeichen ESC-Folge
                         C      ;--------------------------
                         C       IF escpc
  D536    06 FF          C      	ld	b,0ffh
  D537                   C      crtffl	equ	$-1		;auf 00 bei "1b 5e xx"; auf 01 bei "1b 5f xx"
  D538    10 05          C      	djnz	crtnsp		;nicht 1b 5f xx
  D53A    3E 5E          C      crtfa3:	ld	a,'^'		;Spezialzeichen nicht realisierbar
  D53C    C3 D4C5        C      	jp	 crtobs
  D53F                   C      crtnsp:
  D53F    04             C      	inc	b		;1b 5e xx?
  D540    20 17          C      	jr	nz,crtnfa	;nein
  D542    CB 67          C      	bit	4,a		;invers?
  D544    28 02          C      	jr	z,crtfa1	;nein
  D546    CB C0          C      	set	0,b
  D548    CB 47          C      crtfa1:	bit	0,a		;hell?
  D54A    28 02          C      	jr	z,crtfa2	;nein
  D54C    CB C8          C      	set	1,b
  D54E    E6 2E          C      crtfa2:	and	00101110b	;wurden noch andere Funktionen verlangt?
  D550    20 E8          C      	jr	nz,crtfa3	;ja, kann die Hardware nicht
  D552    3E 84          C      	ld	a,84h
  D554    B0             C      	or	b		;Steuerzeichen auf 84..87 abbilden
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-39


  D555    4F             C      	ld	c,a
  D556    C3 D4B0        C      	jp	crto02		;umgewandeltes Steuerzeichen auswerten
  D559                   C      crtnfa:
                         C       ENDIF
                         C      ; Positionierung Spalte
                         C      	if	adm3a
                         C      	endif
                         C      
  D559    3E 3F          C      	ld	a,bssp1-1	;spalte setzen
  D55A                   C      crtm11	equ	$-1
  D55B    B9             C      	cp	c		;0 .. letzte spalte
  D55C    30 01          C      	jr	nc,crto08	;ja
  D55E    4F             C      	ld	c,a		;sonst auf letzte spalte
  D55F    06 00          C      crto08:	ld	b,0
  D561    09             C      	add	hl,bc
  D562    C9             C      	ret
                         C      
                         C      	if	adm3a
                         C      	endif
                         C      ;----------------------------
                         C      
                         C      ; ...Realisierung Sonderzeichen...
                         C      ;=================================
  D563    01 0040        C      crtcr:	ld	bc,bssp1
  D564                   C      crtm12	equ	$-2
  D566    21 FFFF        C      	ld	hl,bsend1
  D567                   C      crtm13	equ	$-2
  D569    B7             C      crto12:	or	a
  D56A    ED 42          C      	sbc	hl,bc		;suchen,bis hl < (crtcps)
  D56C    E5             C      	push	hl
  D56D    ED 52          C      	sbc	hl,de
  D56F    E1             C      	pop	hl
  D570    30 F7          C      	jr	nc,crto12	;zeilenanf. noch nicht gefunden
  D572    23             C      	inc	hl
  D573    C9             C      	ret
                         C      ;-----------------------------
  D574    21 FFBF        C      crtlf:	ld	hl,bsend1-bssp1
  D575                   C      crtm14	equ	$-2
  D577    ED 52          C      	sbc	hl,de	;bs ende (anfang letzte zeile)
  D579    DA D4D1        C      	jp	c,crto03	;aufschieben
  D57C    21 0040        C      	ld	hl,bssp1
  D57D                   C      crtm15	equ	$-2
  D57F    19             C      	add	hl,de		;naechste zeile
  D580    C9             C      	ret
                         C      ;-----------------------------
  D581                   C      crtdel:	setbs
  D581    12             C      	ld	(de),a
                         C      	setram
  D582    21 FC00        C      crtcl:	ld	hl,bsanf1	;cursor zurueck
  D583                   C      crtm16	equ	$-2
  D585    ED 52          C      	sbc	hl,de
  D587    EB             C      	ex	de,hl
  D588    C8             C      	ret	z
  D589    2B             C      	dec	hl
  D58A    C9             C      	ret
                         C      ;----------------------------
  D58B    11 FC00        C      crtbsl:	ld	de,bsanf1	;bs loeschen + home
  D58C                   C      crtm17	equ	$-2
  D58E    21 FFFF        C      crtbsr:	ld	hl,bsend1
  D58F                   C      crtm18	equ	$-2
  D591    ED 52          C      	sbc	hl,de
  D593    EB             C      	ex	de,hl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-40


                         C      	setbs
  D594    77             C      	ld	(hl),a
                         C      	setram
  D595    C8             C      	ret	z
  D596    E5             C      	push	hl
  D597    42             C      	ld	b,d	
  D598    4B             C      	ld	c,e
  D599    54             C      	ld	d,h
  D59A    5D             C      	ld	e,l
  D59B    13             C      	inc	de
                         C      	setbs
  D59C    ED B0          C      	ldir
                         C      	setram
  D59E    E1             C      	pop	hl
  D59F    C9             C        	ret
                         C      ;----------------------------
  D5A0    21 FC00        C      crthom:	ld	hl,bsanf1	;home
  D5A1                   C      crtm19	equ	$-2
  D5A3    C9             C      	ret
                         C      ;----------------------------
  D5A4                   C      crtcup:
                         C      	if	adm3a
                         C      	endif
                         C      
  D5A4    21 FC3F        C      	ld	hl,bsanf1+bssp1-1  ;eine zeile hoch
  D5A5                   C      crtm20	equ	$-2
  D5A7    ED 52          C      	sbc	hl,de		;in oberster zeile?
  D5A9    EB             C      	ex	de,hl
  D5AA    D0             C      	ret	nc		;nicht ausfuehren
  D5AB    11 FFC0        C      	ld	de,0-bssp1
  D5AC                   C      crtm21	equ	$-2
  D5AE    19             C      	add	hl,de		;zeilenlaenge abziehen
  D5AF    C9             C      	ret
                         C      ;-----------------------------
  D5B0    CD D563        C      crtzl:	call	crtcr		;zeile loeschen
  D5B3    EB             C      	ex	de,hl
  D5B4    D5             C      crtzlr:	push	de		;restzeile loeschen
  D5B5    CD D563        C      	call	crtcr
  D5B8    09             C      	add	hl,bc
  D5B9    B7             C      	or	a
  D5BA    ED 52          C      	sbc	hl,de		;zeilenrest
                         C      	setbs
  D5BC    12             C      crto13:	ld	(de),a
  D5BD    13             C      	inc	de
  D5BE    2D             C      	dec	l
  D5BF    20 FB          C      	jr	nz,crto13
                         C      	setram
  D5C1    E1             C      	pop	hl
  D5C2    C9             C      	ret
                         C      ;-----------------------------
                         C       IF inslin
  D5C3    CD D563        C      crtinl:	call	crtcr		;Insert line
  D5C6    E5             C      	push	hl		;hl auf Zeilenanfang
  D5C7    11 FF30        C      	ld	de,bsend2-bssp2+1 ;Anfang letzte Zeile
  D5C8                   C      crtm44	equ	$-2
  D5CA    EB             C      	ex	de,hl
  D5CB    B7             C      	or	a
  D5CC    ED 52          C      	sbc	hl,de		;Laenge
  D5CE    28 0A          C      	jr	z,crtil1	;letzte Zeile
  D5D0    44             C      	ld	b,h
  D5D1    4D             C      	ld	c,l
  D5D2    11 FF7F        C      	ld	de,bsend2	;Ziel
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-41


  D5D3                   C      crtm45	equ	$-2
  D5D5    21 FF2F        C      	ld	hl,bsend2-bssp2	;Quelle
  D5D6                   C      crtm46	equ	$-2
                         C      	setbs
  D5D8    ED B8          C      	lddr			;eine Zeile nach unten schieben
                         C      	setram
  D5DA    D1             C      crtil1:	pop	de
  D5DB    62             C      	ld	h,d
  D5DC    6B             C      	ld	l,e
  D5DD    18 D5          C      	jr	crtzlr		;freigewordene Zeile loeschen
                         C      ;-----------------------------
  D5DF    CD D563        C      crtdll:	call	crtcr		;Delete Line
  D5E2    E5             C      	push	hl
  D5E3    11 FF30        C      	ld	de,bsend2-bssp2+1	;Anfang letzte Zeile
  D5E4                   C      crtm47	equ	$-2
  D5E6    EB             C      	ex	de,hl
  D5E7    B7             C      	or	a
  D5E8    ED 52          C      	sbc	hl,de		;Laenge
  D5EA    28 08          C      	jr	z,crtdl1	;letzte Zeile
  D5EC    E3             C      	ex	(sp),hl
  D5ED    54             C      	ld	d,h
  D5EE    5D             C      	ld	e,l		;de auf Ziel (Zeilenanfang)
  D5EF    09             C      	add	hl,bc		;hl auf Quelle
  D5F0    C1             C      	pop	bc
  D5F1    D5             C      	push	de
                         C      	setbs
  D5F2    ED B0          C      	ldir			;eine Zeile nach oben schieben
                         C      	setram
  D5F4    21 FF30        C      crtdl1:	ld	hl,bsend2-bssp2+1
  D5F5                   C      crtm48	equ	$-2
  D5F7    54             C      	ld	d,h
  D5F8    5D             C      	ld	e,l
  D5F9    CD D5B4        C      	call	crtzlr		;letzte Zeile loeschen
  D5FC    E1             C      	pop	hl
  D5FD    C9             C      	ret
                         C      ;-----------------------------
                         C       ENDIF	;inslin
  D5FE    3E 02          C      crtesc:	ld	a,2		;escape flag setzen
  D600    32 D4AC        C      	ld	(desc),a
                         C      
                         C      	if	costu or adm3a
                         C      	endif
                         C      
  D603    C9             C      	ret
                         C      ;-----------------------------
  D604    3E 80          C      crtcrt:	ld	a,80h		;cursor an
  D606    18 01          C      	jr	crto14
                         C      ;-----------------------------
  D608    AF             C      crtcof:	xor	a		;cursor aus
  D609    32 D480        C      crto14:	ld	(dcurs),a
  D60C    C9             C      	ret
                         C      ;-----------------------------
                         C      ; Realisierung 07h
                         C      ; Achtung! Diese Routine wird aus Interruptroutine aufgerufen!
  D60D    CD D610        C      crtclk:	call	crtcl1		;Fehlerlampe umschalten
                         C      
  D610    06 19          C      crtcl1:	ld	b,25		;0.25 sec warten
  D612    CD E7B0        C      	call	wait10
                         C      				;Fehlerlampe wieder zurueck
                         C      ; Fehlerlampe umschalten
                         C      ; Reg. A, HL bleiben erhalten
  D615    F5             C      swilmp:	push	af
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-42


  D616    E5             C      	push	hl
  D617    21 0040        C      	ld	hl,lampbf
  D61A    7E             C      	ld	a,(hl)
  D61B    EE 40          C      	xor	1 shl lmperr
  D61D    77             C      	ld	(hl),a
  D61E    CD D2CA        C      	call	lampen
  D621    E1             C      	pop	hl
  D622    F1             C      	pop	af
  D623    C9             C      	ret
                         C      ;-----------------------------
                         C       IF umlaut
                         C      ; Umschalten auf 2. Zeichensatz
  D624    E5             C      crt2zs:	push	hl
  D625    21 D03D        C      	ld	hl,synflg
  D628    CB D6          C      	set	umlflg,(hl)
  D62A    E1             C      	pop	hl
  D62B    C9             C      	ret
                         C      ; Umschalten auf 1. Zeichensatz
  D62C    E5             C      crt1zs:	push	hl
  D62D    21 D03D        C      	ld	hl,synflg
  D630    CB 96          C      	res	umlflg,(hl)
  D632    E1             C      	pop	hl
  D633    C9             C      	ret
                         C       ENDIF
                         C      ;-----------------------------
                         C      
                         C       IF stpvar
                         C       IF chdvar
                         C      ;Hardcopy Bildschirm -> LST
  D634    E5             C      crthrd:	push	hl
  D635    21 FC00        C      	ld	hl,bsanf1
  D636                   C      crtm22	equ	$-2
  D638    0E 11          C      	ld	c,bszl1+1
  D639                   C      crtm23	equ	$-1
  D63A    18 30          C      	jr	crthd3		;zu Beginn neue Zeile
  D63C    06 40          C      crthd1:	ld	b,bssp1
  D63D                   C      crtm24	equ	$-1
  D63E    C5             C      crthd2:	push	bc
                         C      	setbs
  D63F    7E             C      	ld	a,(hl)
                         C      	setram
  D640    23             C      	inc	hl
  D641    E5             C      	push	hl
  D642    E6 7F          C      	and	7fh
  D644    FE 20          C      	cp	20h		;BS-Steuerzeichen?
  D646    30 1C          C      	jr	nc,crthd4	;nein
                         C       IF umlaut
  D648    21 D03D        C      	ld	hl,synflg	;Schalterbyte 
  D64B    CB 56          C      	bit	umlflg,(hl)	;Umlaute anzeigen ?
  D64D    28 13          C      	jr	z,cnuml1	;nein!
  D64F    21 D6A5        C      	ld	hl,umltb2	;Umlautcodierung ?
  D652    01 000B        C      	ld	bc,umllen
  D655    ED B1          C      	cpir
  D657    20 09          C      	jr	nz,cnuml1	;nein !
  D659    01 000C        C      	ld	bc,umllen+1	;sonst rueckkodieren
  D65C    B7             C      	or	a
  D65D    ED 42          C      	sbc	hl,bc
  D65F    7E             C      	ld	a,(hl)		;rueckkodiertes Zeichen
  D660    18 02          C      	jr	crthd4
  D662                   C      cnuml1:
                         C       ENDIF
  D662    3E 5E          C      	ld	a,'^'		;sonst Sonderzeichen
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-43


  D664    4F             C      crthd4:	ld	c,a
  D665    CD D00F        C      	call	BIOS0F		;LIST
  D668    E1             C      	pop	hl
  D669    C1             C      	pop	bc
  D66A    10 D2          C      	djnz	crthd2		;bis Zeilenende
  D66C    C5             C      crthd3:	push	bc
  D66D    E5             C      	push	hl
  D66E    0E 0D          C      	ld	c,0dh
  D670    CD D00F        C      	call	BIOS0F
  D673    0E 0A          C      	ld	c,0ah
  D675    CD D00F        C      	call	BIOS0F
  D678    E1             C      	pop	hl
  D679    C1             C      	pop	bc
  D67A    0D             C      	dec	c		;Bildschirmende?
  D67B    20 BF          C      	jr	nz,crthd1	;nein
  D67D    E1             C      	pop	hl
  D67E    C9             C      	ret
                         C       ENDIF
                         C       ENDIF	;stpvar
                         C      
                         C       IF umlaut
                         C      ; Umlaute umcodieren fuer Anzeige auf BAB1/BAB2 (Sonder-PROM)
  D67F                   C      crtuml:	
  D67F    E5             C      	push 	hl		;retten wegen evtl. ext. Verwendung
  D680    C5             C      	push 	bc
  D681    21 D03D        C      	ld	hl,synflg	;Schalterbyte
  D684    CB 56          C      	bit	umlflg,(hl)	;Umlaute anzeigen ?
  D686    28 0F          C      	jr	z,umlcn1	;nein !
  D688    21 D69A        C      	ld 	hl,umltb1
  D68B    01 000B        C      	ld 	bc,umllen
  D68E    ED B1          C      	cpir			;in Tabelle suchen
  D690    20 05          C      	jr	nz,umlcn1	;nicht gefunden
  D692    01 000A        C      	ld	bc,umllen-1	;wegen cpir
  D695    09             C      	add 	hl,bc
  D696    7E             C      	ld	a,(hl)		;umcodieren
  D697    C1             C      umlcn1:	pop	bc
  D698    E1             C      	pop	hl
  D699    C9             C      	ret
                         C      
                         C      ;------------------------------
                         C      ; Umcodiertabelle fuer Umlautumcodierung
                         C       IF zsuml ;auf freie 7023/24-Steuerzeichen (IH Mittweida, Koll. Geiler)
                         C      ;		Ae  Oe  Ue  ae  oe  ue  sz  **2 **3 Par my
  D69A    5B 5C 5D 7B    C      umltb1:db	5bh,5ch,5dh,7bh,7ch,7dh,7eh,3ch,3eh,40h,5eh
  D69E    7C 7D 7E 3C    C      
  D6A2    3E 40 5E       C      
  D6A5    15 16 17 1C    C      umltb2:db	15h,16h,17h,1ch,1dh,1eh,1fh,10h,12h,14h,18h
  D6A9    1D 1E 1F 10    C      
  D6AD    12 14 18       C      
  000B                   C      umllen	equ	umltb2-umltb1
                         C       ENDIF
                         C       IF zsibm ;auf 00..1f erweiterter IBM-Zeichensatz
                         C       ENDIF	
                         C       ENDIF	
                         C      
                         C      ; Arbeitszellen
                         C      ;==============
                         C      
  D6B0    00             C      crtcch:	db	0		;direkt auszugebendes BS-Zeichen
                         C       if crt eq dsy5
                         C       endif
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-44


                         C      ; Tabelle der Sonderzeichen, SCP kompatibel!
                         C      ;==========================================
                         C      
  D6B1                   C      dszta:	
  D6B1    00             C      	db	00h	;nop
  D6B2    01             C      	db	01h	;home
  D6B3    02             C      	db	02h	;(auch 82h) cursor an
  D6B4    03             C      	db	03h	;(auch 83h) cursor aus
  D6B5    04             C      	db	04h	;(auch 84h) normal, nicht inv.
  D6B6    05             C      	db	05h	;(auch 85h) normal,       inv.
  D6B7    06             C      	db	06h	;(auch 86h) hell  , nicht inv.
                         C      ;			 (nur  87h) hell  ,       inv.
  D6B8    07             C      	db	07h	;bell (akustisches zeichen)
  D6B9    08             C      	db	08h	;cursor zurueck
  D6BA    0A             C      	db	0ah	;LF
  D6BB    0C             C      	db	0ch	;bs loeschen, cursor links oben
  D6BC    0D             C      	db	0dh	;CR
                         C       if umlaut
  D6BD    0E             C      	db	0eh	;umschalten auf 2. Zeichensatz
  D6BE    0F             C      	db	0fh	;umschalten auf 1. Zeichensatz
                         C       endif
  D6BF    14             C      	db	14h	;rest bs loeschen
  D6C0    15             C      	db	15h	;cursor vorwaerts
  D6C1    16             C      	db	16h	;rest der zeile loeschen
                         C       IF inslin
  D6C2    17             C      	db	17h	;Insert Line
                         C       ENDIF
  D6C3    18             C      	db	18h	;zeile loeschen, cursor an zeilanf.
                         C       IF inslin
  D6C4    19             C      	db	19h	;Delete Line
                         C       ENDIF
  D6C5    1A             C      	db	1ah	;eine zeile hoch
                         C      			;bei ADM3a wie 0ch
  D6C6    1B             C      	db	1bh	;escape
                         C      ;		1b zeile+80h spalte+80h		Kursor posit. SCP
                         C      ;		1b zeile+00h spalte+00h		geht auch bei CP/A
                         C      ;		1b '='/'Y' zeile+20h spalte+20h	Kursor posit. bei ADM3A
                         C      ;		1b 5e xx	Feldattribut setzen (SCP1715 fuer 8275-Contr.)
                         C      ;			mit xx= 01urggbh
                         C      ;				  u		unterstreichen,
                         C      ;				   r		invers,
                         C      ;				    gg		Zeichengenerator-Umschaltung,
                         C      ;				      b		blinken,
                         C      ;				       h	heller 
                         C      ;		1b 5f xx	Spezialzeichen setzen (SCP1715 fuer 8275)
                         C      ;			mit xx= 01ssssbh
                         C      ;				  ssss		Zeichencode (1100 Sonderfkt)
                         C      ;				      b		blinken des Sonderzeichens
                         C      ;				       h	heller des Sonderzeichens
                         C      	if	adm3a
                         C      	endif
                         C       if crt eq dsy5
                         C       endif
  D6C7    7F             C      	db	7fh	;delete
  D6C8    87             C      	db	87h	;(nicht 07h) hell  ,      inv.
  0018                   C       dsztal	equ	$-dszta	;Tabellenlaenge
                         C      
                         C      ; Reaktionsroutinen fuer Sonderzeichen
                         C      
  D6C9    D511           C      	dw	crtnop	;00
  D6CB    D5A0           C      	dw	crthom	;01
  D6CD    D604           C      	dw	crtcrt	;02/82
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-45


  D6CF    D608           C      	dw	crtcof	;03/83
  D6D1    D4EA           C      	dw	crto84	;04/84
  D6D3    D4EA           C      	dw	crto85	;05/85
  D6D5    D4EA           C      	dw	crto86	;06/86
  D6D7    D60D           C      	dw	crtclk	;07
  D6D9    D582           C      	dw	crtcl	;08
  D6DB    D574           C      	dw	crtlf	;0A
  D6DD    D58B           C      	dw	crtbsl	;0C
  D6DF    D563           C      	dw	crtcr	;0D
                         C       if umlaut
  D6E1    D624           C      	dw	crt2zs	;0E
  D6E3    D62C           C      	dw	crt1zs	;0F
                         C       endif
  D6E5    D58E           C      	dw	crtbsr	;14
  D6E7    D4C7           C      	dw	crtcur	;15
  D6E9    D5B4           C      	dw	crtzlr	;16
                         C       IF inslin
  D6EB    D5C3           C      	dw	crtinl	;17
                         C       ENDIF
  D6ED    D5B0           C      	dw	crtzl	;18
                         C       IF inslin
  D6EF    D5DF           C      	dw	crtdll	;19
                         C       ENDIF
  D6F1    D5A4           C      	dw	crtcup	;1A
  D6F3    D5FE           C      	dw	crtesc	;1B
                         C      	if	adm3a
                         C      	endif
                         C       if crt eq dsy5
                         C       endif
  D6F5    D581           C      	dw	crtdel	;7F
  D6F7    D4EA           C      	dw	crto87	;87
  D6F9                   C      dswe 	equ	$	;tabellenende
                         C      
                                
                                 IF chdvar
                         C      	include BIOSCHD
                         C      ;**************************************************************
                         C      ;	zeichenorientierte Geraete
                         C      ; Aenderungen:
                         C      ; Fehlerkorrektur UC1:-Treiber
                         C      ; - getrennter Status Sender/Empf.
                         C      ; - Verwaltung des DTR-Bits auf Empf.seite
                         C      ; - UC1: arbeitet empfangsseitig interruptgetrieben
                         C      ; - Einfuehrung eines UC1:-Puffers als Verlaengerung des SIO-Puffers
                         C      ; - bei E/A-Fehler (Drucker nicht bereit) warten auf Bestaetigung,
                         C      ;   moegliche Reaktion ^C, I(gnore device) oder R(etry)
                         C      ; 29.09.88
                         C      ; - beide Bahnen parallel wird zurueckgesetzt, wenn linke oder rechte
                         C      ;   Bahn ausgewaehlt wird
                         C      ; 04.04.89
                         C      ; - zeichenweise Geraete werden bei Warmstart nicht neu initialisiert,
                         C      ;   nur beim Betaetigen der Taste "Synchronisieren"
                         C      ; 06.07.89
                         C      ; - bei DTR mit/ohne Warten auf Senderegister leer
                         C      ; 15.09.89
                         C      ; - wegen Drucker 1152.257 TimeOut auf nicht-Bereitschaft von 30 s auf 2 min
                         C      ;**************************************************************
                         C      
                         C       if1
                         C       endif ; if1
                         C      
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-46


                         C      ; Ausgabe
                         C      ;~~~~~~~~
                         C      ; TTY:
                         C      ;=====
                         C       if	iobtty
  D6F9    DD 21 D797     C      ttyo:	ld	ix,lsttty
  D6FD    18 0C          C      	jr	lsto
                         C       endif
                         C      
                         C      ; LPT:
                         C      ;=====
                         C       if	ioblpt
  D6FF    DD 21 D7B4     C      lpto:	ld	ix,lstlpt
  D703    18 06          C      	jr	lsto
                         C       endif
                         C      
                         C      ; UC1:
                         C      ;=====
                         C       if	iobuc1
  D705    DD 21 D7D1     C      uc1o:	ld	ix,lstuc1
  D709    18 00          C      	jr	lstoch		;nicht 2 Bahn Zeichen interpr.
                         C       endif
                         C      
  D70B                   C      lsto:
  D70B                   C      listi:	;interner Aufruf lsto mit gestelltem IX
                         C       IF l2bahn
                         C       ENDIF
                         C      
                         C      ; Einzelzeichenausgabe Reg. C
                         C      ;-----------------------------
  D70B                   C      lstoch:
  D70B    DD CB 00 4E    C      	bit	1,(ix+ltpst)	;senderseitig blockiert?
  D70F    C0             C      	ret	nz		;ja, Ausgabe ignorieren
  D710    C5             C      	push	bc		;retten Zeichen in C
  D711    0E 78          C      loutws:	ld	c,120		;max. Wartezeit in Sek. auf ready
  D713    06 64          C      loutw1:	ld	b,100		;100*10ms warten
  D715    C5             C      loutwt:	push	bc
  D716    CD D77B        C      	CALL	lststi		;Status holen
  D719    20 16          C      	jr	nz,loutwf	;ist frei
  D71B    06 01          C      	ld	b,1
  D71D    CD E7B0        C      	call	wait10		;Warten 10 ms
  D720    C1             C      	pop	bc
  D721    10 F2          C      	djnz	loutwt		;weiter warten?
  D723    0D             C      	dec	c		;weitere Sekunde warten?
  D724    20 ED          C      	jr	nz,loutw1	;ja
                         C       IF errvar
  D726    CD D73B        C      	call	spioer		;Fehlermeldung
  D729    20 E6          C      	jr	nz,loutws	;Wiederholung
                         C       ENDIF
  D72B    C1             C      	pop	bc
  D72C    DD CB 00 CE    C      	set	1,(ix+ltpst)	;Sender blockiert
  D730    C9             C      	ret			;folgende Ausgaben werden ignor.
  D731    C1             C      loutwf:	pop	bc
  D732    C1             C      	pop	bc
  D733    79             C      	ld	a,c		;auszugebendes Zeichen nach A
  D734    DD 6E 04       C      	ld	l,(ix+ltpo)
  D737    DD 66 05       C      	ld	h,(ix+ltpo+1)
  D73A    E9             C      	jp	(hl)
                         C      
                         C       IF errvar
  D73B    DD 7E 02       C      spioer:	ld	a,(ix+ltpsd)	;Daten-Port-Adresse
  D73E    11 D75C        C      	ld	de,louttp
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-47


  D741    CD E7BF        C      	call	mrecoa		;in Text
  D744    21 D75A        C      	ld	hl,loutto
  D747    CD E7A4        C      	call	biosms
  D74A    CD D1AE        C      	call	kbdbcl
  D74D    CD E66F        C      	call	conin
  D750    CB AF          C      	res	5,a
  D752    FE 03          C      	cp	'C' and 1fh	;^C ?
  D754    CA 0000        C      	jp	z,0		;ja, Abbruch
  D757    FE 49          C      	cp	'I'		;ret z: 'I'; ret nz: 'R'
  D759    C9             C      	ret
                         C      
  D75A                   C      loutto:
                         C       IF cpastz
                         C       ELSE
  D75A    0D 0A          C      	db	0dh,0ah
                         C       ENDIF
  D75C    58 58 68 20    C      louttp:	db	'XXh Fehler ^C/I/R'
  D760    46 65 68 6C    C      
  D764    65 72 20 5E    C      
  D768    43 2F 49 2F    C      
  D76C    52             C      
                         C       IF cpastz
                         C       ELSE
  D76D    07 00          C      	db	07h,0
                         C       ENDIF
                         C       ENDIF	;errvar
                         C      
                         C      ;-----------------------
                         C      
                         C      
                         C      ; Status
                         C      ;-------
                         C      ; o A=0, ret z	: Ausgabe besetzt
                         C      ; o A=ff,ret nz	: Ausgabe frei
                         C      
                         C      ; TTY:
                         C      ;=====
                         C       if	iobtty
  D76F    DD 21 D797     C      ttyst:	ld	ix,lsttty
  D773    18 06          C      	jr	lstst
                         C       endif
                         C      
                         C      ; LPT
                         C      ;====
                         C       if	ioblpt
  D775    DD 21 D7B4     C      lptst:	ld	ix,lstlpt
  D779    18 00          C      	jr	lstst
                         C       endif
                         C      
                         C       if iobuc1
                         C       endif
                         C      
  D77B                   C      lstst:
  D77B                   C      lststi:	;interner Aufruf Sender-Status mit gestelltem IX
                         C      ; ret nz, A=FF fuer frei
                         C      ; ret z , A=00 fuer besetzt
                         C      
  D77B    DD 6E 08       C      	ld	l,(ix+ltps)
  D77E    DD 66 09       C      	ld	h,(ix+ltps+1)
  D781    E9             C      	jp	(hl)
                         C      
                         C      ;-----------------------------
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-48


                         C      
                         C      ; Zeichenempfang
                         C      ;---------------
                         C      
  D149                   C      ttyi	equ	dumi
  D149                   C      lpti	equ	dumi
                         C       if iobuc1
                         C       endif
                         C      
                         C      ;-------------------------------
                         C      
                         C      ; Alle zeichenweisen Geraete neu synchronisieren
                         C      ;-----------------------------------------------
  D782                   C      lsynch:	
  D782    AF             C      	xor	a
                         C      	if	iobtty
  D783    32 D797        C      	ld	(lsttty+ltpst),a
                         C      	endif
                         C      	if	ioblpt
  D786    32 D7B4        C      	ld	(lstlpt+ltpst),a
                         C      	endif
                         C      	if	iobuc1
  D789    32 D7D1        C      	ld	(lstuc1+ltpst),a
                         C      	endif
  D78C    C9             C      	ret
                         C      
                         C      ; Portprogrammierung
                         C      ;===================
                         C      ; i HL	^Steuertabelle, Laenge+1, Port, Bytes,...,1
  D78D                   C      portpr:
  D78D    46             C      portpz:	ld	b,(hl)		;Stringlaenge +1
  D78E    23             C      	inc	hl
  D78F    05             C      	dec	b		;Ende?
  D790    C8             C      	ret	z		;ja
  D791    4E             C      	ld	c,(hl)		;Port
  D792    23             C      	inc	hl
  D793    ED B3          C      	otir
  D795    18 F6          C      	jr	portpz
                         C      
                         C      ;Steuertabellen fuer zeichenweise arbeitende Geraete
                         C      ;===================================================
                         C      
                         C      ;Struktur:
                         C      ; fester Teil
  0000                   C      ltpst	equ	0	;Status
                         C      			;Bit  7-4 Empf.,3-0 Sender  Bedeutung, wenn =1
                         C      			;	4	0 Empfseite init./ Senderseite init.
                         C      			;	5	1      -	 / Sender blockiert
                         C      			;	7	3 Sender gestoppt/ Sender hat frei gem.
  0001                   C      ltpdc	equ	1	;DC1/DC3: zuletzt empf. Zeichen (i.a. DCx)
                         C      			;DTR:	Statusmaske (Bit 5 Kanal A, Bit 3 Kanal B),
                         C      			;	Bit 7 =1 wenn kein Wait auf Senderegister leer
  0002                   C      ltpsd	equ	2	;Portadr. Daten
  0003                   C      ltpsc	equ	3	;Portadr. Kommando/Status (noch mal in ltpini!)
                         C      
  0004                   C      ltpo	equ	4	;Adresse der Senderoutine
  0006                   C      ltpi	equ	6	;Adresse der Empfangsroutine
  0008                   C      ltps	equ	8	;Adresse der Empfangsstatus-Routine
                         C      
                         C      ; Der folgende Teil existiert nur fuer SIO-Treiber
  000A                   C      ltpw5	equ	10	;WR5:
                         C      			;DTR/RTS Bit 7,1: 11 DTR; 00 DC1/DC3
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-49


                         C      			;Bitanzahl/Byte Bit 6,5: 00 5;01 7;10 6;11 8
                         C      			;Bit 3 = 1 (Senderfreigabe)
                         C      			;Bit 0,2,4 = 0
                         C      ; Port-Initialisierung (fuer alle Treiber)
  000B                   C      ltpini	equ	11	;jeweils Byteanzahl+1; Port; Bytefolge
                         C      			;variabel lang
                         C      
                         C      			;fuer SIO-Treiber einige Erlaeuterungen:
  000C                   C      ltpcs	equ	12	;Port CTC-Sendetakt
                         C      			;Vorteiler (37h Vorteiler 256, 17h Vorteiler 16)
                         C      			;Baudrate (1=9600,2=4800,..64=150,96=100,128=75)
                         C      			;evtl. nochmal fuer Port CTC-Empf.takt
                         C      			;WR4:
                         C      			;Paritaet  in Bit 1,0: 00 ohne, 01 unger., 11 ger.
                         C      			;Stop-Bits in Bit 3,2: 01 1; 10 1,5; 11 2
                         C      			;Reserve   in Bit 5,4: 00 immer (nur fuer Synchr.mode)
                         C      			;Takt      in Bit 7,6: 00 *1, 01 *16, 10 *32, 11 *64
                         C      			;WR1:
                         C      			;Interrvektormod. in Bit 2: 0=keine Modifizierung
                         C      			;in Kanal B!! setzen
                         C      			;Empf.interr.mode Bit4,3: 00 kein Interrupt
                         C      			;			  01 bei erstem Zeichen
                         C      			;			  10 bei jedem mit Mod.
                         C      			;			  11 bei jedem ohne Mod.
                         C      			;WR3:
                         C      			;Empf.freigabe in Bit 0: 0=Empf. gesperrt; 1=Empf. frei
                         C      			;Bit 1-5:00000
                         C      			;Bitanzahl/Byte Bit 7,6:00 5;01 7;10 6;11 8
                         C      
                                 IF iobtty
  0713                          @lt	aset	iobtty
  0050                          @ld	aset	ttydat
  0051                          @ls	aset	ttysta
  000C                          @lcs	aset	ttycts
  000C                          @lcr	aset	ttyctr
  0000                          @wr1	aset	00000000b ;WR1: kein Interruptbetrieb
  0000                          @wsre	aset	00000000b ;Bit 7=0: Warten auf Senderegister leer
  D797                   C      lsttty: include BIOSCPB
                         C      ;; 07.04.89
                         C      ;; 06.07.89
                         C      ;; - Einfuehrung Bit 7 in Statusmaske DTR - =1 kein Warten Senderegister leer
  D797    00             C      	db	00H	;Status
                         C       IF ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
                         C        IF (@lt mod 10) eq 1; DTR, Treiber 1
  0008                   C      @l	aset	@wsre xor 08h	;Statusmaske DTR-Abfrage ueber DCD im Kanal B
                         C        ENDIF
                         C        IF (@lt mod 10) eq 3; DTR, Treiber 3
                         C        ENDIF
  D798    08             C      	db	@l	;DTR-Abfrage-Maske, Bit 7 Wait_Senderegister_leer-Flag
                         C       ENDIF
  D799    50             C      	db	@ld	;Port fuer Daten
  D79A    51             C      	DB	@ls	;Port fuer Status/Kommando
                         C       IF (@lt mod 10) lt 5	;;SIO ###########################################
                         C       if ((@lt mod 10) eq 0) or ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
  D79B    D7EE           C      	dw	cdsioo	;;Senden
  D79D    D149           C      	dw	cdsioi	;;Empfang
  D79F    D7F4           C      	dw	cdsios	;;Empf.Status
                         C       endif
                         C       if (@lt mod 10) eq 2
                         C       endif
  0008                   C      @l	aset	00001000b	;;DC1/3, 5 Bit
                         C       if ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-50


  008A                   C      @l	aset	@l xor 10000010b	;;DTR
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 6
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 7
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 8
  00EA                   C      @l	aset	@l xor 01100000b
                         C       endif
  D7A1    EA             C      	db	@l	;WR5
                         C      			;**Portinitialisierung**
                         C      ; CTC Sendetakt
  D7A2    03             C       	db	2+1
  D7A3    0C             C      	db	@lcs		;CTC Senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
  D7A4    17             C      	db	17h		;Vorteiler 16
                         C       ENDIF
  0001                   C      @l	aset	1 shl (((@lt mod 100)/10)-1)
                         C        if ((@lt mod 100)/10) eq 8
                         C        endif
                         C        if ((@lt mod 100)/10) eq 9
                         C        endif
  D7A5    01             C      	db	@l		;Baudrate senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
                         C      ;;; zum nachtraeglichen Patchen immer CTC Empf. generieren
                         C      ;;; auch wenn '@cls eq @clr'
                         C      ; CTC Empfangstakt
  D7A6    03             C      	db	2+1
  D7A7    0C             C      	db	@lcr		;CTC Empf.
  D7A8    17             C      	db	17h		;Vorteiler 16
  D7A9    01             C      	db	@l		;Baudrate empf.
                         C      ; SIO-Initialisierung
  D7AA    08             C      	db	7+1
  D7AB    51             C      	db	@ls		;SIO-Komm.
  D7AC    18             C      	db	18h		;WR0
  0044                   C      @l	aset	01000100b	;;Takt*16, ohne P., 1 Stbit, DTR
                         C       if (@lt mod 10) eq 2
                         C       endif
                         C        if @lt ge 10000
                         C        endif
                         C        if @lt ge 20000
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 2
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 3
                         C        endif
  D7AD    04 44          C      	db	4,@l		;WR4
  D7AF    01 00          C      	db	1,@wr1		;WR1
  0001                   C      @l	aset	00000001b	;;5 Bit, Empf.freigabe
                         C        if ((@lt mod 1000)/100) eq 6
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 7
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 8
  00C1                   C      @l	aset	@l xor 11000000b
                         C        endif
  D7B1    03 C1          C      	db	3,@l		;WR3
                         C        ENDIF	;;(cpu ne c1715) or (@ld ne kbdsci)
  D7B3    01             C      	db	1	;**Ende SIO-Initialisierung** 
                         C       ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-51


                         C      
                                 ENDIF
                                
                                 IF ioblpt
  2DBE                          @lt	aset	ioblpt
  005E                          @ld	aset	lptdat
  005F                          @ls	aset	lptsta
  0058                          @lcs	aset	lptcts
  0058                          @lcr	aset	lptctr
  0000                          @wr1	aset	00000000b ;WR1: kein Interruptbetrieb
  0000                          @wsre	aset	00000000b ;Bit 7=0: Warten auf Senderegister leer
  D7B4                   C      lstlpt: include BIOSCPB
                         C      ;; 07.04.89
                         C      ;; 06.07.89
                         C      ;; - Einfuehrung Bit 7 in Statusmaske DTR - =1 kein Warten Senderegister leer
  D7B4    00             C      	db	00H	;Status
                         C       IF ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
                         C       ELSE ;DC1/3 oder PIO
  D7B5    00             C      	db	00H	;zuletzt empfangenes Zeichen
                         C       ENDIF
  D7B6    5E             C      	db	@ld	;Port fuer Daten
  D7B7    5F             C      	DB	@ls	;Port fuer Status/Kommando
                         C       IF (@lt mod 10) lt 5	;;SIO ###########################################
                         C       if ((@lt mod 10) eq 0) or ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
  D7B8    D7EE           C      	dw	cdsioo	;;Senden
  D7BA    D149           C      	dw	cdsioi	;;Empfang
  D7BC    D7F4           C      	dw	cdsios	;;Empf.Status
                         C       endif
                         C       if (@lt mod 10) eq 2
                         C       endif
  0008                   C      @l	aset	00001000b	;;DC1/3, 5 Bit
                         C       if ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 6
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 7
  0028                   C      @l	aset	@l xor 00100000b
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 8
                         C       endif
  D7BE    28             C      	db	@l	;WR5
                         C      			;**Portinitialisierung**
                         C      ; CTC Sendetakt
  D7BF    03             C       	db	2+1
  D7C0    58             C      	db	@lcs		;CTC Senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
  D7C1    17             C      	db	17h		;Vorteiler 16
                         C       ENDIF
  0001                   C      @l	aset	1 shl (((@lt mod 100)/10)-1)
                         C        if ((@lt mod 100)/10) eq 8
                         C        endif
                         C        if ((@lt mod 100)/10) eq 9
                         C        endif
  D7C2    01             C      	db	@l		;Baudrate senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
                         C      ;;; zum nachtraeglichen Patchen immer CTC Empf. generieren
                         C      ;;; auch wenn '@cls eq @clr'
                         C      ; CTC Empfangstakt
  D7C3    03             C      	db	2+1
  D7C4    58             C      	db	@lcr		;CTC Empf.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-52


  D7C5    17             C      	db	17h		;Vorteiler 16
  D7C6    01             C      	db	@l		;Baudrate empf.
                         C      ; SIO-Initialisierung
  D7C7    08             C      	db	7+1
  D7C8    5F             C      	db	@ls		;SIO-Komm.
  D7C9    18             C      	db	18h		;WR0
  0044                   C      @l	aset	01000100b	;;Takt*16, ohne P., 1 Stbit, DTR
                         C       if (@lt mod 10) eq 2
                         C       endif
                         C        if @lt ge 10000
  0045                   C      @l	aset	@l xor 00000001b	;;ung P.
                         C        endif
                         C        if @lt ge 20000
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 2
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 3
                         C        endif
  D7CA    04 45          C      	db	4,@l		;WR4
  D7CC    01 00          C      	db	1,@wr1		;WR1
  0001                   C      @l	aset	00000001b	;;5 Bit, Empf.freigabe
                         C        if ((@lt mod 1000)/100) eq 6
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 7
  0041                   C      @l	aset	@l xor 01000000b
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 8
                         C        endif
  D7CE    03 41          C      	db	3,@l		;WR3
                         C        ENDIF	;;(cpu ne c1715) or (@ld ne kbdsci)
  D7D0    01             C      	db	1	;**Ende SIO-Initialisierung** 
                         C       ENDIF
                         C      
                                 ENDIF
                                
                                 IF iobuc1
  0713                          @lt	aset	iobuc1
  0050                          @ld	aset	uc1dat
  0051                          @ls	aset	uc1sta
  000C                          @lcs	aset	uc1cts
  000C                          @lcr	aset	uc1ctr
  0014                          @wr1	aset	00010100b ;WR1: Empfangsinterr. bei jedem Char., Intv.modif.
  0080                          @wsre	aset	10000000b ;Bit 7=1: kein Warten auf Senderegister leer
  D7D1                   C      lstuc1: include BIOSCPB
                         C      ;; 07.04.89
                         C      ;; 06.07.89
                         C      ;; - Einfuehrung Bit 7 in Statusmaske DTR - =1 kein Warten Senderegister leer
  D7D1    00             C      	db	00H	;Status
                         C       IF ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
                         C        IF (@lt mod 10) eq 1; DTR, Treiber 1
  0088                   C      @l	aset	@wsre xor 08h	;Statusmaske DTR-Abfrage ueber DCD im Kanal B
                         C        ENDIF
                         C        IF (@lt mod 10) eq 3; DTR, Treiber 3
                         C        ENDIF
  D7D2    88             C      	db	@l	;DTR-Abfrage-Maske, Bit 7 Wait_Senderegister_leer-Flag
                         C       ENDIF
  D7D3    50             C      	db	@ld	;Port fuer Daten
  D7D4    51             C      	DB	@ls	;Port fuer Status/Kommando
                         C       IF (@lt mod 10) lt 5	;;SIO ###########################################
                         C       if ((@lt mod 10) eq 0) or ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
  D7D5    D7EE           C      	dw	cdsioo	;;Senden
  D7D7    D149           C      	dw	cdsioi	;;Empfang
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-53


  D7D9    D7F4           C      	dw	cdsios	;;Empf.Status
                         C       endif
                         C       if (@lt mod 10) eq 2
                         C       endif
  0008                   C      @l	aset	00001000b	;;DC1/3, 5 Bit
                         C       if ((@lt mod 10) eq 1) or ((@lt mod 10) eq 3)
  008A                   C      @l	aset	@l xor 10000010b	;;DTR
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 6
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 7
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 8
  00EA                   C      @l	aset	@l xor 01100000b
                         C       endif
  D7DB    EA             C      	db	@l	;WR5
                         C      			;**Portinitialisierung**
                         C      ; CTC Sendetakt
  D7DC    03             C       	db	2+1
  D7DD    0C             C      	db	@lcs		;CTC Senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
  D7DE    17             C      	db	17h		;Vorteiler 16
                         C       ENDIF
  0001                   C      @l	aset	1 shl (((@lt mod 100)/10)-1)
                         C        if ((@lt mod 100)/10) eq 8
                         C        endif
                         C        if ((@lt mod 100)/10) eq 9
                         C        endif
  D7DF    01             C      	db	@l		;Baudrate senden
                         C       IF (cpu eq c1715) and (@ld eq kbdsci)	;;PC1715, SIO durch Tastatur init.!!
                         C       ELSE
                         C      ;;; zum nachtraeglichen Patchen immer CTC Empf. generieren
                         C      ;;; auch wenn '@cls eq @clr'
                         C      ; CTC Empfangstakt
  D7E0    03             C      	db	2+1
  D7E1    0C             C      	db	@lcr		;CTC Empf.
  D7E2    17             C      	db	17h		;Vorteiler 16
  D7E3    01             C      	db	@l		;Baudrate empf.
                         C      ; SIO-Initialisierung
  D7E4    08             C      	db	7+1
  D7E5    51             C      	db	@ls		;SIO-Komm.
  D7E6    18             C      	db	18h		;WR0
  0044                   C      @l	aset	01000100b	;;Takt*16, ohne P., 1 Stbit, DTR
                         C       if (@lt mod 10) eq 2
                         C       endif
                         C        if @lt ge 10000
                         C        endif
                         C        if @lt ge 20000
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 2
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 3
                         C        endif
  D7E7    04 44          C      	db	4,@l		;WR4
  D7E9    01 14          C      	db	1,@wr1		;WR1
  0001                   C      @l	aset	00000001b	;;5 Bit, Empf.freigabe
                         C        if ((@lt mod 1000)/100) eq 6
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 7
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 8
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-54


  00C1                   C      @l	aset	@l xor 11000000b
                         C        endif
  D7EB    03 C1          C      	db	3,@l		;WR3
                         C        ENDIF	;;(cpu ne c1715) or (@ld ne kbdsci)
  D7ED    01             C      	db	1	;**Ende SIO-Initialisierung** 
                         C       ENDIF
                         C      
                                 ENDIF
                                
                                  IF cdtdc1 or cdtdtr
                         C      	include BIOSCSIO
                         C      ;===================================================================
                         C      ; SIO-Treiber, DTR- und DC1/DC3-Protokoll
                         C      ;===================================================================
                         C      ;
                         C      ; Aenderungen:
                         C      ; - Statusabfrage jedesmal, auch wenn zuvor frei gemeldet
                         C      ; - Pufferueberlauf bei UC1-Puffer kontrolliert
                         C      ; - bei DC1/DC3 nach Initialisierung 7fh an Drucker und max. 30 sec auf
                         C      ;  Antwort gewartet (sonst Fehler am SD1157, wenn zu frueh gesendet wird)
                         C      ; 29.6.88:
                         C      ; - bei DC1/3 Protokoll wird neu initialisiert, wenn DC4 vom Drucker kommt
                         C      ;  (Probleme bei K6314)
                         C      ; 20.09.88
                         C      ; - Neben DTR-Statusabfrage ueber Kanal B, Bit 3 (Treiber 1, Standard)
                         C      ;  auch DTR-Statusabfrage ueber Kanal A, Bit 5 (Treiber 3) unterstuetzt
                         C      ; 23.03.89
                         C      ; - CTS-Zusammenspiel bei K6311 u.ae. funktioniert nur, wenn bis zum
                         C      ;   Verlassen aller Bits aus dem Sender gewartet wird und nicht nur auf
                         C      ;   das Freiwerden des Sendepuffers - sonst Zeichenverlust!
                         C      ; - wenn UC1 am Kanal A wird WR1 Bit2 und WR2 im Kanal B gesetzt
                         C       IF cpu eq c1715
                         C       ENDIF
                         C      ; 04.04.89
                         C      ; - nach Drucker-Init 'set 0,(ix+ltpst)' statt 'ld (ix+ltpst),11h'
                         C      ; 06.07.89
                         C      ; - wegen K6314-Problemen wird nach Initialisierung DC1 angenommen
                         C      ; - bei UC1-Kopplung ueber DTR ohne Warten auf Senderegister leer,
                         C      ;   nur Warten auf Sendepuffer leer
                         C      ;   (Aenderung 23.03.89 daher nur fuer Drucker wirksam, sonst zu langsam)
                         C      ; 15.09.89
                         C      ; - bei UC1-Kopplung ueber DC1/DC3 nicht 7fh zu Beginn gesendet, sondern DC1
                         C      ;**************************************************************************
                         C      
  D149                   C      cdsioi	equ	dumi		;keine Zeicheneingabe unterstuetzt
                         C      
                         C      ; Einzelzeichenausgabe Reg. A
  D7EE    DD 4E 02       C      cdsioo:	ld	c,(ix+ltpsd)	;Datenport
  D7F1    ED 79          C      	out	(c),a
  D7F3    C9             C      	ret
                         C      
                         C      ;------------------------------------
                         C      
                         C      ; Statusabfrage
  D7F4    DD 7E 00       C      cdsios:	ld	a,(ix+ltpst)	;Status
  D7F7    CB 4F          C      	bit	1,a		;senderseitig blockiert?
  D7F9    20 3F          C      	jr	nz,lstsr	;ja, frei rueckmelden
  D7FB    B7             C      	or	a		;initialisiert?
  D7FC    CC D861        C      	call	z,cdsins	;nein
  D7FF    DD CB 0A 7E    C      	bit	7,(ix+ltpw5)	;Prozedur DTR?
  D803    28 3A          C      	JR	Z,lstsdc	;nein
  D805    DD 4E 03       C      	ld	c,(ix+ltpsc)	;SIO Kommando
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-55


                         C       IF iobuc1
  D808    DD CB 01 7E    C      	bit	7,(ix+ltpdc)	;Warten auf Senderegister leer?
  D80C    28 0C          C      	jr	z,lstse0	;ja
  D80E    3E 10          C      	ld	a,00010000b	;Reset Ext/Status-Interrupt, Lesereg. 0
  D810    ED 79          C      	out	(c),a		;Status abspeichern
  D812    ED 78          C      	in	a,(c)		;Lesereg. 0
  D814    CB 57          C      	bit	2,a		;Sendepuffer leer?
  D816    20 0C          C      	jr	nz,lstse1	;ja
  D818    18 20          C      	jr	lstsr		;nein, Drucker besetzt
  D81A                   C      lstse0:
                         C       ENDIF
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D81A    3E 11          C      	LD	a,00010001b	;Reset Ext/Status-Interrupt, Lesereg. 1
  D81C    ED 79          C      	OUT	(C),a		;Status abspeichern
  D81E    ED 78          C      	IN	a,(C)		;Leseregister 1
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D820    CB 47          C      	bit	0,a		;alle Bits gesendet?
                         C      				; Sendepuffer frei reicht nicht, da
                         C      				; K6311 u.ae. nicht korrekt arbeiten
  D822    28 16          C      	jr	z,lstsr		;nein, Drucker besetzt
  D824    DD CB 01 5E    C      lstse1:	bit	3,(ix+ltpdc)	;Abfrage DTR ueber DCD im Kanal B?
  D828    20 06          C      	jr	nz,lstsb3	;ja
  D82A    ED 78          C      	in	a,(c)		;Leseregister 0
  D82C    CB 6F          C      	bit	5,a		;CTS?
  D82E    18 0A          C      	jr	lstsr		;nz bei ja
  D830    0C             C      lstsb3:	inc	c
  D831    0C             C      	inc	c		;auf Kanal B
  D832    3E 10          C      	LD	a,00010000b	;Reset Ext/Status-Interrupt, Lesereg. 0
  D834    ED 79          C      	out	(c),a		;DCD in RR0 Kanal B abspeichern
  D836    ED 78          C      	in	a,(c)		;Leseregister 0 des Kanal B
  D838    CB 5F          C      	bit	3,a		;DCD im Kanal B (ist DTR-Bit vom Kanal A)
                         C      ; Ausgang Senderstatus
  D83A                   C      lstsr:
  D83A    3E FF          C      lstsr1:	ld	a,0ffh
  D83C    C0             C      	ret	nz		;senderseitig frei
  D83D    3C             C      	inc	a		;A=00, ret z
  D83E    C9             C      	RET			;senderseitig besetzt
                         C      ;-----------------------
                         C      ; DC1/DC3 und XON/XOFF
  D83F    DD 4E 02       C      lstsdc:	LD	C,(ix+ltpsd)	;SIO Daten
  D842    ED 78          C      	IN	A,(C)		;Status lesen (SIO speichert letzten Status)
  D844    DD 77 01       C      	LD	(ix+ltpdc),A	;zuletzt empf. Zeichen fuer Fehlersuche merken
  D847    E6 7F          C      	and	7fh		;evtl. Paritaet ignorieren
  D849    FE 13          C      	cp	13h		;DC3?
  D84B    28 12          C      	jr	z,lstsd2	;ja, besetzt
  D84D    FE 14          C      	cp	14h		;DC4 (Status)?
  D84F    20 05          C      	jr	nz,lstsd1	;nein (DC1 angenommen)
  D851    CD D895        C      	call	cdsini		;statt Status abzuholen neu initialisieren
  D854    18 E9          C      	jr	lstsdc		;und Status neu abfragen
  D856    DD 4E 03       C      lstsd1:	ld	c,(ix+ltpsc)	;SIO Kommando
  D859    ED 78          C      	in	a,(c)
  D85B    CB 57          C      	bit	2,a		;Sendepuffer leer? (nz bei ja)
  D85D    18 DB          C      	jr	lstsr
  D85F    AF             C      lstsd2:	xor	a		;A=00, ret z
  D860    C9             C      	ret			;senderseitig besetzt
                         C      
                         C      ;-----------------------
                         C      
                         C      ; (Re-)Initialisierung
                         C      ; IX auf Steuertabelle
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-56


                         C      ; ret: C zeigt auf Kommandoport
                         C      
                         C      ; Sender initialisieren
  D861                   C      cdsins:
  D861    DD CB 00 C6    C      	set	0,(ix+ltpst)	;Sender ist initialisiert
  D865    CD D895        C      	call	cdsini
  D868    DD CB 0A 7E    C      	bit	7,(ix+ltpw5)	;Prozedur DC1/DC3?
  D86C    C0             C      	ret	nz		;nein
  D86D    41             C      	ld	b,c
  D86E    DD 4E 02       C      	ld	c,(ix+ltpsd)	;Datenport
                         C       IF iobuc1
  D871    DD CB 01 7E    C       	bit	7,(ix+ltpdc)	;Warten auf Senderegister leer?
  D875    28 06          C      	jr	z,cdsind	;ja, Drucker
  D877    3E 11          C      	ld	a,11h		;bei UC1: mit DC1/DC3-Protokoll DC1 senden
  D879    ED 79          C      	out	(c),a
  D87B    48             C      	ld	c,b
  D87C    C9             C      	ret
                         C       ENDIF
  D87D    3E 7F          C      cdsind:	ld	a,7fh		;nach Initialisierung RESET senden
  D87F    ED 79          C      	out	(c),a
  D881    48             C      	ld	c,b
  D882    11 0BB8        C      	ld	de,30*100	;max. Wartezeit ca. 30 sec (SD1157!)
  D885    ED 78          C      cdsinw:	in	a,(c)
  D887    CB 47          C      	bit	0,a		;Antwort da?
  D889    C0             C      	ret	nz		;ja
  D88A    06 01          C      	ld	b,1
  D88C    CD E7B0        C      	call	wait10		;10ms warten
  D88F    1B             C      	dec	de
  D890    7A             C      	ld	a,d
  D891    B3             C      	or	e		;max. Wartezeit abgelaufen?
  D892    20 F1          C      	jr	nz,cdsinw	;nein
  D894    C9             C      	ret			;sonst Drucker wohl nicht bereit
                         C      
                         C      
                         C      ; gem. UP fuer Sender und Empf. initialisieren
  D895                   C      cdsini:
  D895    DD E5          C      	push	ix
  D897    E1             C      	pop	hl
  D898    01 000B        C      	ld	bc,ltpini
  D89B    09             C      	add	hl,bc
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D89C    CD D78D        C      	call	portpr		;CTC, WR0, WR4, WR1, WR3
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D89F    DD 5E 0A       C      ltpow5:	LD	e,(ix+ltpw5)	;Prozedurtyp/Bitanzahl
                         C      ; Stellen Schreibregister 5
                         C      ; Reg. B,HL bleiben erhalten
  D8A2    3E 05          C      ltpot5:	ld	a,5
  D8A4    DD 4E 03       C      	ld	c,(ix+ltpsc)
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D8A7    ED 79          C      	OUT	(C),A
  D8A9    ED 59          C      	OUT	(C),e
                         C       IF cpu eq c1715 ;wegen evtl. parallelem Tastaturpolling am gleichen SIO-Kanal
                         C       ENDIF
  D8AB    C9             C      	RET
                         C      
                         C      ;-------------------------------------
                         C       if iobuc1
                         C      
                         C      ; UC1-Routinen (ausser Senden)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-57


                         C      
                         C      ; UC1: Empf.-Status
                         C      ;==================
                         C      ; o A=0, ret z	: kein Zeichen empfangen
                         C      ; o A=ff,ret nz	: Zeichen da
  D8AC    DD 21 D7D1     C      uc1st:	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
  D8B0                   C      uc1si:	;interner Aufruf mit gestelltem IX
  D8B0    DD CB 00 66    C      	bit	4,(ix+ltpst)	;initialisiert?
  D8B4    20 19          C      	jr	nz,uc1si1	;ja
  D8B6    AF             C      	xor	a
  D8B7    32 D97D        C      	ld	(uc1bfp),a	;Puffer leeren
  D8BA    CD D895        C      	call	cdsini		;Initialisierung
  D8BD    DD CB 00 E6    C      	set	4,(ix+ltpst)	;Empfaenger ist initialisiert
  D8C1    F3             C      	di
                         C       IF (uc1dat xor uc1sta) eq 01b	;Kanal-Nr ist Bit 1 (bei Buerocomp und OEM)
                         C        IF (uc1sta and 10b) eq 00b	;UC1 ist an Kanal A
  D8C2    CB C9          C      	set	1,c		;Kanal B erzwingen
                         C        ENDIF
                         C       ENDIF
  D8C4    21 D8D7        C      	ld	hl,uc1i2	;WR1,WR2 programmieren
  D8C7    06 04          C       	ld	b,uc1il
  D8C9    ED B3          C      	otir
  D8CB    FB             C      	ei
  D8CC    CD D906        C      	call	uc1ird		;DTR bzw. DC1 senden
  D8CF    3A D97D        C      uc1si1:	ld	a,(uc1bfp)	;Zeichen im Empfpuffer?
  D8D2    B7             C      	or	a
  D8D3    C8             C      	ret	z		;nein
  D8D4    3E FF          C      	ld	a,0ffh
  D8D6    C9             C      	ret
                         C      
  D8D7                   C      uc1i2: ;zusaetzliche Initialisierung fuer WR1/Bit2 und WR2 (beide nur Kanal B)
                         C       IF (uc1dat xor uc1sta) eq 01b	;Kanal-Nr ist Bit 1 (bei Buerocomp und OEM)
                         C        IF (uc1sta and 10b) eq 00b	;UC1 ist an Kanal A
  D8D7    01 04          C      	db	1,00000100b	;WR1, Kanal B: Intv.modif. setzen
                         C        ENDIF
                         C       ENDIF
  D8D9    02 D0          C      	db	2,ivsio0	;WR2, Kanal B: Interruptvektor
  0004                   C      uc1il	equ	$-uc1i2
                         C      ; UC1: empf. Zeichen an Nutzer
                         C      ;=============================
                         C      ; o A:	aeltestes empf. Zeichen
                         C      
  D8DB    DD 21 D7D1     C      uc1i:	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
                         C      
  D8DF                   C      uc1ii:	;interner Aufruf mit gestelltem IX
  D8DF    FB             C      uc1iw:	ei			;UC1:-Interrupt zulassen
  D8E0    CD D8B0        C      	call	uc1si		;Zeichen da?
  D8E3    28 FA          C      	jr	z,uc1iw		;nein ***keine Zeitueberwachung!***
  D8E5    21 D97D        C      	ld	hl,uc1bfp
  D8E8    F3             C      	di
  D8E9    4E             C      	ld	c,(hl)
  D8EA    35             C      	dec	(hl)		;Pufferlaenge -1
  D8EB    06 00          C      	ld	b,0
  D8ED    23             C      	inc	hl		;^(aeltestes Pufferzeichen)
  D8EE    7E             C      	ld	a,(hl)		;Zeichen nach A
  D8EF    11 D97F        C      	ld	de,uc1buf+1
  D8F2    EB             C      	ex	de,hl
  D8F3    ED B0          C      	ldir			;Puffer aufschieben
  D8F5    FB             C      	ei
  D8F6    DD CB 00 7E    C      	bit	7,(ix+ltpst)	;war Stopaufforderung?
  D8FA    C8             C      	ret	z		;nein
  D8FB    F5             C      	push	af		;retten Zeichen
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-58


  D8FC    3A D97D        C      	ld	a,(uc1bfp)	;Pufferbelegung
  D8FF    FE 06          C      	cp	1*uc1bfl/3	;unter dem Limit?
  D901    DC D906        C      	call	c,uc1ird	;ja, Senden wieder erlauben
  D904    F1             C      	pop	af
  D905    C9             C      	ret
                         C      
                         C      ; Empfangsbereitschaft anzeigen
  D906    DD CB 00 BE    C      uc1ird:	res	7,(ix+ltpst)
  D90A    DD CB 0A 7E    C      	bit	7,(ix+ltpw5)	;Prozedur DC1/DC3?
  D90E    C2 D89F        C      	jp	nz,ltpow5	;nein, DTR wieder setzen
  D911    3E 11          C      	ld	a,11h		;DC1 (Senden wieder erlauben)
  D913    DD 4E 02       C      	LD	C,(ix+ltpsd)	;SIO Daten
  D916    ED 79          C      	OUT	(C),A
  D918    C9             C      	ret
                         C      
                         C      ; UC1: Empf.-Interrupt
                         C      ;=====================
  D919    ED 73 E624     C      uc1rin:	ld	(intsp),sp
  D91D    31 F0F7        C      	ld	sp,intstk
  D920    F5             C      	push	af
  D921    E5             C      	push	hl
  D922    D5             C      	push	de
  D923    C5             C      	push	bc
  D924    DD E5          C      	push	ix
  D926    21 D946        C      	ld	hl,uc1rir
  D929    E5             C      	push	hl
  D92A    DD 21 D7D1     C      	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
  D92E    DD 4E 02       C      	ld	c,(ix+ltpsd)	;SIO Daten
  D931    ED 40          C      	in	b,(c)		;Zeichen lesen
  D933    21 D97D        C      	ld	hl,uc1bfp	;Pufferzeiger zum zuletzt empf. Zeichen
  D936    7E             C      	ld	a,(hl)
  D937    FE 14          C      	cp	uc1bfl		;Puffer voll?
  D939    D0             C      	ret	nc		;ja, Zeichen ignorieren
  D93A    FE 0D          C      	cp	2*uc1bfl/3	;Puffer fast voll (SIO-Empf.puffer 3 Byte!)?
  D93C    D4 D94B        C      	call	nc,uc1ri1	;ja, DC3 senden bzw. DTR wegnehmen
  D93F    34             C      	inc	(hl)		;+1
  D940    5E             C      	ld	e,(hl)
  D941    16 00          C      	ld	d,0
  D943    19             C      	add	hl,de		;naechste freie Stelle
  D944    70             C      	ld	(hl),b		;Zeichen in Puffer
  D945    C9             C      	ret
  D946    DD E1          C      uc1rir:	pop	ix
  D948    C3 E61F        C      	jp	intrbc		;fertig
                         C      
                         C      ; Stopaufforderung senden
                         C      ; B,HL bleibt erhalten
  D94B    DD CB 00 FE    C      uc1ri1:	set	7,(ix+ltpst)	;merken Stopaufforderung
  D94F    DD 5E 0A       C      	ld	e,(ix+ltpw5)
  D952    CB 7B          C      	bit	7,e		;Prozedur DC1/DC3?
  D954    28 05          C      	jr	z,uc1ri2	;ja
  D956    CB BB          C      	res	7,e		;DTR loeschen
  D958    C3 D8A2        C      	jp	ltpot5
  D95B    3E 13          C      uc1ri2:	ld	a,13h		;DC3 an Partner (Senden stopppen)
  D95D    DD 4E 02       C      	LD	C,(ix+ltpsd)	;SIO Daten
  D960    ED 79          C      	OUT	(C),A
  D962    C9             C      	ret
                         C      
                         C      ; UC1: Interrupt Empf.-Fehler (Parit., Ueberlauf, Rahmenfehler)
                         C      ;============================
  D963    ED 73 E624     C      uc1err:	ld	(intsp),sp
  D967    31 F0F7        C      	ld	sp,intstk
  D96A    F5             C      	push	af
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-59


  D96B    E5             C      	push	hl
  D96C    D5             C      	push	de
  D96D    C5             C      	push	bc
  D96E    DD E5          C      	push	ix
  D970    DD 21 D7D1     C      	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
  D974    DD 4E 03       C      	ld	c,(ix+ltpsc)	;SIO Kommando
  D977    16 30          C      	ld	d,00110000b	;Reset Fehler-Interrupt
  D979    ED 51          C      	out	(c),d
                         C      				;keine Fehlermeldung, da bei
                         C      				;Empf.ueberlauf alles noch
                         C      				;mehr verzoegert wird
  D97B    18 C9          C      	jr	uc1rir
                         C      
                         C      ; UC1: Empfangspuffer
                         C      ;====================
  D97D    00             C      uc1bfp:	db	0
  D97E                   C      uc1buf:	ds	uc1bfl,0
                         C      
                         C       endif	;uc1
                         C      
                                  ENDIF
                                  IF cdtsib
                                  ENDIF
                                  IF cdtpio
                                  ENDIF
                                  IF cdtp54
                                  ENDIF
                                  IF cdth54
                                  ENDIF
                                  IF cdtn56 or cdtp56
                                  ENDIF
                                 ENDIF
                                
                         C      	include BIOSDSK
                         C      
                         C      ;****************************************************
                         C      ;	Diskettentreiber; Umkleidung des phys. Transfers
                         C      ;	Version 04.11.88
                         C      ; Aenderungen:
                         C      ; - Jeder Fehler in Spur 0, Sektor 1 fuehrt zur Annahme von Systemspuren
                         C      ;   (A7100-System mit 5" FM und 8272-Hardware mit 128er Sektorlaenge)
                         C      ; - !!Schnittstelle fuer diskio-Aufruf neu!! (Flags neu, side zusaetzlich)
                         C      ; - Verify nach Schreiben kann laufwerksspezifisch gewaehlt werden
                         C      ; - Laufwerkskapazitaet nach phys. LW-Nr in Statuszeile
                         C      ; - Fehlerkorrektur bei KAYPRO IV fuer C128
                         C      ; 12.06.88
                         C      ; - bei stzaus in synflg keine Pflege der Statuszeile
                         C      ; 06.07.88:
                         C      ; - Spurnummer generell auf 16 bit erweitert
                         C      ; 14.10.88
                         C      ; - Generierung ohne Floppy-Laufwerke moeglich
                         C      ; 26.10.88
                         C      ; - Test der Laufwerksbereitschaft bei Select
                         C      ; 04.11.88
                         C      ; - bei 5" und 512 Sektorlaenge Dir-Groesse 0
                         C      ; 12.03.89
                         C      ; - 'ibmfrm' gestrichen, phys. Formaterkennung fuer SIOS erfolgt immer
                         C      ;****************************************************
                         C      
                         C       if1
                         C       endif
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-60


                         C      ; Laufwerksauswahl
                         C      ;=================
                         C      ; i C: Laufw. (0=A:, 1=B: ...)
                         C      ; i E: Bit 0 ist LOGIN-Bit von BDOS (=0, wenn LOGIN)
                         C      
  D992    CD E87F        C      seldsk:	call	dgetpb		;HL auf DPH stellen, IX auf DPB
  D995    C8             C      	ret	z		;Geraet ex. nicht
  D996    79             C      	ld	a,c
  D997    32 DFB6        C      	ld	(ddrive),a	;Laufwerk merken
  D99A    CB 43          C      	bit	0,e		;LOGIN von BDOS?
  D99C    C0             C      	ret	nz		;nein
                         C       if ramfl
                         C      ;###RAM-Floppy
  D99D    DD CB 0F 7E    C      	bit	dpbfnd,(ix+dpbflg)	;Diskette?
  D9A1    C0             C      	ret	nz		;nein, fertig
                         C      ;####
                         C       endif
  D9A2    E5             C      	push	hl		;^DPH merken
                         C      
                         C      	IF	dbufsz gt 7
  D9A3    21 DFAD        C      	ld	hl,dbdev
  D9A6    BE             C      	cp	(hl)		;LOGIN fuer gepuffertes Device?
  D9A7    20 07          C      	jr	nz,dselnb	;nein
  D9A9    36 FF          C      	ld	(hl),0ffh	;Puffer ist ungueltig
  D9AB    21 DFAC        C      	ld	hl,dbflg
  D9AE    CB 96          C      	res	dfbwr,(hl)	;kein veraend. Puffer auszug.!
  D9B0                   C      dselnb:
                         C      	ENDIF
                         C      
                         C       IF format
  D9B0    DD CB 0F 76    C      	bit	dpbfrm,(ix+dpbflg);Formaterkennung unterdr.?
  D9B4    28 1A          C      	jr	z,drdfrm	;nein
                         C       ENDIF
                         C      
                         C      ; Test der Laufwerks-Bereitschaft; nur dann Select Disk ok
                         C      ;---------------------------------------------------------
  D9B6    32 DF9F        C      	ld	(drddev),a	;log. LW
  D9B9    DD 6E 0D       C      	ld	l,(ix+dpbofs)
  D9BC    DD 66 0E       C      	ld	h,(ix+dpbofs+1)
  D9BF    22 DFA0        C      	ld	(drdtrk),hl	;auf Beginn des Verzeichnisses
  D9C2    21 DF9E        C      	ld	hl,drdcdb	;Positionieren ohne Fehlerbehandlung
  D9C5    CD DDA6        C      	call	dsktra
  D9C8    CA DBC5        C      	jp	z,selext	;ok
  D9CB    E1             C      	pop	hl		;^DPH wegschmeissen
  D9CC    21 0000        C      	ld	hl,0		;Select Fehler
  D9CF    C9             C      	ret
  D9D0                   C      drdfrm:
                         C      
                         C      	IF	format
                         C      ;++++++++++Automatische Format-Erkennung++++++++++
                         C      ; Reg. C zeigt auf Laufwerk
                         C      
                         C      	IF	dbufsz gt 7
  D9D0    CD DD73        C       	call	dbtrw		;Puffer freimachen
                         C      				;und auf Lesen schalten
  D9D3    21 DFC3        C      	ld	hl,dbnb
  D9D6    36 FF          C      	ld	(hl),0ffh	;Puffernummer ist ungueltig, obwohl evtl.
                         C      				;alle anderen Pufferparameter stimmen
                         C      				;(da nur 128 Bytes vom Puffer belegt sind)
                         C      	ENDIF
                         C      
  D9D8    79             C      	ld	a,c
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-61


  D9D9    32 DFA6        C      	ld	(dfrmdv),a
  D9DC    32 DFAD        C      	ld	(dbdev),a
                         C      
  D9DF    AF             C      	xor	a
  D9E0    DD 77 0F       C      	ld	(ix+dpbflg),a	;ruecksetzen alle Flags
  D9E3    DD 77 13       C      	ld	(ix+dpbsn0),a	;keine Weiter-Numm. auf Ruecks.
  D9E6    DD 77 0D       C      	ld	(ix+dpbofs),a	;keine Systemspuren
                         C      
  D9E9    32 DFA7        C      	ld	(dfrmtr),a	;Spur 0
  D9EC    32 DFAE        C      	ld	(dbtrk),a
  D9EF    32 DFAF        C      	ld	(dbtrk+1),a
  D9F2    3C             C      	inc	a
  D9F3    32 DFB0        C      	ld	(dbsec),a	;Sektor 1
  D9F6    32 DFB2        C      	ld	(dbsnb),a	;1 phys. Sektor lesen
                         C      
                         C      ; Stellen  Sektor-Translate-Tabelle 1,2,3,...
  D9F9    DD E5          C      	push	ix
  D9FB    06 1A          C      	ld	b,26		;max. Laenge der Tabelle
                         C       IF dsk8mf
  D9FD    DD CB 18 7E    C      	bit	dpbt52,(ix+dpbtyp)	;Tabelle max 52 lang?
  DA01    28 02          C      	jr	z,nd8mf		;nein
  DA03    06 34          C      	ld	b,52
  DA05                   C      nd8mf:
                         C       ENDIF
  DA05    DD 77 19       C      selstz:	ld	(ix+dpbstr),a
  DA08    DD 23          C      	inc	ix
  DA0A    3C             C      	inc	a
  DA0B    10 F8          C      	djnz	selstz
  DA0D    DD E1          C      	pop	ix
                         C      
                         C      ; Positionieren auf Spur 0 und analysieren Systemspuren
  DA0F    CD DD8B        C      	call	dsidtr		;beliebigen Sekt.Id lesen
  DA12    20 49          C      	jr	nz,selsys	;Fehler beim Lesen; Systemsp. annehmen
                         C      ;				 (z.B. SCP1700 mit 5"FM in Spur 0!!)
  DA14    7C             C      	ld	a,h
  DA15    32 DFB1        C      	ld	(dbslc),a	;setzen Spurformat fuer Sp. 0
                         C      	IF	dbufsz le 7
                         C      	ENDIF
  DA18    21 DFAC        C      	ld	hl,dbflg
                         C       IF dsk8mf
  DA1B    CB 9E          C      	res	dioffm,(hl)
  DA1D    3A DFA5        C      	ld	a,(dfrflg)	;Flag zum Lesen des Sektid.
  DA20    CB 5F          C      	bit	dioffm,a	;war dazu temporaer FM notwendig?
  DA22    28 02          C      	jr	z,nfrtfm	;nein
  DA24    CB DE          C      	set	dioffm,(hl)	;sonst fuer Datenlesen uebernehmen
  DA26                   C      nfrtfm:
                         C       ENDIF
  DA26    46             C      	ld	b,(hl)		;merken Fehlerprotokoll-Bit
  DA27    CB E6          C      	set	dfbtr,(hl)	;kein Fehlerprotokoll
  DA29    E5             C      	push	hl
  DA2A    CD DD79        C      	call	dbtran		;Lesen Spur 0, Sektor 1
  DA2D    E1             C      	pop	hl
  DA2E    70             C      	ld	(hl),b		;setzen Standard fuer Fehlerprotokoll-Bit
  DA2F    20 2C          C      	jr	nz,selsys	;Fehler, Systemspuren annehmen
  DA31    FD E5          C      	push	iy
  DA33    FD 2A DFB3     C      	ld	iy,(dbdma)
  DA37    FD 7E 00       C      	ld	a,(iy+0)	;Format-Loeschbyte
  DA3A    FE E5          C      	cp	0e5h		;leere Diskette/geloeschter Eintrag?
  DA3C    20 0A          C      	jr	nz,selsy2	;nein, weder/noch
  DA3E    FD BE 01       C      	cp	(iy+1)		;auch danach 0e5h?
  DA41    20 15          C      	jr	nz,selsy0	;nein, geloeschter Dir-Eintrag
  DA43    DD 35 0D       C      	dec	(ix+dpbofs)	;Flag: leere Disk oder leere Systemsp.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-62


  DA46    18 10          C      	jr	selsy0		;dpbofs auf 254
  DA48                   C      selsy2:
  DA48    FE 40          C      	cp	40h		;IBM-Format (SIOS-Daten-Diskette)?
  DA4A    28 0F          C      	jr	z,selsy1	;ja, 0 Systemspuren annehmen
  DA4C    FE 20          C      	cp	20h		;<=31 ? ("S"YL ist groesser!)
  DA4E    30 0B          C      	jr	nc,selsy1	;nein, kann kein Directory sein; 0 Systemsp.
                         C      ;Systemlader fuer PC1715 beginnt mit 02 oder 03
  DA50    FD 7E 20       C      	ld	a,(iy+20h)	;bei SCP1715-Systemdiskette dort 00h
                         C      				;bei MicroDos dort 10h
  DA53    FD B6 21       C      	or	(iy+21h)	;bei SCP1715-Systemdiskette dort 00h
                         C      				;bei CP/A dort Dir-Eintrag (E5 oder Filename)
  DA56    28 03          C      	jr	z,selsy1	;beides 00h, kein Directory; 0 Systemsp.
  DA58    DD 35 0D       C      selsy0:	dec	(ix+dpbofs)	;=255, wenn Directory; =254 wenn vorn leer
  DA5B                   C      selsy1:
  DA5B    FD E1          C      	pop	iy
  DA5D                   C      selsys:
                         C      
                         C      ; Analysieren Datenspur
                         C      
                         C      ; SS/DS-Analyse
  DA5D    DD 36 12 02    C      	ld	(ix+dpbstp),2	;Doppel-Step-Impulse
  DA61    3E 03          C      	ld	a,dlgint	;auf LOGIN-Spur
  DA63    CD DD88        C      	call	dsidtt		;belieb. SektId Vorderseite lesen
  DA66    20 3B          C      	jr	nz,seldle	;Fehler, unsicheres Format
  DA68    54             C      	ld	d,h		;d:=Sektorlcode, e:=Spur
                         C       IF dsk8mf
  DA69    21 DFA5        C      	ld	hl,dfrcdb
  DA6C    CB 5E          C      	bit	dioffm,(hl)	;musste FM erzwungen werden?
  DA6E    28 04          C      	jr	z,selnfm	;nein
  DA70    DD CB 0F D6    C      	set	dpbffm,(ix+dpbflg)	;sonst ist alles FM
  DA74    21 DFAC        C      selnfm:	ld	hl,dbflg
  DA77    CB 9E          C      	res	dioffm,(hl)	;loeschen fuer normalen Transfer
                         C      
                         C       ENDIF
                         C       IF dskds
  DA79    DD CB 18 46    C      	bit	dpbtds,(ix+dpbtyp)	;ist es ein DS-Laufwerk?
  DA7D    28 14          C      	jr	z,selss		;nein, SS
  DA7F    D5             C      	push	de		;merken Sektorlaengencode und Spur
  DA80    DD CB 0F EE    C      	set	dpbfds,(ix+dpbflg)
  DA84    3E 07          C      	ld	a,1+(dlgint*2)	;Rueckseite der Spur,
                         C      				;ab der Format bei SS konstant
  DA86    CD DD88        C      	call	dsidtt		;beliebigen Sekt.Id Ruecks. lesen
  DA89    7A             C      	ld	a,d		;merken side Ruecks.
  DA8A    6B             C      	ld	l,e		;h:=Sektorlcode, l:=Spur Rueckseite
  DA8B    D1             C      	pop	de		;wiederherstellen Vorderseite
  DA8C    20 05          C      	jr	nz,selss	;Fehler beim Lesen, SS
  DA8E    B7             C      	or	a
  DA8F    ED 52          C      	sbc	hl,de		;Vorder- gleich Rueckseite?
  DA91    28 04          C      	jr	z,sel48		;ja; 40 Tr/ 80 Tr unterscheiden
  DA93    DD CB 0F AE    C      selss:	res	dpbfds,(ix+dpbflg)
                         C       ENDIF
                         C      
                         C      ; 40/80 Track Analyse
  DA97    7B             C      sel48:	ld	a,e		;trk
  DA98    D6 03          C      	sub	dlgint		;waren 2 Steps richtig? 
  DA9A    28 12          C      	jr	z,seldl1	;ja
  DA9C    DD 35 12       C      	dec	(ix+dpbstp)	;Einzelstep-Impulse
  DA9F    D6 03          C      	sub	dlgint		;waere 1 Step richtig?
  DAA1    28 0B          C      	jr	z,seldl1	;ja
                         C      				;nein, unsicher
  DAA3    DD 36 10 FF    C      seldle:	ld	(ix+dpbslc),0ffh;provozieren 'BAD SECTOR'
  DAA7    21 0000        C      	ld	hl,0		;erzeugen 'SELECT' Error
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-63


  DAAA    E3             C      	ex	(sp),hl
  DAAB    C3 DBC5        C      	jp	selext
                         C      
                         C      ; DS/SS und 40/80 ist unterschieden, es fehlt Sektorlaenge
  DAAE    7A             C      seldl1:	ld	a,d
  DAAF    DD 77 10       C      	ld	(ix+dpbslc),a	;definieren Sektorlaengencode
                         C       IF	dbufsz le 7
                         C       ELSE
                         C      	IF	dbufsz lt 10	;Test, ob Disk-Puffer ausreicht
                         C      	ENDIF
  DAB2    B7             C      	or	a		;Sektorlaenge 128?
  DAB3    20 1B          C      	jr	nz,seldxl	;nein, normale Sektorfolge
                         C       ENDIF	;dbufsz gt 7
                         C       IF dsk8mf
  DAB5    DD CB 18 7E    C      	bit	dpbt52,(ix+dpbtyp)	;8" MFM?
  DAB9    28 06          C      	jr	z,seldsv	;nein
  DABB    DD CB 0F 56    C      	bit	dpbffm,(ix+dpbflg)	;als MFM betreiben?
  DABF    28 0F          C      	jr	z,seldxl	;ja, kein Sektorversatz
                         C       ENDIF
  DAC1                   C      seldsv:
                         C      ; Stellen Sektor-Translate-Tabelle 1,7,13,..
  DAC1    DD E5          C      	push	ix
  DAC3    E1             C      	pop	hl
  DAC4    01 0019        C      	ld	bc,dpbstr
  DAC7    09             C      	add	hl,bc
  DAC8    EB             C      	ex	de,hl
  DAC9    21 DF6F        C      	ld	hl,xlt
  DACC    0E 1A          C      	ld	c,26
  DACE    ED B0          C      	ldir
  DAD0                   C      seldxl:
                         C      
  DAD0    CD DED9        C      	call	dtrsla		;stellen hl entspr. Sektorlaenge
  DAD3    20 CE          C      	jr	nz,seldle	;unzulaessig
  DAD5    01 0005        C      	ld	bc,dsll		;Laenge eines Eintrags
                         C       IF disk8
  DAD8    DD CB 18 66    C      	bit	dpbt5z,(ix+dpbtyp)	;8"-LW?
  DADC    20 13          C      	jr	nz,sel5zl	;nein
  DADE    09             C      	add	hl,bc		;5" uebergehen
  DADF    09             C      	add	hl,bc
  DAE0    09             C      	add	hl,bc
  DAE1    09             C      	add	hl,bc
                         C        IF dsk8mf
  DAE2    DD CB 18 5E    C      	bit	dpbtdd,(ix+dpbtyp)	;MFM-Laufwerk?
  DAE6    28 1F          C      	jr	z,selset	;nein
  DAE8    DD CB 0F 56    C      	bit	dpbffm,(ix+dpbflg) ;als FM zu betreiben?
  DAEC    20 19          C      	jr	nz,selset	;ja
  DAEE    09             C      	add	hl,bc		;sonst auf 8" MFM Muster
                         C        ENDIF
  DAEF    18 16          C      	jr	selset		;Format-Werte setzen
  DAF1                   C      sel5zl:
                         C       ENDIF
  DAF1    DD CB 12 4E    C      	bit	1,(ix+dpbstp)	;40 Tr. auf 80er LW?
  DAF5    20 08          C      	jr	nz,seld40	;ja
  DAF7    DD 7E 16       C      	ld	a,(ix+dpbptr)	;40er LW?
  DAFA    FE 29          C      	cp	40+1
  DAFC    38 01          C      	jr	c,seld40	;ja, 40 Tr. auf 40er LW
  DAFE    09             C      	add	hl,bc		;auf 80er Format stellen
  DAFF    DD CB 0F 6E    C      seld40:	bit	dpbfds,(ix+dpbflg)	;DS?
  DB03    28 02          C      	jr	z,seldss	;nein
  DB05    09             C      	add	hl,bc		;auf DS Format
  DB06    09             C      	add	hl,bc
  DB07                   C      seldss:
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-64


  DB07                   C      selset:
                         C      ; DPB modifizieren entsprechend erkanntem Format
  DB07    4E             C      	ld	c,(hl)		;Zahl der benutzten Spuren
  DB08    DD 71 14       C      	ld	(ix+dpbtrk),c
  DB0B    23             C      	inc	hl
  DB0C    4E             C      	ld	c,(hl)		;Anzahl 128er Sektoren pro Spur
  DB0D    DD 71 00       C      	ld	(ix+dpbspt),c
  DB10    23             C      	inc	hl
  DB11    4E             C      	ld	c,(hl)		;Anzahl der Dir-Eintraege -1
  DB12    23             C      	inc	hl
  DB13    7E             C      	ld	a,(hl)		;Anzahl der Systemspuren
  DB14    CB 3F          C      	srl	a		;feste Anzahl erzwungen?
  DB16    38 28          C      	jr	c,seldof	;ja
  DB18    DD CB 0D 7E    C      	bit	7,(ix+dpbofs)	;kann Spur 0 Directory sein?
  DB1C    28 22          C      	jr	z,seldof	;nein, Standardanzahl setzen
  DB1E    DD 34 0D       C      	inc	(ix+dpbofs)	;evtl. leere Systemspur?
  DB21    28 1C          C      	jr	z,seldo0	;nein, 0 Systemspuren
  DB23    47             C      	ld	b,a		;retten Anzahl Systemspuren
  DB24    32 DFAE        C      	ld	(dbtrk),a	;einlesen evtl. moeglicher Datenbeginn
  DB27    E5             C      	push	hl
  DB28    CD DD79        C      	call	dbtran		; dauert bei falscher Spur etwas laenger
  DB2B    E1             C      	pop	hl
  DB2C    78             C      	ld	a,b
  DB2D    20 11          C      	jr	nz,seldof	;Fehler, mit Systemspuren annehmen
  DB2F    FD E5          C      	push	iy
  DB31    FD 2A DFB3     C      	ld	iy,(dbdma)
  DB35    FD 7E 0E       C      	ld	a,(iy+14)	;falls dort Dir, so Byte 14 von Dir =0
  DB38    FE E5          C      	cp	0e5h		;Daten auch leer?
  DB3A    FD E1          C      	pop	iy
  DB3C    78             C      	ld	a,b
  DB3D    20 01          C      	jr	nz,seldof	;nein, vorn liegen nichtbelegte Systemspuren
  DB3F    AF             C      seldo0:	xor	a		;sonst ohne Systemspuren
  DB40    DD 77 0D       C      seldof:	ld	(ix+dpbofs),a
  DB43    B7             C      	or	a		;0 Systemspuren?
  DB44    28 07          C      	jr	z,selddr	;ja
  DB46    79             C      	ld	a,c		;Anzahl Dir-Eintraege -1
  DB47    FE BF          C      	cp	192-1		;>=192 Dir-Eintraege ?
  DB49    38 02          C      	jr	c,selddr	;nein
  DB4B    0E 7F          C      	ld	c,128-1		;780k hat 128 Dir-Eintraege
  DB4D    DD 71 07       C      selddr:	ld	(ix+dpbdir),c
  DB50    23             C      	inc	hl
  DB51    4E             C      	ld	c,(hl)		;Abstand der Blockgroessentab.
  DB52    06 00          C      	ld	b,0
  DB54    09             C      	add	hl,bc		;auf Blockgroessentabelle
  DB55    4E             C      	ld	c,(hl)
  DB56    DD 71 02       C      	ld	(ix+dpbbls),c
  DB59    23             C      	inc	hl
  DB5A    4E             C      	ld	c,(hl)
  DB5B    DD 71 03       C      	ld	(ix+dpbblm),c
  DB5E    23             C      	inc	hl
  DB5F    4E             C      	ld	c,(hl)
  DB60    DD 71 04       C      	ld	(ix+dpbexm),c
                         C      
                         C      ; Bestimmen Zahl der abweichenden 128er-Sektoren ab Spur 0
                         C      
  DB63    AF             C      	xor	a
  DB64    32 DFA7        C      	ld	(dfrmtr),a	;ab Spur 0
                         C      		;(gleichz. Spurkorr. bei falschen Doppelstepimpulsen)
  DB67    CD DD8B        C      sf128z:	call	dsidtr		;beliebigen SektId lesen
  DB6A    20 18          C      	jr	nz,sf128e	;Fehler
  DB6C    7C             C      	ld	a,h		;Sektorlaenge
  DB6D    DD BE 10       C      	cp	(ix+dpbslc)	;gleich Disketten-Rest?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-65


  DB70    28 12          C      	jr	z,sf128e	;ja
  DB72    DD 7E 0F       C      	ld	a,(ix+dpbflg)
  DB75    E6 03          C      	and	dpbfsm		;bisherige Anzahl abweichender Spuren
  DB77    FE 03          C      	cp	dpbfsm		;Zaehler voll?
  DB79    28 09          C      	jr	z,sf128e	;ja
  DB7B    DD 34 0F       C      	inc	(ix+dpbflg)	;erhoehen abweich. Spurzahl
  DB7E    21 DFA7        C      	ld	hl,dfrmtr	;naechste (logische!) Spur
  DB81    34             C      	inc	(hl)
  DB82    18 E3          C      	jr	sf128z
  DB84                   C      sf128e:
                         C      
                         C      ; Setzen Anzahl der logischen 128er Rekords im Puffer -1
                         C      ; Es wird immer das Maximum gesetzt, dies setzt eine dichte
                         C      ; Sektorfolge beim Transfer voraus! (so in dpbstr)
                         C      
                         C      	IF	dbufsz gt 7
  DB84    DD 36 11 07    C      	ld	(ix+dpbbfm),+(1 shl (dbufsz-7))-1
                         C      	ENDIF
                         C      
                         C      ; Berechnen Speicherkapazitaet-1 in BDOS-Bloecken aus
                         C      ; ((Tracks-dpbofs)*dpbspt/(2**dpbbls))-1
  DB88    DD 6E 14       C      	ld	l,(ix+dpbtrk)
  DB8B    AF             C      	xor	a
  DB8C    67             C      	ld	h,a		;hl:=log. Spurzahl
  DB8D    DD 5E 0D       C      	ld	e,(ix+dpbofs)
  DB90    57             C      	ld	d,a		;de:=log. offset-Spurzahl
  DB91    ED 52          C      	sbc	hl,de
  DB93    EB             C      	ex	de,hl		;de:=log. Daten-Spurzahl
  DB94    6F             C      	ld	l,a		;hl:=0
  DB95    DD 46 00       C      	ld	b,(ix+dpbspt)
  DB98    19             C      dsizmz:	add	hl,de
  DB99    10 FD          C      	djnz	dsizmz		;hl:=(tracks-dpbofs)*dpbspt
  DB9B    DD 46 02       C      dsizme:	ld	b,(ix+dpbbls)
  DB9E    CB 3C          C      dsizdz:	srl	h
  DBA0    CB 1D          C      	rr	l
  DBA2    10 FA          C      	djnz	dsizdz
  DBA4    2B             C      	dec	hl
  DBA5    DD 75 05       C      	ld	(ix+dpbsiz),l
  DBA8    DD 74 06       C      	ld	(ix+dpbsiz+1),h
  DBAB    DD 7E 07       C      	ld	a,(ix+dpbdir)	;Dir-Groesse
  DBAE    3C             C      	inc	a
  DBAF    E6 FC          C      	and	0fch		;abrunden auf durch 4 teilbare Dir-Groesse
  DBB1    0F             C      	rrca
  DBB2    0F             C      	rrca			;div 4, da 4 Dir-Eintr. /Sekt.
  DBB3    DD 77 0B       C      	ld	(ix+dpbchk),a	;ist Sektorzahl = Check size
  DBB6    DD 46 02       C      	ld	b,(ix+dpbbls)	;block shift
  DBB9    0F             C      seldla:	rrca			;BDOS-Bloecke fuer Dir.
  DBBA    10 FD          C      	djnz	seldla
  DBBC    47             C      	ld	b,a
  DBBD    AF             C      	xor	a
  DBBE    37             C      seldal:	scf			;Allocation-Bits fuer Dir.
  DBBF    1F             C      	rra
  DBC0    10 FC          C      	djnz	seldal
  DBC2    DD 77 09       C      	ld	(ix+dpbalc),a
                         C      ;+++++++++++Ende automatische Formaterkennung+++++++++++++
                         C      	ENDIF	;format
                         C      
  DBC5                   C      selext:
                         C       IF cpastz
                         C       ENDIF
                         C      
  DBC5    E1             C      selexx:	pop	hl		;hl auf DPH
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-66


  DBC6    C9             C      	ret			;Return Seldsk
                         C      
                         C       IF cpastz
                         C       ENDIF
                         C      
                         C      
                         C      ; auf Spur 0 zurueck (vor jedem Dir-Zugriff)
                         C      ;===================
  DBC7                   C      home:
                         C      	IF	dbufsz gt 7
  DBC7    21 DFAC        C      	ld	hl,dbflg
  DBCA    CB 56          C      	bit	dfbwr,(hl)	;veraenderter Puffer?
  DBCC    20 05          C      	jr	nz,home1	;ja, nicht freigeben
  DBCE    3E FF          C      	ld	a,0ffh		;sonst Diskwechsel erlauben
  DBD0    32 DFAD        C      	ld	(dbdev),a	;Puffer ist nicht aktiv
                         C      	ENDIF
  DBD3    01 0000        C      home1:	ld	bc,0
                         C      ;-----------------------
                         C      
                         C      ; Einstellen Spur in Reg. BC
                         C      ;================
  DBD6                   C      settrk:
  DBD6    ED 43 DFB7     C      	ld	(dtrack),bc	;Spur merken
  DBDA    C9             C      	ret
                         C      ;-----------------------
                         C      
                         C      ; Einstellen Sektor in Reg. C
                         C      ;==================
  DBDB    79             C      setsec:	LD	A,C
  DBDC    32 DFB9        C      	LD	(dsectr),A
  DBDF    C9             C      	RET
                         C      ;-----------------------
                         C      
                         C      ; Einstellen DMA in Reg. BC
                         C      ;===============
  DBE0    ED 43 DFBC     C      setdma:	LD	(ddma),BC
  DBE4    C9             C      	RET
                         C      ;-----------------------
                         C      
                         C      ; Uebersetzung Sektornummer 
                         C      ;==========================
                         C      ; Translate-Tab-Adr. in DE, Eingangs-Sektornummer in BC,
                         C      ;			    Ausgangs-Sektornummer in HL
                         C      ; Es wird keine Translate-Tabelle benutzt, da die Sektor-
                         C      ; nummernverwaltung verallgemeinert im nicht-Standard-DPB 
                         C      ; enthalten ist (auch fuer physische Sektorlaenge <>128)
                         C      
  DBE5                   C      sectran:
  DBE5    60             C      	LD	H,B
  DBE6    69             C      	LD	L,C
  DBE7    23             C      	inc	hl		;Sektoren zaehlen in CP/A ab 1
  DBE8    C9             C      	RET
                         C      ;-----------------------
                         C      
                         C      ; Schreiben Sektor
                         C      ;=================
                         C      ; Register C (vom BDOS gestellt):
                         C      ;	=0, wenn normales write
                         C      ;	=1, wenn directory-write (sofort ausgeben)
                         C      ;	=2, wenn Beginn eines neuen Datenblocks (kein preread)
                         C      
  DBE9                   C      write:
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-67


                         C       IF @write
  DBE9    59             C      	ld	e,c		;retten Reg. C
  DBEA    3A DFB6        C      	ld	a,(ddrive)
  DBED    4F             C      	ld	c,a
  DBEE    CD E87F        C      	call	dgetpb		;ix:=dpb(ddrive)
  DBF1    28 6B          C      	jr	z,drwerr	;Geraet ex. nicht
                         C       if ramfl
                         C      ;###RAM-Floppy
  DBF3    DD CB 0F 7E    C      	bit	dpbfnd,(ix+dpbflg)	;Diskette?
  DBF7    C2 E526        C      	jp	nz,wrramf	;nein
                         C      ;###
                         C       endif
  DBFA    21 DFB5        C      	ld	hl,dflg
  DBFD    CB D6          C      	set	dfwr,(hl)	;Write-Flag setzen
                         C      
                         C      	IF	dbufsz gt 7	;gepufferte Disk E/A
  DBFF    21 DFAC        C      	ld	hl,dbflg
  DC02    CB C6          C      	set	dfbprr,(hl)	;Annahme preread notwendig
  DC04    7B             C      	ld	a,e		;A:= Write-Typ
  DC05    32 DFC4        C      	ld	(dwrtyp),a	;merken Write-Typ
  DC08    FE 02          C      	cp	2		;write to unallocated?
  DC0A    20 17          C      	jr	nz,chkuna	;nein
  DC0C    DD 7E 03       C      	ld	a,(ix+dpbblm)	;Zahl der 128-Sekt. im Block -1
  DC0F    3C             C      	inc	a
  DC10    32 DFBE        C      	ld	(unacnt),a	;fuer diese Sekt. kein preread
  DC13    21 DFBF        C      	ld	hl,unadev
  DC16    71             C      	ld	(hl),c
  DC17    2A DFB7        C      	ld	hl,(dtrack)
  DC1A    22 DFC0        C      	ld	(unatrk),hl
  DC1D    3A DFB9        C      	ld	a,(dsectr)
  DC20    32 DFC2        C      	ld	(unasec),a
  DC23    21 DFBE        C      chkuna:	ld	hl,unacnt
  DC26    7E             C      	ld	a,(hl)
  DC27    B7             C      	or	a		;noch nicht geschr. Sekt. da?
  DC28    28 56          C      	jr	z,alloc		;nein
  DC2A    3D             C      	dec	a		;sonst Restzahl -1
  DC2B    77             C      	ld	(hl),a
  DC2C    23             C      	inc	hl
  DC2D    79             C      	ld	a,c
  DC2E    BE             C      	cp	(hl)		;gleiches Geraet?
  DC2F    20 4F          C      	jr	nz,alloc	;nein
  DC31    23             C      	inc	hl
  DC32    3A DFB7        C      	ld	a,(dtrack)
  DC35    BE             C      	cp	(hl)		;gleiche Spur?
  DC36    20 48          C      	jr	nz,alloc	;nein
  DC38    23             C      	inc	hl
  DC39    3A DFB8        C      	ld	a,(dtrack+1)
  DC3C    BE             C      	cp	(hl)
  DC3D    20 41          C      	jr	nz,alloc
  DC3F    23             C      	inc	hl
  DC40    3A DFB9        C      	ld	a,(dsectr)
  DC43    BE             C      	cp	(hl)		;gleicher Sektor?
  DC44    20 3A          C      	jr	nz,alloc	;nein
                         C      ; Vorbereiten naechsten unalloc write-Aufruf
  DC46    DD BE 00       C      	cp	(ix+dpbspt)	;neue Spur?
  DC49    38 0A          C      	jr	c,unatr1	;nein
  DC4B    2B             C      	dec	hl
  DC4C    56             C      	ld	d,(hl)
  DC4D    2B             C      	dec	hl
  DC4E    5E             C      	ld	e,(hl)
  DC4F    13             C      	inc	de		;unatrk +1
  DC50    73             C      	ld	(hl),e
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-68


  DC51    23             C      	inc	hl
  DC52    72             C      	ld	(hl),d
  DC53    23             C      	inc	hl
  DC54    AF             C      	xor	a		;Sektor auf Spuranfang
  DC55    3C             C      unatr1:	inc	a		;naechster Sektor
  DC56    77             C      	ld	(hl),a
  DC57    21 DFAC        C      	ld	hl,dbflg
  DC5A    CB 86          C      	res	dfbprr,(hl)	;anzeigen kein preread notw.
                         C      	ENDIF
  DC5C    18 26          C      	jr	drw
                         C      
                         C       ENDIF ;@write
                         C      
                         C      ; Abbruch read/write mit E/A-Fehler
  DC5E    3E 01          C      drwerr:	ld	a,1
  DC60    C9             C      	ret
                         C      
                         C      ; Lesen Sektor
                         C      ;=============
                         C      
  DC61                   C      read:
  DC61    3A DFB6        C      	ld	a,(ddrive)
  DC64    4F             C      	ld	c,a
  DC65    CD E87F        C      	call	dgetpb		;ix:=dpb(ddrive)
  DC68    28 F4          C      	jr	z,drwerr	;Geraet ex. nicht
                         C       if ramfl
                         C      ;###RAM-Floppy
  DC6A    DD CB 0F 7E    C      	bit	dpbfnd,(ix+dpbflg)	;Diskette?
  DC6E    C2 E549        C      	jp	nz,rdramf	;nein
                         C      ;###
                         C       endif
  DC71    21 DFB5        C      	ld	hl,dflg
  DC74    CB 96          C      	res	dfwr,(hl)	;Lesen anzeigen
                         C      
                         C       IF dbufsz gt 7
  DC76    21 DFAC        C      	ld	hl,dbflg
  DC79    CB C6          C      	set	dfbprr,(hl)	;preread notwendig
  DC7B    3E 02          C      	ld	a,2
  DC7D    32 DFC4        C      	ld	(dwrtyp),a
                         C      
  DC80                   C      alloc:
                         C        IF @write
  DC80    AF             C      	xor	a
  DC81    32 DFBE        C      	ld	(unacnt),a	;Ende unalloc
                         C        ENDIF
                         C      
                         C       ENDIF
                         C      
                         C      ; gemeinsamer Zweig read/write Floppy
                         C      ;------------------------------------
                         C      
  DC84    3A DFB9        C      drw:	ld	a,(dsectr)	;Sektornummer in 1..dpbspt ?
  DC87    3D             C      	dec	a		;ab 0 zaehlen
  DC88    FA DC5E        C      	jp	m,drwerr	;<0, Fehler
  DC8B    DD BE 00       C      	cp	(ix+dpbspt)	;<dpbspt?
  DC8E    30 CE          C      	jr	nc,drwerr	;nein, Fehler
                         C       IF dbufsz gt 7
  DC90    47             C      	ld	b,a		;retten dsectr-1
                         C       ENDIF
  DC91    DD 7E 0F       C      	ld	a,(ix+dpbflg)
  DC94    E6 03          C      	and	dpbfsm		;Anzahl der abweich. 128er Spuren
  DC96    5F             C      	ld	e,a
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-69


  DC97    16 00          C      	ld	d,0
  DC99    2A DFB7        C      	ld	hl,(dtrack)	;verlangte Spur
  DC9C    B7             C      	or	a
  DC9D    ED 52          C      	sbc	hl,de		;im abweichenden Spurformat?
  DC9F    DA DDA3        C      	jp	c,drwsec	;ja, Sektorlaenge 128
                         C      
                         C       IF dbufsz gt 7	;gepufferte Disk E/A
                         C       IF dbufsz lt 12 ;<2**12 =4K Puffer
  DCA2    DD 7E 10       C      	ld	a,(ix+dpbslc)	;phys. Sektorlaenge 128?
  DCA5    B7             C      	or	a		;d.h. mit Sektorversatz?
  DCA6    CA DDA3        C      	jp	z,drwsec	;ja, keine Pufferung sinnvoll
                         C       ENDIF
  DCA9    78             C      	ld	a,b
  DCAA    DD 56 11       C      	ld	d,(ix+dpbbfm)	;Puffermaske
  DCAD    A2             C      	and	d		;rel. Sekt.nr. des BDOS-Blocks zum Puff.anf.
  DCAE    F5             C      	push	af		;merken fuer move
  DCAF    A8             C      	xor	b		;a ist Sektornr. des Puff.anf.
  DCB0    CB 3F          C      drwbnr:	srl	a		;ermitteln Puffernr in Spur
  DCB2    CB 1A          C      	rr	d		;noch Bits in Puffermaske?
  DCB4    20 FA          C      	jr	nz,drwbnr	;ja
                         C      ; Test, ob dieser Puffer da ist
  DCB6    F5             C      	push	af		;merken Puffernummer
  DCB7    21 DFC3        C      	ld	hl,dbnb
  DCBA    BE             C      	cp	(hl)		;richtige Puffernummer?
  DCBB    20 12          C      	jr	nz,dbn		;nein
  DCBD    2A DFB7        C      	ld	hl,(dtrack)	;geforderte Spur
  DCC0    ED 5B DFAE     C      	ld	de,(dbtrk)
  DCC4    B7             C      	or	a
  DCC5    ED 52          C      	sbc	hl,de		;richtige Spur?
  DCC7    20 06          C      	jr	nz,dbn
  DCC9    3A DFAD        C      	ld	a,(dbdev)	;zum Puffer gehoeriges Geraet
  DCCC    B9             C      	cp	c		;richtiges Geraet?
  DCCD    28 6C          C      	jr	z,dbmat		;ja, Sektor steht im Puffer
                         C      
  DCCF    C5             C      dbn:	push	bc		;retten ddrive
  DCD0    CD DD73        C      	call	dbtrw		;veraenderten Puffer ausgeben
  DCD3    C1             C      	pop	bc		;c:=ddrive
  DCD4    21 DFAD        C      	ld	hl,dbdev
  DCD7    71             C      	ld	(hl),c
  DCD8    2A DFB7        C      	ld	hl,(dtrack)
  DCDB    22 DFAE        C      	ld	(dbtrk),hl
  DCDE    CD E87F        C      	call	dgetpb		;ix:=dpb(c)
  DCE1    DD 46 10       C      	ld	b,(ix+dpbslc)
  DCE4    21 DFB1        C      	ld	hl,dbslc
  DCE7    70             C      	ld	(hl),b
  DCE8    DD 7E 11       C      	ld	a,(ix+dpbbfm)	;Zahl der 128er Sektoren -1
  DCEB    3C             C      	inc	a
  DCEC    87             C      	add	a,a		;CY:=0
  DCED    04             C      	inc	b		;fuer djnz, falls dpbslc=0
  DCEE    0F             C      dbsnbz:	rrca			;Zahl der phys. Sekt. im Puff.
  DCEF    10 FD          C      	djnz	dbsnbz
  DCF1    57             C      	ld	d,a		;merken
  DCF2    AF             C      	xor	a
  DCF3    C1             C      	pop	bc		;b:=geforderte Puffernr.
  DCF4    C5             C      	push	bc
  DCF5    21 DFC3        C      	ld	hl,dbnb
  DCF8    70             C      	ld	(hl),b
  DCF9    04             C      	inc	b
  DCFA    05             C      	dec	b		;Puffernr. 0?
  DCFB    28 03          C      	jr	z,dbsec0	;ja
  DCFD    82             C      dbsecz:	add	a,d		;0. phys. Sekt. im Puffer
  DCFE    10 FD          C      	djnz	dbsecz		;=dbsnb.*Puffernr.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-70


  DD00    5F             C      dbsec0:	ld	e,a		;merken Pufferanf.-Sektor
  DD01    DD 46 10       C      	ld	b,(ix+dpbslc)
  DD04    DD 7E 00       C      	ld	a,(ix+dpbspt)
  DD07    04             C      	inc	b		;wegen djnz
  DD08    87             C      	add	a,a
  DD09    CB 3F          C      dbsecm:	srl	a		;phys. Sektoranzahl
  DD0B    10 FC          C      	djnz	dbsecm
  DD0D    93             C      	sub	e		;Restsektorzahl auf Spur
  DD0E    BA             C      	cp	d		;>= Zahl zu transferierender?
  DD0F    30 01          C      	jr	nc,dbseco	;ja
  DD11    57             C      	ld	d,a		;sonst nur Restsektorzahl
  DD12    1C             C      dbseco:	inc	e		;Sektoren zaehlen ab 1
  DD13    7B             C      	ld	a,e
  DD14    32 DFB0        C      	ld	(dbsec),a	;Sektor
  DD17    7A             C      	ld	a,d
  DD18    32 DFB2        C      	ld	(dbsnb),a	;Sektorzahl
  DD1B    21 DFAC        C      	ld	hl,dbflg
  DD1E    CB 96          C      	res	dfbwr,(hl)
                         C       if @write
  DD20    CB 46          C      	bit	dfbprr,(hl)	;muss neuer Puffer gel. werden?
  DD22    20 14          C      	jr	nz,dbprr	;ja
                         C      ; nur dann kein preread, wenn Rest BDOS-Block >= phys. Puff.
                         C      ; und Rest BDOS-Block auf Pufferanfang beginnt
  DD24    3A DFBE        C      	ld	a,(unacnt)
  DD27    DD BE 11       C      	cp	(ix+dpbbfm)	;Restzahl-1 >= Puffergr.-1 ?
  DD2A    38 0C          C      	jr	c,dbprr		;nein, preread
  DD2C    3A DFB9        C      	ld	a,(dsectr)	;Sektornr.
  DD2F    3D             C      	dec	a		;ab 0 zaehlen
  DD30    DD A6 11       C      	and	(ix+dpbbfm)	;rel. Sekt.nr. des
                         C      ;				BDOS-Blocks zum Pufferanfang
  DD33    20 03          C      	jr	nz,dbprr
  DD35    32 DFC5        C      	ld	(dberrf),a	;fehlerfrei gel. anzeigen
  DD38    C4 DD79        C      dbprr:	call	nz,dbtran	;Puffer lesen
                         C       endif
  DD3B                   C      dbmat:	
                         C      
                         C      ; Sektor in/aus Puffer holen
                         C      ;===========================
  DD3B    F1             C      	pop	af		;Puffernr. in Spur wegschm.
  DD3C    F1             C      	pop	af		;128-er Index im Puffer
  DD3D    F5             C      	push	af
  DD3E    1F             C      	rra			;Sektornb*128 berechnen
  DD3F    47             C      	ld	b,a
  DD40    0E 00          C      	ld	c,0
  DD42    CB 19          C      	rr	c
  DD44    21 F347        C      	ld	hl,dbuf
  DD47    09             C      	add	hl,bc		;Adresse im Puffer
  DD48    ED 5B DFBC     C      	ld	de,(ddma)	;Nutzer-DMA
  DD4C    3A DFB5        C      	ld	a,(dflg)
  DD4F    CB 57          C      	bit	dfwr,a		;Schreiben?
  DD51    28 09          C      	jr	z,dsmove	;nein
  DD53    3A DFAC        C      	ld	a,(dbflg)
  DD56    CB D7          C      	set	dfbwr,a		;anzeigen Puffer beschrieben
  DD58    32 DFAC        C      	ld	(dbflg),a
  DD5B    EB             C      	ex	de,hl
  DD5C    01 0080        C      dsmove:	ld	bc,128
                         C       IF dev eq cpd
                         C       ELSE
  DD5F    ED B0          C      	ldir
                         C       ENDIF
  DD61    F1             C      	pop	af		;128-Index im Puffer
  DD62    DD BE 11       C      	cp	(ix+dpbbfm)	;letzter Sektor im Puffer
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-71


  DD65    28 05          C      	jr	z,dmovew	;ja, Puffer ausgeben
  DD67    3A DFC4        C      	ld	a,(dwrtyp)
  DD6A    FE 01          C      	cp	1		;write to directory?
  DD6C    CC DD73        C      dmovew:	call	z,dbtrw		;ja, veraend. Puffer ausgeben
  DD6F    3A DFC5        C      	ld	a,(dberrf)	;Ergebnis letztes dbtran
  DD72    C9             C      	ret
                         C      
                         C      ; Schreiben Puffer, wenn notw.
                         C      ;=============================
  DD73    21 DFAC        C      dbtrw:	ld	hl,dbflg
  DD76    CB 56          C      	bit	dfbwr,(hl)	;Puffer veraendert?
  DD78    C8             C      	ret	z		;nein, Schreiben unterdruecken
                         C      	ENDIF	;dbufsz gt 7
                         C      
                         C      	IF	format or (dbufsz gt 7)
                         C      ; gemeinsamer Zweig Lesen/Schreiben Puffer
                         C      ;=========================================
  DD79                   C      dbtran:	
  DD79    21 DFAC        C      	ld	hl,dbcdb
                         C      	IF	dbufsz gt 7
  DD7C    CD DDA6        C      	call	dsktra
  DD7F    32 DFC5        C      	ld	(dberrf),a	;Fehlerflag stellen
  DD82    21 DFAC        C      	ld	hl,dbflg
  DD85    CB 96          C      	res	dfbwr,(hl)	;Puffer ist nicht beschrieben
  DD87    C9             C      	ret
                         C      	ENDIF
                         C      
                         C      	ENDIF
                         C      
                         C      	IF	format
                         C      ; Lesen beliebigen Sektor-Id.
                         C      ;===========================
  DD88    32 DFA7        C      dsidtt:	ld	(dfrmtr),a	;Eingang fuer Spur in A
  DD8B                   C      dsidtr:
  DD8B    21 DFA5        C      	ld	hl,dfrcdb
                         C       IF dsk8mf
  DD8E    CB 9E          C      	res	dioffm,(hl)	;nicht temporaer umschalten
  DD90    CD DDA6        C      	call	dsktra		;beliebigen Sektorid lesen
  DD93    C8             C      	ret	z		;ok
  DD94    DD 7E 18       C      	ld	a,(ix+dpbtyp)
  DD97    E6 18          C      	and	(1 shl dpbt5z)+(1 shl dpbtdd)	;8"/5" und FM/MFM
  DD99    EE 08          C      	xor	1 shl dpbtdd	;8" MFM ?
  DD9B    C0             C      	ret	nz		;nein, Fehler
  DD9C    21 DFA5        C      	ld	hl,dfrcdb
  DD9F    CB DE          C      	set	dioffm,(hl)	;temporaer auf FM umschalten
                         C       ENDIF
  DDA1    18 03          C      	jr	dsktra		;belieb. SektId lesen
                         C      	ENDIF
                         C      
                         C      
                         C      ; gemeinsamer Zweig Read/Write 128-Sektor einzeln
                         C      ;================================================
  DDA3                   C      drwsec:
  DDA3    21 DFB5        C      	ld	hl,dcdb
                         C      
                         C      ; interner Aufruf phys. Diskettentransfer
                         C      ;----------------------------------------
                         C      ; i HL auf CDB
  DDA6                   C      dsktra:
                         C       IF dev eq cpd
                         C       ENDIF
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-72


                         C      ;*********************************************************
                         C      ; Umkleidung des physischer Disketten-Transfers
                         C      ;*********************************************************
                         C      
                         C      ; Parameter: HL auf CDB mit folgender Struktur:
                         C      ; +0: cdbfl	;Flags	(Struktur angepasst an ft.kom)
  0000                   C      diof00	equ	0	;** frei fuer Anw. ** (frueher Verify nach Schreiben)
  0001                   C      diofid	equ	1	;fest	;=1, wenn nur Sektid. zu lesen
  0002                   C      diofwr	equ	2	;fest	;=1, wenn Schreiben
  0003                   C      dioffm	equ	3	;fest	;=1, wenn temporaer FM-Format erzwungen
  0004                   C      dioftr	equ	4		;=1, wenn keine Fehlermeldung (und -behandlg)
  0005                   C      diofhd	equ	5		;=1, wenn Kopf hochnehmen ("headup")
  0006                   C      diofps	equ	6		;=1, wenn trk,sid,sec schon physisch
  0007                   C      diofs1	equ	7	;fest	;=1, wenn Rueckseite
                         C      
                         C      ; ab hier unwichtig bei "diofhd" in cdbfl =1 (headup)
                         C      ; +1: cdbdev	;logisches Geraet 0 .. dphnb-1
                         C      ; +2: cdbtrk	;log./phys. Spur
                         C      ; +3: cdbsid	;bel./phys. Seite
                         C      ; +4: cdbsec	;log./phys. Sektor
                         C      ; +5: cdbslc	;Sektorlaengencode (0=128, 1=256, 2=512, 3=1024)
                         C      ; +6: cdbsnb	;Anz. zu uebertr. ph. Sekt. (wenn =0, so nur position.)
                         C      ; ab hier nur wichtig, wenn "diofid" in cdbfl =0:
                         C      ; +7,8: cdbdma	;Transferadresse
                         C      
                         C      ; Return, falls nicht "diofhd" in cdbfl =1:
                         C      ;	A=0 (ret z) bei fehlerfrei, sonst A=1 (ret nz) bei cdbfl, "dioftr" =0
                         C      ;	oder Returncode phys. Transfer
                         C      ;	E:=trk, D:=sid ,L:=sec, H:=len
                         C      ;	BC,IX unveraendert
                         C      
  DDA6                   C      diskio:	;Aufruf ueber Sprungvektor von BIOS-Erweiterung
  DDA6    C5             C      	push	bc
  DDA7    11 DFC6        C      	ld	de,diocdb	;CDB des Nutzers auf internen Hilfsspeicher
  DDAA    01 0009        C      	ld	bc,diocdl	;da modifiziert
  DDAD    D5             C       	push	de
                         C       IF dev eq cpd
                         C       ELSE
  DDAE    ED B0          C      	ldir
                         C       ENDIF
  DDB0    E1             C      diskii:	pop	hl		;hl auf diocdb
  DDB1    C1             C      	pop	bc
                         C      
  DDB2    CB 6E          C      	bit	diofhd,(hl)	;Kopf hochnehmen?
                         C       IF disknb ne 0
  DDB4    C2 E2A3        C      	jp	nz,headup	;ja, kein Transfer
                         C       ENDIF
  DDB7    C5             C      	push	bc
  DDB8    DD E5          C      	push	ix
  DDBA    E5             C      	push	hl
  DDBB    23             C       	inc	hl
  DDBC    4E             C      	ld	c,(hl)		;logisches Laufwerk
  DDBD    CD E87F        C      	call	dgetpb		;IX auf DPB stellen
  DDC0    E1             C      	pop	hl		;wiederherstellen hl
  DDC1    3E 44          C      	ld	a,'D'		;falls LW nicht ex.
  DDC3    CA DE96        C      	jp	z,dioert	;LW ex. nicht
                         C      
                         C       IF hdsk
                         C       ENDIF
  DDC6    CB 76          C      	bit	diofps,(hl)	;trk,sid,sec schon physisch?
  DDC8    20 6E          C      	jr	nz,diophy	;ja
                         C       IF dsk8mf
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-73


  DDCA    DD CB 18 7E    C      	bit	dpbt52,(ix+dpbtyp)	;8" MFM?
  DDCE    28 0E          C      	jr	z,drwnsp	;nein
  DDD0    DD 7E 0F       C      	ld	a,(ix+dpbflg)
  DDD3    E6 03          C      	and	dpbfsm		;Zahl der abweichenden 128er Sektoren
  DDD5    57             C      	ld	d,a
  DDD6    3A DFC8        C      	ld	a,(dioctr)	;verlangte Spur
  DDD9    BA             C      	cp	d		;im abweichenden Format?
  DDDA    30 02          C      	jr	nc,drwnsp	;nein
  DDDC    CB DE          C      	set	dioffm,(hl)	;sonst temporaer FM erzwingen
  DDDE                   C      drwnsp:
                         C       ENDIF
                         C      ; Track, Side und Sector entpsr. Diskettenformat setzen
  DDDE    23             C      	inc	hl
  DDDF    23             C      	inc	hl
  DDE0    56             C      	ld	d,(hl)		;Track
  DDE1    5A             C      	ld	e,d		;merken
  DDE2    23             C      	inc	hl
  DDE3    23             C      	inc	hl
  DDE4    4E             C      	ld	c,(hl)		;Sektornummer ab 1
  DDE5    0D             C      	dec	c		;Sektornr. ab 0
  DDE6    DD CB 0F 66    C      	bit	dpbf86,(ix+dpbflg)	;Fortsetzung Dsk. auf Ruecks.?
  DDEA    20 0C          C      	jr	nz,diots2	;ja
  DDEC    DD CB 0F 6E    C      	bit	dpbfds,(ix+dpbflg)	;ungerade Spuren auf Rueckseite?
  DDF0    28 29          C      	jr	z,diotrs	;nein, einseitig
  DDF2    CB 3A          C      	srl	d		;Spur halbieren
  DDF4    30 25          C      	jr	nc,diotrs	;gerade Spur, Vorderseite
  DDF6    18 12          C      	jr	diots1		;auf Rueckseite
  DDF8    DD 46 14       C      diots2:	ld	b,(ix+dpbtrk)	;log. Spurzahl
  DDFB    CB 38          C      	srl	b		;Spuren auf Vorderseite
  DDFD    7A             C      	ld	a,d
  DDFE    90             C      	sub	b		;Spur auf Vorderseite?
  DDFF    38 1A          C      	jr	c,diotrs	;ja, Spur in d unveraendert lassen
                         C      				;40 ->  0; 41 ->  1; ...; 79 ->  39
                         C      				;77 ->  0; 78 ->  1; ...;153 ->  76
  DE01    DD CB 0F 5E    C      	bit	dpbfsv,(ix+dpbflg)	;Ruecks. von aussen nach innen?
  DE05    20 02          C      	jr	nz,diots4	;ja
  DE07    2F             C      	cpl			;40 -> -1; 41 -> -2; ...; 79 -> -40
                         C      				;77 -> -1; 78 -> -2; ...;153 -> -77
  DE08    80             C      	add	a,b		;40 -> 39; 41 -> 38; ...; 79 ->   0
                         C      				;77 -> 76; 78 -> 75; ...;153 ->   0
  DE09    57             C      diots4:	ld	d,a
  DE0A    3A DFC6        C      diots1:	ld	a,(diocfl)
  DE0D    CB FF          C      	set	diofs1,a	;vermerken Rueckseite
  DE0F    32 DFC6        C      	ld	(diocfl),a
  DE12    DD 7E 13       C      	ld	a,(ix+dpbsn0)	;Versch. der Sektornr. auf Rueckseite
  DE15    81             C      	add	a,c		;Sektornr. evtl. weiterzaehlen
                         C      ;;;	cp	c		;Weiternummerierung auf Rueckseite?
  DE16    4F             C      	ld	c,a
                         C      ;;;	jr	nz,diotrs	;ja, dann side:=0
  DE17    3E 01          C      	ld	a,1		;side:=1
  DE19    18 01          C      	jr	diotss
  DE1B    AF             C      diotrs:	xor	a		;side:=0
  DE1C    32 DFC9        C      diotss:	ld	(diocsi),a	;phys. Seite setzen
  DE1F    7A             C      	ld	a,d
  DE20    32 DFC8        C      	ld	(dioctr),a	;phys. Spur setzen
                         C      
  DE23    7B             C      	ld	a,e		;log. Spurnr. zurueck nach A
  DE24    DD E5          C      	push	ix
  DE26    E1             C      	pop	hl
  DE27    11 0019        C      	ld	de,dpbstr	;d:=0
  DE2A    19             C      	add	hl,de
  DE2B    DD BE 0D       C      	cp	(ix+dpbofs)	;Systemspur?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-74


  DE2E    38 03          C      	jr	c,diossp	;ja, Sektornummern nicht logisch
  DE30    59             C      	ld	e,c
  DE31    19             C      	add	hl,de		;HL entspr. Index in dpbstr
  DE32    4A             C      	ld	c,d		;c:=0
  DE33    79             C      diossp:	ld	a,c		;phys. Sektornr. ab 0
  DE34    86             C      	add	a,(hl)		;+echte Sektornr.
  DE35    32 DFCA        C      	ld	(diocse),a	;phys. Sektor setzen
  DE38                   C      diophy:
                         C      
                         C      ; i ret, BC, IX im Stack
                         C      ; i cdb auf diocdb
                         C      ; i IX auf DPB
                         C      
  DE38                   C      diorty:	;interne Wiederholung diskio
  DE38    DD E5          C      	push	ix		;retten IX fuer evtl. Wiederholung
  DE3A    21 DFC6        C      	ld	hl,diocdb
  DE3D    E5             C      	push	hl
  DE3E    7E             C      	ld	a,(hl)		;side 0/1, -/FM, read/write, -/sectid l.
  DE3F    E6 8E          C       and (1 shl diofs1)+(1 shl dioffm)+(1 shl diofwr)+(1 shl diofid)
  DE41    47             C      	ld	b,a
  DE42    DD 7E 18       C      	ld	a,(ix+dpbtyp)	;5"/8", FM/MFM, 40/80, Verify nach Schreiben
  DE45    E6 78          C       and (1 shl dpbt80)+(1 shl dpbt5z)+(1 shl dpbtdd)+(1 shl dpbtwv) ;aus DPB
  DE47    A8             C      	xor	b
                         C       IF dsk8mf
  DE48    DD CB 0F 56    C      	bit	dpbffm,(ix+dpbflg)	;Diskette permanent FM?
  DE4C    28 02          C      	jr	z,dionfm	;nein
  DE4E    CB 9F          C      	res	dpbtdd,a		;erzwingen FM-Format
  DE50                   C      dionfm:
                         C       ENDIF
  DE50    CB 66          C      	bit	dioftr,(hl)	;Fehlerbehandlung unterdruecken?
  DE52    28 01          C      	jr	z,dionft	;nein
  DE54    3C             C      	inc	a
  DE55                   C      dionft:
  DE55    32 E2C0        C      	ld	(ft.kom),a	
                         C      
  DE58    23             C      	inc	hl
  DE59    DD 7E 15       C      	ld	a,(ix+dpbdnr)	;physische LW-Nr.
  DE5C    32 E2C3        C      	ld	(ft.lwn),a
                         C      
  DE5F    23             C      	inc	hl
  DE60    7E             C      	ld	a,(hl)
  DE61    32 E2C4        C      	ld	(ft.trk),a
  DE64    23             C      	inc	hl
  DE65    7E             C      	ld	a,(hl)
  DE66    32 E2C5        C      	ld	(ft.sid),a
  DE69    23             C      	inc	hl
  DE6A    7E             C      	ld	a,(hl)
  DE6B    32 E2C6        C      	ld	(ft.sec),a
  DE6E    23             C      	inc	hl
  DE6F    7E             C      	ld	a,(hl)
  DE70    32 E2C7        C      	ld	(ft.len),a
  DE73    23             C      	inc	hl
  DE74    7E             C      	ld	a,(hl)
  DE75    32 E2C8        C      	ld	(ft.anz),a
                         C      
  DE78    DD 7E 12       C      	ld	a,(ix+dpbstp)	;Anzahl der Stepimpulse
  DE7B    32 E2C9        C      	ld	(ft.stp),a
                         C      
  DE7E    DD 7E 17       C      	ld	a,(ix+dpbsti)	;Schrittzeit
  DE81    32 E2CA        C      	ld	(ft.sti),a
                         C      
  DE84    2A DFCD        C      	ld	hl,(diocad)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-75


  DE87    22 E2C1        C      	ld	(ft.adr),hl
                         C      
                         C       IF stpvar or monitor
  DE8A    CD E6DE        C      	call	delsps		;Sondertasten verbieten
                         C       ENDIF
                         C       IF hdsk
                         C       ELSE
  DE8D    CD DFCF        C      	call	floppy		;$$$ phys. Transfer $$$
                         C       ENDIF
                         C       IF stpvar or monitor
  DE90    CD E6EB        C      	call	delspr		;Sondertasten wieder erlauben
                         C       ENDIF
                         C      
  DE93    E1             C      	pop	hl		;HL wieder auf Paramfeld-Adresse
  DE94    DD E1          C      	pop	ix		;IX wieder auf DPB
                         C      
  DE96                   C      dioert:
                         C      ; Fehlerprotokoll
  DE96    CB 66          C      	bit	dioftr,(hl)	;Fehlerprotokoll und -behandlung  unterdr.?
  DE98    20 33          C      	jr	nz,dtrok	;ja
  DE9A    B7             C      	or	a		;Returncode
  DE9B    28 30          C      	jr	z,dtrok		; -> fehlerfrei
  DE9D    FE 52          C      	cp	'R'		;not ready?
  DE9F    CA DE38        C      	jp	z,diorty	;ja, Wiederholung
                         C      
                         C       IF errvar
  DEA2    32 DF8C        C      	ld	(derrcd),a	;Fehlercode
  DEA5    CB 56          C      	bit	diofwr,(hl)	;war lesen?
  DEA7    3E 52          C      	ld	a,'R'
  DEA9    28 02          C      	jr	z,derrr		;ja
  DEAB    3E 57          C      	ld	a,'W'
  DEAD    32 DF8B        C      derrr:	ld	(derrrw),a
                         C        IF dev eq cpd
                         C        ELSE
  DEB0    21 E2C4        C      	ld	hl,ft.trk	;phys. Spur
  DEB3    11 DF96        C      	ld	de,derrtr
  DEB6    CD E7BE        C      	call	mbreco
  DEB9    21 E2C5        C      	ld	hl,ft.sid	;Seite
  DEBC    CD E7BE        C      	call	mbreco
  DEBF    21 E2C6        C      	ld	hl,ft.sec	;Sektor
  DEC2    CD E7BE        C      	call	mbreco
                         C        ENDIF
  DEC5    21 DF89        C      	ld	hl,derrms
  DEC8    CD E7A4        C      	call	biosms
                         C       ENDIF
  DECB    3E 01          C       	ld	a,1		;return mit Fehler
                         C      
  DECD    B7             C      dtrok:	or	a		;stellen Z-Flag
  DECE    ED 5B E2C4     C      	ld	de,(ft.trk)	;E:=trk, D:=sid
  DED2    2A E2C6        C      	ld	hl,(ft.sec)	;L:=sec, H:=len
  DED5    DD E1          C      	pop	ix
  DED7    C1             C      	pop	bc
  DED8    C9             C      	ret
                         C      
                         C       IF	format
                         C      
                         C      ; Stellen HL entsprechend Sektorlaengencode in (A)
                         C      ;=================================================
                         C      ; ret nz bei unzulaessigem
  DED9    B7             C      dtrsla:	or	a
  DEDA    21 DEED        C      	ld	hl,dtrsl0
  DEDD    C8             C      	ret	z		;=0 (128)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-76


  DEDE    3D             C      	dec	a
  DEDF    21 DF0B        C      	ld	hl,dtrsl1	;=1 (256)
  DEE2    C8             C      	ret	z
  DEE3    3D             C      	dec	a
  DEE4    21 DF2A        C      	ld	hl,dtrsl2	;=2 (512)
  DEE7    C8             C      	ret	z
  DEE8    3D             C      	dec	a
  DEE9    21 DF48        C      	ld	hl,dtrsl3	;=3 (1024)
  DEEC    C9             C      	ret
                         C      
                         C       ENDIF
                         C      
                         C      ;************************************************
                         C      ;	Steuertabellen
                         C      ;************************************************
                         C      
                         C      
                         C       IF	format
                         C      ; Modifizierungstabellen entspr. Sektorlaenge und LW-Typ
                         C      ;-------------------------------------------------------
                         C      
                         C      ; Struktur:
                         C      
  0000                   C      dsltrk	equ	0		;benutzte Spuren
  0001                   C      dslspt	equ	dsltrk+1	;Sektoren/Spur
  0002                   C      dsldir	equ	dslspt+1	;Dir-Eintraege
  0003                   C      dsloff	equ	dsldir+1	;2*offset
                         C      				;[+Flag fuer festes offset]
  0001                   C      dslfo	equ	1		;festes offset
  0000                   C      dslvo	equ	0		;offset =0, falls Directory mgl.
  0004                   C      dslblk	equ	dsloff+1	;rel. Adr. Tab. BDOS-Blockgroesse
  0005                   C      dsll	equ	5		;Laenge eines Eintrags
                         C      
                         C      ; Reihenfolge
                         C      ; 5", 40 Tr, SS
                         C      ; 5", 80 Tr, SS
                         C      ; 5", 40 Tr, DS
                         C      ; 5", 80 Tr, DS
                         C       if	disk8
                         C      ; 8", 77 Tr, SS, SD
                         C        if dsk8mf
                         C      ; 8", 77 Tr, SS, DD
                         C        endif
                         C       endif
                         C      
                         C      ; Zur automatischen Bestimmung des Spurformats wird dasjenige
                         C      ; Format der Spur "dlgint" benutzt, alle folgenden Spuren
                         C      ; muessen das gleiche Format haben!
  0003                   C      dlgint	equ	3	;groesste Anzahl SS-Systemspuren
                         C      
                         C      ; 128
  DEED                   C      dtrsl0:	
  DEED    28 1A 3F 04    C      	db	40,26,63,2*2+dslvo,dbl1k-$	;CP/M Standard
  DEF1    75             C      
  DEF2    50 1A 7F 04    C      	db	80,26,127,2*2+dslvo,dbl2k-$
  DEF6    73             C      
  DEF7    50 1A 7F 01    C      	db	80,26,127,2*0+dslfo,dbl2k-$
  DEFB    6E             C      
  DEFC    A0 1A 7F 01    C      	db	160,26,127,2*0+dslfo,dbl2k0-$
  DF00    6C             C      
                         C      
                         C      	if	disk8
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-77


  DF01    4D 1A 3F 04    C      	db	77,26,63,2*2+dslvo,dbl1k-$	;CP/M Standard
  DF05    61             C      
                         C      	if	dsk8mf
  DF06    4D 28 7F 04    C      	db	77,40,127,2*2+dslvo,dbl2k-$
  DF0A    5F             C      
                         C      	endif
                         C      	endif
                         C      
                         C      ; 256
  DF0B                   C      dtrsl1:	
  DF0B    28 20 3F 07    C      	db	40,32,63,2*3+dslfo,dbl2k-$	;SCP Hausformat A51xx
  DF0F    5A             C      
  DF10    50 20 3F 07    C      	db	80,32,63,2*3+dslfo,dbl2k-$	;SCP
  DF14    55             C      
  DF15    50 20 7F 09    C      	db	80,32,127,2*4+dslfo,dbl2k-$
  DF19    50             C      
  DF1A    A0 20 7F 09    C      	db	160,32,127,2*4+dslfo,dbl2k0-$	;SCP Hausformat PC1715
  DF1E    4E             C      
                         C      
                         C      	if	disk8
  DF1F    4D 20 3F 07    C      	db	77,32,63,2*3+dslfo,dbl2k-$
  DF23    46             C      
                         C      	if	dsk8mf
  DF24    4D 34 7F 04    C      	db	77,52,127,2*2,dslfo,dbl2k-$
  DF28    01 40          C      
                         C      	endif
                         C      	endif
                         C      
                         C      ; 512
  DF2A                   C      dtrsl2:	
  DF2A    28 24 00 01    C      	db	40,36,0,2*0+dslfo,dbl1k-$
  DF2E    38             C      
  DF2F    50 24 00 01    C      	db	80,36,0,2*0+dslfo,dbl2k-$
  DF33    36             C      
  DF34    50 24 00 01    C      	db	80,36,0,2*0+dslfo,dbl2k-$
  DF38    31             C      
  DF39    A0 24 00 01    C      	db	160,36,0,2*0+dslfo,dbl2k0-$
  DF3D    2F             C      
                         C      
                         C      	if	disk8
  DF3E    4D 24 7F 04    C      	db	77,36,127,2*2+dslvo,dbl2k-$	;Hausformat IH Mittweida
  DF42    27             C      
                         C      	if	dsk8mf
  DF43    4D 40 7F 04    C      	db	77,64,127,2*2+dslvo,dbl2k0-$
  DF47    25             C      
                         C      	endif
                         C      	endif
                         C      	
                         C      ; 1024
  DF48                   C      dtrsl3:	
  DF48    28 28 3F 04    C      	db	40,40,63,2*2+dslvo,dbl1k-$	;CP/A Standard A51xx
  DF4C    1A             C      
  DF4D    50 28 7F 04    C      	db	80,40,127,2*2+dslvo,dbl2k-$	;CP/A
  DF51    18             C      
  DF52    50 28 7F 00    C      	db	80,40,127,2*0+dslvo,dbl2k-$	;CP/A
  DF56    13             C      
  DF57    A0 28 BF 08    C      	db	160,40,191,2*4+dslvo,dbl2k0-$	;CP/A (und SCP)
  DF5B    11             C      
                         C      
                         C      	if	disk8
  DF5C    4D 20 3F 06    C      	db	77,32,63,2*3+dslvo,dbl2k-$	;CP/A und SCP
  DF60    09             C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-78


                         C      	if	dsk8mf
  DF61    4D 40 7F 04    C      	db	77,64,127,2*2+dslvo,dbl2k0-$	;CP/A und SCP
  DF65    07             C      
                         C      	endif
                         C      	endif
                         C      
                         C      ; Modifizierungstabellen fuer BDOS-Blockgroesse
  DF66    03 07 00       C      dbl1k:	db	3,7,0		;Bl. Shift, Bl. Mask, Ext. Mask
  DF69    04 0F 01       C      dbl2k:	db	4,0fh,1
  DF6C    04 0F 00       C      dbl2k0:	db	4,0fh,0		;fuer Kapazitaet >255
                         C      
                         C      ; log. Sektortranslate-Tabelle fuer 26*128
  DF6F    01 07 0D 13    C      xlt:	db	1,7,13,19,25,5,11,17,23,3,9,15,21
  DF73    19 05 0B 11    C      
  DF77    17 03 09 0F    C      
  DF7B    15             C      
  DF7C    02 08 0E 14    C      	db	2,8,14,20,26,6,12,18,24,4,10,16,22
  DF80    1A 06 0C 12    C      
  DF84    18 04 0A 10    C      
  DF88    16             C      
                         C      
                         C       ENDIF	;format
                         C      
                         C      	include BIOSDSKW
                         C      ;;***************************************************************
                         C      ;;	Arbeitsbereiche logischer Floppy-Treiber im System-RAM *
                         C      ;;***************************************************************
                         C      ;; 03.06.89
                         C      
                         C       IF errvar
                         C      ;; Fehlermeldung Disk I/O Error
                         C      ;;=============================
                         C      ;; Genau so lang (kurz), wie in Statuszeile Platz dafuer da ist!
                         C      ;; und das sind 17 Bytes!
  DF89                   C      derrms:
                         C       IF cpastz
                         C       ELSE
  DF89    0D 0A          C      	db	0dh,0ah
                         C       ENDIF
  DF8B    58             C      derrrw:	db	'X'
  DF8C    58 3B 54 2C    C      derrcd:	db	'X;T,Si,Se='
  DF90    53 69 2C 53    C      
  DF94    65 3D          C      
  DF96    58 58          C      derrtr:	db	'XX'
  DF98    58 58          C      derrts:	db	'XX'
  DF9A    58 58          C      derrsc:	db	'XX'
                         C       IF cpastz
                         C       ELSE
  DF9C    07 00          C      	db	07h,0
                         C       ENDIF
                         C      
                         C       ENDIF
                         C      
                         C      ;; CDB's
                         C      ;;======
                         C      
                         C      ;;CDB fuer Bestimmung Laufwerksbereitschaft bei Select Disk
                         C      ;;--------------------------------------------------------
  DF9E                   C      drdcdb:
  DF9E    10             C      drdflg:	db	(1 shl dioftr)	;;Lesen, kein Fehlerprotokoll
  DF9F    FF             C      drddev:	db	0ffh		;;Geraet
  DFA0    0000           C      drdtrk:	dw	0		;;Spur
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-79


  DFA2    01             C      	db	1		;;Sektor (bel.)
  DFA3    01             C      	db	1		;;Sektorlaengencode (>0, 1..3)
  DFA4    00             C      	db	0		;;Sektoranzahl=0 -> nur Positionieren
                         C      
                         C      	IF	format
                         C      ;; CDB fuer Bestimmung Spurformat
                         C      ;;------------------------------------
  DFA5                   C      dfrcdb:
  DFA5    12             C      dfrflg:	db	(1 shl diofid)+(1 shl dioftr)
                         C      ;;		Lesen Sektorid., kein Fehlerprotokoll
  DFA6    FF             C      dfrmdv:	db	0ffh		;;Geraet
  DFA7    FF             C      dfrmtr:	db	0ffh		;;Spur
  DFA8    FF             C      	db	0ffh		;;Seite (bel.)
  DFA9    01             C      	db	1		;;Sektor (bel.)
  DFAA    01             C      	db	1		;;Sektorlaengencode (>0, 1..3)
  DFAB    01             C      	db	1		;;Sektoranzahl (>0)
                         C      	ENDIF
                         C      
                         C      	IF	format or (dbufsz gt 7)
                         C      ;; Puffer-CDB
                         C      ;;-----------
  DFAC                   C      dbcdb:
  DFAC    00             C      dbflg:	db	0
  0000                   C      dfbprr	equ	diof00		;;=1, wenn Puffer erst gelesen 
                         C      ;;				     werden muss
  0002                   C      dfbwr	equ	diofwr		;;=1, wenn Puffer durch
                         C      ;;				     Schreiben veraendert
  0004                   C      dfbtr	equ	dioftr		;;=1, wenn mit Fehlerprotokoll
                         C      ;; restliche Bits immer =0
  DFAD    FF             C      dbdev:	db	0ffh
  DFAE    FF             C      dbtrk:	db	0ffh
  DFAF    FF             C      dbsid:	db	0ffh
  DFB0    FF             C      dbsec:	db	0ffh
  DFB1    FF             C      dbslc:	db	0ffh
  DFB2    FF             C      dbsnb:	db	0ffh
                         C      	IF	dbufsz gt 7
  DFB3    F347           C      dbdma:	dw	dbuf
                         C      	ENDIF
                         C      	ENDIF
                         C      
                         C      ;; CDB fuer ungepufferte E/A
                         C      ;;--------------------------
                         C      
  DFB5                   C      dcdb:
  DFB5    00             C      dflg:	db	0
  0002                   C      dfwr	equ	diofwr 		;;=1, wenn write-Aufruf
                         C      ;; restliche Bits immer =0
  DFB6    00             C      ddrive:	db	0
  DFB7    FF             C      dtrack:	db	0ffh
  DFB8    FF             C      	db	0ffh		;;Seite
  DFB9    FF             C      dsectr:	db	0ffh
  DFBA    00             C      	db	0		;;128 Bytes Sektorlaenge
  DFBB    01             C      	db	1		;;immer nur 1 Sektor
  DFBC    FFFF           C      ddma:	dw	0ffffh
                         C      
                         C       if ramfl
  DFB7                   C      rtrack	equ	dtrack
                         C       endif
                         C      
                         C      ;; Pufferzugriff
                         C       IF @write
                         C       IF dbufsz gt 7
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-80


  DFBE    00 FF FF FF    C      unacnt:	db	0,0ffh,0ffh,0ffh,0
  DFC2    00             C      
  DFBF                   C      unadev	equ	unacnt+1
  DFC0                   C      unatrk	equ	unacnt+2
  DFC2                   C      unasec	equ	unacnt+4
                         C       ENDIF
                         C       ENDIF
                         C       IF dbufsz gt 7
  DFC3    FF             C      dbnb:	db	0ffh
  DFC4    FF             C      dwrtyp:	db	0ffh
  DFC5    00             C      dberrf:	db	0		;;Ergebnisflag letztes dbtran
                         C       ENDIF
                         C      	include BIOSDSKB
                         C      ;;***************************************************************
                         C      ;;	Arbeitsbereiche logischer Floppy-Treiber im BIOS-RAM   *
                         C      ;;***************************************************************
                         C       IF dev eq cpd
                         C       ELSE
  DFC6                   C      diocdb:	ds	9,0ffh
                         C       ENDIF
  DFC6                   C      diocfl	equ	diocdb+0
  DFC7                   C      diocde	equ	diocdb+1
  DFC8                   C      dioctr	equ	diocdb+2
  DFC9                   C      diocsi	equ	diocdb+3
  DFCA                   C      diocse	equ	diocdb+4
  DFCB                   C      diocsl	equ	diocdb+5
  DFCC                   C      diocsn	equ	diocdb+6
  DFCD                   C      diocad	equ	diocdb+7
  0009                   C      diocdl	equ	9		;;Anzahl der Bytes
                         C      
                         C       IF dev eq cpd
                         C       ELSE
                         C        IF disknb eq 0
                         C        ENDIF
                         C       ENDIF
                                 IF disknb ne 0
                         C      	include BIOSDSKT
                         C      ;*********************************************************
                         C      ; physischer Disketten-Transfer
                         C      ; Aenderungen:
                         C      ; - Es koennen 9 statt bisher 4 phys. Sektoren auf einmal gelesen werden
                         C      ;!-!Schnittstellenaenderung bei SektId lesen:
                         C      ;   ft.anz muss <>0 sein (zuvor beliebig, bei =0 kein Transfer)
                         C      ;   ft.len muss 0..3 sein (zuvor beliebig, bei >3 fehlerhafte Tabellenmodif.)
                         C      ;   ft.kom, Bit 7 eingefuehrt: =0 Vorderseite, =1 Rueckseite
                         C      ;   ft.kom, Bit 0 (Verify nach Schreiben) auf Bit 6 verlegt
                         C      ;   ft.kom, Bit 0 =1 bedeutet "keine Fehlerwiederholung"
                         C      ; - Floppy-Treiber auch fuer Variante K5120/22 generierbar
                         C      ; 06.07.88
                         C      ; - Motor-Start-Wait von 254 auf 252 veraendert (2.5 Umdrehungen)
                         C      ;   (ist bei einigen Laufwerken wegen PreReady notwendig)
                         C      ; 03.11.22
                         C      ; - Variante K5122 eingefuegt
                         C      ; 25.09.89
                         C      ; - bei MFS 1.2 bei Mehr-Sektor-Transfer "Fault reset" zwischen den Sektoren
                         C      ;*********************************************************
                         C      
                         C      ; Aufruf:
                         C      ; -------
                         C      ; Bereitstellung der Parameter auf den Bytes:
                         C      
                         C      ;       ft.kom:	db	0	; bit0 - =1 ohne Fehlerwiederholung
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-81


                         C      ;				     1 - =1 lesen ft.len von beliebigem Sektor
                         C      ;				     2 - =0 lesen ; =1 schreiben Sektor(en)
                         C      ;				     3 - =0-FM; =1-MFM   (5"FM nur bei PC1715)
                         C      ;				     4 - =0-8"; =1-5"
                         C      ;				     5 - =0- 40-Spur-Laufwerk; =1- 80-Spur-LW
                         C      ;				     6 - =1 bei verify nach schreiben
                         C      ;				     7 - =0 Vorderseite, =1 Rueckseite
                         C      ;	ft.adr: dw	0	; Transferadresse
                         C      ;	ft.lwn: db	0	; 0..3 phys. Laufwerksnummer
                         C      ;	ft.trk: db	0	; 0..  track
                         C      ;	ft.sid: db	0	; 0..ff side (side=0 auf Rueckseite moeglich!)
                         C      ;	ft.sec: db	0	; 0..  sector (beliebig bei SektId lesen)
                         C      ;	ft.len: db	0	; 0..3 Sektorlaenge (auch 0..3 bei SektId les.)
                         C      ;	ft.anz: db	0	; 0..9 Anzahl der zu uebertragenden Sektoren
                         C      ;				;      =0: nur Positionieren
                         C      ;				;      (<>0 bei SektId lesen)
                         C      ;       ft.stp: db	0	;      Anzahl der Stepimpulse von Spur zu Spur
                         C      ;	ft.sti: db	0	;      Schrittzeit von Spur zu Spur
                         C      ;				;      in 0,1ms Einheiten
                         C      ;
                         C      ;	call	floppy
                         C      ;       ...			; in A steht Ergebniskode
                         C      ;				; alle Register (auch IX) undef.
                         C      ;
                         C      ; Ergebniskode (in Reg. A):
                         C      ;	00h kein Fehler (Z-Flag nicht von floppy gesetzt)
                         C      ;	'C' CRC-Fehler
                         C      ;	'D' LW nicht existent
                         C      ;	'R' Geraet nicht bereit, aber existent
                         C      ;	'L' unzulaessige Transferlaenge
                         C      ;	'S' Sektor nicht gefunden
                         C      ;	'T' Spurnummer zu gross
                         C      ;	'U' keine Marke gefunden
                         C      ;	'W' Diskette schreibgeschuetzt
                         C      
                         C      ; Paramfeld wird an folgenden Stellen veraendert:
                         C      ;  Komm. "Lesen Sekt,Id.":	ft.trk .. ft.len gestellt
                         C      ;  Komm. "Schreiben mit Verify":ft.kom, bit 2 geloescht
                         C      ;**************************************************
                         C      
  0004                   C      maxlw	equ	4		; Anzahl der Laufwerke (1..4)
                         C      
                         C      ; Adressen der Floppy-Karte
                         C      ;==========================
                         C      
                         C       IF (fdc eq k5120) or (fdc eq k5122)
                         C      ;Steuer-PIO
  0010                   C      flcoad    equ  10h  ;PORT A
  0011                   C      flcoac    equ  11h
  0012                   C      flcobd    equ  12h  ;PORT B
  0013                   C      flcobc    equ  13h
                         C      
                         C      ;Daten-PIO
  0014                   C      fldaad    equ  14h  ;Port A Schreib-Daten
  0015                   C      fldaac    equ  15h
  0016                   C      fldabd    equ  16h  ;Port B Lese-Daten
  0017                   C      fldabc    equ  17h
                         C      
                         C      ;Select-Latch
  0018                   C      flsel     equ  18h  ;Bit 7..4 /Sel LW3..0;Bit 3..0  /LCK  LW 3..0
                         C      ;
                         C       ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-82


                         C      
                         C       IF (fdc eq f1715)
                         C       ENDIF
                         C      
                         C      ;; Legende AMF:
                         C      ;;   Port A
                         C      ;;  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
                         C      ;;    |   |   |   |   |   |   |   |__ A  /WE  0-Schreiben ein
                         C      ;;    |   |   |   |   |   |   |______ A   MK  lesen  0-MFM-A1 Erkennung
                         C      ;;    |   |   |   |   |   |                          1-FM-Mark., MFM-C2 Erkenn.
                         C      ;;    |   |   |   |   |   |               schreiben  0-Takt fuer MFM
                         C      ;;    |   |   |   |   |   |                          1-Marken FM und A1 MFM
                         C      ;;    |   |   |   |   |   |__________ A  /SIDE 0-Kopf Seite 1; 1-Kopf Seite 0
                         C      ;;    |   |   |   |   |        oder   A  /FR   0-Fault reset;  1-kein FR
                         C      ;;    |   |   |   |   |______________ A  /STR 0-AMF aktiv
                         C      ;;    |   |   |   |                           1-AMF ausgeschaltet
                         C      ;;    |   |   |   |__________________ A   MK1 lesen  0-Informationen einlesen
                         C      ;;    |   |   |                                      1-nur 1 einlesen
                         C      ;;    |   |   |                           schreiben  0-FM-Daten schreiben
                         C      ;;    |   |   |                                      1-MFM und FM-Marken schr.
                         C      ;;    |   |   |______________________ A   MR, SD     0-steppen Richtung aussen
                         C      ;;    |   |                                          1-Marke-erkannt loeschen
                         C      ;;    |   |                                            steppen Richtung innen
                         C      ;;    |   |__________________________ A  /HL         0-Kopf geladen
                         C      ;;    |                                              1-Kopf entladen
                         C      ;;    |______________________________ A  /ST         0-Stepsignal an LW ein
                         C      ;;                                                   1-Stepsignal an LW aus
                         C      ;;
                         C      ;;  Port B
                         C      ;;  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
                         C      ;;    |   |   |   |   |   |   |   |__ E  /RDY  0-Laufwerk bereit
                         C      ;;    |   |   |   |   |   |   |                1-Laufwerk nicht bereit
                         C      ;;    |   |   |   |   |   |   |______ E  /MKE  0-Marke erkannt
                         C      ;;    |   |   |   |   |   |                    1-Marke noch nicht erkannt
                         C      ;;    |   |   |   |   |	 oder PC1715  E   MKE  1-Marke erkannt
                         C      ;;    |   |   |   |   |   | u.K5122            0-Marke noch nicht erkannt
                         C      ;;    |   |   |   |   |   |__________ E  /SYN  ???? (K5120)
                         C      ;;    |   |   |   |   |  oder K5122   A  /HF   0-Takt fuer 8" MFM
                         C      ;;    |   |   |   |   |                        1-Takt fuer 5" MFM und 8" FM
                         C      ;;    |   |   |   |   |  oder PC1715: A   MFM  0-FM-Aufzeichnung
                         C      ;;    |   |   |   |   |                        1-MFM-Aufzeichnung
                         C      ;;    |   |   |   |   |______________ A   PRE  0-schreiben ohne Prekompensation
                         C      ;;    |   |   |   |                            1-schreiben mit         "
                         C      ;;    |   |   |   |__________________ E  /FA   0-Fehler in der AMF aufgetreten
                         C      ;;    |   |   |                                1-kein Fehler aufgetreten
                         C      ;;    |   |   |          oder PC1715: A   FO   0-5"-Disketten
                         C      ;;    |   |   |                                1-8"-Disketten
                         C      ;;    |   |   |______________________ E  /WP   0-Schreibschutz ist ein
                         C      ;;    |   |                                    1-kein Schreibschutz
                         C      ;;    |   |__________________________ E  /FW   0-Laufwerk meldete Schreibfehler
                         C      ;;    |                                        1-Laufwerk meldete keinen Fehler
                         C      ;;    |______________________________ E  /T0   0-Kopf steht auf Spur 0
                         C      ;;                                             1-Kopf steht nicht auf Spur 0
                         C      
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      ;	FLOPPY-Treiber
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
  DFCF                   C      floppy:
                         C      
                         C      ; Anfangswerte stellen
  DFCF    3A E2C0        C      	ld	a,(ft.kom)
  DFD2    E6 01          C      	and	1		;Fehlerwiederholung?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-83


  DFD4    20 02          C      	jr	nz,setecr	;nein, A=0+1 (keine Wiederholung)
  DFD6    3E 10          C      	ld	a,15+1
  DFD8    32 E2E6        C      setecr:	ld	(crerc),a	; Fehlerzaehler fuer CRC-Fehlerwiederholungen
  DFDB    20 02          C      	jr	nz,setesp
  DFDD    3E 05          C      	ld	a,4+1		; Fehlerzaehler fuer Spurfindewiederholungen
  DFDF    32 E2E7        C      setesp:	ld	(sperc),a
                         C      
                         C      ; Laufwerksnummer pruefen
  DFE2    3A E2C3        C      	ld	a,(ft.lwn)	; LW
                         C      ;	cp	maxlw		; LW < groesster LW-Nr.?
                         C      ;	jr	nc,nolw		; -> nein, Fehler: LW nicht existent
  DFE5    4F             C      	ld	c,a		; merken LW fuer Motor-an-Test
  DFE6    47             C      	ld	b,a		; fuer djnz
  DFE7    B7             C      	or	a		; LW=0?
  DFE8    3A E2E9        C      	ld	a,(lwexis)
  DFEB    28 04          C      	jr	z,drv0		; ->ja
  DFED    0F             C      sp13: 	rrca
  DFEE    0F             C      	rrca
  DFEF    10 FC          C      	djnz	sp13
  DFF1    E6 03          C      drv0: 	and	3
  DFF3    20 05          C      	jr	nz,drv0a
                         C      
  DFF5    3E 44          C      nolw: 	ld	a,'D'		; LW nicht existent
  DFF7    C3 E1BC        C      	jp	fehret		; -> Fehler
                         C      
  DFFA                   C      drv0a:
                         C      ; LW selektieren und Motor einschalten
  DFFA    AF             C      	xor	a
  DFFB    32 E291        C      	ld	(pretx+1),a	;Motorabschaltung verhindern
  DFFE    3D             C      	dec	a		;A:=255
  DFFF    CD E278        C      	call	fl.sto		;Index-Ueberwachung ein
  E002    CB D9          C      	set	3,c		; Motor-an-Bit setzen
  E004    21 E2EA        C      	ld	hl,alwnr
  E007    7E             C      	ld	a,(hl)
  E008    B9             C      	cp	c		; ist es das richtige LW und Motor an?
  E009    3E 6A          C      	ld	a,+pvrw2-(xpvrw+2) ; jr z,pvrw2 (keine Vertikalstab.)
  E00B    28 42          C      	jr	z,dskmon	; ->ja, Kopf ist noch aufgesetzt
                         C      ; falsches LW oder Motor des LW aus
  E00D    CD E2AB        C      	call	flres		; alte Spurnr. merken
                         C      
                         C      ; neues LW anwaehlen, Motor einschalten und alte Spurnr. holen
  E010    71             C      	ld	(hl),c		; neues LW, Motor-an-Bit
  E011    EB             C      	ex	de,hl		;merken ^alwnr
  E012    CB 99          C      	res	3,c		; alte Spurnr. holen
  E014    06 00          C      	ld	b,0
  E016    21 E2EC        C      	ld	hl,spnrl
  E019    09             C      	add	hl,bc
  E01A    7E             C      	ld	a,(hl)
  E01B    32 E2EB        C      	ld	(aspnr),a
  E01E    41             C      	ld	b,c
  E01F    04             C      	inc	b
  E020    3E 77          C      	ld	a,077h		; LW-Anwahlbyte bilden (mit Lock)
  E022    07             C      nfdei2: rlca
  E023    10 FD          C      	djnz	nfdei2
  E025    D3 18          C      	out	(flsel),a	; Laufwerk selektieren (und evtl. Motor ein)
                         C       IF fdc eq f1715
                         C       ENDIF
  E027    3E A9          C      	ld	a,10101001b	; Kopf laden, Fault reset
  E029    D3 10          C      	out	(flcoad),a
                         C      
                         C      ; Motor-Start
  E02B    2E FD          C      	ld	l,252+1		;von 255 auf 252, d.h. mind 2 Umdrehungen?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-84


  E02D    3A E2C0        C      	ld	a,(ft.kom)
  E030    CB 67          C      	bit	4,a		;5"?
  E032    28 06          C      	jr	z,dskmo1	;nein
  E034    CB 6F          C      	bit	5,a		;5" 40 Spur?
  E036    20 02          C      	jr	nz,dskmo1	;nein
  E038    2E FB          C      	ld	l,250+1		;von 255 auf 250,
                         C      				; d.h. mind. 4 volle Umdrehungen?
                         C      				;(bei MFS 1.2 kommt evtl. ready zu frueh)
  E03A                   C      dskmo1:
  E03A    3A E289        C      dskdaw:	ld	a,(fl.zto)	;Index-Interrupt-Zaehler
  E03D    BD             C      	cp	l		;entprechend viele Umdrehungen vorbei?
  E03E    38 0D          C      	jr	c,dskda		;ja
  E040    0D             C      	dec	c		; warten, bis Diskette eingeschoben
  E041    20 F7          C      	jr	nz,dskdaw
  E043    10 F5          C      	djnz	dskdaw
  E045    EB             C      	ex	de,hl
  E046    CB 9E          C      	res	3,(hl)		;loeschen Motor an Bit
  E048    3E 52          C      	ld	a,'R'		;LW nicht bereit
  E04A    C3 E1BC        C      	jp	fehret
  E04D    3E 61          C      dskda:	ld	a,+pvrw1-(xpvrw+2) ; jr z,pvrw1 (mit Vertikal-Stabil.)
  E04F                   C      dskmon:
  E04F    32 E0B0        C      	ld	(xpvrw+1),a	; Vertikal-Stabilisierung ein/aus
                         C      
                         C      
                         C       IF dsk8fm+dsk8mf+dsk5fm; Standard ist 5"MFM
                         C      ; modifizieren FM/MFM und 8"/5"
                         C      
  E052    21 E305        C      	ld	hl,mdmfm8
  E055    01 000A        C      	ld	bc,mdtbl	;BC:=(Anzahl der Bytes)
  E058    3A E2C0        C      	ld	a,(ft.kom)
  E05B    CB 5F          C      	bit	3,a		;MFM?
  E05D    20 02          C      	jr	nz,modfl1	;ja
  E05F    09             C      	add	hl,bc
  E060    09             C      	add	hl,bc
  E061    CB 67          C      modfl1:	bit	4,a		;8"?
  E063    28 01          C      	jr	z,modfl2	;ja
  E065    09             C      	add	hl,bc
  E066    EB             C      modfl2:	ex	de,hl
  E067    21 E2F0        C      	ld	hl,mdtbad
  E06A    CD E219        C      	call	flmodf		;Modifizierung
                         C       ENDIF
                         C       if dsk80
  E06D    3A E2C0        C      	ld	a,(ft.kom)
                         C       if dsk8fm+dsk8mf
  E070    CB 67          C      	bit	4,a		;5" LW?
  E072    28 0B          C      	jr	z,dprecn	;nein
                         C       endif
  E074    CB 6F          C      	bit	5,a		;80-Spur-LW?
  E076    3E 19          C      	ld	a,25		;Spur, ab der mit Praekomp.
  E078    28 02          C      	jr	z,dprec2	;nein
  E07A    3E 29          C      	ld	a,41
  E07C    32 E136        C      dprec2:	ld	(dpretr),a
  E07F                   C      dprecn:
                         C       endif
                         C      
                         C      ; modifizieren entspr. phys. Sektorlaenge
  E07F    3A E2C7        C      	ld	a,(ft.len)
  E082    32 E3C7        C      	ld	(sidlen),a
  E085    21 E32D        C      	ld	hl,dsln0-dslnl
  E088    47             C      	ld	b,a
  E089    04             C      	inc	b
  E08A    11 0009        C      	ld	de,dslnl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-85


  E08D    19             C      dtrsll:	add	hl,de
  E08E    10 FD          C      	djnz	dtrsll
  E090    EB             C      	ex	de,hl
  E091    21 E323        C      	ld	hl,dslnmt	;Tabelle der Modif.adr.
  E094    CD E219        C      	call	flmodf
                         C      
                         C      ; Kopf positionieren
  E097    21 E2C4        C      	ld	hl,ft.trk	; gewuenschte Spur
  E09A    7E             C      	ld	a,(hl)
  E09B    B7             C      	or	a		;Spur 0?
  E09C    20 0D          C      	jr	nz,npost0	;nein
  E09E    3A E2C8        C      	ld	a,(ft.anz)	;Sektorzahl
  E0A1    B7             C      	or	a		;nur positionieren auf Spur 0 (FORMAT-Progr.)
  E0A2    28 4F          C      	jr	z,trk0		;ja, Spur 0 immer ueber Recalibrate
  E0A4    3A E2C0        C      	ld	a,(ft.kom)
  E0A7    CB 4F          C      	bit	1,a		;Lesen Sekt.id Spur 0?
  E0A9    20 53          C      	jr	nz,trk0s	;ja, Lesen Sektid Spur 0 ueber Recalibrate
  E0AB    3A E2EB        C      npost0:	ld	a,(aspnr)	; stimmt Spur?
  E0AE    BE             C      	cp	(hl)
  E0AF    28 61          C      xpvrw:	jr	z,pvrw1		; -> ja, Kopf evtl. vertikal stabilisieren
                         C      				; auf jr z,pvrw2, wenn Kopf noch aufgesetzt
  E0B1                   C      spprty:				;Wiederholung bei fehlerhafter Spur
                         C      ; Positionierung auf ft.trk
  E0B1    3A E2C4        C      spe: 	ld	a,(ft.trk)
  E0B4    06 8F          C      	ld	b,08fh		; stepout-Befehl
  E0B6    21 E2EB        C      	ld	hl,aspnr
  E0B9    BE             C      	cp	(hl)		; auf richtiger Spur angekommen?
  E0BA    28 56          C      	jr	z,phrw		; -> ja, Kopf horizontal stabilisieren
  E0BC    38 0D          C      	jr	c,spre		; -> stepout
  E0BE    FE 55          C      xmaxtr: cp	85		; Spur zu gross?
  E0C0    38 05          C      	jr	c,spve		; -> nein, stepin
  E0C2    3E 54          C      	ld	a,'T'		; Fehler: Spurnr. zu gross
  E0C4    C3 E1BC        C      	jp	fehret
                         C      
                         C      ; stepin
  E0C7    06 AF          C      spve:	ld	b,0afh		; stepin-Befehl
  E0C9    34             C      	inc	(hl)		; alte Spurnr. erhoehen
  E0CA    34             C      	inc	(hl)		; wegen stepout-dec
                         C      
                         C      ; stepout
  E0CB    35             C      spre: 	dec	(hl)		; alte Spurnr. verringern
  E0CC    CD E0D1        C      	call	step
  E0CF    18 E0          C      	jr	spe
                         C      
                         C      ; steppen
  E0D1    3A E2C9        C      step: 	ld	a,(ft.stp)	; Anzahl der Stepimpulse pro Step
  E0D4    0E 10          C      step0: 	ld	c,flcoad
  E0D6    ED 41          C      	out	(c),b		; select direction
                         C      ;;;	push	bc
                         C      ;;;	ld	b,0
                         C      ;;;step1: 	djnz	step1		; 1,3ms warten
                         C      ;;;	pop	bc
  E0D8    C5             C      step2: 	push	bc
  E0D9    CB B8          C      	res	7,b
  E0DB    F3             C      	di			;verhindern Unterbrechung
  E0DC    ED 41          C      	out	(c),b
  E0DE    CB F8          C      	set	7,b
  E0E0    ED 41          C      	out	(c),b		; step
  E0E2    FB             C      	ei
  E0E3    ED 4B E2CA     C      	ld	bc,(ft.sti)	; 13,2 / 11,6 / 3,0 ms Schrittzeit
  E0E7    06 13          C      stepw1: ld	b,19		;(19*13)/(256*9600)=0.0001
  E0E9    10 FE          C      stepw: 	djnz	stepw		;0.1 ms warten
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-86


  E0EB    0D             C      	dec	c
  E0EC    20 F9          C      	jr	nz,stepw1
  E0EE    C1             C      	pop	bc
  E0EF    3D             C      	dec	a
  E0F0    20 E6          C      	jr	nz,step2
  E0F2    C9             C      	ret
                         C      
                         C      ; Spur 0 anfahren (Recalibrate)
  E0F3    06 02          C      trk0:	ld	b,2		; nach innen, falls auf Spur -1
  E0F5    C5             C      trk0i:	push	bc
  E0F6    06 AF          C      	ld	b,0afh	 	; stepin
  E0F8    CD E0D1        C      	call	step
  E0FB    C1             C      	pop	bc
  E0FC    10 F7          C      	djnz	trk0i
  E0FE    DB 12          C      trk0s:	in	a,(flcobd)
  E100    07             C      	rlca			; Spur 0 erreicht?
  E101    30 09          C      	jr	nc,trk0f	; -> ja
  E103    06 8F          C      	ld	b,08fh		; stepout-Befehl
  E105    3E 01          C      	ld	a,1		; in phys. Schritten
  E107    CD E0D4        C      	call	step0
  E10A    18 F2          C      	jr	trk0s
  E10C    AF             C      trk0f: 	xor	a
  E10D    32 E2EB        C      	ld	(aspnr),a	; aktuelle Spurnr ist 0
  E110    18 9F          C      	jr	spprty
                         C      
                         C      
                         C      ; Kopf stabilisieren (horizontal und vertikal)
  E112                   C      pvrw1:	; Kopf vertikal stabilisieren
  E112                   C      phrw:	; Kopf horizontal (und evtl. auch vertikal) stabilisieren
  E112    3E 32          C      	ld	a,50		; 50 ms (fuer alle Laufwerkstypen)
  E114    06 BD          C      phrww1: ld	b,189		; (189*13)/(256*9600)=0.001
  E116    10 FE          C      phrww: 	djnz	phrww		; 1 ms warten
  E118    3D             C      	dec	a
  E119    20 F9          C      	jr	nz,phrww1
  E11B                   C      pvrw2:	; Kopf war aufgesetzt und Spur stimmte auch - keine Stabilis.
                         C      
  E11B                   C      rdwr:
                         C      ; Anfangswerte fuer Transfer der physischen Sektoren
  E11B    3A E2C8        C      	ld	a,(ft.anz)	; Anzahl der zu uebertragenden phys. Sektoren
  E11E    32 E3BC        C      	ld	(secan1),a
  E121    32 E22B        C      	ld	(secanz),a	; fuer CRC-Berechnung
                         C      
  E124    3A E2C4        C      	ld	a,(ft.trk)	; Spur
  E127    32 E3C3        C      	ld	(sidtr),a
  E12A    21 E2C9        C      	ld	hl,ft.stp
  E12D    CB 46          C      	bit	0,(hl)		;Doppelschritte?
  E12F    28 01          C      	jr	z,dprec1	;nein
  E131    87             C      	add	a,a		;sonst phys. Spur verdoppeln
  E132                   C      dprec1:
                         C      ; evtl. Precompensation einschalten
  E132    01 0412        C      	ld	bc,00000100b*256+flcobd
  E134                   C      dfrcod	equ	$-1		; Frequenzcode
  E135    FE 19          C      	cp	25		; Spur ab der mit writeprecomp.
  E136                   C      dpretr	equ	$-1
  E137    38 02          C      	jr	c,prec		; <, ohne Precompensation
  E139    CB D8          C      	set	3,b		; >= , mit
  E13B    ED 41          C      prec: 	out	(c),b
                         C      
  E13D    3A E2C6        C      	ld	a,(ft.sec)	; erste zu uebertr. Sektornr.
  E140    32 E3C6        C      	ld	(sidsec),a
  E143    3A E2C5        C      	ld	a,(ft.sid)
  E146    32 E3C4        C      	ld	(sidsid),a
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-87


                         C      
                         C       IF dskds ; double sided
                         C      ; evtl. side 1 anwaehlen vorbereiten
  E149    3A E2C0        C      	ld	a,(ft.kom)
  E14C    21 E35A        C      	ld	hl,dsidmt
  E14F    46             C      	ld	b,(hl)
  E150    23             C      dsidmz:	inc	hl
  E151    5E             C      	ld	e,(hl)
  E152    23             C      	inc	hl
  E153    56             C      	ld	d,(hl)
  E154    EB             C      	ex	de,hl
  E155    CB 7F          C      	bit	7,a		; side 0?
  E157    28 04          C      	jr	z,pside0	; ja
  E159    CB 96          C      	res	2,(hl)		; side 1 einstellen
  E15B    18 02          C      	jr 	pside1
  E15D    CB D6          C      pside0:	set	2,(hl)
  E15F    EB             C      pside1:	ex	de,hl
  E160    10 EE          C      	djnz	dsidmz
  E162    CB 6F          C      	bit	5,a		;40-Spur LW?
  E164    20 03          C      	jr	nz,pside2	;nein
  E166    EB             C      	ex	de,hl		;diom11
  E167    CB 96          C      	res	2,(hl)		;fault reset zwischen den Sektoren
  E169                   C      pside2:
                         C       ENDIF
                         C      
                         C      ; evtl. nur Lesen Sektor-Id.
  E169    3A E2C0        C      	ld	a,(ft.kom)
  E16C    CB 4F          C      	bit	1,a		; Lesen Sekt.Id?
  E16E    21 E3B4        C      	ld	hl,dio
  E171    28 03          C      	jr	z,srdsid	; -> nein
  E173    21 E41A        C      	ld	hl,diotsr
  E176    22 E374        C      srdsid:	ld	(diortn),hl
                         C      
                         C       IF @write
  E179    3A E2C0        C      	ld	a,(ft.kom)	; Schreiben?
  E17C    CB 57          C      	bit	2,a
  E17E    20 08          C      	jr	nz,writpt	; -> ja, Schreibroutine steht auf dioop
                         C       ENDIF
  E180    21 E46F        C      	ld	hl,diord
  E183    22 E418        C      	ld	(dioop),hl	; read einstellen
                         C      
                         C       IF @write
  E186    18 22          C      	jr	dtrdyt
  E188                   C      writpt:		; pruefen, ob Schreiben erlaubt ist
  E188    DB 12          C      	in	a,(flcobd)
  E18A    CB 6F          C      	bit	5,a		; /WP
  E18C    3E 57          C      	ld	a,'W'		; Fehler: write protected
  E18E    CA E1BC        C      	jp	z,fehret
                         C      
                         C      ; CRC-Zeichen der zu schreibenden Daten berechnen und in crcber ablegen
  E191    2A E2C1        C      	ld	hl,(ft.adr)
  E194    DD 21 E2CB     C      	ld	ix,crcber	; Pointer auf 1. Daten-CRC stellen
  E198    DD 36 00 FB    C      crcbes: ld	(ix),0fbh	; Datenbeginn
  E19C    CD E23B        C      	call	crcbd		; CRC eines phys. Sektors berechnen
  E19F    DD 72 00       C      	ld	(ix+0),d
  E1A2    DD 73 01       C      	ld	(ix+1),e	; ... und ablegen
  E1A5    CD E226        C      	call	crcnb		; weiterer phys. Sektor?
  E1A8    20 EE          C      	jr	nz,crcbes	; -> ja
                         C       ENDIF ;@write
                         C      
                         C      
                         C      ; Disk inzwischen ready?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-88


                         C      
  E1AA                   C      dtrdyt:
  E1AA    DB 12          C      dtrdyz:	IN	A,(flcobd)
  E1AC    1F             C      	RRA			;ready-bit =0?
  E1AD    38 FB          C      dtrdyw:	JR	C,dtrdyz	;nein, 5" Disk not ready
                         C      				;auf jr c,$+2 modif bei 8"
                         C      
  E1AF    3E 05          C      	ld	a,5
  E1B1    CD E278        C      	call	fl.sto		;bei evtl. Fehlerwiederholung
                         C      				; timeout-Wert wieder hochstellen
                         C      				; fuer Ueberwachung auf fehlende Marke
  E1B4    3A E2C8        C      	ld	a,(ft.anz)	;Sektorzahl
  E1B7    B7             C      	or	a		; nur positionieren?
  E1B8    C2 E36D        C      	jp	nz,diorun	; -> nein, Start des Transfers
                         C      
                         C      ; kein Fehler aufgetreten
  E1BB    AF             C      noerr:	xor	a
                         C      
                         C      ; Fertigmelden, Ergebnis in A
  E1BC    F5             C      fehret:	push	af
  E1BD    21 E291        C      	ld	hl,pretx+1	;Motorabschaltung ueber Index-Interrupt
  E1C0    36 0B          C      	ld	(hl),pret3-pret4;jr pret4
  E1C2    3E 14          C      	ld	a,20		;nach 20*200ms = 4 sec
  E1C4    CD E278        C      	call	fl.sto
  E1C7    F1             C      	pop	af
  E1C8    C9             C      	ret
                         C      
                         C      ; normale Beendigung
                         C      ;===================
                         C      
                         C      ; Schreiben
  E1C9    21 E2C0        C      dtrwre:	ld	hl,ft.kom
  E1CC    CB 76          C      	bit	6,(hl)		;Kontrollesen?
  E1CE    28 EB          C      	jr	z,noerr		;nein, fertig
  E1D0    CB 96          C      	res	2,(hl)		;sonst schreiben loeschen (d.h. auf lesen)
  E1D2    C3 E11B        C      	jp	rdwr		;und auf gleichen Puffer zuruecklesen
                         C      
                         C      ; Lesen
  E1D5    2A E2C1        C      dtrrde:	ld	hl,(ft.adr)
  E1D8    DD 21 E2CB     C      	ld	ix,crcber
  E1DC    CD E23B        C      crcbel:	call	crcbd		;CRC bilden
  E1DF    CD E231        C      	call	crcvgl		; und vergleichen
  E1E2    20 07          C      	jr	nz,crcerx	; -> Fehler
  E1E4    CD E226        C      	call	crcnb		;noch ein Sektor?
  E1E7    20 F3          C      	jr	nz,crcbel	;ja
  E1E9    18 D0          C      	jr	noerr
                         C      
                         C      ; Fehlerbehandlung
                         C      ;=================
                         C      ; blieb weiterer Versuch, Sektor CRC-richtig reinzubekommen?
  E1EB    21 E2E6        C      crcerx: ld	hl,crerc
  E1EE    35             C      	dec	(hl)
  E1EF    C2 E11B        C      	jp	nz,rdwr		; -> ja, alles noch mal
  E1F2    3E 43          C      	ld	a,'C'		; Fehler: CRC-Zeichen falsch
  E1F4    18 C6          C      	jr	fehret
                         C      
                         C      ; Sektor nicht gefunden, evtl. falsche Spur
  E1F6                   C      serrx:
                         C      ; blieb weiterer Versuch, die richtige Spur zu finden?
  E1F6    21 E2E7        C      	ld	hl,sperc
  E1F9    35             C      	dec	(hl)
  E1FA    28 15          C      	jr	z,sperr2	; Wiederhlg. abgelaufen
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-89


  E1FC    3E 02          C      	ld	a,2
  E1FE    BE             C      	cp	(hl)		;> 2 Wiederhlg?
  E1FF    DA E0F3        C      	jp	c,trk0		;ja, Spur neu anfahren
  E202    06 8F          C      	ld	b,08fh		;stepout
  E204    28 05          C      	jr	z,sperr4	;=2 Wiederhlg., stepout
  E206    06 AF          C      	ld	b,0afh		;stepin
  E208    CD E0D1        C      	call	step		;2 mal (zuvor war stepout)
  E20B    CD E0D1        C      sperr4:	call	step
  E20E    C3 E112        C      	jp	phrw		;Wiederholung
                         C      
  E211    3E 53          C      sperr2:	ld	a,'S'		; Fehler: Sektor ist nicht zu finden
  E213    18 A7          C      	jr	fehret
                         C      
                         C      
  E215                   C      fl.to1: ; keine Sektor-Marke gefunden
  E215    3E 55          C      	ld	a,'U'		; time-out (undefind)
  E217    18 A3          C      	jr	fehret
                         C      
                         C      ; Modifizierung entsprechend Steuertabelle
                         C      ;=========================================
                         C      ; i HL	Tabelle der Modifizierungsadressen (wohin)
                         C      ; i DE	Tabelle der Modifizierungsbytes    (was)
  E219    46             C      flmodf:	ld	b,(hl)		;Anzahl der Adressen
  E21A    23             C      dslnmz:	inc	hl
  E21B    C5             C      	push	bc
  E21C    4E             C      	ld	c,(hl)
  E21D    23             C      	inc	hl
  E21E    46             C      	ld	b,(hl)		;bc:=wohin
  E21F    1A             C      	ld	a,(de)		;a:=was
  E220    13             C      	inc	de
  E221    02             C      	ld	(bc),a
  E222    C1             C      	pop	bc
  E223    10 F5          C      	djnz	dslnmz
  E225    C9             C      	ret
                         C      
                         C      ; CRC-Berechnung
                         C      ;===============
                         C      
                         C      ; von weiterem Sektor CRC-Zeichen berechnen?
                         C      ; IX wird weitergestellt
  E226    DD 23          C      crcnb: 	inc	ix		; CRC-Pointer erhoehen
  E228    DD 23          C      	inc	ix
  E22A    3E FF          C      	ld	a,0ffh
  E22B                   C      secanz	equ	$-1
  E22C    3D             C      	dec	a
  E22D    32 E22B        C      	ld	(secanz),a
  E230    C9             C      	ret
                         C      
                         C      ; CRC-Vergleich DE mit (IX)
  E231    DD 7E 00       C      crcvgl: ld	a,(ix+0)
  E234    BA             C      	cp	d
  E235    C0             C      	ret	nz
  E236    DD 7E 01       C      	ld	a,(ix+1)
  E239    BB             C      	cp	e
  E23A    C9             C      	ret
                         C      
                         C      ; von einem phys. Sektor ab HL die CRC-Zeichen berechnen
                         C      ; HL wird weitergestellt
  E23B    11 CDB4        C      crcbd:	ld	de,0cdb4h	;CRC Anfangswert
  E23C                   C      crcbeg	equ	$-2
  E23E    DD E5          C      	push	ix
  E240    E3             C      	ex	(sp),hl		;hl:= ^Datenbeginn-Byte
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-90


  E241    06 01          C      	ld	b,1
  E243    CD E255        C      	call	bercrc		;CRC ueber Datenbeginn-Byte
  E246    E3             C      	ex	(sp),hl
  E247    DD E1          C      	pop	ix
  E249    06 01          C      	ld	b,1
  E24A                   C      fl.tsb	equ	$-1		; Zahl der 128er Bloecke
  E24B    C5             C      sp74: 	push	bc
  E24C    06 80          C      	ld	b,128
  E24E    CD E255        C      	call	bercrc
  E251    C1             C      	pop	bc
  E252    10 F7          C      	djnz	sp74
  E254    C9             C      	ret
                         C      
                         C      ; von HL an B Zeichen auf DE als CRC-Polynom draufrechnen
  E255    7E             C      bercrc: ld	a,(hl)
  E256    AA             C      	xor	d
  E257    57             C      	ld	d,a
  E258    0F             C      	rrca
  E259    0F             C      	rrca
  E25A    0F             C      	rrca
  E25B    0F             C      	rrca
  E25C    E6 0F          C      	and	0fh
  E25E    AA             C      	xor	d
  E25F    57             C      	ld	d,a
  E260    0F             C      	rrca
  E261    0F             C      	rrca
  E262    0F             C      	rrca
  E263    4F             C      	ld	c,a
  E264    E6 1F          C      	and	1fh
  E266    AB             C      	xor	e
  E267    5F             C      	ld	e,a
  E268    79             C      	ld	a,c
  E269    0F             C      	rrca
  E26A    E6 F0          C      	and	0f0h
  E26C    AB             C      	xor	e
  E26D    5F             C      	ld	e,a
  E26E    79             C      	ld	a,c
  E26F    E6 E0          C      	and	0e0h
  E271    AA             C      	xor	d
  E272    53             C      	ld	d,e
  E273    5F             C      	ld	e,a
  E274    23             C      	inc	hl
  E275    10 DE          C      	djnz	bercrc
  E277    C9             C      	ret
                         C      
                         C      ; Aktivieren Indexpunktueberwachung
                         C      ; i A	Zaehler (wird bis 0 runtergezaehlt)
                         C      ; nur Reg. A zerstoert
                         C      
  E278    32 E289        C      fl.sto:	ld	(fl.zto),a	;Setzen Zaehler fuer Indexpunkte
  E27B    3E 83          C      	ld	a,83h		;zulassen Indexinterrupt
  E27D    D3 11          C      	out	(flcoac),a
  E27F    C9             C      	ret
                         C      
                         C      ; Interruptbehandlungsroutine: time-out-Zeit abgelaufen
                         C      ; ausgeloest durch Index-Interrupt
  E280    ED 73 E624     C      itimeo: ld	(intsp),sp
  E284    31 F0F7        C      	ld	sp,intstk
  E287    F5             C      	push	af
  E288    3E 00          C      	ld	a,0		; Zaehler fuer time-out Takte
  E289                   C      fl.zto	equ	$-1
  E28A    3D             C      	dec	a		; time-out -1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-91


  E28B    32 E289        C      	ld	(fl.zto),a
  E28E    20 10          C      	jr	nz,pret1	;-> nicht abgelaufen
  E290    18 0B          C      pretx:	jr	pret3		;modif. auf "jr pret4" waehrend Transfer
  E292                   C      pret4:
                         C       IF cpu eq k2526
  E292    3E A9          C      	ld	a,10101001b	;Time out waehrend Transfer
  E294    D3 10          C      	out	(flcoad),a	;CPU 2 stoppen
  E296    3E 00          C      	ld	a,dtrtor-dtrwjr
  E298    32 E3A4        C      	ld	(dtrret),a	;Reaktionsroutine "keine Marke gefunden"
                         C       ENDIF
  E29B    18 03          C      	jr	pret1
  E29D    CD E2A3        C      pret3:	call	headup
  E2A0    C3 E622        C      pret1: 	jp	intraf		; allg. Ausgang Interruptroutinen
                         C      
                         C      ; Motor-Abschaltung von aussen her
                         C      ; nur Reg. AF zerstoert
  E2A3    3E 03          C      headup:	ld	a,3		; Indexinterrupt sperren
  E2A5    D3 11          C      	out	(flcoac),a
  E2A7    3E FF          C      	ld	a,0ffh		; Motor aus
  E2A9    D3 18          C      	out	(flsel),a
                         C       IF fdc eq f1715
                         C       ENDIF
                         C      ; Motor aus und alte Spurnummer merken
  E2AB    E5             C      flres: 	push	hl
  E2AC    C5             C      	push	bc
  E2AD    21 E2EA        C      	ld	hl,alwnr
  E2B0    CB 9E          C      	res	3,(hl)		; Motor aus vermerken
  E2B2    4E             C      	ld	c,(hl)
  E2B3    06 00          C      	ld	b,0
  E2B5    21 E2EC        C      	ld	hl,spnrl	; alte Spurnr. in Tabelle merken
  E2B8    09             C      	add	hl,bc
  E2B9    3A E2EB        C       	ld	a,(aspnr)
  E2BC    77             C      	ld	(hl),a
  E2BD    C1             C      	pop	bc
  E2BE    E1             C      	pop	hl
  E2BF    C9             C      	ret
                         C      
                         C      
                         C      ;*****************************************************
                         C      ;	Arbeitsbereiche phys. Floppy-Treiber
                         C      ;*****************************************************
                         C      
                         C      ; Parameterfeld
                         C      ;==============
  E2C0    00             C      ft.kom: db	0	; Kommando
  E2C1    0000           C      ft.adr: dw	0	; Transferadresse
  E2C3    00             C      ft.lwn: db	0	; Laufwerksnummer 0..3
  E2C4    00             C      ft.trk: db	0	; Spurnummer   0..
  E2C5    00             C      ft.sid: db	0	; side-Nr.     0..1
  E2C6    00             C      ft.sec: db	0	; Sektornummer
  E2C7    00             C      ft.len: db	0	; Sektorlaenge 0..3
  E2C8    00             C      ft.anz: db	0	; Anz. phys. Sektoren
  E2C9    00             C      ft.stp: db	0	; Anzahl der Stepimpulse pro Spur
  E2CA    00             C      ft.sti: db	0	; Schrittzeit von Spur zu Spur
                         C      
  E2CB                   C      crcber: ds	3*9,0ffh; Ber. zum Ablegen der gelesenen/zu schreibenden CRC-Z.
                         C      			; reicht fuer 9 physische Sektoren pro Transfer
                         C      ; Fehler-Wiederholungszaehler
  E2E6    00             C      crerc: 	db	0	; CRC-Fehler
  E2E7    00             C      sperc: 	db	0	; Spur nicht gefunden
  E2E8    00             C      seerc: 	db	0	; Sektor nicht gefunden
  E2E9    00             C      lwexis: db	0	; Anzeigebyte fuer vorhandene Laufwerke
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-92


                         C      			; bit 0 = 1 LW 0 vorhanden
                         C      			; bit 2 = 1 LW 1 vorhanden
                         C      			; bit 4 = 1 LW 2 vorhanden
                         C      			; bit 6 = 1 LW 3 vorhanden
                         C      
  E2EA    00             C      alwnr: 	db	0	; alte Laufwerksnummer vom vergangenen Zugriff
                         C      			; bit 0-2 LW-Nr., bit 3 = 1 Motor laeuft noch
                         C      
  E2EB    00             C      aspnr:	db	0	; aktuelle Spur des durch alwnr bezeichneten LW
  E2EC    00 00 00 00    C      spnrl: 	db	0,0,0,0	; Tabelle der alten Spurnummern
                         C      
                         C       IF dsk8fm+dsk8mf+dsk5fm
                         C      
                         C      ; Modifizierungstaelle entspr. LW-Typ und Aufzeichnungsverfahren
                         C      ; standardmaessig ist 5" MFM, Seite 0 eingestellt
                         C      
  E2F0    0A             C      mdtbad:	db	mdtbl
  E2F1    E3E5           C      	dw	diom01		;Lesen Marke auf Seite 0 ein
  E2F3    E410           C      	dw	diomd2		;Gap-Rest Sektor/Daten
  E2F5    E23C           C      	dw	crcbeg		;CRC-Anfangswert
  E2F7    E23D           C      	dw	crcbeg+1
  E2F9    E134           C      	dw	dfrcod		;Taktfrequenzcode
  E2FB    E136           C      	dw	dpretr		;Precomp. Spur
  E2FD    E1AE           C      	dw	dtrdyw+1	;ready Wartezyklus
                         C       IF cpu eq k2526
                         C       ENDIF
                         C       if @write
  E2FF    E418           C      	dw	dioop		;Schreibroutine
  E301    E419           C      	dw	dioop+1
                         C        IF cpu eq k2526
                         C        ENDIF
                         C        if dsk8fm+dsk8mf
  E303    E517           C      	dw	diowm1+1	;Zahl der Null-Bytes nach Datenschreiben
                         C        endif
                         C       endif
  000A                   C      mdtbl	equ	($-mdtbad-1)/2
                         C      
                         C      ; MFM
                         C      ;====
  E305    85             C      mdmfm8:	db	10000101b
                         C       IF cpu eq k2526
  E306    11             C      	db	17
                         C       ENDIF
  E307    CDB4           C      	dw	0cdb4h
                         C       IF fdc eq f1715
                         C       ENDIF
                         C       IF fdc eq k5120
                         C       ENDIF
                         C       IF fdc eq k5122
  E309    00             C      	db	00000000b
                         C       ENDIF
  E30A    FF             C      	db	255
  E30B    00             C      	db	0
                         C       IF cpu eq k2526
                         C       ENDIF
                         C       if @write
  E30C    E4D9           C      	dw	diwmfm
                         C        IF cpu eq k2526
                         C        ENDIF
                         C        if dsk8fm+dsk8mf
  E30E    02             C      	db	2
                         C        endif
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-93


                         C       endif
                         C      
  E30F    85             C      mdmfm5:	db	10000101b
                         C       IF cpu eq k2526
  E310    11             C      	db	17
                         C       ENDIF
  E311    CDB4           C      	dw	0cdb4h
                         C       IF fdc eq f1715
                         C       ENDIF
                         C       IF fdc eq k5120
                         C       ENDIF
                         C       IF fdc eq k5122
  E313    04             C      	db	00000100b
                         C       ENDIF
  E314    19             C      	db	25
  E315    FB             C      	db	dtrdyz-(dtrdyw+2)
                         C       IF cpu eq k2526
                         C       ENDIF
                         C       if @write
  E316    E4D9           C      	dw	diwmfm
                         C        IF cpu eq k2526
                         C        ENDIF
                         C        if dsk8fm+dsk8mf
  E318    1C             C      	db	28
                         C        endif
                         C       endif
                         C      
                         C      ; FM
                         C      ;===
                         C       IF dsk8mf+dsk8fm+dsk5fm ; dsk8fm-Platz immer freihalten wenn danach 5" FM
  E319    87             C      mdfm8:	db	10000111b
                         C       IF cpu eq k2526
  E31A    06             C      	db	6
                         C       ENDIF
  E31B    FFFF           C      	dw	0ffffh
                         C       IF fdc eq f1715
                         C       ENDIF
                         C       IF fdc eq k5120
                         C       ENDIF
                         C       IF fdc eq k5122
  E31D    04             C      	db	00000100b
                         C       ENDIF
  E31E    FF             C      	db	255
  E31F    00             C      	db	0
                         C       IF cpu eq k2526
                         C       ENDIF
                         C       if @write
  E320    E4B3           C      	dw	diowfm
                         C        IF cpu eq k2526
                         C        ENDIF
                         C        if dsk8fm+dsk8mf
  E322    02             C      	db	2
                         C        endif
                         C       endif
                         C       ENDIF
                         C      
                         C       IF dsk5fm ; kann K5120, K5122 nicht, nur PC1715
                         C       ENDIF
                         C      
                         C       ENDIF ;nicht nur 5" MFM
                         C      
                         C      ; Modifizierungstabelle entspr. Sektorlaenge
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-94


                         C      
  E323    09             C      dslnmt:	db	dslnl		;Tabellenlaenge
  E324    E24A           C      	dw	fl.tsb		;Anzahl der 128er Bloecke
  E326    E480           C      	dw	diosl1		;Laenge erstes INIR
                         C       IF cpu eq k2526
  E328    E48C           C      	dw	dini1+1		;INI oder INIR
  E32A    E48F           C      	dw	dini2+1
  E32C    E492           C      	dw	dini3+1
                         C       ENDIF
                         C       if @write
  E32E    E506           C      	dw	diosl2		;Laenge erstes OTIR
                         C        IF cpu eq k2526
  E330    E509           C      	dw	doti1+1		;OUTI oder OTIR
  E332    E50B           C      	dw	doti2+1
  E334    E50D           C      	dw	doti3+1
                         C        ENDIF
                         C       endif
  0009                   C      dslnl	equ	($-dslnmt-1)/2	;Tabellenlaenge
                         C      
                         C      ; 128
  E336    01             C      dsln0:	db	1
                         C       IF cpu eq k2526
  E337    80 A2 A2 A2    C      	db	128,0a2h,0a2h,0a2h
                         C       ENDIF
                         C       if @write
                         C        IF cpu eq k2526
  E33B    80 A3 A3 A3    C      	db	128,0a3h,0a3h,0a3h
                         C        ENDIF
                         C       endif
                         C      
                         C      ; 256
  E33F    02             C      dsln1:	db	2
                         C       IF cpu eq k2526
  E340    00 A2 A2 A2    C      	db	0,0a2h,0a2h,0a2h
                         C       ENDIF
                         C       if @write
                         C        IF cpu eq k2526
  E344    00 A3 A3 A3    C      	db	0,0a3h,0a3h,0a3h
                         C        ENDIF
                         C       endif
                         C      
                         C      ; 512
  E348    04             C      dsln2:	db	4
                         C       IF cpu eq k2526
  E349    00 A2 A2 B2    C      	db	0,0a2h,0a2h,0b2h
                         C       ENDIF
                         C       if @write
                         C        IF cpu eq k2526
  E34D    00 A3 A3 B3    C      	db	0,0a3h,0a3h,0b3h
                         C        ENDIF
                         C       endif
                         C      
                         C      ; 1024
  E351    08             C      dsln3:	db	8
                         C       IF cpu eq k2526
  E352    00 B2 B2 B2    C      	db	0,0b2h,0b2h,0b2h
                         C       ENDIF
                         C       if @write
                         C        IF cpu eq k2526
  E356    00 B3 B3 B3    C      	db	0,0b3h,0b3h,0b3h
                         C        ENDIF
                         C       endif
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-95


                         C      
                         C       IF dskds
                         C      ; Modifizierungsadressen fuer Seitenauswahl
  E35A    09             C      dsidmt:	db	dsidtl		; MFM		 FM
  E35B    E3E5           C      	dw	diom01		;85/81		87/83
                         C       IF cpu eq k2526
  E35D    E391           C      	dw	diom02		;a5/a1		a5/a1
  E35F    E3E1           C       	dw	diom03		;b5/b1		b5/b1
  E361    E3D1           C      	dw	diom13		;bd/b9		bd/b9
                         C       ENDIF
                         C       if @write
                         C        IF dsk8fm+dsk5fm
                         C        ENDIF
  E363    E4DF           C      	dw	diom07		;b4/b0		 -
  E365    E4F1           C      	dw	diom08		;b6/b2		 -
  E367    E4FB           C      	dw	diom09		;b4/b0		 -
                         C       endif
  E369    E478           C      	dw	diom10		;b5/b1		b5/b1
                         C      ;;diom11 muss letztes Byte in der Tabelle sein
  E36B    E51D           C      	dw	diom11		;b5/b1		b5/b1
  0009                   C      dsidtl	equ	($-dsidmt-1)/2
                         C       ENDIF
                         C      	include BIOSDSKP
                         C      ;****************************************************************
                         C      ; Treiber fuer Ansteuerung K5120/K5122 ueber K2526 (mit Hilfsprozessor)
                         C      ; 04.06.87
                         C      ; - Fehlerkorrektur 8" MFM (Taktzeiten)
                         C      ; 25.09.89
                         C      ; - wegen MFS 1.2 nach Transfer b1 (= fault reset) als Standardwert
                         C      ;****************************************************************
                         C      
  E36D                   C      diorun:
  E36D    2A E2C1        C      	ld	hl,(ft.adr)
  E370    22 E3B9        C      	ld	(diodma),hl
                         C      
                         C      ; physischen Transfer ueber CPU 2 starten
                         C      
  E373    21 E3B4        C      	ld	hl,dio
  E374                   C      diortn	equ	$-2
  E376    ED 4B 0001     C      	ld	bc,(1)		;retten HS 1
  E37A    22 0001        C      	ld	(1),hl		;CPU 2 -Routine
  E37D    3E FE          C      	ld	a,0feh
  E37F    32 E3A4        C      	ld	(dtrret),a	;stellen Warte-Reaktion
  E382    AF             C      	XOR	A
  E383    D3 14          C      	OUT	(fldaad),A
  E385    D3 04          C      	OUT	(04H),A		;reset CPU 2
  E387    3D             C      	dec	a		;Mode 3 (Bit E/A)
  E388    D3 17          C      	OUT	(fldabc),A
  E38A    D3 17          C      	OUT	(fldabc),A	;alles Input
  E38C    3E B9          C      	ld	a,10111001b	;AMF aus, Fault reset
  E38E    D3 10          C      	out	(flcoad),a
  E390    3E A5          C      	LD	A,10100101b	;Seite einstellen, Mark reset, AMF aktiv
  E391                   C      diom02	equ	$-1		;a5/a1
  E392    D3 10          C      	OUT	(flcoad),A
  E394    3E 7F          C      	LD	A,7FH		;Mode 1
  E396    D3 17          C      	OUT	(fldabc),A
  E398    DB 16          C      	IN	A,(fldabd)	;CPU2 starten (ueber BUSRQ)
                         C      ; durch die Anfangsinitialisierung der CPU2 vergehen die notwendigen
                         C      ; 100 Mikrosek. fuer Seitenumschaltung
  E39A    ED 43 0001     C      	ld	(1),bc		;HS 1 wiederherst.
  E39E    3A E3E5        C      	LD	A,(diom01)	;Lesen Marke
  E3A1    D3 10          C      	OUT	(flcoad),A	;weiter bei CPU2 nach Anfangsinit.
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-96


                         C      ; Achtung!! Zur Synchronisation CPU1 und CPU2 keine 2-Byte-Werte
                         C      ; (Adressen) verwenden, da dazwischen BUSRQ auftreten kann und dann
                         C      ; nur ein Byte gesetzt wurde!!
  E3A3    18 FE          C      	jr	$		;auf CPU 2 Ende warten
  E3A4                   C      dtrret	equ	$-1
  E3A5                   C      dtrwjr:
  E3A5    C3 E215        C      dtrtor:	jp	fl.to1		;time out
  E3A8    C3 E1BB        C      dtrner:	jp	noerr		;fehlerfrei (Sekt.id)
  E3AB    C3 E1F6        C      dtrnsr:	jp	serrx		;Sektor nicht gefunden
  E3AE    C3 E1D5        C      dtrrdr:	jp	dtrrde		;Read Ende
  E3B1    C3 E1C9        C      dtrwrr:	jp	dtrwre		;Write Ende
                         C      ;--------------------------
                         C      
                         C      
                         C      ; Code CPU 2 fuer phys. Diskettentransfer
                         C      ;========================================
                         C      ; Zeitbedingungen fuer 8" MFM:
                         C      ; 6 Umdrehungen pro Sec bei 2*5208 Bytes pro Spur bedeutet
                         C      ; 1/(6*2*5208), d.h. 16 Mikrosec pro Byte!!
                         C      ; Bei einer Taktfrequenz von (9600*256)=2457600 Hz sind das
                         C      ; (9600*256)/(6*2*5208) Takte, d.h. max. 39 Takte pro Byte!!
                         C      ; Wegen BUSRQ/BUSAK muss davon der laengste Maschinenzyklus
                         C      ; der CPU 1 abgezogen werden, d.h. 6 Takte (Interruptannahme),
                         C      ; weiterhin je ein Takt fuer BUSRQ/BUSAK-Umschaltung,
                         C      ; es verbleiben 31 Takte zwischen den E/A-Maschinenzyklen!!
                         C      
                         C      ; normaler Entry in phys. Diskettentransfer
                         C      ;==========================================
  E3B4                   C      dio:	
  E3B4    AF             C      	xor	a		;wiederherstellen 'jr diokl'
  E3B5    32 E3ED        C      	ld	(diomd1+1),a
  E3B8    21 0000        C      	ld	hl,0
  E3B9                   C      diodma	equ	$-2		;Transferadresse
  E3BB    3E 00          C      	ld	a,0
  E3BC                   C      secan1	equ	$-1		;a':=Zahl zu transfer. phys. Sekt.
  E3BD    08             C      	ex	af,af'
  E3BE    11 E2CB        C      	ld	de,crcber	;auf Beginn Datenbyte-/CRC-Vektor
  E3C1    D9             C      dio2:	exx
  E3C2    01 00FF        C      	ld	bc,000ffh	;bc':= Spur, Seite
  E3C3                   C      sidtr	equ	$-2
  E3C4                   C      sidsid	equ	$-1
  E3C5    21 FFFF        C      	ld	hl,0ffffh	;hl':= Sektor, Sektlngflag
  E3C6                   C      sidsec	equ	$-2
  E3C7                   C      sidlen	equ	$-1
  E3C8    11 FEA1        C      	ld	de,0fea1h	;de':= Sektorid-Byte, Kluftbyte
  E3CB    3E 3C          C      	ld	a,60		;Wiederholungszaehler falscher Sektid.
  E3CD    32 E2E8        C      	ld	(seerc),a	;fuer ersten Sektor stellen
  E3D0    3E BD          C      diostp:	ld	a,10111101b	;bd/b9, AMF aus, Seite bleibt (>=100 Mikros.)
  E3D1                   C      diom13	equ	$-1
  E3D2    D3 10          C      	out	(flcoad),a	;Ende CPU2
  E3D4    18 12          C      	jr	diogo		;Fortsetzung nach Anfangsinit
                         C      
  E3D6                   C      dionss:
  E3D6    3E 3C          C      	ld	a,60		;Wiederholungszaehler falscher Sektid.
  E3D8    32 E2E8        C      	ld	(seerc),a	;fuer naechsten Sektor setzen
  E3DB                   C      diomr:
  E3DB    3E 05          C      	ld	a,5		;verhindern unendl. Schleife
  E3DD    32 E289        C      	ld	(fl.zto),a	;bei fehlender Sektor-Marke
  E3E0    3E B5          C      diomrk:	ld	a,10110101b	;b5/b1 MFM; b5/b1 FM
  E3E1                   C      diom03	equ	$-1		;Mark reset, lesen 1
  E3E2    D3 10          C      	out	(flcoad),a
  E3E4    3E 85          C      	ld	a,10000101b	;85/81 MFM; 87/83 FM
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-97


  E3E5                   C      diom01	equ	$-1		;Lesen Marke entspr. Aufzverf.
  E3E6    D3 10          C      	out	(flcoad),a
  E3E8    DB 16          C      diogo:	in	a,(fldabd)
  E3EA    D3 14          C      	out	(fldaad),a
  E3EC    18 00          C      diomd1:	jr	diomd1+2	;wird modifiziert mit 'jr diotrr',
                         C      				;wenn Sektorid zu lesen
  E3EE    DB 16          C      diokl:	in	a,(fldabd)
  E3F0    BB             C      	cp	e		;'A1', d.h. noch in Kluft?
  E3F1    28 FB          C      	jr	z,diokl		;ja
  E3F3    BA             C      	cp	d		;'FE', d.h. Sektorbeginn?
  E3F4    DB 16          C      	in	a,(fldabd)
  E3F6    20 E8          C      	jr	nz,diomrk	;nein, weitersuchen
  E3F8    B9             C      	cp	c		;Spur ok?
  E3F9    DB 16          C      	in	a,(fldabd)
  E3FB    20 5D          C      	jr	nz,serr		;nein, falscher Sektid.
  E3FD    B8             C      	cp	b		;Seite ok?
  E3FE    DB 16          C      	in	a,(fldabd)
  E400    20 58          C      	jr	nz,serr		;nein, falscher Sektid.
  E402    BD             C      	cp	l		;Sektor ok?
  E403    DB 16          C      	in	a,(fldabd)
  E405    20 53          C      	jr	nz,serr		;nein, falscher Sektid.
  E407    BC             C      	cp	h		;Sekt-Laengencode?
  E408    DB 16          C      	in	a,(fldabd)	;**ignorieren CRC Sektid**
  E40A    20 4E          C      	jr	nz,serr		;nein, falscher Sektid.
  E40C    D9             C      	exx
  E40D    DB 16          C      	in	a,(fldabd)	;**ignorieren CRC Sektid**
  E40F    06 11          C      	ld	b,17		;Zahl zu uebergeh. Bytes
  E410                   C      diomd2	equ	$-1		;bei DD auf 17, bei SD auf 6
  E411    DB 16          C      diosyn:	in	a,(fldabd)	;Bytes ignorieren
  E413    10 FC          C      	djnz	diosyn
  E415    DB 16          C      	in	a,(fldabd)
  E417    C3 E46F        C      	jp	diord
  E418                   C      dioop	equ	$-2		;wird modifiziert entspr. Oper.
                         C      ;				 mit diord, diwmfm, diowfm
                         C      
                         C      ; Entry fuer phys. Treiber zum Lesen Sekt.-Id. auf akt. Spur
                         C      ;===========================================================
  E41A    3E 39          C      diotsr:	ld	a,diotrr-(diomd1+2)	;jr diotrr
  E41C    32 E3ED        C      	ld	(diomd1+1),a	;modifizieren
  E41F    01 0316        C      	ld	bc,3*256+fldabd	;Lesen 3 Bytes Sektorid
  E422    21 E2C5        C      	ld	hl,ft.trk+1	;dorthin Sektorid hinterlegen
  E425    18 9A          C      	jr	dio2		;Einsprung in phys. Treiber
  E427                   C      diotrr:
  E427    DB 16          C      diotr0:	in	a,(fldabd)
  E429    BB             C      	cp	e		;'A1', d.h. noch in Kluft?
  E42A    28 FB          C      	jr	z,diotr0	;ja
  E42C    BA             C      	cp	d		;'FE', d.h. Sektorbeginn?
  E42D    DB 16          C      	in	a,(fldabd)	;wenn ja, so ist das die Spur
  E42F    20 AF          C      	jr	nz,diomrk	;nein, weitersuchen
  E431    D9             C      	exx
  E432    ED B2          C      	inir			;Sektorid lesen
  E434    D9             C      	exx
  E435    6F             C      	ld	l,a		;Spur retten
  E436    3A E3E1        C      	ld	a,(diom03)
  E439    D3 10          C      	out	(flcoad),a	;Lesen 1
  E43B    7D             C      	ld	a,l
  E43C    B9             C      	cp	c		;richtige Spur?
  E43D    28 09          C      	jr	z,diotr1	;ja
  E43F    3A E2C5        C      	ld	a,(ft.sid)
  E442    90             C      	sub	b		;stimmt side?
  E443    20 0B          C      	jr	nz,diotre	;nein, dies ist kein Sektid.
  E445    B9             C      	cp	c		;war Spur 0 gefordert?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-98


  E446    28 23          C      	jr	z,serr2		;ja, nachjustieren (ft.trk steht noch)
  E448    7D             C      diotr1:	ld	a,l
  E449    32 E2C4        C      	ld	(ft.trk),a	;(tatsaechliche) Spur aus Sekt.Id.
  E44C    3E 03          C      	ld	a,dtrner-dtrwjr	;Reaktionsroutine
  E44E    18 5D          C      	jr	dioend		;Abschlussbehandlung
  E450    D9             C      diotre:	exx
  E451    01 0316        C      	ld	bc,3*256+fldabd	;Lesen 3 Bytes Sektorid
  E454    21 E2C5        C      	ld	hl,ft.trk+1	;dorthin Sektorid hinterlegen
  E457    D9             C      	exx
  E458    18 07          C      	jr	serr1
                         C      ;---------------------------
                         C      
                         C      ; Fehlerausgaenge
                         C      ;----------------
                         C      ; falscher Sektorid.
  E45A    DB 16          C      serr:	in	a,(fldabd)
  E45C    3A E3E1        C      	ld	a,(diom03)	;Lesen 1
  E45F    D3 10          C      	out	(flcoad),a
  E461    3A E2E8        C      serr1:	ld	a,(seerc)
  E464    3D             C      	dec	a		;blieb weiterer Versuch?
  E465    32 E2E8        C      	ld	(seerc),a
  E468    C2 E3DB        C      	jp	nz,diomr	;ja
  E46B    3E 06          C      serr2:	ld	a,dtrnsr-dtrwjr	;Sektor nicht gefunden
  E46D    18 3E          C      	jr	dioend
                         C      
                         C      ; Lesen
                         C      ;-------
  E46F    DB 16          C      diord:	in	a,(fldabd)
  E471    06 06          C      	ld	b,6
  E473    DB 16          C      diords:	in	a,(fldabd)	;uebergehen Synchron-Bytes
  E475    10 FC          C      	djnz	diords
  E477    3E B5          C      	ld	a,10110101b	;b5/b1
  E478                   C      diom10	equ	$-1
  E479    D3 10          C      	out	(flcoad),a	;Lesen 1
  E47B    3A E3E5        C      	ld	a,(diom01)	;85/81 MFM; 87/83 FM
  E47E    01 8016        C      	ld	bc,128*256+fldabd ;b:=inir-Laenge
  E480                   C      diosl1	equ	$-1		  ;   128 bei Sektl 128, sonst =0
  E481    D3 10          C      	out	(flcoad),a	;Lesen Marke
  E483    DB 16          C      	in	a,(fldabd)	;ignorieren evtl. anstehenden Muell
  E485    DB 16          C      diorkl:	in	a,(fldabd)
  E487    FE A1          C      	cp	0a1h		;noch in Kluft?
  E489    28 FA          C      	jr	z,diorkl	;ja
  E48B    ED A2          C      dini1:	ini			;Daten lesen
  E48D    12             C      	ld	(de),a		;Datenbeginn-Byte hinterlegen
  E48E    ED A2          C      dini2:	ini
  E490    13             C      	inc	de
  E491    ED A2          C      dini3:	ini
  E493    ED B2          C      	inir
  E495    EB             C      	ex	de,hl
  E496    ED A2          C      	ini			;CRC Daten
  E498    ED A2          C      	ini
  E49A    3A E51D        C      	ld	a,(diom11)	;b1 fuer MFS 1.2 Fault reset, sonst b5/b1
  E49D    D3 10          C      	out	(flcoad),a	;Lesen 1
  E49F    EB             C      	ex	de,hl
  E4A0    3E 09          C      	ld	a,dtrrdr-dtrwjr	;Reaktionsroutine Read Ende
                         C      
                         C      ; naechsten Sektor behandeln
                         C      ;---------------------------
  E4A2    08             C      dions:	ex	af,af'		;Zahl zu uebertr. Sektoren
  E4A3    3D             C      	dec	a
  E4A4    28 06          C      	jr	z,dionse	;=0, fertig
  E4A6    08             C      	ex	af,af'
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-99


  E4A7    D9             C      	exx
  E4A8    2C             C      	inc	l		;Sektor+1
  E4A9    C3 E3D6        C      	jp	dionss
  E4AC    08             C      dionse:	ex	af,af'
                         C      
                         C      ; Abschlussbehandlung
                         C      ;--------------------
  E4AD                   C      dioend:
  E4AD    32 E3A4        C      	ld	(dtrret),a	;Reaktionsroutine hinterlegen
  E4B0    C3 E3D0        C      	jp	diostp		;Stop CPU2
                         C      
                         C       IF @write
                         C      
                         C       IF dsk8fm+dsk8mf+dsk5fm
                         C      
                         C      ; Schreiben FM
                         C      ;-------------
  E4B3    DB 16          C      diowfm:	in	a,(fldabd)
  E4B5    EB             C      	ex	de,hl
  E4B6    DB 16          C      	in	a,(fldabd)
  E4B8    01 A410        C      	ld	bc,10100100b*256+flcoad
  E4BA                   C      diom04	equ	$-1		;a4/a0
  E4BB    DB 16          C      	in	a,(fldabd)
  E4BD    ED 41          C      	out	(c),b		;Schreiben FM Daten ein
  E4BF    DB 16          C      	in	a,(fldabd)
  E4C1    AF             C      	xor	a
  E4C2    D3 14          C      	out	(fldaad),a	;6*'00'
  E4C4    01 0414        C      	ld	bc,4*256+fldaad
  E4C7    D3 14          C      diowfs:	out	(fldaad),a
  E4C9    10 FC          C      	djnz	diowfs
  E4CB    3E B6          C      	ld	a,10110110b
  E4CC                   C      diom05	equ	$-1		;b6/b2
  E4CD    ED 41          C      	out	(c),b
  E4CF    D3 10          C      	out	(flcoad),a	;schreiben FM Marke ein
  E4D1    3E A4          C      	ld	a,10100100b
  E4D2                   C      diom06	equ	$-1		;a4/a0
  E4D3    ED A3          C      	outi			;'FB'	
  E4D5    D3 10          C      	out	(flcoad),a	;schreiben FM Daten ein
  E4D7    18 2C          C      	jr	diowrt
                         C       ENDIF
                         C      
                         C      
                         C      ; Schreiben  MFM
                         C      ;---------------
  E4D9    DB 16          C      diwmfm:	in	a,(fldabd)
  E4DB    DB 16          C      	in	a,(fldabd)
  E4DD    01 B410        C      	ld	bc,10110100b*256+flcoad
  E4DF                   C      diom07	equ	$-1		;b4/b0
  E4E0    DB 16          C      	in	a,(fldabd)
  E4E2    ED 41          C      	out	(c),b		;Schreiben MFM normal
  E4E4    DB 16          C      	in	a,(fldabd)
  E4E6    AF             C      	xor	a
  E4E7    D3 14          C      	out	(fldaad),a	; 1*'00'
  E4E9    01 0A14        C      	ld	bc,10*256+fldaad
  E4EC    D3 14          C      diwmfs:	out	(fldaad),a	;10*'00'
  E4EE    10 FC          C      	djnz	diwmfs
  E4F0    3E B6          C      	ld	a,10110110b
  E4F1                   C      diom08	equ	$-1		;b6/b2
  E4F2    ED 41          C      	out	(c),b		; 1*'00'
  E4F4    D3 10          C      	out	(flcoad),a	;Schreiben MFM Marke
  E4F6    06 A1          C      	ld	b,0a1h
  E4F8    ED 41          C      	out	(c),b		;3*'A1'
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-100


  E4FA    3E B4          C      	ld	a,10110100b
  E4FB                   C      diom09	equ	$-1		;b4/b0
  E4FC    ED 41          C      	out	(c),b
  E4FE    EB             C      	ex	de,hl
  E4FF    ED 41          C      	out	(c),b
  E501    D3 10          C      	out	(flcoad),a	;Schreiben MFM normal
  E503    ED A3          C      	outi			;'FB'
                         C      
  E505    06 80          C      diowrt:	ld	b,128		;Laenge erster OTIR-Block
  E506                   C      diosl2	equ	$-1		;128 bei Sektl 128, sonst 0
  E507    EB             C      	ex	de,hl
  E508    ED A3          C      doti1:	outi			;Daten ausgeben
  E50A    ED A3          C      doti2:	outi
  E50C    ED A3          C      doti3:	outi
  E50E    ED B3          C      	otir
  E510    EB             C      	ex	de,hl
  E511    ED A3          C      	outi			;CRC Daten
  E513    AF             C      	xor	a
  E514    ED A3          C      	outi
  E516    06 14          C      diowm1:	ld	b,20		;Anzahl der Nach-Null-Bytes
                         C      				;5" MFM/FM: 20; 8" MFM/FM: 2
  E518    D3 14          C      diow00:	out	(fldaad),a	;'00'
  E51A    10 FC          C      	djnz	diow00
  E51C    3E B1          C      	ld	a,10110001b	;b1 fuer MFS 1.2 Fault reset, sonst b5/b1
  E51D                   C      diom11	equ	$-1
  E51E    D3 10          C      	out	(flcoad),a	;Schreiben aus, Lesen 1
  E520    EB             C      	ex	de,hl
  E521    3E 0C          C      	ld	a,dtrwrr-dtrwjr	;Schreiben OK Reaktion
  E523    C3 E4A2        C      	jp	dions		;naechster Sektor
                         C      
                         C      	ENDIF	;@write
                                 ENDIF
                                 IF hdsk
                                 ENDIF
                                 IF oss
                                 ENDIF
                                 IF em256
                         C      	include BIOSREM		;RAM-Floppy mit EM256
                         C      ;********************************************************
                         C      ;	RAM-Floppy mit EM256 Erweiterungsmodul (16 Bit mit U8000)
                         C      ; Version 15.05.87
                         C      ;********************************************************
                         C      
                         C       if1
                         C       endif ;if1
                         C      
                         C      ;**************************************************************
                         C      ;	Schreiben RAM-Floppy
                         C      ;**************************************************************
  E526                   C      wrramf:
  E526    2A DFBC        C      	ld 	hl,(ddma)
  E529    01 0080        C      	ld 	bc,128		;128 Byte von DMA nach Puffer
  E52C    11 F2C7        C      	ld 	de,dmabuf
  E52F    ED B0          C      	ldir
  E531    3A DFB7        C      	ld	a,(dtrack)
  E534    CD E56C        C      	call 	ramon		;Testram / EM256 zuschalten
  E537    C5             C      	push 	bc
  E538    EB             C      	ex 	de,hl
  E539    01 0080        C      	ld 	bc,128
  E53C    21 F2C7        C      	ld 	hl,dmabuf	;128 byte von Puffer nach RAM-Floppy
  E53F    ED B0          C      	ldir
  E541    C1             C      	pop 	bc
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-101


  E542    CD E59F        C      	call	ramoff
                         C      	IF	em256
  E545    3A E5C4        C      	ld	a,(parerr)
                         C      	ENDIF
  E548    C9             C      	ret
                         C      
                         C      ;**************************************************************
                         C      ;	Lesen RAM-Floppy
                         C      ;**************************************************************
                         C      
  E549                   C      rdramf:
  E549    3A DFB7        C      	ld	a,(dtrack)
  E54C    CD E56C        C      	call 	ramon		;Testram aktivieren
  E54F    C5             C      	push 	bc
  E550    01 0080        C      	ld 	bc,128		;128 Byte 
  E553    11 F2C7        C      	ld 	de,dmabuf	;nach Puffer
  E556    ED B0          C      	ldir
  E558    C1             C      	pop 	bc
  E559    CD E59F        C      	call 	ramoff		;Testram abschalten
  E55C    21 F2C7        C      	ld 	hl,dmabuf	;von Puffer nach DMA uebertragen
  E55F    01 0080        C      	ld 	bc,128
  E562    ED 5B DFBC     C      	ld 	de,(ddma)
  E566    ED B0          C      	ldir
                         C      	IF	em256
  E568    3A E5C4        C      	ld	a,(parerr)
                         C      	ENDIF
  E56B    C9             C      	ret
                         C      
                         C      ;********************************************************************
                         C      ;	Unterprogramme fuer RAM-Floppy
                         C      ;********************************************************************
                         C      
                         C      ;Routinen fuer EM256-RAM-Floppy
                         C      ;==============================
                         C      ;
                         C      ;Aktivieren / Deaktivieren der RAM des EM256
                         C      ;Eintritt: <A> - Tracknummer, <dsectr> - Sektornummer
                         C      ;Austritt: <DE>- Anfangsadresse des Sektors
                         C      ;
  E56C    57             C      ramon:	ld	d,a		;<a>=  0  0 S1 S0 P3 P2 P1 P0
  E56D    0F             C      	rrca			;          Segment   Page   
  E56E    0F             C      	rrca
  E56F    0F             C      	rrca
  E570    0F             C      	rrca			;<a>= P3 P2 P1 P0  0  0 S1 S0
  E571    E6 3F          C      	and	3fh		;   =  0  0 P1 P0  0  0 S1 S0
  E573    F6 40          C      	or	high(hbemadr)	;   = H3 H2 P1 P0  0  0 S1 S0
  E575    47             C      	ld	b,a		;H3,H2 sind ext. Adresse!!
  E576    7A             C      	ld	a,d
  E577    2F             C      	cpl
  E578    E6 0C          C      	and	0ch		;<a>=  0  0  0  0 /P3/P2  0  0
  E57A    B0             C      	or	b		;   = H3 H2 P1 P0 /P3/P2 S1 S0
  E57B    47             C      	ld	b,a		;Low-Nibble gleichgueltig (retten)
  E57C    0E AF          C      	ld 	c,modadr+7	;Adressierung 16*4-RAM
  E57E    E6 0C          C      	and	0ch		;<a>=  0  0  0  0 /P3/P2  0  0     
                         C      				;EM256 erkennt sich auf em256adr
                         C      				;Write enable, Page enable
  E580    ED 79          C      	out	(c),a
  E582    78             C      	ld	a,b
  E583    E6 03          C      	and	3		;Segmentnummer
  E585    F6 10          C      	or	1 shl reset16	;U8000-Reset, RAM-Enable
  E587    D3 A9          C      	out	(modadr+1),a	;RAM scharf
  E589    78             C      	ld	a,b
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-102


  E58A    E6 F0          C      	and	0f0h
  E58C    57             C      	ld 	d,a		;Page erscheint auf Adr. in DE
  E58D    AF             C      	xor 	a
  E58E    5F             C      	ld	e,a
  E58F    32 E5C4        C      	ld	(parerr),a	;Paritaetsfehler reset
  E592    3A DFB9        C      	ld	a,(dsectr)	;offset aus Sektornummer berechnen
  E595    3D             C      	dec	a
  E596    67             C      	ld 	h,a
  E597    2E 00          C      	ld	l,0
  E599    CB 3C          C      	srl	h
  E59B    CB 1D          C      	rr	l		
  E59D    19             C      	add	hl,de		;Offset zu Track(Page)Adresse addieren
  E59E    C9             C      	ret
  E59F    78             C      ramoff:	ld a,b
  E5A0    E6 0C          C      	and	0ch
  E5A2    F6 03          C      	or	1 shl n_pagen or 1 shl n_write	;page disable, write disable
  E5A4    ED 79          C      	out 	(c),a
  E5A6    3E 14          C      	ld	a,1 shl reset16 or 1 shl n_ramen
  E5A8    D3 A9          C      	out	(modadr+1),a
  E5AA    C9             C      	ret
                         C      
  E5AB    32 E5C3        C      parrou:	ld	(rettea),a	;Interruptbedienung Paritaetsfehler
  E5AE    3E 01          C      	ld	a,1		;benoetigt keinen eigenen Stack
  E5B0    32 E5C4        C      	ld	(parerr),a	;Kennung Fehler
  E5B3    DB A9          C      	in	a,(modadr+1)
  E5B5    CB F7          C      	set	prreset,a
  E5B7    D3 A9          C      	out	(modadr+1),a	;Fehler ruecksetzen
  E5B9    CB B7          C      	res	prreset,a
  E5BB    D3 A9          C      	out	(modadr+1),a
  E5BD    3A E5C3        C      	ld	a,(rettea)
  E5C0    FB             C      	ei
  E5C1    ED 4D          C      	reti
                         C      
  E5C3    00             C      rettea:	db	0		;A bei Parityinterrupt
  E5C4    00             C      parerr:	db	0		;Paritaetsfehlerspeicher
                         C      
                         C      
                         C      ;*************************************************************
                         C      ; Steuertabellen fuer RAM-Floppy
                         C      ;*************************************************************
                         C      
  E5C5                   C      dphem:
  E5C5    0000           C      dphm:	dw	0	;kein Sektorversatz
  E5C7    0000 0000      C      	dw	0,0,0
  E5CB    0000           C      
  E5CD    F0F7           C      	dw	dirbuf
  E5CF    E5D5 0000      C      	dw	dpbem,0,alvem
  E5D3    F2A7           C      
                         C      
  E5D5                   C      dpbem:
  E5D5    0020           C      dpbm:	dw	32	;Recs per Track
  E5D7    03 07 00       C      	db	3,7,0	;1k-BDOS-Bloecke 
  E5DA    00FF           C      	dw	256-1	;256k
  E5DC    003F           C      	dw	64-1	;64 Dir-.Eintraege
  E5DE    C0 00          C      	db	0c0h,0	;Alloc. fuer 64 Dir.
  E5E0    0000           C      	dw	0	;kein check
  E5E2    0000           C      	dw	0	;Offset: keine Systemspuren
  E5E4    80             C      	db	80h	;kein Disketten-DPB
                         C      
  E5C5                   C      dpham	aset	dphm		;definieren LW "M:"
                                 ENDIF
                                 IF mkd256
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-103


                                 ENDIF
                                 IF kes
                                 ENDIF
                                 IF raf
                                 ENDIF
                                 IF rna
                                 ENDIF
                                
                         C      	include BIOSTIM
                         C      ;*************************************************************
                         C      ;	Zeitgeberdienst
                         C      ; 15.06.88
                         C      ; - BAB2 als Standard
                         C       IF cpu eq c1715
                         C       ENDIF
                         C      ; - zusaetzliche Laufwerksabschaltung ueber Zeittakt eingefuehrt
                         C      ; - Abfrage von 'synsem' in 1-sec-Interrupt entfernt (kein setbs/setram notw.)
                         C      ; 24.09.88
                         C      ; - Bildschirmpuffer kann ausserhalb des normalen RAM's liegen
                         C      ; 09.10.88
                         C      ; - Pflege der Statuszeile nur bei stzaus=0
                         C      ; 23.12.88
                         C      ; - Einbau der Pflege des Datums
                         C      ; 07.01.89
                         C      ; - Tastaturpolling nur wenn Zugriff zur Statuszeile erlaubt
                         C      ; 20.03.89
                         C      ; - Laufwerksabschaltung ueber Zeittakt nur bei FDC K5120/22 und F1715
                         C      ;*************************************************************
                         C      
                         C       IF1
                         C       ENDIF
                         C      
                         C      ; 5ms/25ms an
  E5E5                   C      tim5on:
                         C       IF cpu eq c1715
                         C       ENDIF
  E5E5    3E B1          C      	ld	a,10110001b
                         C      	;int./zeitg./vort.256/pos.flanke/naechst.zykl./keine zk/weiter/1
  E5E7    F3             C      tim5ot:	DI
  E5E8    D3 0E          C      	out	(sysctc+tim5ct),a
  E5EA    FB             C      	EI
  E5EB    C9             C      ret:	ret
                         C      
                         C      ; 5ms/25ms aus
  E5EC                   C      tim5of:
                         C       IF cpu eq c1715
                         C       ENDIF
  E5EC    3E 31          C      	ld	a,00110001b	;kein int./...
  E5EE    18 F7          C      	jr	tim5ot
                         C      
                         C       IF cpu eq c1715
                         C       ELSE
                         C      ; 1s an
  E5F0    3E D1          C      tim1on:	ld	a,11010001b
                         C      	;int./zaehler//pos.flanke//keine zk/weiter/1
  E5F2    F3             C      tim1ot:	DI
  E5F3    D3 0F          C      	out	(sysctc+tim1ct),a
  E5F5    FB             C      	EI
  E5F6    C9             C      	ret
                         C      ; 1s aus
  E5F7    3E 51          C      tim1of:	ld	a,01010001b	;kein int./...
  E5F9    18 F7          C      	jr	tim1ot
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-104


                         C       ENDIF
                         C      
                         C      ; Interr.routine 5ms/25ms
  E5FB                   C      tim5it:
                         C       IF stpvar or monitor
  E5FB    22 E603        C      	ld	(t5ihl),hl	;retten hl
  E5FE    21 E6F7        C      	ld	hl,chksp	;Test auf haengende Spezialfktnen
  E601    E5             C      	push	hl		;nach const-Aufruf in CTC-Interrupt
  E602    21 0000        C      	ld	hl,0		;wiederherstellen hl
  E603                   C      t5ihl	equ	$-2
                         C       ENDIF
  E605    ED 73 E624     C      	ld	(intsp),sp
  E609    31 F0F7        C      	ld	sp,intstk
  E60C    F5             C      	push	af
  E60D    E5             C      	push	hl
  E60E    D5             C      	push	de
  E60F    C5             C      	push	bc
  E610    2A 0041        C      	ld	hl,(tim5cn)
  E613    23             C      	inc	hl
  E614    22 0041        C      	ld	(tim5cn),hl
                         C       IF cpu eq c1715
                         C       ENDIF
  E617    3A D03D        C      	ld	a,(synflg)
  E61A    CB 77          C      	bit	stzaus,a	;Zugriff zur Statuszeile erlaubt?
  E61C    CC D171        C      intkbd:	call	z,kbdsti	;ja, Tastatur abfragen und puffern
                         C      				;auf 'ld hl,.. .' waehrend Lampen-Ausgabe
  E61F                   C      intrbc:				;allg. Interr.-ausgang
  E61F    C1             C      	pop	bc
  E620    D1             C      	pop	de
  E621                   C      intrhl:				;allg. Interr.-ausgang
  E621    E1             C      	pop	hl
  E622                   C      intraf:				;allg. Interr.-ausgang
  E622    F1             C      	pop	af
  E623    31 0000        C      	ld	sp,0
  E624                   C      intsp	equ	$-2
  E626                   C      intret:				;allg. Interr.-ausgang
  E626    FB             C      	ei
  E627    ED 4D          C      	reti
                         C      
                         C       IF cpu ne c1715
                         C      ; Interr.routine 1s
  E629    ED 73 E624     C      tim1it:	ld	(intsp),sp
  E62D    31 F0F7        C      	ld	sp,intstk
  E630    F5             C      	push	af
  E631    E5             C      	push	hl
  E632    D5             C      	push	de
  E633    C5             C      	push	bc
  E634    CD E639        C      	call	tim1up
  E637    18 E6          C      	jr	intrbc
                         C       ENDIF
                         C      
                         C      ; Reaktionsroutine fuer 1 sec Interrupt
  E639    2A 0043        C      tim1up:	ld	hl,(tim1cn)
  E63C    2B             C      	dec	hl
  E63D    22 0043        C      	ld	(tim1cn),hl
                         C       IF uhrvar
                         C       ENDIF
  E640    3A E61C        C      	ld	a,(intkbd)	;lampen aktiv?
  E643    FE 21          C      	cp	021h		;  call-Befehl oder ld hl,...
  E645    C4 D2CA        C      	call	nz,lampen	;nein, Aktualisierung Lampen
                         C      
  E648    21 E64B        C      intcrt:	ld	hl,tim1uu	;auf jp,... waehrend conout
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-105


                         C      
                         C       IF cpastz or uhrvar
                         C       ENDIF
                         C       IF uhrvar
                         C       ENDIF
                         C      
                         C       IF cpastz
                         C       ENDIF ;cpastz
                         C      
                         C       IF cpastz or uhrvar
                         C       ENDIF ;cpastz or uhrvar
                         C      
                         C       IF cpastz
                         C       ENDIF ;cpastz
                         C      
                         C       IF cpastz or uhrvar
                         C       ENDIF
                         C      
  E64B                   C      tim1uu:
                         C       IF disknb ne 0
                         C        IF (fdc eq K5120) or (fdc eq K5122) or (fdc eq f1715)
                         C      ; zusaetzliche Laufwerksabschaltung ueber Zeittakt
  E64B    3A E291        C      	ld	a,(pretx+1)	;Motorabschaltung unterdrueckt?
  E64E    B7             C      	or	a
  E64F    28 0E          C      	jr	z,t1nmo1	;ja
  E651    3A E289        C      	ld	a,(fl.zto)	;pro Sekunde 5 Umdrehungen
  E654    D6 04          C      	sub	4		;noch >= 4* 200ms Zeit?
  E656    30 01          C      	jr	nc,t1nmo2	;ja
  E658    AF             C      	xor	a
  E659    32 E289        C      t1nmo2:	ld	(fl.zto),a
  E65C    CC E2A3        C      	call	z,headup	;Ueberw.zeit abgelaufen -> Motor aus
  E65F                   C      t1nmo1:
                         C        ENDIF
                         C       ENDIF
  E65F    2A 0045        C      	ld	hl,(tim1rt)	;Adresse der Nutzerroutine
  E662    E9             C      	jp	(hl)		;1-sec-Nutzerroutine ausfuehren, ret
                         C      
                         C       IF cpastz or uhrvar
                         C       ENDIF
                                
                                 IF	mprot
                                 ENDIF
                                
                                 IF	monitor
                                 ENDIF
                                
                         C      	include BIOSNUC
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      ; Zentrale BIOS-Kompenenten
                         C      ; - rst 38h fuehrt bei Monitor zu seinem Aufruf, sonst Warmstart
                         C      ; - Nachladen CCP aus RAM-Floppy vereinheitlicht (unabh. von RAM-Floppy)
                         C      ; - synflg hinter BIOS-Sprungvektor fuer Modifizierung von aussen
                         C      ; - Verwendung der Interruptsaeule in Generierungsteil verlagert
                         C      ; 25.09.88
                         C      ; - Streichen des Tastaturpuffers in Tastaturstatus
                         C      ; 09.10.88
                         C      ; - Pflege der Statuszeile nur bei stzaus=0
                         C      ; 11.01.89
                         C      ; - Variante wbootv=4 (@CCP.COM) eingefuehrt
                         C      ; 17.05.89
                         C      ; - Generierung ohne LW A moeglich
                         C      ; 05.06.89
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-106


                         C      ; - Unterstuetzung NANOS-RAF
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      
                         C       IF iobvar
                         C      ;Verteiler fuer die 1-Zeichen-Kanaele entsprechend IOBYTE:
                         C      ;=========================================================
                         C      
  E663                   C      const:			; iobyte  00 00 00 xx
  E663    CD E6C3        C      	call	iodisp
  E666    07             C      	db	7
  E667    D169           C      	dw	kbdst		;0 kbd:
  E669    D169           C      	dw	kbdst		;1 kbd:
  E66B    E687           C      	dw	reades		;2 rdr:
  E66D    D8AC           C      	dw	uc1st		;3 uc1: (liefert, ob Z. da)
                         C      
  E66F                   C      conin:			; iobyte:  00 00 00 xx
  E66F    CD E6C3        C      	call	iodisp
  E672    07             C      	db	7
  E673    D201           C      	dw	kbdi		;0 kbd:
  E675    D201           C      	dw	kbdi		;1 kbd:
  E677    E693           C      	dw	reader		;2 rdr:
  E679    D8DB           C      	dw	uc1i		;3 uc1: (wartet, bis Z. da)
                         C      
  E67B                   C      conout:			; iobyte:  00 00 00 xx
  E67B    CD E6C3        C      	call	iodisp
  E67E    07             C      	db	7
  E67F    D46E           C      	dw	crto		;0 crt:
  E681    D14C           C      	dw	dumo		;1 dum:
  E683    E69F           C      	dw	punch		;2 pun:
  E685    D705           C      	dw	uc1o		;3 uc1: (wartet, bis frei)
                         C      
  E687                   C      reades:			; iobyte:   00 00 xx 00
  E687    CD E6C3        C      	call	iodisp
  E68A    01             C      	db	1
  E68B    D169           C      	dw	kbdst		;0 kbd:
  E68D    D146           C      	dw	dumst		;1 dum:
  E68F    D146           C      	dw	dumst		;2 dum:
  E691    D8AC           C      	dw	uc1st		;3 uc1: (liefert, ob Z. da)
                         C      
  E693                   C      reader:			; iobyte:   00 00 xx 00
  E693    CD E6C3        C      	call	iodisp
  E696    01             C      	db	1
  E697    D201           C      	dw	kbdi		;0 kbd:
  E699    D149           C      	dw	dumi		;1 dum:
  E69B    D149           C      	dw	dumi		;2 dum:
  E69D    D8DB           C      	dw	uc1i		;3 uc1: (wartet, bis Z. da)
                         C      
                         C      
  E69F                   C      punch:			; iobyte:   00 xx 00 00
  E69F    CD E6C3        C      	call	iodisp
  E6A2    03             C      	db	3
  E6A3    D46E           C      	dw	crto		;0 crt:
  E6A5    D14C           C      	dw	dumo		;1 dum:
  E6A7    E6B7           C      	dw	list		;2 lst:
  E6A9    D705           C      	dw	uc1o		;3 uc1: (wartet, bis frei)
                         C      
                         C      
  E6AB                   C      listst:			; iobyte:  xx 00 00 00
  E6AB    CD E6C3        C      	call	iodisp
  E6AE    05             C      	db	5
  E6AF    D76F           C      	dw	ttyst		;0 tty:
  E6B1    D146           C      	dw	crtst		;1 crt:
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-107


  E6B3    D775           C      	dw	lptst		;2 lpt:
  E6B5    D146           C      	dw	dumst		;3 dum:
                         C      
  E6B7                   C      list:			; iobyte:  xx 00 00 00
  E6B7    CD E6C3        C      	call	iodisp
  E6BA    05             C      	db	5
  E6BB    D6F9           C      	dw	ttyo		;0 tty:
  E6BD    D46E           C      	dw	crto		;1 crt:
  E6BF    D6FF           C      	dw	lpto		;2 lpt:
  E6C1    D14C           C      	dw	dumo		;3 dum:
                         C      
                         C      
                         C      ; IOBYTE-Auswertung - Verteilung auf die physischen Geraete
                         C      ; ---------------------------------------------------------
                         C      ; A,HL werden zerstoert
                         C      ; Anwender-IX wird gerettet, darf von Treiber-Routine zerstoert werden
                         C      ; damit kann Treiber auch aus Interrupt-Routine aufgerufen werden
                         C      
  E6C3                   C      iodisp:
  E6C3    E1             C      	pop	hl
  E6C4    C5             C      	push	bc
  E6C5    46             C      	ld	b,(hl)
  E6C6    23             C      	inc	hl
  E6C7    3A 0003        C      	ld	a,(iobyte)
  E6CA    0F             C      iodis1: rrca
  E6CB    10 FD          C      	djnz	iodis1
  E6CD    E6 06          C      	and	6
  E6CF    4F             C      	ld	c,a
  E6D0    09             C      	add	hl,bc
  E6D1    7E             C      	ld	a,(hl)
  E6D2    23             C      	inc	hl
  E6D3    66             C      	ld	h,(hl)
  E6D4    6F             C      	ld	l,a
  E6D5    C1             C      	pop	bc
  E6D6    DD E5          C      	push	ix		;retten Anwender-IX
  E6D8    CD E7A3        C      	call	callhl
  E6DB    DD E1          C      	pop	ix		;wiederherstellen Anwender-IX
  E6DD    C9             C      	ret
                         C      
                         C       ENDIF
                         C      
                         C      ;************************************************************
                         C      ;	Spezialroutinen
                         C      ;************************************************************
                         C      
                         C      	IF	monitor
                         C      	ENDIF
                         C      
                         C      
                         C      ; Arbeit mit asynchronen Sonderaktionen
                         C      ;======================================
                         C      ; Die folgenden beiden Routinen werden vom BIOS immer dann aufgerufen,
                         C      ; wenn wegen zeitkritischer (z.B. Floppy-Bedienung) oder anderer
                         C      ; BIOS-Arbeit (z.B. Bildschirmrollen) keine parallelen Sonderaktionen
                         C      ; erlaubt sind.
                         C      
                         C      ; Reg A bleibt erhalten
  E6DE    F5             C      delsps: push	af
  E6DF    2A 004A        C      	ld	hl,(kritbg)	;evtl. Nutzerroutine fuer Beginn krit. BIOS
  E6E2    CD E7A3        C      	call	callhl		;aufrufen
  E6E5    F1             C      	pop	af
  E6E6    21 D03E        C      	ld	hl,synsem	;Verzoegern Sonderaktionen
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-108


  E6E9    34             C      	inc	(hl)
  E6EA    C9             C      	ret
                         C      
                         C      ; Reg A bleibt erhalten
  E6EB    F5             C      delspr: push	af
  E6EC    2A 004C        C      	ld	hl,(kriten)	;evtl. Nutzerroutine fuer Ende krit. BIOS
  E6EF    CD E7A3        C      	call	callhl		;aufrufen
  E6F2    F1             C      	pop	af
  E6F3    21 D03E        C      	ld	hl,synsem	;Zulassen Sonderaktionen
  E6F6    35             C      	dec	(hl)
                         C      
                         C       IF stpvar or monitor
                         C      
                         C      ; Test auf zwischenzeitliche Anforderung von Sonderroutinen
                         C      ;----------------------------------------------------------
                         C      
                         C      ; Diese Routine wird nach dem Lesen eines Tastaturzeichens
                         C      ; als "Ohr" eingeschoben, bevor zur eigentlichen Interrupt-
                         C      ; adresse zurueckgekehrt wird. Sie wird nicht innerhalb der
                         C      ; Interruptroutine ausgefuehrt, um mit offenen Interrupts
                         C      ; arbeiten zu koennen.
                         C      ; maximale Stackbelastung nach RETI von Interruptroutinen:
                         C      ; -	Return-Adresse zum Nutzer
                         C      ; -	AF
  E6F7    F3             C      chksp:	di
  E6F8    F5             C      	push	af		;A und F Reg retten
  E6F9    3A D03E        C      	ld	a,(synsem)
  E6FC    B7             C      	or	a		;asynchr. Routinen zugelassen?
  E6FD    C2 E714        C      	jp	nz,chkspx	;nein
  E700    3C             C      	inc	a		;weiteren Eintritt verhindern
  E701    32 D03E        C      	ld	(synsem),a
  E704    FB             C      chkspn: ei
  E705    3A D03D        C      	ld	a,(synflg)	;inzw. (neue) Anforderung?
  0000                   C      rqmask	aset	0
                         C       IF monitor
                         C       ENDIF
                         C       IF stpvar
  0010                   C      rqmask	aset	rqmask+(1 shl stoprq)
                         C       IF chdvar
  0018                   C      rqmask	aset	rqmask+(1 shl synlrq)
                         C       ENDIF
                         C       ENDIF
  E708    E6 18          C      	and	rqmask
  E70A    C2 E717        C      	jp	nz,chkspd	;ja, ausfuehren
  E70D    3A D03E        C      	ld	a,(synsem)
  E710    3D             C      	dec	a
  E711    32 D03E        C      	ld	(synsem),a
  E714    F1             C      chkspx: pop	af
  E715    FB             C      	ei
  E716    C9             C      	ret
                         C      
                         C      ; asynchrone Aktionen ausfuehren
  E717                   C      chkspd:
                         C       IF monitor
                         C       ENDIF
                         C      
                         C       IF stpvar
  E717    3A D03D        C      	ld	a,(synflg)
  E71A    CB 67          C      	bit	stoprq,a	;inzwischen Stop-Forderung?
  E71C    28 10          C      	jr	z,nstpsp	;nein
  E71E    CB A7          C      	res	stoprq,a
  E720    32 D03D        C      	ld	(synflg),a
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-109


  E723    F1             C      	pop	af		;Nutzer-Stackbelastung verringern
  E724    22 E75C        C      	ld	(asynhl),hl	;HL freimachen
  E727    21 E75F        C      	ld	hl,stoprt	;Routine
  E72A    CD E748        C      	call	asynrt		;aufrufen mit eigenem Stack
  E72D    F5             C      	push	af
  E72E                   C      nstpsp:
                         C      
                         C       IF chdvar
  E72E    3A D03D        C      	ld	a,(synflg)
  E731    CB 5F          C      	bit	synlrq,a	;inzwischen LST:-Synchr.?
  E733    28 10          C      	jr	z,nsynlr	;nein
  E735    CB 9F          C      	res	synlrq,a
  E737    32 D03D        C      	ld	(synflg),a
  E73A    F1             C      	pop	af
  E73B    22 E75C        C      	ld	(asynhl),hl
  E73E    21 D782        C      	ld	hl,lsynch
  E741    CD E748        C      	call	asynrt
  E744    F5             C      	push	af
  E745                   C      nsynlr:
                         C       ENDIF
                         C       ENDIF	;stpvar
                         C      
  E745    C3 E704        C      	jp	chkspn		;Test auf neue Requests
                         C      
                         C       IF stpvar or chdvar
                         C      ; Asynchrone Routine (HL) mit eigenem Stack aufrufen
                         C      ;---------------------------------------------------
                         C      
  E748    ED 73 E759     C      asynrt: ld	(asynsv),sp	;asynchr. Routinen haben
  E74C    31 F0DF        C      	ld	sp,stpstk	;ein eigenes Stack
  E74F    F5             C      	push	af
  E750    D5             C      	push	de
  E751    C5             C      	push	bc
  E752    CD E7A3        C      	call	callhl		;Routine aufrufen
  E755    C1             C      	pop	bc
  E756    D1             C      	pop	de
  E757    F1             C      	pop	af
  E758    31 0000        C      	ld	sp,0		;SP wiederherstellen
  E759                   C      asynsv	equ	$-2
  E75B    21 0000        C      	ld	hl,0		;gerettetes hl wiederherst.
  E75C                   C      asynhl	equ	$-2
  E75E    C9             C      	ret
                         C       ENDIF
                         C      
                         C       IF stpvar
                         C      ; Asynchrone Stop-Routine
                         C      ;------------------------
  E75F                   C      stoprt:
                         C       IF disknb ne 0
  E75F    CD E2A3        C      	call	headup		;Disk-Kopf abheben
                         C       ENDIF
  E762    CD E78D        C      stopz:	call	stpchp		;holen naechste phys. Taste
                         C      
                         C       IF umlaut
  E765    FE 75          C      	cp	'u'		;Umlaut-Modus umschalten ?
  E767    28 04          C      	jr	z,stopzu
  E769    FE 55          C      	cp	'U'
  E76B    20 08          C      	jr	nz,stopnu	;Nein !
  E76D    21 D03D        C      stopzu: ld	hl,synflg	;Umlaute-Flag im Flagbyte
  E770    7E             C      	ld	a,(hl)
  E771    EE 04          C      	xor	1 shl umlflg	;umschalten
  E773    77             C      	ld	(hl),a
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-110


  E774    C9             C      	ret
  E775                   C      stopnu:
                         C       ENDIF
                         C      
                         C       IF chdvar
  E775    FE FB          C      	cp	zblmin		;"- im Ziffernblock": Hardcopy BS -> LIST?
  E777    CA D634        C      	jp	z,crthrd	;ja, ausfuehren
  E77A    FE CD          C      	cp	spcins		;"INS": I/O-Byte im LST:Kanal weiterschalten?
  E77C    20 08          C      	jr	nz,stopz2	;nein
  E77E    21 0003        C      	ld	hl,iobyte
  E781    7E             C      	ld	a,(hl)
  E782    C6 40          C      	add	a,40h		;Ueberlauf wird ignoriert
  E784    77             C      	ld	(hl),a
  E785    C9             C      	ret
  E786                   C      stopz2:
                         C      
                         C       IF l2bahn
                         C       ENDIF
                         C       ENDIF
                         C      
                         C       IF cpastz or uhrvar
                         C       ENDIF
                         C      
                         C       IF costu
                         C       ENDIF
                         C      
  E786    D6 C7          C      	sub	kcurpd		;"Page down": ^C ?
  E788    C0             C      	ret	nz		;nein, Stop-Ende
  E789    32 D03E        C      	ld	(synsem),a	;falls rst 0 nicht in BIOS fuehrt
  E78C    C7             C      	rst	0		;sonst Warmstart
                         C      
                         C      ; Holen naechste Taste physisch
  E78D    21 D03D        C      stpchp: ld	hl,synflg
  E790    CB FE          C      	set	phyact,(hl)	;naechste Taste physisch
  E792    E5             C      	push	hl
  E793    CD E79A        C      	call	stopch		;holen naechstes Tastaturz.
  E796    E1             C      	pop	hl
  E797    CB BE          C      	res	phyact,(hl)	;physisches Lesen beendet
  E799    C9             C      	ret
                         C      
                         C      ; Holen naechste Taste im Stopzustand
  E79A    CD D615        C      stopch: call	swilmp		;Stop-Lampe an
  E79D    CD D201        C      	call	kbdi		;Warten auf naechstes Zeichen
  E7A0    C3 D615        C      	jp	swilmp		;danach Stop-Lampe aus
                         C      
                         C       ENDIF ;stpvar
                         C       ENDIF ;asynchr. Routinen
                         C      
                         C      ;***************************************************
                         C      ;	Allgemeine BIOS-Hilfsprogramme
                         C      ;***************************************************
                         C      
                         C      ; Aufruf der Routine (HL)
  E7A3    E9             C      callhl: jp	(hl)
                         C      
                         C      ; Ausgabe Text ab (HL) bis 00h auf CON: und evtl. LST:
  E7A4    7E             C      putmes: LD	A,(HL)
  E7A5    B7             C      	OR	A
  E7A6    C8             C      	RET	Z
  E7A7    E5             C      	PUSH	HL
  E7A8    4F             C      	LD	C,A
  E7A9    CD D00C        C      	CALL	conol
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-111


  E7AC    E1             C      	POP	HL
  E7AD    23             C      	INC	HL
  E7AE    18 F4          C      	JR	putmes
                         C      
                         C      ; Ausgabe Text ab (HL) mit exakter Laenge "stzbl" in Statuszeile
                         C       IF cpastz
                         C       ELSE
  E7A4                   C      biosms	equ	putmes	;0dh,0ah,...,07h,00h im Text ergaenzen!!
                         C       ENDIF
                         C      
                         C      ;	Wait 0.01 sec * (B)
                         C      ; Reg HL bleibt erhalten
  E7B0    C5             C      wait10: push	bc
  E7B1    0E 0A          C      	ld	c,10		;10* 1ms warten
  E7B3    06 BD          C      wait2z: ld	b,189		;(189*13)/(256*9600)=0.001
  E7B5    10 FE          C      wait1z: djnz	wait1z		;1ms warten
  E7B7    0D             C      	dec	c
  E7B8    20 F9          C      	jr	nz,wait2z
  E7BA    C1             C      	pop	bc
  E7BB    10 F3          C      	djnz	wait10
  E7BD    C9             C      	ret
                         C      
                         C      ;************************************************************
                         C      ;	zentral verwendete Rueckkonvertierungsroutinen
                         C      ;************************************************************
                         C      
                         C       IF monitor or errvar or iobvar or uhrvar or mprot
                         C      
                         C      ; Rueckkonvertieren Byte ab (HL) nach (DE)
                         C      ; RET: 2 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
  E7BE    7E             C      mbreco: ld	a,(hl)
                         C      
                         C      ; Rueckkonvertieren Byte in A nach (DE)
                         C      ; RET: 2 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
  E7BF    CD E7C2        C      mrecoa: call	mreca
                         C      
                         C      ; Rueckkonvertieren A in HEX-Ziffern nach (DE)
                         C      ; RET: A um 4 bits nach rechts rotiert
                         C      ;      DE zeigt auf naechstes Byte
  E7C2                   C      mrecol:
  E7C2    0F             C      mreca:	rrca			;linkes Halbbyte
  E7C3    0F             C      	rrca
  E7C4    0F             C      	rrca
  E7C5    0F             C      	rrca
  E7C6                   C      mrecor:				;rechtes Halbbyte
  E7C6    F5             C      	push	af		;fuer 2. mreca-Aufruf retten
  E7C7    E6 0F          C      	and	0fh
  E7C9    D6 0A          C      	sub	9+1
  E7CB    38 02          C      	jr	c,mrecod	;0..9
  E7CD    C6 07          C      	add	a,7		;A..F
  E7CF    C6 3A          C      mrecod: add	a,'0'+10
  E7D1    12             C      	ld	(de),a
  E7D2    13             C      	inc	de
  E7D3    F1             C      	pop	af
  E7D4    C9             C      	ret
                         C      
                         C       ENDIF
                         C      
                         C       IF monitor or cpastz
                         C       ENDIF
                         C      
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-112


                         C      ;*************************************************************
                         C      ;	wiederholter Kaltstart
                         C      ;*************************************************************
  E7D5                   C      kalts1:
                         C       IF cpu eq k2521
                         C       ENDIF
                         C       IF (cpu eq k2526) or (cpu eq c1715)
  E7D5    CD E5EC        C      	call	tim5of		;totlegen aller Interruptquellen
                         C        IF cpu eq k2526
  E7D8    CD E5F7        C      	call	tim1of
                         C        ENDIF
                         C        IF cpu eq c1715
                         C        ENDIF
  E7DB    F3             C      	di
                         C        IF cpu eq k2526
  E7DC    3E F7          C      	ld	a,0f7h
  E7DE    D3 0A          C      	out	(0ah),a		;Lade-ROM zuschalten
                         C        ENDIF
                         C        IF cpu eq c1715
                         C        ENDIF
  E7E0    C7             C      	rst	0		;RESET
                         C       ENDIF
                         C      
                         C      ;*************************************************************
                         C      ;	Warmstart
                         C      ;*************************************************************
                         C       if1
                         C       endif
                         C      
                         C       IF	wbootv eq 1	;Warmstart=Kaltstart
                         C       ELSE
  E7E1    31 0080        C      WARMST: LD	SP,tpa-80h
                         C      
                         C         if	wbootv eq 0		;;CCP-Kopie im BIOS
  E7E4    21 E8A2        C      	ld	hl,ccpkop	;;CCP von Kopie wiederherst.
  E7E7    11 BA00        C      	ld	de,CCP
  E7EA    01 0811        C      	ld	bc,ccpkpl+bdskpl
  E7ED    ED B0          C      	ldir
                         C         endif
                         C      
                         C         if	(wbootv eq 2) or (wbootv eq 3) or (wbootv eq 4)
                         C         endif ;(wbootv eq 2) or (wbootv eq 3) or (wbootv eq 4)
                         C      
                         C         if (wbootv eq 0) or (wbootv eq 2) or (wbootv eq 3)
  E7EF    21 BA03        C      	LD	HL,CCP+3	;EINGANG MIT KOMMANDOLOESCHEN
                         C         endif
                         C         if wbootv eq 4
                         C         endif
                         C      	warmin
  E7F2    F3             C+     wbinit: DI
  E7F3    E5             C+     	PUSH	HL
  E7F4    3E F7          C+     	LD	A,high(intvr)
  E7F6    ED 47          C+     	LD	I,A
  E7F8    ED 5E          C+     	im	2
  E7FA    3E C3          C+     	LD	A,0C3H
  E7FC    32 0000        C+     	LD	(REBOOT),A
  E7FF    21 0003'       C+     	LD	HL,BIOS+3
  E802    22 0001        C+     	LD	(REBOOT+1),HL
  E805    32 0005        C+     	LD	(BDOSJP),A
  E808    21 C206        C+     	LD	HL,BDOS+6
  E80B    22 0006        C+     	LD	(BDOSJP+1),HL
  E80E    32 0038        C+     	ld	(38h),a		;Breakpoint
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-113


  E811    21 0000        C+     	ld	hl,0		;ohne Monitor wie Warmstart
  E814    22 0039        C+     	ld	(38h+1),hl
  E817    21 D03D        C+     	ld	hl,synflg
  E81A    36 00          C+     	ld	(hl),0
  E81C    23             C+     	inc	hl
  E81D    36 00          C+     	ld	(hl),0		;synsem:=0
  E81F    21 E5EB        C+     	ld	hl,ret
  E822    22 004A        C+     	ld	(kritbg),hl	;leere Routine fuer Beginn kritischer BIOS-Teil
  E825    22 004C        C+     	ld	(kriten),hl
  E828    21 E5EB        C+     	ld	hl,ret
  E82B    22 0045        C+     	ld	(tim1rt),hl
  E82E    CD E5E5        C+     	call	tim5on
  E831    CD E5F0        C+     	call	tim1on
  E834    AF             C+     	xor	a
  E835    32 D4AC        C+     	ld	(desc),a	;evtl. ESCAPE-Modus beenden
  E838    0E 82          C+     	ld	c,82h		;Kursor sichtbar machen
  E83A    CD D46E        C+     	call	crto
  E83D    3A 0040        C+     	ld	a,(lampbf)
  E840    E6 B3          C+      and (1 shl lmphcp)+(1 shl lmpb2r)+(1 shl lmpb2b)+(1 shl kbdcpb)+(1 shl kbdcal)
  E842    32 0040        C+     	ld	(lampbf),a	;ruecksetzen Lampen
  E845    21 D39B        C+     	ld	hl,kbdsts	;Standard-Stringtabelle wiederherstellen
  E848    22 D03B        C+     	ld	(kbdsst),hl
  E84B    3E FF          C+     	ld	a,0ffh
  E84D    32 DFAD        C+     	ld	(dbdev),a
  E850    FB             C+     	EI
  E851    21 0004        C+     setcld: ld	hl,defaul
  E854    4E             C+     	ld	c,(hl)
  E855    C5             C+     	push	bc
  E856    79             C+     	ld	a,c
  E857    E6 0F          C+     	and	0fh
  E859    4F             C+     	ld	c,a
  E85A    AE             C+     	xor	(hl)
  E85B    F6 00          C+     	or	0
  E85D    77             C+     	ld	(hl),a
  E85E    CD E87F        C+     	call	dgetpb
  E861    C1             C+     	pop	bc
  E862    28 ED          C+     	jr	z,setcld
  E864    C9             C+     	ret
                         C       ENDIF	;wbootv ne 1
                         C      
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      ;	Steuertabellen fuer Massenspeicher
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C       if1
                         C       endif
                         C      
                         C      ; Tabelle der Adressen der DPH's
                         C      ;===============================
                         C      
                         C      ;===============================================
  000D                   C      @din	aset	dphnb
  E865                   C      dphatb: IRP	di,<A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P>
                         C      	if	@din eq 0
                         C      	EXITM
                         C      	endif
                         C      @din	aset	@din-1
                         C       IF dpha&di ; Laufwerk A auf erstes definiertes Geraet legen
                         C      dphaA	aset	dpha&di
                         C       ENDIF
                         C      	dw	dpha&di
                         C      	ENDM
  E865    D03F           C+     	dw	dpha&A
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-114


  E867    D04F           C+     	dw	dpha&B
  E869    D05F           C+     	dw	dpha&C
  E86B    0000           C+     	dw	dpha&D
  E86D    0000           C+     	dw	dpha&E
  E86F    0000           C+     	dw	dpha&F
  E871    0000           C+     	dw	dpha&G
  E873    0000           C+     	dw	dpha&H
  E875    0000           C+     	dw	dpha&I
  E877    0000           C+     	dw	dpha&J
  E879    0000           C+     	dw	dpha&K
  E87B    0000           C+     	dw	dpha&L
  E87D    E5C5           C+     	dw	dpha&M
                         C      
                         C      ; Ermitteln DPH und DPB von (c) nach HL bzw. IX
                         C      ; ret z		DPH existiert nicht, HL=0
                         C      ; ret nz	ok, HL auf DPH, IX auf DPB
                         C      ; BC, DE bleiben erhalten
                         C      ;=====================================================
  E87F    D5             C      dgetpb: push	de
  E880    21 0000        C      	ld	hl,0
  E883    79             C      	ld	a,c
  E884    FE 0D          C      	cp	dphnb		;DPH definiert?
  E886    30 16          C      	jr	nc,dgetp0	;nein
  E888    EB             C      	ex	de,hl
  E889    21 E865        C      	ld	hl,dphatb	;Adresstabelle fuer DPH's
  E88C    59             C      	ld	e,c
  E88D    19             C      	add	hl,de
  E88E    19             C      	add	hl,de
  E88F    7E             C      	ld	a,(hl)
  E890    23             C      	inc	hl
  E891    66             C      	ld	h,(hl)
  E892    6F             C      	ld	l,a		;hl:=^DPH
  E893    E5             C      	push	hl
  E894    1E 0A          C      	ld	e,10
  E896    19             C      	add	hl,de
  E897    5E             C      	ld	e,(hl)
  E898    23             C      	inc	hl
  E899    56             C      	ld	d,(hl)		;de:=^dpb
  E89A    D5             C      	push	de
  E89B    DD E1          C      	pop	ix		;ix:=^dpb
  E89D    E1             C      	pop	hl
  E89E    D1             C      dgetp0: pop	de
  E89F    7C             C      	ld	a,h
  E8A0    B5             C      	or	l		;ret z bei hl=0
  E8A1    C9             C      	ret
                         C      
                         C      
                         C      ;**************************************************
                         C      ;	Arbeits-Felder (ab hier keine Konstanten!!)
                         C      ;	Arbeits-Felder werden benutzt fuer Kaltstart-Routinen
                         C      ;**************************************************
  E8A2                   C      biosds	equ	$
  E8A2                   C      @dsad	aset	biosds
                         C      
                         C      ; ===========allgemeine BIOS-Funktionen=============
                         C      
  0800                   C      ccpkpl	equ	ccpln		;Laenge CCP+ BDOS-Anfang
  0011                   C      bdskpl	equ	11h		;BDOS-Anfang
                         C      
                         C      	if	wbootv eq 0	;CCP-Kopie im BIOS
  E8A2                   C      ccpkop	equ	@dsad
  F0B3                   C      ccpkpe	equ	ccpkop+ccpkpl+bdskpl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-115


  F0B3                   C      @dsad	aset	ccpkpe	;Ende CCP-Kopie
                         C      	endif
                         C      
                         C      	if	(wbootv eq 2) or (wbootv eq 3)
                         C      	endif
                         C      
                         C       IF stpvar
  F0DF                   C      @dsad	aset	@dsad+2*22	;Stack fuer asynchrone Routinen
  F0DF                   C      stpstk	equ	@dsad
                         C       ENDIF
  F0F7                   C      @dsad	aset	@dsad+2*12	;Stack fuer Interrupt-Routinen
  F0F7                   C      intstk	equ	@dsad
                         C      
                         C      ;=============Disketten-Arbeit============
                         C      
  F0F7                   C      dirbuf	equ	@dsad	;Directory-Puffer fuer alle Laufwerke
  F177                   C      @dsad	aset	@dsad+128
                         C      	IRP	di,<A,B,C,D>
                         C       IF disk&di
                         C      alv&di	equ	@dsad		;;Allocation-Vector Disk.
                         C      	IF	((disk&di mod 1000)/100) eq 5	;;5" 
                         C      	if	((disk&di mod 10000)/1000)	;;DS
                         C      @dsad	aset	@dsad+(400+7)/8 ;;reicht fuer 400k (1K Bloecke)
                         C      				;;	bzw. 800K (2K Bloecke)
                         C      	else					;;SS
                         C      @dsad	aset	@dsad+(200+7)/8 ;;reicht fuer 200k (1K Bloecke)
                         C      				;;	bzw. 400K (2K Bloecke)
                         C      	endif
                         C      	ELSE					;;8" 
                         C      	if	(disk&di ge 10000)		;;MFM
                         C      @dsad	aset	@dsad+(352+7)/8 ;;reicht fuer 704 2K Bloecke
                         C      	else					;;FM
                         C      @dsad	aset	@dsad+(250+7)/8 ;;reicht fuer 250K (1K Bloecke)
                         C      				;;	bzw. 500K (2K-Bloecke)
                         C      	endif
                         C      	ENDIF
                         C      csv&di	equ	@dsad		;;Check Sum
                         C      	IF	(disk&di mod 100) gt 40 ;;8",77 oder 5",80 Track
                         C      	if	((disk&di mod 10000)/1000)	;;DS
                         C      @dsad	aset	@dsad+256/4	;;reicht fuer 256 Dir.eintraege
                         C      	else					;;SS
                         C      @dsad	aset	@dsad+128/4	;;reicht fuer 128 Dir.eintraege
                         C      	endif
                         C      	ELSE				;;5" 40 Track
                         C      	if	((disk&di mod 10000)/1000)	;;DS
                         C      @dsad	aset	@dsad+128/4	;;reicht fuer 128 Dir.eintraege
                         C      	else
                         C      @dsad	aset	@dsad+64/4	;;reicht fuer 64 Dir.eintraege
                         C      	endif
                         C      	ENDIF
                         C       ENDIF
                         C      	ENDM
                         C      
                         C      	if	oss
                         C      	endif
                         C      
                         C      
                         C      	IF	em256
  F2A7                   C      alvem	equ	@dsad		;Allocation Vektor TRAM-Floppy
  F2C7                   C      @dsad	aset	@dsad+32	;reicht fuer 256k
                         C      ; kein checksum vektor, da nicht wechselbar
  F2C7                   C      dmabuf	equ	@dsad		;Puffer fuer RAM-Zugriff
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-116


  F347                   C      @dsad	aset	@dsad+128
                         C      	ENDIF
                         C      
                         C      	IF	mkd256
                         C      	ENDIF
                         C      
                         C       IF raf
                         C       ENDIF
                         C      
                         C       IF rna
                         C       ENDIF
                         C      
                         C       IF dbufsz gt 7
  F347                   C      dbuf	equ	@dsad		;Diskettenpuffer
  F747                   C      @dsad	aset	@dsad+(1 shl dbufsz)
                         C       ENDIF
                         C      
                         C      ; ============Tastatur=================
                         C      
                         C       IF cpastz
                         C       ELSE
  F747                   C      kbdbuf	equ	@dsad
  F75C                   C      @dsad	aset	@dsad+kbdbl+1
                         C       ENDIF
                         C      
                         C      ; Es folgt der Bereich fuer nutzereigene Stringdefinition
                         C      ; immer am Ende, d.h. bis zum Beginn der Interruptsaeule,
                         C      ; damit durch Rundung auf 100h-Grenze freibleibende Bytes
                         C      ; fuer Nutzerstrings zusaetzlich zur Verfuegung stehen.
                         C       IF costu
                         C       ENDIF
                         C      
  F75C                   C      biosde	aset	@dsad	;*****Ende BIOS-Arbeitsbereiche*****
                         C      
                         C      
                         C      ; Kontrolle auf Adressenueberschreitung
                         C      ;======================================
                         C       if1
                         C       endif
                         C      
                         C       if biosde gt intvr
                         C       endif
                         C      
                         C      
                         C       if1
                         C       endif
                         C      
  F75C                   C      @diff	aset	biosde
                         C      
                         C       if intvr ge @diff
  0000                   C      @diff	aset	(intvr-@diff) shr 8 shl 8
                         C       if @diff gt 100h ;100h als Unschaerfe zulassen
                         C       endif
                         C       endif ;intvr ge @diff
                         C      
                         C       if1
                         C       endif
                         C      
                         C      ;************************************************
                         C      ;	Kaltstart-Rest, der nicht im Anfangslader
                         C      ; Anschlussbedingung:
                         C      ; i A:	Default-Laufwerk (i.a. =Kaltstartlaufwerk)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-117


                         C      ;	Bit 7 =1, wenn kein jungfr. Kaltstart
                         C      ;************************************************
                         C      
  E8A2                   C      KALTST:				;Kaltstart-Initialisierung
                         C      ; Achtung! Weder Stack noch Reg. A benutzen!
  E8A2    F3             C      	di
                         C       IF dev eq k8915
                         C       ENDIF
  E8A3    21 18B1'       C      	ld	hl,kaltsc
  E8A6    11 0180        C      	ld	de,kaltsb
  E8A9    01 0BBF        C      	ld	bc,kaltsl
  E8AC    ED B0          C      	ldir			;Kaltstart-Code nach vorn
  E8AE    C3 0180        C      	jp	kaltsb		;und abarbeiten
                         C      	.DEPHASE
                         C      
                         C       IF dev eq OEM
  0180                   C      kaltsb	equ	180h		;Basisadr fuer Kaltstartcode
                         C       ENDIF
                         C       IF dev eq K8915
                         C       ENDIF
  18B1'                  C      kaltsc: .PHASE	kaltsb
                         C      
                         C      ; Loeschen 0..tpa-80h
  0180    21 0000        C      	ld	hl,0
  0183    36 00          C      	ld	(hl),0
  0185    11 0001        C      	ld	de,1
  0188    01 007F        C      	ld	bc,tpa-80h-1
  018B    ED B0          C      	ldir
                         C      ;
  018D    31 0180        C      	ld	sp,kaltsb
  0190    F5             C      	push	af		;merken Default
  0191    E6 80          C      	and	80h		;Bit 7
  0193    32 09D6        C      	ld	(cjungf),a	;merken
  0196    F1             C      	pop	af
                         C      
  0197    E6 03          C      	and	03h
  0199    32 0004        C      	ld	(defaul),a	;setzen Default-Laufwerk
  019C    32 E85C        C      	ld	(clddev),a
                         C      
                         C       if (wbootv eq 2) or (wbootv eq 3) or (wbootv eq 4)
                         C       endif
                         C      
                         C      ; Loeschen BIOS-Arbeitsbreiche zur Spur-Suche
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                         C      
  019F    21 E8A2        C      	ld	hl,biosds
  01A2    11 E8A3        C      	ld	de,biosds+1
  01A5    01 0EB9        C      	ld	bc,biosde-biosds-1
  01A8    36 FD          C      	ld	(hl),0fdh
  01AA    ED B0          C      	ldir
                         C      
                         C      ; Definieren Interruptvektor
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~
  01AC    21 F7D0        C      	LD	HL,intvr
  01AF    7C             C      	LD	A,H
  01B0    ED 47          C      	LD	I,A
  01B2    ED 5E          C      	im	2
                         C       IF (intvec+100h-intvr) eq 256
                         C       ELSE
  01B4    06 30          C      	ld	b,intvec+100h-intvr
                         C       ENDIF
  01B6    36 00          C      intvcl: ld	(hl),0		;vorloeschen Interruptsaeule
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-118


  01B8    23             C      	inc	hl
  01B9    10 FB          C      	djnz	intvcl
  01BB    21 D122        C      	ld	hl,cpmx00	;Adr.Sprungvektor CP/M-Erw.
  01BE    22 004E        C      	ld	(cpmext),hl	;eintragen
                         C      
                         C      ; Definieren Arbeitszellen fuer asynchrone Routinen
                         C      ;--------------------------------------------------
                         C      
  01C1    21 E5EB        C      	ld	hl,ret
  01C4    22 004A        C      	ld	(kritbg),hl
  01C7    22 004C        C      	ld	(kriten),hl
                                
                                ;#############################################################
                                ; Kaltstart-Initialisierungen
                                ;----------------------------
                         C      	include BIOSTIMC
                         C      
                         C      ; Kaltstart-Initialisierung Timer
                         C      ;================================
                         C      ; 21.03.89
                         C      
                         C       IF cpu eq c1715
                         C       ELSE
  0002                   C      tim5ct	equ	2
  0003                   C      tim1ct	equ	3
                         C       ENDIF
  01CA    21 E5FB        C      	ld	hl,tim5it	;;int.adr.
  01CD    22 F7FC        C      	ld	(intvec+ivctc0+2*tim5ct),hl
                         C       IF cpu ne c1715
  01D0    21 E629        C       	ld	hl,tim1it	;;int.adr. 1 sec
  01D3    22 F7FE        C      	ld	(intvec+ivctc0+2*tim1ct),hl
                         C       ENDIF
  01D6    3E F8          C      	ld	a,ivctc0
  01D8    D3 0C          C      	out	(sysctc),a	;;int.vekt.
  01DA    3E 37          C      	ld	a,00110111b
                         C      ;;kein int./zeitg./vort.256/pos.flanke/naechst.zykl./zk folgt/abbruch/1
  01DC    D3 0E          C      	out	(sysctc+tim5ct),a
  0030                   C      tim5zk	equ	(5*100*cpuclk)/256	;;Zeitkonstante 5 ms
                         C       IF cpu eq c1715
                         C       ELSE
  01DE    3E 30          C      	ld	a,tim5zk		;;zk fuer 5 ms
                         C       ENDIF
  01E0    D3 0E          C       	out	(sysctc+tim5ct),a
                         C       IF cpu ne c1715
  01E2    3E 57          C       	ld	a,01010111b
                         C      ;;kein int./zaehler//pos.flanke//zk folgt/abbruch/1
  01E4    D3 0F          C      	out	(sysctc+tim1ct),a
  01E6    3E C8          C      	ld	a,1000/5		;;zk fuer 1s
  01E8    D3 0F          C      	out	(sysctc+tim1ct),a
                         C       ENDIF
                         C      	include BIOSCHDC
                         C      ; Kaltstart-Initialisierung zeichenorientierte Geraete
                         C      ;=====================================================
                         C      ; 03.04.89
                         C       if cdtpio
                         C       endif
                         C       if iobuc1
                         C       IF (uc1dat xor uc1sta) eq 01b	;Kanal-Nr ist Bit 1 (bei Buerocomp und OEM)
                         C        IF (uc1sta and 10b) eq 00b	;UC1 ist an Kanal A
  01EA    21 D919        C      	ld	hl,uc1rin	;;Empf-Interrupt fuer UC1:
  01ED    22 F7DC        C      	ld	(intvec+ivsio6),hl ;;Kanal A
  01F0    21 D963        C      	ld	hl,uc1err	;;spez. Empf.Bedingung fuer UC1:
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-119


  01F3    22 F7DE        C      	ld	(intvec+ivsio7),hl ;;Kanal A
                         C        ENDIF
                         C       ENDIF
                         C       endif
                                  IF disknb ne 0
                         C      	include BIOSDSKC
                         C      
                         C      ; Kaltstart-Initialisierung Floppy
                         C      ;=================================
                         C      
                         C      ;; Steuer-PIO A
  01F6    21 E280        C      	LD	HL,itimeo		;;Interrupt bei Indexpunkt
  01F9    22 F7E8        C      	LD	(intvec+ivdsk1),HL
  01FC    3E E8          C      	ld	a,ivdsk1
  01FE    D3 11          C      	OUT	(flcoac),A
  0200    3E 7F          C      	LD	A,7FH
  0202    D3 11          C      	OUT	(flcoac),A		;;zunaechst Byte Eingabe
                         C      ;; Daten-PIO B (Lesen)
  0204    D3 17          C      	OUT	(fldabc),A		;;Byte Eingabe
  0206    DB 16          C      	IN	A,(fldabd)		;;Scheineingabe
                         C      ;; weiter Steuer-PIO A
  0208    3E FD          C      	LD	A,11111101b		;;AMF aus
  020A    D3 10          C      	OUT	(flcoad),A
  020C    3E 3F          C      	LD	A,3FH			;;ab jetzt Byte Ausgabe
  020E    D3 11          C      	OUT	(flcoac),A
                         C      ;; Daten-PIO A (Schreiben)
  0210    D3 15          C      	OUT	(fldaac),A		;;Byte Ausgabe
                         C      ;; Steuer-PIO B
  0212    3E FF          C      	LD	A,0FFH			;;Bit E/A
  0214    D3 13          C      	OUT	(flcobc),A
  0216    3E F3          C      	LD	A,11110011b		;;eeee aaee
  0218    D3 13          C      	OUT	(flcobc),A
                         C      
                         C      ;; Ermittlung der vorhandenen Laufwerke
  021A    0E 04          C      	ld	c,maxlw
  021C    16 00          C      	ld	d,0
  021E    3E F7          C      	ld	a,0f7h		;; ohne lock
  0220    07             C      fl.ka1: rlca
  0221    D3 18          C      	out	(flsel),a
  0223    08             C      	ex	af,af'
  0224    06 55          C      	ld	b,85		;; max 85 mal steppen
  0226    DB 12          C      fl.ka2:	in	a,(flcobd)
  0228    07             C      	rlca			;; kam Spur0-Signal?
  0229    30 12          C      	jr	nc,fl.ka4	;; -> ja
  022B    3E 5F          C      	ld	a,01011111b	;; steppen in Richtung Spur 0
  022D    D3 10          C      	out	(flcoad),a
  022F    3E DF          C      	ld	a,11011111b	;; mit Kopf oben
  0231    D3 10          C      	out	(flcoad),a
  0233    26 08          C      	ld	h,8		;; Schrittzeit abwarten
  0235    2D             C      fl.ka3: dec	l
  0236    20 FD          C      	jr	nz,fl.ka3
  0238    25             C      	dec	h
  0239    20 FA          C      	jr	nz,fl.ka3
  023B    10 E9          C      	djnz	fl.ka2		;; -> weiteren Schritt ausfuehren
                         C      ;****Laufwerke immer existent melden wegen 8" Beistell-Laufwerken ohne Strom
                         C      ;***	jr	fl.ka5		;; -> LW nicht existent
                         C      ;***
  023D    CB F2          C      fl.ka4: set	6,d		;; Laufwerk existent melden
  023F    0D             C      fl.ka5: dec	c		;; weiteres LW?
  0240    28 07          C      	jr	z,fl.ka6	;; -> nein
  0242    CB 0A          C      	rrc	d
  0244    CB 0A          C      	rrc	d
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-120


  0246    08             C      	ex	af,af'
  0247    18 D7          C      	jr	fl.ka1		;; -> naechstes LW pruefen
                         C      
  0249    7A             C      fl.ka6: ld	a,d
  024A    32 E2E9        C      	ld	(lwexis),a
                         C      
  024D    3E FF          C      	ld	a,0ffh		;; alle LW ausschalten
  024F    D3 18          C      	out	(flsel),a
                         C      
  0251    AF             C      	xor	a
  0252    32 E2EA        C      	ld	(alwnr),a	;; LW 0 ist das zuletzt benutzte, Motor ist aus
  0255    32 E2EB        C      	ld	(aspnr),a	;; steht auf Spur 0
  0258    06 04          C      	ld	b,maxlw
  025A    21 E2EC        C      	ld	hl,spnrl
  025D    77             C      fl.ka7: ld	(hl),a		;; alle alten Spurnr. sind 0
  025E    23             C      	inc	hl
  025F    10 FC          C      	djnz	fl.ka7
                         C      
                                  ENDIF
                                  IF oss
                                  ENDIF
                                  IF em256
                         C      	include BIOSREMC
                         C      ;;Initialisieren RAM-Floppy mit EM256
                         C      ;;===================================
                         C      ;; 06.02.89
                         C      ;; 09.04.89
                         C      ;; - Fehlerkorrektur: Blockgroesse im DPB ist 1K und nicht 2K
                         C      
                         C      ;;	Bedeutung der Bits der PIO-Ports des EM256
                         C      ;;
                         C      ;;	PIO Port A (alle Bits auf Eingabe)
  0000                   C      pioa_0	equ	0		;;Kennung vom U8000
  0001                   C      pioa_1	equ	1		;;       "
  0002                   C      pioa_2	equ	2		;;       "
  0003                   C      n_vi	equ	3		;;Vektorinterrupt U8000 (negiert)
  0004                   C      int16	equ	4		;;Interrupt vom U8000 an U880
  0005                   C      n_s	equ	5		;;Normal-(1) oder Systemmode(0) des U8000
  0006                   C      m8_16	equ	6		;;8-Bit-(1) oder 16-Bit-Mode(0)
  0007                   C      tren	equ	7		;;Transfer Enable des U8000
                         C      ;;		
                         C      ;;	PIO Port B (b0..b6 Ausgabe, b7 Eingabe)
  0000                   C      sg0p	equ	0		;;fuer U880-Zugriff angewaehltes Segment
  0001                   C      sg1b	equ	1		;;                "
  0002                   C      n_ramen	equ	2		;;RAM-Enable (negiert)
  0003                   C      n_stop	equ	3		;;U8000-Stop (negiert)
  0004                   C      reset16	equ	4		;;U8000-Reset
  0005                   C      n_trq8	equ	5		;;Transferrequest des U880 (negiert)
  0006                   C      prreset	equ	6		;;Reset Paritaetsfehler
  0007                   C      n_pe	equ	7		;;Paritaetsfehler (negiert)
                         C      ;;
                         C      ;;
                         C      ;;Programmierung des 16*4-RAM
                         C      ;;
                         C      ;;     0x/modadr+7    |x|x|x|x| | | | |
                         C      ;;     1x/modadr+7    |x|x|x|x| | | | |
                         C      ;;          .                 .
                         C      ;;          .                 .
                         C      ;;    0Fx/modadr+7    |x|x|x|x| | | | |
                         C      ;;     |     |                 | | | |___0=Page enable
                         C      ;;     |     |                 | | |_____0=Write enable
                         C      ;;     |     |                 | |_______/A14-8  Adressbit14 auf EM256 (neg.)
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-121


                         C      ;;     |     |                 |_________/A15-8      "    15        "
                         C      ;;     |     |___________________________Grund(Port)adresse des 16*4-RAM
                         C      ;;     |_________________________________Subadresse, adressiert Page im
                         C      ;;					 gewaehlten Segment
                         C      ;;
                         C      ;; !! b6 und b7 der Subadresse stellen die hoechstwertigen Bits der !!
                         C      ;; !! externen (von der U880-Seite) Adresse fuer den Zugriff dar.   !!
                         C      ;; !! Die wirkliche Adresse auf U8000-Seite ergibt sich durch Sub-  !!
                         C      ;; !! stitution durch die mit /A14-8 u. /A15-8 festgelegten Bits.   !!
                         C      
  0000                   C      n_pagen	equ	0	;;Page enable (negiert)
  0001                   C      n_write equ	1	;;write enable (negiert)
  4000                   C      hbemadr	aset	em256adr and 0c000h
                         C      ;;
  0261    21 E5AB        C      emina:	ld 	hl,parrou	;;Interruptadresse Paritaetsfehler
  0264    22 F7E0        C      	ld	(intvec+ivpar),hl;;
                         C      ;;
                         C      ;;initialisieren 1. EM 256
  0267    06 03          C      	ld	b,3
  0269    21 038C        C      	ld	hl,painit	;;em256 PIO Port A
  026C    0E AA          C      	ld	c,modadr+2
  026E    ED B3          C      	otir			;;Initialisieren
                         C      ;;
  0270    06 05          C      	ld	b,5
  0272    21 038F        C      	ld 	hl,pbinit	;;em256 PIO Port B
  0275    0E AB          C      	ld	c,modadr+3
  0277    ED B3          C      	otir			;;Initialisieren
                         C      ;;
  0279    3E 54          C      	ld	a,1 shl prreset or 1 shl reset16 or 1 shl n_ramen
  027B    D3 A9          C      	out	(modadr+1),a	;;Parityreset
  027D    3E 14          C      	ld	a,1 shl n_ramen or 1 shl reset16
                         C            				;;RAM-Disable, U8000 Reset
  027F    D3 A9          C      	out	(modadr+1),a
                         C      ;;
                         C      ;;alle Pages im 16*4-Bit-Speicher mit PAGE Disable, WRITE Disable,
                         C      ;;externe Adresse em256adr initialisieren
                         C      ;;
  0281    01 00AF        C      	ld	bc,modadr+7	;;16*4-RAM, Subadresse 0
  0284    3E 07          C      inloop:	ld a,1 shl n_pagen or 1 shl n_write or hbemadr shr 12
  0286    ED 79          C      	out	(c),a
  0288    3E 10          C      	ld 	a,10h
  028A    80             C      	add	a,b
  028B    47             C      	ld 	b,a		;;naechste Subadresse
  028C    30 F6          C      	jr	nc,inloop
                         C      ;;
                         C      ;;Test ob Ramfloppy vorhanden
  028E    2A 4000        C      	ld	hl,(em256adr)	;;retten aktuellen Inhalt RAM
  0291    E5             C      	push	hl
  0292    21 0000        C      	ld	hl,0
  0295    22 4000        C      	ld	(em256adr),hl	;;und zerstoeren RAM-Inhalt
  0298    AF             C      	xor	a		;;Spur 0
  0299    CD E56C        C      	call	ramon		;;scharf
  029C    2A 4000        C      	ld	hl,(em256adr)	;;retten alten Inhalt RAM-Floppy
  029F    E5             C      	push	hl
  02A0    11 A55A        C      	ld	de,0a55ah	;;Bitmuster 5A A5 auf erste beide Bytes
  02A3    ED 53 4000     C      	ld	(em256adr),de	;;der RAM-Floppy oder in normalen RAM
  02A7    2A 4000        C      	ld	hl,(em256adr)	;;Muster zuruecklesen
  02AA    B7             C      	or	a
  02AB    ED 52          C      	sbc	hl,de
  02AD    28 07          C      	jr	z,emt1		
  02AF    CD E59F        C      	call	ramoff		;;Muster nicht angekommen
  02B2    E1             C      emt0:	pop	hl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-122


  02B3    37             C      	scf
  02B4    18 17          C      	jr	emt2
  02B6    CD E59F        C      emt1:	call	ramoff		;;Test Muster im 8 Bit Speicher
  02B9    2A 4000        C      	ld	hl,(em256adr)
  02BC    B7             C      	or	a
  02BD    ED 52          C      	sbc	hl,de
  02BF    28 F1          C      	jr	z,emt0
  02C1    AF             C      	xor	a		;;Ramfloppy in Ordnung bringen
  02C2    CD E56C        C      	call	ramon
  02C5    E1             C      	pop	hl
  02C6    22 4000        C      	ld	(em256adr),hl
  02C9    CD E59F        C      	call	ramoff
  02CC    AF             C      	xor	a
  02CD    E1             C      emt2:	pop	hl
  02CE    22 4000        C      	ld	(em256adr),hl
  02D1    30 19          C      	jr	nc,inl001	;;ja, EM256 ist vorhanden
                         C      ;;  EM256 nicht vorhanden,
  02D3    21 0A76        C      	ld	hl,kemlwt
  02D6    36 3F          C      	ld	(hl),'?'	;;in Kaltstart-Text
  02D8    23             C      	inc	hl
  02D9    36 3F          C      	ld	(hl),'?'
  02DB    21 0000        C      	ld	hl,0		;;Laufwerk nicht definiert
  02DE    22 E87D        C      	ld	(dphatb+2*('M'-'A')),hl
  02E1    3E C9          C      	ld	a,0c9h		;;RET
  02E3    32 E56C        C      	ld	(ramon),a	;;ramon entschaerfen
  02E6    32 E59F        C      	ld	(ramoff),a	;;ramoff	"
  02E9    C3 03D0        C      	jp	emine
                         C      ;;
  02EC    AF             C      inl001:	xor 	a
  02ED    32 E5C4        C      	ld	(parerr),a	;;Paritaetsfehler ruecksetzen
  02F0    CD 0394        C      	call 	tstkng		;;Test, ob Kennung vorhanden
  02F3    28 1C          C      	jr	z,inl004	;;Ja, noch geladen
                         C      
                         C      ;;RAM-Floppy neu anlegen
  02F5    AF             C      inl003:	xor	a
  02F6    CD E56C        C      	call	ramon
  02F9    C5             C      	push	bc
  02FA    11 4000        C      	ld	de,em256adr	;;Dir-Eintrag anlegen
  02FD    21 03AF        C      	ld	hl,kenn1
  0300    01 0021        C      	ld	bc,32+1		;;+ 1 Byte 0E5H
  0303    ED B0          C      	ldir
  0305    21 4020        C      	ld 	hl,em256adr+32
  0308    01 0FE0        C      	ld	bc,1000h-31-1
  030B    ED B0          C      	ldir			;;Directory mit 0E5H vollschreiben
  030D    C1             C      	pop	bc
  030E    CD E59F        C      	call	ramoff
  0311    3A E5C4        C      inl004:	ld	a,(parerr)
  0314    3D             C      	dec	a		;;Fehler aufgetreten ?
  0315    20 09          C      	jr	nz,inl005	;; Nein !
  0317    21 0362        C      	ld	hl,parmes
  031A    CD E7A4        C      	call	biosms
  031D    C3 0261        C      	jp	emina
                         C      ;;
                         C      ;; wenn auf Segment 2,1 (Spuren 32,16) die Kennung steht, liegt eine
                         C      ;; abgeruestete Variante des EM256 vor ---> Kapazitaet in DPB verringern
                         C      ;;
  0320                   C      inl005:
  0320    3E FF          C      	ld	a,256-1		;;Volle Bestueckung annehmen
  0322    32 E5DA        C      	ld	(dpbem+dpbsiz),a
  0325    21 0A7D        C      	ld	hl,kemmc
  0328    36 32          C      	ld	(hl),'2'
  032A    23             C      	inc	hl
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-123


  032B    36 35          C      	ld	(hl),'5'
  032D    23             C      	inc	hl
  032E    36 36          C      	ld	(hl),'6'
                         C      ;;
  0330    3E 20          C      	ld	a,32		;;Spur 32
  0332    CD 0394        C      	call	tstkng		;;Test: Kennung da?
  0335    C2 03D0        C      	jp	nz,emine	;;Nein, dann volle Bestueckung
                         C      
  0338    3E 7F          C      	ld	a,128-1		;;Ja, dann max.128kByte
  033A    32 E5DA        C      	ld	(dpbem+dpbsiz),a
  033D    21 0A7D        C      	ld 	hl,kemmc
  0340    36 31          C      	ld	(hl),'1'	;;128 k in Meldezeile
  0342    23             C      	inc	hl
  0343    36 32          C      	ld	(hl),'2'
  0345    23             C      	inc	hl
  0346    36 38          C      	ld	(hl),'8'
  0348    3E 10          C      	ld	a,16		;;Spur 16
  034A    CD 0394        C      	call	tstkng		;;Test:	Kennung da?
  034D    C2 03D0        C      	jp	nz,emine	;;Nein,dann 128kByte
                         C      
  0350    3E 3F          C      	ld	a,64-1		;;Ja, dann 64kByte
  0352    32 E5DA        C      	ld	(dpbem+dpbsiz),a
  0355    21 0A7D        C      	ld 	hl,kemmc
  0358    36 20          C      	ld	(hl),' '	;; 64 k in Meldezeile
  035A    23             C      	inc	hl
  035B    36 36          C      	ld	(hl),'6'
  035D    23             C      	inc	hl
  035E    36 34          C      	ld	(hl),'4'
  0360    18 6E          C      	jr	emine
                         C      
  0362    0D 0A 20 50    C      parmes:	db	0dh,0ah,' Paritaetsfehler im EM256, Wiederholung!'
  0366    61 72 69 74    C      
  036A    61 65 74 73    C      
  036E    66 65 68 6C    C      
  0372    65 72 20 69    C      
  0376    6D 20 45 4D    C      
  037A    32 35 36 2C    C      
  037E    20 57 69 65    C      
  0382    64 65 72 68    C      
  0386    6F 6C 75 6E    C      
  038A    67 21          C      
                         C      
  038C    CF             C      painit:	db	0cfh		;;Bit-E/A
  038D    FF             C      	db	0ffh		;;alle Bits Eingabe
  038E    07             C      	db	7		;;Int. verbieten, keine Maske
  038F    E0             C      pbinit: db	ivpar		;;Int.-vektor Paritaetsfehler
  0390    CF             C      	db	0cfh		;;Bit-E/A
  0391    80             C      	db 	80h		;;b7 Eingabe, Rest Ausgabe
  0392    97             C      	db 	97h		;;Maske folgt, 0 loest INT aus, INT Enable
  0393    80             C      	db	80h		;;Paritaetsfehler loest INT aus
                         C      
  0394    CD E56C        C      tstkng: call	ramon
  0397    C5             C      	push	bc
  0398    21 03AF        C      	ld	hl,kenn1
  039B    11 4000        C      	ld	de,em256adr
  039E    06 0C          C      	ld	b,12
  03A0    1A             C      testk1:	ld	a,(de)		;;Kennung da ?
  03A1    BE             C      	cp	(hl)
  03A2    20 04          C      	jr	nz,testk2	;;Nein, dann volle Bestueckung
  03A4    23             C      	inc	hl
  03A5    13             C      	inc	de
  03A6    10 F8          C      	djnz	testk1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-124


  03A8    C1             C      testk2:	pop	bc
  03A9    F5             C      	push	af			;;Zero-Flag merken
  03AA    CD E59F        C      	call	ramoff
  03AD    F1             C      	pop	af
  03AE    C9             C      	ret
                         C      
                         C      ;; Kennungsmuster fuer Verhindern Loeschen der RAM-Floppy nach Kaltstart
  03AF    1F 40 45 4D    C      kenn1:	db 1fh,'@EMvalid','S' or 80h,'Y' or 80h,'S'	;;User 31
  03B3    76 61 6C 69    C      
  03B7    64 D3 D9 53    C      
  03BB                   C      	ds 20,0
  03CF    E5             C      	db 0e5h
                         C      
  03D0                   C      emine:
                                  ENDIF
                                  IF mkd256
                                  ENDIF
                                  IF kes
                                  ENDIF
                                  IF raf
                                  ENDIF
                                  IF rna
                                  ENDIF
                                
                                ;##############################################################
                                ; Kaltstart-Initialisierung, die vom Bildschirmformat abhaengen
                                ;--------------------------------------------------------------
                         C      	include BIOSCLD1	;Wiederholung mit neuem Bildschirmformat
                         C       IF cpu eq c1715
                         C       ENDIF
                         C      	include BIOSCRTC
                         C      ; Kaltstart-Initialisierung Bildschirm
                         C      ;=====================================
                         C      ; Version 25.09.88
                         C      ;;***naechste frei crtmxx-Marke: crtm49
                         C      
                         C       IF cpu eq k2526 ;BC A5120
                         C      ; automatische Bildschirmerkennung durch Bit 6 des System-PIO's
                         C      ; Bit 6=0 -> Loetbruecke bei grossem (24*80) Bildschirm
  03D0    DB 0A          C      	in	a,(0ah)		;;BAB2/3 (grosser Bildschirm?)
                         C       ENDIF
                         C      ;; Automatische Umschaltung des Bildschirmformates
  03D2    CB 77          C      	bit	6,a		;;BAB2 (24*80)?
  03D4    CA 046C        C      	jp	z,bsbab2	;;ja
                         C      
                         C      ;; Umstellung auf BAB1 (16*64)
                         C      ;;----------------------------
  03D7    21 0001        C      bsbab1:	ld	hl,0-bsend1
  03DA    22 D4C8        C      	ld	(crtm01),hl
  03DD    21 FFC0        C      	ld	hl,bsend1-bssp1+1
  03E0    22 D4CF        C      	ld	(crtm02),hl
                         C       IF inslin
  03E3    22 D5C8        C      	ld	(crtm44),hl
  03E6    22 D5E4        C      	ld	(crtm47),hl
  03E9    22 D5F5        C      	ld	(crtm48),hl
                         C       ENDIF
  03EC    2B             C      	dec	hl
  03ED    22 D575        C      	ld	(crtm14),hl
                         C       IF inslin
  03F0    22 D5D6        C      	ld	(crtm46),hl
                         C       ENDIF
  03F3    21 FC40        C      	ld	hl,bsanf1+bssp1
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-125


  03F6    22 D4D3        C      	ld	(crtm03),hl
  03F9    2B             C      	dec	hl
  03FA    22 D5A5        C      	ld	(crtm20),hl
  03FD    21 FC00        C      	ld	hl,bsanf1
  0400    22 D038        C      	ld	(crtcps),hl
  0403    22 D4D6        C      	ld	(crtm04),hl
  0406    22 D52A        C      	ld	(crtm09),hl
  0409    22 D583        C      	ld	(crtm16),hl
  040C    22 D58C        C      	ld	(crtm17),hl
  040F    22 D5A1        C      	ld	(crtm19),hl
                         C       IF stpvar
                         C        IF chdvar
  0412    22 D636        C      	ld	(crtm22),hl
                         C        ENDIF
                         C       ENDIF
                         C       IF mprot
                         C       ENDIF
  0415    21 03C0        C      	ld	hl,bsend1-bsanf1-bssp1+1
  0418    22 D4D9        C      	ld	(crtm05),hl
  041B    21 FFFE        C      	ld	hl,bsend1-1
  041E    22 D4E1        C      	ld	(crtm06),hl
  0421    23             C      	inc	hl
  0422    22 D567        C      	ld	(crtm13),hl
  0425    22 D58F        C      	ld	(crtm18),hl
                         C       IF inslin
  0428    22 D5D3        C      	ld	(crtm45),hl
                         C       ENDIF
  042B    21 003F        C      	ld	hl,bssp1-1
  042E    22 D4E4        C      	ld	(crtm07),hl
  0431    7D             C      	ld	a,l
  0432    32 D55A        C      	ld	(crtm11),a
  0435    23             C      	inc	hl
  0436    22 D52F        C      	ld	(crtm10),hl
  0439    22 D564        C      	ld	(crtm12),hl
  043C    22 D57D        C      	ld	(crtm15),hl
                         C       IF stpvar
                         C        IF chdvar
  043F    7D             C      	ld	a,l
  0440    32 D63D        C      	ld	(crtm24),a
  0443    3E 11          C      	ld	a,bszl1+1
  0445    32 D639        C      	ld	(crtm23),a
                         C        ENDIF
                         C       ENDIF
  0448    3E 0F          C      	ld	a,bszl1-1
  044A    32 D524        C      	ld	(crtm08),a
  044D    21 FFC0        C      	ld	hl,0-bssp1
  0450    22 D5AC        C      	ld	(crtm21),hl
                         C       IF cpastz
                         C       ELSE
  0453    21 F747        C      	ld	hl,kbdbuf
                         C       ENDIF
  0456    22 D246        C      	ld	(crtm32),hl
  0459    22 D239        C      	ld	(crtm33),hl
  045C    22 D1DD        C      	ld	(crtm35),hl
  045F    22 0512        C       	ld	(crtm43),hl
                         C       IF stpvar or monitor
  0462    22 D1B0        C      	ld	(crtm36),hl
                         C       ENDIF
  0465    23             C      	inc	hl
  0466    22 D23D        C      	ld	(crtm34),hl
                         C       IF	uhrvar
                         C       ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-126


  0469    C3 04FE        C      	jp	bsbabi
                         C      
                         C      ;; Umstellung auf BAB2 (24*80)
                         C      ;;----------------------------
  046C    21 0081        C      bsbab2:	ld	hl,0-bsend2
  046F    22 D4C8        C      	ld	(crtm01),hl
  0472    21 FF30        C      	ld	hl,bsend2-bssp2+1
  0475    22 D4CF        C      	ld	(crtm02),hl
                         C       IF inslin
  0478    22 D5C8        C      	ld	(crtm44),hl
  047B    22 D5E4        C      	ld	(crtm47),hl
  047E    22 D5F5        C      	ld	(crtm48),hl
                         C       ENDIF
  0481    2B             C      	dec	hl
  0482    22 D575        C      	ld	(crtm14),hl
                         C       IF inslin
  0485    22 D5D6        C      	ld	(crtm46),hl
                         C       ENDIF
  0488    21 F850        C      	ld	hl,bsanf2+bssp2
  048B    22 D4D3        C      	ld	(crtm03),hl
  048E    2B             C      	dec	hl
  048F    22 D5A5        C      	ld	(crtm20),hl
  0492    21 F800        C      	ld	hl,bsanf2
  0495    22 D038        C      	ld	(crtcps),hl
  0498    22 D4D6        C      	ld	(crtm04),hl
  049B    22 D52A        C      	ld	(crtm09),hl
  049E    22 D583        C      	ld	(crtm16),hl
  04A1    22 D58C        C      	ld	(crtm17),hl
  04A4    22 D5A1        C      	ld	(crtm19),hl
                         C       IF stpvar
                         C        IF chdvar
  04A7    22 D636        C      	ld	(crtm22),hl
                         C        ENDIF
                         C       ENDIF
                         C       IF mprot
                         C       ENDIF
  04AA    21 0730        C      	ld	hl,bsend2-bsanf2-bssp2+1
  04AD    22 D4D9        C      	ld	(crtm05),hl
  04B0    21 FF7E        C      	ld	hl,bsend2-1
  04B3    22 D4E1        C      	ld	(crtm06),hl
  04B6    23             C      	inc	hl
  04B7    22 D567        C      	ld	(crtm13),hl
  04BA    22 D58F        C      	ld	(crtm18),hl
                         C       IF inslin
  04BD    22 D5D3        C      	ld	(crtm45),hl
                         C       ENDIF
  04C0    21 004F        C      	ld	hl,bssp2-1
  04C3    22 D4E4        C      	ld	(crtm07),hl
  04C6    7D             C      	ld	a,l
  04C7    32 D55A        C      	ld	(crtm11),a
  04CA    23             C      	inc	hl
  04CB    22 D52F        C      	ld	(crtm10),hl
  04CE    22 D564        C      	ld	(crtm12),hl
  04D1    22 D57D        C      	ld	(crtm15),hl
                         C       IF stpvar
                         C        IF chdvar
  04D4    7D             C      	ld	a,l
  04D5    32 D63D        C      	ld	(crtm24),a
  04D8    3E 19          C      	ld	a,bszl2+1
  04DA    32 D639        C      	ld	(crtm23),a
                         C        ENDIF
                         C       ENDIF
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-127


  04DD    3E 17          C      	ld	a,bszl2-1
  04DF    32 D524        C      	ld	(crtm08),a
  04E2    21 FFB0        C      	ld	hl,0-bssp2
  04E5    22 D5AC        C      	ld	(crtm21),hl
                         C       IF cpastz
                         C       ELSE
  04E8    21 F747        C      	ld	hl,kbdbuf
                         C       ENDIF
  04EB    22 D246        C      	ld	(crtm32),hl
  04EE    22 D239        C      	ld	(crtm33),hl
  04F1    22 D1DD        C      	ld	(crtm35),hl
  04F4    22 0512        C      	ld	(crtm43),hl
                         C       IF stpvar or monitor
  04F7    22 D1B0        C      	ld	(crtm36),hl
                         C       ENDIF
  04FA    23             C      	inc	hl
  04FB    22 D23D        C      	ld	(crtm34),hl
                         C       IF	uhrvar
                         C       ENDIF
                         C      
  04FE                   C      bsbabi:
                         C      
                         C       IF cpastz
                         C       ENDIF	;cpastz
                         C      
  04FE    0E 0C          C      	ld	c,0ch
  0500    CD D46E        C      	call	crto		;;Bildschirmpuffer loeschen
                         C      
  0503    3E 01          C      	ld	a,1
  0505    D3 40          C      	out	(40h),a		;;BAB3: Kursor blinkend
  0507    3E 03          C      	ld	a,3
  0509    D3 40          C      	OUT	(40h),A		;;BAB3: 1920 Zeichen
                         C      
  050B    0E 84          C      	ld	c,bsinic	;;Grundzustand Bildschirm
  050D    CD D46E        C      	call	crto		;;einstellen
                         C      
                         C      	include BIOSKBDC
                         C      ; Kaltstart-Initialisierung Tastatur
                         C      ;===================================
                         C      ;14.07.88:
                         C      ; - Einbau Typcode 80h fuer K7634.54 (meldet sich wie K7636, ist aber anders!)
                         C      ; 07.11.88
                         C      ; - Erweiterung um K7634-spezifische Tasten
                         C      ;14.01.89
                         C      ; - Einbau K7633
                         C      ;16.02.89
                         C      ; - Ueberwachung der Tabellenlaenge zur Modifizierung der Tastaturcodes
                         C      ;22.03.89
                         C      ; - INSLINE -> spcins  bei K7634 in Umkodierungstabelle aufgenommen
                         C      ; - bei K7633 war KORR und ABBR vertauscht
                         C      ;07.08.89
                         C      ; - Fehlerkorrektur K7637: CTRL-Ersatztaste brachte kein ^Q-Prefix
                         C      
  0510    AF             C      	xor	a
  0511    32 FFFF        C      	ld	(0ffffh),a	;;Tastaturpuffer leeren
  0512                   C      crtm43	equ	$-2
                         C      
                         C       IF costu
                         C       ENDIF
                         C      
                         C      ;;automatische Tastaturerkennung
                         C      ;;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-128


                         C       IF kbdpin
                         C       ENDIF
  0514    06 03          C       	ld	b,3
  0516    11 0400        C      ciini1:	ld	de,400h
  0519    1B             C      ciini2:	dec	de
  051A    DB 06          C      	in	a,(kbdpci)	;;ueberlesen Tastaturzeichen
  051C    7A             C      	ld	a,d
  051D    B3             C      	or	e
  051E    20 F9          C      	jr	nz,ciini2
  0520    10 F4          C      	djnz	ciini1
                         C      
  0522    DB 01          C      	in	a,(kbdpcs)	;;Status einer leeren Tastatur
  0524    E6 08          C      	and	8		;;ist Taste gedrueckt?
  0526    20 06          C      	jr	nz,ciini3	;;nein
  0528    32 062F        C      	ld	(coistc),a	;;sonst cpl -> nop
  052B    32 D24F        C      	ld	(kbdstc),a
  052E                   C      ciini3:
                         C      
  052E                   C      ciisrt:		;;Eingang fuer Wiederholen Tastatur-Abfrage
  052E    AF             C      	xor	a
  052F    D3 03          C      	out	(kbdp3o),a	;;ruecksetzen K7634/36
                         C       IF kbdotp eq 3
                         C       ENDIF
  0531    ED 4B 0631     C      	ld	bc,(kbdsmt)
  0535    06 05          C      	ld	b,00000101b	;;di/zeitg/vt16/neg.fl/strt/zk
  0537    ED 41          C      	out	(c),b		;;Zeitgeber fuer IFSS-Tastatur
  0539    06 01          C      	ld	b,1		;;Zeitkonstante 9600bd
  053B    ED 41          C      	out	(c),b
  053D    ED 4B 0633     C      	ld	bc,(kbdsms)
  0541    06 0A          C      	ld	b,k37prl	;;ruecksetzen K7637
  0543    21 0635        C      	ld	hl,k37par
  0546    ED B3          C      	otir			;;SIO initialisieren
  0548    ED 4B 0632     C      	ld	bc,(kbdsmi)
  054C    AF             C      	xor	a		;;reset an Tastatur
  054D    ED 79          C      	out	(c),a
                         C      ;; Bediensicherung nach RESET wird als unzulaessiges Zeichen
                         C      ;; bei der normalen Tastatureingabe ignoriert
  054F    21 063F        C      	ld	hl,kmodif	;;Standard-Ausgang
  0552    E5             C      	push	hl		;;als Return-Adresse
  0553    11 0600        C      	ld	de,6*256+0	;;Warten auf Typ-Code K7634/36/37
  0556    CD 062D        C      coityp:	call	coistp
  0559    CB 5F          C      	bit	3,a		;;Zeichen da?
  055B    28 2A          C      	jr	z,coitn1	;;nein
  055D    CB 57          C      	bit	2,a		;;CNTL-Status ohne gedrueckte CNTL-Taste?
  055F    28 05          C      	jr	z,coicnp	;;nein
  0561    3E 18          C      	ld	a,18h		;;sonst jr-Befehl,
  0563    32 D259        C      	ld	(kbdstm),a	;;zum Ignorieren des CNTL-Status
  0566    DB 06          C      coicnp:	in	a,(kbdpci)
  0568    E6 F0          C      	and	0f0h
  056A    FE 10          C      	cp	typc3s		;;Typ-Code Sondertastatur
  056C    21 06B0        C      	ld	hl,km3s
  056F    C8             C      	ret	z		;;ja
  0570    FE A0          C      	cp	typc34		;;Typ-Code K7634?
  0572    20 0D          C      	jr	nz,coin34	;;nein
  0574    CD 062D        C      	call	coistp		;;ctrl-Taste vorhanden?
  0577    CB 57          C      	bit	2,a
  0579    21 0686        C      	ld	hl,km3458
  057C    C8             C      	ret	z		;;ja, nicht K7634.54
  057D    21 066A        C      	ld	hl,km3454
  0580    C9             C      	ret
                         C      ;;;Typcode 80h
  0581    FE 80          C      coin34:	cp	80h		;;Typcode 80h?
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-129


                         C       if typ80 eq 3454
                         C       else
  0583    21 06A2        C      	ld	hl,km36		;;  Modifizierung fuer K7636
                         C      endif
  0586    C8             C      	ret	z		;;ja
                         C      ;;;Ende Typcode 80h
                         C      
  0587    ED 4B 0633     C      coitn1:	ld	bc,(kbdsms)
  058B    ED 78          C      	in	a,(c)
  058D    CB 47          C      	bit	0,a		;;Zeichen da?
  058F    28 31          C      	jr	z,coitn2	;;nein
  0591    ED 4B 0632     C      	ld	bc,(kbdsmi)
  0595    ED 78          C      	in	a,(c)
  0597    E6 F0          C      	and	0f0h
  0599    FE 80          C      	cp	typc37
  059B    21 065C        C      	ld	hl,km37
  059E    20 22          C      	jr	nz,coitn2	;;nicht Typcode K7637
  05A0    3A 0633        C      	ld	a,(kbdsms)	;;Portadressen aendern
  05A3    32 0751        C      	ld	(k37dm1),a
  05A6    3A 0632        C      	ld	a,(kbdsmi)
  05A9    32 06BF        C      	ld	(k37dm2),a
  05AC    32 D2DE        C      	ld	(k37dm3),a
  05AF    32 D2F1        C      	ld	(k37dm4),a
  05B2    32 D2FD        C      	ld	(k37dm5),a
  05B5    32 D309        C      	ld	(k37dm6),a
  05B8    32 D326        C      	ld	(k37dm7),a
  05BB    32 D32D        C      	ld	(k37dm8),a
  05BE    21 065C        C      	ld	hl,km37
  05C1    C9             C      	ret			;;K7637
  05C2                   C      coitn2:
  05C2    1D             C      	dec	e
  05C3    20 91          C      	jr	nz,coityp
  05C5    15             C      	dec	d
  05C6    20 8E          C      	jr	nz,coityp	;;verhindern unendl.Schleife
                         C      ;;				 fuer Tastaturen ohne Typcode
  05C8    21 0634        C       	ld	hl,kbdsnr	;;laufende SIO-Tastatur-Nr
  05CB    7E             C      	ld	a,(hl)
  05CC    34             C       	inc	(hl)		;;+1
                         C       if kbds2i+kbds2s+kbds2t
  05CD    FE 02          C      	cp	2		;;war schon 2?
  05CF    30 13          C      	jr	nc,coits2	;;ja
  05D1    3E 52          C      	ld	a,kbds2i
  05D3    32 0632        C      	ld	(kbdsmi),a
  05D6    3E 53          C      	ld	a,kbds2s
  05D8    32 0633        C      	ld	(kbdsms),a
  05DB    3E 59          C      	ld	a,kbds2t
  05DD    32 0631        C      	ld	(kbdsmt),a
  05E0    E1             C      	pop	hl		;;return-Adresse vergessen
  05E1    C3 052E        C      	jp	ciisrt	
  05E4                   C      coits2:
                         C       endif
                         C       if kbds3i+kbds3s+kbds3t
  05E4    FE 03          C      	cp	3		;;war schon 3?
  05E6    30 13          C      	jr	nc,coits3	;;ja
  05E8    3E 52          C      	ld	a,kbds3i
  05EA    32 0632        C      	ld	(kbdsmi),a
  05ED    3E 53          C      	ld	a,kbds3s
  05EF    32 0633        C      	ld	(kbdsms),a
  05F2    3E 5A          C      	ld	a,kbds3t
  05F4    32 0631        C      	ld	(kbdsmt),a
  05F7    E1             C      	pop	hl		;;return-Adresse vergessen
  05F8    C3 052E        C      	jp	ciisrt	
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-130


  05FB                   C      coits3:
                         C       endif
                         C       if kbds4i+kbds4s+kbds4t
  05FB    FE 04          C      	cp	4		;;war schon 4?
  05FD    30 13          C      	jr	nc,coits4	;;ja
  05FF    3E 52          C      	ld	a,kbds4i
  0601    32 0632        C      	ld	(kbdsmi),a
  0604    3E 53          C      	ld	a,kbds4s
  0606    32 0633        C      	ld	(kbdsms),a
  0609    3E 0C          C      	ld	a,kbds4t
  060B    32 0631        C      	ld	(kbdsmt),a
  060E    E1             C      	pop	hl		;;return-Adresse vergessen
  060F    C3 052E        C      	jp	ciisrt	
  0612                   C      coits4:
                         C       endif
                         C       if kbds5i+kbds5s+kbds5t
  0612    FE 05          C      	cp	5		;;war schon 5?
  0614    30 13          C      	jr	nc,coits5	;;ja
  0616    3E 4E          C      	ld	a,kbds5i
  0618    32 0632        C      	ld	(kbdsmi),a
  061B    3E 4F          C      	ld	a,kbds5s
  061D    32 0633        C      	ld	(kbdsms),a
  0620    3E 4A          C      	ld	a,kbds5t
  0622    32 0631        C      	ld	(kbdsmt),a
  0625    E1             C      	pop	hl		;;return-Adresse vergessen
  0626    C3 052E        C      	jp	ciisrt	
  0629                   C      coits5:
                         C       endif
                         C       IF kbdotp eq 0	;;K7606 annehmen
  0629    21 0694        C      	ld	hl,km06
                         C       ENDIF
                         C       IF kbdotp eq 1	;;K7604 annehmen
                         C       ENDIF
                         C       IF kbdotp eq 2	;;DEG-Tastatur annehmen
                         C       ENDIF
                         C       IF kbdotp eq 3	;;K7633 annehmen
                         C       ENDIF
  062C    C9             C      	ret
                         C      
                         C      ;;Lesen Statusregister fuer PIO-Tastatur
                         C      ; Bit 3	=1, wenn Taste gedrueckt
                         C      ; Bit 2	=1, wenn CNTL-Taste gedrueckt
  062D    DB 01          C      coistp:	in	a,(kbdpcs)
  062F    2F             C      coistc:	cpl			;;auf NOP, wenn Status negiert
  0630    C9             C      	ret
                         C      
                         C      ;; Initialisierung Tastatur K7637
  0631    58             C      kbdsmt:	db	kbdsct	;;CTC
  0632    5C             C      kbdsmi:	db	kbdsci	;;Zeichen E/A
  0633    5D             C      kbdsms:	db	kbdscs	;;Status
  0634    01             C      kbdsnr:	db	1	;;Laufende Nr. fuer Tastaturvarianten
  0635    00 18          C      k37par:	db	0,18h	;;Kanal-Reset
  0637    04 44          C      	db	4,44h	;;clock*16  / 1 stoppbit / unger. Par.
  0639    01 00          C      	db	1,0
  063B    05 68          C      	db	5,68h	;;Send. ein / 8 bit pro Zeichen
  063D    03 C1          C      	db	3,0c1h	;;Empf. ein / 8 bit pro Zeichen
  000A                   C      k37prl	equ	$-k37par
                         C      
                         C      
                         C      ;; Tastatur-Modifizierung gemaess Steuertabelle ab (HL)
                         C      
  063F                   C      kmodif:
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-131


  063F    11 0A48        C      	ld	de,kbdtyp
  0642    01 0002        C      	ld	bc,2
  0645    ED B0          C      	ldir
  0647    06 06          C      	ld	b,kmodl		;;Anzahl der Adressen
  0649    C5             C      kmodi1:	push	bc
  064A    5E             C      	ld	e,(hl)
  064B    23             C      	inc	hl
  064C    56             C      	ld	d,(hl)
  064D    23             C      	inc	hl
  064E    E5             C      	push	hl
  064F    21 0655        C      	ld	hl,kmodi2
  0652    E5             C      	push	hl		;;ret-Adr.
  0653    D5             C      	push	de		;;Modif.routine
  0654    C9             C      coidum:	ret			;;abarbeiten
  0655    E1             C      kmodi2:	pop	hl
  0656    C1             C      	pop	bc
  0657    10 F0          C      	djnz	kmodi1
                         C      ;; Ende Kaltstart-Modifizierungen
  0659    C3 093C        C      	jp	coinie
                         C      
                         C      
                         C      ;;Steuertabellen fuer Modifizierung
                         C      ;;==================================
                         C      
                         C      ;; dw coidum, wenn keine Modifizierung
                         C      
                         C      ;; k7637 -Tastatur
                         C      ;;----------------
                         C      
  065C    33 37          C      km37:	db	'37'
  065E    06BE           C      kmodt:	dw	coi37p		;;Port-Modifizierung
  0660    06D3           C      	dw	coi37t		;;Tastenumkodierung
  0662    06EB           C      	dw	coi37c		;;kbdst1-Modifizierung
  0664    06F7           C      	dw	coi37w		;;kbdwin-Modifizierung
  0666    0654           C      	dw	coidum		;;lampen-Modifizierung
  0668    0654           C      	dw	coidum		;;gross <-> klein vertauschen
  0006                   C      kmodl	equ	($-kmodt)/2	;;Anzahl der Adressen
                         C      
                         C      ;; k76x4 -Tastaturen
                         C      ;;------------------
                         C      
                         C       IF kbdotp eq 1
                         C       ENDIF
                         C      
  066A    33 34          C      km3454:	db	'34'
  066C    0654           C      	dw	coidum
  066E    06C4           C      	dw	coi344
  0670    0654           C      	dw	coidum
  0672    06F7           C      	dw	coi34w
  0674    070E           C      	dw	coi34l
  0676    0740           C      	dw	coicps
                         C      
                         C      ;;;Typcode 80h
  0678    33 34          C      km8454:	db	'34'
  067A    0654           C      	dw	coidum
  067C    06C9           C      	dw	coi834		;bis auf wenige Tasten wie K7636
  067E    0654           C      	dw	coidum
  0680    06F7           C      	dw	coi34w
  0682    071A           C      	dw	coi84l		;warten auf Typcode 80h, sonst wie K7634
  0684    0740           C      	dw	coicps
                         C      ;;;Ende Typcode 80h
                         C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-132


  0686    33 34          C      km3458:	db	'34'
  0688    0654           C      	dw	coidum
  068A    06CE           C      	dw	coi348
  068C    0654           C      	dw	coidum
  068E    06F7           C      	dw	coi34w
  0690    070E           C      	dw	coi34l
  0692    0740           C      	dw	coicps
                         C      
                         C      ;; k76x6 -Tastaturen
                         C      ;;------------------
                         C      
                         C       IF kbdotp eq 0
  0694    30 36          C      km06:	db	'06'
  0696    0654           C      	dw	coidum
  0698    0654           C      	dw	coidum
  069A    0654           C      	dw	coidum
  069C    0654           C      	dw	coidum
  069E    0721           C      	dw	coi06l
  06A0    0654           C      	dw	coidum
                         C       ENDIF
                         C      
  06A2    33 36          C      km36:	db	'36'
  06A4    0654           C      	dw	coidum
  06A6    0654           C      	dw	coidum
  06A8    0654           C      	dw	coidum
  06AA    06F7           C      	dw	coi36w
  06AC    072D           C      	dw	coi36l
  06AE    0654           C      	dw	coidum
                         C      
                         C      ;; Sondertastatur (modifizierte K7634)
                         C      ;;---------------
  06B0    3F 53          C      km3s:	db	'?S'
  06B2    0654           C      	dw	coidum		;;Portmodif.
  06B4    06DF           C      	dw	coi3st		;;Tastenumkodierung
  06B6    0654           C      	dw	coidum		;;kbdst1-Modif.
  06B8    06F7           C      	dw	coi3sw		;;kbdwin-Modif.
  06BA    0739           C      	dw	coi3sl		;;lampen-Modif.
  06BC    0654           C      	dw	coidum		;;klein <-> gross
                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      
                         C      ;; Modifizierungs-Unterprogramme
                         C      ;;==============================
                         C      
                         C      ;;Portmodifizierung
                         C      ;;-----------------
  06BE    3E 5C          C      coi37p:	ld	a,kbdsci
  06BF                   C      k37dm2	equ	$-1		;;modifiziert bei Digitalisier-AP
  06C0    32 D287        C      	ld	(kbdmt1),a
  06C3    C9             C      	ret
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;;Codemodif.
                         C      ;;----------
                         C       IF kbdotp eq 1
                         C       ENDIF
  06C4    21 07EC        C      coi344:	ld	hl,cp3454
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-133


  06C7    18 0D          C      	jr	coicpt
                         C      
                         C      ;;;Typcode 80h
  06C9    21 0896        C      coi834:	ld	hl,cp8454
  06CC    18 08          C      	jr	coicpt
                         C      ;;;Ende Typcode 80h
                         C      
  06CE    21 0841        C      coi348:	ld	hl,cp3458
  06D1    18 03          C      	jr	coicpt
                         C      
  06D3    21 08DD        C      coi37t:	ld	hl,cp37
  06D6    11 D336        C      coicpt:	ld	de,kbdcpt
  06D9    01 0065        C      	ld	bc,kbdcpl
  06DC    ED B0          C      	ldir			;;Umkodierungstabelle setzen
  06DE    C9             C      	ret
                         C      
  06DF    21 0746        C      coi3st:	ld	hl,cocp3s	;;Umkodierung ignorieren
  06E2    11 D288        C      	ld	de,cocpm1
  06E5    01 0002        C      	ld	bc,coc3se-cocp3s
  06E8    ED B0          C      	ldir
  06EA    C9             C      	ret
                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;;kbdst1-Modif.
                         C      ;;-------------
  06EB    21 0750        C      coi37c:	ld	hl,cst37
  06EE    11 D24D        C      	ld	de,kbdst1
  06F1    01 0016        C      	ld	bc,cst37e-cst37
  06F4    ED B0          C      	ldir
  06F6    C9             C      	ret
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;;kbdwin-Modif.
                         C      ;;-------------
  06F7                   C      coi3sw:
  06F7                   C      coi04w:
  06F7                   C      coi34w:
  06F7                   C      coi36w:
  06F7                   C      coi37w:
                         C       IF kbdotp eq 3
                         C       ENDIF
  06F7    21 0748        C      	ld	hl,cwi34
  06FA    11 D201        C      	ld	de,kbdmd1
  06FD    01 0008        C      	ld	bc,cwi34e-cwi34
  0700    ED B0          C      	ldir
  0702    C9             C      	ret
                         C      
                         C      ;;lampen-Modif.
                         C      ;;-------------
  0703    21 07B3        C      coi04l:	ld	hl,lmp04
  0706    11 079A        C      	ld	de,lmp3404	;;lmp34 modif. ohne Warten
  0709    01 0002        C      	ld	bc,lmp04e-lmp04
  070C    ED B0          C      	ldir
  070E    21 077C        C      coi34l:	ld	hl,lmp34
  0711    11 D2CA        C      	ld	de,kbdmd2
  0714    01 0037        C      	ld	bc,lmp34e-lmp34
  0717    ED B0          C      	ldir
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-134


  0719    C9             C      	ret
                         C      
                         C      ;;;Typcode 80h
  071A    21 07A4        C      coi84l:	ld	hl,lmp34c
  071D    36 80          C      	ld	(hl),80h	;;Typecode modif.
  071F    18 ED          C      	jr	coi34l
                         C      ;;;Ende Typcode 80h
                         C      
                         C       IF kbdotp eq 0
  0721    21 0766        C      coi06l:	ld	hl,lmp06
  0724    11 D2CA        C      	ld	de,kbdmd2
  0727    01 0016        C      	ld	bc,lmp06e-lmp06
  072A    ED B0          C      	ldir
  072C    C9             C      	ret
                         C       ENDIF
                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C      
  072D    21 07B5        C      coi36l:	ld	hl,lmp36
  0730    11 D2CA        C      	ld	de,kbdmd2
  0733    01 0037        C      	ld	bc,lmp36e-lmp36
  0736    ED B0          C      	ldir
  0738    C9             C      	ret	
                         C      
  0739    21 07A4        C      coi3sl:	ld	hl,lmp34c
  073C    36 10          C      	ld	(hl),typc3s	;;Typecode modif.
  073E    18 CE          C      	jr	coi34l
                         C      
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;;Gross <-> klein modif. bei Tastaturen, die nach RESET Grossb. liefern
                         C      ;;----------------------
  0740    3E C0          C      coicps:	ld	a,0c0h		;ret nz
  0742    32 D275        C      	ld	(kbdmd3),a	;statt ret z
  0745    C9             C      	ret
                         C      
                         C      
                         C      ;; Modifizierungs-Muster
                         C      ;;======================
                         C      
                         C      ;; Tastatur-Code modif.
                         C      ;;--------------------
  0746    18 12          C      cocp3s:	jr	$+cocpm2-cocpm1
  0748                   C      coc3se:
                         C      
                         C      ;; kbdwin
                         C      ;;-------
  0748                   C      cwi34:		;;Modifizierungsroutine fuer K7634/36/37
                         C      ;;kbdwin:
  0748    CD D169        C      	call	kbdst		;;Taste gedrueckt?
  074B    28 FB          C      	jr	z,cwi34		;;nein
  074D    C3 D238        C      	jp	kbdinn		;;sonst auswerten
                         C      
  0750                   C      cwi34e:
                         C      
                         C      ;; kbdst1
                         C      ;;-------
                         C      ;; Modifizierungsroutine fuer K7637
  0750                   C      cst37:
                         C      ;;kbdst1:
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-135


  0750    DB 5D          C      	in	a,(kbdscs)	;;Taste gedrueckt?
  0751                   C      k37dm1	equ	$-1		;;modifiziert bei Digitalisier-AP
  0752    E6 01          C      	and	1
  0754    C8             C      	ret	z		;(a)=0, z=1
  0755    21 D03D        C      	ld	hl,synflg
  0758    CB 46          C      	bit	ctrlst,(hl)	;Ersatz-CNTL?
  075A    3E FF          C      	ld	a,0ffh		;Schnittmaske c0..ff -> c0..ff
  075C    28 02          C      	jr	z,cst37b	;nein
  075E    3E BF          C      	ld	a,0bfh		;Schnittmaske c0..ff -> 80..bf
  0760    32 D2A8        C      cst37b:	ld	(kbdlcs),a
  0763    AF             C      	xor	a
  0764    3D             C      	dec	a		;(a)=ff, z=0
  0765    C9             C      	ret
  0766                   C      cst37e:
                         C      
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;; lampen
                         C      ;;-------
                         C       IF kbdotp eq 0
  0766                   C      lmp06:		;;Modifizierungsroutine fuer K7606
                         C      ;;lampen:
  0766    3E 03          C      	ld	a,3
  0768    D3 03          C      	out	(kbdp3o),a	;;lampen aus
  076A    3A 0040        C      	ld	a,(lampbf)	;;puffer lampenbits
  076D    F5             C      	push	af
  076E    07             C      	rlca
  076F    07             C      	rlca
  0770    E6 03          C      	and	3
  0772    EE 0B          C      	xor	8+3		;;0 bedeutet ein
  0774    D3 03          C      	out	(kbdp3o),a
  0776    F1             C      	pop	af		;;selectorlampem
  0777    EE 0F          C      	xor	0fh		;;0 bedeutet ein
  0779    D3 05          C      	out	(kbdp5o),a
  077B    C9             C      	ret
  077C                   C      lmp06e:
                         C       ENDIF
                         C      
  077C                   C      lmp34:		;;Modifizierungsroutine fuer K7604/K7634
                         C      ;;lampen:
  077C    3A 0040        C      	ld	a,(lampbf)
  077F    FE 00          C      	cp	00h		;;veraendert?
  0780                   C      lmpb34	equ	$-1		;;Kopie Lampen-Puffer
  0781    C8             C      	ret	z		;;unveraendert
  0782    21 E61C        C      	ld	hl,intkbd
  0785    36 21          C      	ld	(hl),21h	;;ld hl,...
  0787    E6 C0          C      	and	0c0h		;;Sel 0..3 LED gibt es nicht
  0789    CB 7F          C      	bit	7,a		;;INS-MODE ?
  078B    28 02          C      	jr	z,lmp34a	;;aus
  078D    CB E7          C      	set	4,a
  078F    CB 77          C      lmp34a:	bit	6,a		;;Fehlerlampe ?
  0791    28 02          C      	jr	z,lmp34b	;;aus
  0793    F6 24          C      	or	00100100b	;;sonst zusaetzlich OFF-LED
  0795    2F             C      lmp34b:	cpl			;;0 bedeutet ein
  0796    CB FF          C      	set	7,a		;;Flag LED-Aenderung
  0798    D3 03          C      	out	(kbdp3o),a
  079A                   C      lmp3404:
  079A    CD D24D        C      lmp34w:	call	kbdst1		;;warten auf Antwort
  079D    28 FB          C      	jr	z,lmp34w
  079F    DB 06          C      	in	a,(kbdpci)
  07A1    E6 F0          C      	and	0f0h
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-136


  07A3    FE A0          C      	cp	typc34
  07A4                   C      lmp34c	equ	$-1		;;fuer evtl. Typecode-Modif.
  07A5    20 F3          C      	jr	nz,lmp34w
  07A7    3A 0040        C      lmp04w:	ld	a,(lampbf)
  07AA    32 D2CE        C      	ld	(lampen+lmpb34-lmp34),a
  07AD    21 E61C        C      	ld	hl,intkbd
  07B0    36 CC          C      	ld	(hl),0cch
  07B2    C9             C      	ret
  07B3                   C      lmp34e	equ	$
                         C      
  07B3                   C      lmp04:		;;Modifizierungsroutine fuer K7604
  07B3    18 0B          C      	jr	$+(lmp04w-lmp3404);;nicht auf Antwort warten
  07B5                   C      lmp04e	equ	$
                         C      
  07B5                   C      lmp36:		;;Modifizierungsroutine fuer K7636
                         C      ;;lampen:
  07B5    3A 0040        C      	ld	a,(lampbf)
  07B8    FE 00          C      	cp	00h		;;veraendert?
  07B9                   C      lmpb36	equ	$-1		;;Kopie Lampen-Puffer
  07BA    C8             C      	ret	z		;;unveraendert
  07BB    21 E61C        C      	ld	hl,intkbd	;parall. 5ms Portabfrage verhindern
  07BE    36 21          C      	ld	(hl),21h	;call ... -> ld hl,...
  07C0    E6 CF          C      	and	0cfh		;;loeschen unbenutzte Bits
  07C2    CB 7F          C      	bit	7,a		;;INS-MODE ?
  07C4    28 02          C      	jr	z,lmp36a	;;aus
  07C6    CB E7          C      	set	4,a
  07C8    CB 77          C      lmp36a:	bit	6,a		;;Fehlerlampe ?
  07CA    28 02          C      	jr	z,lmp36b	;;aus
  07CC    CB EF          C      	set	5,a		;;sonst zusaetzlich 'PIEP'
  07CE    2F             C      lmp36b:	cpl			;;0 bedeutet ein
  07CF    CB FF          C      	set	7,a		;;Flag LED-Aenderung
  07D1    D3 03          C      	out	(kbdp3o),a
  07D3                   C      lmpdg06:
  07D3    CD D24D        C      lmp36w:	call	kbdst1		;;warten auf Antwort
  07D6    28 FB          C      	jr	z,lmp36w
  07D8    DB 06          C      	in	a,(kbdpci)
  07DA    E6 F0          C      	and	0f0h
  07DC    FE 80          C      	cp	80h		;Typcode
  07DE    20 F3          C      	jr	nz,lmp36w
  07E0    3A 0040        C      lmpdgw:	ld	a,(lampbf)
  07E3    32 D2CE        C      	ld	(lampen+lmpb36-lmp36),a
  07E6    21 E61C        C      	ld	hl,intkbd
  07E9    36 CC          C      	ld	(hl),0cch	;;wieder call ...
  07EB    C9             C      	ret
  07EC                   C      lmp36e	equ	$
                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C      
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
                         C      ;; Tabelle physikalische -> virt. Tastencodes
                         C      ;; ##########################################
                         C      
                         C      ;; K76x4.54 (ohne Controltaste)
                         C      ;;=========
  07EC                   C      cp0454:
  07EC                   C      cp3454:
                         C      ; Kursortasten
                         C      ;-------------
  07EC    0B C1          C      	db	00BH,kcurwl		;|<-
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-137


  07EE    04 C2          C      	db	004H,kcurup		;^
  07F0    01 C3          C      	DB	001H,kcurwr		;->|
  07F2    06 C4          C      	db	006H,kcurlf		;<-
  07F4    1E C5          C      	db	01eh,kcurpu		;FM als Ersatz '\
  07F6    07 C6          C      	db	007H,kcurri		;->
  07F8    0A C7          C      	db	00AH,kcurpd		;<-'
  07FA    05 C8          C      	db	005H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  07FC    9D 0D          C      	db	09dh,0dh		;ENTR
  07FE    0F 09          C      	db	00FH,009h		;|<-| als Ersatz Tab
  0800    13 1B          C      	db	013H,01bh		;DEL LINE als Ersatz ESC
  0802    1B C0          C      	db	01BH,spcdel		;DEL
  0804    03 CD          C      	db	003H,spcins		;INSL
  0806    1C D1          C      	db	01cH,Sel0		;DUP
  0808    1F DF          C      	db	01fh,ctlc		;RESET als Ersatz Control-Taste
  080A    09 CC          C      	db	009h,spcce		;ERIN als Ersatz CE
  080C    8D CA          C      	db	08dh,spcclr		;CLEAR
  080E    8F CB          C      	db	08fh,spccnc		;CNCL
  0810    82 CE          C      	db	082h,spckor		;KOR
  0812    83 CF          C      	db	083h,spcrol		;ROLL <-
  0814    84 D0          C      	db	084h,spcror		;ROLL ->
                         C      ; num. Tasten
                         C      ;------------
  0816    12 DD          C      	db	012H,zbl000		;Dzif
  0818    02 FB          C      	db	002h,zblmin		;INS MODE als Ersatz num. Minus
  081A    86 FC          C      	db	086h,zbla		;Taste ueber der "7"
  081C    85 C9          C      	db	085h,zblb		;Taste ueber der "8"
  081E    87 FE          C      	db	087h,zblc		;Taste ueber der "9"
                         C      ; Funktionstasten
                         C      ;----------------
  0820    11 E0          C      	db	011h,pf0c		;REC
  0822    91 E1          C      	db	091h,pf1c		;PF1
  0824    92 E2          C      	db	092h,pf2c		;PF2
  0826    93 E3          C      	db	093h,pf3c		;PF3
  0828    94 E4          C      	db	094h,pf4c		;PF4
  082A    95 E5          C      	db	095h,pf5c		;PF5
  082C    96 E6          C      	db	096h,pf6c		;PF6
  082E    97 E7          C      	db	097h,pf7c		;PF7
  0830    98 E8          C      	db	098h,pf8c		;PF8
  0832    99 E9          C      	db	099h,pf9c		;PF9
  0834    9A EA          C      	db	09ah,pfac		;PF10
  0836    9B EB          C      	db	09bh,pfbc		;PF11
  0838    9C EC          C      	db	09ch,pfcc		;PF12
  083A    81 ED          C      	db	081h,pfdc		;VLD als Ersatz PF13
  083C    08 EE          C      	db	008H,pfec		;EREO als Ersatz PF14 (Monitor)
  083E    10 EF          C      	db	010h,pffc		;OFF als Erstatz PF15 (Stop)
  0840    00             C      	db	0			;Tabellenende
                         C       IF1
                         C       ENDIF
                         C      ;----------------------------------------------------------
                         C      
                         C      ;; K76x4.58 (mit Controltaste)
                         C      ;;=========
  0841                   C      cp0458:
  0841                   C      cp3458:
                         C      ; Kursortasten
                         C      ;-------------
  0841    0B C1          C      	db	00BH,kcurwl		;|<-
  0843    04 C2          C      	db	004H,kcurup		;^
  0845    01 C3          C      	DB	001H,kcurwr		;->|
  0847    07 C4          C      	db	007H,kcurlf		;<-
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-138


  0849    1E C5          C      	db	01eh,kcurpu		;FM als Ersatz '\
  084B    06 C6          C      	db	006H,kcurri		;->
  084D    0A C7          C      	db	00AH,kcurpd		;<-'
  084F    05 C8          C      	db	005H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  0851    9D 0D          C      	db	09dh,0dh		;ENTR
  0853    0F 09          C      	db	00FH,009h		;|<-| als Ersatz Tab
  0855    13 1B          C      	db	013H,01bh		;DEL LINE als Ersatz ESC
  0857    1B C0          C      	db	01BH,spcdel		;DEL
  0859    03 CD          C      	db	003H,spcins		;INSL
  085B    1C D1          C      	db	01cH,Sel0		;DUP
  085D    1F DF          C      	db	01fh,ctlc		;RESET als Ersatz Control-Taste
  085F    09 CC          C      	db	009h,spcce		;ERIN als Ersatz CE
  0861    8D CA          C      	db	08dh,spcclr		;CLEAR
  0863    8F CB          C      	db	08fh,spccnc		;CNCL
  0865    82 CE          C      	db	082h,spckor		;KOR
  0867    83 CF          C      	db	083h,spcrol		;ROLL <-
  0869    84 D0          C      	db	084h,spcror		;ROLL ->
                         C      ; num. Tasten
                         C      ;------------
  086B    12 DD          C      	db	012H,zbl000		;Dzif
  086D    02 FB          C      	db	002h,zblmin		;INS MODE als Ersatz num. Minus
  086F    86 FC          C      	db	086h,zbla		;Taste ueber der "7"
  0871    85 C9          C      	db	085h,zblb		;Taste ueber der "8"
  0873    87 FE          C      	db	087h,zblc		;Taste ueber der "9"
                         C      ; Funktionstasten
                         C      ;----------------
  0875    11 E0          C      	db	011h,pf0c		;REC
  0877    91 E1          C      	db	091h,pf1c		;PF1
  0879    92 E2          C      	db	092h,pf2c		;PF2
  087B    93 E3          C      	db	093h,pf3c		;PF3
  087D    94 E4          C      	db	094h,pf4c		;PF4
  087F    95 E5          C      	db	095h,pf5c		;PF5
  0881    96 E6          C      	db	096h,pf6c		;PF6
  0883    97 E7          C      	db	097h,pf7c		;PF7
  0885    98 E8          C      	db	098h,pf8c		;PF8
  0887    99 E9          C      	db	099h,pf9c		;PF9
  0889    9A EA          C      	db	09ah,pfac		;PF10
  088B    9B EB          C      	db	09bh,pfbc		;PF11
  088D    9C EC          C      	db	09ch,pfcc		;PF12
  088F    81 ED          C      	db	081h,pfdc		;VLD als Ersatz PF13
  0891    08 EE          C      	db	008H,pfec		;EREO als Ersatz PF14 (Monitor)
  0893    10 EF          C      	db	010h,pffc		;OFF als Erstatz PF15 (Stop)
  0895    00             C      	db	0			;Tabellenende
                         C       IF1
                         C       ENDIF
                         C      ;----------------------------------------------------------
                         C      
                         C      ;;;Typcode 80h
                         C      ;; K7634.54 mit Typcode 80h (UBT-Tastatur)
                         C      ;==========================
  0896                   C      cp8454:
                         C      ; Kursortasten
                         C      ;-------------
  0896    0B C1          C      	db	00BH,kcurwl		;|<-
  0898    04 C2          C      	db	004H,kcurup		;^
  089A    01 C3          C      	DB	001H,kcurwr		;->|
  089C    06 C4          C      	db	006H,kcurlf		;<-
  089E    1E C5          C      	db	01eh,kcurpu		;FM als Ersatz '\
  08A0    07 C6          C      	db	007H,kcurri		;->
  08A2    0A C7          C      	db	00AH,kcurpd		;<-'
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-139


  08A4    13 C7          C      	db	013h,kcurpd		;DEL LINE als Ersatz <-'
  08A6    05 C8          C      	db	005H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  08A8    FF 0D          C      	db	0ffh,0dh		;ENT als CR
  08AA    0F 09          C      	db	00FH,009h		;|<-| als Ersatz Tab
  08AC    FE 1B          C      	db	0feH,01bh		;CNCL als Ersatz ESC
  08AE    1B C0          C      	db	01BH,spcdel		;DEL
  08B0    09 CC          C      	db	009H,spcce		;ERIN als Ersatz CE	K7604/34
  08B2    03 CD          C      	db	003H,spcins		;INSL
  08B4    1C D1          C      	db	01cH,Sel0		;DUP
  08B6    AF DF          C      	db	0afH,ctlc		;RESET Control-Taste	K7604/34
                         C      ; num. Tasten
                         C      ;------------
  08B8    12 DD          C      	db	012H,zbl000		;Dzif
  08BA    A8 FB          C      	DB	0A8H,zblmin		;INSM als Ersatz num. Minus
                         C      ; Funktionstasten
                         C      ;----------------
  08BC    FD E0          C      	db	0fdh,pf0c		;REC
  08BE    C1 E1          C      	db	0c1h,pf1c		;PF1
  08C0    C2 E2          C      	db	0c2h,pf2c		;PF2
  08C2    C3 E3          C      	db	0c3h,pf3c		;PF3
  08C4    C4 E4          C      	db	0c4h,pf4c		;PF4
  08C6    C5 E5          C      	db	0c5h,pf5c		;PF5
  08C8    C6 E6          C      	db	0c6h,pf6c		;PF6
  08CA    C7 E7          C      	db	0c7h,pf7c		;PF7
  08CC    C8 E8          C      	db	0c8h,pf8c		;PF8
  08CE    C9 E9          C      	db	0c9h,pf9c		;PF9
  08D0    CA EA          C      	db	0cah,pfac		;PF10
  08D2    CB EB          C      	db	0cbh,pfbc		;PF11
  08D4    CC EC          C      	db	0cch,pfcc		;PF12
  08D6    FC ED          C      	db	0fch,pfdc		;CLEAR als Ersatz PF13
  08D8    08 EE          C      	db	008H,pfec		;EREO als Ersatz PF14
  08DA    10 EF          C      	DB	010H,pffc		;OFF als Ersatz PF15
                         C      
  08DC    00             C      	db	0			;Tabellenende
                         C       IF1
                         C       ENDIF
                         C      ;----------------------------------------------------------
                         C      ;;;Ende Typcode 80h
                         C      
                         C      ;; K7637
                         C      ;;======
  08DD                   C      cp37:
                         C      ; Kursortasten
                         C      ;-------------
  08DD    9B C1          C      	db	09BH,kcurwl		;|<-
  08DF    94 C2          C      	db	094H,kcurup		;^
  08E1    91 C3          C      	DB	091H,kcurwr		;->|
  08E3    96 C4          C      	db	096H,kcurlf		;<-
  08E5    9C C5          C      	DB	09CH,kcurpu		;'\
  08E7    97 C6          C      	db	097H,kcurri		;->
  08E9    9A C7          C      	db	09AH,kcurpd		;<-'
  08EB    95 C8          C      	db	095H,kcurdw		;v
                         C      ; Sondertasten
                         C      ;-------------
  08ED    FF 0D          C      	db	0ffh,0dh		;ET1 als CR
  08EF    9F 09          C      	db	09FH,009h		;|<-| als Ersatz Tab
  08F1    B3 1B          C      	db	0b3H,01bh		;DELL als Ersatz ESC
  08F3    BB C0          C      	db	0bBH,spcdel		;DELCH
  08F5    B9 CC          C      	db	0b9H,spcce		;CE
  08F7    93 CD          C      	db	093H,spcins		;INSL
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-140


  08F9    A0 D1          C      	DB	0A0H,Sel0		;SEL0
  08FB    A1 D2          C      	DB	0A1H,Sel1		;SEL1
  08FD    A2 D4          C      	DB	0A2H,Sel2		;SEL2
  08FF    A3 D8          C              DB	0A3H,Sel3		;SEL3
  0901    FE DF          C      	db	0feh,ctlc		;ET2 als Control-Taste (Loslassen!)
                         C      ; num. Tasten
                         C      ;------------
  0903    B1 DC          C      	db	0b1H,zbl00		;00
  0905    A8 FB          C      	DB	0A8H,zblmin		;INSMD als Ersatz num. Minus
                         C      ; Funktionstasten
                         C      ;----------------
  0907    C0 E0          C      	db	0c0h,pf0c		;ENTER
  0909    C1 E1          C      	db	0c1h,pf1c		;PF1
  090B    C2 E2          C      	db	0c2h,pf2c		;PF2
  090D    C3 E3          C      	db	0c3h,pf3c		;PF3
  090F    C4 E4          C      	db	0c4h,pf4c		;PF4
  0911    C5 E5          C      	db	0c5h,pf5c		;PF5
  0913    C6 E6          C      	db	0c6h,pf6c		;PF6
  0915    C7 E7          C      	db	0c7h,pf7c		;PF7
  0917    C8 E8          C      	db	0c8h,pf8c		;PF8
  0919    C9 E9          C      	db	0c9h,pf9c		;PF9
  091B    CA EA          C      	db	0cah,pfac		;PF10
  091D    CB EB          C      	db	0cbh,pfbc		;PF11
  091F    CC EC          C      	db	0cch,pfcc		;PF12
  0921    B0 EE          C      	db	0b0H,pfec		;MON als PF14
  0923    AF EF          C      	DB	0AFH,pffc		;RESET als Ersatz PF15
                         C      ; Tasten, die mit Shift oder Control anderen Code liefern
                         C      ;--------------------------------------------------------
  0925    93 BB          C      	db	093h,zblmin-40h		;INSMD	+Shift/Control	= INSL
  0927    B3 80          C      	db	0b3h,spcdel-40h		;DELCH	+Shift/Control	= DELL
  0929    FA A1          C      	db	0fah,pf1c-40h		;PF1	+Shift/Control	= PA1
  092B    F9 A2          C      	db	0f9h,pf2c-40h		;PF2	+Shift/Control	= PA2
  092D    F8 A3          C      	db	0f8h,pf3c-40h		;PF3	+Shift/Control	= PA3
  092F    FC A5          C      	db	0fch,pf5c-40h		;PF5	+Shift/Control	= CLEAR
  0931    FD A6          C      	db	0fdh,pf6c-40h		;PF6	+Shift/Control	= REC
  0933    BE A7          C      	db	0beh,pf7c-40h		;PF7	+Shift/Control	= FM
  0935    BC A8          C      	db	0bch,pf8c-40h		;PF8	+Shift/Control	= DUP
  0937    98 AA          C      	db	098h,pfac-40h		;PF10	+Shift/Control	= EREOF
  0939    99 AB          C      	db	099h,pfbc-40h		;PF11	+Shift/Control	= ERINP
                         C      
  093B    00             C      	db	0			;Tabellenende
                         C      
                         C       IF1
                         C       ENDIF
                         C      ;----------------------------------------------------------
                         C      
                         C      
                         C       IF kbdotp eq 2
                         C       ENDIF
                         C      
                         C       IF kbdotp eq 3
                         C       ENDIF
                         C      
  093C                   C      coinie:
  093C    CD D2CA        C      	call	lampen		;alle Lampen aus
                                
                                ;########################################################
                                ; Durch Initialisierrung modifizierte Kaltstart-Meldungen
                                ;--------------------------------------------------------
                         C      	include BIOSCLD2
                         C      ; 23.12.88
                         C      ; - Anforderung des Datums bei "datvar"<>0
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-141


                         C      
                         C      ; Ende der Kaltstart-Initialisierungen
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  093F    FB             C      	ei
  0940    21 E7D5        C      	ld	hl,kalts1	;erneuten kaltstart
  0943    22 D001        C      	ld	(BIOS00+1),hl	;umlenken
  0946    21 09DC        C      	LD	HL,kaltm	;Startmeldung, variabler Teil
  0949    CD 09D5        C      	CALL	cputms
                         C      
                         C      ; Hauptspeicher-Test TPA-Bereich
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  094C    21 0C56        C      	ld	hl,ramtt
  094F    CD 09D5        C      	call	cputms
  0952    21 C206        C      	ld	hl,tpaend+1
  0955    11 0D42        C      	ld	de,kaltsb+kaltsl+3;Kaltstart-Code nicht modif.
  0958    B7             C      	or	a
  0959    ED 52          C      	sbc	hl,de		;Restlaenge TPA (-3 fuer JP)
  095B    44             C      	ld	b,h
  095C    4D             C      	ld	c,l
  095D    EB             C      	ex	de,hl
  095E    7E             C      ramtz:	ld	a,(hl)
  095F    2F             C      	cpl
  0960    77             C      	ld	(hl),a
  0961    BE             C      	cp	(hl)		;angekommen?
  0962    20 2C          C      	jr	nz,ramter	;nein
  0964    2F             C      	cpl
  0965    77             C      	ld	(hl),a
  0966    23             C      	inc	hl
  0967    0B             C      	dec	bc
  0968    78             C      	ld	a,b
  0969    B1             C      	or	c
  096A    20 F2          C      	jr	nz,ramtz
  096C    21 0C78        C      	ld	hl,ramtok
  096F    CD 09D5        C      	call	cputms
  0972    C3 09B0        C      	jp	ramten
  0975    7C             C      rameh:	ld	a,h
  0976    CD 097A        C      	call	dcnvoa
  0979    7D             C      	ld	a,l
                         C      
                         C      ; Rueckkonvertieren Byte in A nach (DE)
                         C      ; RET: 2 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
  097A    CD 097D        C      dcnvoa:	call	dcnva
                         C      
                         C      ; Rueckkonvertieren A in HEX-Ziffern nach (DE)
                         C      ; RET: A um 4 bits nach rechts rotiert
                         C      ;      DE zeigt auf naechstes Byte
  097D                   C      dcnvol:
  097D    0F             C      dcnva:	rrca			;linkes Halbbyte
  097E    0F             C      	rrca
  097F    0F             C      	rrca
  0980    0F             C      	rrca
  0981                   C      dcnvor:				;rechtes Halbbyte
  0981    F5             C      	push	af		;fuer 2. dcnva-Aufruf retten
  0982    E6 0F          C      	and	0fh
  0984    D6 0A          C      	sub	9+1
  0986    38 02          C      	jr	c,dcnvod	;0..9
  0988    C6 07          C      	add	a,7		;A..F
  098A    C6 3A          C      dcnvod:	add	a,'0'+10
  098C    12             C      	ld	(de),a
  098D    13             C      	inc	de
  098E    F1             C      	pop	af
  098F    C9             C      	ret
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-142


                         C      
  0990    11 0C9F        C      ramter:	ld	de,ramead
  0993    CD 0975        C      	call	rameh
  0996    11 C206        C      	ld	de,BDOS+6	;jp BDOS+6 vor diese Stelle
  0999    2B             C      	dec	hl
  099A    72             C      	ld	(hl),d
  099B    2B             C      	dec	hl
  099C    73             C      	ld	(hl),e
  099D    2B             C      	dec	hl
  099E    36 C3          C      	ld	(hl),0c3h
  09A0    22 E809        C      	ld	(bdosre),hl	;diesen Sprung als BDOS setzen
  09A3    2B             C      	dec	hl
  09A4    11 0CB4        C      	ld	de,ramete
  09A7    CD 0975        C      	call	rameh
  09AA    21 0C84        C      	ld	hl,ramert
  09AD    CD 09D5        C      	call	cputms
  09B0                   C      ramten:
                         C      
                         C       IF uhrvar		;stellen der Uhr
                         C       ENDIF
                                
                                ;#############################################################
                                ; Kaltstart-Initialisierungen nach variabler Kaltstart-Meldung
                                ;-------------------------------------------------------------
                                 IF raf
                                 ENDIF
                                 IF rna
                                 ENDIF
                                 IF hdsk
                                 ENDIF
                         C      	include BIOSCLD3
                         C      ;12.01.89
                         C      ;17.05.89
                         C      ;05.06.89
                         C      
                         C      ;START CP/M
                         C      ;~~~~~~~~~~~
                         C       if wbootv eq 0
  09B0    21 BA00        C      	ld	hl,CCP		;CCP fuer Warmstart kopieren
  09B3    11 E8A2        C      	ld	de,ccpkop
  09B6    01 0811        C      	ld	bc,ccpkpl+bdskpl
  09B9    ED B0          C      	ldir
                         C       endif
                         C      
                         C         if	(wbootv eq 3)	;;CCP nach RAM-Floppy laden
                         C         endif ;wbootv eq 3
                         C         if (wbootv eq 2) or (wbootv eq 3)
                         C         endif ;(wbootv eq 2) or (wbootv eq 3)
                         C      
  09BB    21 BA03        C      	ld	hl,CCP+3	;zum Eingang mit Kommandoloeschen
                         C       if cldcmx eq 0
  09BE    3A 09D6        C      	ld	a,(cjungf)
  09C1    B7             C      	or	a		;jungfr. Start?
  09C2    20 0E          C      	jr	nz,njung3	;nein
                         C       endif
  09C4    21 0CBE        C      	LD	HL,kltkom	;Kaltstartkommando
  09C7    11 BA07        C      	LD	DE,CCP+7	;in CCP eintragen
  09CA    01 0081        C      	LD	BC,lkaltc
  09CD    ED B0          C      	LDIR
  09CF    21 BA00        C      	ld	hl,CCP		;zum Eingang ohne Komm.loeschen
  09D2                   C      njung3:
                         C       if	wbootv eq 1	;Warmstart=Kaltstart, d.h. Code nur einmal
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-143


                         C       else
  09D2    C3 E7F2        C      	jp	wbinit		;Warmstart-Initialisierungen
                         C       endif
                         C      
                         C      ; Meldungen Kaltstart
                         C      
  09D5                   C      cputms:
  09D5    3E 00          C      	ld	a,0		;jungfr. Kaltstart?
  09D6                   C      cjungf	equ	$-1
  09D7    B7             C      	or	a
  09D8    C0             C      	ret	nz		;nein
  09D9    C3 E7A4        C      	jp	putmes
                         C      
                         C      ; Konstanten fuer Kaltstart
                         C      ;==========================
  09DC                   C      kaltm:
  09DC    43 50 2F 41    C      	db	'CP/A'
  09E0    2C 20 56 65    C      	db	', Version '
  09E4    72 73 69 6F    C      
  09E8    6E 20          C      
                         C      	version
  09EA    32 35          C+     	db	'25'
  09EC    2E             C+     	db	'.'
  09ED    30 39          C+     	db	'09'
  09EF    2E             C+     	db	'.'
  09F0    38 39          C+     	db	'89'
  09F2    2C 20 54 50    C      	db	', TPA '
  09F6    41 20          C      
                         C      	hexout	tpa
  0010                   C+     	.RADIX	16
  09F8    31 30 30 48    C+     	db	'100','H'
  000A                   C+     	.RADIX	10
  09FC    20 2D 20       C      	db	' - '
                         C      	hexout	tpaend
  0010                   C+     	.RADIX	16
  09FF    30 43 32 30    C+     	db	'0C205','H'
  0A03    35 48          C+     
  000A                   C+     	.RADIX	10
                         C      
  0A05    0D 0A          C      	db	0dh,0ah
                         C      	IF	monitor
                         C      	ELSE
  0A07    2D 20 6F 68    C      	db	'- ohne BIOS-Monitor (Taste und Aufruf ignoriert)'
  0A0B    6E 65 20 42    C      
  0A0F    49 4F 53 2D    C      
  0A13    4D 6F 6E 69    C      
  0A17    74 6F 72 20    C      
  0A1B    28 54 61 73    C      
  0A1F    74 65 20 75    C      
  0A23    6E 64 20 41    C      
  0A27    75 66 72 75    C      
  0A2B    66 20 69 67    C      
  0A2F    6E 6F 72 69    C      
  0A33    65 72 74 29    C      
                         C      	ENDIF
                         C      
                         C       IF cpu eq c1715
                         C       ELSE
  0A37    0D 0A          C      	db	0dh,0ah
  0A39    2D 20 54 61    C      	db	'- Tastatur: K76'
  0A3D    73 74 61 74    C      
  0A41    75 72 3A 20    C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-144


  0A45    4B 37 36       C      
  0A48    3F 3F          C      kbdtyp: db	'??'
                         C      
                         C       ENDIF
                         C       IF oss
                         C       ENDIF
                         C       IF	kes
                         C       ENDIF
                         C       IF	em256
  0A4A    0D 0A          C      	db	0dh,0ah
  0A4C    2D 20 31 36    C      	db	'- 16-Bit Erweiterungsmodul als RAM-Floppy '
  0A50    2D 42 69 74    C      
  0A54    20 45 72 77    C      
  0A58    65 69 74 65    C      
  0A5C    72 75 6E 67    C      
  0A60    73 6D 6F 64    C      
  0A64    75 6C 20 61    C      
  0A68    6C 73 20 52    C      
  0A6C    41 4D 2D 46    C      
  0A70    6C 6F 70 70    C      
  0A74    79 20          C      
  0A76    4D 3A 20 6D    C      kemlwt: db	'M: mit '
  0A7A    69 74 20       C      
  0A7D    3F 3F 3F 20    C      kemmc:	db	'??? kByte'
  0A81    6B 42 79 74    C      
  0A85    65             C      
                         C       ENDIF
                         C       IF	mkd256
                         C       ENDIF
                         C       IF raf
                         C       ENDIF
                         C      
                         C       IF rna
                         C       ENDIF
                         C      
  0A86    0D 0A          C      	db	0dh,0ah
  0A88    2D 20 44 69    C      	db	'- Disketten: '
  0A8C    73 6B 65 74    C      
  0A90    74 65 6E 3A    C      
  0A94    20             C      
  0000                   C      @din	aset	0
                         C      	IRP	di,<A,B,C,D>
                         C       IF disk&di
                         C      @din	aset	@din+1
                         C      	if	@din gt 1
                         C      	db	'/'
                         C      	endif
                         C      	db	'&di:'
                         C      	db	((disk&di mod 1000)/100) or '0','"('
                         C      	db	((disk&di mod 100)/10) or '0'
                         C      	db	(disk&di mod 10) or '0'
                         C      	db	','
                         C      	if	disk&di ge 10000
                         C      	db	'DD'
                         C      	else
                         C      	db	'SD'
                         C      	endif
                         C      	db	','
                         C      	if	((disk&di mod 10000)/1000) and 00000001b
                         C      	db	'DS'
                         C      	else
                         C      	db	'SS'
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-145


                         C      	endif
                         C      	if	((disk&di mod 10000)/1000) and 00000010b
                         C      	db	',Verify'
                         C      	else
                         C      	endif
                         C      	db	')'
                         C       ENDIF
                         C      	ENDM
  0A95    41 3A          C+     	db	'A:'
  0A97    38 22 28       C+     	db	((disk&A mod 1000)/100) or '0','"('
  0A9A    37             C+     	db	((disk&A mod 100)/10) or '0'
  0A9B    37             C+     	db	(disk&A mod 10) or '0'
  0A9C    2C             C+     	db	','
  0A9D    44 44          C+     	db	'DD'
  0A9F    2C             C+     	db	','
  0AA0    53 53          C+     	db	'SS'
  0AA2    29             C+     	db	')'
  0AA3    2F             C+     	db	'/'
  0AA4    42 3A          C+     	db	'B:'
  0AA6    35 22 28       C+     	db	((disk&B mod 1000)/100) or '0','"('
  0AA9    38             C+     	db	((disk&B mod 100)/10) or '0'
  0AAA    30             C+     	db	(disk&B mod 10) or '0'
  0AAB    2C             C+     	db	','
  0AAC    44 44          C+     	db	'DD'
  0AAE    2C             C+     	db	','
  0AAF    44 53          C+     	db	'DS'
  0AB1    29             C+     	db	')'
  0AB2    2F             C+     	db	'/'
  0AB3    43 3A          C+     	db	'C:'
  0AB5    35 22 28       C+     	db	((disk&C mod 1000)/100) or '0','"('
  0AB8    38             C+     	db	((disk&C mod 100)/10) or '0'
  0AB9    30             C+     	db	(disk&C mod 10) or '0'
  0ABA    2C             C+     	db	','
  0ABB    44 44          C+     	db	'DD'
  0ABD    2C             C+     	db	','
  0ABE    44 53          C+     	db	'DS'
  0AC0    29             C+     	db	')'
  0AC1    0D 0A          C      	db	0dh,0ah
  0AC3    20 20 20 20    C      	db	'             max. phys. Sektorlaenge: '
  0AC7    20 20 20 20    C      
  0ACB    20 20 20 20    C      
  0ACF    20 6D 61 78    C      
  0AD3    2E 20 70 68    C      
  0AD7    79 73 2E 20    C      
  0ADB    53 65 6B 74    C      
  0ADF    6F 72 6C 61    C      
  0AE3    65 6E 67 65    C      
  0AE7    3A 20          C      
                         C      	if	dbufsz le 7
                         C      	else
                         C      	decout	<1 shl dbufsz>
  0AE9    31 30 32 34    C+     	db	'1024'
                         C      	endif
  0AED    2C 20          C      	db	', '
                         C       if format
  0AEF    6D 69 74       C      	db	'mit'
                         C       endif
  0AF2    20 61 75 74    C      	db	' autom. Formaterkennung'
  0AF6    6F 6D 2E 20    C      
  0AFA    46 6F 72 6D    C      
  0AFE    61 74 65 72    C      
  0B02    6B 65 6E 6E    C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-146


  0B06    75 6E 67       C      
  0B09    0D 0A          C      	db	0dh,0ah
                         C       if chdvar eq 0
                         C       else
                         C       if1
                         C       endif
  0B0B    2D 20 65 69    C      	db	'- einige I/O-Byte-Zuordnungen:'
  0B0F    6E 69 67 65    C      
  0B13    20 49 2F 4F    C      
  0B17    2D 42 79 74    C      
  0B1B    65 2D 5A 75    C      
  0B1F    6F 72 64 6E    C      
  0B23    75 6E 67 65    C      
  0B27    6E 3A          C      
  0B29    0D 0A 20 20    C      	db	0dh,0ah,'  Bit 7,6 (LST:-Kanal):'
  0B2D    42 69 74 20    C      
  0B31    37 2C 36 20    C      
  0B35    28 4C 53 54    C      
  0B39    3A 2D 4B 61    C      
  0B3D    6E 61 6C 29    C      
  0B41    3A             C      
                         C      	if	iobtty
  0B42    0D 0A 20 20    C      	db	0dh,0ah,'      00 (TTY:): '
  0B46    20 20 20 20    C      
  0B4A    30 30 20 28    C      
  0B4E    54 54 59 3A    C      
  0B52    29 3A 20       C      
                         C      	druckt	ttydat
  0B55    47 65 72 61    C+     	db	'Geraet an Portadresse '
  0B59    65 74 20 61    C+     
  0B5D    6E 20 50 6F    C+     
  0B61    72 74 61 64    C+     
  0B65    72 65 73 73    C+     
  0B69    65 20          C+     
  0010                   C+     	.RADIX	16
  0B6B    35 30 48       C+     	db	'50','H'
  000A                   C+     	.RADIX	10
                         C      	endif
  0B6E    0D 0A 20 20    C      	db	0dh,0ah,'      01 (CRT:): LST:-Ausgabe auf Bildschirm'
  0B72    20 20 20 20    C      
  0B76    30 31 20 28    C      
  0B7A    43 52 54 3A    C      
  0B7E    29 3A 20 4C    C      
  0B82    53 54 3A 2D    C      
  0B86    41 75 73 67    C      
  0B8A    61 62 65 20    C      
  0B8E    61 75 66 20    C      
  0B92    42 69 6C 64    C      
  0B96    73 63 68 69    C      
  0B9A    72 6D          C      
                         C      	if	ioblpt
  0B9C    0D 0A 20 20    C      	db	0dh,0ah,'      10 (LPT:): '
  0BA0    20 20 20 20    C      
  0BA4    31 30 20 28    C      
  0BA8    4C 50 54 3A    C      
  0BAC    29 3A 20       C      
                         C      	druckt	lptdat
  0BAF    47 65 72 61    C+     	db	'Geraet an Portadresse '
  0BB3    65 74 20 61    C+     
  0BB7    6E 20 50 6F    C+     
  0BBB    72 74 61 64    C+     
  0BBF    72 65 73 73    C+     
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-147


  0BC3    65 20          C+     
  0010                   C+     	.RADIX	16
  0BC5    35 45 48       C+     	db	'5E','H'
  000A                   C+     	.RADIX	10
                         C      	endif
  0BC8    0D 0A 20 20    C      	db	0dh,0ah,'      11 (UL1:): LST:-Ausgabe hex auf Bildschirm'
  0BCC    20 20 20 20    C      
  0BD0    31 31 20 28    C      
  0BD4    55 4C 31 3A    C      
  0BD8    29 3A 20 4C    C      
  0BDC    53 54 3A 2D    C      
  0BE0    41 75 73 67    C      
  0BE4    61 62 65 20    C      
  0BE8    68 65 78 20    C      
  0BEC    61 75 66 20    C      
  0BF0    42 69 6C 64    C      
  0BF4    73 63 68 69    C      
  0BF8    72 6D          C      
                         C      	if	iobuc1
  0BFA    0D 0A 20 20    C      	db	0dh,0ah,'  Bit 5,4/3,2/1,0 (UP2:-/UR2:-/UC1:-Kanaele):'
  0BFE    42 69 74 20    C      
  0C02    35 2C 34 2F    C      
  0C06    33 2C 32 2F    C      
  0C0A    31 2C 30 20    C      
  0C0E    28 55 50 32    C      
  0C12    3A 2D 2F 55    C      
  0C16    52 32 3A 2D    C      
  0C1A    2F 55 43 31    C      
  0C1E    3A 2D 4B 61    C      
  0C22    6E 61 65 6C    C      
  0C26    65 29 3A       C      
  0C29    0D 0A 20 20    C      	db	0dh,0ah,'      11 (UC1:): '
  0C2D    20 20 20 20    C      
  0C31    31 31 20 28    C      
  0C35    55 43 31 3A    C      
  0C39    29 3A 20       C      
                         C      	druckt	uc1dat
  0C3C    47 65 72 61    C+     	db	'Geraet an Portadresse '
  0C40    65 74 20 61    C+     
  0C44    6E 20 50 6F    C+     
  0C48    72 74 61 64    C+     
  0C4C    72 65 73 73    C+     
  0C50    65 20          C+     
  0010                   C+     	.RADIX	16
  0C52    35 30 48       C+     	db	'50','H'
  000A                   C+     	.RADIX	10
                         C      	endif
                         C       endif
                         C      
  0C55    00             C      	db	0	;ende-flag putmes
                         C      
                         C      ; RAM-Test-Texte
                         C      ;~~~~~~~~~~~~~~~
  0C56    0D 0A          C      ramtt:	db	0dh,0ah
  0C58    2D 20 52 41    C      	db	'- RAM-Test fuer TPA-Bereich... ',0
  0C5C    4D 2D 54 65    C      
  0C60    73 74 20 66    C      
  0C64    75 65 72 20    C      
  0C68    54 50 41 2D    C      
  0C6C    42 65 72 65    C      
  0C70    69 63 68 2E    C      
  0C74    2E 2E 20 00    C      
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	1-148


  0C78    54 50 41 20    C      ramtok: db	'TPA ist OK!',0
  0C7C    69 73 74 20    C      
  0C80    4F 4B 21 00    C      
  0C84    0D 0A 21 21    C      ramert: db	0dh,0ah,'!!RAM-Fehler auf Adresse '
  0C88    52 41 4D 2D    C      
  0C8C    46 65 68 6C    C      
  0C90    65 72 20 61    C      
  0C94    75 66 20 41    C      
  0C98    64 72 65 73    C      
  0C9C    73 65 20       C      
  0C9F    58 58 58 58    C      ramead: db	'XXXXH!!  TPA nur bis '
  0CA3    48 21 21 20    C      
  0CA7    20 54 50 41    C      
  0CAB    20 6E 75 72    C      
  0CAF    20 62 69 73    C      
  0CB3    20             C      
  0CB4    59 59 59 59    C      ramete: db	'YYYYH.',07h,0dh,0ah,0
  0CB8    48 2E 07 0D    C      
  0CBC    0A 00          C      
                         C      
                         C      ; Kaltstart-Kommando
                         C      ;-------------------
  0CBE    7F             C      kltkom: db	kaltce-kaltc
  0CBF                   C      kaltc:	coldcm
  0CBF    00             C+     kltbef: db	0
  0CC0                   C+     	ds	kltbef+127-$,0
  0D3E    00             C      kaltce: DB	0		;00h notwendig fuer CCP
  0081                   C      lkaltc	equ	$-kltkom	;Laenge gesamtes Kommando
                         C      
                         C      	.DEPHASE
  0BBF                   C      kaltsl	equ	$-kaltsc
                         C      
  2470'                  C      kalten	equ	$
                         C      
                                
                                ;##############################################################
  2470'                         biosce: ;Code-Ende fuer BIOS
                                
                                	END
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S


Macros:
CHARDB          CHDWARM         COLDCM          COSTS           CRTOFF          
CRTON           CRTWARM         DECDB           DECOUT          DRUCKT          
DSKWARM         HEXDB           HEXOUT          KBDWARM         PRINTD          
PRINTH          PRINTV          PRINTX          RFLWARM         SETBS           
SETRAM          TIMWARM         VERSION         WARMIN          

Symbols:
0001 	@CDT            0000 	@DIFF           0003 	@DIN            
0039 	@DPBHL          F75C 	@DSAD           0001 	@FACT           
0000 	@FSYS           00C1 	@L              000C 	@LCR            
000C 	@LCS            0050 	@LD             0051 	@LS             
0713 	@LT             0014 	@WR1            0001 	@WRITE          
0080 	@WSRE           0000 	ADM3A           DC80 	ALLOC           
F177 	ALVA            F1C3 	ALVB            F235 	ALVC            
F2A7 	ALVEM           E2EA 	ALWNR           E2EB 	ASPNR           
E75C 	ASYNHL          E748 	ASYNRT          E759 	ASYNSV          
0007 	B1715           C200 	BDOS            0005 	BDOSJP          
0E00 	BDOSLN          E809 	BDOSRE          0011 	BDSKPL          
E255 	BERCRC          0000I'	BIOS            D000 	BIOS00          
D003 	BIOS03          D006 	BIOS06          D009 	BIOS09          
D00C 	BIOS0C          D00F 	BIOS0F          D012 	BIOS12          
D015 	BIOS15          D018 	BIOS18          D01B 	BIOS1B          
D01E 	BIOS1E          D021 	BIOS21          D024 	BIOS24          
D027 	BIOS27          D02A 	BIOS2A          D02D 	BIOS2D          
D030 	BIOS30          D033 	BIOS33          D036 	BIOS36          
D038 	BIOS38          D03B 	BIOS3B          D03D 	BIOS3D          
D03F 	BIOS3F          D000 	BIOSAD          2470I'	BIOSCE          
F75C 	BIOSDE          E8A2 	BIOSDS          3000 	BIOSL0          
2F73 	BIOSLN          E7A4 	BIOSMS          FC00 	BSANF1          
F800 	BSANF2          03D7 	BSBAB1          046C 	BSBAB2          
04FE 	BSBABI          FFFF 	BSEND1          FF7F 	BSEND2          
0084 	BSINIC          0040 	BSSP1           0050 	BSSP2           
0010 	BSZL1           0018 	BSZL2           0007 	C1715           
E7A3 	CALLHL          BA00 	CCP             E8A2 	CCPKOP          
F0B3 	CCPKPE          0800 	CCPKPL          0800 	CCPLN           
D87D 	CDSIND          D895 	CDSINI          D861 	CDSINS          
D885 	CDSINW          D149 	CDSIOI          D7EE 	CDSIOO          
D7F4 	CDSIOS          0000U	CDTCD1          0001 	CDTDC1          
0002 	CDTDTR          0000 	CDTH54          0000 	CDTN56          
0000 	CDTP54          0000 	CDTP56          0000 	CDTPIO          
0000 	CDTSIB          FFFF 	CHDVAR          E6F7 	CHKSP           
E717 	CHKSPD          E704 	CHKSPN          E714 	CHKSPX          
DC23 	CHKUNA          00FF 	CIGN            0516 	CIINI1          
0519 	CIINI2          052E 	CIINI3          052E 	CIISRT          
09D6 	CJUNGF          0000 	CLDCMX          E85C 	CLDDEV          
D662 	CNUML1          0748 	COC3SE          0746 	COCP3S          
D288 	COCPM1          D29C 	COCPM2          0703 	COI04L          
06F7 	COI04W          0721 	COI06L          06C4 	COI344          
06CE 	COI348          070E 	COI34L          06F7 	COI34W          
072D 	COI36L          06F7 	COI36W          06EB 	COI37C          
06BE 	COI37P          06D3 	COI37T          06F7 	COI37W          
0739 	COI3SL          06DF 	COI3ST          06F7 	COI3SW          
06C9 	COI834          071A 	COI84L          0566 	COICNP          
0740 	COICPS          06D6 	COICPT          0654 	COIDUM          
0581 	COIN34          093C 	COINIE          062F 	COISTC          
062D 	COISTP          0587 	COITN1          05C2 	COITN2          
05E4 	COITS2          05FB 	COITS3          0612 	COITS4          
0629 	COITS5          0556 	COITYP          E66F 	CONIN           
D00C 	CONOL           E67B 	CONOUT          E663 	CONST           
D2B3 	COSTR           D2B5 	COSTR0          D2C2 	COSTR1          
0000 	COSTU           07EC 	CP0454          0841 	CP0458          
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-1


07EC 	CP3454          0841 	CP3458          08DD 	CP37            
0896 	CP8454          0000 	CPASTZ          0001 	CPD             
004E 	CPMEXT          D122 	CPMX00          D125 	CPMX03          
D128 	CPMX06          D12B 	CPMX09          D12E 	CPMX0C          
D13A 	CPMX18          D13D 	CPMX1B          D140 	CPMX1E          
D143 	CPMX21          0006 	CPU             0019 	CPUCLK          
09D5 	CPUTMS          E23B 	CRCBD           E23C 	CRCBEG          
E1DC 	CRCBEL          E2CB 	CRCBER          E198 	CRCBES          
E1EB 	CRCERX          E226 	CRCNB           E231 	CRCVGL          
E2E6 	CRERC           0000 	CRT             D62C 	CRT1ZS          
D624 	CRT2ZS          0800 	CRTBFL          D58B 	CRTBSL          
D58E 	CRTBSR          D6B0 	CRTCCH          D03A 	CRTCCN          
D582 	CRTCL           D610 	CRTCL1          D60D 	CRTCLK          
D608 	CRTCOF          D038 	CRTCPS          D563 	CRTCR           
D604 	CRTCRT          D5A4 	CRTCUP          D4C7 	CRTCUR          
D581 	CRTDEL          D5F4 	CRTDL1          D5DF 	CRTDLL          
D5FE 	CRTESC          D548 	CRTFA1          D54E 	CRTFA2          
D53A 	CRTFA3          D537 	CRTFFL          D63C 	CRTHD1          
D63E 	CRTHD2          D66C 	CRTHD3          D664 	CRTHD4          
D5A0 	CRTHOM          D634 	CRTHRD          D5DA 	CRTIL1          
D5C3 	CRTINL          D4A7 	CRTLC           0004 	CRTLCL          
D574 	CRTLF           D4C8 	CRTM01          D4CF 	CRTM02          
D4D3 	CRTM03          D4D6 	CRTM04          D4D9 	CRTM05          
D4E1 	CRTM06          D4E4 	CRTM07          D524 	CRTM08          
D52A 	CRTM09          D52F 	CRTM10          D55A 	CRTM11          
D564 	CRTM12          D567 	CRTM13          D575 	CRTM14          
D57D 	CRTM15          D583 	CRTM16          D58C 	CRTM17          
D58F 	CRTM18          D5A1 	CRTM19          D5A5 	CRTM20          
D5AC 	CRTM21          D636 	CRTM22          D639 	CRTM23          
D63D 	CRTM24          D246 	CRTM32          D239 	CRTM33          
D23D 	CRTM34          D1DD 	CRTM35          D1B0 	CRTM36          
0512 	CRTM43          D5C8 	CRTM44          D5D3 	CRTM45          
D5D6 	CRTM46          D5E4 	CRTM47          D5F5 	CRTM48          
D559 	CRTNFA          D511 	CRTNOP          D53F 	CRTNSP          
D46E 	CRTO            D4B0 	CRTO02          D4D1 	CRTO03          
D512 	CRTO04          D529 	CRTO05          D532 	CRTO06          
D536 	CRTO07          D55F 	CRTO08          D4F1 	CRTO09          
D501 	CRTO11          D569 	CRTO12          D5BC 	CRTO13          
D609 	CRTO14          D4EA 	CRTO84          D4EA 	CRTO85          
D4EA 	CRTO86          D4EA 	CRTO87          D4C5 	CRTOBS          
D499 	CRTOE1          D483 	CRTONC          D4AB 	CRTOTI          
D4C6 	CRTSBL          D146 	CRTST           D67F 	CRTUML          
D5B0 	CRTZL           D5B4 	CRTZLR          D25D 	CST34A          
D265 	CST34B          0750 	CST37           0760 	CST37B          
0766 	CST37E          F1A3 	CSVA            F1F5 	CSVB            
F267 	CSVC            00DF 	CTLC            0000 	CTRLST          
0748 	CWI34           0750 	CWI34E          DFAC 	DBCDB           
DFAD 	DBDEV           DFB3 	DBDMA           DFC5 	DBERRF          
DFAC 	DBFLG           DF66 	DBL1K           DF69 	DBL2K           
DF6C 	DBL2K0          DD3B 	DBMAT           DCCF 	DBN             
DFC3 	DBNB            DD38 	DBPRR           DFB0 	DBSEC           
DD00 	DBSEC0          DD09 	DBSECM          DD12 	DBSECO          
DCFD 	DBSECZ          DFAF 	DBSID           DFB1 	DBSLC           
DFB2 	DBSNB           DCEE 	DBSNBZ          DD79 	DBTRAN          
DFAE 	DBTRK           DD73 	DBTRW           F347 	DBUF            
000A 	DBUFSZ          DFB5 	DCDB            097D 	DCNVA           
097A 	DCNVOA          098A 	DCNVOD          097D 	DCNVOL          
0981 	DCNVOR          D480 	DCURS           DFBC 	DDMA            
DFB6 	DDRIVE          0004 	DEFAUL          E6EB 	DELSPR          
E6DE 	DELSPS          DF8C 	DERRCD          DF89 	DERRMS          
DEAD 	DERRR           DF8B 	DERRRW          DF9A 	DERRSC          
DF96 	DERRTR          DF98 	DERRTS          D4AC 	DESC            
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-2


0000 	DEV             0000 	DFBPRR          0004 	DFBTR           
0002 	DFBWR           DFB5 	DFLG            DFA5 	DFRCDB          
E134 	DFRCOD          DFA5 	DFRFLG          DFA6 	DFRMDV          
DFA7 	DFRMTR          0002 	DFWR            E89E 	DGETP0          
E87F 	DGETPB          E48B 	DINI1           E48E 	DINI2           
E491 	DINI3           E3B4 	DIO             E3C1 	DIO2            
DFCD 	DIOCAD          DFC6 	DIOCDB          DFC7 	DIOCDE          
0009 	DIOCDL          DFC6 	DIOCFL          DFCA 	DIOCSE          
DFC9 	DIOCSI          DFCB 	DIOCSL          DFCC 	DIOCSN          
DFC8 	DIOCTR          E3B9 	DIODMA          E4AD 	DIOEND          
DE96 	DIOERT          0000 	DIOF00          0003 	DIOFFM          
0005 	DIOFHD          0001 	DIOFID          0006 	DIOFPS          
0007 	DIOFS1          0004 	DIOFTR          0002 	DIOFWR          
E3E8 	DIOGO           E3EE 	DIOKL           E3E5 	DIOM01          
E391 	DIOM02          E3E1 	DIOM03          E4BA 	DIOM04          
E4CC 	DIOM05          E4D2 	DIOM06          E4DF 	DIOM07          
E4F1 	DIOM08          E4FB 	DIOM09          E478 	DIOM10          
E51D 	DIOM11          E3D1 	DIOM13          E3EC 	DIOMD1          
E410 	DIOMD2          E3DB 	DIOMR           E3E0 	DIOMRK          
DE50 	DIONFM          DE55 	DIONFT          E4A2 	DIONS           
E4AC 	DIONSE          E3D6 	DIONSS          E418 	DIOOP           
DE38 	DIOPHY          E46F 	DIORD           E473 	DIORDS          
E485 	DIORKL          E374 	DIORTN          DE38 	DIORTY          
E36D 	DIORUN          E480 	DIOSL1          E506 	DIOSL2          
DE33 	DIOSSP          E3D0 	DIOSTP          E411 	DIOSYN          
E427 	DIOTR0          E448 	DIOTR1          E450 	DIOTRE          
E427 	DIOTRR          DE1B 	DIOTRS          DE0A 	DIOTS1          
DDF8 	DIOTS2          DE09 	DIOTS4          E41A 	DIOTSR          
DE1C 	DIOTSS          E518 	DIOW00          E4B3 	DIOWFM          
E4C7 	DIOWFS          E516 	DIOWM1          E505 	DIOWRT          
F0F7 	DIRBUF          0002 	DISK5           0001 	DISK8           
2A7D 	DISKA           2D3C 	DISKB           2D3C 	DISKC           
0000 	DISKD           2D3C 	DISKDI          DDB0 	DISKII          
DDA6 	DISKIO          0003 	DISKNB          E4D9 	DIWMFM          
E4EC 	DIWMFS          0003 	DLGINT          F2C7 	DMABUF          
DD6C 	DMOVEW          E508 	DOTI1           E50A 	DOTI2           
E50C 	DOTI3           D06F 	DPBA            0009 	DPBALC          
D0BC 	DPBB            0011 	DPBBFM          0003 	DPBBLM          
0002 	DPBBLS          D0EF 	DPBC            000B 	DPBCHK          
0007 	DPBDIR          0015 	DPBDNR          E5D5 	DPBEM           
0004 	DPBEXM          0004 	DPBF86          0005 	DPBFDS          
0002 	DPBFFM          000F 	DPBFLG          0007 	DPBFND          
0006 	DPBFRM          0003 	DPBFSM          0003 	DPBFSV          
0033 	DPBLNG          E5D5 	DPBM            000D 	DPBOFS          
0016 	DPBPTR          0005 	DPBSIZ          0010 	DPBSLC          
0013 	DPBSN0          0000 	DPBSPT          0017 	DPBSTI          
0012 	DPBSTP          0019 	DPBSTR          0007 	DPBT52          
0004 	DPBT5Z          0005 	DPBT80          0003 	DPBTDD          
0000 	DPBTDS          0014 	DPBTRK          0006 	DPBTWV          
0018 	DPBTYP          D03F 	DPHA            E5C5 	DPHAA           
D04F 	DPHAB           D05F 	DPHAC           0000 	DPHAD           
0000 	DPHAE           0000 	DPHAF           0000 	DPHAG           
0000 	DPHAH           0000 	DPHAI           0000 	DPHAJ           
0000 	DPHAK           0000 	DPHAL           E5C5 	DPHAM           
0000 	DPHAN           0000 	DPHAO           0000 	DPHAP           
E865 	DPHATB          D04F 	DPHB            D05F 	DPHC            
E5C5 	DPHEM           E5C5 	DPHM            000D 	DPHNB           
E132 	DPREC1          E07C 	DPREC2          E07F 	DPRECN          
E136 	DPRETR          DF9E 	DRDCDB          DF9F 	DRDDEV          
DF9E 	DRDFLG          D9D0 	DRDFRM          DFA0 	DRDTRK          
DFF1 	DRV0            DFFA 	DRV0A           DC84 	DRW             
DCB0 	DRWBNR          DC5E 	DRWERR          DDDE 	DRWNSP          
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-3


DDA3 	DRWSEC          DFB9 	DSECTR          D9B0 	DSELNB          
E35A 	DSIDMT          E150 	DSIDMZ          0009 	DSIDTL          
DD8B 	DSIDTR          DD88 	DSIDTT          DB9E 	DSIZDZ          
DB9B 	DSIZME          DB98 	DSIZMZ          0000 	DSK5FM          
0002 	DSK5MF          0003 	DSK80           0000 	DSK8FM          
0001 	DSK8MF          E04D 	DSKDA           E03A 	DSKDAW          
0002 	DSKDS           E03A 	DSKMO1          E04F 	DSKMON          
DDA6 	DSKTRA          0004 	DSLBLK          0002 	DSLDIR          
0001 	DSLFO           0005 	DSLL            E336 	DSLN0           
E33F 	DSLN1           E348 	DSLN2           E351 	DSLN3           
0009 	DSLNL           E323 	DSLNMT          E21A 	DSLNMZ          
0003 	DSLOFF          0001 	DSLSPT          0000 	DSLTRK          
0000 	DSLVO           DD5C 	DSMOVE          D6F9 	DSWE            
0001 	DSY5            D6B1 	DSZTA           0018 	DSZTAL          
DFB7 	DTRACK          E1AA 	DTRDYT          E1AD 	DTRDYW          
E1AA 	DTRDYZ          E3A8 	DTRNER          E3AB 	DTRNSR          
DECD 	DTROK           E1D5 	DTRRDE          E3AE 	DTRRDR          
E3A4 	DTRRET          DEED 	DTRSL0          DF0B 	DTRSL1          
DF2A 	DTRSL2          DF48 	DTRSL3          DED9 	DTRSLA          
E08D 	DTRSLL          E3A5 	DTRTOR          E3A5 	DTRWJR          
E1C9 	DTRWRE          E3B1 	DTRWRR          D149 	DUMI            
D14C 	DUMO            D159 	DUMOH           D146 	DUMST           
DFC4 	DWRTYP          0001 	EM256           4000 	EM256ADR        
0261 	EMINA           03D0 	EMINE           02B2 	EMT0            
02B6 	EMT1            02CD 	EMT2            0001 	ERRVAR          
0001 	ESCPC           0007 	F1715           0001 	FDC             
000B 	FDC3            E1BC 	FEHRET          0220 	FL.KA1          
0226 	FL.KA2          0235 	FL.KA3          023D 	FL.KA4          
023F 	FL.KA5          0249 	FL.KA6          025D 	FL.KA7          
E278 	FL.STO          E215 	FL.TO1          E24A 	FL.TSB          
E289 	FL.ZTO          0011 	FLCOAC          0010 	FLCOAD          
0013 	FLCOBC          0012 	FLCOBD          0015 	FLDAAC          
0014 	FLDAAD          0017 	FLDABC          0016 	FLDABD          
E219 	FLMODF          DFCF 	FLOPPY          E2AB 	FLRES           
0018 	FLSEL           0001 	FORMAT          E2C1 	FT.ADR          
E2C8 	FT.ANZ          E2C0 	FT.KOM          E2C7 	FT.LEN          
E2C3 	FT.LWN          E2C6 	FT.SEC          E2C5 	FT.SID          
E2CA 	FT.STI          E2C9 	FT.STP          E2C4 	FT.TRK          
4000 	HBEMADR         0000 	HDSK            E2A3 	HEADUP          
DBC7 	HOME            DBD3 	HOME1           00DA 	HRLC            
02EC 	INL001          02F5 	INL003          0311 	INL004          
0320 	INL005          0284 	INLOOP          0001 	INSLIN          
0004 	INT16           E648 	INTCRT          E61C 	INTKBD          
E622 	INTRAF          E61F 	INTRBC          E626 	INTRET          
E621 	INTRHL          E624 	INTSP           F0F7 	INTSTK          
00D0 	INTVB           01B6 	INTVCL          F700 	INTVEC          
00D0 	INTVL           F7D0 	INTVR           00E0 	INTVSY          
00D0 	INTVUC          2DBE 	IOBLPT          0713 	IOBTTY          
0713 	IOBUC1          0001 	IOBVAR          0003 	IOBYTE          
E6CA 	IODIS1          E6C3 	IODISP          E280 	ITIMEO          
00F8 	IVCTC0          00FA 	IVCTC1          00FC 	IVCTC2          
00FE 	IVCTC3          00E8 	IVDSK1          00EA 	IVDSK2          
00E0 	IVPAR           00E2 	IVPIOD          00E6 	IVPROT          
00F0 	IVPUN1          00F6 	IVPUN2          00F2 	IVRDR1          
00F4 	IVRDR2          00D0 	IVSIO0          00D2 	IVSIO1          
00D4 	IVSIO2          00D6 	IVSIO3          00D8 	IVSIO4          
00DA 	IVSIO5          00DC 	IVSIO6          00DE 	IVSIO7          
0001 	K2521           0006 	K2526           0751 	K37DM1          
06BF 	K37DM2          D2DE 	K37DM3          D2F1 	K37DM4          
D2FD 	K37DM5          D309 	K37DM6          D326 	K37DM7          
D32D 	K37DM8          0635 	K37PAR          000A 	K37PRL          
0000 	K5120           0001 	K5122           0006 	K5126           
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-4


0000 	K7024           0002 	K8915           0CBF 	KALTC           
0D3E 	KALTCE          2470'	KALTEN          09DC 	KALTM           
E7D5 	KALTS1          0180 	KALTSB          18B1'	KALTSC          
0BBF 	KALTSL          E8A2 	KALTST          0043 	KBDB3O          
0042 	KBDBCI          D1AE 	KBDBCL          0041 	KBDBCS          
D17C 	KBDBFE          0014 	KBDBL           F747 	KBDBUF          
0001 	KBDCAL          D19E 	KBDCO           D1F3 	KBDCO1          
D1F4 	KBDCO2          D283 	KBDCP1          0000 	KBDCPB          
0065 	KBDCPL          D336 	KBDCPT          D201 	KBDI            
D238 	KBDINN          D2A8 	KBDLCS          D201 	KBDMD1          
D2CA 	KBDMD2          D275 	KBDMD3          D287 	KBDMT1          
D1A5 	KBDNCO          D191 	KBDNCT          D1CD 	KBDNHC          
D1DA 	KBDNSL          D1B6 	KBDNST          D1BD 	KBDNSY          
0000 	KBDOTP          0003 	KBDP3O          0005 	KBDP5O          
0006 	KBDPCI          0001 	KBDPCS          0000 	KBDPIN          
D1F0 	KBDPT1          D1DC 	KBDPUT          D297 	KBDRC1          
D29B 	KBDRC2          D28B 	KBDRC3          D2AB 	KBDRC4          
D2B0 	KBDRC5          D29C 	KBDRC6          D26D 	KBDRCH          
D286 	KBDRCU          D182 	KBDRDT          0052 	KBDS2I          
0053 	KBDS2S          0059 	KBDS2T          0052 	KBDS3I          
0053 	KBDS3S          005A 	KBDS3T          0052 	KBDS4I          
0053 	KBDS4S          000C 	KBDS4T          004E 	KBDS5I          
004F 	KBDS5S          004A 	KBDS5T          005C 	KBDSCI          
005D 	KBDSCS          0058 	KBDSCT          D2C5 	KBDSLM          
0632 	KBDSMI          0633 	KBDSMS          0631 	KBDSMT          
0634 	KBDSNR          D17B 	KBDSNT          D03B 	KBDSST          
D169 	KBDST           D26B 	KBDST0          D24D 	KBDST1          
D24F 	KBDSTC          D171 	KBDSTI          D259 	KBDSTM          
D39B 	KBDSTS          D171 	KBDSTZ          0A48 	KBDTYP          
D20F 	KBDWA           D22E 	KBDWB           D233 	KBDWE           
D201 	KBDWIN          D216 	KBDWST          D20A 	KBDWT           
00C8 	KCURDW          00C4 	KCURLF          00C7 	KCURPD          
00C5 	KCURPU          00C6 	KCURRI          00C2 	KCURUP          
00C1 	KCURWL          00C3 	KCURWR          0A76 	KEMLWT          
0A7D 	KEMMC           03AF 	KENN1           0000 	KES             
0CBF 	KLTBEF          0CBE 	KLTKOM          0694 	KM06            
066A 	KM3454          0686 	KM3458          06A2 	KM36            
065C 	KM37            06B0 	KM3S            0678 	KM8454          
0649 	KMODI1          0655 	KMODI2          063F 	KMODIF          
0006 	KMODL           065E 	KMODT           004A 	KRITBG          
004C 	KRITEN          0000 	L2BAHN          D30F 	LAMPB0          
D303 	LAMPB1          D2F7 	LAMPB2          D2EB 	LAMPB3          
D2E2 	LAMPB6          0040 	LAMPBF          D318 	LAMPBN          
D2CA 	LAMPEN          D2CE 	LAMPLT          E6B7 	LIST            
D70B 	LISTI           E6AB 	LISTST          0081 	LKALTC          
07B3 	LMP04           07B5 	LMP04E          07A7 	LMP04W          
0766 	LMP06           077C 	LMP06E          077C 	LMP34           
079A 	LMP3404         078F 	LMP34A          0795 	LMP34B          
07A4 	LMP34C          07B3 	LMP34E          079A 	LMP34W          
07B5 	LMP36           07C8 	LMP36A          07CE 	LMP36B          
07EC 	LMP36E          07D3 	LMP36W          0004 	LMPB2B          
0005 	LMPB2R          0780 	LMPB34          07B9 	LMPB36          
07D3 	LMPDG06         07E0 	LMPDGW          0006 	LMPERR          
0007 	LMPHCP          D324 	LMPOUT          D327 	LMPOW           
0000 	LMPSL0          0001 	LMPSL1          0002 	LMPSL2          
0003 	LMPSL3          D75A 	LOUTTO          D75C 	LOUTTP          
D713 	LOUTW1          D731 	LOUTWF          D711 	LOUTWS          
D715 	LOUTWT          0058 	LPTCTR          0058 	LPTCTS          
005E 	LPTDAT          D149 	LPTI            D6FF 	LPTO            
D775 	LPTST           005F 	LPTSTA          D7B4 	LSTLPT          
D70B 	LSTO            D70B 	LSTOCH          D830 	LSTSB3          
D856 	LSTSD1          D85F 	LSTSD2          D83F 	LSTSDC          
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-5


D81A 	LSTSE0          D824 	LSTSE1          D83A 	LSTSR           
D83A 	LSTSR1          D77B 	LSTST           D77B 	LSTSTI          
D797 	LSTTTY          D7D1 	LSTUC1          D782 	LSYNCH          
000C 	LTPCS           0001 	LTPDC           0006 	LTPI            
000B 	LTPINI          0004 	LTPO            D8A2 	LTPOT5          
D89F 	LTPOW5          0008 	LTPS            0003 	LTPSC           
0002 	LTPSD           0000 	LTPST           000A 	LTPW5           
E2E9 	LWEXIS          0006 	M8_16           0004 	MAXLW           
E7BE 	MBRECO          E319 	MDFM8           E30F 	MDMFM5          
E305 	MDMFM8          E2F0 	MDTBAD          000A 	MDTBL           
0000 	MKD256          00A8 	MODADR          E061 	MODFL1          
E066 	MODFL2          00DB 	MONC            0000 	MONITOR         
0000 	MPROT           E7C2 	MRECA           E7BF 	MRECOA          
E7CF 	MRECOD          E7C2 	MRECOL          E7C6 	MRECOR          
DA05 	ND8MF           E022 	NFDEI2          DA26 	NFRTFM          
09D2 	NJUNG3          E1BB 	NOERR           DFF5 	NOLW            
E0AB 	NPOST0          E72E 	NSTPSP          E745 	NSYNLR          
0000 	N_PAGEN         0007 	N_PE            0002 	N_RAMEN         
0005 	N_S             0003 	N_STOP          0005 	N_TRQ8          
0003 	N_VI            0001 	N_WRITE         0000 	OEM             
0000 	OSS             038C 	PAINIT          E5C4 	PARERR          
0362 	PARMES          E5AB 	PARROU          038F 	PBINIT          
00E0 	PF0C            00E1 	PF1C            00E2 	PF2C            
00E3 	PF3C            00E4 	PF4C            00E5 	PF5C            
00E6 	PF6C            00E7 	PF7C            00E8 	PF8C            
00E9 	PF9C            00EA 	PFAC            00EB 	PFBC            
00EC 	PFCC            00ED 	PFDC            00EE 	PFEC            
00EF 	PFFC            E112 	PHRW            E116 	PHRWW           
E114 	PHRWW1          0007 	PHYACT          0000 	PIOA_0          
0001 	PIOA_1          0002 	PIOA_2          D78D 	PORTPR          
D78D 	PORTPZ          E13B 	PREC            E2A0 	PRET1           
E29D 	PRET3           E292 	PRET4           E290 	PRETX           
0006 	PRRESET         E15D 	PSIDE0          E15F 	PSIDE1          
E169 	PSIDE2          E69F 	PUNCH           E7A4 	PUTMES          
E112 	PVRW1           E11B 	PVRW2           0000 	RAF             
0000 	RAMBYT          0C9F 	RAMEAD          0975 	RAMEH           
0C84 	RAMERT          0CB4 	RAMETE          0001 	RAMFL           
0040 	RAMKB           E59F 	RAMOFF          E56C 	RAMON           
09B0 	RAMTEN          0990 	RAMTER          0C78 	RAMTOK          
0C56 	RAMTT           095E 	RAMTZ           E549 	RDRAMF          
E11B 	RDWR            DC61 	READ            E693 	READER          
E687 	READES          0000 	REBOOT          0004 	RESET16         
E5EB 	RET             E5C3 	RETTEA          0000 	RNA             
0018 	RQMASK          DFB7 	RTRACK          E3BC 	SECAN1          
E22B 	SECANZ          DBE5 	SECTRAN         E2E8 	SEERC           
00D1 	SEL0            00D2 	SEL1            00D4 	SEL2            
00D8 	SEL3            DA97 	SEL48           DAF1 	SEL5ZL          
DAFF 	SELD40          DBBE 	SELDAL          DB4D 	SELDDR          
DAAE 	SELDL1          DBB9 	SELDLA          DAA3 	SELDLE          
DB3F 	SELDO0          DB40 	SELDOF          D992 	SELDSK          
DB07 	SELDSS          DAC1 	SELDSV          DAD0 	SELDXL          
DBC5 	SELEXT          DBC5 	SELEXX          DA74 	SELNFM          
DB07 	SELSET          DA93 	SELSS           DA05 	SELSTZ          
DA58 	SELSY0          DA5B 	SELSY1          DA48 	SELSY2          
DA5D 	SELSYS          E45A 	SERR            E461 	SERR1           
E46B 	SERR2           E1F6 	SERRX           E851 	SETCLD          
DBE0 	SETDMA          DFD8 	SETECR          DFDF 	SETESP          
DBDB 	SETSEC          DBD6 	SETTRK          DB84 	SF128E          
DB67 	SF128Z          0000 	SG0P            0001 	SG1B            
E3C7 	SIDLEN          E3C6 	SIDSEC          E3C4 	SIDSID          
E3C3 	SIDTR           DFED 	SP13            E24B 	SP74            
00CC 	SPCCE           00CA 	SPCCLR          00CB 	SPCCNC          
BIOS CP/A, Buerocomputer (A5120/30 u. ae.)	MACRO-80 V3.50	25-Oct-85	Page	S-6


00C0 	SPCDEL          00CD 	SPCINS          00CE 	SPCKOR          
00CF 	SPCROL          00D0 	SPCROR          E0B1 	SPE             
E2E7 	SPERC           E211 	SPERR2          E20B 	SPERR4          
D73B 	SPIOER          E2EC 	SPNRL           E0B1 	SPPRTY          
E0CB 	SPRE            E0C7 	SPVE            E176 	SRDSID          
E0D1 	STEP            E0D4 	STEP0           E0D8 	STEP2           
E0E9 	STEPW           E0E7 	STEPW1          E79A 	STOPCH          
E775 	STOPNU          0004 	STOPRQ          E75F 	STOPRT          
E762 	STOPZ           E786 	STOPZ2          E76D 	STOPZU          
00DE 	STPC            E78D 	STPCHP          F0DF 	STPSTK          
0001 	STPVAR          0006 	STZAUS          D615 	SWILMP          
00D9 	SYLC            D03D 	SYNFLG          0003 	SYNLRQ          
D03E 	SYNSEM          000C 	SYSCTC          E65F 	T1NMO1          
E659 	T1NMO2          E603 	T5IHL           03A0 	TESTK1          
03A8 	TESTK2          0043 	TIM1CN          0003 	TIM1CT          
E629 	TIM1IT          E5F7 	TIM1OF          E5F0 	TIM1ON          
E5F2 	TIM1OT          0045 	TIM1RT          E639 	TIM1UP          
E64B 	TIM1UU          0041 	TIM5CN          0002 	TIM5CT          
E5FB 	TIM5IT          E5EC 	TIM5OF          E5E5 	TIM5ON          
E5E7 	TIM5OT          0030 	TIM5ZK          0100 	TPA             
C205 	TPAEND          0007 	TREN            E0F3 	TRK0            
E10C 	TRK0F           E0F5 	TRK0I           E0FE 	TRK0S           
0394 	TSTKNG          000C 	TTYCTR          000C 	TTYCTS          
0050 	TTYDAT          D149 	TTYI            D6F9 	TTYO            
D76F 	TTYST           0051 	TTYSTA          0024 	TYP80           
00A0 	TYPC34          0080 	TYPC37          0010 	TYPC3S          
0014 	UC1BFL          D97D 	UC1BFP          D97E 	UC1BUF          
000C 	UC1CTR          000C 	UC1CTS          0050 	UC1DAT          
D963 	UC1ERR          D8DB 	UC1I            D8D7 	UC1I2           
D8DF 	UC1II           0004 	UC1IL           D906 	UC1IRD          
D8DF 	UC1IW           D705 	UC1O            D94B 	UC1RI1          
D95B 	UC1RI2          D919 	UC1RIN          D946 	UC1RIR          
D8B0 	UC1SI           D8CF 	UC1SI1          D8AC 	UC1ST           
0051 	UC1STA          0000 	UHRVAR          0001 	UMLAUT          
D697 	UMLCN1          0002 	UMLFLG          000B 	UMLLEN          
D69A 	UMLTB1          D6A5 	UMLTB2          DFBE 	UNACNT          
DFBF 	UNADEV          DFC2 	UNASEC          DC55 	UNATR1          
DFC0 	UNATRK          0059 	VERSJ           0009 	VERSM           
0019 	VERST           E7B0 	WAIT10          E7B5 	WAIT1Z          
E7B3 	WAIT2Z          E7E1 	WARMST          E7F2 	WBINIT          
0000 	WBOOTV          DBE9 	WRITE           E188 	WRITPT          
E526 	WRRAMF          DF6F 	XLT             E0BE 	XMAXTR          
E0AF 	XPVRW           00DD 	Z000            00DC 	Z00C            
00F0 	ZBL0            00DC 	ZBL00           00DD 	ZBL000          
00F1 	ZBL1            00F2 	ZBL2            00F3 	ZBL3            
00F4 	ZBL4            00F5 	ZBL5            00F6 	ZBL6            
00F7 	ZBL7            00F8 	ZBL8            00F9 	ZBL9            
00FC 	ZBLA            00C9 	ZBLB            00FE 	ZBLC            
00FA 	ZBLKOM          00FB 	ZBLMIN          0000 	ZSIBM           
0001 	ZSUML           



No Fatal error(s)


UMLLEN 