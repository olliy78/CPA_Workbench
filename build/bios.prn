BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1


                                	title	BIOS CP/A fuer PC1715
                                	name	('BIOSMOD')
                                 	.z80
                                	.tfcond		;bei Assembler-Aufruf mit "/X" vollst. Listing
                                
                                ; Versionsangabe:
                                ;----------------
  0018                          verst	equ	24	;Tag
  0005                          versm	equ	05	;Monat
  0058                          versj	equ	88	;Jahr
                                
                                	.list
                                
                                	entry	BIOS,BIOSCE
  0E00                          bdosln	equ	0e00h
  0800                          ccpln	equ	0800h
                                
  0000'                         BIOS:
                                
                                ;***********************************************************
                                ; Generierungsvarianten und andere Equ's:
                                ; =======================================
                                
                                ; Vorbemerkung:
                                ; Alle in '"..."' eingeschlossenen Worte sind Bezeichner,
                                ; die in dem vorliegenden Assembler-Quelltext gesetzt werden.
                                
                                ;------------------------------------------------------------
                                ; BIOS-Laenge (Grundwert, wird spaeter evtl. modifiziert!)
                                ; -----------
                                ;	minimal erreichbare BIOS-Laenge
                                ;	einschl. 2k Bildschirmpuffer
                                ;	 ohne Interruptvektoren
                                ;	 0 Diskettenlaufwerke
                                ;	 ohne Diskettenpuffer
                                ;	 ohne Extra's
  13B0                          biosln	aset	13b0h
                                
                                ; Durch Weglassen der CP/A-Extras kann man den TPA-Bereich
                                ; um den Wert vergroessern, der sonst zu 'biosln' addiert
                                ; wird.
                                
                                ;------------------------------------------------------------
                                ;	Speicher
                                ;	~~~~~~~~
                                ; Bei Kaltstart erfolgt ein nichtzerstoerender RAM-Test von
                                ; "tpa"+3 bis "tpaend".
                                ; Wird dabei ein Speicherfehler erkannt, so wird auf die
                                ; letzten 3 fehlerfreien RAM-Zellen ein Sprung zum BDOS abge-
                                ; legt und der BDOS-Sprung auf Hauptspeicherplatz 5-7 auf
                                ; diesen Sprung gefuehrt. Ausserdem erfolgt eine entsprechende
                                ; Fehlermeldung beim Kaltstart.
                                
  0040                          ramkb	equ	64	;RAM-Groesse in Kilobytes
                                ;			 Bildschirmpuffer am Ende!
  0000                          rambyt	equ	ramkb*1024
                                
  0000                          oss	equ	0	;keine OSS-Karte unterstuetzt
                                
                                ; Wenn eine 16-Bit-Erweiterungskarte mit 256k-Speicher EM256 in-
                                ; stalliert ist, so kann dieser Speicher als RAM-Floppy 'M:' be-
                                ; nutzt werden. 
                                ; Bei "em256" ungleich Null wird das Vorhandensein einer Erweite-
                                ; rungskarte getestet. Bei vorhandener EM256 wird beim Kaltstart
                                ; die RAM-Floppy eingerichtet.
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-1


                                ;
  0000                          em256	equ	0	;=0 ,wenn keine 16-Bit-Erweiterung
                                			;=1 ,wenn 16-Bit-Erweiterung vorhanden
                                	IF 	em256
                                	ENDIF
                                
  0000                          kes	equ	0	;keine Testram KES unterstuetzt
                                
                                ; Wenn mindestens eine RAF-Karte des ZWG der AdW vorhanden ist (beliebig
                                ; bestueckt, auch nur teilweise und/oder gemischt, max. 2M Byte pro Karte,
                                ; max. 4 Karten mit aufeinanderfolgenden E/A-Adressen), so kann bzw.
                                ; koennen diese als RAM-Floppy 'M:' benutzt werden (ueber "SWAP A: M:"
                                ; bei Bedarf spaeter auch als LW A:)
                                ; Bei "raf" ungleich Null wird das Vorhandensein von RAF-Karten getestet.
                                ; Bei vorhandener(n) Karte(n) wird beim erstmaligen Kaltstart nach dem
                                ; Einschalten des Stromes die RAM-Floppy eingerichtet, bei RESET bleibt ihr
                                ; Inhalt erhalten. Der RAM-Floppy-Inhalt bleibt auch bei der erstmaligen
                                ; Initialisierung erhalten, im Verzeichnis wird lediglich E5h auf jeden
                                ; Eintrag geschrieben, so dass Files trotzdem ueber POWER-reclaim
                                ; wiederhergestellt werden  koennen.
                                ;
  0000                          raf	equ	0	;=0 ,wenn keine RAF-Karte
                                			;=1 ,wenn RAF-Karte(n) vorhanden
                                 IF 	raf
                                 ENDIF
                                
  0000                          ramfl	equ	oss+kes+em256+raf
                                
                                
                                ;------------------------------------------------------------
                                ;	Kaltstart
                                ;	~~~~~~~~~
                                ; Es besteht die Moeglichkeit, beim Kaltstart des Systems automatisch
                                ; ein Kommando auszufuehren (dies kann auch ueber SUBMIT eine Kommando-
                                ; folge sein!).
                                
                                 IF1
                                 ENDIF
  0000                          cldcmx	equ	0		;=0, wenn Kommando nur bei Kaltstart
                                				;    nach Einschalten auszufuehren
                                				;=1, wenn Kommando auch bei RESET
                                				;    auszufuehren
                                
                                ;------------------------------------------------------------
                                ;	Warmstart
                                ;	~~~~~~~~~
                                ; Im Normalfall wird das CCP von einer im BIOS gehaltenen Kopie
                                ; bei jedem Warmstart vor das BDOS kopiert, wodurch keine Sy-
                                ; stemspuren auf Laufwerk A erforderlich sind. Um einen maximal
                                ; grossen TPA zu erhalten, sind auch andere Varianten moeglich:
                                
  0000                          wbootv	equ	0
                                ;		=0:	CCP-Kopie im BIOS (2K grosser Puffer)
                                ;		=1:	keine CCP-Kopie, Warmstart=Kaltstart
                                ;			(Kaltstart-Kommando sollte leer sein!)
                                ;		=2:	keine CCP-Kopie, CCP aus File '@os.com'
                                ;		=3:	CCP-Kopie in RAM-Floppy (RAM-Floppy
                                ;			dann um 2K kleiner),
                                ;			wenn keine RAM-Floppy vorhanden
                                ;			(siehe "Hauptspeicher"), so wie wbootv=1
                                ; Bei "wbootv"<>0 und Arbeit ohne Diskettenpuffer kann der
                                ; Kaltstart-Code u.U. bis in den Bildschirmpuffer reichen,
                                ; wodurch der Bildschirm beim Kaltstart kurzzeitig undefi-
                                ; niert sein kann.
                                
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-2


                                	IF	wbootv eq 0
  1C40                          biosln	aset	biosln+90h+ccpln;2K fuer CCP-Kopie
                                	ENDIF
                                	IF	(wbootv eq 2) or (wbootv eq 3)
                                	ENDIF
                                
                                
                                ;------------------------------------------------------------
                                ;	BIOS-Monitor
                                ;	~~~~~~~~~~~~
  0001                          monitor equ	1	;=1: mit  BIOS-Monitor
                                ;			 =0: ohne
                                	IF	monitor
  1FD0                          biosln	aset	biosln+390h	;Laenge Monitorcode dazu
                                	ENDIF
                                
                                
                                ;------------------------------------------------------------
                                ;	STOP-Funktion
                                ;	-------------
  0001                          stpvar	equ	1	;=1: mit Unterstuetzung STOP-Funktion
                                			;=0: ohne,
                                			;    es werden auch alle Drucker-Sondert. ign.
                                	IF	stpvar
  20A0                          biosln	aset	biosln+0d0h
                                	ENDIF
                                
                                ;------------------------------------------------------------
                                ;	Speicherschutz
                                ;	~~~~~~~~~~~~~~
  0000                          mprot	equ	0	;hardwaremaessig bei PC1715 nicht moeglich
                                
                                ;------------------------------------------------------------
                                ;	Status-Zeile
                                ;	------------
  0000                          cpastz	equ	0	;=1: mit 25./17. Statuszeile
                                			;=0: ohne Statuszeile (wie BC A51xx)
                                ; Wird beim PC1715 mit kleinem Bildschirm die Loetbruecke X12
                                ; nicht wie fuer 24*80 BAB2 geaendert, so ist cpastz=0 zu setzen.
                                ; Soll eine zusaetzliche Zeile fuer die normale Bildschirmarbeit benutzt
                                ; werden (siehe "crtbig" bei Bildschirmdef.), so ist cpastz=0 zu setzen.
                                
                                	IF	cpastz
                                	ENDIF
                                
                                ;------------------------------------------------------------
                                ;	Fehlermeldungen des BIOS
                                ;	------------------------
  0000                          errvar	equ	0	;=1: mit BIOS-Fehlermeludngen
                                			;=0: ohne
                                	IF	errvar
                                	ENDIF
                                
                                ;------------------------------------------------------------
                                ;	Uhr
                                ;	---
  0008                          sysctc	equ	08h	;System-CTC, Kanal 0
                                ;Fuer die Uhr wird Kanal 3 benutzt, Kanal 0, 1 fuer Drucker
                                ;bzw. V.24; Kanal 2 (Port 0ah!) wird entspr. des Bildschirmformats
                                ;mit 0 bzw. 40h geladen, so dass A5120/30 Software mit dynami-
                                ;schem Bildschirmtest auf Port 0ah, Bit 6 unveraendert laeuft!!
                                
                                
  0000                          uhrvar	equ	0	;=1: mit BCD-Uhr (Platz siehe "bcduhr")
                                ;			 =0: ohne
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-3


                                	IF	uhrvar
                                	ENDIF
                                
                                ;------------------------------------------------------------
                                ;	IOBYTE
                                ;	------
  0001                          iobvar	equ	1	;=1: mit IOBYTE-Unterstuetzung
                                			;=0: ohne (wie IOBYTE=00h)
                                	IF	iobvar
  2140                          biosln	aset	biosln+0a0h
                                	ENDIF
                                
                                ;------------------------------------------------------------
                                ;	Vereinbarungen fuer zeichenweise arbeitende Geraete (i.a. Drucker)
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                                ; gaengige Hardware (auch andere zulaessig):
                                ;	Ausgang PC1715	Daten	Status	CTC S/E	Bemerkungen
                                ;	Printer 	0c	0e	08/08	nur DTR senden
                                ;	V24		0d	0f      09/09
                                ;	Kanal A		14	16	10/11	DC1/3, IFSS
                                ;	Kanal B		15	17	12/12	DC1/3, IFSS
                                
                                ; Diese Ausgaenge koennen physischen CP/M-Geraeten entsprechend
                                ; der I/O-Byte-Belegung zugewiesen werden:
                                ; TTY:	bei Kaltstart zugewiesener Drucker 		(kann fehlen)
                                ; LPT:	zweiter Drucker 				(kann fehlen)
                                ; UC1:  Geraetekopplung ueber CON: oder RDR:/PUN: 	(kann fehlen)
                                ;       Fuer UC1: nur Treiber-Typ DC1/3 oder DTR erlaubt (kein PIO)!
                                
                                ; Im folgenden fuer 'iobxxx', 'xxxdat', 'xxxsta', 'xxxcts', 'xxxctr'
                                ; jeweils die Parameter angeben:
                                ; (=00000 fuer fehlenden, d.h. vom BIOS nicht unterstuetzten Tr.)
                                ; Sind alle Treiber-Nr. =0, so entfaellt der gesamte Treiber-
                                ; teil im BIOS (fuer Testzwecke zum Erreichen eines grossen
                                ; TPA, alle Ausgaben und Druckersondertasten ignoriert)
                                ; Format fuer 'iobxxx':
                                ; PSCBT
                                ; PSCB  nur bei T<5 angeben, sonst 0000
                                ; P		Paritaet
                                ;		0 ohne Paritaet; 1 ungerade Paritaet; 2 gerade Paritaet
                                ;  S		Stopbits
                                ;		1  1   Stopbit
                                ;		2  2   Stopbits
                                ;		3  1.5 Stopbits (nur bei IFSS erlaubt)
                                ;   C		Anzahl der Bits pro Zeichen (5..8)
                                ;    B		Baudrate
                                ;		1:9600,2:4800,3:2400,4:1200,5:600,6:300,7:150,8:100,9:75
                                ;     T		Treiber-Typ
                                ;		0:DC1/DC3, 1:DTR
                                ;		5:PIO, 6:PIO1154, 7:PIO1156 neg., 8:PIO1156 pos.
                                
                                
                                ;Standard-Drucker
                                ;================
                                
  0713                          iobtty	equ	01811	;ohne P.;1 Stbit;8 Bit;9600;DTR (z.B. EPSON LX86)
  000C                          ttydat	equ	0ch	;am Printer-Ausgang
  000E                          ttysta	equ	0eh
  0008                          ttycts	equ	08h
  0008                          ttyctr	equ	08h
                                
                                
                                ;zweiter Drucker
                                ;===============
                                
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-4


  0000                          ioblpt equ     0        ;kein zweiter Drucker
                                ;ioblpt	equ	11710	;ung. P.;1 Stbit;7 Bit;9600;DC1/3
                                ;lptdat	equ	14h	;am IFSS A
                                ;lptsta	equ	16h
                                ;lptcts	equ	10h
                                ;lptctr	equ	11h
                                
                                
                                ;Kopplung
                                ;========
                                
  0713                          iobuc1	equ	01811	;ohne P.;1 Stbit;8 Bit;9600;DTR
  000D                          uc1dat	equ	0dh	;am V.24-Ausgang (wegen SIO Kanal B verwenden!!)
  000F                          uc1sta	equ	0fh
  0009                          uc1cts	equ	09h
  0009                          uc1ctr	equ	09h
                                
                                
                                ; Ueber diese Treiber koennen unter Beachtung des unterschiedlichen
                                ; Steuerzeichenvorrats beliebige Geraete angeschlossen werden, die
                                ; Treiber-Software ist steuerzeichenunabhaengig
                                ; (ausser TTY: und LPT: bei generierter Variante 2-Bahn-Drucker).
                                
  FFFF                          chdvar	equ	(iobtty ne 0) or (ioblpt ne 0) or (iobuc1 ne 0)
                                
                                	IF	chdvar
  2250                          biosln	aset	biosln+110h	;Grundroutinen Einzelzeichen-Treiber
                                	IF	stpvar
  22E0                          biosln	aset	biosln+090h	;asynchrone LST:-Routinen
                                				;und Hardcopy
                                	ENDIF
                                	ENDIF
                                
                                	IF	((iobtty mod 10) eq 7) or ((ioblpt mod 10) eq 7)
                                	ENDIF
                                	IF	((iobtty mod 10) eq 8) or ((ioblpt mod 10) eq 8)
                                	ENDIF
                                
                                	IF	iobuc1
  0014                          uc1bfl	equ	20		;Laenge des UC1:-Puffers
                                				;muss z.B. 2k Bildschirmrollen abfangen!
                                				;d.h. >=20 bei 9600 bd 
  23C4                          biosln	aset	biosln+0d0h+uc1bfl ;UC1:-Routinen + UC1:-Puffer
                                	ENDIF
                                
                                ; Es besteht die Moeglichkeit, 2-Bahn-Drucker getrennt fuer
                                ; jede Bahn zu betreiben (nur Druckerschnittstelle 1):
  0000                          l2bahn	equ	0		;>0: Position fuer 2. Bahn (i.a. 138)
                                				;=0: keine 2. Bahn unterst.
                                	IF	l2bahn
                                	ENDIF
                                
                                ;------------------------------------------------------------
                                ;	Vereinbarungen fuer Disketten
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                                
  0001                          @write	equ	1	;bei <>0 auch Schreiben auf Disketten unterst.
                                ; Es werden maximal 4 Diskettenlaufwerke A..D dicht von A
                                ; beginnend unterstuetzt.
                                ; Diese koennen sowohl 5 1/4 " als auch 8" Laufwerke sein
                                ; (auch gemischte Konfigurationen erlaubt!).
                                ; Fuer jedes Laufwerk kann Zuruecklesen nach jedem Schreiben verlangt
                                ; werden (Verify), fuer sichere Disketten und Laufwerke dies jedoch i.a.
                                ; nicht notwendig (Schreiben geht dann genauso schnell wie Lesen), lediglich
                                ; beim Anlegen einer Sicherheitskopie sollte explizit Verify vom Kopier-
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-5


                                ; programm verlangt werden ([v] bei POWER bzw. DIENST). Die bei der System-
                                ; generierung eingestellte Variante kann durch FORMAT laufwerksspezifisch
                                ; geaendert werden.
                                
                                ; Folgende Angaben sind verbindlich:
                                ;DSZTT
                                ;D		Density; 0 single (SD bzw. FM), 1 double (DD bzw. MFM)
                                ; S		Sided; 0 single (SS), 1 double (DS)
                                ;		bei Verify nach Schreiben S+2 angeben
                                ;  Z		5 fuer 5 1/4 ", 8 fuer 8 "
                                ;   TT		Anzahl der tracks
                                ; z.B.
                                ; 10540		DD, SS, 5", 40 Tracks (z.B. K5600.10)
                                ; 10580		DD, SS, 5", 80 Tracks (z.B. K5600.20)
                                ; 11580		DD, DS, 5", 80 Tracks
                                ; 00877		SD, SS, 8", 77 Tracks (z.B. MF3200)
                                ; 10877		DD, SS, 8", 77 Tracks (z.B. K5602.10, MF6400))
                                ; 0		nicht ex. (immer am Ende!)
                                
  2D3C                          diskA	equ	11580
  2D3C                          diskB	equ	11580
  0000                          diskC	equ	0
  0000                          diskD	equ	0
                                
                                ; Es wird eine automatische Formaterkennung fuer gaengige CP/M-
                                ; Diskettenformate einschliesslich der SCP-Hausformate von CP/A
                                ; unterstuetzt. Dies kann unterdrueckt werden, wenn nur mit
                                ; festen Formaten gearbeitet wird (und eine extra CP/A-Variante
                                ; fuer den Datenaustausch mit Formaterkennung existiert). In
                                ; diesem Fall haben die Disketten das Standard-CP/A-Format ent-
                                ; sprechend dem vorgegebenen LW-Typ.
                                
  0001                          format	equ	1	;=0: ohne automatische Formaterkennung
                                			;=1: mit
                                 IF format
  25A4                          biosln	aset	biosln+1e0h	;Routinen +Tabellen
                                
                                ; Zur automatischen Format-Erkennung von SIOS-Datendisketten wird
                                ; auf 40h in Spur 0, Sektor 1 geprueft. Solche Disketten duerfen
                                ; also keine System-Lader-Informationen haben und werden dann als
                                ; "CP/M"-Disketten ohne Systempuren behandelt. Dadurch ist die Anwen-
                                ; dung von Original-Konvertierungsprogrammen IBM<->CP/M moeglich
                                ; {unter SCP existierende Programme laufen u.a. nur dann, wenn sie
                                ; konsequent den BIOS-Entry 30h (Sektornr. uebersetzen) nutzen!}.
                                
                                ; Ohne automatische Formaterkennung oder bei vorhandenen System-Lader-
                                ; informationen auf der SIOS-Diskette muss das Format explizit einge-
                                ; stellt werden (26*128 einseitig ohne Systemspuren).
                                
  0001                          ibmfrm	equ	1	;=0: keine Erkennung von IBM-Format-Disketten
                                			;=1: mit
                                 IF ibmfrm
  25A8                          biosln	aset	biosln+4
                                 ENDIF
                                
                                 ENDIF
                                
                                 IF1
                                 ENDIF
  0002                          disk5	aset	dsk5fm+dsk5mf
  0000                          disk8	aset	dsk8fm+dsk8mf
  0002                          disknb	aset	disk5+disk8
  267E                          biosln	aset	biosln+disknb*6bh	;Diskettensteuerbloecke
  267E                          biosln	aset	biosln+dsk8mf*26	;Verlaengerung Sektortab.
  26DE                          biosln	aset	biosln+disk8*16+dsk80*48;Checksize beruecks.
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-6


                                 IF disk8
                                 ENDIF
                                
                                ; Die Disketten Ein-/Ausgabe kann gepuffert verlaufen.
                                ; "dbufsz"<=7 fuehrt zur ungepufferten Arbeit (Codeeinsparung).
                                ; Die Angabe der Pufferlaenge erfolgt als Exponent von 2, d.h.
                                ; die Puffergroesse ist 2**dbufsz !
                                
  000A                          dbufsz	equ	10		;2**dbufsz = Pufferlaenge
                                	IF	dbufsz gt 7
  2C5E                          biosln	aset	biosln+180h+(1 shl dbufsz);Diskpuffer dazu
                                	ENDIF
                                
                                ; Der Diskettenpuffer muss mindestens so gross wie die groesste
                                ; physische Sektorlaenge entspr. dem Spurformat sein, also
                                ; i.a. 1K. Fuer eine exakte BDOS-Rueckmeldung von Schreib-
                                ; fehlern (BAD SECTOR) darf die Puffergroesse nicht groesser
                                ; als die kleinste Blockgroesse fuer Disketten (1 K) sein,
                                ; da sonst die Pufferausgabe erst erfolgt, wenn mit anderen
                                ; Daten gearbeitet werden soll.
                                ; Vorzugswert fuer "dbufsz" ist daher 10!
                                ; Mehr als die maximale Spurlaenge von ca. 6 1/4  K ergibt
                                ; keinen Gewinn, d.h. "dbufsz"<=13 .
                                ; "dbufsz"<12 fuehrt zu einer ungepufferten Arbeit bei Sektor-
                                ; laenge 128, da die Effektivitaet wegen des Sektorversatzes
                                ; bei Pufferung von Teilen einer Spur sinkt!
                                
                                
                                ;------------------------------------------------------------
                                ;	Vereinbarung der Tastatur
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~
                                ; Es wird lediglich die Standard-Tastatur des PC 1715 unterstuetzt.
                                
                                ; SIO-Tastatur (Kanal A Empfaenger, Kanal A Sender ist "Printer")
                                ; Der SIO hat keinen CTC als Takt, da Takt von PC1715-Tastatur geliefert wird.
  000C                          kbdsci	equ	0ch	;Zeichen E/A
  000E                          kbdscs	equ	0eh	;Status
                                
                                ; Der Tastaturpuffer befindet sich bei Arbeit mit Statuszeile
                                ; an deren Ende, so dass der Kopf staendig auf dem Bildschirm
                                ; sichtbar ist. Ohne Statuszeile ist er im BIOS-Arbeitsbereich.
                                
  0011                          kbdbl	equ	17	;1..47, Zahl zu puffernder Zeichen
                                			;Weniger als 47 laesst auch bei Arbeit
                                			;mit Statuszeile am Speicherende Bytes
                                			;als BIOS-Patch-Bereich frei.
                                
                                 IF cpastz	;Puffer benoetigt keinen zusaetzlichen Platz
                                 ELSE
  2C6F                          biosln	aset	biosln+kbdbl
                                 ENDIF
                                
                                ; Fuer die Tastatur wird die Arbeit mit Tastaturstrings unterstuetzt.
                                ; Es existiert sowohl eine Standardbelegung von Stringtasten als auch
                                ; die Moeglichkeit der nutzereignenen Definition bis auf Widerruf.
                                
                                 IF1
                                 ENDIF
  000A                          costu	equ	10	;>=0
                                			;bei =0 werden Verw.routinen eingespart
                                			;bei >0 Mindestlaenge fuer Nutzer-Tastendef.
                                			;    Tab. liegt direkt vor Int.vektoren
                                			;    und ist evtl. groesser!
                                	IF	costu
  2D19                          biosln	aset	biosln+0a0h+costu
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-7


                                	ENDIF
                                
                                ;------------------------------------------------------------
                                ;	Vereinbarungen fuer Bildschirm
                                ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                                ;Es wird sowohl ein grosser (24*80, BAB2) als auch ein kleiner
                                ;(16*64, BAB1) Bildschirm unterstuetzt. Die Treibermodifizierung
                                ;geschieht ohne notwendige Neuuebersetzung beim Kaltstart.
                                
                                ; 'bab' gibt die Vorzugsvariante an, die an den meisten Geraeten
                                ; vorhanden ist.
                                
  0002                          bab	equ	2	;=1 fuer BAB1, =2 fuer BAB2
                                
                                ;Ist 'uhrvar'=1, d.h. wird die Eingabe einer Uhrzeit bei Kalt-
                                ;start gefordert, so gibt 'babdyn' die maximale Wartezeit in
                                ;Sekunden an, die auf die Eingabe gewartet wird. Danach wird
                                ;auf das andere Bildschirmformat umgeschaltet und die Eingabe
                                ;erneut versucht. Die gleiche Wirkung hat die Eingabe von ESC
                                ;statt der Uhrzeit.
                                
  000A                          babdyn	equ	10	;max. Wartezeit in Sekunden auf Uhr-
                                			;zeiteingabe bis Wechsel des Bild-
                                			;schirmformates
                                			;=0 fuer unendlich (18,2 Std.)
                                
                                ;Ist keine CP/A-Statuszeile gefordert, so kann eine zusaetzliche
                                ;Bildschirmzeile gefordert werden (17 bzw. 25 Zeilen).
                                 if cpastz
                                 else
  0001                          babbig	equ	1	;=0 fuer normale Zeilenzahl
                                			;=1 fuer zusaetzliche Zeile
                                 endif 
                                ; vorgegebene Werte fuer Bildschirm:
                                ;-----------------------------------
  F800                          bsanf2	equ	0f800h		;Anfang Bildschirmpuffer BAB2
  F800                          bsanf1	equ	bsanf2		;dito BAB1
  0019                          bszl2	equ	24+babbig	;Zeilenzahl
  0011                          bszl1	equ	16+babbig	;dito BAB1
  0050                          bssp2	equ	80		;Spaltenzahl
  0040                          bssp1	equ	64		;dito BAB1
  FFCF                          bsend2	equ	bsanf2+bszl2*bssp2-1	;Pufferende
  FC3F                          bsend1	equ	bsanf1+bszl1*bssp1-1	;dito BAB1
                                 IF cpastz
                                 ENDIF
                                
                                ; Sondereinstellungen fuer Bildschirm:
                                ;-------------------------------------
  0002                          csf	equ	2		;Cursorformat
                                				;0 Block blinkend
                                				;1 Strich blinkend
                                				;2 Block invers ruhend
                                				;3 Strich ruhend
  0001                          fam	equ	1		;Field Attribut Modus
                                				;0 transparent
                                				;1 nicht transp. (wie BC A5120/30)
                                
                                ; Underline Placement (Zeichenzeile fuer 'Unter'streichen)
                                ;--------------------
                                ; Hardwaremaessig wird ueber Steuerzeichen eine Unterstreichen
                                ; von Zeichen unterstuetzt. Ist 'uplx'<=7, so wird bei inverser
                                ; Zeichendarstellung die volle Zeilenanzahl des Zeichens inver-
                                ; tiert (flaechige Darstellung bei aufeinanderfolgenden Text-
                                ; zeilen), sonst die obere und untere Zeichenzeile nicht.
                                ; Fuer die einfachen Pseudografik-Zeichen, die mit Hilfe der
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-8


                                ; Unterstreichung realisiert werden, bietet sich ein 'Unter'-
                                ; streichen etwa in der Zeichenmitte an.
                                
  0001                          upl	equ	1		;***12 mit  Unterstreichen BAB2
                                				; 1 ohne Unterstreichen
  0001                          upl1	equ	1		;14 mit  Unterstreichen BAB1
                                				;*** 1 ohne Unterstreichen
                                
  0084                          bsinic	equ	84h	;Steuerzeichen fuer Bildschirmzustand
                                ;			 nach dem Loeschen des Bildschirms
                                ;			 bei Kaltstart
                                ;			 z.B. auf 86h fuer andere Helligkeit
                                
                                ; Es existiert inzwischen ein Reihe von Software, die die SCP1715-Steuer-
                                ; zeichenfolgen 1b 5e xx (Feldattribut) und 1b 5f xx (Spezialzeichen) nutzt,
                                ; aber vom SCP1526 nicht unterstuetzt werden.
                                ; Diese Steuerzeichenfolgen koennen wahlweise unter CP/A unterstuetzt werden,
                                ; wobei fuer den Buerocomputer technisch bedingt nur die Feldattribut-
                                ; Funktionen invers und hell zugelassen sind (Reaktion wie Steuerzeichen
                                ; 84,85,86,87; alle anderen Funktionen fuehren zur Steuerzeichen-Fehlermeldung
                                ; durch Ausgabe von '^' auf dem Bildschirm an dieser Selle).
                                ; Wird im folgenden "escpc"=0 gesetzt, so werden obige Steuerzeichenfolgen
                                ; als Kursorpositionierfolgen behandelt und fuehren zu entsprechend sinnlosen
                                ; Effekten auf dem Bildschirm. Ausser aus Speicherplatzgruenden sollte daher
                                ; "escpc"=1 sein.
  0001                          escpc	equ	1	;=1 fuer Unterstuetzung 1b 5e xx und 1b 5f xx
                                			;=0 fuer fehlende Unterstuetzung
                                 IF escpc
  2D59                          biosln	aset	biosln+40h
                                 ENDIF
                                
                                ; Fuer eine effektivere Arbeit von TURBO-Pascal koennen wahlweise die
                                ; Nicht-SCP-Steuerzeichen 17h (Insert Line) und 19h (Delete Line)
                                ; vom Bildschirmtreiber unterstuetzt werden, wodurch der Bildschirm-
                                ; neuaufbau erheblich beschleunigt wird (keine Neuausgabe des gesamten
                                ; Bildschirmrestes). Hat nur Sinn, wenn TURBO-Pascal auch geaendert
                                ; wird, d.h. diese Steuerzeichen nutzt!
                                
  0001                          inslin	equ	1	;=1, wenn InsLine und DelLine zu unterstuetzen
                                			;=0 sonst
                                 IF inslin
  2DB9                          biosln	aset	biosln+60h
                                 ENDIF
                                
  0000                          adm3a	equ	0	;=1, wenn auch Unterst. einiger ADM3A-St.zeich.
                                ;			 =0, wenn nur SCP-Steuerz.
                                	IF	adm3a
                                	ENDIF
                                
  0000                          zs2var	equ	0	;=1, wenn Umschaltung 2. Zeichensatz zu unterst.
                                			;=0 sonst
                                	IF	zs2var
                                	ENDIF
                                
                                ; Durch Erweiterung des Zeichengenerators (EPROM-Aenderung!) ist eine
                                ; Unterstuetzung der deutschen Umlaute moeglich.
                                ; Genauere Informationen: IH Mittweida, Koll. Geiler
                                
  0000                          umlaut	equ	0	;=1, wenn Umlaute zu unterstuetzen
                                			;=0 sonst
                                
                                
                                ;------------------------------------------------------------
                                ;	Unterstuetzung weiterer Peripherie 
                                ;	----------------------------------
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-9


                                
                                ; Es gibt in CP/A grundsaetzlich folgende Moeglichkeiten fuer die
                                ; Unterstuetzung einer SIO-Bedienung (i.a. fuer Kopplungen):
                                ; a) Unterstuetzung als UC1:-Geraet
                                ;   (siehe Vereinbarungen fuer serielle Geraete).
                                ;   In diesem Fall erfolgt die Bedienung voll ueber das BIOS
                                ;   (im Interruptbetrieb, mit speziellem Empf.puffer im BIOS)
                                ;   Fehler werden nur als BIOS-Fehler gemeldet, das Anwenderprogramm
                                ;   erfaehrt davon nichts ueber die BIOS-Schnittstelle.
                                ; b) im Anwenderprogramm, keine Unterstuetzung im BIOS.
                                ; Im Fall b) - oder wenn es sich um andersartige Peripherie handelt -
                                ; bietet CP/A durch Veraenderung von "intvl" zusaetzlichen Platz in
                                ; der Interruptvektor-Tabelle an, so dass eine Umspeicherung der
                                ; BIOS-Interruptvektoren vermieden werden kann.
                                
                                ; Vom BIOS vorgegeben:
                                	IF	iobuc1
  00D0                          intvb	aset	0d0h		;d0..df SIO-Bedienung fuer UC1:-Treiber
                                	ENDIF
                                
                                ; Vom Anwender zu beeinflussen:
  00D0                          intvl	aset	intvb		;kleinster low-Interruptvektor
                                				;Kann 00h.."intvb" sein
                                				;("intvb"..ff wird vom BIOS benoetigt)
  2DE9                          biosln	aset	biosln+(100h-intvl)
                                
                                ;------------------------------------------------------
                                ;	absolute Hauptspeicherplaetze
                                ;------------------------------------------------------
                                ;		      Byteanzahl
  0000                          reboot	equ	0	;(3)	;Warmstart-Sprung
  0003                          iobyte	equ	3	;(1)	;I/O-Byte
  0004                          defaul	equ	4	;(1)	;DEFAULT-Disk
  0005                          bdosjp	equ	5	;(3)	;BDOS-Sprung
                                
                                 IF oss		;OSS-Hilfsadressen <4000h !
                                 ENDIF
                                
                                ; In CP/M zugelassener Scratch-Bereich fuer BIOS 40h..4fh
  0040                          lampbf	equ	40h	;(1)	;Puffer Tastaturlampen
                                				;Bedeutung (wenn Lampe vorhanden)
  0000                          lmpsl0	equ	0	;	Selektor 0
  0001                          lmpsl1	equ	1	;	Selektor 1
  0002                          lmpsl2	equ	2	;	Selektor 2
  0003                          lmpsl3	equ	3	;	Selektor 3
  0004                          lmpb2b	equ	4	;	2 Bahn Drucker beide Bahnen parallel
  0005                          lmpb2r	equ	5	;	2 Bahn Drucker rechte Bahn
  0006                          lmperr	equ	6	;	Fehler Lampe
  0007                          lmphcp	equ	7	;	Hardcopy (INSM) Lampe
  0041                          tim5cn	equ	41h	;(2)	;25-ms-Zaehler aufwaerts
  0043                          tim1cn	equ	43h	;(2)	;1-sec-Zaehler abwaerts
  0045                          tim1rt	equ	45h	;(2)	;Adr. der 1-sec Interr.routine
  004A                          kritbg	equ	4ah	;(2)	;Adr. der Nutzerroutine fuer Beginn zeit-
                                			;	;kritischer BIOS-Abschnitte (z.B. Floppy)
  004C                          kriten	equ	4ch	;(2)	;Adr. Enderoutine fuer kritbg
  004E                          cpmext	equ	4eh	;(2)	;Adr. Sprungvektor CP/M-Erw.
                                
                                 IF uhrvar
                                 ENDIF
                                
  0100                          tpa	equ	100h		;Programmladepunkt
                                
                                
                                ;************************Ende Varianten-Vereinbarungen
                                
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-10


                                 IF1
                                 ENDIF
                                	page	66
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-11


                                
                                
  C400                          BDOS	equ	biosad-bdosln	;vermeiden Externals, da linkmt
  BC00                          CCP	equ	BDOS-ccpln	;nicht ganz sauber ist
                                
                                ; Die folgenden EQU's dienen dazu, um bereits zum Zeitpunkt der
                                ; Uebersetzung eine Verschiebung des Ladepunktes durch ein zu
                                ; lang gewordenes BIOS zu erkennen.
                                
  2E00                          biosl0	aset	(biosln+0ffh) and 0ff00h;auf 256-Grenze runden
  D200                          biosad	aset	rambyt-biosl0	;BIOS-Ladeadresse
  C405                          tpaend	equ	biosad-bdosln+5	;Laenge BDOS abziehen
                                
  F700                          intvec	equ	rambyt-900h	;Interruptvektoradr.
                                ;				 liegt immer 100h vor BS-Puffer
                                ;				 bei 64k RAM auf F700H
  F7D0                          intvr	aset	intvec+intvl	;nur hinterer teil genutzt
                                
                                ;------------------------------------------------------------
                                ;	BEGINN BIOS-CODE
                                ;------------------------------------------------------------
                                
                                	.PHASE	biosad
                                 IF1
                                 ENDIF
                                
  D200    C3 E991               BIOS00:	JP	kaltst
  D203    C3 E8DE               BIOS03:	JP	warmst
  D206    C3 E730               BIOS06:	JP	const	;CON:	Status; oA =FF bereit, =00 sonst
  D209    C3 E73C               BIOS09:	JP	conin	;CON:	Zeichen oA (solange Warten)
  D20C                          conol:	;conout mit evtl. hardcopy
  D20C    C3 E748               BIOS0C:	JP	conout	;CON:	Zeichen iC
  D20F    C3 E784               BIOS0F:	jp	list	;LST:	Zeichen iC
  D212    C3 E76C               BIOS12:	jp	punch	;PUN:	Zeichen iC
  D215    C3 E760               BIOS15:	jp	reader	;RDR:	Zeichen oA (solange Warten)
  D218    C3 DB5A               BIOS18:	JP	home		;./. (trk:=0)
  D21B    C3 D990               BIOS1B:	JP	seldsk		;iC (0=A,1=B,..); oHL ^DPH
  D21E    C3 DB68               BIOS1E:	JP	settrk		;iBC
  D221    C3 DB6D               BIOS21:	JP	setsec		;iBC
  D224    C3 DB72               BIOS24:	JP	setdma		;iBC
  D227    C3 DBDF               BIOS27:	JP	read		;oA Resultat; A=0 ok, A=1 sonst
  D22A    C3 DB7B               BIOS2A:	JP	write		;oA Resultat; A=0 ok, A=1 sonst
  D22D    C3 E778               BIOS2D:	jp	listst	;LST:	Status; oA =FF bereit, =00 sonst
  D230    C3 DB77               BIOS30:	JP	sectran		;iBC log. Sektnr (ab 0!!),
                                				;iDE ^Sektor-Translate-Tabelle
                                				;oHL Sektornr. fuer setsec
                                
                                ; Die folgenden Bytes liegen an der gleichen Stelle im BIOS
                                ; wie bei SCP fuer Buerocomputer und dienen zur sicheren Er-
                                ; kennung von SCP-spezifischen Programmen, da diese an dieser
                                ; Stelle testen.
                                
  D233    43 50                 BIOS33:	db	'CP'		;SCP-Kennzeichen ist 'BW '
  D235    41                    	db	'A'		;'CPA'
  D236                          BIOS36:
  D236    50                    	db	'P'		;Hardware PC1715
  D237    36                    	db	'6'		;CP/A-Schnittstellen-Version
                                	
                                ; Die folgenden Bytes dienen der direkten Bildschirmbedienung ohne
                                ; BIOS-Benutzung fuer extreme Zeitanforderungen
  D238                          BIOS38:
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-12


  D238    F800                  crtcps:	dw	bsanf1		;Kursorposition im Bildschirmpuffer
  D23A    00                    crtccn:	db	0		;Zeittaktzaehler fuer Kursorpflege
                                ; Die folgenden Bytes dienen der Tastenumdefinition von aussen
  D23B                          BIOS3B:
  D23B    D49F                  kbdsst:	dw	kbdsts		;Standard-Stringtabelle (bei jedem Warmstart)
                                			;Aufbau: virt. Tastencode,Laenge,String,...,0ffh
  D23D                          BIOS3D:	
                                ; Die folgenden beiden Bytes dienen der Einstellung spezieller Zust. von aussen
                                ;*************************************************************
                                ;	Synchronisierungsflags
                                ;*************************************************************
                                
  D23D    00                    synflg:	db	0		;Synchr.-Flags
  0000                          ctrlst	equ	0		;CTRL-Status-Bit (=0 fest!)
                                 IF monitor
  0001                          monact	equ	1		;Monitor aktiv
                                 ENDIF
                                 IF umlaut
                                 ENDIF
                                 IF stpvar
                                  IF chdvar
  0003                          synlrq	equ	3		;Anforderung LST:-Kanal zu synchron.
                                  ENDIF
                                 ENDIF
  0004                          stoprq	equ	4		;Stop-Anforderung
                                 IF monitor
  0005                          monrq	equ	5		;Monitor-Anforderung
                                 ENDIF
                                 IF uhrvar
                                 ENDIF
                                 IF stpvar
  0007                          phyact	equ	7		;Tasten physisch in Puffer
                                 ENDIF
                                
                                ;!!synsem muss direkt nach synflg liegen!!
  D23E    01                    synsem:	db	1		;bei >0 keine asynchr. Arbeit
                                
  D23F                          BIOS3F:
                                ;=====================Ende des festen BIOS-Vektors=========================
                                
                                 IF1 ;dphaX wird spaeter bei existierendem Geraet X <>0 gesetzt
                                 ENDIF
                                
                                ; Parameterheader fuer Disketten
                                ;-------------------------------
                                
  0002                          @din	aset	disknb
                                	IRP	di,<A,B,C,D>
                                	IF	@din eq 0
                                	EXITM
                                	ENDIF
                                @din	aset	@din-1
                                dph&di:	DW	0,0,0,0,dirbuf
                                	DW	dpb&di,csv&di,alv&di
                                dpha&di	aset	dph&di
                                	ENDM
  D23F    0000 0000       +     dph&A:	DW	0,0,0,0,dirbuf
  D243    0000 0000       +     
  D247    F1E6            +     
  D249    D25F F298       +     	DW	dpb&A,csv&A,alv&A
  D24D    F266            +     
  D24F    0000 0000       +     dph&B:	DW	0,0,0,0,dirbuf
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-13


  D253    0000 0000       +     
  D257    F1E6            +     
  D259    D292 F30A       +     	DW	dpb&B,csv&B,alv&B
  D25D    F2D8            +     
                                
                                ; Bemerkungen zur Arbeit ohne automatische Formaterkennung:
                                ;---------------------------------------------------------
                                ; Die folgende DPB-Generierung erzeugt entspr. 'dbufsz' das
                                ; jeweilige Standardformat von CP/A, so dass dieses bei Arbeit
                                ; ohne automatische Formaterkennung eingestellt ist.
                                ; Nutzerspezifische Modifizierungen koennen in den Standard-DPB's
                                ; vorgenommen werden. Kommt dabei das Format der Kaltstart-
                                ; Diskette nicht mehr vor, so muss diese nach dem Kaltstart
                                ; gegen die Nutzerdiskette gewechselt werden. Dadurch ist z.B.
                                ; fuer extreme TPA-Anforderungen nur 128er Diskettenformat
                                ; moeglich (kein 1K Diskettenpuffer!), obwohl der Kaltstart von
                                ; einer Diskette mit 1K Sektoren erfolgte.
                                
                         C      	include	BIOPDPBM
                         C      ; Struktur DPB (einschl. Erweiterung gegenueber Standard-DPB)
                         C      ; Standard-Teil:
  0000                   C      dpbspt	equ	0	;(dw)	128-Sektoren pro Spur
  0002                   C      dpbbls	equ	2	;(db)	blockshift (3=1K, 4=2K)
  0003                   C      dpbblm	equ	3	;(db)	blockmask
  0004                   C      dpbexm	equ	4	;(db)	extentmask
  0005                   C      dpbsiz	equ	5	;(dw)	Kapazitaet -1 in Bloecken
  0007                   C      dpbdir	equ	7	;(dw)	Anzahl -1 DIR-Eintraege
  0009                   C      dpbalc	equ	9	;(dw)	Allocation-Bits fuer DIR
  000B                   C      dpbchk	equ	11	;(dw)	Check-Size fuer 'R/O'-Test
  000D                   C      dpbofs	equ	13	;(dw)	Zahl der Systemspuren
                         C      ; Ab Byte 15 folgt Nicht-Standard fuer DPB
                         C      
                         C      ; DPB-Steuerinformationen
  000F                   C      dpbflg	equ	15	;(db)	Flags, i.a. alle =0
  0003                   C      dpbfsm	equ	3	;	0..3 Zahl der abweichend vom
                         C      			;	restlichen Spurformat mit 
                         C      			;	26*128 formatierten Spuren
  0002                   C      dpbffm	equ	2	;	=1, wenn FM-Aufzeichung zu erzwingen
                         C      			;	    (d.h. FM-Disk in MFM-Laufwerk)
  0003                   C      dpbfsv	equ	3	;	=1, wenn Double sided zu betreiben,
                         C      			;	    indem von aussen nach innen
                         C      			;	    und auch Rueckseite von aussen
                         C      			;	    nach innen
                         C      			;	=0, wenn Double sided zu betreiben,
                         C      			;	    indem zunaechst von aussen nach
                         C      			;	    innen und Rueckseite von innen
                         C      			;	    nach aussen
                         C      			;	immer mit dpbf86+dpbfds zusammen setzen!
  0004                   C      dpbf86	equ	4	;	=1, dpbfsv benutzen
                         C      			;	=0, wenn Double sided zu betreiben,
                         C      			;	    indem ungerade logische Spuren
                         C      			;	    auf der Rueckseite liegen
                         C      			;	immer mit dpbfds zusammen setzen!
  0005                   C      dpbfds	equ	5	;	=1, wenn Double sided zu betreiben
  0006                   C      dpbfrm	equ	6	;	=1, wenn keine autom. Format-
                         C      			;	    erkennung in Seldsk
  0007                   C      dpbfnd	equ	7	;	=1, wenn abweichende DPB-Struktur
                         C      			;	    (keine Disketten)
                         C      
  0010                   C      dpbslc	equ	16	;(db)	Sektorlaengencode
  0011                   C      dpbbfm	equ	17	;(db)	Puffermaske, d.h. Anzahl der 128er
                         C      			;	Sektoren im Puffer -1
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-14


                         C      			;	muss < 2**(dbufsz-7) sein,
                         C      			;	muss < 2**dpbslc sein, wenn phys.
                         C      			;	Sektornummern in dpbstr nicht monoton
  0012                   C      dpbstp	equ	18	;(db)	Stepimpulse pro Spurpositionierung
                         C      			;	1 oder 2
  0013                   C      dpbsn0	equ	19	;(db)	Verschiebung der Sektor-Numm. auf Rueckseite
  0014                   C      dpbtrk	equ	20	;(db)	log. Anzahl Spuren
                         C      ; geraeteabh.Parameter:
  0015                   C      dpbdnr	equ	21	;(db)	physische Laufwerksnummer
  0016                   C      dpbptr	equ	22	;(db)	Gesamtzahl physische Spuren (40/77/80)
  0017                   C      dpbsti	equ	23	;(db)	Schrittzeit in 0.1 ms
  0018                   C      dpbtyp	equ	24	;(db)	Laufwerkstyp:
  0000                   C      dpbtds	equ	0	; =0 bei SS, =1 bei DS
  0003                   C      dpbtdd	equ	3	; =0 bei SD (FM), =1 bei DD (MFM)
  0004                   C      dpbt5z	equ	4	; =0 bei 8", =1 bei 5"
  0005                   C      dpbt80	equ	5	; =0 bei nicht 80-Spur, =1 bei 80-Spur
  0006                   C      dpbtwv	equ	6	; =0 ohne, =1 mit Verify nach Schreiben
  0007                   C      dpbt52	equ	7	; =0 bei max 26 ,=1 bei max 52 Sekt./Spur (8" MFM)
                         C      ; physische Sektortranslate-Tabelle (sollte am Ende liegen,
                         C      ; um bei festem Format mit weniger als 26 phys. Sektoren den
                         C      ; DPB entspr. verkuerzen zu koennen)
  0019                   C      dpbstr	equ	25	;(ds26)	entspr. phys. Sektoren pro Seite
                         C      
  0033                   C      dpblng	equ	dpbstr+26	;(max.) Laenge eines DPB
                         C      		;***bei 8" MFM:  52 Sektoren, d.h. dpblng um 26 groesser***
                                
  0002                          @din	aset	disknb
                                
                                ; Im folgenden kein IRP im Assembler moeglich, da INCLUDE
                                
                                 IF @din ne 0
  2D3C                          diskdi	aset	diska
  D25F                          DPBA:	
                         C      	include	BIOPDPB
                         C      
                         C       if dbufsz le 7
                         C       else
                         C       if dbufsz lt 10
                         C       else ;;dbufsz ge 10
                         C        if	((diskdi mod 10000)/1000) and 00000001b	;;DS
                         C         if	(diskdi mod 100) eq 40		;;40 Tr.
                         C         endif
                         C         if	(diskdi mod 100) eq 80		;;80 Tr.
  D25F    0028           C      	DW	40	;;(0)	;SECTORS/TRACK	(LOGIN)
  D261    04             C      	DB	4	;;(2)	;BLOCK SHIFT	(LOGIN)
  D262    0F             C      	db	0fh	;;(3)	;BLOCK MASK	(LOGIN)
  D263    00             C      	DB	0	;;(4)	;EXTENT MASK	(LOGIN)
  D264    0185           C      	DW	780/2-1	;;(5)	;Blockanzahl- 1 (LOGIN)
  D266    007F           C      	DW	128-1	;;(7)	;DIR MAX	(LOGIN)
  D268    C0 00          C      	DB	0c0H,0	;;(9)	;ALLOC fuer dir.(LOGIN)
  D26A    0020           C      	DW	32	;;(11)	;CHECK SIZE	(LOGIN)
  D26C    0004           C      	DW	4	;;(13)	;OFFSET		(LOGIN)
                         C         endif
                         C        endif
                         C       endif
                         C       endif
                         C      
                         C      ;; Nicht-Standard-DPB-Teil
  0000                   C      @dpbhl	aset	0
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0020                   C      @dpbhl	aset	@dpbhl+(1 shl dpbfds)		;;DS betreiben
                         C       endif
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-15


                         C       if	format
                         C       endif
  D26E    20             C      	db	@dpbhl
                         C       if dbufsz le 7
                         C       endif
                         C       if (dbufsz lt 10) and (dbufsz gt 7)
                         C       endif
                         C       if dbufsz ge 10
  D26F    03             C      	db	3		;;Sektorlaengencode
  D270    07             C      	db	7		;;Puffermaske 8*128
                         C       endif
  D271    01             C      	db	1		;;Zahl der Stepimpulse
  D272    00             C      	db	0		;;keine Weiter-Numm. auf Rueckseite
  D273    50             C      	db	diskdi mod 100	;;benutztye Zahl phys. Spuren
  D274    00             C      	db	disknb-@din	;;phys. LW-Nr.
  D275    50             C      	db	diskdi mod 100	;;maximale Zahl phys. Spuren
                         C       if	(diskdi mod 1000)/100 eq 5	;;5"
                         C        if	(diskdi mod 100) gt 40
                         C         if ((diskdi mod 10000)/1000) and 00000001b
  D276    28             C      	db	4*10		;;Schrittzeit fuer 80 Tr. DS LW
                         C         endif
                         C        endif
                         C       endif
                         C      
  0000                   C      @dpbhl	aset	0		;;vorbereiten Laufwerkstyp-Flags
                         C      
                         C       if	(diskdi ge 10000)
  0008                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtdd)	;;double density
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 5
  0018                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt5z)	;;5"
                         C       endif
                         C       if (diskdi mod 100) eq 80
  0038                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt80)	;;80-Spur-Laufwerk
                         C       endif
                         C       if	((diskdi mod 10000)/1000) and 00000001b	
  0039                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtds)	;;double sided
                         C       endif
                         C       if ((diskdi mod 10000)/1000) and 00000010b
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8"
                         C       endif
  D277    39             C      	db	@dpbhl	;;vom Laufwerkstyp abhaengige Flags
                         C      
                         C       if	(diskdi mod 1000)/100 eq 5 ;;5"
                         C        if dbufsz le 7 
                         C        else
                         C      ;; log. Sektortranslate-Tabelle fuer andere Formate
  D278    01 02 03 04    C      	db	1,2,3,4,5,6,7,8,9,10,11,12,13,14
  D27C    05 06 07 08    C      
  D280    09 0A 0B 0C    C      
  D284    0D 0E          C      
  D286    0F 10 11 12    C      	db	15,16,17,18,19,20,21,22,23,24,25,26
  D28A    13 14 15 16    C      
  D28E    17 18 19 1A    C      
                         C        endif
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8"
                         C       endif	;;8"
  0001                          @din	aset	@din-1
                                 ENDIF
                                 IF @din ne 0
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-16


  2D3C                          diskdi	aset	diskb
  D292                          DPBB:
                         C      	include	BIOPDPB
                         C      
                         C       if dbufsz le 7
                         C       else
                         C       if dbufsz lt 10
                         C       else ;;dbufsz ge 10
                         C        if	((diskdi mod 10000)/1000) and 00000001b	;;DS
                         C         if	(diskdi mod 100) eq 40		;;40 Tr.
                         C         endif
                         C         if	(diskdi mod 100) eq 80		;;80 Tr.
  D292    0028           C      	DW	40	;;(0)	;SECTORS/TRACK	(LOGIN)
  D294    04             C      	DB	4	;;(2)	;BLOCK SHIFT	(LOGIN)
  D295    0F             C      	db	0fh	;;(3)	;BLOCK MASK	(LOGIN)
  D296    00             C      	DB	0	;;(4)	;EXTENT MASK	(LOGIN)
  D297    0185           C      	DW	780/2-1	;;(5)	;Blockanzahl- 1 (LOGIN)
  D299    007F           C      	DW	128-1	;;(7)	;DIR MAX	(LOGIN)
  D29B    C0 00          C      	DB	0c0H,0	;;(9)	;ALLOC fuer dir.(LOGIN)
  D29D    0020           C      	DW	32	;;(11)	;CHECK SIZE	(LOGIN)
  D29F    0004           C      	DW	4	;;(13)	;OFFSET		(LOGIN)
                         C         endif
                         C        endif
                         C       endif
                         C       endif
                         C      
                         C      ;; Nicht-Standard-DPB-Teil
  0000                   C      @dpbhl	aset	0
                         C       if	((diskdi mod 10000)/1000) and 00000001b
  0020                   C      @dpbhl	aset	@dpbhl+(1 shl dpbfds)		;;DS betreiben
                         C       endif
                         C       if	format
                         C       endif
  D2A1    20             C      	db	@dpbhl
                         C       if dbufsz le 7
                         C       endif
                         C       if (dbufsz lt 10) and (dbufsz gt 7)
                         C       endif
                         C       if dbufsz ge 10
  D2A2    03             C      	db	3		;;Sektorlaengencode
  D2A3    07             C      	db	7		;;Puffermaske 8*128
                         C       endif
  D2A4    01             C      	db	1		;;Zahl der Stepimpulse
  D2A5    00             C      	db	0		;;keine Weiter-Numm. auf Rueckseite
  D2A6    50             C      	db	diskdi mod 100	;;benutztye Zahl phys. Spuren
  D2A7    01             C      	db	disknb-@din	;;phys. LW-Nr.
  D2A8    50             C      	db	diskdi mod 100	;;maximale Zahl phys. Spuren
                         C       if	(diskdi mod 1000)/100 eq 5	;;5"
                         C        if	(diskdi mod 100) gt 40
                         C         if ((diskdi mod 10000)/1000) and 00000001b
  D2A9    28             C      	db	4*10		;;Schrittzeit fuer 80 Tr. DS LW
                         C         endif
                         C        endif
                         C       endif
                         C      
  0000                   C      @dpbhl	aset	0		;;vorbereiten Laufwerkstyp-Flags
                         C      
                         C       if	(diskdi ge 10000)
  0008                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtdd)	;;double density
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 5
  0018                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt5z)	;;5"
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-17


                         C       endif
                         C       if (diskdi mod 100) eq 80
  0038                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbt80)	;;80-Spur-Laufwerk
                         C       endif
                         C       if	((diskdi mod 10000)/1000) and 00000001b	
  0039                   C      @dpbhl	aset	@dpbhl xor (1 shl dpbtds)	;;double sided
                         C       endif
                         C       if ((diskdi mod 10000)/1000) and 00000010b
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8"
                         C       endif
  D2AA    39             C      	db	@dpbhl	;;vom Laufwerkstyp abhaengige Flags
                         C      
                         C       if	(diskdi mod 1000)/100 eq 5 ;;5"
                         C        if dbufsz le 7 
                         C        else
                         C      ;; log. Sektortranslate-Tabelle fuer andere Formate
  D2AB    01 02 03 04    C      	db	1,2,3,4,5,6,7,8,9,10,11,12,13,14
  D2AF    05 06 07 08    C      
  D2B3    09 0A 0B 0C    C      
  D2B7    0D 0E          C      
  D2B9    0F 10 11 12    C      	db	15,16,17,18,19,20,21,22,23,24,25,26
  D2BD    13 14 15 16    C      
  D2C1    17 18 19 1A    C      
                         C        endif
                         C       endif
                         C       if	(diskdi mod 1000)/100 eq 8	;;8"
                         C       endif	;;8"
  0000                          @din	aset	@din-1
                                 ENDIF
                                 IF @din ne 0
                                 ENDIF
                                 IF @din ne 0
                                 ENDIF
                                
                                
                                ;=======================
                                ; CP/M-Erweiterungen
                                ;=======================
  D2C5                          cpmx00:	IF	monitor
  D2C5    C3 E7AB               	jp	moncal		;Monitor-Aufruf
                                	ENDIF
  D2C8    C3 E34B               cpmx03:	jp	tim5on		;5ms Takt an
  D2CB    C3 E356               cpmx06:	jp	tim5of		;5ms Takt aus
  D2CE    C3 E34B               cpmx09:	jp	tim1on		;1s Takt an
  D2D1    C3 E356               cpmx0c:	jp	tim1of		;1s Takt aus
                                	IF	mprot
                                	ELSE
  D2D4    C9                    	ret
  D2D5    00                    	nop
  D2D6    00                    	nop
  D2D7    C9                    	ret
  D2D8    00                    	nop
  D2D9    00                    	nop
  D2DA    C9                    	ret
  D2DB    00                    	nop
  D2DC    00                    	nop
                                	ENDIF
                                 IF stpvar or monitor
  D2DD    C3 E7AF               cpmx18:	jp	delsps		;verzoegern Sondertasten
  D2E0    C3 E7BC               cpmx1b:	jp	delspr		;erlauben Sondertasten
                                 ENDIF
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-18


                                 IF umlaut
                                 ELSE
  D2E3    C9                    cpmx1e:	ret
  D2E4    00                    	nop
  D2E5    00                    	nop
                                 ENDIF
  D2E6    C3 DD04               cpmx21:	jp	diskio		;phys. Disktransfer
                                				;Schnittstelle siehe BIOxDSKT.MAC
                                
                                	page	66
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-19


                                
                                ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                                ;	Beginn BIOS-Treiber
                                ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                                
                                ; Dummy-Treiber
  D2E9                          dumst:
  D2E9    AF                    	xor	a
  D2EA    3D                    	dec	a		;Status immer FF (bereit)
                                 IF iobvar
                                 ENDIF
  D2EB    C9                    	ret			;Status immer FF (bereit)
                                
                                 IF iobvar
  D2EC    3E 1A                 dumi:	ld	a,1ah		;Eingabe-Zeichen immer EOF
  D2EE    C9                    	ret
  D2EF    79                    dumo:	ld	a,c
  D2F0    11 D2FC               	ld	de,dumoh
  D2F3    CD E8B3               	call	mrecoa		;Zeichen hex aufbereiten
  D2F6    0E 28                 	ld	c,'('
  D2F8    CD D51E               	call	crto
  D2FB    01 0000               	ld	bc,0
  D2FC                          dumoh	equ	$-2
  D2FE    C5                    	push	bc
  D2FF    CD D51E               	call	crto
  D302    C1                    	pop	bc
  D303    48                    	ld	c,b
  D304    CD D51E               	call	crto
  D307    0E 29                 	ld	c,')'
  D309    C3 D51E               	jp	crto
                                 ENDIF
                                
                         C      	include	BIOPKBD		;Tastatur
                         C      ;****************************************************
                         C      ;	Tastatur-Eingabe, Version 15.04.88
                         C      ; Aenderungen:
                         C      ; - freie Belegbarkeit Kursor- und rechter Ziffernblock
                         C      ;****************************************************
                         C      
                         C       if1
                         C       endif	;if1
                         C      
                         C      ; Tastatur-Status
                         C      ;================
  D30C                   C      kbdst:
                         C      ; vor Pufferabfrage anstehende Zeichen lesen (falls 5ms Takt aus)
  D30C    F3             C      	di			;parallele Abfrage ueber 5ms verhindern
  D30D    CD D314        C      	call	kbdsti		;interner Aufruf
  D310    FB             C      	ei
                         C       IF stpvar or monitor
  D311    C3 E7C8        C      	jp	chksp		;Test auf Spezialfunktionen
                         C       ENDIF
                         C      
  D314                   C      kbdsti:				;kbdst-Aufruf intern
  D314    CD D3CB        C      kbdstz:	call	kbdst1		;Taste neu gedrueckt ? 
  D317    28 05          C      	jr	z,kbdsnt	;nein
  D319    CD D326        C      	call	kbdrdt		;Taste in Puffer ablegen
                         C       IF stpvar
                         C       ENDIF
  D31C    18 F6          C      	jr	kbdstz		;auf neuen Tastendruck testen
  D31E                   C      kbdsnt:
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-20


                         C      
  D31E    3A FFFF        C      	ld	a,(0ffffh)	;erstes Pufferzeichen
  D31F                   C      crtm32	equ	$-2		;wird vom Kaltstart modifiziert
  D321    B7             C      	or	a		;Puffer leer?
  D322    C8             C      	ret	z		;ja
  D323    3E FF          C      	ld	a,0ffh
  D325    C9             C      	ret
                         C      
                         C      ;------------------------------------------------------------
                         C      
                         C      
                         C      ; Taste umkodieren und im Puffer ablegen
                         C      ;=======================================
                         C      ; Achtung!! Dieses UP wird aus Interruptroutine aufgerufen
  D326    CD D3E9        C      kbdrdt:	call	kbdrch		;Zeichen lesen und auf virtuellen Tastaturcode
                         C      
                         C       IF stpvar
  D329    21 D23D        C      	ld	hl,synflg
  D32C    CB 7E          C      	bit	phyact,(hl)	;Taste physisch in Puffer?
  D32E    C2 D38D        C      	jp	nz,kbdput	;ja, direkt ablegen
                         C       ENDIF
                         C       IF costu
  D331    21 F75D        C      	ld	hl,costrt+1
  D334    CD D40A        C      	call	costr		;Nutzerstring?
  D337    20 08          C      	jr	nz,kbdco	;ja
                         C       ENDIF
  D339    2A D23B        C      	ld	hl,(kbdsst)	;Adresse der Standard-Stringtabelle
  D33C    CD D40A        C      	call	costr		;Standardstring?
  D33F    28 07          C      	jr	z,kbdnco	;nein
  D341    1D             C      kbdco:	dec	e		;String der Laenge 0?
  D342    C8             C      	ret	z		;ja, zu ignorierende Taste
  D343    1D             C      	dec	e		;String exakt ein Zeichen lang?
  D344    C2 D3A3        C      	jp	nz,kbdco1	;nein, kann keine Sondertaste sein
  D347    7E             C      	ld	a,(hl)		;holen erstes Stringzeichen
  D348    21 D23D        C      kbdnco:	ld	hl,synflg
                         C      
                         C      ; Auswertung Sondertasten, die nicht im Puffer abgelegt werden
                         C      ;-------------------------------------------------------------
                         C      
  D34B    FE DE          C      	cp	stpc		;STOP ?
  D34D    20 03          C      	jr	nz,kbdnst
  D34F    CB E6          C      	set	stoprq,(hl)	;Stop-Request vermerken
  D351    C9             C      	ret
  D352                   C      kbdnst:
                         C       IF stpvar
                         C       IF chdvar
  D352    FE D9          C      	cp	SyLc		;Drucker Synchronisieren?
  D354    20 03          C      	jr	nz,kbdnsy	;nein
  D356    CB DE          C      	set	synlrq,(hl)	;sonst vermerken
  D358    C9             C      	ret
  D359                   C      kbdnsy:
  D359    FE DA          C      	cp	HrLc		;Hardcopy ein/aus ?
  D35B    20 0C          C      	jr	nz,kbdnhc
  D35D    21 D20C        C      	ld	hl,conol
  D360    7E             C      	ld	a,(hl)
  D361    EE 0E          C      	xor	0cdh xor 0c3h	;CALL aus JP u.umgekehrt
  D363    77             C      	ld	(hl),a
  D364    3E 80          C      	ld	a,1 shl lmphcp	;Hardcopy-Lampe
  D366    C3 D445        C      	jp	kbdslm
  D369                   C      kbdnhc:
                         C       ENDIF
                         C       ENDIF	;stpvar
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-21


                         C      
                         C       IF monitor
  D369    FE DB          C      	cp	Monc		;Monitor-Taste ?
  D36B    20 0B          C      	jr	nz,kbdnmn
  D36D    CB 4E          C      	bit	monact,(hl)	;Monitor aktiv ?
  D36F    20 03          C      	jr	nz,kbdmo2	;ja
  D371    CB EE          C      	set	monrq,(hl)	;Vermerken Monitor-Request
  D373    C9             C      	ret
  D374    3E 0D          C      kbdmo2:	ld	a,0dh		;sonst CR substituieren
  D376    18 15          C      	jr	kbdput
  D378                   C      kbdnmn:
                         C       ENDIF
                         C      
  D378    B7             C      	or	a		;Taste zu ignorieren?
  D379    F8             C      	ret	m		;ja
                         C      
  D37A    CB 46          C      	bit	ctrlst,(hl)	;Sondertaste mit Control?
  D37C    CB 86          C      	res	ctrlst,(hl)	;  loeschen evtl. Control-St.
  D37E    28 0D          C      	jr	z,kbdcts	;nein
  D380    F5             C      	push	af
  D381    3E 11          C      	ld	a,'Q' and 1fh	;"^Q"
  D383    CD D38D        C      	call	kbdput		;im Puffer ablegen
  D386    F1             C      	pop	af
  D387    FE 08          C      	cp	08h		;"<-"-Taste?
  D389    20 02          C      	jr	nz,kbdcts	;nein
  D38B    3E 13          C      	ld	a,'S' and 1fh	;umwandeln in "^S"
  D38D                   C      kbdcts:
                         C      
                         C      ; Zeichen im Puffer ablegen
                         C      ;--------------------------
                         C      ; A und F bleiben erhalten!
                         C      
  D38D    21 FFFF        C      kbdput:	ld	hl,0ffffh	;Pufferadresse
  D38E                   C      crtm35	equ	$-2
  D390    01 0011        C      	ld	bc,kbdbl	;Pufferlaenge
  D393    F5             C      	push	af		;A, F retten
  D394    AF             C      	xor	a		;Pufferende-Kennzeichen
  D395    ED B1          C      	cpir
  D397    20 05          C      	jr	nz,kbdpt1	;Puffer voll
  D399    77             C      	ld	(hl),a		;neues Pufferende anzeigen
  D39A    F1             C      	pop	af		;A, F regenerieren
  D39B    2B             C      	dec	hl
  D39C    77             C      	ld	(hl),a		;Zeichen puffern
  D39D    C9             C      	ret
  D39E    CD D70F        C      kbdpt1:	call	crtclk		;Puffer voll anzeigen
  D3A1    F1             C      	pop	af		;A, F regenerieren
  D3A2    C9             C      	ret
                         C      
                         C      ; Ablegen String im Puffer
                         C      ;-------------------------
                         C      ; i E Stringlaenge -1
                         C      ; i HL Stringanfang
  D3A3    1C             C      kbdco1:	inc	e
  D3A4    E5             C      kbdco2:	push	hl
  D3A5    D5             C      	push	de
  D3A6    7E             C      	ld	a,(hl)
  D3A7    CD D38D        C      	call	kbdput		;in Puffer
  D3AA    D1             C      	pop	de
  D3AB    E1             C      	pop	hl
  D3AC    23             C      	inc	hl
  D3AD    1D             C      	dec	e
  D3AE    20 F4          C      	jr	nz,kbdco2	;wenn String noch nicht fertig
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-22


  D3B0    C9             C      	ret
                         C      
                         C      
                         C      ; Rest des Konsolpuffers streichen
                         C      ;---------------------------------
  D3B1    AF             C      kbdbcl:	xor	a
  D3B2    32 FFFF        C      	ld	(0ffffh),a
  D3B3                   C      crtm36	equ	$-2
  D3B5    C9             C      	ret
                         C      
                         C      ; Holen naechstes Tastaturzeichen mit Warten
                         C      ;===========================================
                         C      
  D3B6    CD D30C        C      kbdwin: call	kbdst		;Zeichen da?
  D3B9    28 FB          C      	jr	z,kbdwin	;nein
                         C      
  D3BB    11 FFFF        C      kbdi:	ld	de,0ffffh
  D3BC                   C      crtm33	equ	$-2
  D3BE    1A             C      	ld	a,(de)		;1.Zeichen lesen
  D3BF    B7             C      	or	a		;Puffer leer ?
  D3C0    28 F4          C      	jr	z,kbdwin	;ja: warten 
  D3C2    21 0000        C      	ld	hl,0ffffh+1	;Puffer umspeichern
  D3C3                   C      crtm34	equ	$-2
  D3C5    01 0011        C      	ld	bc,kbdbl	;einschl.(00h am Ende
  D3C8    ED B0          C      	ldir			;parall. Tastatur-Interrupt
                         C      				;stoert nicht, da alles umgesp.
  D3CA    C9             C      	ret
                         C      
                         C      ;-------------------------------------------------------------
                         C      
                         C      ; Test, ob Taste (neu) gedrueckt
                         C      ;===============================
                         C      ; o AF	=00 und Z=1	keine Taste
                         C      ;	=FF und Z=0	es ist eine Taste gedrueckt
  D3CB                   C      kbdst1:
  D3CB    3E 10          C      kbdstc:	ld	a,10h		;Reset extern/Status-Interrupt
  D3CD    D3 0E          C      	out	(kbdscs),a
  D3CF    DB 0E          C      	in	a,(kbdscs)
  D3D1    E6 01          C      	and	1		;Zeichen im Empf.puffer?
  D3D3    C8             C      	ret	z		;nein, A=00, ret z
  D3D4    DB 0C          C      	in	a,(kbdsci)	;Tastaturzeichen lesen
  D3D6    FE E0          C      	cp	0e0h		;Status?
  D3D8    38 09          C      	jr	c,kbdrts	;nein, Taste
                         C       IF zs2var
                         C       ENDIF
  D3DA    21 D23D        C      	ld	hl,synflg
  D3DD    E6 01          C      	and	1 shl ctrlst	;CTRL-Status
  D3DF    B6             C      	or	(hl)		;merken
  D3E0    77             C      	ld	(hl),a
                         C       IF zs2var
                         C       ELSE
  D3E1    18 E8          C      	jr	kbdstc		;nach Zeichenstatus folgt Zeichen
                         C       ENDIF
  D3E3    32 D3EA        C      kbdrts:	ld	(kbdlch),a	;Taste fuer Auswertung merken
  D3E6    AF             C      	xor	a
  D3E7    3D             C      	dec	a		;A=ff, ret nz
  D3E8    C9             C      	ret
                         C      
                         C      
                         C      ;-------------------------------------------------------------
                         C      
                         C      ;Zeichen von Tastatur lesen , CAPS-Lock realisieren
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-23


                         C      ;==================================================
  D3E9                   C      kbdrch:		;CAPS-Lock funktioniert, Zeichen direkt verwenden
                         C      
                         C      ; Zeichen von Tastatur umkodieren
                         C      ;================================
  D3E9                   C      kbdrcu:
  D3E9    3E 5E          C      	ld	a,'^'		;letztes empf. Zeichen
  D3EA                   C      kbdlch	equ	$-1
                         C      
  D3EB    21 D44B        C      cocpm1:	ld	hl,kbdcpt
  D3EE    01 002A        C      	ld	bc,kbdcpl
  D3F1    ED B1          C      	cpir			;Umcodieren ?
  D3F3    20 05          C      	jr	nz,kbdrc1	;nein
  D3F5    01 0029        C      	ld	bc,kbdcpl-1	;-1 wegen CPIR
  D3F8    09             C      	add	hl,bc
  D3F9    7E             C      	ld	a,(hl)		;umcodiertes Zeichen
  D3FA                   C      kbdrc1:	
  D3FA                   C      cocpm2:
  D3FA    FE 20          C      	cp	20h		;Sondertaste?
  D3FC    D8             C      	ret	c		;<20h, ja
  D3FD    B7             C      	or	a		
  D3FE    F8             C      	ret	m		;>=80h, ja
  D3FF    21 D23D        C      	ld	hl,synflg	;norm. Taste mit Control?
  D402    CB 46          C      	bit	ctrlst,(hl)
  D404    C8             C      	ret	z
  D405    CB 86          C      	res	ctrlst,(hl)
  D407    E6 1F          C      	and	1fh		;CTRL realisieren
  D409    C9             C      	ret
                         C      
                         C      ; Suchen, ob Taste (A) umzukodieren entspr. Stringtab ab (HL)
                         C      ; ret z:	nicht gefunden, A unveraendert
                         C      ; ret nz:	gefunden, A unveraendert
                         C      ;		E Stringlaenge+1
                         C      ;		HL Stringanfang (nur gueltig falls E>1!)
  D40A    16 00          C      costr:	ld	d,0
  D40C    4E             C      costr0:	ld	c,(hl)		;Tastencode o. Tabende
  D40D    0C             C      	inc	c		;Tabende?
  D40E    C8             C      	ret	z		;ja, nicht gefunden
  D40F    23             C      	inc	hl
  D410    5E             C      	ld	e,(hl)		;Stringlaenge
  D411    1C             C      	inc	e		;+1
  D412    0D             C      	dec	c		;Tastencode wiederherstellen
  D413    B9             C      	cp	c		;Zeichen umkodieren?
  D414    28 03          C      	jr	z,costr1	;ja
  D416    19             C      	add	hl,de		;String uebergehen
  D417    18 F3          C      	jr	costr0
  D419                   C      costr1:
  D419    23             C      	inc	hl
  D41A    14             C      	inc	d		;ret nz
  D41B    C9             C      	ret
                         C      
                         C       IF costu
                         C      ; Eintrag Taste (A) in Stringtab ab (HL)+1
                         C      ; ret po:	Tabelle voll
                         C      ; ret pe:	ok, costda-Aufruf vorbereitet
  D41C    5F             C      costdf:	ld	e,a
  D41D    4E             C      	ld	c,(hl)		;Laenge Stringtab -1
  D41E    23             C      	inc	hl
  D41F    AF             C      	xor	a
  D420    47             C      	ld	b,a
  D421    3D             C      	dec	a		;Endezeichen fuer Tab
  D422    ED B1          C      	cpir			;suchen Tab-Ende, BC:=Restlng
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-24


  D424    E0             C      	ret	po		;bc=0, Tab. voll
  D425    2B             C      	dec	hl		;auf Tastencode
  D426    73             C      	ld	(hl),e		;ablegen
  D427    23             C      	inc	hl		;auf Stringlaenge
  D428    70             C      	ld	(hl),b		;Stringlaenge :=0
  D429    22 D433        C      	ld	(costdl),hl	;^Stringlaenge merken
  D42C    18 0C          C      	jr	costdn
                         C      
                         C      ; Verlaengern aktuell definierten String um Zeichen (A)
                         C      ; ret z:	kein Platz
                         C      ; ret nz:	ok
  D42E    0E 00          C      costda:	ld	c,0		;c:=Restlaenge+1
  D42F                   C      costdr	equ	$-1
  D430    0D             C      	dec	c		;noch Platz?
  D431    C8             C      	ret	z		;nein
  D432    21 0000        C      	ld	hl,0		;^Stringlaenge
  D433                   C      costdl	equ	$-2
  D435    34             C      	inc	(hl)		;Stringlaenge +1
  D436    21 0000        C      	ld	hl,0		;^Tabende
  D437                   C      costdp	equ	$-2
  D439    77             C      	ld	(hl),a		;Stringzeichen dorthin
  D43A    23             C      costdn:	inc	hl
  D43B    36 FF          C      	ld	(hl),0ffh	;neues Tabende
  D43D    22 D437        C      	ld	(costdp),hl	;merken
  D440    79             C      	ld	a,c		;max. (restliche) Stringlaenge
  D441    32 D42F        C      	ld	(costdr),a	;merken
  D444    C9             C      	ret			;ret nz / ret pe 
                         C       ENDIF
                         C      
                         C      ; Tastatur-Lampe umschalten
                         C      ;==========================
  D445    21 0040        C      kbdslm:	ld	hl,lampbf
  D448    AE             C      	xor	(hl)		;Lampe ein/aus
  D449    77             C      	ld	(hl),a
                         C      
                         C      ; Tastatur-Lampen ein/aus
                         C      ;========================
                         C      ; Achtung! Diese Routine wird auch aus Interrupt-Routine
                         C      ; aufgerufen (EI/DI darf hier nicht auftreten!!)
  D44A                   C      lampen:
                         C       IF cpastz
                         C       ELSE
  D44A    C9             C      	ret			;Lampen nicht simulieren
                         C       ENDIF
                         C      
                         C      
                         C      ; Die folgende phys. Code-Tabelle kann je nach Tastaturtyp
                         C      ; beim Kaltstart modifiziert werden (bisher bei PC1715 noch
                         C      ; nicht notwendig), dies ist bei Aenderung der Tastenzuord-
                         C      ; nung zu beachten!
                         C      ; Einige Tastencodes koennen mehrmals auftauchen (wenn sie
                         C      ; bei den Tastaturen disjunkt sind), um auch bei falsch er-
                         C      ; kanntem Tastaturtyp eine notduerftige Arbeit zu gestatten.
                         C      
  D44B                   C      kbdcpt:
                         C      ;	physik.Tastencodes (Standardbelegung)
                         C      ;	~~~~~~~~~~~~~~~~~~
                         C      
                         C      ; Kursortastenfeld:
                         C      ;------------------
  D44B    87             C      	db	087H
                         C      ;		|<-
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-25


  D44C    8B             C      	db	08BH
                         C      ;		^
  D44D    89             C      	DB	089H
                         C      ;		->|
  D44E    88             C      	db	088H
                         C      ;		<-
  D44F    8C             C      	DB	08CH
                         C      ;		'\  
  D450    86             C      	db	086H
                         C      ;		->
  D451    9D             C      	db	09DH
                         C      ;		<-'
  D452    8A             C      	db	08AH
                         C      ;		v
                         C      ; Sondertasten:
                         C      ;--------------
  D453    9E             C      	db	9eh
                         C      ;		ET
  D454    8D             C      	db	8dh
                         C      ;		-> im Tastenfeld rechts oben
  D455    9B             C      	db	9bh
                         C      ;		ESC
  D456    CE             C      	db	0ceh
                         C      ;		CE
  D457    82             C      	db	082H
                         C      ;		INS
                         C      ; Funktionstasten:
                         C      ;-----------------
  D458    D0 D1 D2 D3    C      	db	0d0h,0d1h,0d2h,0d3h,0d4h,0cfh,0a0h,0a1h
  D45C    D4 CF A0 A1    C      
                         C      ;		S    F1   F2   F3   F4   F5   F6   F7
  D460    A2 A3 83 C1    C      	db	0a2h,0a3h,083h,0c1h,0c0h,0c2h,0cdh,08eh
  D464    C0 C2 CD 8E    C      
                         C      ;		F8   F9   F10  F11  F12  F13  F14  F15
                         C      ; Ziffernfeld
                         C      ;------------
  D468    B0 B1 B2 B3    C      	db	0b0h,0b1h,0b2h,0b3h,0b4h,0b5h,0b6h,0b7h,0b8h,0b9h
  D46C    B4 B5 B6 B7    C      
  D470    B8 B9          C      
                         C      ;		0    1    2    3    4    5    6    7    8    9
  D472    BB AC          C      	db	0BBH,0ach
                         C      ;		00  ,Komma
  D474    BD             C      	db	0bdh
                         C      ;		Minus unter CE
                         C      
                         C      
                         C      
  002A                   C      kbdcpl	EQU	$-kbdcpt	;Laenge Tabelle phys. Codes
                         C      
                         C      ;	zugehoerige log.Tastencodes
                         C      ;	~~~~~~~~~~~~~~~~~~~~~~~~~~~
                         C      ;	(direkt hinter phys. Codes!, in gleicher Ordnung)
                         C      
                         C      ; Die Vergabe der Codes ist entsprechend der CP/A-Philosophie
                         C      ; tastaturunabhaengig, daher kommen auch Codes vor, die keine
                         C      ; Entsprechung beim PC1715 haben, aber am BC A51xx!
                         C      
                         C      ; Kursortasten
                         C      ;-------------
  00C1                   C      kcurwl	equ	0c1h
  00C2                   C      kcurup	equ	0c2h
  00C3                   C      kcurwr	equ	0c3h
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-26


  00C4                   C      kcurlf	equ	0c4h
  00C5                   C      kcurpu	equ	0c5h
  00C6                   C      kcurri	equ	0c6h
  00C7                   C      kcurpd	equ	0c7h
  00C8                   C      kcurdw	equ	0c8h
                         C      
                         C      ; Sondertasten
                         C      ;-------------
  00CC                   C      spcce	equ	0cch		;CE
  00CD                   C      spcins	equ	0cdh		;INS
                         C      
                         C      ; Bei Einfuehrung neuer Sonderzeichen zwischen Sel0..Sel3 muss
                         C      ; Test auf Sel0..3 zuletzt erfolgen, da diese als Gruppe
                         C      ; getestet werden, aber nicht dicht liegen!
  00D1                   C      Sel0	equ	0d1h;!!hintere!!	;LED 0 bei SEL 0
  00D2                   C      Sel1	equ	0d2h;!!Tetrade!!	;LED 1 bei SEL 1
  00D4                   C      Sel2	equ	0d4h;!!=2**LED!!	;LED 2 bei SEL 2
  00D8                   C      Sel3	equ	0d8h;!!	      !!	;LED 3 bei SEL 3
                         C      
  00D9                   C      SyLc	equ	0d9h			; Synch. List
  00DA                   C      HrLc	equ	0dah			; Hardcopy
  00DB                   C      Monc	equ	0dbh			; BIOS-Monitor
  00DC                   C      z00c	equ	0dch			; "00" im Ziffernblock
  00DD                   C      z000	equ	0ddh			; "000" im Ziffernblock
  00DE                   C      stpc	equ	0deh			; allg. STOP
  00DF                   C      ctlc	equ	0dfh			; Control (-Ersatz)
                         C      
                         C      ; Funktionstasten
                         C      ;----------------
  00E0                   C      pf0c	equ	0e0h			;PF0 bzw. S0
  00E1                   C      pf1c	equ	0e1h			;PF1...
  00E2                   C      pf2c	equ	0e2h
  00E3                   C      pf3c	equ	0e3h
  00E4                   C      pf4c	equ	0e4h
  00E5                   C      pf5c	equ	0e5h
  00E6                   C      pf6c	equ	0e6h
  00E7                   C      pf7c	equ	0e7h
  00E8                   C      pf8c	equ	0e8h
  00E9                   C      pf9c	equ	0e9h
                         C      ;***die folgenden 3 Funktionstasten ex nicht bei allen
                         C      ; Tastaturen, koennten aber durch andere Tasten ersetzt werden!
  00EA                   C      pfac	equ	0eah
  00EB                   C      pfbc	equ	0ebh
  00EC                   C      pfcc	equ	0ech
                         C      ;***die folgenden 3 Funktionstasten ex. nicht bei A51xx:
  00ED                   C      pfdc	equ	0edh
  00EE                   C      pfec	equ	0eeh
  00EF                   C      pffc	equ	0efh
                         C      
                         C      ;rechter Ziffernblock
                         C      ;--------------------
  00F0                   C      zbl0	equ	0f0h
  00F1                   C      zbl1	equ	0f1h
  00F2                   C      zbl2	equ	0f2h
  00F3                   C      zbl3	equ	0f3h
  00F4                   C      zbl4	equ	0f4h
  00F5                   C      zbl5	equ	0f5h
  00F6                   C      zbl6	equ	0f6h
  00F7                   C      zbl7	equ	0f7h
  00F8                   C      zbl8	equ	0f8h
  00F9                   C      zbl9	equ	0f9h
  00DC                   C      zbl00	equ	z00c
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-27


  00DD                   C      zbl000	equ	z000
  00FA                   C      zblkom	equ	0fah		;Komma im Ziffernblock
  00FB                   C      zblmin	equ	0fbh		;Minus im Ziffernblock
                         C      	;Enter im Ziffernblock siehe "pf0c"
                         C      
                         C      ; zu ignorierende Tasten
                         C      ;-----------------------
  00FF                   C      cign	equ	0ffh			;Taste ignorieren
                         C      
  0000                   C      kbdcpb	equ	lmpsl0	;0..3, Selectortaste fuer CAPS-Lock
                         C      
                         C      
                         C      ; Beginn der Tabelle logischer Tastencodes
                         C      ;=========================================
                         C      
                         C      ; Kursortastenfeld:
                         C      ;------------------
  D475    C1             C      	db	kcurwl
                         C      ;		|<-
  D476    C2             C      	db	kcurup
                         C      ;		^
  D477    C3             C      	DB	kcurwr
                         C      ;		->|
  D478    C4             C      	db	kcurlf
                         C      ;		<-
  D479    C5             C      	DB	kcurpu
                         C      ;		'\  
  D47A    C6             C      	db	kcurri
                         C      ;		->
  D47B    C7             C      	db	kcurpd
                         C      ;		<-'
  D47C    C8             C      	db	kcurdw
                         C      ;		v
                         C      ; Sondertasten:
                         C      ;--------------
  D47D    0D             C      	db	0dh
                         C      ;		ET
  D47E    09             C      	db	09h
                         C      ;		-> im Tastenfeld rechts oben
  D47F    1B             C      	db	1bh
                         C      ;		ESC
  D480    CC             C      	db	spcce
                         C      ;		CE
  D481    CD             C      	db	spcins
                         C      ;		INS
                         C      ; Funktionstasten:
                         C      ;-----------------
                         C      ; Es folgen die Funktionstasten. Diese werden unabhaengig von
                         C      ; der Tastatur zunaechst auf einen einheitlichen 'logischen'
                         C      ; Code pf0c,...,pffc abgebildet und dann i.a. ueber Standard-
                         C      ; oder Nutzer-Stringumkodierung weiter umgesetzt.
  D482    E0 E1 E2 E3    C      	db	pf0c,pf1c,pf2c,pf3c,pf4c,pf5c,pf6c,pf7c
  D486    E4 E5 E6 E7    C      
                         C      ;		S    F1   F2   F3   F4   F5   F6   F7
  D48A    E8 E9 EA EB    C      	db	pf8c,pf9c,pfac,pfbc,pfcc,pfdc,pfec,pffc
  D48E    EC ED EE EF    C      
                         C      ;		F8   F9   F10  F11  F12  F13  F14  F15
                         C      ; Ziffernfeld
                         C      ;------------
  D492    F0 F1 F2 F3    C      	db	zbl0,zbl1,zbl2,zbl3,zbl4,zbl5,zbl6,zbl7,zbl8,zbl9
  D496    F4 F5 F6 F7    C      
  D49A    F8 F9          C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-28


                         C      ;		0    1    2    3    4    5    6    7    8    9
  D49C    DC FA FB       C      	db	zbl00,zblkom,zblmin
                         C      ;		00   ,Komma ,Minus
                         C      
                         C      
                         C      ; String-Umkodierungstabellen
                         C      ;============================
                         C      
                         C      ; Standardstrings:
                         C      
  D49F                   C      kbdsts:	costs
  D49F    C1 01 01       C+     	db	kcurwl,1,'A' and 1fh
  D4A2    C2 01 05       C+     	db	kcurup,1,'E' and 1fh
  D4A5    C3 01 06       C+     	db	kcurwr,1,'F' and 1fh
  D4A8    C4 01 08       C+     	db	kcurlf,1,'H' and 1fh
  D4AB    C5 01 12       C+     	db	kcurpu,1,'R' and 1fh
  D4AE    C6 01 04       C+     	db	kcurri,1,'D' and 1fh
  D4B1    C7 01 03       C+     	db	kcurpd,1,'C' and 1fh
  D4B4    C8 01 18       C+     	db	kcurdw,1,'X' and 1fh
  D4B7    E0 01 02       C+     	db	pf0c,1,'B' and 1fh
  D4BA    E1 01 07       C+     	db	pf1c,1,'G' and 1fh
  D4BD    E2 01 19       C+     	db	pf2c,1,'Y' and 1fh
  D4C0    E3 01 14       C+     	db	pf3c,1,'T' and 1fh
  D4C3    E4 01 16       C+     	db	pf4c,1,'V' and 1fh
  D4C6    E5 01 0C       C+     	db	pf5c,1,'L' and 1fh
  D4C9    E6 02 0F 44    C+     	db	pf6c,2,'O' and 1fh,'D'
  D4CD    E7 02 0F 47    C+     	db	pf7c,2,'O' and 1fh,'G'
  D4D1    E8 01 17       C+     	db	pf8c,1,'W' and 1fh
  D4D4    E9 01 1A       C+     	db	pf9c,1,'Z' and 1fh
  D4D7    EA 04 0B 53    C+     	db	pfac,4,'K' and 1fh,'S','Q' and 1fh,'P'
  D4DB    11 50          C+     
  D4DD    EB 02 0B 42    C+     	db	pfbc,2,'K' and 1fh,'B'
  D4E1    EC 02 0B 4B    C+     	db	pfcc,2,'K' and 1fh,'K'
  D4E5    ED 02 0B 56    C+     	db	pfdc,2,'K' and 1fh,'V'
  D4E9    EE 01 DB       C+     	db	pfec,1,Monc
  D4EC    EF 01 DE       C+     	db	pffc,1,Stpc
  D4EF    F1 01 31       C+     	db	zbl1,1,'1'
  D4F2    F2 01 32       C+     	db	zbl2,1,'2'
  D4F5    F3 01 33       C+     	db	zbl3,1,'3'
  D4F8    F4 01 34       C+     	db	zbl4,1,'4'
  D4FB    F5 01 35       C+     	db	zbl5,1,'5'
  D4FE    F6 01 36       C+     	db	zbl6,1,'6'
  D501    F7 01 37       C+     	db	zbl7,1,'7'
  D504    F8 01 38       C+     	db	zbl8,1,'8'
  D507    F9 01 39       C+     	db	zbl9,1,'9'
  D50A    F0 01 30       C+     	db	zbl0,1,'0'
  D50D    DC 02 30 30    C+     	db	zbl00,2,'00'
  D511    FA 01 2E       C+     	db	zblkom,1,'.'
  D514    FB 01 DA       C+     	db	zblmin,1,HrLc
  D517    CC 01 18       C+     	db	spcce,1,'X' and 1fh
  D51A    CD 01 D9       C+     	db	spcins,1,SyLc
  D51D    FF             C      	db	0ffh		;Tab.ende
                         C      
                         C       IF costu
                         C      ; Nutzerstrings liegen direkt vor Interruptvektoren
                         C      ;==================================================
                         C       ENDIF
                                
                         C      	include	BIOPCRT		;Bildschirm
                         C      ;************************************************************
                         C      ; Bildschirm-Ausgabe, Version 22.04.88
                         C      ; - Fehlerkorrektur Steuerzeichen 18h (es wurden nur 79 Zeichen gel.)
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-29


                         C      ; - bei Tastenumdefinition auch chr(253) als Begrenzer (dbase)
                         C      ; - BAB2 als Standardvariante
                         C      ; - 17h (insline) und 19h (delline) eingefuehrt fuer TURBO-PASCAL-Editor
                         C      ; - Realisierung der SCP1715-Steuerzeichen 1b 5e xx (Feldattribut)
                         C      ;   und 1b 5f xx (Spezialzeichen)
                         C      ;   Diese ESC-Folgen fueren beim Buerocomputer i.a. auf '^' (unzulaessig),
                         C      ;   ausser Feldattribute invers und hell (Reaktion wie Steuerz. 84..87)
                         C      ; - Kursor wird nur alle 50ms ueber Zeittakt gestellt, dadurch ca. 20%
                         C      ;   Zeiteinsparung bei aufeinanderfolgender Bildschirmausgabe
                         C      ;************************************************************
                         C      
                         C      
  0019                   C      bscom	equ	19h		;CRT Kommando
  0018                   C      bspar	equ	18h		;CRT Parameter
  0034                   C      bschsw	equ	34h		;Bildschpuffer/Zeichensatz
                         C      
                         C      ; Durch Zeichentakt vorgegebene Werte:
                         C      ; (es wurde eine Korrektur der hrtc-Werte um 2 vorgenommen,
                         C      ;  um die Neueinstellung der Vertikal-Synchronisation
                         C      ;  bei schlecht eingestelltem Fangbereich trotz der
                         C      ;  17. bzw. 25. Text-Zeile zu vermeiden; bei einer Korrektur
                         C      ;  um 4 rueckt das Bild zuweit nach rechts!)
                         C      
                         C      ; 					BAB1	BAB2
                         C      ; Quarz qubpt Bildpunkttakt		10,7	13,824	Mhz
                         C      ; Zeichentakt cclk =8/qubpt		750	580	ns
                         C      ; horfq =1/(cclk*(bssp+hrtc)		15.50	16.26	kHz
                         C      ; vertfq=horfq/(lpcr*(bszl+vrtc))	57.42	52.1	 Hz
                         C      
                         C      ; Originalwerte ohne 17./25. Zeile	15.15	15.96
                         C      ;					56.1	51.2
                         C      
  0002                   C      vrtc	equ	2		;Vertical Retrace Count
  0002                   C      vrtc1	equ	2		;dito BAB1
                         C       IF (bszl2 gt 24) or cpastz
  000D                   C      hrtc	equ	(28-2)/2	;Horizontal Retrace Count
                         C       ENDIF
                         C       IF (bszl1 gt 16) or cpastz
  000B                   C      hrtc1	equ	(24-2)/2	;dito BAB1
                         C       ENDIF
  000C                   C      lpcr	equ	12		;Lines per Character Row
  000F                   C      lpcr1	equ	15		;dito BAB1
                         C      
  D238                   C      dcupos	equ	crtcps		;BIOS+38h Kursorposition
                         C      
                         C       if1
                         C       endif	;if1
                         C      
  D2E9                   C      crtst	equ	dumst		;CRT:-Status immer ready
                         C      
  D51E                   C      crto:
  D51E    CD E7AF        C      	call	delsps		;waehrend Bildaufbau
  D521    C5             C      	push	bc		;merken zeichen in c
  D522    21 00FF        C      	ld	hl,0*256+255	;Kursor auf Zeile 0, Spalte 255
  D525    CD D73B        C      	call	crtscu		;d.h. loeschen
  D528    2A D238        C      	ld	hl,(dcupos)	;Kursorposition	
  D52B    CD D56C        C      	call	crtoti		;Zeichen ausgeben
                         C      ;				 HL danach auf neuer Kursorpositon
                         C      
                         C      ; Setzen Kursor auf (HL)
                         C      
  D52E    22 D238        C      	ld	(dcupos),hl	;cursorposition
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-30


  D531    3E 80          C      	ld	a,80h
  D532                   C      dcurs	equ	$-1
  D533    B7             C      	or	a		;Cursor an?
  D534    28 0D          C      	jr	z,crtonc	;nein
  D536    3A D23A        C      	ld	a,(crtccn)	;auf 0ffh ohne 25ms Zeittakt, sonst 2..0
  D539    3C             C      	inc	a		;laeuft der Zeittakt?
  D53A    20 05          C      	jr	nz,crtsc1	;ja
  D53C    CD D729        C      	call	crtsci		;sonst Cursor aus HL berechnen und setzen
  D53F    18 05          C      	jr	crtsc2
  D541    3E 02          C      crtsc1:	ld	a,2		;erst nach 2*25ms Cursor berechnen und setzen
  D543    32 D23A        C      crtonc:	ld	(crtccn),a
  D546                   C      crtsc2:
  D546    C1             C      	pop	bc		;wiederherstellen c-reg
  D547    CD E7BC        C      	call	delspr		;wiederzulassen Parall.arbeit
                         C      
                         C       if (stpvar ne 0)  and (chdvar ne 0)
                         C      ; Hardcopy realisieren
                         C      
  D54A    3A 0040        C      	ld	a,(lampbf)
  D54D    CB 7F          C      	bit	lmphcp,a	;Hardcopy?
  D54F    C8             C      	ret	z		;nein
  D550    79             C      	ld	a,c
  D551    E6 7F          C      	and	7fh
  D553    FE 20          C      	cp	20h		;Steuerzeichen?
  D555    38 03          C      	jr	c,crtoe1	;ja
  D557    FE 7F          C      	cp	7fh
  D559    D8             C      	ret	c
  D55A    C5             C      crtoe1:	push	bc
  D55B    21 D568        C      	ld	hl,crtlc	;zugelassene Steuerzeichen
  D55E    01 0004        C      	ld	bc,crtlcl
  D561    ED B1          C      	cpir			;erlaubt?
  D563    C1             C      	pop	bc
  D564    C8             C      	ret	z		;ja
  D565    0E 5E          C      	ld	c,'^'		;sonst Spezialzeichen
  D567    C9             C      	ret
                         C      
                         C      ; bei Hardcopy Bildschirm -> Drucker zugelassene Steuerzeichen
                         C      
  D568    08 0A 0C 0D    C      crtlc:	db	08h,0ah,0ch,0dh
  0004                   C      crtlcl	equ	$-crtlc
                         C      
                         C       endif	;stpvar and chdvar
                         C      
                         C      
                         C      ;==================================
                         C      ; interner Aufruf Bildschirmtreiber
                         C      ; i HL	Zeiger in Bildschirmpuffer auf Kursorposition
                         C      ; o HL	neuer Zeiger auf Kursorposition
                         C      ;==================================
                         C      
  D56C                   C      crtoti:
  D56C    3E 00          C      	ld	a,0		;escape mode
  D56D                   C      desc	equ	$-1
  D56E    B7             C      	or	a
  D56F    20 65          C      	jr	nz,crto04	;ja
  D571    79             C      crto02:	ld	a,c
  D572    FE 87          C      	cp	87h		;07h ist bell!, daher 87h<>07h
  D574    28 3F          C      	jr	z,crto09
  D576    CB BF          C      	res	7,a		;sonst 1xxxxxxxB  = 0xxxxxxxB
  D578    FE 20          C      	cp	20h		;steuerzeichen?
  D57A    38 39          C      	jr	c,crto09	;ja
  D57C    FE 7F          C      	cp	7fh
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-31


  D57E    30 35          C      	jr	nc,crto09
  D580    77             C      crtobs:	ld	(hl),a		;Zeichen in Bildschirmpuffer
  D581    EB             C      	ex	de,hl
  D582    21 03C1        C      crtcur:	ld	hl,0-bsend1
  D583                   C      crtm01	equ	$-2
  D585    19             C      	add	hl,de		;bs voll?
  D586    EB             C      	ex	de,hl
  D587    23             C      	inc	hl	
  D588    D0             C      	ret	nc
  D589    11 FC00        C      	ld	de,bsend1-bssp1+1
  D58A                   C      crtm02	equ	$-2
  D58C    D5             C      crto03:	push	de
  D58D    21 F840        C      	ld	hl,bsanf1+bssp1	;aufschieben
  D58E                   C      crtm03	equ	$-2
  D590    11 F800        C      	ld	de,bsanf1
  D591                   C      crtm04	equ	$-2
  D593    01 0400        C      	ld	bc,bsend1-bsanf1-bssp1+1
  D594                   C      crtm05	equ	$-2
  D596    ED B0          C      	ldir
  D598    2B             C      	dec	hl
  D599    36 20          C      	ld	(hl),' '	;letzte zeile loeschen
  D59B    11 FC3E        C      	ld	de,bsend1-1
  D59C                   C      crtm06	equ	$-2
  D59E    01 003F        C      	ld	bc,bssp1-1
  D59F                   C      crtm07	equ	$-2
  D5A1    ED B8          C      	lddr
  D5A3    E1             C      	pop	hl
  D5A4    C9             C      	ret
                         C      ;------------------------------
                         C      ; 84/04,..,86/06,87
                         C      
  D5A5    3E 80          C      crto84:	ld	a,80h		;normal
  D5A7    18 D7          C      	jr	crtobs
  D5A9    3E 90          C      crto85:	ld	a,90h		;invers
  D5AB    18 D3          C      	jr	crtobs
  D5AD    3E 81          C      crto86:	ld	a,81h		;intensiv
  D5AF    18 CF          C      	jr	crtobs
  D5B1    3E 91          C      crto87:	ld	a,91h		;invers intensiv
  D5B3    18 CB          C      	jr	crtobs
                         C      
                         C      ;--------------------------------
                         C      
                         C      ; Behandlung Sonderzeichen
                         C      ;=========================
  D5B5    EB             C      crto09:	ex	de,hl		;test sonderzeichen
  D5B6    21 D777        C      	ld	hl,dszta
  D5B9    01 0016        C      	ld	bc,dsztal
  D5BC    ED B1          C      	cpir
  D5BE    28 05          C      	jr	z,crto11	;gefunden
  D5C0    0E 5E          C      	ld	c,'^'		;nicht-Sonderz. anzeigen
  D5C2    EB             C      	ex	de,hl
  D5C3    18 AC          C      	jr	crto02		;falls nicht gefunden
  D5C5    21 D7B8        C      crto11:	ld	hl,dswe-1
  D5C8    B7             C      	or	a
  D5C9    ED 42          C      	sbc	hl,bc
  D5CB    ED 42          C      	sbc	hl,bc
  D5CD    46             C      	ld	b,(hl)
  D5CE    2B             C      	dec	hl
  D5CF    4E             C      	ld	c,(hl)		;bc:=ansprungadresse
  D5D0    C5             C      	push	bc
  D5D1    6B             C      	ld	l,e
  D5D2    62             C      	ld	h,d		;bs adresse
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-32


  D5D3    3E 20          C      	ld	a,' '		;fuer BS-loeschen
  D5D5    C9             C      crtnop:	ret			;ansprung sonderzeichen
                         C      ;-----------------------------
                         C      
                         C      ; Behandlung Zeichen innerhalb Escape-Folgen
                         C      ;===========================================
  D5D6                   C      crto04:	if	adm3a
                         C      	endif
                         C      
                         C      	if	costu
  D5D6    06 00          C      	ld	b,0
  D5D7                   C      cotd2	equ	$-1		;Restzeichenzahl Stringdef.
  D5D8    10 39          C      	djnz	crttd0		;nicht in Stringdefinition
  D5DA    3D             C      	dec	a		;Escape-Rest := 1/0
  D5DB    32 D56D        C      	ld	(desc),a
  D5DE    79             C      	ld	a,c		;a:=Tastcode/Stringz.
  D5DF    28 20          C      	jr	z,cotd5		;im String
  D5E1    E5             C      	push	hl		;retten Kursoradresse
  D5E2    21 F75C        C      	ld	hl,costrt
  D5E5    FE FD          C      	cp	253		;Nutzerstringspeicher loeschen?
  D5E7    28 03          C      	jr	z,cotdcl	;ja
  D5E9    B7             C      	or	a		;Nutzerstringspeicher loeschen?
  D5EA    20 09          C      	jr	nz,cotd1	;nein
  D5EC    AF             C      cotdcl:	xor	a
  D5ED    32 D56D        C      	ld	(desc),a	;sonst Escape zuende
  D5F0    3D             C      	dec	a
  D5F1    23             C      	inc	hl
  D5F2    77             C      	ld	(hl),a		;sonst Tabelle leeren
  D5F3    E1             C      	pop	hl
  D5F4    C9             C      	ret
  D5F5    CD D41C        C      cotd1:	call	costdf		;Tastencode in Nutzerstr.sp.
  D5F8    E1             C      	pop	hl
  D5F9    E8             C      	ret	pe		;ok
  D5FA    AF             C      cotd4:	xor	a
  D5FB    32 D56D        C      	ld	(desc),a	;beenden Stringdef.
  D5FE    C3 D70F        C      	jp	crtclk		;und Fehler anzeigen
  D601    FE FD          C      cotd5:	cp	253		;Stringende?
  D603    C8             C      	ret	z		;ja
  D604    B7             C      	or	a		;Stringende?
  D605    C8             C      	ret	z		;ja
  D606    E5             C      	push	hl
  D607    CD D42E        C      	call	costda		;Zeichen eintragen
  D60A    E1             C      	pop	hl
  D60B    28 ED          C      	jr	z,cotd4		;kein Platz mehr
  D60D    3E 01          C      	ld	a,1		;sonst naechstes Zeichen abw.
  D60F    32 D56D        C      	ld	(desc),a
  D612    C9             C      	ret
                         C      
  D613    FE 02          C      crttd0:	cp	2		;Zeichen nach ESC?
  D615    20 0C          C      	jr	nz,crttd1	;nein
  D617    79             C      	ld	a,c
  D618    FE 1B          C      	cp	1bh		;Einleitung Stringdef.?
  D61A    3E 02          C      	ld	a,2
  D61C    20 05          C      	jr	nz,crttd1	;nein
  D61E    3D             C      	dec	a		;Flag: in Stringdef.
  D61F    32 D5D7        C      	ld	(cotd2),a	;String-Def.-Flag setzen
  D622    C9             C      	ret
  D623                   C      crttd1:
                         C      	endif
                         C      
  D623    3D             C      	dec	a
  D624    32 D56D        C      	ld	(desc),a	;naechstes escape flag setzen
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-33


                         C       IF escpc
  D627    79             C      	ld	a,c		;Zeichen mit offset nach A
                         C       ENDIF
  D628    CB B9          C      	res	7,c		;loeschen evtl. offset 80h
  D62A    28 1B          C      	jr	z,crto07	;letztes Zeichen ESC-Folge
                         C      
                         C      ; vorletztes Zeichen ESC-Folge
                         C      ;-----------------------------
                         C       IF escpc
  D62C    D6 5E          C      	sub	5eh		;Feldattribut oder Sonderzeichen?
  D62E    32 D648        C      	ld	(crtffl),a	;wenn ja, so 00 bzw. 01
  D631    C8             C      	ret	z		;1b 5e xx
  D632    3D             C      	dec	a
  D633    C8             C      	ret	z		;1b 5f xx 
                         C       ENDIF
                         C      ;Positionierung Zeile
                         C       	if	adm3a
                         C      	endif
                         C      
  D634    3E 10          C      	ld	a,bszl1-1	;letzte zeile
  D635                   C      crtm08	equ	$-1
  D636    B9             C      	cp	c		;nach letzter zeile?
  D637    38 01          C      	jr	c,crto05	;ja
  D639    79             C      	ld	a,c		;sonst auf gewuenschte zeile
  D63A    21 F800        C      crto05:	ld	hl,bsanf1	;zeile adressieren
  D63B                   C      crtm09	equ	$-2
  D63D    B7             C      	or	a
  D63E    C8             C      	ret	z
  D63F    11 0040        C      	ld	de,bssp1
  D640                   C      crtm10	equ	$-2
  D642    47             C      	ld	b,a
  D643    19             C      crto06:	add	hl,de
  D644    10 FD          C      	djnz	crto06		;zeile finden
  D646    C9             C      	ret
                         C      
  D647                   C      crto07:
                         C      ; letztes Zeichen ESC-Folge
                         C      ;--------------------------
                         C       IF escpc
  D647    06 FF          C      	ld	b,0ffh
  D648                   C      crtffl	equ	$-1		;auf 00 bei "1b 5e xx"; auf 01 bei "1b 5f xx"
  D649    10 05          C      	djnz	crtnsp		;nicht 1b 5f xx
  D64B    F6 80          C      crtspc:	or	80h		;Bit 7 fuer Spezialzeichen setzen
  D64D    C3 D580        C      	jp	 crtobs
  D650                   C      crtnsp:
  D650    04             C      	inc	b		;1b 5e xx?
  D651    20 04          C      	jr	nz,crtnfa	;nein
  D653    E6 3F          C      	and	3fh		;Feldattribute lassen, Bit 6 =0
  D655    18 F4          C      	jr	crtspc
  D657                   C      crtnfa:
                         C       ENDIF
                         C      ; Positionierung Spalte
                         C      	if	adm3a
                         C      	endif
                         C      
  D657    3E 3F          C      	ld	a,bssp1-1	;spalte setzen
  D658                   C      crtm11	equ	$-1
  D659    B9             C      	cp	c		;0 .. letzte spalte
  D65A    30 01          C      	jr	nc,crto08	;ja
  D65C    4F             C      	ld	c,a		;sonst auf letzte spalte
  D65D    06 00          C      crto08:	ld	b,0
  D65F    09             C      	add	hl,bc
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-34


  D660    C9             C      	ret
                         C      
                         C      	if	adm3a
                         C      	endif
                         C      ;----------------------------
                         C      
                         C      ; ...Realisierung Sonderzeichen...
                         C      ;=================================
  D661    01 0040        C      crtcr:	ld	bc,bssp1
  D662                   C      crtm12	equ	$-2
  D664    21 FC3F        C      	ld	hl,bsend1
  D665                   C      crtm13	equ	$-2
  D667    B7             C      crto12:	or	a
  D668    ED 42          C      	sbc	hl,bc		;suchen,bis hl < (dcupos)
  D66A    E5             C      	push	hl
  D66B    ED 52          C      	sbc	hl,de
  D66D    E1             C      	pop	hl
  D66E    30 F7          C      	jr	nc,crto12	;zeilenanf. noch nicht gefunden
  D670    23             C      	inc	hl
  D671    C9             C      	ret
                         C      ;-----------------------------
  D672    21 FBFF        C      crtlf:	ld	hl,bsend1-bssp1
  D673                   C      crtm14	equ	$-2
  D675    ED 52          C      	sbc	hl,de	;bs ende (anfang letzte zeile)
  D677    DA D58C        C      	jp	c,crto03	;aufschieben
  D67A    21 0040        C      	ld	hl,bssp1
  D67B                   C      crtm15	equ	$-2
  D67D    19             C      	add	hl,de		;naechste zeile
  D67E    C9             C      	ret
                         C      ;-----------------------------
  D67F    12             C      crtdel:	ld	(de),a
  D680    21 F800        C      crtcl:	ld	hl,bsanf1	;cursor zurueck
  D681                   C      crtm16	equ	$-2
  D683    ED 52          C      	sbc	hl,de
  D685    EB             C      	ex	de,hl
  D686    C8             C      	ret	z
  D687    2B             C      	dec	hl
  D688    C9             C      	ret
                         C      ;----------------------------
  D689    11 F800        C      crtbsl:	ld	de,bsanf1	;bs loeschen + home
  D68A                   C      crtm17	equ	$-2
  D68C    21 FC3F        C      crtbsr:	ld	hl,bsend1
  D68D                   C      crtm18	equ	$-2
  D68F    ED 52          C      	sbc	hl,de
  D691    EB             C      	ex	de,hl
  D692    77             C      	ld	(hl),a
  D693    C8             C      	ret	z
  D694    E5             C      	push	hl
  D695    42             C      	ld	b,d	
  D696    4B             C      	ld	c,e
  D697    54             C      	ld	d,h
  D698    5D             C      	ld	e,l
  D699    13             C      	inc	de
  D69A    ED B0          C      	ldir
  D69C    E1             C      	pop	hl
  D69D    C9             C      	ret
                         C      ;----------------------------
  D69E    21 F800        C      crthom:	ld	hl,bsanf1	;home
  D69F                   C      crtm19	equ	$-2
  D6A1    C9             C      	ret
                         C      ;----------------------------
  D6A2                   C      crtcup:
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-35


                         C      	if	adm3a
                         C      	endif
                         C      
  D6A2    21 F83F        C      	ld	hl,bsanf1+bssp1-1  ;eine zeile hoch
  D6A3                   C      crtm20	equ	$-2
  D6A5    ED 52          C      	sbc	hl,de		;in oberster zeile?
  D6A7    EB             C      	ex	de,hl
  D6A8    D0             C      	ret	nc		;nicht ausfuehren
  D6A9    11 FFC0        C      	ld	de,0-bssp1
  D6AA                   C      crtm21	equ	$-2
  D6AC    19             C      	add	hl,de		;zeilenlaenge abziehen
  D6AD    C9             C      	ret
                         C      ;-----------------------------
  D6AE    CD D661        C      crtzl:	call	crtcr		;zeile loeschen
  D6B1    EB             C      	ex	de,hl
  D6B2    D5             C      crtzlr:	push	de		;restzeile loeschen
  D6B3    CD D661        C      	call	crtcr
  D6B6    09             C      	add	hl,bc
  D6B7    B7             C      	or	a
  D6B8    ED 52          C      	sbc	hl,de		;zeilenrest
  D6BA    12             C      crto13:	ld	(de),a
  D6BB    13             C      	inc	de
  D6BC    2D             C      	dec	l
  D6BD    20 FB          C      	jr	nz,crto13
  D6BF    E1             C      	pop	hl
  D6C0    C9             C      	ret
                         C      ;-----------------------------
                         C       IF inslin
  D6C1    CD D661        C      crtinl:	call	crtcr		;Insert line
  D6C4    E5             C      	push	hl		;hl auf Zeilenanfang
  D6C5    11 FF80        C      	ld	de,bsend2-bssp2+1 ;Anfang letzte Zeile
  D6C6                   C      crtm44	equ	$-2
  D6C8    EB             C      	ex	de,hl
  D6C9    B7             C      	or	a
  D6CA    ED 52          C      	sbc	hl,de		;Laenge
  D6CC    28 0A          C      	jr	z,crtil1	;letzte Zeile
  D6CE    44             C      	ld	b,h
  D6CF    4D             C      	ld	c,l
  D6D0    11 FFCF        C      	ld	de,bsend2	;Ziel
  D6D1                   C      crtm45	equ	$-2
  D6D3    21 FF7F        C      	ld	hl,bsend2-bssp2	;Quelle
  D6D4                   C      crtm46	equ	$-2
  D6D6    ED B8          C      	lddr			;eine Zeile nach unten schieben
  D6D8    D1             C      crtil1:	pop	de
  D6D9    62             C      	ld	h,d
  D6DA    6B             C      	ld	l,e
  D6DB    18 D5          C      	jr	crtzlr		;freigewordene Zeile loeschen
                         C      ;-----------------------------
  D6DD    CD D661        C      crtdll:	call	crtcr		;Delete Line
  D6E0    E5             C      	push	hl
  D6E1    11 FF80        C      	ld	de,bsend2-bssp2+1	;Anfang letzte Zeile
  D6E2                   C      crtm47	equ	$-2
  D6E4    EB             C      	ex	de,hl
  D6E5    B7             C      	or	a
  D6E6    ED 52          C      	sbc	hl,de		;Laenge
  D6E8    28 08          C      	jr	z,crtdl1	;letzte Zeile
  D6EA    E3             C      	ex	(sp),hl
  D6EB    54             C      	ld	d,h
  D6EC    5D             C      	ld	e,l		;de auf Ziel (Zeilenanfang)
  D6ED    09             C      	add	hl,bc		;hl auf Quelle
  D6EE    C1             C      	pop	bc
  D6EF    D5             C      	push	de
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-36


  D6F0    ED B0          C      	ldir			;eine Zeile nach oben schieben
  D6F2    21 FF80        C      crtdl1:	ld	hl,bsend2-bssp2+1
  D6F3                   C      crtm48	equ	$-2
  D6F5    54             C      	ld	d,h
  D6F6    5D             C      	ld	e,l
  D6F7    CD D6B2        C      	call	crtzlr		;letzte Zeile loeschen
  D6FA    E1             C      	pop	hl
  D6FB    C9             C      	ret
                         C      ;-----------------------------
                         C       ENDIF	;inslin
  D6FC    3E 02          C      crtesc:	ld	a,2		;escape flag setzen
  D6FE    32 D56D        C      	ld	(desc),a
                         C      
                         C      	if	costu or adm3a
  D701    AF             C      	xor	a
                         C      	if	costu
  D702    32 D5D7        C      	ld	(cotd2),a	;keine Stringdef.
                         C      	endif
                         C      	if	adm3a
                         C      	endif
                         C      	endif
                         C      
  D705    C9             C      	ret
                         C      ;-----------------------------
  D706    3E 80          C      crtcrt:	ld	a,80h		;cursor an
  D708    18 01          C      	jr	crto14
                         C      ;-----------------------------
  D70A    AF             C      crtcof:	xor	a		;cursor aus
  D70B    32 D532        C      crto14:	ld	(dcurs),a
  D70E    C9             C      	ret
                         C      ;-----------------------------
                         C      ; Realisierung 07h
                         C      ; Achtung! Diese Routine wird aus Interruptroutine aufgerufen!
  D70F    CD D712        C      crtclk:	call	crtcl1		;Fehlerlampe umschalten
                         C      
  D712    06 19          C      crtcl1:	ld	b,25		;0.25 sec warten
  D714    CD E8A4        C      	call	wait10
                         C      				;Fehlerlampe wieder zurueck
                         C      ; Fehlerlampe umschalten
                         C      ; Reg. A, HL bleiben erhalten
  D717    F5             C      swilmp:	push	af
  D718    E5             C      	push	hl
  D719    21 0040        C      	ld	hl,lampbf
  D71C    7E             C      	ld	a,(hl)
  D71D    EE 40          C      	xor	1 shl lmperr
  D71F    77             C      	ld	(hl),a
  D720    CD D44A        C      	call	lampen
  D723    E1             C      	pop	hl
  D724    F1             C      	pop	af
  D725    C9             C      	ret
                         C      ;-----------------------------
                         C      
                         C      ; Cursor aus HL im Bildschirmpuffer berechnen und setzen
  D726    2A D238        C      crtscp:	ld	hl,(dcupos)
  D729    11 F800        C      crtsci:	ld	de,bsanf1
  D72A                   C      crtm37	equ	$-2
  D72C    AF             C      	xor	a		;CY:=0, Zeile:=0
  D72D    ED 52          C      	sbc	hl,de		;relative Cursorposition
  D72F    11 0040        C      	ld	de,bssp1
  D730                   C      crtm25	equ	$-2
  D732    ED 52          C      crtoes:	sbc	hl,de		;bestimmen Zeilennummer
  D734    38 03          C      	jr	c,crtoez
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-37


  D736    3C             C      	inc	a
  D737    18 F9          C      	jr	crtoes
  D739    19             C      crtoez:	add	hl,de		;L:=Spalte
  D73A    67             C      	ld	h,a		;H:=Zeile
                         C      
                         C      ; Cursor setzen (H Zeile, L Spalte)
  D73B    3E 80          C      crtscu:	ld	a,80h
  D73D    D3 19          C      	out	(bscom),a
  D73F    7D             C      	ld	a,l
  D740    D3 18          C      	out	(bspar),a
  D742    7C             C      	ld	a,h
  D743    D3 18          C      	out	(bspar),a
  D745    C9             C      	ret
                         C      ;--------------------------------
                         C       IF zs2var
                         C       ENDIF
                         C      ;--------------------------------
                         C      
                         C       IF stpvar
                         C       IF chdvar
                         C      ;Hardcopy Bildschirm -> LST
  D746    E5             C      crthrd:	push	hl
  D747    21 F800        C      	ld	hl,bsanf1
  D748                   C      crtm22	equ	$-2
  D74A    0E 12          C      	ld	c,bszl1+1
  D74B                   C      crtm23	equ	$-1
  D74C    18 16          C      	jr	crthd3		;zu Beginn neue Zeile
  D74E    06 40          C      crthd1:	ld	b,bssp1
  D74F                   C      crtm24	equ	$-1
  D750    C5             C      crthd2:	push	bc
  D751    7E             C      	ld	a,(hl)
  D752    23             C      	inc	hl
  D753    E5             C      	push	hl
  D754    E6 7F          C      	and	7fh
  D756    FE 20          C      	cp	20h		;BS-Steuerzeichen?
  D758    30 02          C      	jr	nc,crthd4	;nein
  D75A    3E 5E          C      	ld	a,'^'		;sonst Sonderzeichen
  D75C    4F             C      crthd4:	ld	c,a
  D75D    CD D20F        C      	call	BIOS0F		;LIST
  D760    E1             C      	pop	hl
  D761    C1             C      	pop	bc
  D762    10 EC          C      	djnz	crthd2		;bis Zeilenende
  D764    C5             C      crthd3:	push	bc
  D765    E5             C      	push	hl
  D766    0E 0D          C      	ld	c,0dh
  D768    CD D20F        C      	call	BIOS0F
  D76B    0E 0A          C      	ld	c,0ah
  D76D    CD D20F        C      	call	BIOS0F
  D770    E1             C      	pop	hl
  D771    C1             C      	pop	bc
  D772    0D             C      	dec	c		;Bildschirmende?
  D773    20 D9          C      	jr	nz,crthd1	;nein
  D775    E1             C      	pop	hl
  D776    C9             C      	ret
                         C       ENDIF
                         C       ENDIF	;stpvar
                         C      
                         C      ; Tabelle der Sonderzeichen, SCP kompatibel!
                         C      ;==========================================
                         C      
  D777                   C      dszta:	
  D777    00             C      	db	00h	;nop
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-38


  D778    01             C      	db	01h	;home
  D779    02             C      	db	02h	;(auch 82h) cursor an
  D77A    03             C      	db	03h	;(auch 83h) cursor aus
  D77B    04             C      	db	04h	;(auch 84h) normal, nicht inv.
  D77C    05             C      	db	05h	;(auch 85h) normal,       inv.
  D77D    06             C      	db	06h	;(auch 86h) hell  , nicht inv.
                         C      ;			 (nur  87h) hell  ,       inv.
  D77E    07             C      	db	07h	;bell (akustisches zeichen)
  D77F    08             C      	db	08h	;cursor zurueck
  D780    0A             C      	db	0ah	;LF
  D781    0C             C      	db	0ch	;bs loeschen, cursor links oben
  D782    0D             C      	db	0dh	;CR
                         C       IF zs2var
                         C       ENDIF
  D783    14             C      	db	14h	;rest bs loeschen
  D784    15             C      	db	15h	;cursor vorwaerts
  D785    16             C      	db	16h	;rest der zeile loeschen
                         C       IF inslin
  D786    17             C      	db	17h	;Insert Line
                         C       ENDIF
  D787    18             C      	db	18h	;zeile loeschen, cursor an zeilanf.
                         C       IF inslin
  D788    19             C      	db	19h	;Delete Line
                         C       ENDIF
  D789    1A             C      	db	1ah	;eine zeile hoch
                         C      			;bei ADM3a wie 0ch
  D78A    1B             C      	db	1bh	;escape
                         C      ;		1b zeile+80h spalte+80h		Kursor posit. SCP
                         C      ;		1b zeile+00h spalte+00h		geht auch bei CP/A
                         C      ;		1b '='/'Y' zeile+20h spalte+20h	Kursor posit. bei ADM3A
                         C      ;		1b 5e xx	Feldattribut setzen (SCP1715 fuer 8275-Contr.)
                         C      ;			mit xx= 01urggbh
                         C      ;				  u		unterstreichen,
                         C      ;				   r		invers,
                         C      ;				    gg		Zeichengenerator-Umschaltung,
                         C      ;				      b		blinken,
                         C      ;				       h	heller 
                         C      ;		1b 5f xx	Spezialzeichen setzen (SCP1715 fuer 8275)
                         C      ;			mit xx= 01ssssbh
                         C      ;				  ssss		Zeichencode (1100 Sonderfkt)
                         C      ;				      b		blinken des Sonderzeichens
                         C      ;				       h	heller des Sonderzeichens
                         C      	if	adm3a
                         C      	endif
                         C      
  D78B    7F             C      	db	7fh	;delete
  D78C    87             C      	db	87h	;(nicht 07h) hell  ,      inv.
  0016                   C       dsztal	equ	$-dszta	;Tabellenlaenge
                         C      
                         C      ; Reaktionsroutinen fuer Sonderzeichen
                         C      
  D78D    D5D5           C      	dw	crtnop	;00
  D78F    D69E           C      	dw	crthom	;01
  D791    D706           C      	dw	crtcrt	;02/82
  D793    D70A           C      	dw	crtcof	;03/83
  D795    D5A5           C      	dw	crto84	;04/84
  D797    D5A9           C      	dw	crto85	;05/85
  D799    D5AD           C      	dw	crto86	;06/86
  D79B    D70F           C      	dw	crtclk	;07
  D79D    D680           C      	dw	crtcl	;08
  D79F    D672           C      	dw	crtlf	;0A
  D7A1    D689           C      	dw	crtbsl	;0C
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-39


  D7A3    D661           C      	dw	crtcr	;0D
                         C       IF zs2var
                         C       ENDIF
  D7A5    D68C           C      	dw	crtbsr	;14
  D7A7    D582           C      	dw	crtcur	;15
  D7A9    D6B2           C      	dw	crtzlr	;16
                         C       IF inslin
  D7AB    D6C1           C      	dw	crtinl	;17
                         C       ENDIF
  D7AD    D6AE           C      	dw	crtzl	;18
                         C       IF inslin
  D7AF    D6DD           C      	dw	crtdll	;19
                         C       ENDIF
  D7B1    D6A2           C      	dw	crtcup	;1A
  D7B3    D6FC           C      	dw	crtesc	;1B
                         C      
                         C      	if	adm3a
                         C      	endif
                         C      
  D7B5    D67F           C      	dw	crtdel	;7F
  D7B7    D5B1           C      	dw	crto87	;87
  D7B9                   C      dswe 	equ	$	;tabellenende
                         C      
                                
                                 IF chdvar
                         C      	include	BIOPCHD		;zeichenorientierte Geraete
                         C      ;**************************************************************
                         C      ;	zeichenorientierte Geraete, Version 10.06.87
                         C      ; Aenderungen:
                         C      ; Fehlerkorrektur UC1:-Treiber
                         C      ; - getrennter Status Sender/Empf.
                         C      ; - Verwaltung des DTR-Bits auf Empf.seite
                         C      ; - UC1: arbeitet empfangsseitig interruptgetrieben
                         C      ; - Einfuehrung eines UC1:-Puffers als Verlaengerung des SIO-Puffers
                         C      ; - bei E/A-Fehler (Drucker nicht bereit) warten auf Bestaetigung,
                         C      ;   moegliche Reaktion ^C, I(gnore device) oder R(etry)
                         C      ;**************************************************************
                         C      
                         C       if1
                         C       endif ; if1
                         C      
                         C      
                         C      ; Ausgabe
                         C      ;~~~~~~~~
                         C      ; TTY:
                         C      ;=====
                         C       if	iobtty
  D7B9    DD 21 D80F     C      ttyo:	ld	ix,lsttty
  D7BD    18 06          C      	jr	lsto
                         C       endif
                         C      
                         C      ; LPT:
                         C      ;=====
                         C       if	ioblpt
                         C       else
  D2EF                   C      lpto	equ	dumo
                         C       endif
                         C      
                         C      ; UC1:
                         C      ;=====
                         C       if	iobuc1
  D7BF    DD 21 D81F     C      uc1o:	ld	ix,lstuc1
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-40


  D7C3    18 00          C      	jr	lstoch		;nicht 2 Bahn Zeichen interpr.
                         C       endif
                         C      
  D7C5                   C      lsto:
  D7C5                   C      listi:	;interner Aufruf lsto mit gestelltem IX
                         C       IF l2bahn
                         C       ENDIF
                         C      
                         C      ; Einzelzeichenausgabe Reg. C
                         C      ;-----------------------------
  D7C5                   C      lstoch:
  D7C5    DD CB 00 4E    C      	bit	1,(ix+ltpst)	;senderseitig blockiert?
  D7C9    C0             C      	ret	nz		;ja, Ausgabe ignorieren
  D7CA    C5             C      	push	bc		;retten Zeichen in C
  D7CB    0E 1E          C      loutws:	ld	c,30		;max. Wartezeit in Sek. auf ready
  D7CD    06 64          C      loutw1:	ld	b,100		;100*10ms warten
  D7CF    C5             C      loutwt:	push	bc
  D7D0    CD D7F6        C      	CALL	lststi		;Status holen
  D7D3    20 11          C      	jr	nz,loutwf	;ist frei
  D7D5    06 01          C      	ld	b,1
  D7D7    CD E8A4        C      	call	wait10		;Warten 10 ms
  D7DA    C1             C      	pop	bc
  D7DB    10 F2          C      	djnz	loutwt		;weiter warten?
  D7DD    0D             C      	dec	c		;weitere Sekunde warten?
  D7DE    20 ED          C      	jr	nz,loutw1	;ja
                         C       IF errvar
                         C       ENDIF
  D7E0    C1             C      	pop	bc
  D7E1    DD CB 00 CE    C      	set	1,(ix+ltpst)	;Sender blockiert
  D7E5    C9             C      	ret			;folgende Ausgaben werden ignor.
  D7E6    C1             C      loutwf:	pop	bc
  D7E7    C1             C      	pop	bc
  D7E8    79             C      	ld	a,c		;auszugebendes Zeichen nach A
  D7E9    DD 6E 04       C      	ld	l,(ix+ltpo)
  D7EC    DD 66 05       C      	ld	h,(ix+ltpo+1)
  D7EF    E9             C      	jp	(hl)
                         C      
                         C       IF errvar
                         C       ENDIF	;errvar
                         C      
                         C      ;-----------------------
                         C      
                         C      
                         C      ; Status
                         C      ;-------
                         C      ; o A=0, ret z	: Ausgabe besetzt
                         C      ; o A=ff,ret nz	: Ausgabe frei
                         C      
                         C      ; TTY:
                         C      ;=====
                         C       if	iobtty
  D7F0    DD 21 D80F     C      ttyst:	ld	ix,lsttty
  D7F4    18 00          C      	jr	lstst
                         C       endif
                         C      
                         C      ; LPT
                         C      ;====
                         C       if	ioblpt
                         C       else
  D2E9                   C      lptst	equ	dumst
                         C       endif
                         C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-41


                         C       if iobuc1
                         C       endif
                         C      
  D7F6                   C      lstst:
  D7F6                   C      lststi:	;interner Aufruf Sender-Status mit gestelltem IX
                         C      ; ret nz, A=FF fuer frei
                         C      ; ret z , A=00 fuer besetzt
                         C      
  D7F6    DD 6E 08       C      	ld	l,(ix+ltps)
  D7F9    DD 66 09       C      	ld	h,(ix+ltps+1)
  D7FC    E9             C      	jp	(hl)
                         C      
                         C      ;-----------------------------
                         C      
                         C      ; Zeichenempfang
                         C      ;---------------
                         C      
  D2EC                   C      ttyi	equ	dumi
  D2EC                   C      lpti	equ	dumi
                         C       if iobuc1
                         C       endif
                         C      
                         C      ;-------------------------------
                         C      
                         C      ; Synchronisieren
                         C      ;----------------
  D7FD                   C      lsynch:	
  D7FD    AF             C      	xor	a		;;SIO neu initialisieren
                         C      	if	iobtty
  D7FE    32 D80F        C      	ld	(lsttty+ltpst),a
                         C      	endif
                         C      	if	ioblpt
                         C      	endif
                         C      	if	iobuc1
  D801    32 D81F        C      	ld	(lstuc1+ltpst),a
                         C      	endif
  D804    C9             C      	ret
                         C      
                         C      ; Portprogrammierung
                         C      ;===================
                         C      ; i HL	^Steuertabelle, Laenge+1, Port, Bytes,...,1
  D805                   C      portpr:
  D805    46             C      portpz:	ld	b,(hl)		;Stringlaenge +1
  D806    23             C      	inc	hl
  D807    05             C      	dec	b		;Ende?
  D808    C8             C      	ret	z		;ja
  D809    4E             C      	ld	c,(hl)		;Port
  D80A    23             C      	inc	hl
  D80B    ED B3          C      	otir
  D80D    18 F6          C      	jr	portpz
                         C      
                         C      ;Steuertabellen fuer zeichenweise arbeitende Geraete
                         C      ;===================================================
                         C      
                         C      ;Struktur:
                         C      ; fester Teil
  0000                   C      ltpst	equ	0	;Status
                         C      			;Bit  7-4 Empf.,3-0 Sender  Bedeutung, wenn =1
                         C      			;	4	0 Empfseite init./ Senderseite init.
                         C      			;	5	1      -	 / Sender blockiert
                         C      			;	7	3 Sender gestoppt/ Sender hat frei gem.
  0001                   C      ltpdc	equ	1	;zuletzt empf. Zeichen (i.a. DCx)
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-42


                         C      			; (DC1/3 bei IFSS, bei DTR nur bei UC1: benutzt)
  0002                   C      ltpsd	equ	2	;Portadr. Daten
  0003                   C      ltpsc	equ	3	;Portadr. Kommando/Status (noch mal in ltpini!)
                         C      
  0004                   C      ltpo	equ	4	;Adresse der Senderoutine
  0006                   C      ltpi	equ	6	;Adresse der Empfangsroutine
  0008                   C      ltps	equ	8	;Adresse der Empfangsstatus-Routine
                         C      
                         C      ; Der folgende Teil existiert nur fuer SIO-Treiber
  000A                   C      ltpw5	equ	10	;WR5:
                         C      			;Prozedur Bit 7,1: 11 DTR; 00 DC1/DC3
                         C      			;Bitanzahl/Byte Bit 6,5: 00 5;01 7;10 6;11 8
                         C      			;Bit 3 = 1 (Senderfreigabe)
                         C      			;Bit 0,2,4 = 0
                         C      ; Port-Initialisierung (fuer alle Treiber)
  000B                   C      ltpini	equ	11	;jeweils Byteanzahl+1; Port; Bytefolge
                         C      			;variabel lang
                         C      
                         C      			;fuer SIO-Treiber einige Erlaeuterungen:
                         C      			;Port CTC-Sendetakt
                         C      			;Vorteiler (37h DTR; 17h DC1/3)
                         C      			;Baudrate (1=9600,2=4800,..64=150,96=100,128=75)
                         C      			;evtl. nochmal fuer Port CTC-Empf.takt
                         C      			;WR4:
                         C      			;Paritaet in Bit 1,0: 00 ohne, 01 unger., 11 ger.
                         C      			;Stop-Bits in Bit 3,2: 01 1; 10 1,5; 11 2
                         C      			;Reserve   in Bit 5,4: 00 immer
                         C      			;Prozedur  in Bit 7,6: 00 DTR; 01 DC1/DC3
                         C      			;WR1:
                         C      			;Interrvektormod. in Bit 2: 0=keine Modifizierung
                         C      			;in Kanal B!! setzen
                         C      			;Empf.interr.mode Bit4,3: 00 kein Interrupt
                         C      			;			  01 bei erstem Zeichen
                         C      			;			  10 bei jedem mit Mod.
                         C      			;			  11 bei jedem ohne Mod.
                         C      			;WR3:
                         C      			;Empf.freigabe in Bit 0: 0=Empf. gesperrt; 1=Empf. frei
                         C      			;Bit 1-5:00000
                         C      			;Bitanzahl/Byte Bit 7,6:00 5;01 7;10 6;11 8
                         C      
                                 IF iobtty
  0713                          @lt	aset	iobtty
  000C                          @ld	aset	ttydat
  000E                          @ls	aset	ttysta
  0008                          @lcs	aset	ttycts
  0008                          @lcr	aset	ttyctr
  D80F                   C      lsttty:	include	BIOPCPB
  D80F    00             C      	db	00H	;Status
  D810    00             C      	db	00H	;zuletzt empfangenes Zeichen
  D811    0C             C      	db	@ld	;Daten
  D812    0E             C      	DB	@ls	;Status/Kommando
                         C       IF (@lt mod 10) lt 5	;;SIO
  D813    D838           C      	dw	cdsioo	;;Senden
  D815    D2EC           C      	dw	cdsioi	;;Empfang
  D817    D84C           C      	dw	cdsios	;;Empf.Status
  0008                   C      @l	aset	00001000b	;;DC1/3, 5 Bit
                         C       if (@lt mod 10) eq 1
  008A                   C      @l	aset	@l xor 10000010b	;;DTR
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 6
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 7
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-43


                         C       endif
                         C       if ((@lt mod 1000)/100) eq 8
  00EA                   C      @l	aset	@l xor 01100000b
                         C       endif
  D819    EA             C      	db	@l	;WR5
                         C      			;**Portinitialisierung**
  D81A    03             C       	db	2+1
  D81B    08             C      	db	@lcs		;CTC Senden
                         C       IF @ld ne kbdsci	;;bei PC1715 SIO durch Tastatur initialisiert!!
                         C       ELSE
  D81C    37             C      	db	37h		;Vorteiler 256 (da in WR4 Takt*1 fuer Tastatur)
                         C       ENDIF
  0001                   C      @l	aset	1 shl (((@lt mod 100)/10)-1)
                         C        if ((@lt mod 100)/10) eq 8
                         C        endif
                         C        if ((@lt mod 100)/10) eq 9
                         C        endif
  D81D    01             C      	db	@l		;Baudrate senden
                         C        if @lcr ne @lcs
                         C        endif
                         C       IF @ld ne kbdsci	;;bei PC1715 SIO durch Tastatur initialisiert!!
                         C       ENDIF	;;@ld ne kbdsci
  D81E    01             C      	db	1	;**Ende**
                         C       ENDIF
                         C      
                                 ENDIF
                                
                                 IF ioblpt
                                 ENDIF
                                
                                 IF iobuc1
  0713                          @lt	aset	iobuc1
  000D                          @ld	aset	uc1dat
  000F                          @ls	aset	uc1sta
  0009                          @lcs	aset	uc1cts
  0009                          @lcr	aset	uc1ctr
  D81F                   C      lstuc1:	include	BIOPCPB
  D81F    00             C      	db	00H	;Status
  D820    00             C      	db	00H	;zuletzt empfangenes Zeichen
  D821    0D             C      	db	@ld	;Daten
  D822    0F             C      	DB	@ls	;Status/Kommando
                         C       IF (@lt mod 10) lt 5	;;SIO
  D823    D838           C      	dw	cdsioo	;;Senden
  D825    D2EC           C      	dw	cdsioi	;;Empfang
  D827    D84C           C      	dw	cdsios	;;Empf.Status
  0008                   C      @l	aset	00001000b	;;DC1/3, 5 Bit
                         C       if (@lt mod 10) eq 1
  008A                   C      @l	aset	@l xor 10000010b	;;DTR
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 6
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 7
                         C       endif
                         C       if ((@lt mod 1000)/100) eq 8
  00EA                   C      @l	aset	@l xor 01100000b
                         C       endif
  D829    EA             C      	db	@l	;WR5
                         C      			;**Portinitialisierung**
  D82A    03             C       	db	2+1
  D82B    09             C      	db	@lcs		;CTC Senden
                         C       IF @ld ne kbdsci	;;bei PC1715 SIO durch Tastatur initialisiert!!
  D82C    17             C      	db	17h		;Vorteiler 16
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-44


                         C       ENDIF
  0001                   C      @l	aset	1 shl (((@lt mod 100)/10)-1)
                         C        if ((@lt mod 100)/10) eq 8
                         C        endif
                         C        if ((@lt mod 100)/10) eq 9
                         C        endif
  D82D    01             C      	db	@l		;Baudrate senden
                         C        if @lcr ne @lcs
                         C        endif
                         C       IF @ld ne kbdsci	;;bei PC1715 SIO durch Tastatur initialisiert!!
  D82E    08             C      	db	7+1
  D82F    0F             C      	db	@ls		;SIO-Komm.
  D830    18             C      	db	18h		;WR0
  0044                   C      @l	aset	01000100b	;;Takt*16, ohne P., 1 Stbit, DTR
                         C        if @lt ge 10000
                         C        endif
                         C        if @lt ge 20000
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 2
                         C        endif
                         C        if ((@lt mod 10000)/1000) eq 3
                         C        endif
  D831    04 44          C      	db	4,@l		;WR4
  D833    01 00          C      	db	1,0		;WR1
  0001                   C      @l	aset	00000001b	;;5 Bit, Empf.freigabe
                         C        if ((@lt mod 1000)/100) eq 6
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 7
                         C        endif
                         C        if ((@lt mod 1000)/100) eq 8
  00C1                   C      @l	aset	@l xor 11000000b
                         C        endif
  D835    03 C1          C      	db	3,@l		;WR3
                         C       ENDIF	;;@ld ne kbdsci
  D837    01             C      	db	1	;**Ende**
                         C       ENDIF
                         C      
                                 ENDIF
                                
                                  IF cdtdc1 or cdtdtr
                         C      	include	BIOPCSIO
                         C      ; SIO-Treiber, Version 28.09.87
                         C      ; Aenderungen:
                         C      ; - Statusabfrage jedesmal, auch wenn zuvor frei gemeldet
                         C      ; - Pufferueberlauf bei UC1-Puffer kontrolliert
                         C      ; - bei DC1/DC3 nach Initialisierung DC1/DC3 abgewartet (Fehler SD1157)
                         C      ;   (max. 30 sec)
                         C      ; - bei DTR nach Ausgabe jedes Zeichens 2 ms gewartet (sonst ab und
                         C      ;   zu Zeichenverlust bei K6311, da Zusammenspiel mit CTS-Signal nicht
                         C      ;   klappt!!)
                         C      
  D2EC                   C      cdsioi	equ	dumi		;keine Zeicheneingabe unterstuetzt
                         C      
                         C      ; Einzelzeichenausgabe Reg. A
  D838    DD 4E 02       C      cdsioo:	ld	c,(ix+ltpsd)	;Datenport
  D83B    ED 79          C      	out	(c),a
                         C      ;;; Verzoegerung wegen CTS-Problemen beim K6311
  D83D    DD CB 0A 7E    C      	bit	7,(ix+ltpw5)	;Prozedur DTR?
  D841    C8             C      	ret	z		;nein
  D842    0E 02          C      	ld	c,2		;2ms Wait (damit Sende-/Empfangspuffer leer)
  D844    06 BD          C      cdsod1:	ld	b,189		;(189*13)/(256*9699)=0.001
  D846    10 FE          C      cdsod2:	djnz	cdsod2		;1ms warten
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-45


  D848    0D             C      	dec	c		;fertig?
  D849    20 F9          C      	jr	nz,cdsod1	;nein
                         C      ;;;
  D84B    C9             C      	ret
                         C      
                         C      ;------------------------------------
                         C      
                         C      ; Statusabfrage
  D84C    DD 7E 00       C      cdsios:	ld	a,(ix+ltpst)	;Status
  D84F    CB 4F          C      	bit	1,a		;senderseitig blockiert?
  D851    20 19          C      	jr	nz,lstsr	;ja, frei rueckmelden
  D853    B7             C      	or	a		;initialisiert?
  D854    CC D88A        C      	call	z,cdsin1	;nein
  D857    DD CB 0A 7E    C      	bit	7,(ix+ltpw5)	;Prozedur DTR?
  D85B    28 14          C      	JR	Z,lstsdc	;nein
  D85D    DD 4E 03       C      	ld	c,(ix+ltpsc)	;SIO Kommando
  D860    16 10          C      	LD	d,00010000b	;Reset Ext/Status-Interrupt
  D862    ED 51          C      	OUT	(C),d		;d.h. CTS in Reg. 0 abspeichern
  D864    ED 78          C      	IN	a,(C)		;Leseregister 0
  D866    CB 6F          C      	BIT	5,a		;CTS?
  D868    28 02          C      	JR	Z,lstsr		;nein, besetzt
  D86A    CB 57          C      	BIT	2,a		;Sendepuffer leer? (nz bei ja)
                         C      ; Ausgang Senderstatus
  D86C                   C      lstsr:
  D86C    3E FF          C      lstsr1:	ld	a,0ffh
  D86E    C0             C      	ret	nz		;senderseitig frei
  D86F    3C             C      	inc	a		;A=00, ret z
  D870    C9             C      	RET			;senderseitig besetzt
                         C      ;-----------------------
                         C      ; DC1/DC3 und XON/XOFF
  D871    DD 4E 02       C      lstsdc:	LD	C,(ix+ltpsd)	;SIO Daten
  D874    ED 78          C      	IN	A,(C)		;Status lesen (SIO speichert letzten Status)
  D876    DD 77 01       C      	LD	(ix+ltpdc),A	;zuletzt empf. Zeichen merken
  D879    E6 7F          C      	and	7fh		;evtl. Paritaet ignorieren
  D87B    FE 11          C      	cp	11h		;DC1?
  D87D    28 02          C      	jr	z,lstsd1	;ja
  D87F    AF             C      	xor	a		;A=00, ret z
  D880    C9             C      	ret
  D881    DD 4E 03       C      lstsd1:	ld	c,(ix+ltpsc)	;SIO Kommando
  D884    ED 78          C      	in	a,(c)
  D886    CB 57          C      	bit	2,a		;Sendepuffer leer? (nz bei ja)
  D888    18 E2          C      	jr	lstsr
                         C      ;-----------------------
                         C      
                         C      ; (Re-)Initialisierung
                         C      ; IX auf Steuertabelle
                         C      ; ret: C zeigt auf Kommandoport
  D88A                   C      cdsin1:
  D88A                   C      cdsini:
  D88A    DD 36 00 11    C      	LD	(ix+ltpst),11h	;ist initial..; Status neu abfragen
  D88E    DD 36 01 13    C      	LD	(ix+ltpdc),13H	;DC3 nach Initialisierung simulieren
  D892    DD E5          C      	push	ix
  D894    E1             C      	pop	hl
  D895    01 000B        C      	ld	bc,ltpini
  D898    09             C      	add	hl,bc
  D899    CD D805        C      	call	portpr		;CTC, WR0, WR4, WR1, WR3
  D89C    CD D8BE        C      	call	ltpow5		;WR5
  D89F    DD CB 0A 7E    C      	bit	7,(ix+ltpw5)	;Prozedur DC1/DC3?
  D8A3    C0             C      	ret	nz		;nein
  D8A4    41             C      	ld	b,c
  D8A5    DD 4E 02       C      	ld	c,(ix+ltpsd)	;Datenport
  D8A8    3E 7F          C      	ld	a,7fh		;Reset an Drucker
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-46


  D8AA    ED 79          C      	out	(c),a
  D8AC    48             C      	ld	c,b
  D8AD    11 0BB8        C      	ld	de,30*100	;max. Wartezeit ca. 30 sec (SD1157!)
  D8B0    ED 78          C      cdsinw:	in	a,(c)
  D8B2    CB 47          C      	bit	0,a		;Antwort da?
  D8B4    C0             C      	ret	nz		;ja
  D8B5    CD E8A4        C      	call	wait10		;10ms warten
  D8B8    1B             C      	dec	de
  D8B9    7A             C      	ld	a,d
  D8BA    B3             C      	or	e		;max. Wartezeit abgelaufen?
  D8BB    20 F3          C      	jr	nz,cdsinw	;nein
  D8BD    C9             C      	ret			;sonst Drucker wohl nicht bereit
                         C      
  D8BE    DD 5E 0A       C      ltpow5:	LD	e,(ix+ltpw5)	;Prozedurtyp/Bitanzahl
                         C      ; Stellen Schreibregister 5
                         C      ; Reg. B,HL bleiben erhalten
  D8C1    3E 05          C      ltpot5:	ld	a,5
  D8C3    DD 4E 03       C      	ld	c,(ix+ltpsc)
  D8C6    ED 79          C      	OUT	(C),A
  D8C8    ED 59          C      	OUT	(C),e
  D8CA    C9             C      	RET
                         C      
                         C      ;-------------------------------------
                         C       if iobuc1
                         C      
                         C      ; UC1-Routinen (ausser Senden)
                         C      
                         C      ; UC1: Empf.-Status
                         C      ;==================
                         C      ; o A=0, ret z	: kein Zeichen empfangen
                         C      ; o A=ff,ret nz	: Zeichen da
  D8CB    DD 21 D81F     C      uc1st:	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
  D8CF                   C      uc1si:	;interner Aufruf mit gestelltem IX
  D8CF    DD CB 00 66    C      	bit	4,(ix+ltpst)	;initialisiert?
  D8D3    20 10          C      	jr	nz,uc1si1	;ja
  D8D5    F3             C      	di
  D8D6    AF             C      	xor	a
  D8D7    32 D97B        C      	ld	(uc1bfp),a	;Puffer leeren
  D8DA    CD D88A        C      	call	cdsini		;Initialisierung
  D8DD    21 D8ED        C      	ld	hl,uc1i2	;WR1,WR2 programmieren
  D8E0    06 04          C       	ld	b,4
  D8E2    ED B3          C      	otir
  D8E4    FB             C      	ei
  D8E5    3A D97B        C      uc1si1:	ld	a,(uc1bfp)	;Zeichen im Empfpuffer?
  D8E8    B7             C      	or	a
  D8E9    C8             C      	ret	z		;nein
  D8EA    3E FF          C      	ld	a,0ffh
  D8EC    C9             C      	ret
                         C      
  D8ED    01 14          C      uc1i2:	db	1,00010100b	;Empfinterr. jedes Zeichen, Intv.mod.
  D8EF    02 D0          C      	db	2,ivsio0	;Interruptvektor
                         C      
                         C      ; UC1: empf. Zeichen an Nutzer
                         C      ;=============================
                         C      ; o A:	aeltestes empf. Zeichen
                         C      
  D8F1    DD 21 D81F     C      uc1i:	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
                         C      
  D8F5                   C      uc1ii:	;interner Aufruf mit gestelltem IX
  D8F5    FB             C      	ei			;UC1:-Interrupt zulassen
  D8F6    CD D8CF        C      uc1iw:	call	uc1si		;Zeichen da?
  D8F9    28 FB          C      	jr	z,uc1iw		;nein ***keine Zeitueberwachung!***
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-47


  D8FB    21 D97B        C      	ld	hl,uc1bfp
  D8FE    F3             C      	di
  D8FF    4E             C      	ld	c,(hl)
  D900    35             C      	dec	(hl)		;Pufferlaenge -1
  D901    06 00          C      	ld	b,0
  D903    23             C      	inc	hl		;^(aeltestes Pufferzeichen)
  D904    7E             C      	ld	a,(hl)		;Zeichen nach A
  D905    11 D97D        C      	ld	de,uc1buf+1
  D908    EB             C      	ex	de,hl
  D909    ED B0          C      	ldir			;Puffer aufschieben
  D90B    FB             C      	ei
  D90C    DD CB 00 7E    C      	bit	7,(ix+ltpst)	;war Stopaufforderung?
  D910    C8             C      	ret	z		;nein
  D911    F5             C      	push	af		;retten Zeichen
  D912    3A D97B        C      	ld	a,(uc1bfp)	;Pufferbelegung
  D915    FE 06          C      	cp	1*uc1bfl/3	;unter dem Limit?
  D917    DC D91C        C      	call	c,uc1ird	;ja, Senden wieder erlauben
  D91A    F1             C      	pop	af
  D91B    C9             C      	ret
                         C      
  D91C    DD CB 00 BE    C      uc1ird:	res	7,(ix+ltpst)
                         C       if (iobuc1 mod 10)	;DTR
  D920    C3 D8BE        C      	jp	ltpow5		;DTR wieder setzen
                         C       endif
                         C      
                         C      ; UC1: Empf.-Interrupt
                         C      ;=====================
  D923    ED 73 E3A4     C      uc1rin:	ld	(intsp),sp
  D927    31 F1E6        C      	ld	sp,intstk
  D92A    F5             C      	push	af
  D92B    E5             C      	push	hl
  D92C    D5             C      	push	de
  D92D    C5             C      	push	bc
  D92E    DD E5          C      	push	ix
  D930    21 D950        C      	ld	hl,uc1rir
  D933    E5             C      	push	hl
  D934    DD 21 D81F     C      	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
  D938    DD 4E 02       C      	ld	c,(ix+ltpsd)	;SIO Daten
  D93B    ED 40          C      	in	b,(c)		;Zeichen lesen
  D93D    21 D97B        C      	ld	hl,uc1bfp	;Pufferzeiger zum zuletzt empf. Zeichen
  D940    7E             C      	ld	a,(hl)
  D941    FE 14          C      	cp	uc1bfl		;Puffer voll?
  D943    D0             C      	ret	nc		;ja, Zeichen ignorieren
  D944    FE 0D          C      	cp	2*uc1bfl/3	;Puffer fast voll (SIO-Empf.puffer 3 Byte!)?
  D946    D4 D955        C      	call	nc,uc1ri1	;ja, DC3 senden bzw. DTR wegnehmen
  D949    34             C      	inc	(hl)		;+1
  D94A    5E             C      	ld	e,(hl)
  D94B    16 00          C      	ld	d,0
  D94D    19             C      	add	hl,de		;naechste freie Stelle
  D94E    70             C      	ld	(hl),b		;Zeichen in Puffer
  D94F    C9             C      	ret
  D950    DD E1          C      uc1rir:	pop	ix
  D952    C3 E39F        C      	jp	intrbc		;fertig
                         C      ; Stopaufforderung senden
                         C      ; B,HL bleibt erhalten
  D955    DD CB 00 FE    C      uc1ri1:	set	7,(ix+ltpst)	;merken Stopaufforderung
                         C       if (iobuc1 mod 10)	;DTR
  D959    DD 5E 0A       C      	ld	e,(ix+ltpw5)
  D95C    CB BB          C      	res	7,e		;DTR loeschen
  D95E    C3 D8C1        C      	jp	ltpot5
                         C       endif
                         C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-48


                         C      ; UC1: Interrupt Empf.-Fehler (Parit., Ueberlauf, Rahmenfehler)
                         C      ;============================
  D961                   C      uc1err:
  D961    ED 73 E3A4     C      	ld	(intsp),sp
  D965    31 F1E6        C      	ld	sp,intstk
  D968    F5             C      	push	af
  D969    E5             C      	push	hl
  D96A    D5             C      	push	de
  D96B    C5             C      	push	bc
  D96C    DD E5          C      	push	ix
  D96E    DD 21 D81F     C      	ld	ix,lstuc1	;Stellen IX auf Steuertabelle
  D972    DD 4E 03       C      	ld	c,(ix+ltpsc)	;SIO Kommando
  D975    16 30          C      	ld	d,00110000b	;Reset Fehler-Interrupt
  D977    ED 51          C      	out	(c),d
                         C      				;keine Fehlermeldung, da bei
                         C      				;Empf.ueberlauf alles noch
                         C      				;mehr verzoegert wird
  D979    18 D5          C      	jr	uc1rir
                         C      
                         C      ; UC1: Empfangspuffer
                         C      ;====================
  D97B    00             C      uc1bfp:	db	0
  D97C                   C      uc1buf:	ds	uc1bfl,0 
                         C      
                         C       endif	;uc1
                         C      
                         C      
                                  ENDIF
                                  IF cdtpio
                                  ENDIF
                                  IF cdtp54
                                  ENDIF
                                  IF cdtn56 or cdtp56
                                  ENDIF
                                 ENDIF
                                
                         C      	include BIOPDSK		;Disketten log. Umkleidung
                         C      
                         C      ;****************************************************
                         C      ;	Diskettentreiber; Umkleidung des phys. Transfers
                         C      ;	Version 27.04.88
                         C      ; Aenderungen:
                         C      ; - Jeder Fehler in Spur 0, Sektor 1 fuehrt zur Annahme von Systemspuren
                         C      ;   (A7100-System mit 5" FM und 8272-Hardware mit 128er Sektorlaenge)
                         C      ; - !!Schnittstelle fuer diskio-Aufruf neu!! (Flags neu, side zusaetzlich)
                         C      ; - Verify nach Schreiben kann laufwerksspezifisch gewaehlt werden
                         C      ; - Laufwerkskapazitaet nach phys. LW-Nr in Statuszeile
                         C      ; - Fehlerkorrektur bei KAYPRO IV fuer C128
                         C      ;****************************************************
                         C      
                         C       if1
                         C       endif
                         C      
                         C      ; Laufwerksauswahl
                         C      ;=================
                         C      ; i C: Laufw. (0=A:, 1=B: ...)
                         C      ; i E: Bit 0 ist LOGIN-Bit von BDOS (=0, wenn LOGIN)
                         C      
  D990    CD E96E        C      seldsk:	call	dgetpb		;HL auf DPH stellen, IX auf DPB
  D993    C8             C      	ret	z		;Geraet ex. nicht
  D994    79             C      	ld	a,c
  D995    32 DE8B        C      	ld	(ddrive),a	;Laufwerk merken
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-49


  D998    CB 43          C      	bit	0,e		;LOGIN von BDOS?
  D99A    C0             C      	ret	nz		;nein
                         C       if ramfl
                         C       endif
  D99B    E5             C      	push	hl		;^DPH merken
                         C      
                         C      	IF	dbufsz gt 7
  D99C    21 DE82        C      	ld	hl,dbdev
  D99F    BE             C      	cp	(hl)		;LOGIN fuer gepuffertes Device?
  D9A0    20 07          C      	jr	nz,dselnb	;nein
  D9A2    36 FF          C      	ld	(hl),0ffh	;Puffer ist ungueltig
  D9A4    21 DE81        C      	ld	hl,dbflg
  D9A7    CB 96          C      	res	dfbwr,(hl)	;kein veraend. Puffer auszug.!
  D9A9                   C      dselnb:
                         C      	ENDIF
                         C      
                         C      	IF	format
                         C      ;++++++++++Automatische Format-Erkennung++++++++++
                         C      ; Reg. C zeigt auf Laufwerk
                         C      
  D9A9    DD CB 0F 76    C      	bit	dpbfrm,(ix+dpbflg);Formaterkennung unterdr.?
  D9AD    C2 DB58        C      	jp	nz,selext	;ja
                         C      
                         C      	IF	dbufsz gt 7
  D9B0    CD DCE4        C       	call	dbtrw		;Puffer freimachen
                         C      				;und auf Lesen schalten
  D9B3    21 DE97        C      	ld	hl,dbnb
  D9B6    36 FF          C      	ld	(hl),0ffh	;Puffernummer ist ungueltig, obwohl evtl.
                         C      				;alle anderen Pufferparameter stimmen
                         C      				;(da nur 128 Bytes vom Puffer belegt sind)
                         C      	ENDIF
                         C      
  D9B8    79             C      	ld	a,c
  D9B9    32 DE7B        C      	ld	(dfrmdv),a
  D9BC    32 DE82        C      	ld	(dbdev),a
                         C      
  D9BF    AF             C      	xor	a
  D9C0    DD 77 0F       C      	ld	(ix+dpbflg),a	;ruecksetzen alle Flags
  D9C3    DD 77 13       C      	ld	(ix+dpbsn0),a	;keine Weiter-Numm. auf Ruecks.
  D9C6    DD 77 0D       C      	ld	(ix+dpbofs),a	;keine Systemspuren
                         C      
  D9C9    32 DE7C        C      	ld	(dfrmtr),a	;Spur 0
  D9CC    32 DE83        C      	ld	(dbtrk),a
  D9CF    3C             C      	inc	a
  D9D0    32 DE85        C      	ld	(dbsec),a	;Sektor 1
  D9D3    32 DE87        C      	ld	(dbsnb),a	;1 phys. Sektor lesen
                         C      
                         C      ; Stellen  Sektor-Translate-Tabelle 1,2,3,...
  D9D6    DD E5          C      	push	ix
  D9D8    06 1A          C      	ld	b,26		;max. Laenge der Tabelle
                         C       IF dsk8mf
                         C       ENDIF
  D9DA    DD 77 19       C      selstz:	ld	(ix+dpbstr),a
  D9DD    DD 23          C      	inc	ix
  D9DF    3C             C      	inc	a
  D9E0    10 F8          C      	djnz	selstz
  D9E2    DD E1          C      	pop	ix
                         C      
                         C      ; Positionieren auf Spur 0 und analysieren Systemspuren
  D9E4    CD DCFC        C      	call	dsidtr		;beliebigen Sekt.Id lesen
  D9E7    20 3E          C      	jr	nz,selsys	;Fehler beim Lesen; Systemsp. annehmen
                         C      ;				 (z.B. SCP1700 mit 5"FM in Spur 0!!)
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-50


  D9E9    7C             C      	ld	a,h
  D9EA    32 DE86        C      	ld	(dbslc),a	;setzen Spurformat fuer Sp. 0
                         C      	IF	dbufsz le 7
                         C      	ENDIF
  D9ED    21 DE81        C      	ld	hl,dbflg
                         C       IF dsk8mf
                         C       ENDIF
  D9F0    46             C      	ld	b,(hl)		;merken Fehlerprotokoll-Bit
  D9F1    CB E6          C      	set	dfbtr,(hl)	;kein Fehlerprotokoll
  D9F3    E5             C      	push	hl
  D9F4    CD DCEA        C      	call	dbtran		;Lesen Spur 0, Sektor 1
  D9F7    E1             C      	pop	hl
  D9F8    70             C      	ld	(hl),b		;setzen Standard fuer Fehlerprotokoll-Bit
  D9F9    20 2C          C      	jr	nz,selsys	;Fehler, Systemspuren annehmen
  D9FB    FD E5          C      	push	iy
  D9FD    FD 2A DE88     C      	ld	iy,(dbdma)
  DA01    FD 7E 00       C      	ld	a,(iy+0)	;Format-Loeschbyte
  DA04    FE E5          C      	cp	0e5h		;leere Diskette/geloeschter Eintrag?
  DA06    20 0A          C      	jr	nz,selsy2	;nein, weder/noch
  DA08    FD BE 01       C      	cp	(iy+1)		;auch danach 0e5h?
  DA0B    20 15          C      	jr	nz,selsy0	;nein, geloeschter Dir-Eintrag
  DA0D    DD 35 0D       C      	dec	(ix+dpbofs)	;Flag: leere Disk oder leere Systemsp.
  DA10    18 10          C      	jr	selsy0		;dpbofs auf 254
  DA12                   C      selsy2:
                         C       if ibmfrm
  DA12    FE 40          C      	cp	40h		;IBM-Format (SIOS-Daten-Diskette)?
  DA14    28 0F          C      	jr	z,selsy1	;ja, 0 Systemspuren annehmen
                         C       endif
  DA16    FE 20          C      	cp	20h		;<=31 ? ("S"YL ist groesser!)
  DA18    30 0B          C      	jr	nc,selsy1	;nein, kann kein Directory sein; 0 Systemsp.
                         C      ;Systemlader fuer PC1715 beginnt mit 02 oder 03
  DA1A    FD 7E 20       C      	ld	a,(iy+20h)	;bei SCP1715-Systemdiskette dort 00h
                         C      				;bei MicroDos dort 10h
  DA1D    FD B6 21       C      	or	(iy+21h)	;bei SCP1715-Systemdiskette dort 00h
                         C      				;bei CP/A dort Dir-Eintrag (E5 oder Filename)
  DA20    28 03          C      	jr	z,selsy1	;beides 00h, kein Directory; 0 Systemsp.
  DA22    DD 35 0D       C      selsy0:	dec	(ix+dpbofs)	;=255, wenn Directory; =254 wenn vorn leer
  DA25                   C      selsy1:
  DA25    FD E1          C      	pop	iy
  DA27                   C      selsys:
                         C      
                         C      ; Analysieren Datenspur
                         C      
                         C      ; SS/DS-Analyse
  DA27    DD 36 12 02    C      	ld	(ix+dpbstp),2	;Doppel-Step-Impulse
  DA2B    3E 03          C      	ld	a,dlgint	;auf LOGIN-Spur
  DA2D    CD DCF9        C      	call	dsidtt		;belieb. SektId Vorderseite lesen
  DA30    20 2B          C      	jr	nz,seldle	;Fehler, unsicheres Format
  DA32    54             C      	ld	d,h		;d:=Sektorlcode, e:=Spur
                         C       IF dsk8mf
                         C       ENDIF
                         C       IF dskds
  DA33    DD CB 18 46    C      	bit	dpbtds,(ix+dpbtyp)	;ist es ein DS-Laufwerk?
  DA37    28 14          C      	jr	z,selss		;nein, SS
  DA39    D5             C      	push	de		;merken Sektorlaengencode und Spur
  DA3A    DD CB 0F EE    C      	set	dpbfds,(ix+dpbflg)
  DA3E    3E 07          C      	ld	a,1+(dlgint*2)	;Rueckseite der Spur,
                         C      				;ab der Format bei SS konstant
  DA40    CD DCF9        C      	call	dsidtt		;beliebigen Sekt.Id Ruecks. lesen
  DA43    7A             C      	ld	a,d		;merken side Ruecks.
  DA44    6B             C      	ld	l,e		;h:=Sektorlcode, l:=Spur Rueckseite
  DA45    D1             C      	pop	de		;wiederherstellen Vorderseite
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-51


  DA46    20 05          C      	jr	nz,selss	;Fehler beim Lesen, SS
  DA48    B7             C      	or	a
  DA49    ED 52          C      	sbc	hl,de		;Vorder- gleich Rueckseite?
  DA4B    28 04          C      	jr	z,sel48		;ja; 40 Tr/ 80 Tr unterscheiden
  DA4D    DD CB 0F AE    C      selss:	res	dpbfds,(ix+dpbflg)
                         C       ENDIF
                         C      
                         C      ; 40/80 Track Analyse
  DA51    7B             C      sel48:	ld	a,e		;trk
  DA52    D6 03          C      	sub	dlgint		;waren 2 Steps richtig? 
  DA54    28 12          C      	jr	z,seldl1	;ja
  DA56    DD 35 12       C      	dec	(ix+dpbstp)	;Einzelstep-Impulse
  DA59    D6 03          C      	sub	dlgint		;waere 1 Step richtig?
  DA5B    28 0B          C      	jr	z,seldl1	;ja
                         C      				;nein, unsicher
  DA5D    DD 36 10 FF    C      seldle:	ld	(ix+dpbslc),0ffh;provozieren 'BAD SECTOR'
  DA61    21 0000        C      	ld	hl,0		;erzeugen 'SELECT' Error
  DA64    E3             C      	ex	(sp),hl
  DA65    C3 DB58        C      	jp	selext
                         C      
                         C      ; DS/SS und 40/80 ist unterschieden, es fehlt Sektorlaenge
  DA68    7A             C      seldl1:	ld	a,d
  DA69    DD 77 10       C      	ld	(ix+dpbslc),a	;definieren Sektorlaengencode
                         C       IF	dbufsz le 7
                         C       ELSE
                         C      	IF	dbufsz lt 10	;Test, ob Disk-Puffer ausreicht
                         C      	ENDIF
  DA6C    B7             C      	or	a		;Sektorlaenge 128?
  DA6D    20 0F          C      	jr	nz,seldxl	;nein, normale Sektorfolge
                         C       ENDIF	;dbufsz gt 7
                         C       IF dsk8mf
                         C       ENDIF
  DA6F                   C      seldsv:
                         C      ; Stellen Sektor-Translate-Tabelle 1,7,13,..
  DA6F    DD E5          C      	push	ix
  DA71    E1             C      	pop	hl
  DA72    01 0019        C      	ld	bc,dpbstr
  DA75    09             C      	add	hl,bc
  DA76    EB             C      	ex	de,hl
  DA77    21 DE60        C      	ld	hl,xlt
  DA7A    0E 1A          C      	ld	c,26
  DA7C    ED B0          C      	ldir
  DA7E                   C      seldxl:
                         C      
  DA7E    CD DDF3        C      	call	dtrsla		;stellen hl entspr. Sektorlaenge
  DA81    20 DA          C      	jr	nz,seldle	;unzulaessig
  DA83    01 0005        C      	ld	bc,dsll		;Laenge eines Eintrags
                         C       IF disk8
                         C       ENDIF
  DA86    DD CB 12 4E    C      	bit	1,(ix+dpbstp)	;40 Tr. auf 80er LW?
  DA8A    20 08          C      	jr	nz,seld40	;ja
  DA8C    DD 7E 16       C      	ld	a,(ix+dpbptr)	;40er LW?
  DA8F    FE 29          C      	cp	40+1
  DA91    38 01          C      	jr	c,seld40	;ja, 40 Tr. auf 40er LW
  DA93    09             C      	add	hl,bc		;auf 80er Format stellen
  DA94    DD CB 0F 6E    C      seld40:	bit	dpbfds,(ix+dpbflg)	;DS?
  DA98    28 02          C      	jr	z,seldss	;nein
  DA9A    09             C      	add	hl,bc		;auf DS Format
  DA9B    09             C      	add	hl,bc
  DA9C                   C      seldss:
  DA9C                   C      selset:
                         C      ; DPB modifizieren entsprechend erkanntem Format
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-52


  DA9C    4E             C      	ld	c,(hl)		;Zahl der benutzten Spuren
  DA9D    DD 71 14       C      	ld	(ix+dpbtrk),c
  DAA0    23             C      	inc	hl
  DAA1    4E             C      	ld	c,(hl)		;Anzahl 128er Sektoren pro Spur
  DAA2    DD 71 00       C      	ld	(ix+dpbspt),c
  DAA5    23             C      	inc	hl
  DAA6    4E             C      	ld	c,(hl)		;Anzahl der Dir-Eintraege -1
  DAA7    23             C      	inc	hl
  DAA8    7E             C      	ld	a,(hl)		;Anzahl der Systemspuren
  DAA9    CB 3F          C      	srl	a		;feste Anzahl erzwungen?
  DAAB    38 28          C      	jr	c,seldof	;ja
  DAAD    DD CB 0D 7E    C      	bit	7,(ix+dpbofs)	;kann Spur 0 Directory sein?
  DAB1    28 22          C      	jr	z,seldof	;nein, Standardanzahl setzen
  DAB3    DD 34 0D       C      	inc	(ix+dpbofs)	;evtl. leere Systemspur?
  DAB6    28 1C          C      	jr	z,seldo0	;nein, 0 Systemspuren
  DAB8    47             C      	ld	b,a		;retten Anzahl Systemspuren
  DAB9    32 DE83        C      	ld	(dbtrk),a	;einlesen evtl. moeglicher Datenbeginn
  DABC    E5             C      	push	hl
  DABD    CD DCEA        C      	call	dbtran		; dauert bei falscher Spur etwas laenger
  DAC0    E1             C      	pop	hl
  DAC1    78             C      	ld	a,b
  DAC2    20 11          C      	jr	nz,seldof	;Fehler, mit Systemspuren annehmen
  DAC4    FD E5          C      	push	iy
  DAC6    FD 2A DE88     C      	ld	iy,(dbdma)
  DACA    FD 7E 0E       C      	ld	a,(iy+14)	;falls dort Dir, so Byte 14 von Dir =0
  DACD    FE E5          C      	cp	0e5h		;Daten auch leer?
  DACF    FD E1          C      	pop	iy
  DAD1    78             C      	ld	a,b
  DAD2    20 01          C      	jr	nz,seldof	;nein, vorn liegen nichtbelegte Systemspuren
  DAD4    AF             C      seldo0:	xor	a		;sonst ohne Systemspuren
  DAD5    DD 77 0D       C      seldof:	ld	(ix+dpbofs),a
  DAD8    B7             C      	or	a		;0 Systemspuren?
  DAD9    28 07          C      	jr	z,selddr	;ja
  DADB    79             C      	ld	a,c		;Anzahl Dir-Eintraege -1
  DADC    FE BF          C      	cp	192-1		;>=192 Dir-Eintraege ?
  DADE    38 02          C      	jr	c,selddr	;nein
  DAE0    0E 7F          C      	ld	c,128-1		;780k hat 128 Dir-Eintraege
  DAE2    DD 71 07       C      selddr:	ld	(ix+dpbdir),c
  DAE5    23             C      	inc	hl
  DAE6    4E             C      	ld	c,(hl)		;Abstand der Blockgroessentab.
  DAE7    06 00          C      	ld	b,0
  DAE9    09             C      	add	hl,bc		;auf Blockgroessentabelle
  DAEA    4E             C      	ld	c,(hl)
  DAEB    DD 71 02       C      	ld	(ix+dpbbls),c
  DAEE    23             C      	inc	hl
  DAEF    4E             C      	ld	c,(hl)
  DAF0    DD 71 03       C      	ld	(ix+dpbblm),c
  DAF3    23             C      	inc	hl
  DAF4    4E             C      	ld	c,(hl)
  DAF5    DD 71 04       C      	ld	(ix+dpbexm),c
                         C      
                         C      ; Bestimmen Zahl der abweichenden 128er-Sektoren ab Spur 0
                         C      
  DAF8    AF             C      	xor	a
  DAF9    32 DE7C        C      	ld	(dfrmtr),a	;ab Spur 0
                         C      		;(gleichz. Spurkorr. bei falschen Doppelstepimpulsen)
  DAFC    CD DCFC        C      sf128z:	call	dsidtr		;beliebigen SektId lesen
  DAFF    20 18          C      	jr	nz,sf128e	;Fehler
  DB01    7C             C      	ld	a,h		;Sektorlaenge
  DB02    DD BE 10       C      	cp	(ix+dpbslc)	;gleich Disketten-Rest?
  DB05    28 12          C      	jr	z,sf128e	;ja
  DB07    DD 7E 0F       C      	ld	a,(ix+dpbflg)
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-53


  DB0A    E6 03          C      	and	dpbfsm		;bisherige Anzahl abweichender Spuren
  DB0C    FE 03          C      	cp	dpbfsm		;Zaehler voll?
  DB0E    28 09          C      	jr	z,sf128e	;ja
  DB10    DD 34 0F       C      	inc	(ix+dpbflg)	;erhoehen abweich. Spurzahl
  DB13    21 DE7C        C      	ld	hl,dfrmtr	;naechste (logische!) Spur
  DB16    34             C      	inc	(hl)
  DB17    18 E3          C      	jr	sf128z
  DB19                   C      sf128e:
                         C      
                         C      ; Setzen Anzahl der logischen 128er Rekords im Puffer -1
                         C      ; Es wird immer das Maximum gesetzt, dies setzt eine dichte
                         C      ; Sektorfolge beim Transfer voraus! (so in dpbstr)
                         C      
                         C      	IF	dbufsz gt 7
  DB19    DD 36 11 07    C      	ld	(ix+dpbbfm),+(1 shl (dbufsz-7))-1
                         C      	ENDIF
                         C      
                         C      ; Berechnen Speicherkapazitaet-1 in BDOS-Bloecken aus
                         C      ; ((Tracks-dpbofs)*dpbspt/(2**dpbbls))-1
  DB1D    DD 6E 14       C      	ld	l,(ix+dpbtrk)
  DB20    AF             C      	xor	a
  DB21    67             C      	ld	h,a		;hl:=log. Spurzahl
  DB22    DD 5E 0D       C      	ld	e,(ix+dpbofs)
  DB25    57             C      	ld	d,a		;de:=log. offset-Spurzahl
  DB26    ED 52          C      	sbc	hl,de
  DB28    EB             C      	ex	de,hl		;de:=log. Daten-Spurzahl
  DB29    6F             C      	ld	l,a		;hl:=0
  DB2A    DD 46 00       C      	ld	b,(ix+dpbspt)
  DB2D    19             C      dsizmz:	add	hl,de
  DB2E    10 FD          C      	djnz	dsizmz		;hl:=(tracks-dpbofs)*dpbspt
  DB30    DD 46 02       C      dsizme:	ld	b,(ix+dpbbls)
  DB33    CB 3C          C      dsizdz:	srl	h
  DB35    CB 1D          C      	rr	l
  DB37    10 FA          C      	djnz	dsizdz
  DB39    2B             C      	dec	hl
  DB3A    DD 75 05       C      	ld	(ix+dpbsiz),l
  DB3D    DD 74 06       C      	ld	(ix+dpbsiz+1),h
  DB40    DD 7E 07       C      	ld	a,(ix+dpbdir)	;Dir-Groesse
  DB43    3C             C      	inc	a
  DB44    0F             C      	rrca
  DB45    0F             C      	rrca			;div 4, da 4 Dir-Eintr. /Sekt.
  DB46    DD 77 0B       C      	ld	(ix+dpbchk),a	;ist Sektorzahl = Check size
  DB49    DD 46 02       C      	ld	b,(ix+dpbbls)	;block shift
  DB4C    0F             C      seldla:	rrca			;BDOS-Bloecke fuer Dir.
  DB4D    10 FD          C      	djnz	seldla
  DB4F    47             C      	ld	b,a
  DB50    AF             C      	xor	a
  DB51    37             C      seldal:	scf			;Allocation-Bits fuer Dir.
  DB52    1F             C      	rra
  DB53    10 FC          C      	djnz	seldal
  DB55    DD 77 09       C      	ld	(ix+dpbalc),a
                         C      ;+++++++++++Ende automatische Formaterkennung+++++++++++++
                         C      	ENDIF	;format
                         C      
  DB58                   C      selext:
                         C       IF cpastz
                         C       ENDIF
                         C      
  DB58    E1             C      selexx:	pop	hl		;hl auf DPH
  DB59    C9             C      	ret			;Return Seldsk
                         C      
                         C       IF cpastz
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-54


                         C       ENDIF
                         C      
                         C      
                         C      ; auf Spur 0 zurueck (vor jedem Dir-Zugriff)
                         C      ;===================
  DB5A                   C      home:
                         C      	IF	dbufsz gt 7
  DB5A    21 DE81        C      	ld	hl,dbflg
  DB5D    CB 56          C      	bit	dfbwr,(hl)	;veraenderter Puffer?
  DB5F    20 05          C      	jr	nz,home1	;ja, nicht freigeben
  DB61    3E FF          C      	ld	a,0ffh		;sonst Diskwechsel erlauben
  DB63    32 DE82        C      	ld	(dbdev),a	;Puffer ist nicht aktiv
                         C      	ENDIF
  DB66    0E 00          C      home1:	ld	c,0
                         C      ;-----------------------
                         C      
                         C      ; Einstellen Spur in Reg. BC
                         C      ;================
  DB68                   C      settrk:
                         C       if ramfl
                         C       endif
  DB68    79             C      	ld	a,c
  DB69    32 DE8C        C      	ld	(dtrack),a	;Spur merken
  DB6C    C9             C      	ret
                         C      ;-----------------------
                         C      
                         C      ; Einstellen Sektor in Reg. C
                         C      ;==================
  DB6D    79             C      setsec:	LD	A,C
  DB6E    32 DE8E        C      	LD	(dsectr),A
  DB71    C9             C      	RET
                         C      ;-----------------------
                         C      
                         C      ; Einstellen DMA in Reg. BC
                         C      ;===============
  DB72    ED 43 DE91     C      setdma:	LD	(ddma),BC
  DB76    C9             C      	RET
                         C      ;-----------------------
                         C      
                         C      ; Uebersetzung Sektornummer 
                         C      ;==========================
                         C      ; Translate-Tab-Adr. in DE, Eingangs-Sektornummer in BC,
                         C      ;			    Ausgangs-Sektornummer in HL
                         C      ; Es wird keine Translate-Tabelle benutzt, da die Sektor-
                         C      ; nummernverwaltung verallgemeinert im nicht-Standard-DPB 
                         C      ; enthalten ist (auch fuer physische Sektorlaenge <>128)
                         C      
  DB77                   C      sectran:
  DB77    60             C      	LD	H,B
  DB78    69             C      	LD	L,C
  DB79    23             C      	inc	hl		;Sektoren zaehlen in CP/A ab 1
  DB7A    C9             C      	RET
                         C      ;-----------------------
                         C      
                         C      	IF	@write
                         C      
                         C      ; Schreiben Sektor
                         C      ;=================
                         C      ; Register C (vom BDOS gestellt):
                         C      ;	=0, wenn normales write
                         C      ;	=1, wenn directory-write (sofort ausgeben)
                         C      ;	=2, wenn Beginn eines neuen Datenblocks (kein preread)
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-55


                         C      
  DB7B                   C      write:
  DB7B    59             C      	ld	e,c		;retten Reg. C
  DB7C    3A DE8B        C      	ld	a,(ddrive)
  DB7F    4F             C      	ld	c,a
  DB80    CD E96E        C      	call	dgetpb		;ix:=dpb(ddrive)
  DB83    28 57          C      	jr	z,drwerr	;Geraet ex. nicht
                         C       if ramfl
                         C       endif
  DB85    21 DE8A        C      	ld	hl,dflg
  DB88    CB D6          C      	set	dfwr,(hl)	;Write-Flag setzen
                         C      
                         C      	IF	dbufsz gt 7	;gepufferte Disk E/A
  DB8A    21 DE81        C      	ld	hl,dbflg
  DB8D    CB C6          C      	set	dfbprr,(hl)	;Annahme preread notwendig
  DB8F    7B             C      	ld	a,e		;A:= Write-Typ
  DB90    32 DE98        C      	ld	(dwrtyp),a	;merken Write-Typ
  DB93    FE 02          C      	cp	2		;write to unallocated?
  DB95    20 17          C      	jr	nz,chkuna	;nein
  DB97    DD 7E 03       C      	ld	a,(ix+dpbblm)	;Zahl der 128-Sekt. im Block -1
  DB9A    3C             C      	inc	a
  DB9B    32 DE93        C      	ld	(unacnt),a	;fuer diese Sekt. kein preread
  DB9E    21 DE94        C      	ld	hl,unadev
  DBA1    71             C      	ld	(hl),c
  DBA2    3A DE8C        C      	ld	a,(dtrack)
  DBA5    32 DE95        C      	ld	(unatrk),a
  DBA8    3A DE8E        C      	ld	a,(dsectr)
  DBAB    32 DE96        C      	ld	(unasec),a
  DBAE    21 DE93        C      chkuna:	ld	hl,unacnt
  DBB1    7E             C      	ld	a,(hl)
  DBB2    B7             C      	or	a		;noch nicht geschr. Sekt. da?
  DBB3    28 42          C      	jr	z,alloc		;nein
  DBB5    3D             C      	dec	a		;sonst Restzahl -1
  DBB6    77             C      	ld	(hl),a
  DBB7    23             C      	inc	hl
  DBB8    79             C      	ld	a,c
  DBB9    BE             C      	cp	(hl)		;gleiches Geraet?
  DBBA    20 3B          C      	jr	nz,alloc	;nein
  DBBC    23             C      	inc	hl
  DBBD    3A DE8C        C      	ld	a,(dtrack)
  DBC0    BE             C      	cp	(hl)		;gleiche Spur?
  DBC1    20 34          C      	jr	nz,alloc	;nein
  DBC3    23             C      	inc	hl
  DBC4    3A DE8E        C      	ld	a,(dsectr)
  DBC7    BE             C      	cp	(hl)		;gleicher Sektor?
  DBC8    20 2D          C      	jr	nz,alloc	;nein
                         C      ; Vorbereiten naechsten unalloc write-Aufruf
  DBCA    DD BE 00       C      	cp	(ix+dpbspt)	;neue Spur?
  DBCD    38 04          C      	jr	c,unatr1	;nein
  DBCF    2B             C      	dec	hl
  DBD0    34             C      	inc	(hl)		;unatrk +1
  DBD1    23             C      	inc	hl
  DBD2    AF             C      	xor	a		;Sektor auf Spuranfang
  DBD3    3C             C      unatr1:	inc	a		;naechster Sektor
  DBD4    77             C      	ld	(hl),a
  DBD5    21 DE81        C      	ld	hl,dbflg
  DBD8    CB 86          C      	res	dfbprr,(hl)	;anzeigen kein preread notw.
                         C      	ENDIF
  DBDA    18 1F          C      	jr	drw
                         C      
                         C      	ENDIF	;@write
                         C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-56


                         C      ; Abbruch read/write mit E/A-Fehler
  DBDC    3E 01          C      drwerr:	ld	a,1
  DBDE    C9             C      	ret
                         C      
                         C      ; Lesen Sektor
                         C      ;=============
                         C      
  DBDF                   C      read:
  DBDF    3A DE8B        C      	ld	a,(ddrive)
  DBE2    4F             C      	ld	c,a
  DBE3    CD E96E        C      	call	dgetpb		;ix:=dpb(ddrive)
  DBE6    28 F4          C      	jr	z,drwerr	;Geraet ex. nicht
                         C       if ramfl
                         C       endif
  DBE8    21 DE8A        C      	ld	hl,dflg
  DBEB    CB 96          C      	res	dfwr,(hl)	;Lesen anzeigen
                         C      
                         C       IF dbufsz gt 7
  DBED    21 DE81        C      	ld	hl,dbflg
  DBF0    CB C6          C      	set	dfbprr,(hl)	;preread notwendig
  DBF2    3E 02          C      	ld	a,2
  DBF4    32 DE98        C      	ld	(dwrtyp),a
                         C      
  DBF7                   C      alloc:
                         C        IF @write
  DBF7    AF             C      	xor	a
  DBF8    32 DE93        C      	ld	(unacnt),a	;Ende unalloc
                         C        ENDIF
                         C      
                         C       ENDIF
                         C      
                         C      ; gemeinsamer Zweig read/write Floppy
                         C      ;------------------------------------
                         C      
  DBFB    3A DE8E        C      drw:	ld	a,(dsectr)	;Sektornummer in 1..dpbspt ?
  DBFE    3D             C      	dec	a		;ab 0 zaehlen
  DBFF    FA DBDC        C      	jp	m,drwerr	;<0, Fehler
  DC02    DD BE 00       C      	cp	(ix+dpbspt)	;<dpbspt?
  DC05    30 D5          C      	jr	nc,drwerr	;nein, Fehler
                         C       IF dbufsz gt 7
  DC07    47             C      	ld	b,a		;retten dsectr-1
                         C       ENDIF
  DC08    DD 7E 0F       C      	ld	a,(ix+dpbflg)
  DC0B    E6 03          C      	and	dpbfsm		;Anzahl der abweich. 128er Spuren
  DC0D    57             C      	ld	d,a
  DC0E    3A DE8C        C      	ld	a,(dtrack)	;verlangte Spur
  DC11    BA             C      	cp	d		;im abweichenden Spurformat?
  DC12    DA DD01        C      	jp	c,drwsec	;ja, Sektorlaenge 128
                         C      
                         C       IF dbufsz gt 7	;gepufferte Disk E/A
                         C       IF dbufsz lt 12 ;<2**12 =4K Puffer
  DC15    DD 7E 10       C      	ld	a,(ix+dpbslc)	;phys. Sektorlaenge 128?
  DC18    B7             C      	or	a		;d.h. mit Sektorversatz?
  DC19    CA DD01        C      	jp	z,drwsec	;ja, keine Pufferung sinnvoll
                         C       ENDIF
  DC1C    78             C      	ld	a,b
  DC1D    DD 56 11       C      	ld	d,(ix+dpbbfm)	;Puffermaske
  DC20    A2             C      	and	d		;rel. Sekt.nr. des BDOS-Blocks zum Puff.anf.
  DC21    F5             C      	push	af		;merken fuer move
  DC22    A8             C      	xor	b		;a ist Sektornr. des Puff.anf.
  DC23    CB 3F          C      drwbnr:	srl	a		;ermitteln Puffernr in Spur
  DC25    CB 1A          C      	rr	d		;noch Bits in Puffermaske?
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-57


  DC27    20 FA          C      	jr	nz,drwbnr	;ja
                         C      ; Test, ob dieser Puffer da ist
  DC29    F5             C      	push	af		;merken Puffernummer
  DC2A    21 DE97        C      	ld	hl,dbnb
  DC2D    BE             C      	cp	(hl)		;richtige Puffernummer?
  DC2E    20 0F          C      	jr	nz,dbn		;nein
  DC30    21 DE83        C      	ld	hl,dbtrk
  DC33    3A DE8C        C      	ld	a,(dtrack)	;geforderte Spur
  DC36    BE             C      	cp	(hl)		;richtige Spur?
  DC37    20 06          C      	jr	nz,dbn
  DC39    3A DE82        C      	ld	a,(dbdev)	;zum Puffer gehoeriges Geraet
  DC3C    B9             C      	cp	c		;richtiges Geraet?
  DC3D    28 6C          C      	jr	z,dbmat		;ja, Sektor steht im Puffer
                         C      
  DC3F    C5             C      dbn:	push	bc		;retten ddrive
  DC40    CD DCE4        C      	call	dbtrw		;veraenderten Puffer ausgeben
  DC43    C1             C      	pop	bc		;c:=ddrive
  DC44    21 DE82        C      	ld	hl,dbdev
  DC47    71             C      	ld	(hl),c
  DC48    3A DE8C        C      	ld	a,(dtrack)
  DC4B    32 DE83        C      	ld	(dbtrk),a
  DC4E    CD E96E        C      	call	dgetpb		;ix:=dpb(c)
  DC51    DD 46 10       C      	ld	b,(ix+dpbslc)
  DC54    21 DE86        C      	ld	hl,dbslc
  DC57    70             C      	ld	(hl),b
  DC58    DD 7E 11       C      	ld	a,(ix+dpbbfm)	;Zahl der 128er Sektoren -1
  DC5B    3C             C      	inc	a
  DC5C    87             C      	add	a,a		;CY:=0
  DC5D    04             C      	inc	b		;fuer djnz, falls dpbslc=0
  DC5E    0F             C      dbsnbz:	rrca			;Zahl der phys. Sekt. im Puff.
  DC5F    10 FD          C      	djnz	dbsnbz
  DC61    57             C      	ld	d,a		;merken
  DC62    AF             C      	xor	a
  DC63    C1             C      	pop	bc		;b:=geforderte Puffernr.
  DC64    C5             C      	push	bc
  DC65    21 DE97        C      	ld	hl,dbnb
  DC68    70             C      	ld	(hl),b
  DC69    04             C      	inc	b
  DC6A    05             C      	dec	b		;Puffernr. 0?
  DC6B    28 03          C      	jr	z,dbsec0	;ja
  DC6D    82             C      dbsecz:	add	a,d		;0. phys. Sekt. im Puffer
  DC6E    10 FD          C      	djnz	dbsecz		;=dbsnb.*Puffernr.
  DC70    5F             C      dbsec0:	ld	e,a		;merken Pufferanf.-Sektor
  DC71    DD 46 10       C      	ld	b,(ix+dpbslc)
  DC74    DD 7E 00       C      	ld	a,(ix+dpbspt)
  DC77    04             C      	inc	b		;wegen djnz
  DC78    87             C      	add	a,a
  DC79    CB 3F          C      dbsecm:	srl	a		;phys. Sektoranzahl
  DC7B    10 FC          C      	djnz	dbsecm
  DC7D    93             C      	sub	e		;Restsektorzahl auf Spur
  DC7E    BA             C      	cp	d		;>= Zahl zu transferierender?
  DC7F    30 01          C      	jr	nc,dbseco	;ja
  DC81    57             C      	ld	d,a		;sonst nur Restsektorzahl
  DC82    1C             C      dbseco:	inc	e		;Sektoren zaehlen ab 1
  DC83    7B             C      	ld	a,e
  DC84    32 DE85        C      	ld	(dbsec),a	;Sektor
  DC87    7A             C      	ld	a,d
  DC88    32 DE87        C      	ld	(dbsnb),a	;Sektorzahl
  DC8B    21 DE81        C      	ld	hl,dbflg
  DC8E    CB 96          C      	res	dfbwr,(hl)
                         C       if @write
  DC90    CB 46          C      	bit	dfbprr,(hl)	;muss neuer Puffer gel. werden?
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-58


  DC92    20 14          C      	jr	nz,dbprr	;ja
                         C      ; nur dann kein preread, wenn Rest BDOS-Block >= phys. Puff.
                         C      ; und Rest BDOS-Block auf Pufferanfang beginnt
  DC94    3A DE93        C      	ld	a,(unacnt)
  DC97    DD BE 11       C      	cp	(ix+dpbbfm)	;Restzahl-1 >= Puffergr.-1 ?
  DC9A    38 0C          C      	jr	c,dbprr		;nein, preread
  DC9C    3A DE8E        C      	ld	a,(dsectr)	;Sektornr.
  DC9F    3D             C      	dec	a		;ab 0 zaehlen
  DCA0    DD A6 11       C      	and	(ix+dpbbfm)	;rel. Sekt.nr. des
                         C      ;				BDOS-Blocks zum Pufferanfang
  DCA3    20 03          C      	jr	nz,dbprr
  DCA5    32 DE99        C      	ld	(dberrf),a	;fehlerfrei gel. anzeigen
  DCA8    C4 DCEA        C      dbprr:	call	nz,dbtran	;Puffer lesen
                         C       endif
  DCAB                   C      dbmat:	
                         C      
                         C      ; Sektor in/aus Puffer holen
                         C      ;===========================
  DCAB    F1             C      	pop	af		;Puffernr. in Spur wegschm.
  DCAC    F1             C      	pop	af		;128-er Index im Puffer
  DCAD    F5             C      	push	af
  DCAE    1F             C      	rra			;Sektornb*128 berechnen
  DCAF    47             C      	ld	b,a
  DCB0    0E 00          C      	ld	c,0
  DCB2    CB 19          C      	rr	c
  DCB4    21 F34A        C      	ld	hl,dbuf
  DCB7    09             C      	add	hl,bc		;Adresse im Puffer
  DCB8    ED 5B DE91     C      	ld	de,(ddma)	;Nutzer-DMA
  DCBC    3A DE8A        C      	ld	a,(dflg)
  DCBF    CB 57          C      	bit	dfwr,a		;Schreiben?
  DCC1    28 09          C      	jr	z,dsmove	;nein
  DCC3    3A DE81        C      	ld	a,(dbflg)
  DCC6    CB D7          C      	set	dfbwr,a		;anzeigen Puffer beschrieben
  DCC8    32 DE81        C      	ld	(dbflg),a
  DCCB    EB             C      	ex	de,hl
  DCCC    01 0080        C      dsmove:	ld	bc,128
  DCCF    CD DE9A        C      	call	flldir
  DCD2    F1             C      	pop	af		;128-Index im Puffer
  DCD3    DD BE 11       C      	cp	(ix+dpbbfm)	;letzter Sektor im Puffer
  DCD6    28 05          C      	jr	z,dmovew	;ja, Puffer ausgeben
  DCD8    3A DE98        C      	ld	a,(dwrtyp)
  DCDB    FE 01          C      	cp	1		;write to directory?
  DCDD    CC DCE4        C      dmovew:	call	z,dbtrw		;ja, veraend. Puffer ausgeben
  DCE0    3A DE99        C      	ld	a,(dberrf)	;Ergebnis letztes dbtran
  DCE3    C9             C      	ret
                         C      
                         C      ; Schreiben Puffer, wenn notw.
                         C      ;=============================
  DCE4    21 DE81        C      dbtrw:	ld	hl,dbflg
  DCE7    CB 56          C      	bit	dfbwr,(hl)	;Puffer veraendert?
  DCE9    C8             C      	ret	z		;nein, Schreiben unterdruecken
                         C      	ENDIF	;dbufsz gt 7
                         C      
                         C      	IF	format or (dbufsz gt 7)
                         C      ; gemeinsamer Zweig Lesen/Schreiben Puffer
                         C      ;=========================================
  DCEA                   C      dbtran:	
  DCEA    21 DE81        C      	ld	hl,dbcdb
                         C      	IF	dbufsz gt 7
  DCED    CD DD04        C      	call	dsktra
  DCF0    32 DE99        C      	ld	(dberrf),a	;Fehlerflag stellen
  DCF3    21 DE81        C      	ld	hl,dbflg
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-59


  DCF6    CB 96          C      	res	dfbwr,(hl)	;Puffer ist nicht beschrieben
  DCF8    C9             C      	ret
                         C      	ENDIF
                         C      
                         C      	ENDIF
                         C      
                         C      	IF	format
                         C      ; Lesen beliebigen Sektor-Id.
                         C      ;===========================
  DCF9    32 DE7C        C      dsidtt:	ld	(dfrmtr),a	;Eingang fuer Spur in A
  DCFC                   C      dsidtr:
  DCFC    21 DE7A        C      	ld	hl,dfrcdb
                         C       IF dsk8mf
                         C       ENDIF
  DCFF    18 03          C      	jr	dsktra		;belieb. SektId lesen
                         C      	ENDIF
                         C      
                         C      
                         C      ; gemeinsamer Zweig Read/Write 128-Sektor einzeln
                         C      ;================================================
  DD01                   C      drwsec:
  DD01    21 DE8A        C      	ld	hl,dflg
                         C      
                         C      ; interner Aufruf phys. Diskettentransfer
                         C      ;----------------------------------------
                         C      ; i HL auf CDB
  DD04                   C      dsktra:
                         C      
                         C      ;*********************************************************
                         C      ; Umkleidung des physischer Disketten-Transfers
                         C      ;*********************************************************
                         C      
                         C      ; Parameter: HL auf CDB mit folgender Struktur:
                         C      ; +0: cdbfl	;Flags	(Struktur angepasst an ft.kom)
  0000                   C      diof00	equ	0	;** frei fuer Anw. ** (frueher Verify nach Schreiben)
  0001                   C      diofid	equ	1	;fest	;=1, wenn nur Sektid. zu lesen
  0002                   C      diofwr	equ	2	;fest	;=1, wenn Schreiben
  0003                   C      dioffm	equ	3	;fest	;=1, wenn temporaer FM-Format erzwungen
  0004                   C      dioftr	equ	4		;=1, wenn keine Fehlermeldung (und -behandlg)
  0005                   C      diofhd	equ	5		;=1, wenn Kopf hochnehmen ("headup")
  0006                   C      diofps	equ	6		;=1, wenn trk,sid,sec schon physisch
  0007                   C      diofs1	equ	7	;fest	;=1, wenn Rueckseite
                         C      
                         C      ; ab hier unwichtig bei "diofhd" in cdbfl =1 (headup)
                         C      ; +1: cdbdev	;logisches Geraet 0 .. dphnb-1
                         C      ; +2: cdbtrk	;log./phys. Spur
                         C      ; +3: cdbsid	;bel./phys. Seite
                         C      ; +4: cdbsec	;log./phys. Sektor
                         C      ; +5: cdbslc	;Sektorlaengencode (0=128, 1=256, 2=512, 3=1024)
                         C      ; +6: cdbsnb	;Anz. zu uebertr. ph. Sekt. (wenn =0, so nur position.)
                         C      ; ab hier nur wichtig, wenn "diofid" in cdbfl =0:
                         C      ; +7,8: cdbdma	;Transferadresse
                         C      
                         C      ; Return, falls nicht "diofhd" in cdbfl =1:
                         C      ;	A=0 (ret z) bei fehlerfrei, sonst A=1 (ret nz) bei cdbfl, "dioftr" =0
                         C      ;	oder Returncode phys. Transfer
                         C      ;	E:=trk, D:=sid ,L:=sec, H:=len
                         C      ;	BC,IX unveraendert
                         C      
  DD04                   C      diskio:	;Aufruf ueber Sprungvektor von BIOS-Erweiterung
  DD04    C5             C      	push	bc
  DD05    11 DE9D        C      	ld	de,diocdb	;CDB des Nutzers auf internen Hilfsspeicher
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-60


  DD08    01 0009        C      	ld	bc,diocdl	;da modifiziert
  DD0B    D5             C       	push	de
  DD0C    CD DE9A        C      	call	flldir		;falls Original im ROM-Adressbereich
  DD0F    E1             C      	pop	hl		;hl auf diocdb
  DD10    C1             C      	pop	bc
                         C      
  DD11    CB 6E          C      	bit	diofhd,(hl)	;Kopf hochnehmen?
  DD13    C2 E158        C      	jp	nz,headup	;ja, kein Transfer
                         C      
  DD16    C5             C      	push	bc
  DD17    DD E5          C      	push	ix
  DD19    E5             C      	push	hl
  DD1A    23             C       	inc	hl
  DD1B    4E             C      	ld	c,(hl)		;logisches Laufwerk
  DD1C    CD E96E        C      	call	dgetpb		;IX auf DPB stellen
  DD1F    E1             C      	pop	hl		;wiederherstellen hl
  DD20    3E 44          C      	ld	a,'D'		;falls LW nicht ex.
  DD22    CA DDD9        C      	jp	z,dioert	;LW ex. nicht
                         C      
  DD25    CB 76          C      	bit	diofps,(hl)	;trk,sid,sec schon physisch?
  DD27    20 5A          C      	jr	nz,diophy	;ja
                         C      ; Track, Side und Sector entpsr. Diskettenformat setzen
                         C       IF dsk8mf
                         C       ENDIF
  DD29    23             C      	inc	hl
  DD2A    23             C      	inc	hl
  DD2B    56             C      	ld	d,(hl)		;Track
  DD2C    5A             C      	ld	e,d		;merken
  DD2D    23             C      	inc	hl
  DD2E    23             C      	inc	hl
  DD2F    4E             C      	ld	c,(hl)		;Sektornummer ab 1
  DD30    0D             C      	dec	c		;Sektornr. ab 0
  DD31    DD CB 0F 66    C      	bit	dpbf86,(ix+dpbflg)	;Fortsetzung Dsk. auf Ruecks.?
  DD35    20 0C          C      	jr	nz,diots2	;ja
  DD37    DD CB 0F 6E    C      	bit	dpbfds,(ix+dpbflg)	;ungerade Spuren auf Rueckseite?
  DD3B    28 29          C      	jr	z,diotrs	;nein, einseitig
  DD3D    CB 3A          C      	srl	d		;Spur halbieren
  DD3F    30 25          C      	jr	nc,diotrs	;gerade Spur, Vorderseite
  DD41    18 12          C      	jr	diots1		;auf Rueckseite
  DD43    DD 46 14       C      diots2:	ld	b,(ix+dpbtrk)	;log. Spurzahl
  DD46    CB 38          C      	srl	b		;Spuren auf Vorderseite
  DD48    7A             C      	ld	a,d
  DD49    90             C      	sub	b		;Spur auf Vorderseite?
  DD4A    38 1A          C      	jr	c,diotrs	;ja, Spur in d unveraendert lassen
                         C      				;40 ->  0; 41 ->  1; ...; 79 ->  39
                         C      				;77 ->  0; 78 ->  1; ...;153 ->  76
  DD4C    DD CB 0F 5E    C      	bit	dpbfsv,(ix+dpbflg)	;Ruecks. von aussen nach innen?
  DD50    20 02          C      	jr	nz,diots4	;ja
  DD52    2F             C      	cpl			;40 -> -1; 41 -> -2; ...; 79 -> -40
                         C      				;77 -> -1; 78 -> -2; ...;153 -> -77
  DD53    80             C      	add	a,b		;40 -> 39; 41 -> 38; ...; 79 ->   0
                         C      				;77 -> 76; 78 -> 75; ...;153 ->   0
  DD54    57             C      diots4:	ld	d,a
  DD55    3A DE9D        C      diots1:	ld	a,(diocfl)
  DD58    CB FF          C      	set	diofs1,a	;vermerken Rueckseite
  DD5A    32 DE9D        C      	ld	(diocfl),a
  DD5D    DD 7E 13       C      	ld	a,(ix+dpbsn0)	;Versch. der Sektornr. auf Rueckseite
  DD60    81             C      	add	a,c		;Sektornr. evtl. weiterzaehlen
                         C      ;;;	cp	c		;Weiternummerierung auf Rueckseite?
  DD61    4F             C      	ld	c,a
                         C      ;;;	jr	nz,diotrs	;ja, dann side:=0
  DD62    3E 01          C      	ld	a,1		;side:=1
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-61


  DD64    18 01          C      	jr	diotss
  DD66    AF             C      diotrs:	xor	a		;side:=0
  DD67    32 DEA0        C      diotss:	ld	(diocsi),a	;phys. Seite setzen
  DD6A    7A             C      	ld	a,d
  DD6B    32 DE9F        C      	ld	(dioctr),a	;phys. Spur setzen
                         C      
  DD6E    7B             C      	ld	a,e		;log. Spurnr. zurueck nach A
  DD6F    DD E5          C      	push	ix
  DD71    E1             C      	pop	hl
  DD72    11 0019        C      	ld	de,dpbstr	;d:=0
  DD75    19             C      	add	hl,de
  DD76    DD BE 0D       C      	cp	(ix+dpbofs)	;Systemspur?
  DD79    38 03          C      	jr	c,diossp	;ja, Sektornummern nicht logisch
  DD7B    59             C      	ld	e,c
  DD7C    19             C      	add	hl,de		;HL entspr. Index in dpbstr
  DD7D    4A             C      	ld	c,d		;c:=0
  DD7E    79             C      diossp:	ld	a,c		;phys. Sektornr. ab 0
  DD7F    86             C      	add	a,(hl)		;+echte Sektornr.
  DD80    32 DEA1        C      	ld	(diocse),a	;phys. Sektor setzen
  DD83                   C      diophy:
                         C      
                         C      ; i ret, BC, IX im Stack
                         C      ; i cdb auf diocdb
                         C      ; i IX auf DPB
                         C      
  DD83                   C      diorty:	;interne Wiederholung diskio
  DD83    DD E5          C      	push	ix		;retten IX fuer evtl. Wiederholung
  DD85    21 DE9D        C      	ld	hl,diocdb
  DD88    E5             C      	push	hl
  DD89    7E             C      	ld	a,(hl)		;side 0/1, -/FM, read/write, -/sectid l.
  DD8A    E6 8E          C       and (1 shl diofs1)+(1 shl dioffm)+(1 shl diofwr)+(1 shl diofid)
  DD8C    47             C      	ld	b,a
  DD8D    DD 7E 18       C      	ld	a,(ix+dpbtyp)	;5"/8", FM/MFM, 40/80, Verify nach Schreiben
  DD90    E6 78          C       and (1 shl dpbt80)+(1 shl dpbt5z)+(1 shl dpbtdd)+(1 shl dpbtwv) ;aus DPB
  DD92    A8             C      	xor	b
                         C       IF dsk8mf
                         C       ENDIF
  DD93    CB 66          C      	bit	dioftr,(hl)	;Fehlerbehandlung unterdruecken?
  DD95    28 01          C      	jr	z,dionft	;nein
  DD97    3C             C      	inc	a
  DD98                   C      dionft:
  DD98    32 E177        C      	ld	(ft.kom),a	
                         C      
  DD9B    23             C      	inc	hl
  DD9C    DD 7E 15       C      	ld	a,(ix+dpbdnr)	;physische LW-Nr.
  DD9F    32 E17A        C      	ld	(ft.lwn),a
                         C      
  DDA2    23             C      	inc	hl
  DDA3    7E             C      	ld	a,(hl)
  DDA4    32 E17B        C      	ld	(ft.trk),a
  DDA7    23             C      	inc	hl
  DDA8    7E             C      	ld	a,(hl)
  DDA9    32 E17C        C      	ld	(ft.sid),a
  DDAC    23             C      	inc	hl
  DDAD    7E             C      	ld	a,(hl)
  DDAE    32 E17D        C      	ld	(ft.sec),a
  DDB1    23             C      	inc	hl
  DDB2    7E             C      	ld	a,(hl)
  DDB3    32 E17E        C      	ld	(ft.len),a
  DDB6    23             C      	inc	hl
  DDB7    7E             C      	ld	a,(hl)
  DDB8    32 E17F        C      	ld	(ft.anz),a
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-62


                         C      
  DDBB    DD 7E 12       C      	ld	a,(ix+dpbstp)	;Anzahl der Stepimpulse
  DDBE    32 E180        C      	ld	(ft.stp),a
                         C      
  DDC1    DD 7E 17       C      	ld	a,(ix+dpbsti)	;Schrittzeit
  DDC4    32 E181        C      	ld	(ft.sti),a
                         C      
  DDC7    2A DEA4        C      	ld	hl,(diocad)
  DDCA    22 E178        C      	ld	(ft.adr),hl
                         C      
                         C       IF stpvar or monitor
  DDCD    CD E7AF        C      	call	delsps		;Sondertasten verbieten
                         C       ENDIF
  DDD0    CD DEA6        C      	call	floppy		;$$$ phys. Transfer $$$
                         C       IF stpvar or monitor
  DDD3    CD E7BC        C      	call	delspr		;Sondertasten wieder erlauben
                         C       ENDIF
                         C      
  DDD6    E1             C      	pop	hl		;HL wieder auf Paramfeld-Adresse
  DDD7    DD E1          C      	pop	ix		;IX wieder auf DPB
                         C      
  DDD9                   C      dioert:
                         C      ; Fehlerprotokoll
  DDD9    CB 66          C      	bit	dioftr,(hl)	;Fehlerprotokoll und -behandlung  unterdr.?
  DDDB    20 0A          C      	jr	nz,dtrok	;ja
  DDDD    B7             C      	or	a		;Returncode
  DDDE    28 07          C      	jr	z,dtrok		; -> fehlerfrei
  DDE0    FE 52          C      	cp	'R'		;not ready?
  DDE2    CA DD83        C      	jp	z,diorty	;ja, Wiederholung
                         C      
                         C       IF errvar
                         C       ENDIF
  DDE5    3E 01          C       	ld	a,1		;return mit Fehler
                         C      
  DDE7    B7             C      dtrok:	or	a		;stellen Z-Flag
  DDE8    ED 5B E17B     C      	ld	de,(ft.trk)	;E:=trk, D:=sid
  DDEC    2A E17D        C      	ld	hl,(ft.sec)	;L:=sec, H:=len
  DDEF    DD E1          C      	pop	ix
  DDF1    C1             C      	pop	bc
  DDF2    C9             C      	ret
                         C      
                         C       IF	format
                         C      
                         C      ; Stellen HL entsprechend Sektorlaengencode in (A)
                         C      ;=================================================
                         C      ; ret nz bei unzulaessigem
  DDF3    B7             C      dtrsla:	or	a
  DDF4    21 DE07        C      	ld	hl,dtrsl0
  DDF7    C8             C      	ret	z		;=0 (128)
  DDF8    3D             C      	dec	a
  DDF9    21 DE1B        C      	ld	hl,dtrsl1	;=1 (256)
  DDFC    C8             C      	ret	z
  DDFD    3D             C      	dec	a
  DDFE    21 DE2F        C      	ld	hl,dtrsl2	;=2 (512)
  DE01    C8             C      	ret	z
  DE02    3D             C      	dec	a
  DE03    21 DE43        C      	ld	hl,dtrsl3	;=3 (1024)
  DE06    C9             C      	ret
                         C      
                         C       ENDIF
                         C      
                         C      ;************************************************
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-63


                         C      ;	Steuertabellen
                         C      ;************************************************
                         C      
                         C      
                         C       IF	format
                         C      ; Modifizierungstabellen entspr. Sektorlaenge und LW-Typ
                         C      ;-------------------------------------------------------
                         C      
                         C      ; Struktur:
                         C      
  0000                   C      dsltrk	equ	0		;benutzte Spuren
  0001                   C      dslspt	equ	dsltrk+1	;Sektoren/Spur
  0002                   C      dsldir	equ	dslspt+1	;Dir-Eintraege
  0003                   C      dsloff	equ	dsldir+1	;2*offset
                         C      				;[+Flag fuer festes offset]
  0001                   C      dslfo	equ	1		;festes offset
  0000                   C      dslvo	equ	0		;offset =0, falls Directory mgl.
  0004                   C      dslblk	equ	dsloff+1	;rel. Adr. Tab. BDOS-Blockgroesse
  0005                   C      dsll	equ	5		;Laenge eines Eintrags
                         C      
                         C      ; Reihenfolge
                         C      ; 5", 40 Tr, SS
                         C      ; 5", 80 Tr, SS
                         C      ; 5", 40 Tr, DS
                         C      ; 5", 80 Tr, DS
                         C       if	disk8
                         C       endif
                         C      
                         C      ; Zur automatischen Bestimmung des Spurformats wird dasjenige
                         C      ; Format der Spur "dlgint" benutzt, alle folgenden Spuren
                         C      ; muessen das gleiche Format haben!
  0003                   C      dlgint	equ	3	;groesste Anzahl SS-Systemspuren
                         C      
                         C      ; 128
  DE07                   C      dtrsl0:	
  DE07    28 1A 3F 04    C      	db	40,26,63,2*2+dslvo,dbl1k-$	;CP/M Standard
  DE0B    4C             C      
  DE0C    50 1A 7F 04    C      	db	80,26,127,2*2+dslvo,dbl2k-$
  DE10    4A             C      
  DE11    50 1A 7F 01    C      	db	80,26,127,2*0+dslfo,dbl2k-$
  DE15    45             C      
  DE16    A0 1A 7F 01    C      	db	160,26,127,2*0+dslfo,dbl2k0-$
  DE1A    43             C      
                         C      
                         C      	if	disk8
                         C      	endif
                         C      
                         C      ; 256
  DE1B                   C      dtrsl1:	
  DE1B    28 20 3F 07    C      	db	40,32,63,2*3+dslfo,dbl2k-$	;SCP Hausformat A51xx
  DE1F    3B             C      
  DE20    50 20 3F 07    C      	db	80,32,63,2*3+dslfo,dbl2k-$	;SCP
  DE24    36             C      
  DE25    50 20 7F 09    C      	db	80,32,127,2*4+dslfo,dbl2k-$
  DE29    31             C      
  DE2A    A0 20 7F 09    C      	db	160,32,127,2*4+dslfo,dbl2k0-$	;SCP Hausformat PC1715
  DE2E    2F             C      
                         C      
                         C      	if	disk8
                         C      	endif
                         C      
                         C      ; 512
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-64


  DE2F                   C      dtrsl2:	
  DE2F    28 24 3F 01    C      	db	40,36,63,2*0+dslfo,dbl1k-$
  DE33    24             C      
  DE34    50 24 7F 01    C      	db	80,36,127,2*0+dslfo,dbl2k-$
  DE38    22             C      
  DE39    50 24 7F 01    C      	db	80,36,127,2*0+dslfo,dbl2k-$
  DE3D    1D             C      
  DE3E    A0 24 7F 01    C      	db	160,36,127,2*0+dslfo,dbl2k0-$
  DE42    1B             C      
                         C      
                         C      	if	disk8
                         C      	endif
                         C      	
                         C      ; 1024
  DE43                   C      dtrsl3:	
  DE43    28 28 3F 04    C      	db	40,40,63,2*2+dslvo,dbl1k-$	;CP/A Standard A51xx
  DE47    10             C      
  DE48    50 28 7F 04    C      	db	80,40,127,2*2+dslvo,dbl2k-$	;CP/A
  DE4C    0E             C      
  DE4D    50 28 7F 00    C      	db	80,40,127,2*0+dslvo,dbl2k-$	;CP/A
  DE51    09             C      
  DE52    A0 28 BF 08    C      	db	160,40,191,2*4+dslvo,dbl2k0-$	;CP/A (und SCP)
  DE56    07             C      
                         C      
                         C      	if	disk8
                         C      	endif
                         C      
                         C      ; Modifizierungstabellen fuer BDOS-Blockgroesse
  DE57    03 07 00       C      dbl1k:	db	3,7,0		;Bl. Shift, Bl. Mask, Ext. Mask
  DE5A    04 0F 01       C      dbl2k:	db	4,0fh,1
  DE5D    04 0F 00       C      dbl2k0:	db	4,0fh,0		;fuer Kapazitaet >255
                         C      
                         C      ; log. Sektortranslate-Tabelle fuer 26*128
  DE60    01 07 0D 13    C      xlt:	db	1,7,13,19,25,5,11,17,23,3,9,15,21
  DE64    19 05 0B 11    C      
  DE68    17 03 09 0F    C      
  DE6C    15             C      
  DE6D    02 08 0E 14    C      	db	2,8,14,20,26,6,12,18,24,4,10,16,22
  DE71    1A 06 0C 12    C      
  DE75    18 04 0A 10    C      
  DE79    16             C      
                         C      
                         C       ENDIF	;format
                         C      
                         C      ;;; if1
                         C      ;;;dskw	MACRO
                         C      ;***************************************************************
                         C      ;	Arbeitsbereiche logischer Floppy-Treiber im System-RAM *
                         C      ;***************************************************************
                         C      
                         C       IF errvar
                         C       ENDIF
                         C      
                         C      ; CDB's
                         C      ;======
                         C      
                         C      	IF	format
                         C      ; CDB fuer Bestimmung Spurformat
                         C      ;------------------------------------
  DE7A                   C      dfrcdb:
  DE7A    12             C      dfrflg:	db	(1 shl diofid)+(1 shl dioftr)
                         C      ;		Lesen Sektorid., kein Fehlerprotokoll
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-65


  DE7B    FF             C      dfrmdv:	db	0ffh		;Geraet
  DE7C    FF             C      dfrmtr:	db	0ffh		;Spur
  DE7D    FF             C      	db	0ffh		;Seite (bel.)
  DE7E    01             C      	db	1		;Sektor (bel.)
  DE7F    00             C      	db	0		;Sektorlaengencode (bel.)
  DE80    01             C      	db	1		;Sektoranzahl (>0)
                         C      	ENDIF
                         C      
                         C      	IF	format or (dbufsz gt 7)
                         C      ; Puffer-CDB
                         C      ;-----------
  DE81                   C      dbcdb:
  DE81    00             C      dbflg:	db	0
  0000                   C      dfbprr	equ	diof00		;=1, wenn Puffer erst gelesen 
                         C      ;				     werden muss
  0002                   C      dfbwr	equ	diofwr		;=1, wenn Puffer durch
                         C      ;				     Schreiben veraendert
  0004                   C      dfbtr	equ	dioftr		;=1, wenn mit Fehlerprotokoll
                         C      ; restliche Bits immer =0
  DE82    FF             C      dbdev:	db	0ffh
  DE83    FF             C      dbtrk:	db	0ffh
  DE84    FF             C      dbsid:	db	0ffh
  DE85    FF             C      dbsec:	db	0ffh
  DE86    FF             C      dbslc:	db	0ffh
  DE87    FF             C      dbsnb:	db	0ffh
                         C      	IF	dbufsz gt 7
  DE88    F34A           C      dbdma:	dw	dbuf
                         C      	ENDIF
                         C      	ENDIF
                         C      
                         C      ; CDB fuer ungepufferte E/A
                         C      ;--------------------------
                         C      
  DE8A                   C      dcdb:
  DE8A    00             C      dflg:	db	0
  0002                   C      dfwr	equ	diofwr 		;=1, wenn write-Aufruf
                         C      ; restliche Bits immer =0
  DE8B    00             C      ddrive:	db	0
  DE8C    FF             C      dtrack:	db	0ffh
  DE8D    FF             C      	db	0ffh		;Seite
  DE8E    FF             C      dsectr:	db	0ffh
  DE8F    00             C      	db	0		;128 Bytes Sektorlaenge
  DE90    01             C      	db	1		;immer nur 1 Sektor
  DE91    FFFF           C      ddma:	dw	0ffffh
                         C      
                         C       if ramfl
                         C       endif
                         C      
                         C      ; Pufferzugriff
                         C       IF @write
                         C       IF dbufsz gt 7
  DE93    00 FF FF 00    C      unacnt:	db	0,0ffh,0ffh,0
  DE94                   C      unadev	equ	unacnt+1
  DE95                   C      unatrk	equ	unacnt+2
  DE96                   C      unasec	equ	unacnt+3
                         C       ENDIF
                         C       ENDIF
                         C       IF dbufsz gt 7
  DE97    FF             C      dbnb:	db	0ffh
  DE98    FF             C      dwrtyp:	db	0ffh
  DE99    00             C      dberrf:	db	0		;Ergebnisflag letztes dbtran
                         C       ENDIF
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-66


                         C      
                         C      ;;;	ENDM
                         C      
                         C      ;;;dskwb	MACRO
                         C      ;***************************************************************
                         C      ;	Arbeitsbereiche logischer Floppy-Treiber im BIOS-RAM   *
                         C      ;***************************************************************
  DE9A    ED B0          C      flldir:	ldir			;Floppy-Puffer <-> Nutzer-DMA
  DE9C    C9             C      	ret
                         C      
                         C      ;;;diocdb	equ	flbsw		;CDB-Hilfsspeicher fuer diskio-Aufruf
  DE9D                   C      diocdb:	ds	9,0ffh
  DE9D                   C      diocfl	equ	diocdb+0
  DE9E                   C      diocde	equ	diocdb+1
  DE9F                   C      dioctr	equ	diocdb+2
  DEA0                   C      diocsi	equ	diocdb+3
  DEA1                   C      diocse	equ	diocdb+4
  DEA2                   C      diocsl	equ	diocdb+5
  DEA3                   C      diocsn	equ	diocdb+6
  DEA4                   C      diocad	equ	diocdb+7
  0009                   C      diocdl	equ	9		;Anzahl der Bytes
                         C      ;;;	ENDM
                         C      ;;; endif	;if1
                         C      
                         C      	include	BIOPDSKT	;Disketten phys. Transfer
                         C      ;*********************************************************
                         C      ; physischer Disketten-Transfer
                         C      ; Version 29.03.88
                         C      ; Aenderungen:
                         C      ; - Es koennen 9 statt bisher 4 phys. Sektoren auf einmal gelesen werden
                         C      ;!-!Schnittstellenaenderung bei SektId lesen:
                         C      ;   ft.anz muss <>0 sein (zuvor beliebig, bei =0 kein Transfer)
                         C      ;   ft.len muss 0..3 sein (zuvor beliebig, bei >3 fehlerhafte Tabellenmodif.)
                         C      ;   ft.kom, Bit 7 eingefuehrt: =0 Vorderseite, =1 Rueckseite
                         C      ;   ft.kom, Bit 0 (Verify nach Schreiben) auf Bit 6 verlegt
                         C      ;   ft.kom, Bit 0 =1 bedeutet "keine Fehlerwiederholung"
                         C      ; - Floppy-Treiber auch fuer Variante K5120/22 generierbar
                         C      ;*********************************************************
                         C      
                         C      ; Typ der Floppy-Karte
                         C      ;=====================
  0000                   C      k5120	equ	0	;K5120/22
  0007                   C      f1715	equ	7	;PC1715
                         C      
  0007                   C      fdc	equ	f1715
                         C      ;fdc	equ	k5120	;K5120/22
                         C      
                         C      ; Aufruf:
                         C      ; -------
                         C      ; Bereitstellung der Parameter auf den Bytes:
                         C      
                         C      ;       ft.kom:	db	0	; bit0 - =1 ohne Fehlerwiederholung
                         C      ;				     1 - =1 lesen ft.len von beliebigem Sektor
                         C      ;				     2 - =0 lesen ; =1 schreiben Sektor(en)
                         C      ;				     3 - =0-FM; =1-MFM   (5"FM nur bei PC1715)
                         C      ;				     4 - =0-8"; =1-5"
                         C      ;				     5 - =0- 40-Spur-Laufwerk; =1- 80-Spur-LW
                         C      ;				     6 - =1 bei verify nach schreiben
                         C      ;				     7 - =0 Vorderseite, =1 Rueckseite
                         C      ;	ft.adr: dw	0	; Transferadresse
                         C      ;	ft.lwn: db	0	; 0..3 phys. Laufwerksnummer
                         C      ;	ft.trk: db	0	; 0..  track
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-67


                         C      ;	ft.sid: db	0	; 0..ff side (side=0 auf Rueckseite moeglich!)
                         C      ;	ft.sec: db	0	; 0..  sector (beliebig bei SektId lesen)
                         C      ;	ft.len: db	0	; 0..3 Sektorlaenge (auch 0..3 bei SektId les.)
                         C      ;	ft.anz: db	0	; 0..9 Anzahl der zu uebertragenden Sektoren
                         C      ;				;      =0: nur Positionieren
                         C      ;				;      (<>0 bei SektId lesen)
                         C      ;       ft.stp: db	0	;      Anzahl der Stepimpulse von Spur zu Spur
                         C      ;	ft.sti: db	0	;      Schrittzeit von Spur zu Spur
                         C      ;				;      in 0,1ms Einheiten
                         C      ;
                         C      ;	call	floppy
                         C      ;       ...			; in A steht Ergebniskode
                         C      ;				; alle Register (auch IX) undef.
                         C      ;
                         C      ; Ergebniskode (in Reg. A):
                         C      ;	00h kein Fehler (Z-Flag nicht von floppy gesetzt)
                         C      ;	'C' CRC-Fehler
                         C      ;	'D' LW nicht existent
                         C      ;	'R' Geraet nicht bereit, aber existent
                         C      ;	'L' unzulaessige Transferlaenge
                         C      ;	'S' Sektor nicht gefunden
                         C      ;	'T' Spurnummer zu gross
                         C      ;	'U' keine Marke gefunden
                         C      ;	'W' Diskette schreibgeschuetzt
                         C      
                         C      ; Paramfeld wird an folgenden Stellen veraendert:
                         C      ;  Komm. "Lesen Sekt,Id.":	ft.trk .. ft.len gestellt
                         C      ;  Komm. "Schreiben mit Verify":ft.kom, bit 2 geloescht
                         C      ;**************************************************
                         C      
  0004                   C      maxlw	equ	4		; Anzahl der Laufwerke (1..4)
                         C      
                         C      ; Adressen der Floppy-Karte
                         C      ;==========================
                         C      
                         C      ;Steuer-PIO
                         C       IF (fdc eq k5120)
                         C       ENDIF
                         C      
                         C       IF (fdc eq f1715)
  0004                   C      flcoad    equ  04h  ;PORT A
  0005                   C      flcoac    equ  05h  
  0006                   C      flcobd    equ  06h  ;PORT B
  0007                   C      flcobc    equ  07h
                         C      
                         C      ;Daten-PIO
  0000                   C      fldaad    equ  00h  ;Port A Schreib-Daten
  0001                   C      fldaac    equ  01h
  0002                   C      fldabd    equ  02h  ;Port B Lese-Daten
  0003                   C      fldabc    equ  03h
                         C      
                         C      ;Select-Latch
  0020                   C      flsel     equ  20h  ;Bit 7..4 /Sel LW3..0;Bit 3..0  /LCK  LW 3..0
  0021                   C      flmot     equ  21h  ;Bit 7..4:/Mot on           
                         C      ;
                         C       ENDIF
                         C      
                         C      ;; Legende AMF:
                         C      ;;   Port A
                         C      ;;  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
                         C      ;;    |   |   |   |   |   |   |   |__ A  /WE  0-Schreiben ein
                         C      ;;    |   |   |   |   |   |   |______ A   MK  lesen  0-MFM-A1 Erkennung
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-68


                         C      ;;    |   |   |   |   |   |                          1-FM-Mark., MFM-C2 Erkenn.
                         C      ;;    |   |   |   |   |   |               schreiben  0-Takt fuer MFM
                         C      ;;    |   |   |   |   |   |                          1-Marken FM und A1 MFM
                         C      ;;    |   |   |   |   |   |__________ A  /SIDE 0-Kopf Seite 1; 1-Kopf Seite 0
                         C      ;;    |   |   |   |   |        oder   A  /FR   0-Fault reset;  1-kein FR
                         C      ;;    |   |   |   |   |______________ A  /STR 0-AMF aktiv
                         C      ;;    |   |   |   |                           1-AMF ausgeschaltet
                         C      ;;    |   |   |   |__________________ A   MK1 lesen  0-Informationen einlesen
                         C      ;;    |   |   |                                      1-nur 1 einlesen
                         C      ;;    |   |   |                           schreiben  0-FM-Daten schreiben
                         C      ;;    |   |   |                                      1-MFM und FM-Marken schr.
                         C      ;;    |   |   |______________________ A   MR, SD     0-steppen Richtung aussen
                         C      ;;    |   |                                          1-Marke-erkannt loeschen
                         C      ;;    |   |                                            steppen Richtung innen
                         C      ;;    |   |__________________________ A  /HL         0-Kopf geladen
                         C      ;;    |                                              1-Kopf entladen
                         C      ;;    |______________________________ A  /ST         0-Stepsignal an LW ein
                         C      ;;                                                   1-Stepsignal an LW aus
                         C      ;;
                         C      ;;  Port B
                         C      ;;  | 7 | 6 | 5 | 4 | 3 | 2 | 1 | 0 |
                         C      ;;    |   |   |   |   |   |   |   |__ E  /RDY  0-Laufwerk bereit
                         C      ;;    |   |   |   |   |   |   |                1-Laufwerk nicht bereit
                         C      ;;    |   |   |   |   |   |   |______ E  /MKE  0-Marke erkannt
                         C      ;;    |   |   |   |   |   |                    1-Marke noch nicht erkannt
                         C      ;;    |   |   |   |   |	 oder PC1715  E   MKE  1-Marke erkannt
                         C      ;;    |   |   |   |   |   |		       0-Marke noch nicht erkannt
                         C      ;;    |   |   |   |   |   |__________ E  /SYN  ????
                         C      ;;    |   |   |   |   |          oder A        0-Takt fuer 8" MFM
                         C      ;;    |   |   |   |   |                        1-Takt fuer 5" MFM und 8" FM
                         C      ;;    |   |   |   |   |  oder PC1715: A   MFM  0-FM-Aufzeichnung
                         C      ;;    |   |   |   |   |                        1-MFM-Aufzeichnung
                         C      ;;    |   |   |   |   |______________ A   PRE  0-schreiben ohne Prekompensation
                         C      ;;    |   |   |   |                            1-schreiben mit         "
                         C      ;;    |   |   |   |__________________ E  /FA   0-Fehler in der AMF aufgetreten
                         C      ;;    |   |   |                                1-kein Fehler aufgetreten
                         C      ;;    |   |   |          oder PC1715: A   FO   0-5"-Disketten
                         C      ;;    |   |   |                                1-8"-Disketten     
                         C      ;;    |   |   |______________________ E  /WP   0-Schreibschutz ist ein
                         C      ;;    |   |                                    1-kein Schreibschutz
                         C      ;;    |   |__________________________ E  /FW   0-Laufwerk meldete Schreibfehler
                         C      ;;    |                                        1-Laufwerk meldete keinen Fehler
                         C      ;;    |______________________________ E  /T0   0-Kopf steht auf Spur 0
                         C      ;;                                             1-Kopf steht nicht auf Spur 0
                         C      
                         C      
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      ;	FLOPPY-Treiber
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
  DEA6                   C      floppy: 
                         C      
                         C      ; Anfangswerte stellen
  DEA6    3A E177        C      	ld	a,(ft.kom)
  DEA9    E6 01          C      	and	1		;Fehlerwiederholung?
  DEAB    20 02          C      	jr	nz,setecr	;nein, A=0+1 (keine Wiederholung)
  DEAD    3E 10          C      	ld	a,15+1
  DEAF    32 E19D        C      setecr:	ld	(crerc),a	; Fehlerzaehler fuer CRC-Fehlerwiederholungen
  DEB2    20 02          C      	jr	nz,setesp
  DEB4    3E 05          C      	ld	a,4+1		; Fehlerzaehler fuer Spurfindewiederholungen
  DEB6    32 E19E        C      setesp:	ld	(sperc),a
                         C      
                         C      ; Laufwerksnummer pruefen
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-69


  DEB9    3A E17A        C      	ld	a,(ft.lwn)	; LW
                         C      ;	cp	maxlw		; LW < groesster LW-Nr.?
                         C      ;	jr	nc,nolw		; -> nein, Fehler: LW nicht existent
  DEBC    4F             C      	ld	c,a		; merken LW fuer Motor-an-Test
  DEBD    47             C      	ld	b,a		; fuer djnz
  DEBE    B7             C      	or	a		; LW=0?
  DEBF    3A E1A0        C      	ld	a,(lwexis)
  DEC2    28 04          C      	jr	z,drv0		; ->ja
  DEC4    0F             C      sp13: 	rrca
  DEC5    0F             C      	rrca
  DEC6    10 FC          C      	djnz	sp13
  DEC8    E6 03          C      drv0: 	and	3
  DECA    20 05          C      	jr	nz,drv0a
                         C      
  DECC    3E 44          C      nolw: 	ld	a,'D'		; LW nicht existent
  DECE    C3 E075        C      	jp	fehret		; -> Fehler
                         C      
  DED1                   C      drv0a: 
                         C      ; LW selektieren und Motor einschalten
  DED1    AF             C      	xor	a
  DED2    32 E14A        C      	ld	(pretx+1),a	;Motorabschaltung verhindern
  DED5    3D             C      	dec	a		;A:=255
  DED6    CD E131        C      	call	fl.sto		;Index-Ueberwachung ein
  DED9    CB D9          C      	set	3,c		; Motor-an-Bit setzen
  DEDB    21 E1A1        C      	ld	hl,alwnr
  DEDE    7E             C      	ld	a,(hl)
  DEDF    B9             C      	cp	c		; ist es das richtige LW und Motor an?
  DEE0    3E 6A          C      	ld	a,+pvrw2-(xpvrw+2) ; jr z,pvrw2 (keine Vertikalstab.)
  DEE2    28 44          C      	jr	z,dskmon	; ->ja, Kopf ist noch aufgesetzt
                         C      ; falsches LW oder Motor des LW aus
  DEE4    CD E162        C      	call	flres		; alte Spurnr. merken
                         C      
                         C      ; neues LW anwaehlen, Motor einschalten und alte Spurnr. holen
  DEE7    71             C      	ld	(hl),c		; neues LW, Motor-an-Bit
  DEE8    EB             C      	ex	de,hl		;merken ^alwnr
  DEE9    CB 99          C      	res	3,c		; alte Spurnr. holen
  DEEB    06 00          C      	ld	b,0
  DEED    21 E1A3        C      	ld	hl,spnrl
  DEF0    09             C      	add	hl,bc
  DEF1    7E             C      	ld	a,(hl)
  DEF2    32 E1A2        C      	ld	(aspnr),a
  DEF5    41             C      	ld	b,c
  DEF6    04             C      	inc	b
  DEF7    3E 77          C      	ld	a,077h		; LW-Anwahlbyte bilden (mit Lock)
  DEF9    07             C      nfdei2: rlca
  DEFA    10 FD          C      	djnz	nfdei2
  DEFC    D3 20          C      	out	(flsel),a	; Laufwerk selektieren (und evtl. Motor ein)
                         C       IF fdc eq f1715
  DEFE    D3 21          C      	out	(flmot),a	; Motor an (wenn nicht schon durch select)
                         C       ENDIF
  DF00    3E A9          C      	ld	a,10101001b	; Kopf laden, Fault reset
  DF02    D3 04          C      	out	(flcoad),a
                         C      
                         C      ; Motor-Start
  DF04    2E FF          C      	ld	l,254+1		;von 255 auf 254, d.h. mind 1 Indexinterrupt
  DF06    3A E177        C      	ld	a,(ft.kom)
  DF09    CB 67          C      	bit	4,a		;5"?
  DF0B    28 06          C      	jr	z,dskmo1	;nein
  DF0D    CB 6F          C      	bit	5,a		;5" 40 Spur?
  DF0F    20 02          C      	jr	nz,dskmo1	;nein
  DF11    2E FB          C      	ld	l,250+1		;von 255 auf 250,
                         C      				; d.h. mind. 4 volle Umdrehungen?
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-70


                         C      				;(bei MFS 1.2 kommt evtl. ready zu frueh)
  DF13                   C      dskmo1:
  DF13    3A E142        C      dskdaw:	ld	a,(fl.zto)	;Index-Interrupt-Zaehler
  DF16    BD             C      	cp	l		;entprechend viele Umdrehungen vorbei?
  DF17    38 0D          C      	jr	c,dskda		;ja
  DF19    0D             C      	dec	c		; warten, bis Diskette eingeschoben
  DF1A    20 F7          C      	jr	nz,dskdaw
  DF1C    10 F5          C      	djnz	dskdaw
  DF1E    EB             C      	ex	de,hl
  DF1F    CB 9E          C      	res	3,(hl)		;loeschen Motor an Bit
  DF21    3E 52          C      	ld	a,'R'		;LW nicht bereit
  DF23    C3 E075        C      	jp	fehret
  DF26    3E 61          C      dskda:	ld	a,+pvrw1-(xpvrw+2) ; jr z,pvrw1 (mit Vertikal-Stabil.)
  DF28                   C      dskmon:
  DF28    32 DF70        C      	ld	(xpvrw+1),a	; Vertikal-Stabilisierung ein/aus
                         C      
                         C      
                         C       IF dsk8fm+dsk8mf+dsk5fm; Standard ist 5"MFM
                         C       ELSE
                         C       IF @write
  DF2B    21 E2F2        C      	ld	hl,diwmfm
  DF2E    22 E28E        C      	ld	(dioop),hl	;Schreiben einstellen (falls Lesen war)
                         C       ENDIF
                         C       ENDIF
                         C       if dsk80
  DF31    3A E177        C      	ld	a,(ft.kom)
                         C       if dsk8fm+dsk8mf
                         C       endif
  DF34    CB 6F          C      	bit	5,a		;80-Spur-LW?
  DF36    3E 19          C      	ld	a,25		;Spur, ab der mit Praekomp.
  DF38    28 02          C      	jr	z,dprec2	;nein
  DF3A    3E 29          C      	ld	a,41
  DF3C    32 DFF6        C      dprec2:	ld	(dpretr),a
  DF3F                   C      dprecn:
                         C       endif
                         C      
                         C      ; modifizieren entspr. phys. Sektorlaenge
  DF3F    3A E17E        C      	ld	a,(ft.len)
  DF42    32 E282        C      	ld	(sidlen),a
  DF45    21 E1AB        C      	ld	hl,dsln0-dslnl
  DF48    47             C      	ld	b,a
  DF49    04             C      	inc	b
  DF4A    11 0003        C      	ld	de,dslnl
  DF4D    19             C      dtrsll:	add	hl,de
  DF4E    10 FD          C      	djnz	dtrsll
  DF50    EB             C      	ex	de,hl
  DF51    21 E1A7        C      	ld	hl,dslnmt	;Tabelle der Modif.adr.
  DF54    CD E0D2        C      	call	flmodf
                         C      
                         C      ; Kopf positionieren
  DF57    21 E17B        C      	ld	hl,ft.trk	; gewuenschte Spur
  DF5A    7E             C      	ld	a,(hl)
  DF5B    B7             C      	or	a		;Spur 0?
  DF5C    20 0D          C      	jr	nz,npost0	;nein
  DF5E    3A E17F        C      	ld	a,(ft.anz)	;Sektorzahl
  DF61    B7             C      	or	a		;nur positionieren auf Spur 0 (FORMAT-Progr.)
  DF62    28 4F          C      	jr	z,trk0		;ja, Spur 0 immer ueber Recalibrate
  DF64    3A E177        C      	ld	a,(ft.kom)
  DF67    CB 4F          C      	bit	1,a		;Lesen Sekt.id Spur 0?
  DF69    20 53          C      	jr	nz,trk0s	;ja, Lesen Sektid Spur 0 ueber Recalibrate
  DF6B    3A E1A2        C      npost0:	ld	a,(aspnr)	; stimmt Spur?
  DF6E    BE             C      	cp	(hl)
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-71


  DF6F    28 61          C      xpvrw:	jr	z,pvrw1		; -> ja, Kopf evtl. vertikal stabilisieren
                         C      				; auf jr z,pvrw2, wenn Kopf noch aufgesetzt
  DF71                   C      spprty:				;Wiederholung bei fehlerhafter Spur
                         C      ; Positionierung auf ft.trk
  DF71    3A E17B        C      spe: 	ld	a,(ft.trk)
  DF74    06 8F          C      	ld	b,08fh		; stepout-Befehl
  DF76    21 E1A2        C      	ld	hl,aspnr
  DF79    BE             C      	cp	(hl)		; auf richtiger Spur angekommen?
  DF7A    28 56          C      	jr	z,phrw		; -> ja, Kopf horizontal stabilisieren
  DF7C    38 0D          C      	jr	c,spre		; -> stepout
  DF7E    FE 55          C      xmaxtr: cp	85		; Spur zu gross?
  DF80    38 05          C      	jr	c,spve		; -> nein, stepin
  DF82    3E 54          C      	ld	a,'T'		; Fehler: Spurnr. zu gross
  DF84    C3 E075        C      	jp	fehret
                         C      
                         C      ; stepin
  DF87    06 AF          C      spve:	ld	b,0afh		; stepin-Befehl
  DF89    34             C      	inc	(hl)		; alte Spurnr. erhoehen
  DF8A    34             C      	inc	(hl)		; wegen stepout-dec
                         C      
                         C      ; stepout  
  DF8B    35             C      spre: 	dec	(hl)		; alte Spurnr. verringern
  DF8C    CD DF91        C      	call	step
  DF8F    18 E0          C      	jr	spe
                         C      
                         C      ; steppen
  DF91    3A E180        C      step: 	ld	a,(ft.stp)	; Anzahl der Stepimpulse pro Step
  DF94    0E 04          C      step0: 	ld	c,flcoad
  DF96    ED 41          C      	out	(c),b		; select direction
                         C      ;;;	push	bc
                         C      ;;;	ld	b,0
                         C      ;;;step1: 	djnz	step1		; 1,3ms warten
                         C      ;;;	pop	bc
  DF98    C5             C      step2: 	push	bc
  DF99    CB B8          C      	res	7,b
  DF9B    F3             C      	di			;verhindern Unterbrechung
  DF9C    ED 41          C      	out	(c),b
  DF9E    CB F8          C      	set	7,b
  DFA0    ED 41          C      	out	(c),b		; step
  DFA2    FB             C      	ei
  DFA3    ED 4B E181     C      	ld	bc,(ft.sti)	; 13,2 / 11,6 / 3,0 ms Schrittzeit
  DFA7    06 13          C      stepw1: ld	b,19		;(19*13)/(256*9600)=0.0001
  DFA9    10 FE          C      stepw: 	djnz	stepw		;0.1 ms warten
  DFAB    0D             C      	dec	c
  DFAC    20 F9          C      	jr	nz,stepw1
  DFAE    C1             C      	pop	bc
  DFAF    3D             C      	dec	a
  DFB0    20 E6          C      	jr	nz,step2
  DFB2    C9             C      	ret
                         C      
                         C      ; Spur 0 anfahren (Recalibrate)
  DFB3    06 02          C      trk0:	ld	b,2		; nach innen, falls auf Spur -1
  DFB5    C5             C      trk0i:	push	bc
  DFB6    06 AF          C      	ld	b,0afh	 	; stepin
  DFB8    CD DF91        C      	call	step
  DFBB    C1             C      	pop	bc
  DFBC    10 F7          C      	djnz	trk0i
  DFBE    DB 06          C      trk0s:	in	a,(flcobd)
  DFC0    07             C      	rlca			; Spur 0 erreicht?
  DFC1    30 09          C      	jr	nc,trk0f	; -> ja
  DFC3    06 8F          C      	ld	b,08fh		; stepout-Befehl
  DFC5    3E 01          C      	ld	a,1		; in phys. Schritten
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-72


  DFC7    CD DF94        C      	call	step0
  DFCA    18 F2          C      	jr	trk0s
  DFCC    AF             C      trk0f: 	xor	a
  DFCD    32 E1A2        C      	ld	(aspnr),a	; aktuelle Spurnr ist 0
  DFD0    18 9F          C      	jr	spprty
                         C      
                         C      
                         C      ; Kopf stabilisieren (horizontal und vertikal)
  DFD2                   C      pvrw1:	; Kopf vertikal stabilisieren
  DFD2                   C      phrw:	; Kopf horizontal (und evtl. auch vertikal) stabilisieren
  DFD2    3E 32          C      	ld	a,50		; 50 ms (fuer alle Laufwerkstypen)
  DFD4    06 BD          C      phrww1: ld	b,189		; (189*13)/(256*9600)=0.001
  DFD6    10 FE          C      phrww: 	djnz	phrww		; 1 ms warten
  DFD8    3D             C      	dec	a
  DFD9    20 F9          C      	jr	nz,phrww1
  DFDB                   C      pvrw2:	; Kopf war aufgesetzt und Spur stimmte auch - keine Stabilis.
                         C      
  DFDB                   C      rdwr: 
                         C      ; Anfangswerte fuer Transfer der physischen Sektoren
  DFDB    3A E17F        C      	ld	a,(ft.anz)	; Anzahl der zu uebertragenden phys. Sektoren
  DFDE    32 E21C        C      	ld	(secan1),a
  DFE1    32 E0E4        C      	ld	(secanz),a	; fuer CRC-Berechnung
                         C      
  DFE4    3A E17B        C      	ld	a,(ft.trk)	; Spur
  DFE7    32 E270        C      	ld	(sidtr),a
  DFEA    21 E180        C      	ld	hl,ft.stp
  DFED    CB 46          C      	bit	0,(hl)		;Doppelschritte?
  DFEF    28 01          C      	jr	z,dprec1	;nein
  DFF1    87             C      	add	a,a		;sonst phys. Spur verdoppeln
  DFF2                   C      dprec1:
                         C      ; evtl. Precompensation einschalten
  DFF2    01 0406        C      	ld	bc,00000100b*256+flcobd
  DFF4                   C      dfrcod	equ	$-1		; Frequenzcode
  DFF5    FE 19          C      	cp	25		; Spur ab der mit writeprecomp.
  DFF6                   C      dpretr	equ	$-1
  DFF7    38 02          C      	jr	c,prec		; <, ohne Precompensation
  DFF9    CB D8          C      	set	3,b		; >= , mit
  DFFB    ED 41          C      prec: 	out	(c),b
                         C      
  DFFD    3A E17D        C      	ld	a,(ft.sec)	; erste zu uebertr. Sektornr.
  E000    32 E27C        C      	ld	(sidsec),a
  E003    3A E17C        C      	ld	a,(ft.sid)
  E006    32 E276        C      	ld	(sidsid),a
                         C      
                         C       IF dskds ; double sided
                         C      ; evtl. side 1 anwaehlen vorbereiten
  E009    3A E177        C      	ld	a,(ft.kom)
  E00C    21 E1BA        C      	ld	hl,dsidmt
  E00F    46             C      	ld	b,(hl)
  E010    23             C      dsidmz:	inc	hl
  E011    5E             C      	ld	e,(hl)
  E012    23             C      	inc	hl
  E013    56             C      	ld	d,(hl)
  E014    EB             C      	ex	de,hl
  E015    CB 7F          C      	bit	7,a		; side 0?
  E017    28 04          C      	jr	z,pside0	; ja
  E019    CB 96          C      	res	2,(hl)		; side 1 einstellen
  E01B    18 02          C      	jr 	pside1
  E01D    CB D6          C      pside0:	set	2,(hl)
  E01F    EB             C      pside1:	ex	de,hl
  E020    10 EE          C      	djnz	dsidmz
                         C       ENDIF
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-73


                         C      
                         C      ; evtl. nur Lesen Sektor-Id.
  E022    3A E177        C      	ld	a,(ft.kom)
  E025    CB 4F          C      	bit	1,a		; Lesen Sekt.Id?
  E027    21 E1DA        C      	ld	hl,dio
  E02A    28 03          C      	jr	z,srdsid	; -> nein
  E02C    21 E1CC        C      	ld	hl,diotsr
  E02F    22 E1CA        C      srdsid:	ld	(diortn),hl
                         C      
                         C       IF @write
  E032    3A E177        C      	ld	a,(ft.kom)	; Schreiben?
  E035    CB 57          C      	bit	2,a
  E037    20 08          C      	jr	nz,writpt	; -> ja, Schreibroutine steht auf dioop
                         C       ENDIF
  E039    21 E2A1        C      	ld	hl,diord
  E03C    22 E28E        C      	ld	(dioop),hl	; read einstellen
                         C      
                         C       IF @write
  E03F    18 22          C      	jr	dtrdyt
  E041                   C      writpt:		; pruefen, ob Schreiben erlaubt ist
  E041    DB 06          C      	in	a,(flcobd)
  E043    CB 6F          C      	bit	5,a		; /WP
  E045    3E 57          C      	ld	a,'W'		; Fehler: write protected
  E047    CA E075        C      	jp	z,fehret
                         C      
                         C      ; CRC-Zeichen der zu schreibenden Daten berechnen und in crcber ablegen
  E04A    2A E178        C      	ld	hl,(ft.adr)
  E04D    DD 21 E182     C      	ld	ix,crcber	; Pointer auf 1. Daten-CRC stellen
  E051    DD 36 00 FB    C      crcbes: ld	(ix),0fbh	; Datenbeginn
  E055    CD E0F4        C      	call	crcbd		; CRC eines phys. Sektors berechnen
  E058    DD 72 00       C      	ld	(ix+0),d
  E05B    DD 73 01       C      	ld	(ix+1),e	; ... und ablegen
  E05E    CD E0DF        C      	call	crcnb		; weiterer phys. Sektor?
  E061    20 EE          C      	jr	nz,crcbes	; -> ja
                         C       ENDIF ;@write
                         C      
                         C      
                         C      ; Disk inzwischen ready?
                         C      
  E063                   C      dtrdyt:
  E063    DB 06          C      dtrdyz:	IN	A,(flcobd)
  E065    1F             C      	RRA			;ready-bit =0?
  E066    38 FB          C      dtrdyw:	JR	C,dtrdyz	;nein, 5" Disk not ready
                         C      				;auf jr c,$+2 modif bei 8"
                         C      
  E068    3E 05          C      	ld	a,5
  E06A    CD E131        C      	call	fl.sto		;bei evtl. Fehlerwiederholung
                         C      				; timeout-Wert wieder hochstellen
                         C      				; fuer Ueberwachung auf fehlende Marke
  E06D    3A E17F        C      	ld	a,(ft.anz)	;Sektorzahl
  E070    B7             C      	or	a		; nur positionieren?
  E071    C2 E1C9        C      	jp	nz,diorun	; -> nein, Start des Transfers
                         C      
                         C      ; kein Fehler aufgetreten
  E074    AF             C      noerr:	xor	a
                         C      
                         C      ; Fertigmelden, Ergebnis in A
  E075    F5             C      fehret:	push	af
  E076    21 E14A        C      	ld	hl,pretx+1	;Motorabschaltung ueber Index-Interrupt
  E079    36 07          C      	ld	(hl),pret3-pret4;jr pret4
  E07B    3E 14          C      	ld	a,20		;nach 20*200ms = 4 sec
  E07D    CD E131        C      	call	fl.sto
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-74


  E080    F1             C      	pop	af
  E081    C9             C      	ret
                         C      
                         C      ; normale Beendigung
                         C      ;===================
                         C      
                         C      ; Schreiben
  E082    21 E177        C      dtrwre:	ld	hl,ft.kom
  E085    CB 76          C      	bit	6,(hl)		;Kontrollesen?
  E087    28 EB          C      	jr	z,noerr		;nein, fertig
  E089    CB 96          C      	res	2,(hl)		;sonst schreiben loeschen (d.h. auf lesen)
  E08B    C3 DFDB        C      	jp	rdwr		;und auf gleichen Puffer zuruecklesen
                         C      
                         C      ; Lesen
  E08E    2A E178        C      dtrrde:	ld	hl,(ft.adr)
  E091    DD 21 E182     C      	ld	ix,crcber
  E095    CD E0F4        C      crcbel:	call	crcbd		;CRC bilden
  E098    CD E0EA        C      	call	crcvgl		; und vergleichen
  E09B    20 07          C      	jr	nz,crcerx	; -> Fehler
  E09D    CD E0DF        C      	call	crcnb		;noch ein Sektor?
  E0A0    20 F3          C      	jr	nz,crcbel	;ja
  E0A2    18 D0          C      	jr	noerr
                         C      
                         C      ; Fehlerbehandlung
                         C      ;=================
                         C      ; blieb weiterer Versuch, Sektor CRC-richtig reinzubekommen?
  E0A4    21 E19D        C      crcerx: ld	hl,crerc
  E0A7    35             C      	dec	(hl)
  E0A8    C2 DFDB        C      	jp	nz,rdwr		; -> ja, alles noch mal
  E0AB    3E 43          C      	ld	a,'C'		; Fehler: CRC-Zeichen falsch
  E0AD    18 C6          C      	jr	fehret
                         C      
                         C      ; Sektor nicht gefunden, evtl. falsche Spur
  E0AF                   C      serrx:
                         C      ; blieb weiterer Versuch, die richtige Spur zu finden?
  E0AF    21 E19E        C      	ld	hl,sperc
  E0B2    35             C      	dec	(hl)
  E0B3    28 15          C      	jr	z,sperr2	; Wiederhlg. abgelaufen
  E0B5    3E 02          C      	ld	a,2
  E0B7    BE             C      	cp	(hl)		;> 2 Wiederhlg?
  E0B8    DA DFB3        C      	jp	c,trk0		;ja, Spur neu anfahren
  E0BB    06 8F          C      	ld	b,08fh		;stepout
  E0BD    28 05          C      	jr	z,sperr4	;=2 Wiederhlg., stepout
  E0BF    06 AF          C      	ld	b,0afh		;stepin
  E0C1    CD DF91        C      	call	step		;2 mal (zuvor war stepout)
  E0C4    CD DF91        C      sperr4:	call	step
  E0C7    C3 DFD2        C      	jp	phrw		;Wiederholung
                         C      
  E0CA    3E 53          C      sperr2:	ld	a,'S'		; Fehler: Sektor ist nicht zu finden
  E0CC    18 A7          C      	jr	fehret
                         C      
                         C      
  E0CE                   C      fl.to1: ; keine Sektor-Marke gefunden
  E0CE    3E 55          C      	ld	a,'U'		; time-out (undefind)
  E0D0    18 A3          C      	jr	fehret
                         C      
                         C      ; Modifizierung entsprechend Steuertabelle
                         C      ;=========================================
                         C      ; i HL	Tabelle der Modifizierungsadressen (wohin)
                         C      ; i DE	Tabelle der Modifizierungsbytes    (was)
  E0D2    46             C      flmodf:	ld	b,(hl)		;Anzahl der Adressen
  E0D3    23             C      dslnmz:	inc	hl
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-75


  E0D4    C5             C      	push	bc
  E0D5    4E             C      	ld	c,(hl)
  E0D6    23             C      	inc	hl
  E0D7    46             C      	ld	b,(hl)		;bc:=wohin
  E0D8    1A             C      	ld	a,(de)		;a:=was
  E0D9    13             C      	inc	de
  E0DA    02             C      	ld	(bc),a
  E0DB    C1             C      	pop	bc
  E0DC    10 F5          C      	djnz	dslnmz
  E0DE    C9             C      	ret
                         C      
                         C      ; CRC-Berechnung
                         C      ;===============
                         C      
                         C      ; von weiterem Sektor CRC-Zeichen berechnen?
                         C      ; IX wird weitergestellt
  E0DF    DD 23          C      crcnb: 	inc	ix		; CRC-Pointer erhoehen
  E0E1    DD 23          C      	inc	ix
  E0E3    3E FF          C      	ld	a,0ffh
  E0E4                   C      secanz	equ	$-1
  E0E5    3D             C      	dec	a
  E0E6    32 E0E4        C      	ld	(secanz),a
  E0E9    C9             C      	ret
                         C      
                         C      ; CRC-Vergleich DE mit (IX)
  E0EA    DD 7E 00       C      crcvgl: ld	a,(ix+0)
  E0ED    BA             C      	cp	d
  E0EE    C0             C      	ret	nz
  E0EF    DD 7E 01       C      	ld	a,(ix+1)
  E0F2    BB             C      	cp	e
  E0F3    C9             C      	ret
                         C      
                         C      ; von einem phys. Sektor ab HL die CRC-Zeichen berechnen  
                         C      ; HL wird weitergestellt
  E0F4    11 CDB4        C      crcbd:	ld	de,0cdb4h	;CRC Anfangswert
  E0F5                   C      crcbeg	equ	$-2
  E0F7    DD E5          C      	push	ix
  E0F9    E3             C      	ex	(sp),hl		;hl:= ^Datenbeginn-Byte
  E0FA    06 01          C      	ld	b,1
  E0FC    CD E10E        C      	call	bercrc		;CRC ueber Datenbeginn-Byte
  E0FF    E3             C      	ex	(sp),hl
  E100    DD E1          C      	pop	ix
  E102    06 01          C      	ld	b,1
  E103                   C      fl.tsb	equ	$-1		; Zahl der 128er Bloecke
  E104    C5             C      sp74: 	push	bc
  E105    06 80          C      	ld	b,128
  E107    CD E10E        C      	call	bercrc
  E10A    C1             C      	pop	bc
  E10B    10 F7          C      	djnz	sp74
  E10D    C9             C      	ret
                         C      
                         C      ; von HL an B Zeichen auf DE als CRC-Polynom draufrechnen
  E10E    7E             C      bercrc: ld	a,(hl)
  E10F    AA             C      	xor	d
  E110    57             C      	ld	d,a
  E111    0F             C      	rrca
  E112    0F             C      	rrca
  E113    0F             C      	rrca
  E114    0F             C      	rrca
  E115    E6 0F          C      	and	0fh
  E117    AA             C      	xor	d
  E118    57             C      	ld	d,a
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-76


  E119    0F             C      	rrca
  E11A    0F             C      	rrca
  E11B    0F             C      	rrca
  E11C    4F             C      	ld	c,a
  E11D    E6 1F          C      	and	1fh
  E11F    AB             C      	xor	e
  E120    5F             C      	ld	e,a
  E121    79             C      	ld	a,c
  E122    0F             C      	rrca
  E123    E6 F0          C      	and	0f0h
  E125    AB             C      	xor	e
  E126    5F             C      	ld	e,a
  E127    79             C      	ld	a,c
  E128    E6 E0          C      	and	0e0h
  E12A    AA             C      	xor	d
  E12B    53             C      	ld	d,e
  E12C    5F             C      	ld	e,a
  E12D    23             C      	inc	hl
  E12E    10 DE          C      	djnz	bercrc
  E130    C9             C      	ret
                         C      
                         C      ; Aktivieren Indexpunktueberwachung
                         C      ; i A	Zaehler (wird bis 0 runtergezaehlt)
                         C      ; nur Reg. A zerstoert
                         C      
  E131    32 E142        C      fl.sto:	ld	(fl.zto),a	;Setzen Zaehler fuer Indexpunkte
  E134    3E 83          C      	ld	a,83h		;zulassen Indexinterrupt
  E136    D3 05          C      	out	(flcoac),a
  E138    C9             C      	ret
                         C      
                         C      ; Interruptbehandlungsroutine: time-out-Zeit abgelaufen
                         C      ; ausgeloest durch Index-Interrupt
  E139    ED 73 E3A4     C      itimeo: ld	(intsp),sp
  E13D    31 F1E6        C      	ld	sp,intstk
  E140    F5             C      	push	af
  E141    3E 00          C      	ld	a,0		; Zaehler fuer time-out Takte
  E142                   C      fl.zto	equ	$-1
  E143    3D             C      	dec	a		; time-out -1
  E144    32 E142        C      	ld	(fl.zto),a
  E147    20 0C          C      	jr	nz,pret1	;-> nicht abgelaufen
  E149    18 07          C      pretx:	jr	pret3		;modif. auf "jr pret4" waehrend Transfer
  E14B                   C      pret4:
  E14B    F1             C      	pop	af
  E14C    06 03          C      	ld	b,3		;Reaktionsroutine "keine Marke gefunden"
  E14E    04             C      	inc	b		;z-Flag loeschen
  E14F    F5             C      	push	af
  E150    18 03          C      	jr	pret1
  E152    CD E158        C      pret3:	call	headup
  E155    C3 E3A2        C      pret1: 	jp	intraf		; allg. Ausgang Interruptroutinen
                         C      
                         C      ; Motor-Abschaltung von aussen her
                         C      ; nur Reg. AF zerstoert
  E158    3E 03          C      headup:	ld	a,3		; Indexinterrupt sperren
  E15A    D3 05          C      	out	(flcoac),a
  E15C    3E FF          C      	ld	a,0ffh		; Motor aus
  E15E    D3 20          C      	out	(flsel),a
                         C       IF fdc eq f1715
  E160    D3 21          C      	out	(flmot),a
                         C       ENDIF
                         C      ; Motor aus und alte Spurnummer merken
  E162    E5             C      flres: 	push	hl
  E163    C5             C      	push	bc
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-77


  E164    21 E1A1        C      	ld	hl,alwnr
  E167    CB 9E          C      	res	3,(hl)		; Motor aus vermerken
  E169    4E             C      	ld	c,(hl)
  E16A    06 00          C      	ld	b,0
  E16C    21 E1A3        C      	ld	hl,spnrl	; alte Spurnr. in Tabelle merken
  E16F    09             C      	add	hl,bc
  E170    3A E1A2        C       	ld	a,(aspnr)
  E173    77             C      	ld	(hl),a
  E174    C1             C      	pop	bc
  E175    E1             C      	pop	hl
  E176    C9             C      	ret
                         C      
                         C      
                         C      ;*****************************************************
                         C      ;	Arbeitsbereiche phys. Floppy-Treiber
                         C      ;*****************************************************
                         C      
                         C      ; Parameterfeld
                         C      ;==============
  E177    00             C      ft.kom: db	0	; Kommando
  E178    0000           C      ft.adr: dw	0	; Transferadresse
  E17A    00             C      ft.lwn: db	0	; Laufwerksnummer 0..3
  E17B    00             C      ft.trk: db	0	; Spurnummer   0..
  E17C    00             C      ft.sid: db	0	; side-Nr.     0..1
  E17D    00             C      ft.sec: db	0	; Sektornummer
  E17E    00             C      ft.len: db	0	; Sektorlaenge 0..3
  E17F    00             C      ft.anz: db	0	; Anz. phys. Sektoren
  E180    00             C      ft.stp: db	0	; Anzahl der Stepimpulse pro Spur
  E181    00             C      ft.sti: db	0	; Schrittzeit von Spur zu Spur
                         C      
  E182                   C      crcber: ds	3*9,0ffh; Ber. zum Ablegen der gelesenen/zu schreibenden CRC-Z.
                         C      			; reicht fuer 9 physische Sektoren pro Transfer
                         C      ; Fehler-Wiederholungszaehler
  E19D    00             C      crerc: 	db	0	; CRC-Fehler
  E19E    00             C      sperc: 	db	0	; Spur nicht gefunden
  E19F    00             C      seerc: 	db	0	; Sektor nicht gefunden
  E1A0    00             C      lwexis: db	0	; Anzeigebyte fuer vorhandene Laufwerke
                         C      			; bit 0 = 1 LW 0 vorhanden
                         C      			; bit 2 = 1 LW 1 vorhanden
                         C      			; bit 4 = 1 LW 2 vorhanden
                         C      			; bit 6 = 1 LW 3 vorhanden
                         C      
  E1A1    00             C      alwnr: 	db	0	; alte Laufwerksnummer vom vergangenen Zugriff
                         C      			; bit 0-2 LW-Nr., bit 3 = 1 Motor laeuft noch
                         C      
  E1A2    00             C      aspnr:	db	0	; aktuelle Spur des durch alwnr bezeichneten LW
  E1A3    00 00 00 00    C      spnrl: 	db	0,0,0,0	; Tabelle der alten Spurnummern
                         C      
                         C       IF dsk8fm+dsk8mf+dsk5fm
                         C       ENDIF ;nicht nur 5" MFM
                         C      
                         C      ; Modifizierungstabelle entspr. Sektorlaenge
                         C      
  E1A7    03             C      dslnmt:	db	dslnl		;Tabellenlaenge
  E1A8    E103           C      	dw	fl.tsb		;Anzahl der 128er Bloecke
  E1AA    E2CA           C      	dw	diosl1
  E1AC    E321           C      	dw	diosl2
  0003                   C      dslnl	equ	($-dslnmt-1)/2	;Tabellenlaenge
                         C      
                         C      
                         C      ; 128
  E1AE    01             C      dsln0:	db	1
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-78


  E1AF    01             C      	db	1
  E1B0    01             C      	db	1
                         C      
                         C      ; 256
  E1B1    02             C      dsln1:	db	2
  E1B2    02             C      	db	2
  E1B3    02             C      	db	2
                         C      
                         C      ; 512
  E1B4    04             C      dsln2:	db	4
  E1B5    04             C      	db	4
  E1B6    04             C      	db	4
                         C      
                         C      ; 1024
  E1B7    08             C      dsln3:	db	8
  E1B8    08             C      	db	8
  E1B9    08             C      	db	8
                         C      
                         C       IF dskds
                         C      ; Modifizierungsadressen fuer Seitenauswahl
  E1BA    07             C      dsidmt:	db	dsidtl		; MFM		 FM
  E1BB    E208           C      	dw	diom01		;85/81		87/83
  E1BD    E1EB           C      	dw	diom02		;bd/b9		bd/b9
                         C       if @write
                         C        IF dsk8fm+dsk5fm
                         C        ENDIF
  E1BF    E2FE           C      	dw	diom07		;b4/b0		 -
  E1C1    E30F           C      	dw	diom08		;b6/b2		 -
  E1C3    E315           C      	dw	diom09		;b4/b0		 -
                         C       endif
  E1C5    E2AC           C      	dw	diom10		;b5/b1		b5/b1
  E1C7    E2E7           C      	dw	diom11		;b5/b1		b5/b1
  0007                   C      dsidtl	equ	($-dsidmt-1)/2
                         C       ENDIF
                         C      	include	BIOPDSKP	;Disketten hardwareabh. Teil
                         C      ;**************************************************************
                         C      ; physischer Floppytreiber fuer PC 1715
                         C      ;  (und bis auf invertiertes Signal MKE auch fuer AMF 5120/21/22)
                         C      ; Autor: W. Dames
                         C      ; Version: 29.03.88
                         C      ; Aenderungen:
                         C      ; - nop,nop in "diowt1" eingefuegt (RAM-refresh)
                         C      ; - K5120 Variante eingefuegt
                         C      ;*************************************************************
                         C      
                         C      ; Die Floppy-Arbeit wird durch paralle Interrupts nicht gestoert,
                         C      ; im Echtzeitbetrieb waehrend des Transfers eines physischen Sektors
                         C      ; arbeitet der Treiber in einer Interruptroutine mit geschlossenen
                         C      ; Interrupts (bei 1K Sektorlaenge max. 40ms!).
                         C      ; Es wird gesichert, dass maximal viele Fremd-Interrupts durchkommen,
                         C      ; so dass z.B. die Verfaelschung einer Software-Uhr durch Disketten-
                         C      ; transfer auf Basis eines 25ms-Taktes (nur wenn nicht kaskadierte
                         C      ; CTC-Kanaele interessant) minimal ist.
                         C      
                         C      ; Zur Realisierung der Motorabschaltung wird der Indexinterrupt des
                         C      ; Floppy benutzt.
                         C      
                         C      ; Es werden keine Schattenregister benoetigt.
                         C      
                         C      ; Untersuchungen zur Einschraenkung der Befehlsfolgen (bei 2.5 MHz Takt):
                         C      ; Abstand zwischen IN/OUT-Befehlen fuer Daten		maximal
                         C      ; Datenrate 	5" FM		64 mikrosec pro Byte	156 Takte
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-79


                         C      ;		5" MFM, 8" FM	32 mikrosec pro Byte	78 Takte
                         C      ;		8" MFM		16 mikrosec pro Byte	39 Takte
                         C      
                         C      ; max. Abstand zwischen zwei M1-Zyklen wegen Refresh und
                         C      ; Bildschirm-DMA waehrend Refresh im Durchschnitt:
                         C      ;	0.580 ns *12 Zeilen	6.96 mikrosec		17 Takte
                         C      ; Dieser Wert kann fuer einzelne Bytes ueberschritten werden (durch
                         C      ; zusaetzliche WAIT-Zyklen), wenn diese Zeit innerhalb einer Bild-
                         C      ; schirmzeile kompensiert wird.
                         C      
  E1C9                   C      diorun:
  E1C9    C3 E1DA        C      	jp	dio
  E1CA                   C      diortn	equ	$-2
                         C      
                         C      ; Lesen Sektorid vorbereiten
                         C      ;===========================
  E1CC    21 2918        C      diotsr:	ld	hl,+(diotrr-(diomd1+2))*256+18h
  E1CF    22 E26D        C      	ld	(diomd1),hl	;einstellen "jr diotrr"
  E1D2    11 0302        C      	ld	de,3*256+fldabd
  E1D5    21 E17C        C      	ld	hl,ft.trk+1
  E1D8    18 0C          C      	jr	diostr
                         C      
                         C      ; normalen Transfer vorbereiten
                         C      ;==============================
  E1DA    21 2120        C      dio:	ld	hl,+(dioign-(diomd1+2))*256+20h
  E1DD    22 E26D        C      	ld	(diomd1),hl	;wiederherstellen "jr nz,dioign"
  E1E0    2A E178        C      	ld	hl,(ft.adr)	;Transferadr.
  E1E3    11 E182        C      	ld	de,crcber	;auf Beginn Datenbyte/CRC Vektor
                         C      
                         C      ; Start des Transfers
                         C      ;====================
  E1E6                   C      diostr:
  E1E6    3E B9          C      	ld	a,10111001b	;AMF aus, Fault Reset fuer 1.2-Laufwerke
  E1E8    D3 04          C      	out	(flcoad),a
  E1EA    3E BD          C      	ld	a,10111101b	;Seite laden, Mark reset, AMF aus
  E1EB                   C      diom02	equ	$-1		;bd/b9
  E1EC    D3 04          C      	out	(flcoad),a
  E1EE    06 13          C      	ld	b,19		;(19*13)/(256*9600)=0.0001
  E1F0    10 FE          C      diow01:	djnz	diow01		;warten 100 Mikrosek. auf Seitenumschaltung
  E1F2    DB 02          C      	in	a,(fldabd)
  E1F4    D3 00          C      	out	(fldaad),a
  E1F6    3E 3C          C      dionss:	ld	a,60		;wiederherst. Zaehler falscher Sektid.
  E1F8    32 E19F        C      	ld	(seerc),a	;fuer naechsten Sektor
  E1FB    3E 05          C      diomr:	ld	a,5		;time out Ueberwachung
  E1FD    32 E142        C      	ld	(fl.zto),a	;bei fehlender Sektormarke
  E200    42             C      diomr1:	ld	b,d		;stellen bc fuer evtl. Lesen Sektid
  E201    4B             C      	ld	c,e
  E202    F3             C      	di
  E203    3E 83          C      	ld	a,83h
  E205    D3 07          C      	out	(flcobc),a	;Interrupt erlauben
  E207    3E 85          C      	ld	a,10000101b	;85/81 MFM, 87/83 FM
  E208                   C      diom01	equ	$-1
  E209    D3 04          C      	out	(flcoad),a	;AMF ein, Lesen Marke ein
  E20B    AF             C      	xor	a		;Interrupt bei Marke stellt nz-Flag
  E20C    FB             C      	ei
  E20D    28 FE          C      diowam:	jr	z,diowam	;Warten auf Ende Interrupt
  E20F    05             C      	dec	b		;Sektorbeginn gefunden?
  E210    28 EE          C      	jr	z,diomr1	;nein, weitersuchen
  E212    05             C      	dec	b		;richtigen Sektorid gefunden?
  E213    28 33          C      	jr	z,serr1		;nein
  E215    05             C      	dec	b		;Sektid-Lesen beendet?
  E216    28 14          C      	jr	z,dtrsie	;ja
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-80


  E218    05             C      	dec	b		;fehlende Marke?
  E219    28 3C          C      	jr	z,diomre	;ja
                         C      ; Transfer fehlerfrei
  E21B    3E 01          C      	ld	a,1
  E21C                   C      secan1	equ	$-1		;Zahl zu transf. phys. Sektoren
  E21D    3D             C      	dec	a		;fertig?
  E21E    28 17          C      	jr	z,dionse	;ja
  E220    32 E21C        C      	ld	(secan1),a
  E223    3A E27C        C      	ld	a,(sidsec)
  E226    3C             C      	inc	a
  E227    32 E27C        C      	ld	(sidsec),a
  E22A    18 CA          C      	jr	dionss		;naechster Sektor
                         C      
                         C      ; Lesen Sektid beendet
  E22C                   C      dtrsie:
  E22C    3A E276        C      	ld	a,(sidsid)	;geforderte Seite
  E22F    21 E17C        C      	ld	hl,ft.sid	;gelesene Seite
  E232    BE             C      	cp	(hl)		;identisch?
  E233    20 10          C      	jr	nz,diotre	;nein, falscher Sektid
  E235    2B             C      	dec	hl		;auf ft.trk
  E236    71             C      	ld	(hl),c		;(tatsaechliche) Spur aus Sektid
  E237    CD E25D        C      dionse:	call	dioaus
  E23A    05             C      	dec	b		;Lesen Daten beendet?
  E23B    CA E08E        C      	jp	z,dtrrde	;ja
  E23E    05             C      	dec	b		;Schreiben Daten beendet?
  E23F    CA E082        C      	jp	z,dtrwre	;ja
  E242    C3 E074        C      	jp	noerr		;sonst Lesen Sektid beendet
                         C      
  E245    21 E17C        C      diotre:	ld	hl,ft.trk+1	;Wiederholung "inir" vorbereiten
                         C      ; falscher Sektid
  E248    3A E19F        C      serr1:	ld	a,(seerc)
  E24B    3D             C      	dec	a		;blieb weiterer Versuch?
  E24C    32 E19F        C      	ld	(seerc),a
  E24F    20 AA          C      	jr	nz,diomr	;ja
  E251    CD E25D        C      	call	dioaus
  E254    C3 E0AF        C      	jp	serrx
                         C      
  E257    CD E25D        C      diomre:	call	dioaus
  E25A    C3 E0CE        C      	jp	fl.to1
                         C      
  E25D                   C      dioaus:
                         C      ; keine Side-Umschaltung, d.h. Seite bleibt mindestens noch 100 Mikrosek.
                         C      ; (fuer einige 1.6-Laufwerke gefordert)
  E25D    3A E1EB        C      	ld	a,(diom02)	;bd/b9  AMF aus
  E260    D3 04          C      	out	(flcoad),a
  E262    C9             C      	ret
                         C      
                         C      ; Interrupt Adressmarke
                         C      ;======================
                         C      
  E263                   C      diomrk:
  E263    DB 02          C      diokl:	in	a,(fldabd)
  E265    FE A1          C      	cp	0a1h		;noch in Kluft?
  E267    28 FA          C      	jr	z,diokl		;ja
  E269    FE FE          C      	cp	0feh		;Sektorbeginn?
  E26B    DB 02          C      	in	a,(fldabd)	; trk
                         C      ; folgender Befehl wird modifiziert bei Lesen Sektid auf "jr diotrr"
  E26D    20 21          C      diomd1:	jr	nz,dioign	;nein, Interrupt ignorieren
  E26F    FE FF          C      	cp	0ffh		; stimmt die Spurnr.?
  E270                   C      sidtr	equ	$-1
  E271    20 21          C      	jr	nz,serr		;nein
  E273    DB 02          C       	in	a,(fldabd)	; side
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-81


  E275    FE FF          C      	cp	0ffh		; stimmt side?
  E276                   C      sidsid	equ	$-1
  E277    20 1B          C      	jr	nz,serr		; nein
  E279    DB 02          C      	in	a,(fldabd)	; sec
  E27B    FE FF          C      	cp	0ffh		; stimmt Sektornr.?
  E27C                   C      sidsec	equ	$-1
  E27D    20 15          C      	jr	nz,serr		;nein
  E27F    DB 02          C      	in	a,(fldabd)	; len
  E281    FE FF          C      	cp	0ffh		; stimmt len?
  E282                   C      sidlen	equ	$-1
  E283    20 0F          C      	jr	nz,serr		;nein
                         C      
                         C      ; das gewuenschte Sektor-ID ist gefunden
  E285    06 14          C      	ld	b,20		;Zahl zu uebergehender Bytes
  E286                   C      diomd2	equ	$-1		;20 bei MFM, 9 bei FM
  E287    DB 02          C      diosyn:	in	a,(fldabd)	; CRC und Gap Sektid/Daten ueberlesen
  E289    00             C      	nop
  E28A    00             C      	nop
  E28B    10 FA          C      diosy3:	djnz	diosyn
  E28D    C3 E2A1        C      	jp	diord		;wird modif. entspr. Operation mit
  E28E                   C      dioop	equ	$-2		;diord, diwmfm, diowfm
                         C      
                         C      
                         C      ; kein Sektorbeginn
                         C      ;------------------
  E290    06 00          C      dioign:	ld	b,1-1
  E292    18 52          C      	jr	dioend
                         C      
                         C      ; Falscher Sektid
                         C      ;----------------
  E294    06 01          C      serr:	ld	b,2-1
  E296    18 4E          C      	jr	dioend
                         C      
                         C      ; Lesen Sektid
                         C      ;-------------
  E298    20 F6          C      diotrr:	jr	nz,dioign	;kein Sektorbeginn
  E29A    ED B2          C      	inir
  E29C    4F             C      	ld	c,a		;merken Spur
  E29D    06 02          C      	ld	b,3-1		;Sektid lesen beendet
  E29F    18 45          C      	jr	dioend
                         C      
                         C      ; Lesen
                         C      ;------
                         C      
  E2A1    DB 02          C      diord:	in	a,(fldabd)
  E2A3    06 06          C      	ld	b,6
  E2A5    DB 02          C      diords:	in	a,(fldabd)	;uebergehen Synchronbytes
  E2A7    00             C      	nop
  E2A8    00             C      	nop
  E2A9    10 FA          C      	djnz	diords
  E2AB    3E B5          C      	ld	a,10110101b	;b5/b1
  E2AC                   C      diom10	equ	$-1
  E2AD    D3 04          C      	out	(flcoad),a	;Mark reset, Lesen 1
  E2AF    3A E208        C      	ld	a,(diom01)	;85/81 MFM; 87/83 FM
  E2B2    D3 04          C      	out	(flcoad),a	;Markenerkennung ein
  E2B4    01 A002        C      	ld	bc,160*256+fldabd ; maximal 160*43/(256*9600)=2.8ms
                         C      ; d.h. 43 (5"FM), 87 (5"MFM, 8"FM), 175 (8"MFM) Bytes Luecke abwarten
  E2B7    DB 06          C      spi4: 	in	a,(flcobd)	; auf Marke warten
  E2B9    E6 02          C      	and	2
                         C       IF fdc eq f1715
  E2BB    20 04          C      	jr	nz,spi5		;Marke ist da
                         C       ENDIF
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-82


  E2BD    10 F8          C      	djnz	spi4
  E2BF    18 CF          C      	jr	dioign		; Datenmarke nicht gefunden
                         C      
  E2C1    06 A1          C      spi5:	ld	b,0a1h
  E2C3    DB 02          C      diorkl:	in	a,(fldabd)	; Sync. A1 ueberlesen
  E2C5    B8             C      	cp	b
  E2C6    28 FB          C      	jr	z,diorkl
  E2C8    12             C      	ld	(de),a		;merken Datenbeginn-Byte
  E2C9    3E 01          C      	ld	a,1
  E2CA                   C      diosl1	equ	$-1		;Anzahl der 128er Bytes im Sektor
  E2CB    ED A2          C      diord1:	ini
  E2CD    06 7E          C       	ld	b,126
  E2CF    ED A2          C      diord2:	ini
                         C      ;folgener Befehl wird modifiziert:
                         C      ;*** bei 8" MFM: jp diord3
                         C      ;***     8" FM : call -> nop,nop,nop,nop,ret
                         C      ;***     5" MFM: wie 8" FM
                         C      ;***     5" FM : nop,nop,nop,nop, nop,nop,nop,nop,ret
  E2D1    CD E346        C      diomrw:	call	diowt1
  E2D4    20 F9          C      diord3:	jr	nz,diord2
  E2D6    ED A2          C      	ini
  E2D8    3D             C      	dec	a
  E2D9    20 F0          C      	jr	nz,diord1
  E2DB    EB             C      	ex	de,hl		; CRC-Adresse holen
  E2DC    23             C      	inc	hl
  E2DD    ED A2          C      	ini			; CRC lesen
  E2DF    ED A2          C      	ini
  E2E1    EB             C      	ex	de,hl		; neue CRC-Adresse zurueck
                         C      
  E2E2    DB 02          C      	in	a,(fldabd)
  E2E4    06 04          C      	ld	b,5-1		;Lesen beendet
                         C      
  E2E6    3E B5          C      dioend:	ld	a,10110101b	;b5/b1
  E2E7                   C      diom11	equ	$-1
  E2E8    D3 04          C      	out	(flcoad),a	;Lesen 1
  E2EA    3E 03          C      	ld	a,3
  E2EC    D3 07          C      	out	(flcobc),a	;erneuten Interrupt verbieten
  E2EE    04             C      	inc	b		;Stellen nz-Flag
  E2EF    FB             C      	ei
  E2F0    ED 4D          C      	reti
                         C      
                         C       IF @write
                         C      ; Es muss zuerst Datenbyte ausgegeben werden, dann Markenschreiben ein/aus!!
                         C      
                         C       IF dsk8fm+dsk8mf+dsk5fm
                         C       ENDIF
                         C      
                         C      ; Schreiben MFM
                         C      ;--------------
  E2F2    DB 02          C      diwmfm:	in	a,(fldabd)	; Gap ueberlesen
  E2F4    DB 02          C      	in	a,(fldabd)
  E2F6    DB 02          C      	in	a,(fldabd)
  E2F8    01 0000        C      	ld	bc,0*256+fldaad
  E2FB    DB 02          C      	in	a,(fldabd)
  E2FD    3E B4          C      	ld	a,10110100b	;b4/b0
  E2FE                   C      diom07	equ	$-1
  E2FF    D3 04          C      	out	(flcoad),a	; write enable
  E301    ED 41          C      	out	(c),b		;'00'
  E303    06 0B          C      	ld	b,11
  E305    AF             C      	xor	a
  E306    00             C      spo4:	nop
  E307    00             C      	nop
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-83


  E308    ED 79          C      	out	(c),a		;11*'00'
  E30A    10 FA          C      	djnz	spo4
  E30C    06 A1          C      	ld	b,0a1h		; 3 x Sync. A1 schreiben
  E30E    3E B6          C      	ld	a,10110110b
  E30F                   C      diom08	equ	$-1		;b6/b2
  E310    ED 41          C      	out	(c),b		;'A1'
  E312    D3 04          C      	out	(flcoad),a	; Markenschreiben ein
  E314    3E B4          C      	ld	a,10110100b
  E315                   C      diom09	equ	$-1		;b4/b0
  E316    ED 41          C      	out	(c),b		;'A1'
  E318    ED 41          C      	out	(c),b		;'A1'
  E31A    EB             C      	ex	de,hl
  E31B    ED A3          C      	outi			;Daten-Am schreiben
  E31D    D3 04          C      	out	(flcoad),a	; Markenschreiben aus
  E31F    EB             C      	ex	de,hl
  E320    3E 01          C      	ld	a,1		;Anzahl der 128er Bloecke
  E321                   C      diosl2	equ	$-1
  E322    ED A3          C      diowr1:	outi
  E324    06 7E          C      diowrt:	ld	b,126
  E326    ED A3          C      diowr2:	outi
                         C      ;folgender Befehl wird modifiziert
                         C      ;*** siehe Datenlesen
  E328    CD E346        C      diomww:	call	diowt1
  E32B    20 F9          C      diowr3:	jr	nz,diowr2
  E32D    ED A3          C      	outi
  E32F    3D             C      	dec	a
  E330    20 F0          C      	jr	nz,diowr1
  E332    EB             C      	ex	de,hl
  E333    ED A3          C      	outi			; CRC schreiben
  E335    ED A3          C      	outi
  E337    EB             C      	ex	de,hl
  E338    AF             C      	xor	a
  E339    06 14          C      diowm1:	ld	b,20		;Anzahl der Nachsatz-Bytes
                         C      				;5" MFM/FM: 20; 8" MFM/FM: 2
  E33B    D3 00          C      diow00:	out	(fldaad),a
  E33D    00             C      	nop
  E33E    00             C      	nop
  E33F    10 FA          C      	djnz	diow00
  E341    06 05          C      	ld	b,6-1		;Schreiben Daten beendet
  E343    C3 E2E6        C      	jp	dioend
                         C      
                         C       ENDIF ;@write
                         C      
                         C      
                         C      ; Zeitverzoegerungen und M1-Zyklus-Absicherung
                         C       IF dsk5fm
                         C       ENDIF
  E346    00             C      diowt1:	nop
  E347    00             C      	nop
  E348    00             C      	nop
  E349    00             C      	nop
  E34A    C9             C      	ret
                                
                                 IF oss
                                 ENDIF
                                 IF em256
                                 ENDIF
                                 IF kes
                                 ENDIF
                                 IF raf
                                 ENDIF
                                
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-84


                         C      	include BIOPTIM		;Zeitgeber
                         C      ;*************************************************************
                         C      ;	Zeitgeberdienst, Version 10.05.88
                         C      ; BAB2 als Standard
                         C      ; - Tastatur im 25ms-Polling statt direkt ueber Interrupt wegen V.24
                         C      ; - Cursor fuer Bildschirm ueber 25ms-Zeittakt statt sofort
                         C      ; - zusaetzliche Laufwerksabschaltung ueber Zeittakt eingefuehrt
                         C      ;*************************************************************
                         C      
                         C       IF1
                         C       ENDIF
                         C      
                         C      ; 5ms/25ms an
  E34B    AF             C      tim5on:	xor	a
  E34C    32 D23A        C      	ld	(crtccn),a	;Flag "Timer aus" fuer Cursor wieder loeschen
  E34F    3E B1          C      	ld	a,10110001b
                         C      ;int./zeitg./vort.256/pos.flanke/naechst.zykl./keine zk/
                         C      ;	weiter/1
  E351    F3             C      tim5ot:	DI
  E352    D3 0B          C      	out	(sysctc+timctc),a
  E354    FB             C      	EI
  E355    C9             C      ret:	ret
                         C      
                         C      ; 5ms/25ms aus
  E356    21 D23A        C      tim5of:	ld	hl,crtccn
  E359    7E             C      	ld	a,(hl)
  E35A    36 FF          C      	ld	(hl),0ffh	;Setzen Flag "Timer aus" fuer Cursor
  E35C    B7             C      	or	a		;muss noch Cursor gesetzt werden?
  E35D    28 04          C      	jr	z,tincur	;nein
  E35F    3C             C      	inc	a		;war Flag "Timer aus"?
  E360    C4 D726        C      	call	nz,crtscp	;nein, Cursor setzen bevor Timer abgeschaltet
  E363                   C      tincur:
  E363    3E 31          C      	ld	a,00110001b
                         C      ;kein int./...
  E365    18 EA          C      	jr	tim5ot
                         C      
  E34B                   C      tim1on	equ	tim5on
  E356                   C      tim1of	equ	tim5of
                         C      
                         C      ; Interr.routine 5ms/25ms
  E367                   C      tim5it:
                         C       IF stpvar or monitor
  E367    22 E36F        C      	ld	(t5ihl),hl	;retten hl
  E36A    21 E7C8        C      	ld	hl,chksp	;Test auf haengende Spezialfktnen
  E36D    E5             C      	push	hl		;nach const-Aufruf in CTC-Interrupt
  E36E    21 0000        C      	ld	hl,0		;wiederherstellen hl
  E36F                   C      t5ihl	equ	$-2
                         C       ENDIF
  E371    ED 73 E3A4     C      	ld	(intsp),sp
  E375    31 F1E6        C      	ld	sp,intstk
  E378    F5             C      	push	af
  E379    E5             C      	push	hl
  E37A    D5             C      	push	de
  E37B    C5             C      	push	bc
  E37C    2A 0041        C      	ld	hl,(tim5cn)
  E37F    23             C      	inc	hl
  E380    22 0041        C      	ld	(tim5cn),hl
  E383    21 D23A        C      	ld	hl,crtccn
  E386    7E             C      	ld	a,(hl)
  E387    B7             C      	or	a		;verzoegertes Cursor-Setzen im Bildschirm?
  E388    28 04          C      	jr	z,tim5cu	;nein
  E38A    35             C      	dec	(hl)		;Zaehler -1
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-85


  E38B    CC D726        C      	call	z,crtscp	;abgelaufen, Cursor setzen
  E38E                   C      tim5cu:
  E38E    3E 00          C      	ld	a,0
  E38F                   C      tim1sc	equ	$-1
  E390    3C             C      	inc	a
  E391    FE 28          C      	cp	1000/25		;1 Sec um?
  E393    38 01          C      	jr	c,tim1s1	;nein
  E395    AF             C      	xor	a		;sonst wieder auf 0 und Z-Flag
  E396    32 E38F        C      tim1s1:	ld	(tim1sc),a
  E399    CC E3A9        C      	call	z,tim1up	; 1s Interrupt simulieren
  E39C    CD D314        C      intkbd:	call	kbdsti		;Tastatur abfragen und puffern
  E39F                   C      intrbc:				;allg. Interr.-ausgang
  E39F    C1             C      	pop	bc
  E3A0    D1             C      	pop	de
  E3A1                   C      intrhl:				;allg. Interr.-ausgang
  E3A1    E1             C      	pop	hl
  E3A2                   C      intraf:				;allg. Interr.-ausgang
  E3A2    F1             C      	pop	af
  E3A3    31 0000        C      	ld	sp,0
  E3A4                   C      intsp	equ	$-2
  E3A6                   C      intret:				;allg. Interr.-ausgang
  E3A6    FB             C      	ei
  E3A7    ED 4D          C      	reti
                         C      
                         C       .comment % bei PC1715 kein expliziter 1 sek Zeittakt
                         C      ; Interr.routine 1s
                         C      tim1it:	ld	(intsp),sp
                         C      	ld	sp,intstk
                         C      	push	af
                         C      	push	hl
                         C      	push	de
                         C      	push	bc
                         C      	call	tim1up
                         C      	jr	intrbc
                         C      %
                         C      
                         C      ; Reaktionsroutine fuer 1 sec Interrupt
  E3A9    2A 0043        C      tim1up:	ld	hl,(tim1cn)
  E3AC    2B             C      	dec	hl
  E3AD    22 0043        C      	ld	(tim1cn),hl
                         C       IF uhrvar
                         C       ENDIF
  E3B0    3A D23E        C      	ld	a,(synsem)
  E3B3    B7             C      	or	a		;const, conout ?
  E3B4    20 03          C      	jr	nz,tim1uu	;ja, keine asysnchronen Aktionen
                         C      
  E3B6    CD D44A        C      	call	lampen		;Aktualisierung Lampen
                         C      
                         C      ;;;	setbs			;Bildschirm zuschalten
                         C      
                         C       IF cpastz
                         C       ENDIF
                         C      
                         C       IF uhrvar
                         C       ENDIF
                         C      
                         C      ;;;	setram			;Bildschirm wieder abschalten
                         C      
  E3B9                   C      tim1uu:
                         C      ; zusaetzliche Laufwerksabschaltung ueber Zeittakt
  E3B9    3A E14A        C      	ld	a,(pretx+1)	;Motorabschaltung unterdrueckt?
  E3BC    B7             C      	or	a
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-86


  E3BD    28 0E          C      	jr	z,t1nmo1	;ja
  E3BF    3A E142        C      	ld	a,(fl.zto)	;pro Sekunde 5 Umdrehungen
  E3C2    D6 04          C      	sub	4		;noch >= 4* 200ms Zeit?
  E3C4    30 01          C      	jr	nc,t1nmo2	;ja
  E3C6    AF             C      	xor	a
  E3C7    32 E142        C      t1nmo2:	ld	(fl.zto),a
  E3CA    CC E158        C      	call	z,headup	;Ueberw.zeit abgelaufen -> Motor aus
  E3CD                   C      t1nmo1:
                         C      
  E3CD    2A 0045        C      	ld	hl,(tim1rt)	;Adresse der Nutzerroutine
  E3D0    E9             C      	jp	(hl)		;1-sec-Nutzerroutine ausfuehren, ret
                         C      
                                
                                 IF	monitor
                         C      	include BIOPMON		;BIOS-Monitor
                         C      ;***************************************************
                         C      ;	BIOS-MONITOR, Version 29.06.87
                         C      ; Angleich an ZSID Kommandos:
                         C      ; -Aenderung M[em]-Kommando in S[ubstitute]-Kommando
                         C      ; -Erweiterung um O(ut/In)-Kommando
                         C      ;  Oadr byte fuer out-Befehl
                         C      ;  Oadr <enter> fuer in-Befehl
                         C      ;***************************************************
  E3D1    ED 73 E65B     C      biosmc:	ld	(moldsp),sp	;SP retten
  E3D5    31 E65B        C      	ld	sp,mstack
  E3D8    FD E5          C      	push	iy
  E3DA    DD E5          C      	push	ix
  E3DC    E5             C      	push	hl
  E3DD    D5             C      	push	de
  E3DE    C5             C      	push	bc
  E3DF    F5             C      	push	af
  E3E0    21 D23D        C      	ld	hl,synflg
  E3E3    CB CE          C      	set	monact,(hl)
  E3E5    CD D3B1        C      	call	kbdbcl		;Tastatur-Puffer loeschen
  E3E8    2A E65B        C      	ld	hl,(moldsp)	;Monitor-Aufrufstelle
  E3EB    23             C      	inc	hl
  E3EC    23             C      	inc	hl
  E3ED    11 E68A        C      	ld	de,mvtxt1
  E3F0    CD E5DA        C      	call	mareco		;rueckkonvertieren
  E3F3    21 E65F        C      	ld	hl,mtxt1
  E3F6    CD E898        C      	call 	putmes		;ausgeben MTXT1
                         C      ;
  E3F9    21 E6B5        C      mzykl1:	ld	hl,mtxt3	;MONITOR-Grundschleife
  E3FC    CD E898        C      mzykl2:	call	putmes		;ausgeben '*'
  E3FF    CD E578        C      	call	mconio		;Einlesen Steuerzeichen
  E402    FE 2D          C      	cp	2dh		;"-" ? (wuerde zu RET)
  E404    CA E530        C      	jp	z,merr		;ja: Eingabefehler
  E407    E6 5F          C      	and	5fh		;Grossbuchstabe	
                         C      ;
  E409    FE 43          C      mcal:	cp	'C'		;CALL ?
  E40B    20 0C          C      	jr	nz,mmem		;nein
  E40D    CD E536        C      	call	mraddr		;Einlesen Adresse
  E410    DA E530        C      	jp	c,merr		;Eingabefehler
  E413    21 E3F9        C      	ld	hl,mzykl1	;Ruecksprungadresse
  E416    E5             C      	push	hl		;ins Stack
  E417    EB             C      	ex	de,hl		;und Aufruf
  E418    E9             C      	jp	(hl)		;des UP
                         C      ;
  E419    FE 53          C      mmem:	cp	'S'		;SUBSTITUTE ?
  E41B    20 4C          C      	jr	nz,mnmem	;nein
  E41D    CD E536        C      	call	mraddr		;Einlesen Adresse
  E420    DA E530        C      	jp	c,merr		;Eingabefehler
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-87


  E423    EB             C      mmem1:	ex	de,hl
  E424    7E             C      mmem5:	ld	a,(hl)
  E425    FE 20          C      	cp	' '
  E427    38 04          C      	jr	c,mmem2
  E429    FE 7F          C      	cp	7fh
  E42B    38 02          C      	jr	c,mmem3
  E42D    3E 20          C      mmem2:	ld	a,' '		;kein ASCII-Zeichen
  E42F    32 E71C        C      mmem3:	ld	(mmtxt+11),a	;Byte als Zeichen z.Ausgabe
  E432    E5             C      	push	hl		;Adresse retten
  E433    11 E719        C      	ld	de,mmtxt+8
  E436    7E             C      	ld	a,(hl)		;urspruengliches Zeichen
  E437    CD E8B3        C      	call	mrecoa
  E43A    21 0000        C      	ld	hl,0
  E43D    39             C      	add	hl,sp		;HL:=SP
  E43E    11 E714        C      	ld	de,mmtxt+3
  E441    CD E5DA        C      	call	mareco		;Adr.rueckkonvertieren
  E444    21 E711        C      	ld	hl,mmtxt
  E447    CD E898        C      	call	putmes		;Ausgabe
  E44A    CD E536        C      	call	mraddr		;Einlesen Byte
  E44D    E1             C      	pop	hl		;Adresse des Bytes
  E44E    38 0D          C      	jr	c,mmem6		;Sonderzeichen/Eing.fehler
  E450    FE 0D          C      	cp	0dh		;RET ?
  E452    28 06          C      	jr	z,mmem4		;ja, keine Aenderung
  E454    3E 02          C      	ld	a,2
  E456    B8             C      	cp	b		;b>2 ?
  E457    38 CA          C      	jr	c,mmem1		;ja, DE ist neue Adresse
  E459    73             C      	ld	(hl),e		;sonst Byte eintragen
  E45A    23             C      mmem4:	inc	hl
  E45B    18 C7          C      	jr	mmem5
  E45D    FE 2E          C      mmem6:	cp	'.'		;Punkt ?
  E45F    28 98          C      	jr	z,mzykl1	;ja, MEM Ende
  E461    FE 2D          C      	cp	'-'		;Minus ?
  E463    C2 E530        C      	jp	nz,merr		;nein: Eingabefehler
  E466    2B             C      	dec	hl		;sonst Adr.dekrem.
  E467    18 BB          C      	jr	mmem5
  E469                   C      mnmem:
                         C      
  E469    FE 4F          C      mout:	cp	'O'		;OUT/IN ?
  E46B    20 27          C      	jr	nz,mnout	;nein
  E46D    CD E536        C      	call	mraddr		;port
  E470    DA E530        C      	jp	c,merr		;Eingabefehler
  E473    D5             C      	push	de
  E474    CD E536        C      	call	mraddr		;bei out Byte holen
  E477    C1             C      	pop	bc		;auch high(port) gestellt!
  E478    DA E530        C      	jp	c,merr
  E47B    FE 0D          C      	cp	0dh		;Leereingabe?
  E47D    28 04          C      	jr	z,min		;ja, IN-Befehl
  E47F    ED 59          C      	out	(c),e
  E481    18 0E          C      	jr	moute
  E483    ED 78          C      min:	in	a,(c)
  E485    11 E724        C      	ld	de,minbyt
  E488    CD E8B3        C      	call	mrecoa
  E48B    21 E722        C      	ld	hl,mintxt
  E48E    CD E898        C      	call	putmes
  E491    C3 E3F9        C      moute:	jp	mzykl1
  E494                   C      mnout:
                         C      
                         C      	IF	mprot
                         C      	ENDIF
                         C      
                         C      ;
  E494    FE 54          C      mtim:	cp	'T'		;TIMER ?
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-88


  E496    20 2C          C      	jr	nz,mreg
  E498    CD E578        C      	call	mconio
  E49B    FE 35          C      	cp	'5'		;5 ms ?
  E49D    21 0000        C      	ld	hl,0
  E4A0    28 07          C      	jr	z,mt1
  E4A2    FE 31          C      	cp	'1'		;1 sec ?
  E4A4    2E 06          C      	ld	l,6
  E4A6    C2 E530        C      	jp	nz,merr		;nein: Fehler
  E4A9    CD E578        C      mt1:	call	mconio
  E4AC    FE 0D          C      	cp	0dh		;RETURN ?
  E4AE    11 0000        C      	ld	de,0
  E4B1    28 07          C      	jr	z,mt2
  E4B3    FE 2D          C      	cp	'-'		;Minus ?
  E4B5    1E 03          C      	ld	e,3
  E4B7    C2 E530        C      	jp	nz,merr		;nein: Fehler
  E4BA    19             C      mt2:	add	hl,de
  E4BB    11 D2C8        C      	ld	de,cpmx03	;im erw.Sprungvektor 
  E4BE    19             C      	add	hl,de
  E4BF    11 E3F9        C      	ld	de,mzykl1	;Rueckspr.adresse
  E4C2    D5             C      	push	de		;ins Stack
  E4C3    E9             C      	jp	(hl)
                         C      ;
  E4C4    FE 52          C      mreg:	cp	'R'		;REG ?
  E4C6    20 23          C      	jr	nz,mhelp
  E4C8    21 E6B9        C      	ld	hl,mrtxt1
  E4CB    CD E898        C      	call	putmes		;Ausgeben 1.Zeile
  E4CE    0E 07          C      	ld	c,7
  E4D0    21 E64D        C      	ld	hl,mstckr-2
  E4D3    11 E6D8        C      	ld	de,mrtx21
  E4D6    23             C      mreg1:	inc	hl
  E4D7    23             C      	inc	hl
  E4D8    13             C      	inc	de
  E4D9    13             C      	inc	de
  E4DA    13             C      	inc	de
  E4DB    13             C      	inc	de
  E4DC    CD E5DA        C      	call	mareco		;Rueckkonv.Doppelregister
  E4DF    0D             C      	dec	c
  E4E0    20 F4          C      	jr	nz,mreg1
  E4E2    21 E6D6        C      	ld	hl,mrtxt2
  E4E5    CD E898        C      	call	putmes		;Ausgeben 2.Zeile
  E4E8    C3 E3F9        C      	jp	mzykl1
                         C      ;
  E4EB    FE 48          C      mhelp:	cp	'H'		;HELP ?
  E4ED    20 25          C      	jr	nz,met1
  E4EF    CD E536        C      	call	mraddr		;Zahl lesen/konvertieren
  E4F2    DA E530        C      	jp	c,merr		;CY: keine Zahl
  E4F5    EB             C      	ex	de,hl		;HL:=Zahl
  E4F6    CD E5E5        C      	call	mhldec		;dezimal ausgeben
  E4F9    7C             C      	ld	a,h
  E4FA    B7             C      	or	a		;nur ein Byte ?
  E4FB    20 14          C      	jr	nz,mh1		;nein: raus
  E4FD    7D             C      	ld	a,l		;sonst
  E4FE    E6 7F          C      	and	7fh		; hoechstes Bit wegschneiden
  E500    FE 7F          C      	cp	7fh		; und
  E502    30 0D          C      	jr	nc,mh1		; Ausgebbarkeit als
  E504    FE 20          C      	cp	20h		; Zeichen pruefen
  E506    38 09          C      	jr	c,mh1		
  E508    32 E720        C      	ld	(mhtxt+1),a
  E50B    21 E71F        C      	ld	hl,mhtxt
  E50E    CD E898        C      	call	putmes		;Zeichen ausgeben
  E511    C3 E3F9        C      mh1:	jp	mzykl1
                         C      ;
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-89


  E514    FE 0D          C      met1:	cp	0dh		;RETURN ?
  E516    20 18          C      	jr	nz,merr		;nein: also unzulaessig
  E518    21 E6A9        C      	ld	hl,mtxt2
  E51B    CD E898        C      	call	putmes
  E51E    21 D23D        C      	ld	hl,synflg
  E521    CB 8E          C      	res	monact,(hl)	;Monitor-Ende vermerken
  E523    F1             C      	pop	af
  E524    C1             C      	pop	bc
  E525    D1             C      	pop	de
  E526    E1             C      	pop	hl
  E527    DD E1          C      	pop	ix
  E529    FD E1          C      	pop     iy   
  E52B    ED 7B E65B     C      	ld	sp,(moldsp)
  E52F    C9             C      	ret
                         C      ;
                         C      ;----------------------------------------------------------
                         C      ;Fehlerreaktion
                         C      ;
  E530    21 E6B3        C      merr:	ld	hl,merrtx
  E533    C3 E3FC        C      	jp	mzykl2
                         C      ;-----------------------------------------------------------
                         C      ;
                         C      ;Eingeben 0..4 Hex-Ziffern von Konsole; Konvertieren
                         C      ;RET: NC - o.k.; CY - unzulaessiges Zeichen
                         C      ;     A: erstes eingegebenes Zeichen
                         C      ;     B: Anzahl der Zeichen
                         C      ;     DE: Ergebnis
  E536    21 E72A        C      mraddr:	ld	hl,mtad2-1
  E539    06 05          C      	ld	b,5		;max. 5 Zeichen lesen
  E53B    CD E578        C      mra1:	call	mconio		;Einlesen Zeichen
  E53E    FE 7F          C      	cp	7fh		;DELETE ?
  E540    20 0A          C      	jr	nz,mra2
  E542    2B             C      	dec	hl
  E543    04             C      	inc	b
  E544    3E 05          C      	ld	a,5
  E546    B8             C      	cp	b		;B>5 ?
  E547    DA E530        C      	jp	c,merr		;ja: Fehler
  E54A    18 EF          C      	jr	mra1
  E54C    23             C      mra2:	inc	hl
  E54D    FE 61          C      	cp	'a'		;kleiner Buchstabe ?
  E54F    38 02          C      	jr	c,mra3		;nein
  E551    E6 5F          C      	and	5fh		;klein => gross
  E553    77             C      mra3:	ld	(hl),a
  E554    FE 0D          C      	cp	0dh		;RETURN ?
  E556    28 09          C      	jr	z,mra4
  E558    FE 20          C      	cp	' '		;Blank ?
  E55A    28 05          C      	jr	z,mra4
  E55C    10 DD          C      	djnz	mra1
  E55E    37             C      	scf			;Fehler: 5.Zeichen
  E55F    18 13          C      	jr	mraret
  E561    3E 05          C      mra4:	ld	a,5
  E563    90             C      	sub	b
  E564    47             C      	ld	b,a		;b: Anz.eingeg.Zeichen
  E565    11 0004        C      	ld	de,mltad1
  E568    ED 52          C      	sbc	hl,de		;HL auf MTAD1+Versatz
  E56A    CD E5AF        C      	call	mconv2		;Konvertieren 1.Byte
  E56D    38 05          C      	jr	c,mraret	;CY: unzul.Zeichen
  E56F    57             C      	ld	d,a		;sonst H-Teil nach D
  E570    CD E5AF        C      	call	mconv2		;Konvertieren 2.Byte
                         C         ;hier keine Pruefung auf unzulaessiges Zeichen:
                         C         ;CY wird durchgereicht
  E573    5F             C      	ld	e,a		;L-Teil nach E
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-90


  E574    3A E72B        C      mraret:	ld	a,(mtad2)	;A:=1.Zeichen
  E577    C9             C      	ret
                         C      ;
                         C      ;----------------------------------------------------------
                         C      ;
                         C      ;Einlesen und Ausgeben 1 Zeichen ueber Konsole
                         C      ;RET: A - Zeichen (DEL fuer DEL,CAN,BACKSP;
                         C      ;		   alle sonstigen Steuerz. werden ignoriert)
  E578    C5             C      mconio:	push	bc
  E579    D5             C      	push	de
  E57A    E5             C      	push	hl
  E57B    CD E73C        C      mcio1:	call	conin
  E57E    FE 18          C      	cp	18h		;CANCEL ?
  E580    28 1A          C      	jr	z,mcio4
  E582    FE 7F          C      	cp	7fh		;DELETE ?
  E584    28 16          C      	jr	z,mcio4
  E586    FE 08          C      	cp	08h		;BACKSPACE ?
  E588    28 12          C      	jr	z,mcio4
  E58A    FE 0D          C      	cp	0dh		;RETURN ?
  E58C    28 19          C      	jr	z,mcio5
  E58E    FE 20          C      	cp	20h		;sonstiges Steuerzeichen ?
  E590    38 E9          C      	jr	c,mcio1		;ja: ignorieren
  E592    4F             C      	ld	c,a
  E593    F5             C      mcio2:	push	af
  E594    CD D20C        C      	call	conol		;Echo
  E597    F1             C      mcio3:	pop	af
  E598    E1             C      	pop	hl
  E599    D1             C      	pop	de
  E59A    C1             C      	pop	bc
  E59B    C9             C      	ret
  E59C    21 E5AB        C      mcio4:	ld	hl,mciodel
  E59F    3E 7F          C      	ld	a,7fh
  E5A1    F5             C      	push	af		;A retten
  E5A2    CD E898        C      	call	putmes		;Sonderzeichen ausgeben
  E5A5    18 F0          C      	jr	mcio3
  E5A7    0E 20          C      mcio5:	ld	c,' '
  E5A9    18 E8          C      	jr	mcio2
                         C      ;
  E5AB    08 20 08 00    C      mciodel:db	08h,' ',08h,0;
                         C      ;
                         C      ;-----------------------------------------------------------
                         C      ;
                         C      ;Konvertieren 2 HEX-Ziffern ab (HL)
                         C      ;RET: NC - o.k.; C - keine HEX-Ziffer
                         C      ;     A  - Binaerzahl; HL zeigt auf naechstes Byte
  E5AF    7E             C      mconv2:	ld	a,(hl)
  E5B0    CD E5C5        C      	call	mconv
  E5B3    D8             C      	ret	c		;keine Hex-Ziffer
  E5B4    C5             C      	push	bc
  E5B5    07             C      	rlca			;linkes Halbbyte
  E5B6    07             C      	rlca
  E5B7    07             C      	rlca
  E5B8    07             C      	rlca
  E5B9    47             C      	ld	b,a
  E5BA    23             C      	inc	hl
  E5BB    7E             C      	ld	a,(hl)
  E5BC    CD E5C5        C      	call	mconv
  E5BF    38 02          C      	jr	c,mc2r	 	;keine Hex-Ziffer
  E5C1    B0             C      	or	b		;rechtes Halbbyte
  E5C2    23             C      	inc	hl
  E5C3    C1             C      mc2r:	pop	bc
  E5C4    C9             C      	ret
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-91


                         C      ;
                         C      ;------------------------------------------------------------
                         C      ;
                         C      ;Konvertieren HEX-Ziffer in A
                         C      ;RET: NC - o.k.; C - keine HEX-Ziffer
  E5C5    FE 30          C      mconv:	cp	'0'		;<A> < '0' ?
  E5C7    D8             C      	ret	c		;ja
  E5C8    FE 3A          C      	cp	'9'+1		;<A> > '9' ?
  E5CA    38 09          C      	jr	c,mconvd	;nein
  E5CC    FE 41          C      	cp	'A'		;<A> < 'A' ?
  E5CE    D8             C      	ret	c		;ja
  E5CF    FE 47          C      	cp	'F'+1		;<A> > 'F' ?
  E5D1    30 05          C      	jr	nc,mconve	;ja
  E5D3    D6 07          C      	sub	7		;'A'-7 => 10
  E5D5    E6 0F          C      mconvd:	and	0fh		;nur rechtes Halbbyte
  E5D7    C9             C      	ret
  E5D8    37             C      mconve:	scf			;Fehler
  E5D9    C9             C      	ret
                         C      ;
                         C      ;--------------------------------------------------------------
                         C      
                         C      ; Rueckkonvertieren Adresse ab (HL) nach (DE)
                         C      ; RET: 4 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
                         C      ;      C,HL unveraendert
  E5DA    06 02          C      mareco:	ld	b,2
  E5DC    23             C      	inc	hl
  E5DD    CD E8B2        C      marec1:	call	mbreco
  E5E0    2B             C      	dec	hl
  E5E1    10 FA          C      	djnz	marec1
  E5E3    23             C      	inc	hl		;HL wiederherstellen
  E5E4    C9             C      	ret
                         C      
                         C      ;
                         C      ; HL dezimal auf Konsole ausgeben
                         C      ; HL bleibt erhalten
                         C      
  E5E5    E5             C      mhldec:	push	hl
  E5E6    0E 00          C      	ld	c,0		;bisher nur fuehrende Nullen
  E5E8    11 D8F0        C      	ld	de,-10000
  E5EB    CD E606        C      	call	mhsub		;Zehntausender
  E5EE    11 FC18        C      	ld	de,-1000
  E5F1    CD E606        C      	call	mhsub		;Tausender
  E5F4    11 FF9C        C      	ld	de,-100
  E5F7    CD E606        C      	call	mhsub		;Hunderter
  E5FA    11 FFF6        C      	ld	de,-10
  E5FD    CD E606        C      	call	mhsub		;Zehner
  E600    7D             C      	ld	a,l
  E601    F6 30          C      	or	'0'
  E603    E1             C      	pop	hl
  E604    18 04          C      	jr	mcono		;Einer (auch wenn Null)
                         C      
  E606    CD E8C9        C      mhsub:	call	mhldig
  E609    C8             C      	ret	z		;fuehrende Null
  E60A    C5             C      mcono:	push	bc
  E60B    E5             C      	push	hl
  E60C    4F             C      	ld	c,a
  E60D    CD D20C        C      	call	conol
  E610    E1             C      	pop	hl
  E611    C1             C      	pop	bc
  E612    C9             C      	ret
                         C      ;
                         C      ;--------------------------------------------------------------
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-92


                         C      ;
                         C      ; Arbeitsfelder:
                         C      ;===============
  E613                   C      mstcke:	ds	30*2,0		;freier Stack-Bereich
  E64F                   C      mstckr:	ds	6*2,0		;Rettungsbereich Nutzerreg.
  E65B                   C      mstack:
  E65B                   C      moldsp:	ds	2,0		;fuer alten SP-Stand
  E65D    E64F           C      mrreg:	dw	mstckr		;Adr. Reg.rettb. fuer R-Komm.
  E65F    0D 0A 42 49    C      mtxt1:	db	0dh,0ah,'BIOS-Version '
  E663    4F 53 2D 56    C      
  E667    65 72 73 69    C      
  E66B    6F 6E 20       C      
                         C      	version
  E66E    32 34          C+     	db	'24'
  E670    2E             C+     	db	'.'
  E671    30 35          C+     	db	'05'
  E673    2E             C+     	db	'.'
  E674    38 38          C+     	db	'88'
  E676    3B 20 4D 4F    C      	db	'; MONITOR called at '
  E67A    4E 49 54 4F    C      
  E67E    52 20 63 61    C      
  E682    6C 6C 65 64    C      
  E686    20 61 74 20    C      
  E68A    20 20 20 20    C      mvtxt1:	db	'     - Type C,H,O'
  E68E    20 2D 20 54    C      
  E692    79 70 65 20    C      
  E696    43 2C 48 2C    C      
  E69A    4F             C      
                         C       IF mprot
                         C       ENDIF
  E69B    2C 52 2C 53    C      	db	',R,S,T, or ET',0
  E69F    2C 54 2C 20    C      
  E6A3    6F 72 20 45    C      
  E6A7    54 00          C      
  E6A9    08 52 45 54    C      mtxt2:	db	08h,'RETURN',0dh,0ah,0
  E6AD    55 52 4E 0D    C      
  E6B1    0A 00          C      
  E6B3    20 3F          C      merrtx: db	' ?'
  E6B5    0D 0A 2A 00    C      mtxt3:	db	0dh,0ah,'*',0
  E6B9    20 52 65 67    C      mrtxt1:	db	' Registers saved at '
  E6BD    69 73 74 65    C      
  E6C1    72 73 20 73    C      
  E6C5    61 76 65 64    C      
  E6C9    20 61 74 20    C      
                         C      	hexout	mstckr
  0010                   C+     	.RADIX	16
  E6CD    30 45 36 34    C+     	db	'0E64F','H'
  E6D1    46 48          C+     
  000A                   C+     	.RADIX	10
  E6D3    0D 0A 00       C      	db	0dh,0ah,0
  E6D6    20 20          C      mrtxt2:	db	'  '
  E6D8    20 41 46 3D    C      mrtx21:	db	' AF=0000 BC=0000 DE=0000'
  E6DC    30 30 30 30    C      
  E6E0    20 42 43 3D    C      
  E6E4    30 30 30 30    C      
  E6E8    20 44 45 3D    C      
  E6EC    30 30 30 30    C      
  E6F0    20 48 4C 3D    C      	db	' HL=0000 IX=0000 IY=0000 SP=0000',0
  E6F4    30 30 30 30    C      
  E6F8    20 49 58 3D    C      
  E6FC    30 30 30 30    C      
  E700    20 49 59 3D    C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-93


  E704    30 30 30 30    C      
  E708    20 53 50 3D    C      
  E70C    30 30 30 30    C      
  E710    00             C      
  E711    0D 0A 20 20    C      mmtxt:	db	0dh,0ah,'           ',0
  E715    20 20 20 20    C      
  E719    20 20 20 20    C      
  E71D    20 00          C      
  E71F    20 20 00       C      mhtxt:	db	'  ',0
  E722    3A 20          C      mintxt:	db	': '
  E724    58 58 00       C      minbyt:	db	'XX',0
  E727    30 30 30 30    C      mtad1:	db	'0000'		;falls n<4 Zeichen
  0004                   C      mltad1	equ	$-mtad1		;Laenge MTAD1
  E72B    30 30 30 30    C      mtad2:	db	'00000'		;Eingabepuffer
  E72F    30             C      
                                 ENDIF
                                
                         C      	include BIOPNUC		;zentrale BIOS-Komponenten
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      ; Zentrale BIOS-Kompenenten, Version 20.04.88
                         C      ; - rst 38h fuehrt bei Monitor zu seinem Aufruf, sonst Warmstart
                         C      ; - Nachladen CCP aus RAM-Floppy vereinheitlicht (unabh. von RAM-Floppy)
                         C      ; - synflg hinter BIOS-Sprungvektor fuer Modifizierung von aussen
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      
                         C       IF iobvar
                         C      ;Verteiler fuer die 1-Zeichen-Kanaele entsprechend IOBYTE:
                         C      ;=========================================================
                         C      
  E730                   C      const:			; iobyte  00 00 00 xx
  E730    CD E790        C      	call	iodisp
  E733    07             C      	db	7
  E734    D30C           C      	dw	kbdst		;0 kbd:
  E736    D30C           C      	dw	kbdst		;1 kbd:
  E738    E754           C      	dw	reades		;2 rdr:
  E73A    D8CB           C      	dw	uc1st		;3 uc1: (liefert, ob Z. da)
                         C      
  E73C                   C      conin:			; iobyte:  00 00 00 xx
  E73C    CD E790        C      	call	iodisp
  E73F    07             C      	db	7
  E740    D3BB           C      	dw	kbdi		;0 kbd:
  E742    D3BB           C      	dw	kbdi		;1 kbd:
  E744    E760           C      	dw	reader		;2 rdr:
  E746    D8F1           C      	dw	uc1i		;3 uc1: (wartet, bis Z. da)
                         C      
  E748                   C      conout:			; iobyte:  00 00 00 xx
  E748    CD E790        C      	call	iodisp
  E74B    07             C      	db	7
  E74C    D51E           C      	dw	crto		;0 crt:
  E74E    D2EF           C      	dw	dumo		;1 dum:
  E750    E76C           C      	dw	punch		;2 pun:
  E752    D7BF           C      	dw	uc1o		;3 uc1: (wartet, bis frei)
                         C      
  E754                   C      reades:			; iobyte:   00 00 xx 00
  E754    CD E790        C      	call	iodisp
  E757    01             C      	db	1
  E758    D30C           C      	dw	kbdst		;0 kbd:
  E75A    D2E9           C      	dw	dumst		;1 dum:
  E75C    D2E9           C      	dw	dumst		;2 dum:
  E75E    D8CB           C      	dw	uc1st		;3 uc1: (liefert, ob Z. da)
                         C      
  E760                   C      reader:			; iobyte:   00 00 xx 00
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-94


  E760    CD E790        C      	call	iodisp
  E763    01             C      	db	1
  E764    D3BB           C      	dw	kbdi		;0 kbd:
  E766    D2EC           C      	dw	dumi		;1 dum:
  E768    D2EC           C      	dw	dumi		;2 dum:
  E76A    D8F1           C      	dw	uc1i		;3 uc1: (wartet, bis Z. da)
                         C      
                         C      
  E76C                   C      punch:			; iobyte:   00 xx 00 00
  E76C    CD E790        C      	call	iodisp
  E76F    03             C      	db	3
  E770    D51E           C      	dw	crto		;0 crt:
  E772    D2EF           C      	dw	dumo		;1 dum:
  E774    E784           C      	dw	list		;2 lst:
  E776    D7BF           C      	dw	uc1o		;3 uc1: (wartet, bis frei)
                         C      
                         C      
  E778                   C      listst:			; iobyte:  xx 00 00 00
  E778    CD E790        C      	call	iodisp
  E77B    05             C      	db	5
  E77C    D7F0           C      	dw	ttyst		;0 tty:
  E77E    D2E9           C      	dw	crtst		;1 crt:
  E780    D2E9           C      	dw	lptst		;2 lpt:
  E782    D2E9           C      	dw	dumst		;3 dum:
                         C      
  E784                   C      list:			; iobyte:  xx 00 00 00
  E784    CD E790        C      	call	iodisp
  E787    05             C      	db	5
  E788    D7B9           C      	dw	ttyo		;0 tty:
  E78A    D51E           C      	dw	crto		;1 crt:
  E78C    D2EF           C      	dw	lpto		;2 lpt:
  E78E    D2EF           C      	dw	dumo		;3 dum:
                         C      
                         C      
                         C      ; IOBYTE-Auswertung - Verteilung auf die physischen Geraete
                         C      ; ---------------------------------------------------------
                         C      ; A,HL werden zerstoert
                         C      ; Anwender-IX wird gerettet, darf von Treiber-Routine zerstoert werden
                         C      ; damit kann Treiber auch aus Interrupt-Routine aufgerufen werden
                         C      
  E790                   C      iodisp:
  E790    E1             C      	pop	hl
  E791    C5             C      	push	bc
  E792    46             C      	ld	b,(hl)
  E793    23             C      	inc	hl
  E794    3A 0003        C      	ld	a,(iobyte)
  E797    0F             C      iodis1:	rrca
  E798    10 FD          C      	djnz	iodis1
  E79A    E6 06          C      	and	6
  E79C    4F             C      	ld	c,a
  E79D    09             C      	add	hl,bc
  E79E    7E             C      	ld	a,(hl)
  E79F    23             C      	inc	hl
  E7A0    66             C      	ld	h,(hl)
  E7A1    6F             C      	ld	l,a
  E7A2    C1             C      	pop	bc
  E7A3    DD E5          C      	push	ix		;retten Anwender-IX
  E7A5    CD E897        C      	call	callhl
  E7A8    DD E1          C      	pop	ix		;wiederherstellen Anwender-IX
  E7AA    C9             C      	ret
                         C      
                         C       ENDIF
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-95


                         C      
                         C      ;************************************************************
                         C      ;	Spezialroutinen
                         C      ;************************************************************
                         C      
                         C      	IF	monitor
  E7AB    CD E3D1        C      moncal:	call	biosmc		;Monitor-Aufruf ueber Spr.vekt.
  E7AE    C9             C      	ret			;**kein jp biosmc wegen stack**
                         C      	ENDIF
                         C      
                         C      
                         C      ; Arbeit mit asynchronen Sonderaktionen
                         C      ;======================================
                         C      ; Die folgenden beiden Routinen werden vom BIOS immer dann aufgerufen,
                         C      ; wenn wegen zeitkritischer (z.B. Floppy-Bedienung) oder anderer
                         C      ; BIOS-Arbeit (z.B. Bildschirmrollen) keine parallelen Sonderaktionen
                         C      ; erlaubt sind.
                         C      
                         C      ; Reg A bleibt erhalten
  E7AF    F5             C      delsps:	push	af
  E7B0    2A 004A        C      	ld	hl,(kritbg)	;evtl. Nutzerroutine fuer Beginn krit. BIOS
  E7B3    CD E897        C      	call	callhl		;aufrufen
  E7B6    F1             C      	pop	af
  E7B7    21 D23E        C      	ld	hl,synsem	;Verzoegern Sonderaktionen
  E7BA    34             C      	inc	(hl)
  E7BB    C9             C      	ret			
                         C      
                         C      ; Reg A bleibt erhalten
  E7BC    F5             C      delspr:	push	af
  E7BD    2A 004C        C      	ld	hl,(kriten)	;evtl. Nutzerroutine fuer Ende krit. BIOS
  E7C0    CD E897        C      	call	callhl		;aufrufen
  E7C3    F1             C      	pop	af
  E7C4    21 D23E        C      	ld	hl,synsem	;Zulassen Sonderaktionen
  E7C7    35             C      	dec	(hl)
                         C      
                         C       IF stpvar or monitor
                         C      
                         C      ; Test auf zwischenzeitliche Anforderung von Sonderroutinen
                         C      ;----------------------------------------------------------
                         C      
                         C      ; Diese Routine wird nach dem Lesen eines Tastaturzeichens
                         C      ; als "Ohr" eingeschoben, bevor zur eigentlichen Interrupt-
                         C      ; adresse zurueckgekehrt wird. Sie wird nicht innerhalb der
                         C      ; Interruptroutine ausgefuehrt, um mit offenen Interrupts
                         C      ; arbeiten zu koennen.
                         C      ; maximale Stackbelastung nach RETI von Interruptroutinen:
                         C      ; -	Return-Adresse zum Nutzer
                         C      ; -	AF
  E7C8    F3             C      chksp:	di
  E7C9    F5             C      	push	af		;A und F Reg retten
  E7CA    3A D23E        C      	ld	a,(synsem)
  E7CD    B7             C      	or	a		;asynchr. Routinen zugelassen?
  E7CE    C2 E7E5        C      	jp	nz,chkspx	;nein
  E7D1    3C             C      	inc	a		;weiteren Eintritt verhindern
  E7D2    32 D23E        C      	ld	(synsem),a
  E7D5    FB             C      chkspn:	ei
  E7D6    3A D23D        C      	ld	a,(synflg)	;inzw. (neue) Anforderung?
  0000                   C      rqmask	aset	0
                         C       IF monitor
  0020                   C      rqmask	aset	rqmask+(1 shl monrq)
                         C       ENDIF
                         C       IF stpvar
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-96


  0030                   C      rqmask	aset	rqmask+(1 shl stoprq)
                         C       IF chdvar
  0038                   C      rqmask	aset	rqmask+(1 shl synlrq)
                         C       ENDIF
                         C       ENDIF
  E7D9    E6 38          C       	and	rqmask
  E7DB    C2 E7E8        C      	jp	nz,chkspd	;ja, ausfuehren
  E7DE    3A D23E        C      	ld	a,(synsem)
  E7E1    3D             C      	dec	a
  E7E2    32 D23E        C      	ld	(synsem),a
  E7E5    F1             C      chkspx:	pop	af
  E7E6    FB             C      	ei
  E7E7    C9             C      	ret
                         C      
                         C      ; asynchrone Aktionen ausfuehren
  E7E8                   C      chkspd:
                         C       IF monitor
  E7E8    3A D23D        C      	ld	a,(synflg)
  E7EB    CB 6F          C      	bit	monrq,a		;inzwischen Monitor-Request?
  E7ED    28 0A          C      	jr	z,nmonsp	;nein
  E7EF    CB AF          C      	res	monrq,a
  E7F1    32 D23D        C      	ld	(synflg),a
  E7F4    F1             C      	pop	af		;alle Register wie Unterbr.zustand
  E7F5    CD E3D1        C      	call	biosmc
  E7F8    F5             C      	push	af
  E7F9                   C      nmonsp:
                         C       ENDIF
                         C      
                         C       IF stpvar
  E7F9    3A D23D        C      	ld	a,(synflg)
  E7FC    CB 67          C      	bit	stoprq,a	;inzwischen Stop-Forderung?
  E7FE    28 10          C      	jr	z,nstpsp	;nein
  E800    CB A7          C      	res	stoprq,a
  E802    32 D23D        C      	ld	(synflg),a
  E805    F1             C      	pop	af		;Nutzer-Stackbelastung verringern
  E806    22 E83E        C      	ld	(asynhl),hl	;HL freimachen
  E809    21 E841        C      	ld	hl,stoprt	;Routine
  E80C    CD E82A        C      	call	asynrt		;aufrufen mit eigenem Stack
  E80F    F5             C      	push	af
  E810                   C      nstpsp:
                         C      
                         C       IF chdvar
  E810    3A D23D        C      	ld	a,(synflg)
  E813    CB 5F          C      	bit	synlrq,a	;inzwischen LST:-Synchr.?
  E815    28 10          C      	jr	z,nsynlr	;nein
  E817    CB 9F          C      	res	synlrq,a
  E819    32 D23D        C      	ld	(synflg),a
  E81C    F1             C      	pop	af
  E81D    22 E83E        C      	ld	(asynhl),hl
  E820    21 D7FD        C      	ld	hl,lsynch
  E823    CD E82A        C      	call	asynrt
  E826    F5             C      	push	af
  E827                   C      nsynlr:
                         C       ENDIF
                         C       ENDIF	;stpvar
                         C      
  E827    C3 E7D5        C      	jp	chkspn		;Test auf neue Requests
                         C      
                         C       IF stpvar or chdvar
                         C      ; Asynchrone Routine (HL) mit eigenem Stack aufrufen
                         C      ;---------------------------------------------------
                         C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-97


  E82A    ED 73 E83B     C      asynrt:	ld	(asynsv),sp	;asynchr. Routinen haben
  E82E    31 F1CE        C      	ld	sp,stpstk	;ein eigenes Stack
  E831    F5             C      	push	af
  E832    D5             C      	push	de
  E833    C5             C      	push	bc
  E834    CD E897        C      	call	callhl		;Routine aufrufen
  E837    C1             C      	pop	bc
  E838    D1             C      	pop	de
  E839    F1             C      	pop	af
  E83A    31 0000        C      	ld	sp,0		;SP wiederherstellen
  E83B                   C      asynsv	equ	$-2
  E83D    21 0000        C      	ld	hl,0		;gerettetes hl wiederherst.
  E83E                   C      asynhl	equ	$-2
  E840    C9             C      	ret
                         C       ENDIF
                         C      
                         C       IF stpvar
                         C      ; Asynchrone Stop-Routine
                         C      ;------------------------
  E841    CD E158        C      stoprt:	call	headup		;Disk-Kopf abheben
  E844    CD D3B1        C      	call	kbdbcl		;Loeschen Tastaturpuffer
  E847    CD E881        C      stopz:	call	stpchp		;holen naechste phys. Taste
                         C      
                         C       IF umlaut
                         C       ENDIF
                         C      
                         C       IF chdvar
  E84A    FE FB          C      	cp	zblmin		;"- im Ziffernblock": Hardcopy BS -> LIST?
  E84C    CA D746        C      	jp	z,crthrd	;ja, ausfuehren
  E84F    FE CD          C      	cp	spcins		;"INS": I/O-Byte im LST:Kanal weiterschalten?
  E851    20 08          C      	jr	nz,stopz2	;nein
  E853    21 0003        C      	ld	hl,iobyte
  E856    7E             C      	ld	a,(hl)
  E857    C6 40          C      	add	a,40h		;Ueberlauf wird ignoriert
  E859    77             C      	ld	(hl),a
  E85A    C9             C      	ret
  E85B                   C      stopz2:
                         C      
                         C       IF l2bahn
                         C       ENDIF
                         C       ENDIF
                         C      
                         C       IF uhrvar
                         C       ENDIF
                         C      
                         C       IF costu
  E85B    FE 1B          C      	cp	1bh		;"ESC": Tastendefinition?
  E85D    20 1B          C      	jr	nz,stopz4	;nein
  E85F    4F             C      	ld	c,a
  E860    CD D51E        C      	call	crto		;1b (Escape-Folge einleiten)
  E863    CD D51E        C      	call	crto		;1b (Stringdef. einleiten)
  E866    CD E881        C      	call	stpchp		;naechste Taste physisch
  E869    18 06          C      	jr	stpz4b
  E86B    CD D51E        C      stpz4a:	call	crto		;1b/Taste/Stringzeichen
  E86E    CD E88E        C      	call	stopch		;Taste logisch
  E871    4F             C      stpz4b:	ld	c,a
  E872    D6 1B          C      	sub	1bh		;fertig?
  E874    20 F5          C      	jr	nz,stpz4a	;nein
  E876    4F             C      	ld	c,a		;00h
  E877    C3 D51E        C      	jp	crto
  E87A                   C      stopz4:
                         C       ENDIF
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-98


                         C      
  E87A    D6 C7          C      	sub	kcurpd		;"Page down": ^C ?
  E87C    C0             C      	ret	nz		;nein, Stop-Ende
  E87D    32 D23E        C      	ld	(synsem),a	;falls rst 0 nicht in BIOS fuehrt
  E880    C7             C      	rst	0		;sonst Warmstart
                         C      
                         C      ; Holen naechste Taste physisch
  E881    21 D23D        C      stpchp:	ld	hl,synflg
  E884    CB FE          C      	set	phyact,(hl)	;naechste Taste physisch
  E886    E5             C      	push	hl
  E887    CD E88E        C      	call	stopch		;holen naechstes Tastaturz.
  E88A    E1             C      	pop	hl
  E88B    CB BE          C      	res	phyact,(hl)	;physisches Lesen beendet
  E88D    C9             C      	ret
                         C      
                         C      ; Holen naechste Taste im Stopzustand
  E88E    CD D717        C      stopch:	call	swilmp		;Stop-Lampe an
  E891    CD D3BB        C      	call	kbdi		;Warten auf naechstes Zeichen
  E894    C3 D717        C      	jp	swilmp		;danach Stop-Lampe aus
                         C      
                         C       ENDIF ;stpvar
                         C       ENDIF ;asynchr. Routinen
                         C      
                         C      ;***************************************************
                         C      ;	Allgemeine BIOS-Hilfsprogramme
                         C      ;***************************************************
                         C      
                         C      ; Aufruf der Routine (HL)
  E897    E9             C      callhl:	jp	(hl)
                         C      
                         C      ; Ausgabe Text ab (HL) bis 00h auf CON: und evtl. LST:
  E898    7E             C      putmes:	LD	A,(HL)
  E899    B7             C      	OR	A
  E89A    C8             C      	RET	Z
  E89B    E5             C      	PUSH	HL
  E89C    4F             C      	LD	C,A
  E89D    CD D20C        C      	CALL	conol
  E8A0    E1             C      	POP	HL
  E8A1    23             C      	INC	HL
  E8A2    18 F4          C      	JR	putmes
                         C      
                         C      ; Ausgabe Text ab (HL) mit exakter Laenge "stzbl" in Statuszeile
                         C       IF cpastz
                         C       ELSE
  E898                   C      biosms	equ	putmes	;0dh,0ah,...,07h,00h im Text ergaenzen!!
                         C       ENDIF
                         C      
                         C      ;	Wait 0.01 sec * (B)
                         C      ; Reg HL bleibt erhalten
  E8A4    C5             C      wait10:	push	bc
  E8A5    0E 0A          C      	ld	c,10		;10* 1ms warten
  E8A7    06 BD          C      wait2z:	ld	b,189		;(189*13)/(256*9600)=0.001
  E8A9    10 FE          C      wait1z:	djnz	wait1z		;1ms warten
  E8AB    0D             C      	dec	c
  E8AC    20 F9          C      	jr	nz,wait2z
  E8AE    C1             C      	pop	bc
  E8AF    10 F3          C      	djnz	wait10
  E8B1    C9             C      	ret
                         C      
                         C      ;************************************************************
                         C      ;	zentral verwendete Rueckkonvertierungsroutinen
                         C      ;************************************************************
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-99


                         C      
                         C       IF monitor or errvar or iobvar or uhrvar
                         C      
                         C      ; Rueckkonvertieren Byte ab (HL) nach (DE)
                         C      ; RET: 2 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
  E8B2    7E             C      mbreco:	ld	a,(hl)
                         C      
                         C      ; Rueckkonvertieren Byte in A nach (DE)
                         C      ; RET: 2 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
  E8B3    CD E8B6        C      mrecoa:	call	mreca
                         C      
                         C      ; Rueckkonvertieren A in HEX-Ziffern nach (DE)
                         C      ; RET: A um 4 bits nach rechts rotiert
                         C      ;      DE zeigt auf naechstes Byte
  E8B6                   C      mrecol:
  E8B6    0F             C      mreca:	rrca			;linkes Halbbyte
  E8B7    0F             C      	rrca
  E8B8    0F             C      	rrca
  E8B9    0F             C      	rrca
  E8BA                   C      mrecor:				;rechtes Halbbyte
  E8BA    F5             C      	push	af		;fuer 2. mreca-Aufruf retten
  E8BB    E6 0F          C      	and	0fh
  E8BD    D6 0A          C      	sub	9+1
  E8BF    38 02          C      	jr	c,mrecod	;0..9
  E8C1    C6 07          C      	add	a,7		;A..F
  E8C3    C6 3A          C      mrecod:	add	a,'0'+10
  E8C5    12             C      	ld	(de),a
  E8C6    13             C      	inc	de
  E8C7    F1             C      	pop	af
  E8C8    C9             C      	ret
                         C      
                         C       ENDIF
                         C      
                         C       IF monitor or cpastz
                         C      
                         C      ; Ermitteln 10er-Ziffer von HL zur Basis -DE
                         C      ; C =0, wenn bisher nur fuehrende Nullen
                         C      ; RET: HL enthaelt Rest; C>0 bei Ziffer >'0'
                         C      ;	B,DE erhalten
                         C      ;	ret z bei fuehrender Null
                         C      
  E8C9    3E 2F          C      mhldig:	ld	a,'0'-1		;ASCII-Zaehler
  E8CB    3C             C      mhdig1:	inc	a
  E8CC    19             C      	add	hl,de
  E8CD    38 FC          C      	jr	c,mhdig1
  E8CF    ED 52          C      	sbc	hl,de		;einmal zuviel gezaehlt
  E8D1    0C             C      	inc	c
  E8D2    FE 30          C      	cp	'0'		;Null ?
  E8D4    C0             C      	ret	nz		;nein
  E8D5    0D             C      	dec	c		; Test auf fuehrende Null
  E8D6    C9             C      	ret			;ret z bei ja
                         C      
                         C       ENDIF
                         C      
                         C      ;*************************************************************
                         C      ;	wiederholter Kaltstart
                         C      ;*************************************************************
  E8D7                   C      kalts1:
  E8D7    CD E356        C      	call	tim5of		;totlegen CTC
  E8DA    F3             C      	di
  E8DB    D3 24          C      	out	(24h),a		;Lade-ROM zuschalten
  E8DD    C7             C      	rst	0		;und RESET simulieren
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-100


                         C      
                         C      
                         C      ;*************************************************************
                         C      ;	Warmstart
                         C      ;*************************************************************
                         C       if1
                         C       endif
                         C      
                         C       IF	wbootv eq 1	;Warmstart=Kaltstart
                         C       ELSE
  E8DE    31 0080        C      WARMST:	LD	SP,tpa-80h
                         C      
                         C         if	wbootv eq 0		;;CCP-Kopie im BIOS
  E8E1    21 E991        C      	ld	hl,ccpkop	;;CCP von Kopie wiederherst.
  E8E4    11 BC00        C      	ld	de,CCP
  E8E7    01 0811        C      	ld	bc,ccpkpl+bdskpl
  E8EA    ED B0          C      	ldir
                         C         endif
                         C      
                         C         if	(wbootv eq 2) or (wbootv eq 3)	;;CCP von @OS.COM/@CCP.SYS wiederhst.
                         C         endif ;(wbootv eq 2) or (wbootv eq 3)
                         C      
  E8EC    21 BC03        C      	LD	HL,CCP+3	;EINGANG MIT KOMMANDOLOESCHEN
                         C      	warmin
  E8EF    F3             C+     wbinit:	DI
  E8F0    E5             C+     	PUSH	HL
  E8F1    3E F7          C+     	LD	A,high(intvr)
  E8F3    ED 47          C+     	LD	I,A
  E8F5    ED 5E          C+     	im	2
  E8F7    3E C3          C+     	LD	A,0C3H
  E8F9    32 0000        C+     	LD	(REBOOT),A
  E8FC    21 0003'       C+     	LD	HL,BIOS+3
  E8FF    22 0001        C+     	LD	(REBOOT+1),HL
  E902    32 0005        C+     	LD	(BDOSJP),A
  E905    21 C406        C+     	LD	HL,BDOS+6
  E908    22 0006        C+     	LD	(BDOSJP+1),HL
  E90B    32 0038        C+     	ld	(38h),a		;Breakpoint
  E90E    21 E7AB        C+     	ld	hl,moncal	;bei Monitor 
  E911    22 0039        C+     	ld	(38h+1),hl
  E914    21 D23D        C+     	ld	hl,synflg
  E917    36 00          C+     	ld	(hl),0
  E919    23             C+     	inc	hl
  E91A    36 00          C+     	ld	(hl),0		;synsem:=0
  E91C    21 E355        C+     	ld	hl,ret
  E91F    22 004A        C+     	ld	(kritbg),hl	;leere Routine fuer Beginn kritischer BIOS-Teil
  E922    22 004C        C+     	ld	(kriten),hl
  E925    21 E355        C+     	ld	hl,ret
  E928    22 0045        C+     	ld	(tim1rt),hl
  E92B    3E 0F          C+     	ld	a,0fh
  E92D    D3 0A          C+     	out	(sysctc+2),a
  E92F    3E 00          C+      	ld	a,0
  E931    D3 0A          C+     	out	(sysctc+2),a
  E933    CD E34B        C+     	call	tim5on
  E936    CD D7FD        C+     	call	lsynch		;alle Zeichen-Geraete neu initial.
  E939    AF             C+     	xor	a
  E93A    32 D56D        C+     	ld	(desc),a	;evtl. ESCAPE-Modus beenden
  E93D    0E 82          C+     	ld	c,82h		;Kursor sichtbar machen
  E93F    CD D51E        C+     	call	crto
  E942    3A 0040        C+     	ld	a,(lampbf)
  E945    E6 B1          C+     	and	(1 shl lmphcp)+(1 shl lmpb2r)+(1 shl lmpb2b)+(1 shl kbdcpb)
  E947    32 0040        C+     	ld	(lampbf),a	;ruecksetzen Lampen
  E94A    21 D49F        C+     	ld	hl,kbdsts	;Standard-Stringtabelle wiederherstellen
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-101


  E94D    22 D23B        C+     	ld	(kbdsst),hl
  E950    3E FF          C+     	ld	a,0ffh
  E952    32 DE82        C+     	ld	(dbdev),a
  E955    FB             C+     	EI
  E956    21 0004        C+     setcld:	ld	hl,defaul
  E959    4E             C+     	ld	c,(hl)
  E95A    C5             C+     	push	bc
  E95B    79             C+     	ld	a,c
  E95C    E6 0F          C+     	and	0fh
  E95E    4F             C+     	ld	c,a
  E95F    AE             C+     	xor	(hl)
  E960    F6 00          C+     	or	0
  E962    77             C+     	ld	(hl),a
  E963    CD E96E        C+     	call	dgetpb
  E966    C1             C+     	pop	bc
  E967    28 ED          C+     	jr	z,setcld
  E969    C9             C+     	ret
                         C       ENDIF	;wbootv ne 1
                         C      
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C      ;	Steuertabellen fuer Massenspeicher
                         C      ;$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$$
                         C       if1
                         C       endif
                         C      
                         C      ; Tabelle der Adressen der DPH's
                         C      ;===============================
  0002                   C      @din	aset	dphnb
  E96A                   C      dphatb:	IRP	di,<A,B,C,D,E,F,G,H,I,J,K,L,M,N,O,P>
                         C      	if	@din eq 0
                         C      	EXITM
                         C      	endif
                         C      @din	aset	@din-1
                         C      	dw	dpha&di
                         C      	ENDM
  E96A    D23F           C+     	dw	dpha&A
  E96C    D24F           C+     	dw	dpha&B
                         C      
                         C      ; Ermitteln DPH und DPB von (c) nach HL bzw. IX
                         C      ; ret z		DPH existiert nicht, HL=0
                         C      ; ret nz	ok, HL auf DPH, IX auf DPB
                         C      ; BC,DE bleibt erhalten
                         C      ;=====================================================
  E96E    D5             C      dgetpb:	push	de
  E96F    21 0000        C      	ld	hl,0
  E972    79             C      	ld	a,c
  E973    FE 02          C      	cp	dphnb		;DPH definiert?
  E975    30 16          C      	jr	nc,dgetp0	;nein
  E977    EB             C      	ex	de,hl
  E978    21 E96A        C      	ld	hl,dphatb	;Adresstabelle fuer DPH's
  E97B    59             C      	ld	e,c
  E97C    19             C      	add	hl,de
  E97D    19             C      	add	hl,de
  E97E    7E             C      	ld	a,(hl)
  E97F    23             C      	inc	hl
  E980    66             C      	ld	h,(hl)
  E981    6F             C      	ld	l,a		;hl:=^DPH
  E982    E5             C      	push	hl
  E983    1E 0A          C      	ld	e,10
  E985    19             C      	add	hl,de
  E986    5E             C      	ld	e,(hl)
  E987    23             C      	inc	hl
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-102


  E988    56             C      	ld	d,(hl)		;de:=^dpb
  E989    D5             C      	push	de
  E98A    DD E1          C      	pop	ix		;ix:=^dpb
  E98C    E1             C      	pop	hl
  E98D    D1             C      dgetp0:	pop	de
  E98E    7C             C      	ld	a,h
  E98F    B5             C      	or	l		;ret z bei hl=0
  E990    C9             C      	ret
                         C      
                         C      
                         C      ;**************************************************
                         C      ;	Arbeits-Felder (ab hier keine Konstanten!!)
                         C      ;	Arbeits-Felder werden benutzt fuer Kaltstart-Routinen
                         C      ;**************************************************
  E991                   C      biosds	equ	$
  E991                   C      @dsad	aset	biosds
                         C      
                         C      ; ===========allgemeine BIOS-Funktionen=============
                         C      
  0800                   C      ccpkpl	equ	ccpln		;Laenge CCP+ BDOS-Anfang
  0011                   C      bdskpl	equ	11h		;BDOS-Anfang
                         C      
                         C      	if	wbootv eq 0	;CCP-Kopie im BIOS
  E991                   C      ccpkop	equ	@dsad
  F1A2                   C      ccpkpe	equ	ccpkop+ccpkpl+bdskpl
  F1A2                   C      @dsad	aset	ccpkpe	;Ende CCP-Kopie
                         C      	endif
                         C      
                         C      	if	(wbootv eq 2) or (wbootv eq 3)
                         C      	endif
                         C      
                         C       IF stpvar
  F1CE                   C      @dsad	aset	@dsad+2*22	;Stack fuer asynchrone Routinen
  F1CE                   C      stpstk	equ	@dsad
                         C       ENDIF
  F1E6                   C      @dsad	aset	@dsad+2*12	;Stack fuer Interrupt-Routinen
  F1E6                   C      intstk	equ	@dsad
                         C      
                         C      ;=============Disketten-Arbeit============
                         C      
  F1E6                   C      dirbuf	equ	@dsad	;Directory-Puffer fuer alle Laufwerke
  F266                   C      @dsad	aset	@dsad+128
  0002                   C      @din	aset	disknb
                         C      	IRP	di,<A,B,C,D>
                         C      	IF	@din eq 0
                         C      	EXITM
                         C      	ENDIF
                         C      @din	aset	@din-1
                         C      alv&di	equ	@dsad		;;Allocation-Vector Disk.
                         C      	IF	((disk&di mod 1000)/100) eq 5	;;5"
                         C      	if	((disk&di mod 10000)/1000)	;;DS
                         C      @dsad	aset	@dsad+(400+7)/8	;;reicht fuer 400k (1K Bloecke)
                         C      				;;	bzw. 800K (2K Bloecke)
                         C      	else					;;SS
                         C      @dsad	aset	@dsad+(200+7)/8	;;reicht fuer 200k (1K Bloecke)
                         C      				;;	bzw. 400K (2K Bloecke)
                         C      	endif
                         C      	ELSE					;;8"
                         C      	if	(disk&di ge 10000)		;;MFM
                         C      @dsad	aset	@dsad+(352+7)/8	;;reicht fuer 704 2K Bloecke
                         C      	else					;;FM
                         C      @dsad	aset	@dsad+(250+7)/8	;;reicht fuer 250K (1K Bloecke)
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-103


                         C      				;;	bzw. 500K (2K-Bloecke)
                         C      	endif
                         C      	ENDIF
                         C      csv&di	equ	@dsad		;;Check Sum
                         C      	IF	(disk&di mod 100) gt 40	;;8",77 oder 5",80 Track
                         C      	if	((disk&di mod 10000)/1000)	;;DS
                         C      @dsad	aset	@dsad+256/4	;;reicht fuer 256 Dir.eintraege
                         C      	else					;;SS
                         C      @dsad	aset	@dsad+128/4	;;reicht fuer 128 Dir.eintraege
                         C      	endif
                         C      	ELSE				;;5" 40 Track
                         C      	if	((disk&di mod 10000)/1000)	;;DS
                         C      @dsad	aset	@dsad+128/4	;;reicht fuer 128 Dir.eintraege
                         C      	else
                         C      @dsad	aset	@dsad+64/4	;;reicht fuer 64 Dir.eintraege
                         C      	endif
                         C      	ENDIF
                         C      	ENDM
                         C      
                         C      	if	oss
                         C      	endif
                         C      
                         C      
                         C      	IF 	em256
                         C      	ENDIF
                         C      
                         C       IF raf
                         C       ENDIF
                         C      
                         C       IF dbufsz gt 7
  F34A                   C      dbuf	equ	@dsad		;Diskettenpuffer
  F74A                   C      @dsad	aset	@dsad+(1 shl dbufsz)
                         C       ENDIF
                         C      
                         C      ; ============Tastatur=================
                         C      
                         C       IF cpastz
                         C       ELSE
  F74A                   C      kbdbuf	equ	@dsad
  F75C                   C      @dsad	aset	@dsad+kbdbl+1
                         C       ENDIF
                         C      
                         C      ; Es folgt der Bereich fuer nutzereigene Stringdefinition
                         C      ; immer am Ende, d.h. bis zum Beginn der Interruptsaeule,
                         C      ; damit durch Rundung auf 100h-Grenze freibleibende Bytes
                         C      ; fuer Nutzerstrings zusaetzlich zur Verfuegung stehen. 
                         C       IF costu
  F75C                   C      costrt	equ	@dsad
  F767                   C      @dsad	aset	@dsad+costu+1	;Mindestbereich
                         C       ENDIF
                         C      
  F767                   C      biosde	aset	@dsad	;*****Ende BIOS-Arbeitsbereiche*****
                         C      
                         C      
                         C      
                         C      
                         C      ; Kontrolle auf Adressenueberschreitung
                         C      ;======================================
                         C       if1
                         C       endif
                         C      
                         C       if biosde gt intvr
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-104


                         C       endif
                         C      
                         C      
                         C       if1
                         C       endif
                         C      
  F767                   C      @diff	aset	biosde
                         C      
                         C       if intvr ge @diff
  0000                   C      @diff	aset	(intvr-@diff) shr 8 shl 8
                         C       if @diff gt 100h ;100h als Unschaerfe zulassen 
                         C       endif
                         C       endif ;intvr ge @diff
                         C      
                         C       if1
                         C       endif
                         C      
                         C      ; Belegung der Interruptsaeule durch das BIOS:
                         C      ;============================================
                         C      
                         C      ;*** 0c0h..0cfh frei bei PC1715
                         C      
                         C       if iobuc1
                         C      ;	SIO fuer UC1:-Treiber im Interrupt
                         C      ; Kanal B
  00D0                   C      ivsio0	equ	0d0h		;Sendepuffer leer
  00D2                   C      ivsio1	equ	ivsio0+2	;Statuswechsel
  00D4                   C      ivsio2	equ	ivsio1+2	;Empf-Zeichen da
  00D6                   C      ivsio3	equ	ivsio2+2	;Empf-Ueberlauf
                         C      ; Kanal A
  00D8                   C      ivsio4	equ	ivsio3+2	;Sendepuffer leer
  00DA                   C      ivsio5	equ	ivsio4+2	;Statuswechsel
  00DC                   C      ivsio6	equ	ivsio5+2	;Empf-Zeichen da
  00DE                   C      ivsio7	equ	ivsio6+2	;Empf-Ueberlauf
                         C       endif
                         C      
  00E0                   C      ivpar	equ	0e0h		;Paritaetsfehler EM256-RAM
                         C      ;*** 0e2h frei bei PC1715
                         C      
                         C      ;*** 0e4h frei
                         C      
                         C      ;*** 0e6h frei bei PC1715
                         C      
                         C      ;*** die folgenden beiden Adressen werden vom FORMAT-Programm
                         C      ;*** vorausgesetzt, d.h. ihre Lage ist quasi fest !!
  00E8                   C      ivdsk1	equ	0e8h		;Disk Index-Interrupt
  00EA                   C      ivdsk2	equ	0eah		;Disk Marken-/Fault-Interrupt
                         C      
                         C      ;*** 0ech, 0eeh frei
                         C      
                         C      ;*** 0f0h..0f6 frei bei PC1715
                         C      
  00F8                   C      ivctc0	equ	0f8h		;CTC Kanal 0
  00FA                   C      ivctc1	equ	ivctc0+2
  00FC                   C      ivctc2	equ	ivctc1+2
  00FE                   C      ivctc3	equ	ivctc2+2
                         C      
                         C      
                         C      ;************************************************
                         C      ;	Kaltstart-Rest, der nicht im Anfangslader
                         C      ; Anschlussbedingung:
                         C      ; i A:	Default-Laufwerk (i.a. =Kaltstartlaufwerk)
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-105


                         C      ;	Bit 7 =1, wenn kein jungfr. Kaltstart
                         C      ;************************************************
                         C      
  E991                   C      KALTST:				;Kaltstart-Initialisierung
  E991    F3             C      	di
  E992    21 17A0'       C      	ld	hl,kaltsc
  E995    11 0180        C      	ld	de,kaltsb
  E998    01 05C5        C      	ld	bc,kaltsl
  E99B    ED B0          C      	ldir			;Kaltstart-Code nach vorn
  E99D    C3 0180        C      	jp	kaltsb		;und abarbeiten
                         C      	.DEPHASE
                         C      
  0180                   C      kaltsb	equ	180h		;Basisadr fuer Kaltstartcode
  17A0'                  C      kaltsc:	.PHASE	kaltsb
                         C      
                         C      ; Loeschen 0..tpa-80h
  0180    21 0000        C      	ld	hl,0
  0183    36 00          C      	ld	(hl),0
  0185    11 0001        C      	ld	de,1
  0188    01 007F        C      	ld	bc,tpa-80h-1
  018B    ED B0          C      	ldir
                         C      ;
  018D    31 0080        C      	ld	sp,tpa-80h
                         C      
  0190    F5             C      	push	af		;merken Default
  0191    E6 80          C      	and	80h		;Bit 7
  0193    32 04A4        C      	ld	(cjungf),a	;merken
  0196    F1             C      	pop	af
                         C      
  0197    E6 03          C      	and	03h
  0199    32 0004        C      	ld	(defaul),a	;setzen Default-Laufwerk
  019C    32 E961        C      	ld	(clddev),a
                         C      
                         C       if	(wbootv eq 2) or (wbootv eq 3)	;CCP von '@OS.COM'/@CCP.SYS laden
                         C       endif
                         C      
                         C      ; Loeschen BIOS-Arbeitsbreiche zur Spur-Suche
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
                         C      
  019F    21 E991        C      	ld	hl,biosds
  01A2    11 E992        C      	ld	de,biosds+1
  01A5    01 0DD5        C      	ld	bc,biosde-biosds-1
  01A8    36 FD          C      	ld	(hl),0fdh
  01AA    ED B0          C      	ldir
                         C      
                         C      ; Definieren Interruptvektor
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~
  01AC    21 F7D0        C      	LD	HL,intvr
  01AF    7C             C      	LD	A,H
  01B0    ED 47          C      	LD	I,A
  01B2    ED 5E          C      	im	2
                         C       IF (intvec+100h-intvr)	eq 256
                         C       ELSE
  01B4    06 30          C      	ld	b,intvec+100h-intvr
                         C       ENDIF
  01B6    36 00          C      intvcl:	ld	(hl),0		;vorloeschen Interruptsaeule
  01B8    23             C      	inc	hl
  01B9    10 FB          C      	djnz	intvcl
  01BB    21 D2C5        C      	ld	hl,cpmx00	;Adr.Sprungvektor CP/M-Erw.
  01BE    22 004E        C      	ld	(cpmext),hl	;eintragen
                         C      
                         C      ; Definieren Arbeitszellen fuer asynchrone Routinen
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-106


                         C      ;--------------------------------------------------
                         C      
  01C1    21 E355        C      	ld	hl,ret
  01C4    22 004A        C      	ld	(kritbg),hl
  01C7    22 004C        C      	ld	(kriten),hl
                                
                                ;#############################################################
                                ; Kaltstart-Initialisierungen
                                ;----------------------------
                         C      	include	BIOPTIMC
                         C      
                         C      ; Kaltstart-Initialisierung Timer
                         C      ;================================
                         C      
                         C      ;;Anmerkung zur Verwendung der Zeitgeberkanaele:
                         C      ;; (keiner ist im PC1715 kaskadiert!)
                         C      ;;CTC0	Tastatur/Printer
                         C      ;;CTC1	V.24
                         C      ;;CTC2	Kennzeichnung grosser/kleiner Bildschirm fuer alle
                         C      ;;	BC-Software, die am A5120 "in a,(0ah)" testen!
                         C      ;;	wird Bildschirm-Kaltstart gestellt
                         C      ;;CTC3	25ms Takt fuer Uhr und Fehlerueberwachung fuer Disk.Treiber
  0003                   C      timctc	equ	3
                         C      
  01CA    21 E367        C      	ld	hl,tim5it	;;int.adr.
  01CD    22 F7FE        C      	ld	(intvec+ivctc0+timctc+timctc),hl
  01D0    3E F8          C      	ld	a,ivctc0
  01D2    D3 08          C      	out	(sysctc),a	;;int.vekt.
  01D4    3E 37          C      	ld	a,00110111b
                         C      ;;kein int./zeitg./vort.256/pos.flanke/naechst.zykl./zk folgt/
                         C      ;;	abbruch/1
  01D6    D3 0B          C      	out	(sysctc+timctc),a
  01D8    3E F0          C      	ld	a,240		;;zk fuer 25ms
  01DA    D3 0B          C      	out	(sysctc+timctc),a
                         C      
                         C      	include	BIOPCHDC
                         C      ; Kaltstart-Initialisierung zeichenorientierte Geraete
                         C      ;=====================================================
                         C       if cdtpio
                         C       endif
                         C       if iobuc1
  01DC    21 D923        C      	ld	hl,uc1rin	;;Empf-Interrupt fuer UC1:
  01DF    22 F7D4        C      	ld	(intvec+ivsio2),hl
  01E2    21 D961        C      	ld	hl,uc1err	;;spez. Empf.Bedingung fuer UC1:
  01E5    22 F7D6        C      	ld	(intvec+ivsio3),hl
                         C       endif
                         C      	include	BIOPDSKC
                         C      
                         C      ; Kaltstart-Initialisierung Floppy
                         C      ;=================================
                         C      ; Version 28.1.88
                         C      
                         C      ;; Port Steuer-B
  01E8    21 E263        C      	ld	hl,diomrk	;; Adressmarken-Interrupt
  01EB    22 F7EA        C      	ld	(intvec+ivdsk2),hl
  01EE    3E EA          C      	ld	a,ivdsk2
  01F0    D3 07          C      	out	(flcobc),a
  01F2    3E CF          C      	ld	a,0cfh		;; bit E/A
  01F4    D3 07          C      	out	(flcobc),a
                         C       IF fdc eq f1715
  01F6    3E E3          C      	ld	a,0e3h		;; eeea aaee
  01F8    D3 07          C      	out	(flcobc),a
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-107


  01FA    3E 37          C      	ld	a,00110111b	;; di/oder/high/Maske
  01FC    D3 07          C      	out	(flcobc),a
                         C       ENDIF
                         C       IF fdc eq k5120
                         C       ENDIF
  01FE    3E FD          C      	ld	a,11111101b	;; Interrupt bei Marke
  0200    D3 07          C      	out	(flcobc),a
                         C      ;; Port Daten-B
  0202    3E 4F          C      	ld	a,4fh		;; byte-Eingabe
  0204    D3 03          C      	out	(fldabc),a
                         C      ;; Port Daten-A
  0206    3E 0F          C      	ld	a,0fh		;; byte-Ausgabe
  0208    D3 01          C      	out	(fldaac),a
                         C      ;; Port Steuer-A
  020A    D3 05          C      	out	(flcoac),a	;; byte-Ausgabe
  020C    D3 04          C      	out	(flcoad),a	;; AMF aus
  020E    21 E139        C      	ld	hl,itimeo
  0211    22 F7E8        C      	ld	(intvec+ivdsk1),hl
  0214    3E E8          C      	ld	a,ivdsk1
  0216    D3 05          C      	out	(flcoac),a	;; Index-Interrupt
  0218    3E 03          C      	ld	a,3
  021A    D3 05          C      	out	(flcoac),a	;; verbieten
                         C      
                         C      ;; Select-Latch-Programmierung
  021C    3E FF          C      	ld	a,0ffh		;; alle LW ausschalten
  021E    D3 20          C      	out	(flsel),a
                         C       IF fdc eq f1715
  0220    D3 21          C      	out	(flmot),a
                         C       ENDIF
                         C      
                         C      ;; Ermittlung der vorhandenen Laufwerke
  0222    0E 04          C      	ld	c,maxlw
  0224    16 00          C      	ld	d,0
  0226    3E F7          C      	ld	a,0f7h		;; ohne lock
  0228    07             C      fl.ka1: rlca
  0229    D3 20          C      	out	(flsel),a
                         C       IF fdc eq f1715
  022B    D3 21          C      	out	(flmot),a
                         C       ENDIF
  022D    08             C       	ex	af,af'
  022E    06 55          C      	ld	b,85		;; max 85 mal steppen
  0230    DB 06          C      fl.ka2:	in	a,(flcobd)
  0232    07             C      	rlca			;; kam Spur0-Signal?
  0233    30 12          C      	jr	nc,fl.ka4	;; -> ja
  0235    3E 5F          C      	ld	a,01011111b	;; steppen in Richtung Spur 0
  0237    D3 04          C      	out	(flcoad),a
  0239    3E DF          C      	ld	a,11011111b	;; mit Kopf oben
  023B    D3 04          C      	out	(flcoad),a
  023D    26 08          C      	ld	h,8		;; Schrittzeit abwarten
  023F    2D             C      fl.ka3: dec	l
  0240    20 FD          C      	jr	nz,fl.ka3
  0242    25             C      	dec	h
  0243    20 FA          C      	jr	nz,fl.ka3
  0245    10 E9          C      	djnz	fl.ka2		;; -> weiteren Schritt ausfuehren
                         C      ;****Laufwerke immer existent melden wegen 8" Beistell-Laufwerken ohne Strom
                         C      ;***	jr	fl.ka5		;; -> LW nicht existent
                         C      ;***
  0247    CB F2          C      fl.ka4: set	6,d		;; Laufwerk existent melden
  0249    0D             C      fl.ka5: dec	c		;; weiteres LW?
  024A    28 07          C      	jr	z,fl.ka6	;; -> nein
  024C    CB 0A          C      	rrc	d
  024E    CB 0A          C      	rrc	d
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-108


  0250    08             C      	ex	af,af'
  0251    18 D5          C      	jr	fl.ka1		;; -> naechstes LW pruefen
                         C      
  0253    7A             C      fl.ka6: ld	a,d
  0254    32 E1A0        C      	ld	(lwexis),a
                         C      
  0257    3E FF          C      	ld	a,0ffh		;; alle LW ausschalten
  0259    D3 20          C      	out	(flsel),a
                         C       IF fdc eq f1715
  025B    D3 21          C      	out	(flmot),a
                         C       ENDIF
  025D    AF             C      	xor	a
  025E    32 E1A1        C      	ld	(alwnr),a	;; LW 0 ist das zuletzt benutzte, Motor ist aus
  0261    32 E1A2        C      	ld	(aspnr),a	;; steht auf Spur 0
  0264    06 04          C      	ld	b,maxlw
  0266    21 E1A3        C      	ld	hl,spnrl
  0269    77             C      fl.ka7: ld	(hl),a		;; alle alten Spurnr. sind 0
  026A    23             C      	inc	hl
  026B    10 FC          C      	djnz	fl.ka7
                         C      
                                  IF oss
                                  ENDIF
                                  IF em256
                                  ENDIF
                                  IF kes
                                  ENDIF
                                  IF raf
                                  ENDIF
                                
                                ;##############################################################
                                ; Kaltstart-Initialisierung, die vom Bildschirmformat abhaengen
                                ;--------------------------------------------------------------
                         C      	include	BIOPCLD1	;Wiederholung mit neuem Bildschirmformat
                         C      
  026D    3A 04A4        C      	ld	a,(cjungf)
  0270    B7             C      	or	a		;wiederholter Kaltstart?
  0271    28 05          C      	jr	z,njung1	;nein
  0273    DB 0A          C      	in	a,(sysctc+2)	;sonst CTC-Wert setzen
  0275    32 027E        C      	ld	(babfrm),a	;als Bildschirmformat
  0278                   C      njung1:
                         C      
  0278    F3             C      cldrty:	di			;Wdhlg mit neuem BS-Format
                         C      	include	BIOPCRTC
                         C      
                         C      ; Kaltstart-Initialisierung Bildschirm
                         C      ;=====================================
                         C      
                         C      ;;anzeigen im CTC-Kanal 2 grosser Bildschirm fuer alle
                         C      ;;A5120-Programme, die "in a,(0ah); bit 6,a" testen!
                         C      
  0279    3E 0F          C      	ld	a,0fh		;;CTC-Start extern, d.h blockiert
  027B    D3 0A          C      	out	(sysctc+2),a
                         C      	if	bab eq 1	;;Standard-Format als Anfang
                         C      	else
  027D    3E 00          C      	ld	a,0
                         C      	endif
  027E                   C      babfrm	equ	$-1		;;Bit 6 auf 0: grosser BS
  027F    D3 0A          C      	out	(sysctc+2),a
  0281    32 E930        C      	ld	(bsform),a	;;merken BS-Format fuer Neuladen CTC
                         C      ;; Automatische Umschaltung des Bildschirmformates
                         C      ;;***naechste frei crtmxx-Marke: crtm49
                         C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-109


  0284    CB 77          C      	bit	6,a		;;BAB2 (24*80)?
  0286    CA 032B        C      	jp	z,bsbab2	;;ja
                         C      
  0289    21 03C1        C      bsbab1:	ld	hl,0-bsend1
  028C    22 D583        C      	ld	(crtm01),hl
  028F    21 FC00        C      	ld	hl,bsend1-bssp1+1
  0292    22 D58A        C      	ld	(crtm02),hl
                         C       IF inslin
  0295    22 D6C6        C      	ld	(crtm44),hl
  0298    22 D6E2        C      	ld	(crtm47),hl
  029B    22 D6F3        C      	ld	(crtm48),hl
                         C       ENDIF
  029E    2B             C      	dec	hl
  029F    22 D673        C      	ld	(crtm14),hl
                         C       IF inslin
  02A2    22 D6D4        C      	ld	(crtm46),hl
                         C       ENDIF
  02A5    21 F840        C      	ld	hl,bsanf1+bssp1
  02A8    22 D58E        C      	ld	(crtm03),hl
  02AB    2B             C      	dec	hl
  02AC    22 D6A3        C      	ld	(crtm20),hl
  02AF    21 F800        C      	ld	hl,bsanf1
  02B2    22 D238        C      	ld	(dcupos),hl
  02B5    22 D591        C      	ld	(crtm04),hl
  02B8    22 D63B        C      	ld	(crtm09),hl
  02BB    22 D681        C      	ld	(crtm16),hl
  02BE    22 D68A        C      	ld	(crtm17),hl
  02C1    22 D69F        C      	ld	(crtm19),hl
  02C4    22 D72A        C      	ld	(crtm37),hl
                         C      	if	stpvar
                         C      	if	chdvar
  02C7    22 D748        C      	ld	(crtm22),hl
                         C      	endif
                         C      	endif
                         C      	if	mprot
                         C      	endif
  02CA    21 0400        C      	ld	hl,bsend1-bsanf1-bssp1+1
  02CD    22 D594        C      	ld	(crtm05),hl
  02D0    21 FC3E        C      	ld	hl,bsend1-1
  02D3    22 D59C        C      	ld	(crtm06),hl
  02D6    23             C      	inc	hl
  02D7    22 D665        C      	ld	(crtm13),hl
  02DA    22 D68D        C      	ld	(crtm18),hl
                         C       IF inslin
  02DD    22 D6D1        C      	ld	(crtm45),hl
                         C       ENDIF
  02E0    21 003F        C      	ld	hl,bssp1-1
  02E3    22 D59F        C      	ld	(crtm07),hl
  02E6    7D             C      	ld	a,l
  02E7    32 D658        C      	ld	(crtm11),a
  02EA    23             C      	inc	hl
  02EB    22 D640        C      	ld	(crtm10),hl
  02EE    22 D662        C      	ld	(crtm12),hl
  02F1    22 D67B        C      	ld	(crtm15),hl
  02F4    22 D730        C      	ld	(crtm25),hl
                         C      	if	stpvar
                         C      	if	chdvar
  02F7    7D             C      	ld	a,l
  02F8    32 D74F        C      	ld	(crtm24),a
  02FB    3E 12          C      	ld	a,bszl1+1
  02FD    32 D74B        C      	ld	(crtm23),a
                         C      	endif
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-110


                         C      	endif
  0300    3E 10          C      	ld	a,bszl1-1
  0302    32 D635        C      	ld	(crtm08),a
  0305    21 FFC0        C      	ld	hl,0-bssp1
  0308    22 D6AA        C      	ld	(crtm21),hl
                         C       IF cpastz
                         C       ELSE
  030B    21 F74A        C      	ld	hl,kbdbuf
                         C       ENDIF
  030E    22 D31F        C      	ld	(crtm32),hl
  0311    22 D3BC        C      	ld	(crtm33),hl
  0314    22 D38E        C      	ld	(crtm35),hl
  0317    22 03EE        C       	ld	(crtm43),hl
                         C       IF stpvar or monitor
  031A    22 D3B3        C      	ld	(crtm36),hl
                         C       ENDIF
  031D    23             C      	inc	hl
  031E    22 D3C3        C      	ld	(crtm34),hl
                         C       IF	uhrvar
                         C       ENDIF
                         C        IF zs2var
                         C        ENDIF
  0321    CD 03CD        C      	call	bsbabi
                         C      
  0324    3E             C      cotp0:	db	high(bsanf1 shr 2)+(0*64);;immer Zeichensatz 0
  0001                   C      cotpl0	equ	$-cotp0
  0325    00             C      cotp1:	db	0			;;Reset
  0001                   C      cotpl1	equ	$-cotp1
  0326    3F             C      cotp2:	db	bssp1-1
                         C       IF cpastz
                         C       ELSE
  0327    50             C      	db	((vrtc1-1)*64)+(bszl1-1)	;;ohne Statuszeile
                         C       ENDIF
  0328    0E             C      	db	((upl1-1)*16)+(lpcr1-1)
  0329    6A             C      	db	(0*128)+(fam*64)+(csf*16)+(hrtc1-1)	
  0004                   C      cotpl2	equ	$-cotp2
  032A    20             C      cotp3:	db	20h			;;Start
  0001                   C      cotpl3	equ	$-cotp3
                         C      
                         C      
                         C      
  032B    21 0031        C      bsbab2:	ld	hl,0-bsend2
  032E    22 D583        C      	ld	(crtm01),hl
  0331    21 FF80        C      	ld	hl,bsend2-bssp2+1
  0334    22 D58A        C      	ld	(crtm02),hl
                         C       IF inslin
  0337    22 D6C6        C      	ld	(crtm44),hl
  033A    22 D6E2        C      	ld	(crtm47),hl
  033D    22 D6F3        C      	ld	(crtm48),hl
                         C       ENDIF
  0340    2B             C      	dec	hl
  0341    22 D673        C      	ld	(crtm14),hl
                         C       IF inslin
  0344    22 D6D4        C      	ld	(crtm46),hl
                         C       ENDIF
  0347    21 F850        C      	ld	hl,bsanf2+bssp2
  034A    22 D58E        C      	ld	(crtm03),hl
  034D    2B             C      	dec	hl
  034E    22 D6A3        C      	ld	(crtm20),hl
  0351    21 F800        C      	ld	hl,bsanf2
  0354    22 D238        C      	ld	(dcupos),hl
  0357    22 D591        C      	ld	(crtm04),hl
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-111


  035A    22 D63B        C      	ld	(crtm09),hl
  035D    22 D681        C      	ld	(crtm16),hl
  0360    22 D68A        C      	ld	(crtm17),hl
  0363    22 D69F        C      	ld	(crtm19),hl
  0366    22 D72A        C      	ld	(crtm37),hl
                         C      	if	stpvar
                         C      	if	chdvar
  0369    22 D748        C      	ld	(crtm22),hl
                         C      	endif
                         C      	endif
                         C      	if	mprot
                         C      	endif
  036C    21 0780        C      	ld	hl,bsend2-bsanf2-bssp2+1
  036F    22 D594        C      	ld	(crtm05),hl
  0372    21 FFCE        C      	ld	hl,bsend2-1
  0375    22 D59C        C      	ld	(crtm06),hl
  0378    23             C      	inc	hl
  0379    22 D665        C      	ld	(crtm13),hl
  037C    22 D68D        C      	ld	(crtm18),hl
                         C       IF inslin
  037F    22 D6D1        C      	ld	(crtm45),hl
                         C       ENDIF
  0382    21 004F        C      	ld	hl,bssp2-1
  0385    22 D59F        C      	ld	(crtm07),hl
  0388    7D             C      	ld	a,l
  0389    32 D658        C      	ld	(crtm11),a
  038C    23             C      	inc	hl
  038D    22 D640        C      	ld	(crtm10),hl
  0390    22 D662        C      	ld	(crtm12),hl
  0393    22 D67B        C      	ld	(crtm15),hl
  0396    22 D730        C      	ld	(crtm25),hl
                         C      	if	stpvar
                         C      	if	chdvar
  0399    7D             C      	ld	a,l
  039A    32 D74F        C      	ld	(crtm24),a
  039D    3E 1A          C      	ld	a,bszl2+1
  039F    32 D74B        C      	ld	(crtm23),a
                         C      	endif
                         C      	endif
  03A2    3E 18          C      	ld	a,bszl2-1
  03A4    32 D635        C      	ld	(crtm08),a
  03A7    21 FFB0        C      	ld	hl,0-bssp2
  03AA    22 D6AA        C      	ld	(crtm21),hl
                         C      
                         C       IF cpastz
                         C       ELSE
  03AD    21 F74A        C      	ld	hl,kbdbuf
                         C       ENDIF
  03B0    22 D31F        C      	ld	(crtm32),hl
  03B3    22 D3BC        C      	ld	(crtm33),hl
  03B6    22 D38E        C      	ld	(crtm35),hl
  03B9    22 03EE        C      	ld	(crtm43),hl
                         C       IF stpvar or monitor
  03BC    22 D3B3        C      	ld	(crtm36),hl
                         C       ENDIF
  03BF    23             C      	inc	hl
  03C0    22 D3C3        C      	ld	(crtm34),hl
                         C       IF	uhrvar
                         C       ENDIF
                         C        IF zs2var
                         C        ENDIF
  03C3    CD 03CD        C      	call	bsbabi
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-112


                         C      
  03C6    3E             C      	db	high(bsanf2 shr 2)+(0*64);;immer Zeichensatz 0
  03C7    00             C      	db	0			;;Reset
  03C8    4F             C      	db	bssp2-1
                         C       IF cpastz
                         C       ELSE
  03C9    58             C      	db	((vrtc-1)*64)+(bszl2-1)		;;ohne Statuszeile
                         C       ENDIF
  03CA    0B             C      	db	((upl-1)*16)+(lpcr-1)
  03CB    6C             C      	db	(0*128)+(fam*64)+(csf*16)+(hrtc-1)	
  03CC    20             C      	db	20h			;;Start
                         C      
  03CD                   C      bsbabi:
                         C      
                         C       IF cpastz
                         C       ENDIF	;cpastz
                         C      
  03CD    0E 0C          C      	ld	c,0ch
  03CF    CD D51E        C      	call	crto		;;Bildschirmpuffer loeschen
                         C      
                         C      ;; Initialisieren Bildschirm
                         C      ;;~~~~~~~~~~~~~~~~~~~~~~~~~~
                         C      
  03D2    E1             C      	pop	hl
  03D3    01 0134        C      	ld	bc,cotpl0*256+bschsw	;;Puffer/Zeichensatz
  03D6    ED B3          C      	otir
  03D8    01 0119        C      	ld	bc,cotpl1*256+bscom	;;Reset
  03DB    ED B3          C      	otir
  03DD    01 0418        C      	ld	bc,cotpl2*256+bspar	;;CRT programmieren
  03E0    ED B3          C      	otir
  03E2    01 0119        C      	ld	bc,cotpl3*256+bscom	;;Start Display
  03E5    ED B3          C      	otir
                         C      
  03E7    0E 84          C      	ld	c,bsinic	;;Grundzustand Bildschirm
  03E9    CD D51E        C      	call	crto		;;einstellen
                         C      
                         C      	include	BIOPKBDC
                         C      ; Kaltstart-Initialisierung Tastatur
                         C      ;===================================
                         C      
  03EC    AF             C      	xor	a
  03ED    32 FFFF        C      	ld	(0ffffh),a	;;Tastaturpuffer leeren
  03EE                   C      crtm43	equ	$-2
                         C      
                         C       IF costu
                         C      ;;Setzen nutzereigene Stringtabelle
  03F0    21 F75C        C      	ld	hl,costrt	;setzen max. Laenge -1
                         C      	if	(costu-1+intvr-biosde) gt 255
                         C      	else
  03F3    36 72          C      	ld	(hl),costu-1+intvr-biosde
                         C      	endif
  03F5    23             C      	inc	hl
  03F6    36 FF          C      	ld	(hl),0ffh	;Tabelle ist leer
                         C       ENDIF
                         C      
  03F8    21 0402        C      	ld	hl,copar
  03FB    01 080E        C      	ld	bc,copl1*256+kbdscs	;;Empf. SIO
  03FE    ED B3          C      	otir
  0400    18 08          C      	jr	coiin1
  0402                   C      copar:
                         C      ;; SIO
  0402                   C      cop1:			;;Kanal A - Tastatur und Printer
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-113


  0402    00 18          C      	db	00h,018h	;;Kanal A Reset
  0404    04 04          C      	db	04h,004h	;;Clock*1/1 Stopb./ohne Par.
  0406    01 00          C      	db	01h,000h	;;kein Interrupt (Polling ueber Zeittakt)
  0408    03 C1          C      	db	03h,0c1h	;;8 Bit/Empf.freigabe
  0008                   C      copl1	equ	$-cop1
                         C      
  040A                   C      coiin1:
  040A    CD D44A        C      	call	lampen		;alle Lampen aus
                                
                                ;########################################################
                                ; Durch Initialisierrung modifizierte Kaltstart-Meldungen
                                ;--------------------------------------------------------
                         C      	include	BIOPCLD2
                         C      
                         C      
                         C      ; Ende der Kaltstart-Initialisierungen
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  040D    FB             C      	ei
  040E    21 E8D7        C      	ld	hl,kalts1	;erneuten kaltstart
  0411    22 D201        C      	ld	(BIOS00+1),hl	;umlenken
  0414    21 04AA        C      	LD	HL,kaltm	;Startmeldung, variabler Teil
  0417    CD 04A3        C      	CALL	cputms
                         C      
                         C      ; Hauptspeicher-Test TPA-Bereich
                         C      ;~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  041A    21 065C        C      	ld	hl,ramtt
  041D    CD 04A3        C      	call	cputms
  0420    21 C406        C      	ld	hl,tpaend+1
  0423    11 0748        C      	ld	de,kaltsb+kaltsl+3;Kaltstart-Code nicht modif.
  0426    B7             C      	or	a
  0427    ED 52          C      	sbc	hl,de		;Restlaenge TPA (-3 fuer JP)
  0429    44             C      	ld	b,h
  042A    4D             C      	ld	c,l
  042B    EB             C      	ex	de,hl
  042C    7E             C      ramtz:	ld	a,(hl)
  042D    2F             C      	cpl
  042E    77             C      	ld	(hl),a
  042F    BE             C      	cp	(hl)		;angekommen?
  0430    20 2C          C      	jr	nz,ramter	;nein
  0432    2F             C      	cpl
  0433    77             C      	ld	(hl),a
  0434    23             C      	inc	hl
  0435    0B             C      	dec	bc
  0436    78             C      	ld	a,b
  0437    B1             C      	or	c
  0438    20 F2          C      	jr	nz,ramtz
  043A    21 067E        C      	ld	hl,ramtok
  043D    CD 04A3        C      	call	cputms
  0440    C3 047E        C      	jp	ramten
  0443    7C             C      rameh:	ld	a,h
  0444    CD 0448        C      	call	dcnvoa
  0447    7D             C      	ld	a,l
                         C      
                         C      ; Rueckkonvertieren Byte in A nach (DE)
                         C      ; RET: 2 Zeichen ab (DE), DE zeigt auf naechstes freies Byte
  0448    CD 044B        C      dcnvoa:	call	dcnva
                         C      
                         C      ; Rueckkonvertieren A in HEX-Ziffern nach (DE)
                         C      ; RET: A um 4 bits nach rechts rotiert
                         C      ;      DE zeigt auf naechstes Byte
  044B                   C      dcnvol:
  044B    0F             C      dcnva:	rrca			;linkes Halbbyte
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-114


  044C    0F             C      	rrca
  044D    0F             C      	rrca
  044E    0F             C      	rrca
  044F                   C      dcnvor:				;rechtes Halbbyte
  044F    F5             C      	push	af		;fuer 2. dcnva-Aufruf retten
  0450    E6 0F          C      	and	0fh
  0452    D6 0A          C      	sub	9+1
  0454    38 02          C      	jr	c,dcnvod	;0..9
  0456    C6 07          C      	add	a,7		;A..F
  0458    C6 3A          C      dcnvod:	add	a,'0'+10
  045A    12             C      	ld	(de),a
  045B    13             C      	inc	de
  045C    F1             C      	pop	af
  045D    C9             C      	ret
                         C      
  045E    11 06A5        C      ramter:	ld	de,ramead
  0461    CD 0443        C      	call	rameh
  0464    11 C406        C      	ld	de,BDOS+6	;jp BDOS+6 vor diese Stelle
  0467    2B             C      	dec	hl
  0468    72             C      	ld	(hl),d
  0469    2B             C      	dec	hl
  046A    73             C      	ld	(hl),e
  046B    2B             C      	dec	hl
  046C    36 C3          C      	ld	(hl),0c3h
  046E    22 E906        C      	ld	(bdosre),hl	;diesen Sprung als BDOS setzen
  0471    2B             C      	dec	hl
  0472    11 06BA        C      	ld	de,ramete
  0475    CD 0443        C      	call	rameh
  0478    21 068A        C      	ld	hl,ramert
  047B    CD 04A3        C      	call	cputms
  047E                   C      ramten:
                         C      
                                
                                ;#############################################################
                                ; Kaltstart-Initialisierungen nach variabler Kaltstart-Meldung
                                ;-------------------------------------------------------------
                                 IF raf
                                 ENDIF
                         C      	include	BIOPCLD3
                         C      ;START CP/M
                         C      ;~~~~~~~~~~~
                         C       IF uhrvar		;stellen der Uhr
                         C       ENDIF
                         C      
                         C       if wbootv eq 0
  047E    21 BC00        C      	ld	hl,CCP		;CCP fuer Warmstart kopieren
  0481    11 E991        C      	ld	de,ccpkop
  0484    01 0811        C      	ld	bc,ccpkpl+bdskpl
  0487    ED B0          C      	ldir
                         C       endif
                         C      
                         C         if	(wbootv eq 3)	;;CCP nach RAM-Floppy laden
                         C         endif ;wbootv eq 3
                         C         if (wbootv eq 2) or (wbootv eq 3)
                         C         endif ;(wbootv eq 2) or (wbootv eq 3)
                         C      
  0489    21 BC03        C      	ld	hl,CCP+3	;zum Eingang mit Kommandoloeschen
                         C       if cldcmx eq 0
  048C    3A 04A4        C      	ld	a,(cjungf)
  048F    B7             C      	or	a		;jungfr. Start?
  0490    20 0E          C      	jr	nz,njung3	;nein
                         C       endif
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-115


  0492    21 06C4        C      	LD	HL,kltkom	;Kaltstartkommando
  0495    11 BC07        C      	LD	DE,CCP+7	;in CCP eintragen
  0498    01 0081        C      	LD	BC,lkaltc
  049B    ED B0          C      	LDIR
  049D    21 BC00        C      	ld	hl,CCP		;zum Eingang ohne Komm.loeschen
  04A0                   C      njung3:
                         C       if	wbootv eq 1	;Warmstart=Kaltstart, d.h. Code nur einmal
                         C       else
  04A0    C3 E8EF        C      	jp	wbinit		;Warmstart-Initialisierungen
                         C       endif
                         C      
                         C      ; Meldungen Kaltstart
                         C      
  04A3                   C      cputms:
  04A3    3E 00          C      	ld	a,0		;jungfr. Kaltstart?
  04A4                   C      cjungf	equ	$-1
  04A5    B7             C      	or	a
  04A6    C0             C      	ret	nz		;nein
  04A7    C3 E898        C      	jp	putmes
                         C      
                         C      ; Konstanten fuer Kaltstart
                         C      ;==========================
                         C      
  04AA                   C      kaltm:
  04AA    43 50 2F 41    C      	db	'CP/A'
  04AE    2C 20 56 65    C      	db	', Version '
  04B2    72 73 69 6F    C      
  04B6    6E 20          C      
                         C      	version
  04B8    32 34          C+     	db	'24'
  04BA    2E             C+     	db	'.'
  04BB    30 35          C+     	db	'05'
  04BD    2E             C+     	db	'.'
  04BE    38 38          C+     	db	'88'
  04C0    2C 20 54 50    C      	db	', TPA '
  04C4    41 20          C      
                         C      	hexout	tpa
  0010                   C+     	.RADIX	16
  04C6    31 30 30 48    C+     	db	'100','H'
  000A                   C+     	.RADIX	10
  04CA    20 2D 20       C      	db	' - '
                         C      	hexout	tpaend
  0010                   C+     	.RADIX	16
  04CD    30 43 34 30    C+     	db	'0C405','H'
  04D1    35 48          C+     
  000A                   C+     	.RADIX	10
                         C      
  04D3    0D 0A          C      	db	0dh,0ah
                         C      	IF	monitor
  04D5    2D 20 6D 69    C      	db	'- mit BIOS-Monitor'
  04D9    74 20 42 49    C      
  04DD    4F 53 2D 4D    C      
  04E1    6F 6E 69 74    C      
  04E5    6F 72          C      
                         C      	ENDIF
                         C      
                         C       IF oss
                         C       ENDIF
                         C       IF	kes
                         C       ENDIF
                         C       IF	em256
                         C       ENDIF
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-116


                         C       IF raf
                         C       ENDIF
                         C      
  04E7    0D 0A          C      	db	0dh,0ah
  04E9    2D 20 44 69    C      	db	'- Disketten: '
  04ED    73 6B 65 74    C      
  04F1    74 65 6E 3A    C      
  04F5    20             C      
  0002                   C      @din	aset	disknb
                         C      	IRP	di,<A,B,C,D>
                         C      	IF	@din eq 0
                         C      	EXITM
                         C      	ENDIF
                         C      @din	aset	@din-1
                         C      	if	@din ne (disknb-1)
                         C      	db	'/'
                         C      	endif
                         C      	db	((disk&di mod 1000)/100) or '0','"('
                         C      	db	((disk&di mod 100)/10) or '0'
                         C      	db	(disk&di mod 10) or '0'
                         C      	db	','
                         C      	if	disk&di ge 10000
                         C      	db	'DD'
                         C      	else
                         C      	db	'SD'
                         C      	endif
                         C      	db	','
                         C      	if	((disk&di mod 10000)/1000) and 00000001b
                         C      	db	'DS'
                         C      	else
                         C      	db	'SS'
                         C      	endif
                         C      	if	((disk&di mod 10000)/1000) and 00000010b
                         C      	db	',Verify'
                         C      	else
                         C      	endif
                         C      	db	')'
                         C      	ENDM
  04F6    35 22 28       C+     	db	((disk&A mod 1000)/100) or '0','"('
  04F9    38             C+     	db	((disk&A mod 100)/10) or '0'
  04FA    30             C+     	db	(disk&A mod 10) or '0'
  04FB    2C             C+     	db	','
  04FC    44 44          C+     	db	'DD'
  04FE    2C             C+     	db	','
  04FF    44 53          C+     	db	'DS'
  0501    29             C+     	db	')'
  0502    2F             C+     	db	'/'
  0503    35 22 28       C+     	db	((disk&B mod 1000)/100) or '0','"('
  0506    38             C+     	db	((disk&B mod 100)/10) or '0'
  0507    30             C+     	db	(disk&B mod 10) or '0'
  0508    2C             C+     	db	','
  0509    44 44          C+     	db	'DD'
  050B    2C             C+     	db	','
  050C    44 53          C+     	db	'DS'
  050E    29             C+     	db	')'
  050F    0D 0A          C      	db	0dh,0ah
  0511    20 20 20 20    C      	db	'             max. phys. Sektorlaenge: '
  0515    20 20 20 20    C      
  0519    20 20 20 20    C      
  051D    20 6D 61 78    C      
  0521    2E 20 70 68    C      
  0525    79 73 2E 20    C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-117


  0529    53 65 6B 74    C      
  052D    6F 72 6C 61    C      
  0531    65 6E 67 65    C      
  0535    3A 20          C      
                         C      	if	dbufsz le 7
                         C      	else
                         C      	decout	<1 shl dbufsz>
  0537    31 30 32 34    C+     	db	'1024'
                         C      	endif
  053B    0D 0A          C      	db	0dh,0ah
                         C       if chdvar eq 0
                         C       else
                         C       if1
                         C       endif
  053D    2D 20 65 69    C      	db	'- einige I/O-Byte-Zuordnungen:'
  0541    6E 69 67 65    C      
  0545    20 49 2F 4F    C      
  0549    2D 42 79 74    C      
  054D    65 2D 5A 75    C      
  0551    6F 72 64 6E    C      
  0555    75 6E 67 65    C      
  0559    6E 3A          C      
  055B    0D 0A 20 20    C      	db	0dh,0ah,'  Bit 7,6 (LST:-Kanal):'
  055F    42 69 74 20    C      
  0563    37 2C 36 20    C      
  0567    28 4C 53 54    C      
  056B    3A 2D 4B 61    C      
  056F    6E 61 6C 29    C      
  0573    3A             C      
                         C      	if	iobtty
  0574    0D 0A 20 20    C      	db	0dh,0ah,'      00 (TTY:): '
  0578    20 20 20 20    C      
  057C    30 30 20 28    C      
  0580    54 54 59 3A    C      
  0584    29 3A 20       C      
                         C      	druckt	ttydat
  0587    47 65 72 61    C+     	db	'Geraet an Portadresse '
  058B    65 74 20 61    C+     
  058F    6E 20 50 6F    C+     
  0593    72 74 61 64    C+     
  0597    72 65 73 73    C+     
  059B    65 20          C+     
  0010                   C+     	.RADIX	16
  059D    30 43 48       C+     	db	'0C','H'
  000A                   C+     	.RADIX	10
                         C      	endif
  05A0    0D 0A 20 20    C      	db	0dh,0ah,'      01 (CRT:): LST:-Ausgabe auf Bildschirm'
  05A4    20 20 20 20    C      
  05A8    30 31 20 28    C      
  05AC    43 52 54 3A    C      
  05B0    29 3A 20 4C    C      
  05B4    53 54 3A 2D    C      
  05B8    41 75 73 67    C      
  05BC    61 62 65 20    C      
  05C0    61 75 66 20    C      
  05C4    42 69 6C 64    C      
  05C8    73 63 68 69    C      
  05CC    72 6D          C      
                         C      	if	ioblpt
                         C      	endif
  05CE    0D 0A 20 20    C      	db	0dh,0ah,'      11 (UL1:): LST:-Ausgabe hex auf Bildschirm'
  05D2    20 20 20 20    C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-118


  05D6    31 31 20 28    C      
  05DA    55 4C 31 3A    C      
  05DE    29 3A 20 4C    C      
  05E2    53 54 3A 2D    C      
  05E6    41 75 73 67    C      
  05EA    61 62 65 20    C      
  05EE    68 65 78 20    C      
  05F2    61 75 66 20    C      
  05F6    42 69 6C 64    C      
  05FA    73 63 68 69    C      
  05FE    72 6D          C      
                         C      	if	iobuc1
  0600    0D 0A 20 20    C      	db	0dh,0ah,'  Bit 5,4/3,2/1,0 (UP2:-/UR2:-/UC1:-Kanaele):'
  0604    42 69 74 20    C      
  0608    35 2C 34 2F    C      
  060C    33 2C 32 2F    C      
  0610    31 2C 30 20    C      
  0614    28 55 50 32    C      
  0618    3A 2D 2F 55    C      
  061C    52 32 3A 2D    C      
  0620    2F 55 43 31    C      
  0624    3A 2D 4B 61    C      
  0628    6E 61 65 6C    C      
  062C    65 29 3A       C      
  062F    0D 0A 20 20    C      	db	0dh,0ah,'      11 (UC1:): '
  0633    20 20 20 20    C      
  0637    31 31 20 28    C      
  063B    55 43 31 3A    C      
  063F    29 3A 20       C      
                         C      	druckt	uc1dat
  0642    47 65 72 61    C+     	db	'Geraet an Portadresse '
  0646    65 74 20 61    C+     
  064A    6E 20 50 6F    C+     
  064E    72 74 61 64    C+     
  0652    72 65 73 73    C+     
  0656    65 20          C+     
  0010                   C+     	.RADIX	16
  0658    30 44 48       C+     	db	'0D','H'
  000A                   C+     	.RADIX	10
                         C      	endif
                         C       endif
                         C      
  065B    00             C      	db	0	;ende-flag putmes
                         C      
                         C      ; RAM-Test-Texte
                         C      ;~~~~~~~~~~~~~~~
  065C    0D 0A          C      ramtt:	db	0dh,0ah
  065E    2D 20 52 41    C      	db	'- RAM-Test fuer TPA-Bereich... ',0
  0662    4D 2D 54 65    C      
  0666    73 74 20 66    C      
  066A    75 65 72 20    C      
  066E    54 50 41 2D    C      
  0672    42 65 72 65    C      
  0676    69 63 68 2E    C      
  067A    2E 2E 20 00    C      
  067E    54 50 41 20    C      ramtok:	db	'TPA ist OK!',0
  0682    69 73 74 20    C      
  0686    4F 4B 21 00    C      
  068A    0D 0A 21 21    C      ramert:	db	0dh,0ah,'!!RAM-Fehler auf Adresse '
  068E    52 41 4D 2D    C      
  0692    46 65 68 6C    C      
  0696    65 72 20 61    C      
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	1-119


  069A    75 66 20 41    C      
  069E    64 72 65 73    C      
  06A2    73 65 20       C      
  06A5    58 58 58 58    C      ramead:	db	'XXXXH!!  TPA nur bis '
  06A9    48 21 21 20    C      
  06AD    20 54 50 41    C      
  06B1    20 6E 75 72    C      
  06B5    20 62 69 73    C      
  06B9    20             C      
  06BA    59 59 59 59    C      ramete:	db	'YYYYH.',07h,0dh,0ah,0
  06BE    48 2E 07 0D    C      
  06C2    0A 00          C      
                         C      
                         C      ; Kaltstart-Kommando
                         C      ;-------------------
  06C4    7F             C      kltkom:	db	kaltce-kaltc
  06C5                   C      kaltc:	coldcm
  06C5    44 49 52 20    C+     kltbef:	db	'DIR *.COM'
  06C9    2A 2E 43 4F    C+     
  06CD    4D             C+     
  06CE                   C+     	ds	kltbef+127-$,0
  0744    00             C      kaltce:	DB	0		;00h notwendig fuer CCP
  0081                   C      lkaltc	equ	$-kltkom	;Laenge gesamtes Kommando
                         C      
                         C      	.DEPHASE
  05C5                   C      kaltsl	equ	$-kaltsc
                         C      
  1D65'                  C      kalten	equ	$
                         C      
                                
                                ;##############################################################
  1D65'                         biosce:	;Code-Ende fuer BIOS
                                
                                	END
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	S


Macros:
CHARDB          CHDWARM         COLDCM          COSTS           CRTWARM         
DECDB           DECOUT          DRUCKT          DSKWARM         HEXDB           
HEXOUT          KBDWARM         PRINTD          PRINTH          PRINTV          
PRINTX          TIMWARM         VERSION         WARMIN          

Symbols:
0001 	@CDT            0000 	@DIFF           0000 	@DIN            
0039 	@DPBHL          F767 	@DSAD           00C1 	@L              
0009 	@LCR            0009 	@LCS            000D 	@LD             
000F 	@LS             0713 	@LT             0001 	@WRITE          
0000 	ADM3A           DBF7 	ALLOC           F266 	ALVA            
F2D8 	ALVB            E1A1 	ALWNR           E1A2 	ASPNR           
E83E 	ASYNHL          E82A 	ASYNRT          E83B 	ASYNSV          
0002 	BAB             0001 	BABBIG          000A 	BABDYN          
027E 	BABFRM          C400 	BDOS            0005 	BDOSJP          
0E00 	BDOSLN          E906 	BDOSRE          0011 	BDSKPL          
E10E 	BERCRC          0000I'	BIOS            D200 	BIOS00          
D203 	BIOS03          D206 	BIOS06          D209 	BIOS09          
D20C 	BIOS0C          D20F 	BIOS0F          D212 	BIOS12          
D215 	BIOS15          D218 	BIOS18          D21B 	BIOS1B          
D21E 	BIOS1E          D221 	BIOS21          D224 	BIOS24          
D227 	BIOS27          D22A 	BIOS2A          D22D 	BIOS2D          
D230 	BIOS30          D233 	BIOS33          D236 	BIOS36          
D238 	BIOS38          D23B 	BIOS3B          D23D 	BIOS3D          
D23F 	BIOS3F          D200 	BIOSAD          1D65I'	BIOSCE          
F767 	BIOSDE          E991 	BIOSDS          2E00 	BIOSL0          
2DE9 	BIOSLN          E3D1 	BIOSMC          E898 	BIOSMS          
F800 	BSANF1          F800 	BSANF2          0289 	BSBAB1          
032B 	BSBAB2          03CD 	BSBABI          0034 	BSCHSW          
0019 	BSCOM           FC3F 	BSEND1          FFCF 	BSEND2          
E930 	BSFORM          0084 	BSINIC          0018 	BSPAR           
0040 	BSSP1           0050 	BSSP2           0011 	BSZL1           
0019 	BSZL2           E897 	CALLHL          BC00 	CCP             
E991 	CCPKOP          F1A2 	CCPKPE          0800 	CCPKPL          
0800 	CCPLN           D88A 	CDSIN1          D88A 	CDSINI          
D8B0 	CDSINW          D2EC 	CDSIOI          D838 	CDSIOO          
D84C 	CDSIOS          D844 	CDSOD1          D846 	CDSOD2          
0000 	CDTDC1          0002 	CDTDTR          0000 	CDTN56          
0000 	CDTP54          0000 	CDTP56          0000 	CDTPIO          
FFFF 	CHDVAR          E7C8 	CHKSP           E7E8 	CHKSPD          
E7D5 	CHKSPN          E7E5 	CHKSPX          DBAE 	CHKUNA          
00FF 	CIGN            04A4 	CJUNGF          0000 	CLDCMX          
E961 	CLDDEV          0278 	CLDRTY          D3EB 	COCPM1          
D3FA 	COCPM2          040A 	COIIN1          E73C 	CONIN           
D20C 	CONOL           E748 	CONOUT          E730 	CONST           
0402 	COP1            0402 	COPAR           0008 	COPL1           
D42E 	COSTDA          D41C 	COSTDF          D433 	COSTDL          
D43A 	COSTDN          D437 	COSTDP          D42F 	COSTDR          
D40A 	COSTR           D40C 	COSTR0          D419 	COSTR1          
F75C 	COSTRT          000A 	COSTU           D5F5 	COTD1           
D5D7 	COTD2           D5FA 	COTD4           D601 	COTD5           
D5EC 	COTDCL          0324 	COTP0           0325 	COTP1           
0326 	COTP2           032A 	COTP3           0001 	COTPL0          
0001 	COTPL1          0004 	COTPL2          0001 	COTPL3          
0000 	CPASTZ          004E 	CPMEXT          D2C5 	CPMX00          
D2C8 	CPMX03          D2CB 	CPMX06          D2CE 	CPMX09          
D2D1 	CPMX0C          D2DD 	CPMX18          D2E0 	CPMX1B          
D2E3 	CPMX1E          D2E6 	CPMX21          04A3 	CPUTMS          
E0F4 	CRCBD           E0F5 	CRCBEG          E095 	CRCBEL          
E182 	CRCBER          E051 	CRCBES          E0A4 	CRCERX          
E0DF 	CRCNB           E0EA 	CRCVGL          E19D 	CRERC           
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	S-1


D689 	CRTBSL          D68C 	CRTBSR          D23A 	CRTCCN          
D680 	CRTCL           D712 	CRTCL1          D70F 	CRTCLK          
D70A 	CRTCOF          D238 	CRTCPS          D661 	CRTCR           
D706 	CRTCRT          D6A2 	CRTCUP          D582 	CRTCUR          
D67F 	CRTDEL          D6F2 	CRTDL1          D6DD 	CRTDLL          
D6FC 	CRTESC          D648 	CRTFFL          D74E 	CRTHD1          
D750 	CRTHD2          D764 	CRTHD3          D75C 	CRTHD4          
D69E 	CRTHOM          D746 	CRTHRD          D6D8 	CRTIL1          
D6C1 	CRTINL          D568 	CRTLC           0004 	CRTLCL          
D672 	CRTLF           D583 	CRTM01          D58A 	CRTM02          
D58E 	CRTM03          D591 	CRTM04          D594 	CRTM05          
D59C 	CRTM06          D59F 	CRTM07          D635 	CRTM08          
D63B 	CRTM09          D640 	CRTM10          D658 	CRTM11          
D662 	CRTM12          D665 	CRTM13          D673 	CRTM14          
D67B 	CRTM15          D681 	CRTM16          D68A 	CRTM17          
D68D 	CRTM18          D69F 	CRTM19          D6A3 	CRTM20          
D6AA 	CRTM21          D748 	CRTM22          D74B 	CRTM23          
D74F 	CRTM24          D730 	CRTM25          D31F 	CRTM32          
D3BC 	CRTM33          D3C3 	CRTM34          D38E 	CRTM35          
D3B3 	CRTM36          D72A 	CRTM37          03EE 	CRTM43          
D6C6 	CRTM44          D6D1 	CRTM45          D6D4 	CRTM46          
D6E2 	CRTM47          D6F3 	CRTM48          D657 	CRTNFA          
D5D5 	CRTNOP          D650 	CRTNSP          D51E 	CRTO            
D571 	CRTO02          D58C 	CRTO03          D5D6 	CRTO04          
D63A 	CRTO05          D643 	CRTO06          D647 	CRTO07          
D65D 	CRTO08          D5B5 	CRTO09          D5C5 	CRTO11          
D667 	CRTO12          D6BA 	CRTO13          D70B 	CRTO14          
D5A5 	CRTO84          D5A9 	CRTO85          D5AD 	CRTO86          
D5B1 	CRTO87          D580 	CRTOBS          D55A 	CRTOE1          
D732 	CRTOES          D739 	CRTOEZ          D543 	CRTONC          
D56C 	CRTOTI          D541 	CRTSC1          D546 	CRTSC2          
D729 	CRTSCI          D726 	CRTSCP          D73B 	CRTSCU          
D64B 	CRTSPC          D2E9 	CRTST           D613 	CRTTD0          
D623 	CRTTD1          D6AE 	CRTZL           D6B2 	CRTZLR          
0002 	CSF             F298 	CSVA            F30A 	CSVB            
00DF 	CTLC            0000 	CTRLST          DE81 	DBCDB           
DE82 	DBDEV           DE88 	DBDMA           DE99 	DBERRF          
DE81 	DBFLG           DE57 	DBL1K           DE5A 	DBL2K           
DE5D 	DBL2K0          DCAB 	DBMAT           DC3F 	DBN             
DE97 	DBNB            DCA8 	DBPRR           DE85 	DBSEC           
DC70 	DBSEC0          DC79 	DBSECM          DC82 	DBSECO          
DC6D 	DBSECZ          DE84 	DBSID           DE86 	DBSLC           
DE87 	DBSNB           DC5E 	DBSNBZ          DCEA 	DBTRAN          
DE83 	DBTRK           DCE4 	DBTRW           F34A 	DBUF            
000A 	DBUFSZ          DE8A 	DCDB            044B 	DCNVA           
0448 	DCNVOA          0458 	DCNVOD          044B 	DCNVOL          
044F 	DCNVOR          D238 	DCUPOS          D532 	DCURS           
DE91 	DDMA            DE8B 	DDRIVE          0004 	DEFAUL          
E7BC 	DELSPR          E7AF 	DELSPS          D56D 	DESC            
0000 	DFBPRR          0004 	DFBTR           0002 	DFBWR           
DE8A 	DFLG            DE7A 	DFRCDB          DFF4 	DFRCOD          
DE7A 	DFRFLG          DE7B 	DFRMDV          DE7C 	DFRMTR          
0002 	DFWR            E98D 	DGETP0          E96E 	DGETPB          
E1DA 	DIO             E25D 	DIOAUS          DEA4 	DIOCAD          
DE9D 	DIOCDB          DE9E 	DIOCDE          0009 	DIOCDL          
DE9D 	DIOCFL          DEA1 	DIOCSE          DEA0 	DIOCSI          
DEA2 	DIOCSL          DEA3 	DIOCSN          DE9F 	DIOCTR          
E2E6 	DIOEND          DDD9 	DIOERT          0000 	DIOF00          
0003 	DIOFFM          0005 	DIOFHD          0001 	DIOFID          
0006 	DIOFPS          0007 	DIOFS1          0004 	DIOFTR          
0002 	DIOFWR          E290 	DIOIGN          E263 	DIOKL           
E208 	DIOM01          E1EB 	DIOM02          E2FE 	DIOM07          
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	S-2


E30F 	DIOM08          E315 	DIOM09          E2AC 	DIOM10          
E2E7 	DIOM11          E26D 	DIOMD1          E286 	DIOMD2          
E1FB 	DIOMR           E200 	DIOMR1          E257 	DIOMRE          
E263 	DIOMRK          E2D1 	DIOMRW          E328 	DIOMWW          
DD98 	DIONFT          E237 	DIONSE          E1F6 	DIONSS          
E28E 	DIOOP           DD83 	DIOPHY          E2A1 	DIORD           
E2CB 	DIORD1          E2CF 	DIORD2          E2D4 	DIORD3          
E2A5 	DIORDS          E2C3 	DIORKL          E1CA 	DIORTN          
DD83 	DIORTY          E1C9 	DIORUN          E2CA 	DIOSL1          
E321 	DIOSL2          DD7E 	DIOSSP          E1E6 	DIOSTR          
E28B 	DIOSY3          E287 	DIOSYN          E245 	DIOTRE          
E298 	DIOTRR          DD66 	DIOTRS          DD55 	DIOTS1          
DD43 	DIOTS2          DD54 	DIOTS4          E1CC 	DIOTSR          
DD67 	DIOTSS          E33B 	DIOW00          E1F0 	DIOW01          
E20D 	DIOWAM          E339 	DIOWM1          E322 	DIOWR1          
E326 	DIOWR2          E32B 	DIOWR3          E324 	DIOWRT          
E346 	DIOWT1          F1E6 	DIRBUF          0002 	DISK5           
0000 	DISK8           2D3C 	DISKA           2D3C 	DISKB           
0000 	DISKC           0000 	DISKD           2D3C 	DISKDI          
DD04 	DISKIO          0002 	DISKNB          E2F2 	DIWMFM          
0003 	DLGINT          DCDD 	DMOVEW          D25F 	DPBA            
0009 	DPBALC          D292 	DPBB            0011 	DPBBFM          
0003 	DPBBLM          0002 	DPBBLS          000B 	DPBCHK          
0007 	DPBDIR          0015 	DPBDNR          0004 	DPBEXM          
0004 	DPBF86          0005 	DPBFDS          0002 	DPBFFM          
000F 	DPBFLG          0007 	DPBFND          0006 	DPBFRM          
0003 	DPBFSM          0003 	DPBFSV          0033 	DPBLNG          
000D 	DPBOFS          0016 	DPBPTR          0005 	DPBSIZ          
0010 	DPBSLC          0013 	DPBSN0          0000 	DPBSPT          
0017 	DPBSTI          0012 	DPBSTP          0019 	DPBSTR          
0007 	DPBT52          0004 	DPBT5Z          0005 	DPBT80          
0003 	DPBTDD          0000 	DPBTDS          0014 	DPBTRK          
0006 	DPBTWV          0018 	DPBTYP          D23F 	DPHA            
D23F 	DPHAA           D24F 	DPHAB           0000 	DPHAC           
0000 	DPHAD           0000 	DPHAE           0000 	DPHAF           
0000 	DPHAG           0000 	DPHAH           0000 	DPHAI           
0000 	DPHAJ           0000 	DPHAK           0000 	DPHAL           
0000 	DPHAM           0000 	DPHAN           0000 	DPHAO           
0000 	DPHAP           E96A 	DPHATB          D24F 	DPHB            
0002 	DPHNB           DFF2 	DPREC1          DF3C 	DPREC2          
DF3F 	DPRECN          DFF6 	DPRETR          DEC8 	DRV0            
DED1 	DRV0A           DBFB 	DRW             DC23 	DRWBNR          
DBDC 	DRWERR          DD01 	DRWSEC          DE8E 	DSECTR          
D9A9 	DSELNB          E1BA 	DSIDMT          E010 	DSIDMZ          
0007 	DSIDTL          DCFC 	DSIDTR          DCF9 	DSIDTT          
DB33 	DSIZDZ          DB30 	DSIZME          DB2D 	DSIZMZ          
0000 	DSK5FM          0002 	DSK5MF          0002 	DSK80           
0000 	DSK8FM          0000 	DSK8MF          DF26 	DSKDA           
DF13 	DSKDAW          0002 	DSKDS           DF13 	DSKMO1          
DF28 	DSKMON          DD04 	DSKTRA          0004 	DSLBLK          
0002 	DSLDIR          0001 	DSLFO           0005 	DSLL            
E1AE 	DSLN0           E1B1 	DSLN1           E1B4 	DSLN2           
E1B7 	DSLN3           0003 	DSLNL           E1A7 	DSLNMT          
E0D3 	DSLNMZ          0003 	DSLOFF          0001 	DSLSPT          
0000 	DSLTRK          0000 	DSLVO           DCCC 	DSMOVE          
D7B9 	DSWE            D777 	DSZTA           0016 	DSZTAL          
DE8C 	DTRACK          E063 	DTRDYT          E066 	DTRDYW          
E063 	DTRDYZ          DDE7 	DTROK           E08E 	DTRRDE          
E22C 	DTRSIE          DE07 	DTRSL0          DE1B 	DTRSL1          
DE2F 	DTRSL2          DE43 	DTRSL3          DDF3 	DTRSLA          
DF4D 	DTRSLL          E082 	DTRWRE          D2EC 	DUMI            
D2EF 	DUMO            D2FC 	DUMOH           D2E9 	DUMST           
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	S-3


DE98 	DWRTYP          0000 	EM256           0000 	ERRVAR          
0001 	ESCPC           0007 	F1715           0001 	FAM             
0007 	FDC             E075 	FEHRET          0228 	FL.KA1          
0230 	FL.KA2          023F 	FL.KA3          0247 	FL.KA4          
0249 	FL.KA5          0253 	FL.KA6          0269 	FL.KA7          
E131 	FL.STO          E0CE 	FL.TO1          E103 	FL.TSB          
E142 	FL.ZTO          0005 	FLCOAC          0004 	FLCOAD          
0007 	FLCOBC          0006 	FLCOBD          0001 	FLDAAC          
0000 	FLDAAD          0003 	FLDABC          0002 	FLDABD          
DE9A 	FLLDIR          E0D2 	FLMODF          0021 	FLMOT           
DEA6 	FLOPPY          E162 	FLRES           0020 	FLSEL           
0001 	FORMAT          E178 	FT.ADR          E17F 	FT.ANZ          
E177 	FT.KOM          E17E 	FT.LEN          E17A 	FT.LWN          
E17D 	FT.SEC          E17C 	FT.SID          E181 	FT.STI          
E180 	FT.STP          E17B 	FT.TRK          E158 	HEADUP          
DB5A 	HOME            DB66 	HOME1           00DA 	HRLC            
000D 	HRTC            000B 	HRTC1           0001 	IBMFRM          
0001 	INSLIN          E39C 	INTKBD          E3A2 	INTRAF          
E39F 	INTRBC          E3A6 	INTRET          E3A1 	INTRHL          
E3A4 	INTSP           F1E6 	INTSTK          00D0 	INTVB           
01B6 	INTVCL          F700 	INTVEC          00D0 	INTVL           
F7D0 	INTVR           0000 	IOBLPT          0713 	IOBTTY          
0713 	IOBUC1          0001 	IOBVAR          0003 	IOBYTE          
E797 	IODIS1          E790 	IODISP          E139 	ITIMEO          
00F8 	IVCTC0          00FA 	IVCTC1          00FC 	IVCTC2          
00FE 	IVCTC3          00E8 	IVDSK1          00EA 	IVDSK2          
00E0 	IVPAR           00D0 	IVSIO0          00D2 	IVSIO1          
00D4 	IVSIO2          00D6 	IVSIO3          00D8 	IVSIO4          
00DA 	IVSIO5          00DC 	IVSIO6          00DE 	IVSIO7          
0000 	K5120           06C5 	KALTC           0744 	KALTCE          
1D65'	KALTEN          04AA 	KALTM           E8D7 	KALTS1          
0180 	KALTSB          17A0'	KALTSC          05C5 	KALTSL          
E991 	KALTST          D3B1 	KBDBCL          0011 	KBDBL           
F74A 	KBDBUF          D341 	KBDCO           D3A3 	KBDCO1          
D3A4 	KBDCO2          0000 	KBDCPB          002A 	KBDCPL          
D44B 	KBDCPT          D38D 	KBDCTS          D3BB 	KBDI            
D3EA 	KBDLCH          D374 	KBDMO2          D348 	KBDNCO          
D369 	KBDNHC          D378 	KBDNMN          D352 	KBDNST          
D359 	KBDNSY          D39E 	KBDPT1          D38D 	KBDPUT          
D3FA 	KBDRC1          D3E9 	KBDRCH          D3E9 	KBDRCU          
D326 	KBDRDT          D3E3 	KBDRTS          000C 	KBDSCI          
000E 	KBDSCS          D445 	KBDSLM          D31E 	KBDSNT          
D23B 	KBDSST          D30C 	KBDST           D3CB 	KBDST1          
D3CB 	KBDSTC          D314 	KBDSTI          D49F 	KBDSTS          
D314 	KBDSTZ          D3B6 	KBDWIN          00C8 	KCURDW          
00C4 	KCURLF          00C7 	KCURPD          00C5 	KCURPU          
00C6 	KCURRI          00C2 	KCURUP          00C1 	KCURWL          
00C3 	KCURWR          0000 	KES             06C5 	KLTBEF          
06C4 	KLTKOM          004A 	KRITBG          004C 	KRITEN          
0000 	L2BAHN          0040 	LAMPBF          D44A 	LAMPEN          
E784 	LIST            D7C5 	LISTI           E778 	LISTST          
0081 	LKALTC          0004 	LMPB2B          0005 	LMPB2R          
0006 	LMPERR          0007 	LMPHCP          0000 	LMPSL0          
0001 	LMPSL1          0002 	LMPSL2          0003 	LMPSL3          
D7CD 	LOUTW1          D7E6 	LOUTWF          D7CB 	LOUTWS          
D7CF 	LOUTWT          000C 	LPCR            000F 	LPCR1           
D2EC 	LPTI            D2EF 	LPTO            D2E9 	LPTST           
D7C5 	LSTO            D7C5 	LSTOCH          D881 	LSTSD1          
D871 	LSTSDC          D86C 	LSTSR           D86C 	LSTSR1          
D7F6 	LSTST           D7F6 	LSTSTI          D80F 	LSTTTY          
D81F 	LSTUC1          D7FD 	LSYNCH          0001 	LTPDC           
0006 	LTPI            000B 	LTPINI          0004 	LTPO            
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	S-4


D8C1 	LTPOT5          D8BE 	LTPOW5          0008 	LTPS            
0003 	LTPSC           0002 	LTPSD           0000 	LTPST           
000A 	LTPW5           E1A0 	LWEXIS          E5DD 	MAREC1          
E5DA 	MARECO          0004 	MAXLW           E8B2 	MBRECO          
E5C3 	MC2R            E409 	MCAL            E57B 	MCIO1           
E593 	MCIO2           E597 	MCIO3           E59C 	MCIO4           
E5A7 	MCIO5           E5AB 	MCIODEL         E578 	MCONIO          
E60A 	MCONO           E5C5 	MCONV           E5AF 	MCONV2          
E5D5 	MCONVD          E5D8 	MCONVE          E530 	MERR            
E6B3 	MERRTX          E514 	MET1            E511 	MH1             
E8CB 	MHDIG1          E4EB 	MHELP           E5E5 	MHLDEC          
E8C9 	MHLDIG          E606 	MHSUB           E71F 	MHTXT           
E483 	MIN             E724 	MINBYT          E722 	MINTXT          
0004 	MLTAD1          E419 	MMEM            E423 	MMEM1           
E42D 	MMEM2           E42F 	MMEM3           E45A 	MMEM4           
E424 	MMEM5           E45D 	MMEM6           E711 	MMTXT           
E469 	MNMEM           E494 	MNOUT           E65B 	MOLDSP          
0001 	MONACT          00DB 	MONC            E7AB 	MONCAL          
0001 	MONITOR         0005 	MONRQ           E469 	MOUT            
E491 	MOUTE           0000 	MPROT           E53B 	MRA1            
E54C 	MRA2            E553 	MRA3            E561 	MRA4            
E536 	MRADDR          E574 	MRARET          E8B6 	MRECA           
E8B3 	MRECOA          E8C3 	MRECOD          E8B6 	MRECOL          
E8BA 	MRECOR          E4C4 	MREG            E4D6 	MREG1           
E65D 	MRREG           E6D8 	MRTX21          E6B9 	MRTXT1          
E6D6 	MRTXT2          E65B 	MSTACK          E613 	MSTCKE          
E64F 	MSTCKR          E4A9 	MT1             E4BA 	MT2             
E727 	MTAD1           E72B 	MTAD2           E494 	MTIM            
E65F 	MTXT1           E6A9 	MTXT2           E6B5 	MTXT3           
E68A 	MVTXT1          E3F9 	MZYKL1          E3FC 	MZYKL2          
DEF9 	NFDEI2          0278 	NJUNG1          04A0 	NJUNG3          
E7F9 	NMONSP          E074 	NOERR           DECC 	NOLW            
DF6B 	NPOST0          E810 	NSTPSP          E827 	NSYNLR          
0000 	OSS             00E0 	PF0C            00E1 	PF1C            
00E2 	PF2C            00E3 	PF3C            00E4 	PF4C            
00E5 	PF5C            00E6 	PF6C            00E7 	PF7C            
00E8 	PF8C            00E9 	PF9C            00EA 	PFAC            
00EB 	PFBC            00EC 	PFCC            00ED 	PFDC            
00EE 	PFEC            00EF 	PFFC            DFD2 	PHRW            
DFD6 	PHRWW           DFD4 	PHRWW1          0007 	PHYACT          
D805 	PORTPR          D805 	PORTPZ          DFFB 	PREC            
E155 	PRET1           E152 	PRET3           E14B 	PRET4           
E149 	PRETX           E01D 	PSIDE0          E01F 	PSIDE1          
E76C 	PUNCH           E898 	PUTMES          DFD2 	PVRW1           
DFDB 	PVRW2           0000 	RAF             0000 	RAMBYT          
06A5 	RAMEAD          0443 	RAMEH           068A 	RAMERT          
06BA 	RAMETE          0000 	RAMFL           0040 	RAMKB           
047E 	RAMTEN          045E 	RAMTER          067E 	RAMTOK          
065C 	RAMTT           042C 	RAMTZ           DFDB 	RDWR            
DBDF 	READ            E760 	READER          E754 	READES          
0000 	REBOOT          E355 	RET             0038 	RQMASK          
E21C 	SECAN1          E0E4 	SECANZ          DB77 	SECTRAN         
E19F 	SEERC           00D1 	SEL0            00D2 	SEL1            
00D4 	SEL2            00D8 	SEL3            DA51 	SEL48           
DA94 	SELD40          DB51 	SELDAL          DAE2 	SELDDR          
DA68 	SELDL1          DB4C 	SELDLA          DA5D 	SELDLE          
DAD4 	SELDO0          DAD5 	SELDOF          D990 	SELDSK          
DA9C 	SELDSS          DA6F 	SELDSV          DA7E 	SELDXL          
DB58 	SELEXT          DB58 	SELEXX          DA9C 	SELSET          
DA4D 	SELSS           D9DA 	SELSTZ          DA22 	SELSY0          
DA25 	SELSY1          DA12 	SELSY2          DA27 	SELSYS          
E294 	SERR            E248 	SERR1           E0AF 	SERRX           
BIOS CP/A fuer PC1715	MACRO-80 V3.50	25-Oct-85	Page	S-5


E956 	SETCLD          DB72 	SETDMA          DEAF 	SETECR          
DEB6 	SETESP          DB6D 	SETSEC          DB68 	SETTRK          
DB19 	SF128E          DAFC 	SF128Z          E282 	SIDLEN          
E27C 	SIDSEC          E276 	SIDSID          E270 	SIDTR           
DEC4 	SP13            E104 	SP74            00CC 	SPCCE           
00CD 	SPCINS          DF71 	SPE             E19E 	SPERC           
E0CA 	SPERR2          E0C4 	SPERR4          E2B7 	SPI4            
E2C1 	SPI5            E1A3 	SPNRL           E306 	SPO4            
DF71 	SPPRTY          DF8B 	SPRE            DF87 	SPVE            
E02F 	SRDSID          DF91 	STEP            DF94 	STEP0           
DF98 	STEP2           DFA9 	STEPW           DFA7 	STEPW1          
E88E 	STOPCH          0004 	STOPRQ          E841 	STOPRT          
E847 	STOPZ           E85B 	STOPZ2          E87A 	STOPZ4          
00DE 	STPC            E881 	STPCHP          F1CE 	STPSTK          
0001 	STPVAR          E86B 	STPZ4A          E871 	STPZ4B          
D717 	SWILMP          00D9 	SYLC            D23D 	SYNFLG          
0003 	SYNLRQ          D23E 	SYNSEM          0008 	SYSCTC          
E3CD 	T1NMO1          E3C7 	T1NMO2          E36F 	T5IHL           
0043 	TIM1CN          E356 	TIM1OF          E34B 	TIM1ON          
0045 	TIM1RT          E396 	TIM1S1          E38F 	TIM1SC          
E3A9 	TIM1UP          E3B9 	TIM1UU          0041 	TIM5CN          
E38E 	TIM5CU          E367 	TIM5IT          E356 	TIM5OF          
E34B 	TIM5ON          E351 	TIM5OT          0003 	TIMCTC          
E363 	TINCUR          0100 	TPA             C405 	TPAEND          
DFB3 	TRK0            DFCC 	TRK0F           DFB5 	TRK0I           
DFBE 	TRK0S           0008 	TTYCTR          0008 	TTYCTS          
000C 	TTYDAT          D2EC 	TTYI            D7B9 	TTYO            
D7F0 	TTYST           000E 	TTYSTA          0014 	UC1BFL          
D97B 	UC1BFP          D97C 	UC1BUF          0009 	UC1CTR          
0009 	UC1CTS          000D 	UC1DAT          D961 	UC1ERR          
D8F1 	UC1I            D8ED 	UC1I2           D8F5 	UC1II           
D91C 	UC1IRD          D8F6 	UC1IW           D7BF 	UC1O            
D955 	UC1RI1          D923 	UC1RIN          D950 	UC1RIR          
D8CF 	UC1SI           D8E5 	UC1SI1          D8CB 	UC1ST           
000F 	UC1STA          0000 	UHRVAR          0000 	UMLAUT          
DE93 	UNACNT          DE94 	UNADEV          DE96 	UNASEC          
DBD3 	UNATR1          DE95 	UNATRK          0001 	UPL             
0001 	UPL1            0058 	VERSJ           0005 	VERSM           
0018 	VERST           0002 	VRTC            0002 	VRTC1           
E8A4 	WAIT10          E8A9 	WAIT1Z          E8A7 	WAIT2Z          
E8DE 	WARMST          E8EF 	WBINIT          0000 	WBOOTV          
DB7B 	WRITE           E041 	WRITPT          DE60 	XLT             
DF7E 	XMAXTR          DF6F 	XPVRW           00DD 	Z000            
00DC 	Z00C            00F0 	ZBL0            00DC 	ZBL00           
00DD 	ZBL000          00F1 	ZBL1            00F2 	ZBL2            
00F3 	ZBL3            00F4 	ZBL4            00F5 	ZBL5            
00F6 	ZBL6            00F7 	ZBL7            00F8 	ZBL8            
00F9 	ZBL9            00FA 	ZBLKOM          00FB 	ZBLMIN          
0000 	ZS2VAR          



No Fatal error(s)


UC1ST           
000F 	UC1STA          0000 	UHRVAR          0000 	UMLAUT     